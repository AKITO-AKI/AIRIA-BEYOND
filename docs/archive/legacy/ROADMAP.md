# プロダクト・ロードマップ（次に調整／実装すべきこと）

このロードマップは、**refine → music → image** の生成フローが「安定」「フォールバック前提で壊れにくい」「HTTP のスモークテスト（`npm run smoke:e2e:http`）で検証済み」であることを前提にしています。次のフェーズは、**プロダクト価値**、**品質を上げ続ける仕組み（Quality Loop）**、**本番運用の硬さ**に投資します。

## 0) 現状のベースライン（すでに堅いところ）

- 外部プロバイダのキーが無くても E2E が完走（音楽は rule-based、画像は placeholder でフォールバック）。
- 「芸術的な深み」の制御が存在（音楽: form/period/leitmotifs/humanize、画像: density + 美術史／共感覚マッピング）。
- スモークテストに strict-provider（実プロバイダ必須）モードがある（本番相当環境で使う）。
- UI 側の型・呼び出しが安定（`any` の削減、リクエスト型を明示）。

## 指針（プロダクト原則）

- **体験を必ず届ける**: ハードフェイルしない。状態表示と復帰導線で優雅に劣化させる。
- **白い世界観の一貫性**: 紙／陶器／曇りガラスの質感。デバッグではなく「ライナーノーツ（解説）」として見せる。
- **プライバシー・ファースト**: 外部に送る情報は最小限。任意入力は任意であることが明確。
- **コスト意識**: 既定値は安く、品質向上は意図的に（スイッチで制御）。
- **再現できる創造性**: 気に入った結果は「同じレシピで近く再生成」「少しだけ変えて派生」ができる。

---

## 1) 今後 1〜2 週間（効果大・リスク小）

### A. UX: 生成を「意図のある体験」にする（ただの非同期ジョブにしない）

- **進行の物語**（スピナーだけにしない）: 例「refine → 構成案 → 演奏表情 → カバーアート」。
- **再開と復帰**: 通信断の後でもワンクリックで「生成を再開」（既に概念はあるのでエッジを詰める）。
- **コントロールの露出はやさしく**: `image.density` と `music.humanize` を安全なプリセット付きの “Artistic” スライダー／トグルとして出す。

受け入れ条件:
- 生成開始 → リロード後もジョブ状態が見え、再開できる。
- 生成画面が「いま何が起きているか」を 1〜2 行で説明でき、白い世界観に合っている。

### B. Quality loop: 「良い」を定義し、測れるようにする

- 軽量な **ゴールデン・プロンプト**（10〜30 ケース）と期待する構造特性を用意。
- スモークテストを「完走するか」から「不変条件を満たすか」へ拡張（例: 終止の存在、セクション数の上限下限、density の範囲）。

受け入れ条件:
- `npm run smoke:e2e:http` が継続してグリーン。
- ゴールデンセットに対して不変条件をローカルで反復チェックできる。

### C. 開発衛生: ドリフトと回帰を減らす

- 実際に動く `lint`/`format` を導入（現状 root の `package.json` はプレースホルダ）。
- CI を build だけでなく、最低限「フォールバック E2E スモーク」まで実行。

受け入れ条件:
- PR で build + smoke（フォールバック）を走らせる。
- フォーマット／リントが 1 コマンドで統一され、パッケージ間でブレない。

### D. セキュリティ: 目立つ穴を先に塞ぐ

- admin 系エンドポイントを保護（トークン + レート制限 + 監査ログ）。
- 本番 CORS を明示的な許可 Origin に絞る。

受け入れ条件:
- admin は認証必須・fail closed。
- 本番 CORS が明示され、テストできる。

---

## 2) 今後 1 か月（本番の耐久性 + “再現性”の強化）

### A. 永続化: 再起動でジョブが消えない

現状の job store は実質的に揮発（インメモリ）です。永続化へ移行します:
- ジョブのメタデータ／結果を Postgres に保存（デプロイ文書でも Neon が推奨）。
- 保持／クリーンアップ方針（例: 7〜30 日）を定義。

受け入れ条件:
- API 再起動後もアクティブなジョブ状態が失われない。
- ユーザーが最近の作品に安定して戻れる。

### B. 再現性 + バリエーション

- 音楽／画像ともに **seed + recipe（レシピ）** を明示的に保存。
- 「バリエーション生成」を実装（例: モチーフは維持しつつ和声だけ変える、density は同じでパレットだけ変える）。

受け入れ条件:
- 保存済み作品を同レシピで “近く” 再生成できる。
- バリエーションが「同一性を保ちつつ」意味のある差分を作れる。

### C. プロバイダ統合の成熟

- プロバイダ・マトリクスを定義し、挙動を揃える:
  - 音楽: OpenAI vs Ollama vs rule-based（スキーマ項目の機能差を縮める）。
  - 画像: Replicate vs ComfyUI vs placeholder（プロンプト／プリセット適用が一貫）。
- ステージング限定の strict-provider チェック（nightly）で、プロバイダ側の破壊的変更を早期検知。

受け入れ条件:
- ステージングで strict 実行が可能で、未設定なら速やかに失敗する。
- プロバイダ特有の回帰を 24 時間以内に検知できる。

### D. 観測性: ユーザー体験を把握できる

- refine/music/image を貫く correlation ID を付与。
- ダッシュボード化できる指標: レイテンシ分位、フォールバック率、プロバイダ別エラー、概算コスト。

受け入れ条件:
- 「生成の何%がフォールバック？」と「失敗がどこに偏っている？」に即答できる。

---

## 3) 今後 3 か月（差別化）

### A. クリエイティブ・コンパニオン機能

- 「Liner Notes / 解説」を第一級の成果物にする:
  - 音楽の形式、モチーフ、緊張→解放の説明。
  - 視覚マッピングの説明（時代 → スタイル、編成 → テクスチャ）。
- 「読みながら聴ける」同期ノーツ（セクション・マーカー）を追加。

### B. ライブラリ体験（白い本棚）

- 背表紙、コレクション、タイムスタンプ、「新しいアルバムが一度だけ着地する」演出など棚体験を強化。
- 検索とフィルタ（感情アーク、時代、density、編成）。

### C. パーソナライズと記憶（オプトイン）

- ユーザーが好みプロファイルにオプトイン（例: 「密度高めが好き」「ロマン派のピアノが好き」）。
- ユーザーのお気に入りレシピを retrieval して few-shot に使う（ファインチューニングより安全で保守しやすい）。

### D. 品質研究（上級）

- 公開ドメイン由来の構造例をキュレーションし、 retrieval ベースでプロンプト強化。
- ファインチューニングは **スキーマ順守**を主目的に限定（`docs/FINE_TUNING_NOTES.md` 参照）。

---

## 推奨の実装順（“北極星”ルート）

1) UX: 進行の物語 + 再開の安定
2) ゴールデン・プロンプト + 不変条件チェック（Quality loop）
3) PR でフォールバック smoke + ステージングで nightly strict
4) Postgres 永続化 + 保持方針
5) レシピ保存 + バリエーション
6) Liner Notes をプロダクト面にする

## 先に決めると後が楽な問い

- 本番の主戦場: Render / VPS（Xserver）/ ハイブリッドのどれに寄せる？（ドキュメントが複数系統ある）
- プロバイダキー無しユーザーの既定体験: ずっとフォールバックで良い？それとも設定ガイドへ誘導？
- 最適化方針: 「即時プレビュー（軽量・速い）」重視？「待ってでも品質」重視？
