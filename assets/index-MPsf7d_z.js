var po=Object.defineProperty;var fo=(n,e,t)=>e in n?po(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var lt=(n,e,t)=>fo(n,typeof e!="symbol"?e+"":e,t);import{r as x,j as a,R as L,a as go,C as ms,u as Ht,B as Cs,V as gn,L as vo,b as _o,c as Qi,M as yo,d as bo,T as xo,S as wo,e as ea,f as Kn,g as No}from"./vendor-three-l38Icqav.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const Bn=n=>{if(!n)return 30;const e=20,t=60,s=30,i=180,r=Math.max(s,Math.min(i,n));return e+(r-s)/(i-s)*(t-e)},ta=n=>{const t=Math.floor(n/10),s=n%10;return{shelfIndex:Math.min(t,4),positionIndex:s}},Un=n=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let s=0;s<n.length;s++)t=(t<<5)-t+n.charCodeAt(s),t=t&t;return e[Math.abs(t)%e.length]},Va=x.createContext(void 0),sa="airia-albums",So=({children:n})=>{const[e,t]=x.useState([]),[s,i]=x.useState(null);x.useEffect(()=>{try{const u=localStorage.getItem(sa);if(u){const h=JSON.parse(u);t(h)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),x.useEffect(()=>{try{localStorage.setItem(sa,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const r=u=>{const h={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()},d=ta(0),g=Bn(h.musicMetadata?.duration),f=Un(h.imageDataURL),m={...h,gallery:{shelfIndex:d.shelfIndex,positionIndex:d.positionIndex,thickness:g,spineColor:f}};return t(p=>[m,...p].map((y,w)=>{const S=ta(w),E=Bn(y.musicMetadata?.duration),b=y.gallery?.spineColor||Un(y.imageDataURL);return{...y,gallery:{shelfIndex:S.shelfIndex,positionIndex:S.positionIndex,thickness:E,spineColor:b}}})),m},o=(u,h)=>{t(d=>d.map(g=>{if(g.id!==u)return g;const f={...g,...h};if(h.imageDataURL){const m=f.gallery?.spineColor||Un(f.imageDataURL);return{...f,gallery:{...f.gallery||{shelfIndex:0,positionIndex:0,thickness:Bn(f.musicMetadata?.duration),spineColor:m},spineColor:m}}}return f}))},l=u=>{i(u)},c=()=>s&&e.find(u=>u.id===s)||null;return a.jsx(Va.Provider,{value:{albums:e,selectedAlbumId:s,addAlbum:r,updateAlbum:o,selectAlbum:l,getSelectedAlbum:c},children:n})},bt=()=>{const n=x.useContext(Va);if(n===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return n},qa=x.createContext(void 0),Gn="airia-causal-logs",To=30;function jo(n){return n&&{mood:n.mood,duration:n.duration,timestamp:n.timestamp,customInput:n.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:n.onboardingAnswers?"[onboarding data - summary only]":void 0}}function ko(n){const e=new Date;return e.setDate(e.getDate()-To),n.filter(t=>new Date(t.createdAt)>=e)}const Co=({children:n})=>{const[e,t]=x.useState([]);x.useEffect(()=>{try{const d=localStorage.getItem(Gn);if(d){const f=JSON.parse(d).map(p=>({...p,createdAt:new Date(p.createdAt),input:{...p.input,timestamp:new Date(p.input.timestamp)},analysis:p.analysis?{...p.analysis,timestamp:new Date(p.analysis.timestamp)}:void 0,imageGeneration:p.imageGeneration?{...p.imageGeneration,timestamp:new Date(p.imageGeneration.timestamp)}:void 0,musicGeneration:p.musicGeneration?{...p.musicGeneration,timestamp:new Date(p.musicGeneration.timestamp)}:void 0,album:p.album?{...p.album,timestamp:new Date(p.album.timestamp)}:void 0,errors:p.errors?.map(_=>({..._,timestamp:new Date(_.timestamp)}))})),m=ko(f);t(m)}}catch(d){console.error("[CausalLog] Failed to load logs from localStorage:",d)}},[]),x.useEffect(()=>{try{localStorage.setItem(Gn,JSON.stringify(e))}catch(d){console.error("[CausalLog] Failed to save logs to localStorage:",d)}},[e]);const s=(d,g)=>{const f=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,m={id:f,sessionId:d,createdAt:new Date,input:jo(g),totalDuration:0,success:!1};return t(p=>[...p,m]),console.log("[CausalLog] Created log:",f,"for session:",d),f},i=d=>e.find(g=>g.id===d),r=d=>e.find(g=>g.sessionId===d),o=(d,g)=>{t(f=>f.map(m=>{if(m.id===d){const p={...m,...g};if(p.analysis||p.imageGeneration||p.musicGeneration){const _=[p.analysis?.duration||0,p.imageGeneration?.duration||0,p.musicGeneration?.duration||0];p.totalDuration=_.reduce((y,w)=>y+w,0)}return p}return m})),console.log("[CausalLog] Updated log:",d)},l=d=>{t(g=>g.filter(f=>f.id!==d)),console.log("[CausalLog] Deleted log:",d)},c=()=>{t([]),localStorage.removeItem(Gn),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(d=>({id:d.id,sessionId:d.sessionId,createdAt:d.createdAt,success:d.success,totalDuration:d.totalDuration,albumId:d.album?.albumId})),h=d=>{const g=i(d);if(!g)throw new Error(`Log ${d} not found`);return JSON.stringify(g,null,2)};return a.jsx(qa.Provider,{value:{logs:e,createLog:s,getLog:i,getLogBySessionId:r,updateLog:o,deleteLog:l,clearAllLogs:c,getLogSummaries:u,exportLog:h},children:n})},Wa=()=>{const n=x.useContext(qa);if(n===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return n},vn="https://airia-beyond.onrender.com",Qn="airia_auth_token_v1";function ei(){try{return String(localStorage.getItem(Qn)||"")}catch{return""}}function Gs(n){try{n?localStorage.setItem(Qn,n):localStorage.removeItem(Qn)}catch{}}async function Ke(n,e={}){const t=ei(),s=new Headers(e.headers||{});return t&&s.set("Authorization",`Bearer ${t}`),fetch(n,{...e,headers:s})}async function _n(n){return n.json().catch(()=>null)}async function na(n,e){const t=await fetch(`${vn}/api/auth/oauth/${encodeURIComponent(n)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await _n(t);if(!t.ok)throw new Error(s?.message||`Failed to login: ${t.status}`);return s}async function Ao(){const n=await Ke(`${vn}/api/auth/me`),e=await _n(n);if(!n.ok)throw new Error(e?.message||`Failed to load me: ${n.status}`);return e}async function Mo(){const n=await Ke(`${vn}/api/auth/logout`,{method:"POST"}),e=await _n(n);if(!n.ok)throw new Error(e?.message||`Failed to logout: ${n.status}`);return e}async function Eo(n){const e=await Ke(`${vn}/api/auth/me`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await _n(e);if(!e.ok)throw new Error(t?.message||`Failed to update profile: ${e.status}`);return t}const Ba=L.createContext(null);function As(){const n=L.useContext(Ba);if(!n)throw new Error("useAuth must be used within AuthProvider");return n}const Io=({children:n})=>{const[e,t]=L.useState(null),[s,i]=L.useState(!0),[r,o]=L.useState(()=>ei()),l=L.useCallback(async()=>{const m=ei();if(o(m),!m){t(null),i(!1);return}try{const p=await Ao();t(p.user),p.user||(Gs(null),o(""))}catch{t(null)}finally{i(!1)}},[]);L.useEffect(()=>{l()},[l]);const c=L.useCallback(async m=>{i(!0);try{const p=await na("google",{idToken:m});Gs(p.token),o(p.token),t(p.user)}finally{i(!1)}},[]),u=L.useCallback(async(m,p)=>{i(!0);try{const _=await na("apple",{idToken:m,user:p||void 0});Gs(_.token),o(_.token),t(_.user)}finally{i(!1)}},[]),h=L.useCallback(async()=>{i(!0);try{await Mo().catch(()=>null)}finally{Gs(null),o(""),t(null),i(!1)}},[]),d=L.useCallback(async m=>{i(!0);try{const p=await Eo(m);t(p.user)}finally{i(!1)}},[]),g=L.useCallback(m=>{t(p=>p&&{...p,followingIds:Array.isArray(m)?m:[]})},[]),f={user:e,loading:s,token:r,refresh:l,loginWithGoogle:c,loginWithApple:u,logout:h,updateProfile:d,updateFollowingIds:g};return a.jsx(Ba.Provider,{value:f,children:n})};var ut=(n=>(n.STOPPED="STOPPED",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.LOADING="LOADING",n))(ut||{});const Ua=x.createContext(void 0),Do=.7,Ro=({children:n})=>{const[e,t]=x.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:Do,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),s=x.useCallback(v=>{t(N=>({...N,playbackState:v?"PLAYING":"PAUSED"}))},[]),i=x.useCallback((v,N)=>{t(A=>({...A,currentAlbumImage:v,currentTrackTitle:N}))},[]),r=x.useCallback(v=>{t(N=>({...N,playbackState:v}))},[]),o=x.useCallback(v=>{t(N=>({...N,currentAlbum:v,currentAlbumImage:v?.imageDataURL,currentTrackTitle:v?v.title||v.mood:void 0}))},[]),l=x.useCallback((v,N=0)=>{t(A=>({...A,queue:v,queueIndex:N,currentAlbum:v[N]||null,currentAlbumImage:v[N]?.imageDataURL,currentTrackTitle:v[N]?v[N].title||v[N].mood:void 0}))},[]),c=x.useCallback(v=>{t(N=>({...N,currentTime:v}))},[]),u=x.useCallback(v=>{t(N=>({...N,duration:v}))},[]),h=x.useCallback(v=>{const N=Math.max(0,Math.min(1,v));t(A=>({...A,volume:N}))},[]),d=x.useCallback(()=>{t(v=>({...v,isMuted:!v.isMuted}))},[]),g=x.useCallback(()=>{t(v=>({...v,shuffle:!v.shuffle}))},[]),f=x.useCallback(()=>{t(v=>{const N=["off","all","one"],D=(N.indexOf(v.repeat)+1)%N.length;return{...v,repeat:N[D]}})},[]),m=x.useCallback(()=>{t(v=>({...v,isExpanded:!v.isExpanded}))},[]),p=x.useCallback(v=>{t(N=>({...N,isExpanded:v}))},[]),_=x.useCallback(v=>{t(N=>({...N,visualizationMode:v}))},[]),y=x.useCallback((v,N)=>{t(A=>{const D=N&&N.length>0?N:A.queue,M=D.length>0?D:[v],P=Math.max(0,M.findIndex(F=>F.id===v.id)),I=M[P]||v;return{...A,queue:M,queueIndex:P,currentAlbum:I,currentAlbumImage:I.imageDataURL,currentTrackTitle:I.title||I.mood,currentTime:0,playRequestId:A.playRequestId+1,isExpanded:!0}})},[]),w=x.useCallback(()=>{t(v=>({...v,playbackState:"PLAYING"}))},[]),S=x.useCallback(()=>{t(v=>({...v,playbackState:"PAUSED"}))},[]),E=x.useCallback(()=>{t(v=>({...v,playbackState:"STOPPED",currentTime:0}))},[]),b=x.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;let N=v.queueIndex+1;if(N>=v.queue.length)if(v.repeat==="all")N=0;else return{...v,playbackState:"STOPPED"};const A=v.queue[N];return{...v,queueIndex:N,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]),T=x.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;if(v.currentTime>3)return{...v,currentTime:0};let N=v.queueIndex-1;if(N<0)if(v.repeat==="all")N=v.queue.length-1;else return v;const A=v.queue[N];return{...v,queueIndex:N,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]),j=x.useCallback(v=>{t(N=>{if(v<0||v>=N.queue.length)return N;const A=N.queue[v];return{...N,queueIndex:v,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]);return a.jsx(Ua.Provider,{value:{state:e,setPlaying:s,setCurrentAlbum:i,setPlaybackState:r,setCurrentAlbumFull:o,setQueue:l,setCurrentTime:c,setDuration:u,setVolume:h,toggleMute:d,toggleShuffle:g,cycleRepeat:f,toggleExpanded:m,setExpanded:p,setVisualizationMode:_,requestPlayAlbum:y,play:w,pause:S,stop:E,next:b,previous:T,skipToIndex:j},children:n})},Rt=()=>{const n=x.useContext(Ua);if(!n)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return n},Ga=x.createContext(void 0),Ms=()=>{const n=x.useContext(Ga);if(!n)throw new Error("useToast must be used within ToastProvider");return n},Oo=({children:n})=>{const[e,t]=x.useState([]),s=x.useCallback((r,o,l=4e3)=>{const c=`toast-${Date.now()}-${Math.random()}`,u={id:c,type:r,message:o,duration:l};t(d=>[...d,u]);const h=setTimeout(()=>{i(c)},l);return()=>clearTimeout(h)},[]),i=x.useCallback(r=>{t(o=>o.filter(l=>l.id!==r))},[]);return a.jsxs(Ga.Provider,{value:{toasts:e,addToast:s,removeToast:i},children:[n,a.jsx(Po,{toasts:e})]})},Po=({toasts:n})=>a.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:n.map(e=>a.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[a.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),a.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class Fo extends x.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(i=>{i.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?a.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[a.jsx("h1",{children:"エラーが発生しました"}),a.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),a.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const $a=x.createContext(void 0),Lo=({value:n,children:e})=>a.jsx($a.Provider,{value:n,children:e}),wt=()=>{const n=x.useContext($a);if(!n)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return n},za=({open:n,onOpenChange:e,title:t,description:s,children:i,footer:r,size:o="md"})=>{const l=x.useId(),c=x.useId();return x.useEffect(()=>{if(!n)return;const u=h=>{h.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[n,e]),n?go.createPortal(a.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[a.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),a.jsxs("div",{className:`dialog-surface dialog-${o}`,role:"dialog","aria-modal":"true","aria-labelledby":l,"aria-describedby":s?c:void 0,children:[a.jsxs("header",{className:"dialog-header",children:[a.jsxs("div",{children:[a.jsx("h2",{id:l,className:"dialog-title",children:t}),s&&a.jsx("p",{id:c,className:"dialog-description",children:s})]}),a.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),a.jsx("div",{className:"dialog-body",children:i}),r?a.jsx("footer",{className:"dialog-footer",children:r}):null]})]}),document.body):null},ia="airia_feedback_nudge_open_count_v1",aa="airia_feedback_nudge_last_shown_at_v1";function Vo(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function qo(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Wo(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function Bo(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Uo(n){return n?(Date.now()-n)/(24*60*60*1e3):Number.POSITIVE_INFINITY}const Go=()=>{const{currentRoomId:n,navigateToRoom:e}=wt(),[t,s]=L.useState(!1),i=L.useRef(null);L.useEffect(()=>{if(n==="onboarding"||n==="feedback")return;const o=Vo(ia)+1;qo(ia,o);const l=Wo(aa);if(Uo(l)<10||o<4)return;const u=o<10?.05:.08;if(!(Math.random()>u))return i.current=window.setTimeout(()=>{document.visibilityState==="visible"&&(Bo(aa,Date.now()),s(!0))},7e3),()=>{i.current&&window.clearTimeout(i.current),i.current=null}},[n]);const r=()=>{s(!1),e("feedback")};return a.jsx(za,{open:t,onOpenChange:s,title:"フィードバックしませんか？",description:"短くてOK。気づいたことを教えてください。",size:"sm",footer:a.jsxs(a.Fragment,{children:[a.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>s(!1),children:"今はしない"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:r,children:"書く"})]}),children:a.jsx("p",{style:{margin:0,lineHeight:1.7},children:"バグ報告・改善案・良かった点、どれでも歓迎です。 送信時に診断情報も添付できるので、原因調査が早くなります。"})})},$o=({rooms:n,initialRoom:e="main"})=>{const t=n.findIndex(I=>I.id===e),[s,i]=x.useState(t>=0?t:0),[r,o]=x.useState(!1),[l,c]=x.useState(0),[u,h]=x.useState(0),[d,g]=x.useState(0),[f,m]=x.useState(null),p=x.useRef(null),_=I=>I instanceof Element?!!I.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,y=I=>{_(I.target)||(o(!0),c(I.touches[0].clientX),h(I.touches[0].clientY),m(null))},w=I=>{if(!r)return;const F=I.touches[0].clientX,V=I.touches[0].clientY,O=F-l,G=V-u;if(!f){const Y=Math.abs(O),H=Math.abs(G);if(Y<6&&H<6)return;if(H>Y*1.2){m("vertical"),o(!1),g(0);return}m("horizontal")}f==="horizontal"&&(I.preventDefault(),g(O))},S=()=>{if(!r)return;o(!1),Math.abs(d)>100&&(d>0&&s>0?i(s-1):d<0&&s<n.length-1&&i(s+1)),g(0),m(null)},E=I=>{_(I.target)||(o(!0),c(I.clientX),h(I.clientY),m(null))},b=I=>{if(!r)return;I.preventDefault();const F=I.clientX-l,V=I.clientY-u;if(!f){const O=Math.abs(F),G=Math.abs(V);if(O<6&&G<6)return;if(G>O*1.2){m("vertical"),o(!1),g(0);return}m("horizontal")}f==="horizontal"&&g(F)},T=()=>{if(!r)return;o(!1),Math.abs(d)>100&&(d>0&&s>0?i(s-1):d<0&&s<n.length-1&&i(s+1)),g(0),m(null)},j=()=>{r&&(Math.abs(d)>100&&(d>0&&s>0?i(s-1):d<0&&s<n.length-1&&i(s+1)),o(!1),g(0),m(null))},v=I=>{i(I),g(0)},N=p.current?.clientWidth||window.innerWidth||1,A=-s*100+d/N*100,D=n[s]?.id,M=D!=="onboarding",P=I=>{const F=n.findIndex(V=>V.id===I);F>=0&&v(F)};return a.jsxs(Lo,{value:{currentRoomId:D,navigateToRoom:P},children:[a.jsx(Go,{}),a.jsxs("div",{className:`room-navigator ${M?"":"indicators-hidden"}`,children:[M&&a.jsx("div",{className:"room-indicators","aria-label":"ルームナビゲーション",children:n.map((I,F)=>a.jsx("button",{className:`room-indicator ${F===s?"active":""}`,onClick:()=>v(F),"aria-current":F===s?"page":void 0,"aria-label":`${I.name}へ移動`,children:a.jsx("span",{className:"room-indicator-label",children:I.name})},I.id))}),a.jsx("div",{ref:p,className:"rooms-container",onTouchStart:y,onTouchMove:w,onTouchEnd:S,onMouseDown:E,onMouseMove:b,onMouseUp:T,onMouseLeave:j,style:{transform:`translateX(${A}%)`,transition:r?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:n.map(I=>a.jsx("div",{className:"room",children:I.component},I.id))})]})]})},ra="airia_onboarding_data",zo=[{value:"talk",title:"会話から",desc:"やさしく整えてから、次へ"},{value:"create",title:"創作から",desc:"早く作品に進みたい"}],Yo=[{value:"今日",title:"今日",desc:"いちばん最近の出来事"},{value:"今週",title:"今週",desc:"数日の範囲"},{value:"今月",title:"今月",desc:"少し長め"},{value:"少し前",title:"少し前",desc:"はっきりしない/覚えてない"}],Ho=[{value:"朝",title:"朝",desc:"スタートを整えたい"},{value:"昼",title:"昼",desc:"途中で乱れやすい"},{value:"夕方",title:"夕方",desc:"疲れが出やすい"},{value:"夜",title:"夜",desc:"余韻が残る/考えが巡る"}],oa=[{value:"穏やか",title:"穏やか",desc:"静か/落ち着く"},{value:"嬉しい",title:"嬉しい",desc:"軽い高揚/前向き"},{value:"不安",title:"不安",desc:"ざわつく/心配"},{value:"疲れ",title:"疲れ",desc:"消耗/休みたい"}],Xo=[{value:"達成/うまくいった",title:"達成",desc:"うまくいった/進んだ"},{value:"不確実/心配",title:"心配",desc:"先が読めない/不確実"},{value:"人間関係",title:"人",desc:"誰かとのやり取り"},{value:"体力/睡眠",title:"体",desc:"寝不足/疲労/体調"}],Jo=[{value:"仕事/学業",title:"仕事",desc:"締切/評価/責任"},{value:"人間関係",title:"人間関係",desc:"距離感/言葉/空気"},{value:"体調/睡眠",title:"体調",desc:"疲れ/睡眠/コンディション"},{value:"SNS/情報",title:"情報",desc:"比較/ニュース/刺激"}],Zo=[{value:"評価や期待が気になる",title:"評価",desc:"期待に応えたい/怖い"},{value:"比較してしまう",title:"比較",desc:"周りと比べて落ちる"},{value:"疲れると増幅する",title:"疲労",desc:"体力が落ちると不安が増える"},{value:"言語化できず溜まる",title:"未消化",desc:"うまく言えず残る"}],Ko=[{value:"落ち着いて集中したい",title:"集中",desc:"静かに深く入りたい"},{value:"安心して眠りたい",title:"眠り",desc:"夜にほどけたい"},{value:"不安を小さくしたい",title:"安心",desc:"ざわつきを鎮めたい"},{value:"気分を切り替えたい",title:"切替",desc:"短時間で整えたい"}],Qo=[{value:"1週間以内",title:"1週間",desc:"短期で変えたい"},{value:"1ヶ月以内",title:"1ヶ月",desc:"少しずつ整える"},{value:"3ヶ月以内",title:"3ヶ月",desc:"習慣化したい"},{value:"長期的",title:"長期",desc:"ゆっくり育てる"}],ec=({onComplete:n,onProgressChange:e})=>{const[t,s]=x.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),i={key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"choices",options:zo},r={key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"choices",options:Yo},o={key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"choices",options:oa},l={key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"一番近い理由を選んでください。",kind:"choices",options:Xo},c={key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"choices",options:Ho},u={key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"choices",options:oa},h={key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"一番近いものを選んでください。",kind:"choices",options:Jo},d={key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"一番近いものを選んでください。",kind:"choices",options:Zo},g={key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"choices",options:Ko},f={key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"choices",options:Qo},m=L.useMemo(()=>t.startMode==="create"?[i,o,g,f]:[i,r,o,l,c,u,h,d,g,f],[t.startMode]),[p,_]=x.useState(0),y=m.length;x.useEffect(()=>{p>m.length-1&&_(Math.max(0,m.length-1))},[p,m.length]),x.useEffect(()=>{const v=y>0?p/y:0;e?.(Math.min(v,.999))},[p,y,e]),x.useEffect(()=>{const v=localStorage.getItem(ra);if(v)try{const N=JSON.parse(v);s(N)}catch(N){console.error("Failed to parse saved onboarding data:",N)}},[]);const w=v=>{localStorage.setItem(ra,JSON.stringify(v))},S=(v,N)=>{const A={...t,[v]:N};s(A),w(A),p<y-1&&_(p+1)},E=()=>{p<y-1&&(w(t),_(p+1))},b=()=>{p>0&&(w(t),_(p-1))},T=()=>{const N={...t,recentMomentWhen:t.recentMomentWhen||"最近",dailyPatternWhen:t.dailyPatternWhen||(t.startMode==="create"?"夜":""),recentMomentEmotion:t.recentMomentEmotion||t.dailyPatternEmotion,dailyPatternEmotion:t.dailyPatternEmotion||t.recentMomentEmotion,recentMomentWhy:t.recentMomentWhy||"未指定",emotionalTrigger:t.emotionalTrigger||"未指定",emotionalTriggerWhy:t.emotionalTriggerWhy||"未指定",emotionalGoal:t.emotionalGoal||"落ち着いて集中したい",emotionalGoalTimeframe:t.emotionalGoalTimeframe||"1ヶ月以内",completedAt:new Date().toISOString()};s(N),w(N),n&&n(N)},j=()=>{const v=m[p];return String(t[v.key]??"").trim().length>0};return a.jsxs("div",{className:"onboarding-form",children:[a.jsxs("div",{className:"onboarding-header",children:[a.jsx("h2",{className:"blend-text",children:"はじめに"}),a.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),a.jsx("div",{className:"progress-bar",children:a.jsx("div",{className:"progress-fill",style:{width:`${(p+1)/y*100}%`}})}),a.jsxs("p",{className:"step-indicator",children:["ステップ ",p+1," / ",y]})]}),a.jsx("div",{className:"question-container",children:(()=>{const v=m[p];return a.jsxs("div",{className:"question-step",children:[a.jsx("h3",{className:"question-title",children:v.title}),v.description?a.jsx("p",{className:"question-description",children:v.description}):null,a.jsx("div",{className:"form-group",children:a.jsx("div",{className:"choice-grid",role:"group","aria-label":v.title,children:v.options.map(N=>{const D=String(t[v.key]??"")===N.value;return a.jsxs("button",{type:"button",className:`choice-btn ${D?"is-selected":""}`,onClick:()=>S(v.key,N.value),"aria-pressed":D,children:[a.jsx("div",{className:"choice-title",children:N.title}),N.desc?a.jsx("div",{className:"choice-desc",children:N.desc}):null]},N.value)})})})]})})()}),a.jsx("div",{className:"onboarding-actions","data-no-swipe":"true","aria-label":"オンボーディング操作",children:a.jsxs("div",{className:"button-group",children:[p>0&&a.jsx("button",{className:"btn btn-secondary",onClick:b,type:"button",children:"← 戻る"}),p<y-1?a.jsx("button",{className:"btn btn-primary",onClick:E,disabled:!j(),type:"button",children:"次へ →"}):a.jsx("button",{className:"btn btn-success",onClick:T,disabled:!j(),type:"button",children:"完了"})]})})]})},tc=({isActive:n})=>{const e=x.useRef(null),t=x.useRef(null);Ht(c=>{if(!e.current)return;e.current.rotation.z+=n?.002:.001;const u=Math.sin(c.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=n?.6:.3)});const s=[],i=5,r=50,o=i*r;for(let c=0;c<o;c++){const u=c/r,h=u*Math.PI*2,d=u*.5;s.push(new gn(Math.cos(h)*d,Math.sin(h)*d,u*.1))}const l=new Cs().setFromPoints(s);return a.jsx("line",{ref:e,geometry:l,children:a.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},sc=({isActive:n=!1})=>a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs(ms,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(tc,{isActive:n})]})}),nc=({isActive:n})=>{const e=x.useRef(null),t=x.useRef(null);Ht(u=>{if(!e.current)return;e.current.rotation.z+=n?.001:5e-4;const h=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(h),t.current&&(t.current.opacity=n?.5:.25)});const s=[],i=200,r=3,o=2,l=Math.PI/2;for(let u=0;u<=i;u++){const h=u/i*Math.PI*2,d=Math.sin(r*h+l)*1.5,g=Math.sin(o*h)*1.5,f=0;s.push(new gn(d,g,f))}const c=new Cs().setFromPoints(s);return a.jsx("line",{ref:e,geometry:c,children:a.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},ic=({isActive:n=!1})=>a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs(ms,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(nc,{isActive:n})]})}),ac=({isActive:n,ripples:e})=>{const t=x.useRef(null);Ht(i=>{if(!t.current)return;const r=i.clock.elapsedTime;t.current.children.forEach((o,l)=>{if(e[l]){const c=r-e[l].startTime,u=3;if(c<u){const h=1+c*.5;o.scale.setScalar(h);const d=1-c/u;o instanceof vo&&(o.material.opacity=d*(n?.6:.3))}else o.visible=!1}})});const s=()=>{const i=[];for(let l=0;l<=64;l++){const c=l/64*Math.PI*2;i.push(new gn(Math.cos(c)*1,Math.sin(c)*1,0))}return new Cs().setFromPoints(i)};return a.jsx("group",{ref:t,children:e.slice(-5).map(i=>a.jsx("line",{geometry:s(),children:a.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},i.id))})},rc=({isActive:n=!1,triggerRipple:e})=>{const[t,s]=x.useState([]),i=x.useRef(0);return x.useEffect(()=>{if(e){const r={id:i.current++,startTime:Date.now()/1e3};s(o=>[...o,r].slice(-5))}},[e]),x.useEffect(()=>{if(!n)return;const r=setInterval(()=>{const o={id:i.current++,startTime:Date.now()/1e3};s(l=>[...l,o].slice(-5))},2e3);return()=>clearInterval(r)},[n]),a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs(ms,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(ac,{isActive:n,ripples:t})]})})},oc=({isActive:n,progress:e,dominantColor:t,onComplete:s,mousePos:i})=>{const r=x.useRef(null),o=x.useRef(null),[l,c]=x.useState(!1),[u,h]=x.useState(0),d=x.useMemo(()=>new _o(t),[t]),g=x.useMemo(()=>{const f=new Cs,m=new Float32Array(100*3),p=new Float32Array(100*3);for(let _=0;_<100;_++){const y=Math.random()*Math.PI*2,w=Math.acos(2*Math.random()-1),S=1;m[_*3]=S*Math.sin(w)*Math.cos(y),m[_*3+1]=S*Math.sin(w)*Math.sin(y),m[_*3+2]=S*Math.cos(w),p[_*3]=m[_*3]*.02,p[_*3+1]=m[_*3+1]*.02,p[_*3+2]=m[_*3+2]*.02}return f.setAttribute("position",new Qi(m,3)),f.setAttribute("velocity",new Qi(p,3)),f},[]);return Ht(f=>{if(!r.current)return;const m=n?2*Math.PI/(30*60):2*Math.PI/(60*60);if(r.current.rotation.y+=m,r.current.rotation.x+=m*.5,n&&i.x!==0&&i.y!==0){const y=(i.x/window.innerWidth-.5)*.5,w=(i.y/window.innerHeight-.5)*.5;r.current.rotation.y+=(y-r.current.rotation.y)*.1,r.current.rotation.x+=(w-r.current.rotation.x)*.1}const p=20,_=Math.floor(e*p);if(_!==u&&_<p&&h(_),e>=1&&!l&&(c(!0),setTimeout(()=>{s?.()},1500)),l&&o.current){const y=g.getAttribute("position"),w=g.getAttribute("velocity");for(let S=0;S<100;S++)y.setXYZ(S,y.getX(S)+w.getX(S),y.getY(S)+w.getY(S),y.getZ(S)+w.getZ(S));y.needsUpdate=!0,r.current.material instanceof yo&&(r.current.material.opacity=Math.max(0,r.current.material.opacity-.02))}}),a.jsxs("group",{children:[!l&&a.jsxs("mesh",{ref:r,children:[a.jsx("icosahedronGeometry",{args:[1,0]}),a.jsx("meshStandardMaterial",{color:d,transparent:!0,opacity:.8,wireframe:!1,emissive:d,emissiveIntensity:u/20})]}),l&&a.jsx("points",{ref:o,geometry:g,children:a.jsx("pointsMaterial",{color:d,size:.05,transparent:!0,opacity:.8})})]})},cc=({isActive:n=!1,progress:e=0,onComplete:t,dominantColor:s="#D4AF37",layer:i="foreground",placement:r="center",sizePx:o=400,opacity:l})=>{const[c,u]=x.useState({x:0,y:0});x.useEffect(()=>{const f=m=>{u({x:m.clientX,y:m.clientY})};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]);const h=(()=>{switch(r){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),d=i==="background",g=typeof l=="number"?l:d?.14:1;return a.jsx("div",{style:{width:"100%",height:`${o}px`,position:"absolute",...h,transform:"translate(-50%, -50%)",pointerEvents:d?"none":n?"auto":"none",zIndex:d?-1:0,opacity:g},children:a.jsxs(ms,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx("pointLight",{position:[10,10,10],intensity:1}),a.jsx(oc,{isActive:n,progress:e,dominantColor:s,onComplete:t,mousePos:c})]})})},lc=({index:n,frequency:e,amplitude:t,color:s,mousePos:i,plucked:r})=>{const o=x.useRef(null),[l,c]=x.useState(0),[u,h]=x.useState(0),d=x.useMemo(()=>{const f=[];for(let _=0;_<100;_++){const y=_/100*4-2;f.push(new gn(y,0,0))}return f},[]);Ht(f=>{if(!o.current)return;const m=o.current.geometry.attributes.position,p=4,_=100;c(w=>w+e*.01),r&&h(w=>w+.2);const y=r?Math.exp(-u)*.5:0;for(let w=0;w<_;w++){const S=w/_*p-p/2,E=(i.x/window.innerWidth-.5)*8,b=(i.y/window.innerHeight-.5)*6,T=(n-2)*.4,j=Math.sqrt(Math.pow(E-S,2)+Math.pow(b-T,2)),v=Math.max(0,1-j/2)*.3,N=(t+v+y)*Math.sin(e*S+l),A=N,D=N*.2;m.setXYZ(w,S,A,D)}m.needsUpdate=!0,o.current.position.y=(n-2)*.4});const g=x.useMemo(()=>new Cs().setFromPoints(d),[d]);return a.jsx("line",{ref:o,geometry:g,children:a.jsx("lineBasicMaterial",{color:s,linewidth:2,transparent:!0,opacity:.8})})},uc=({isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:r})=>{const o=x.useMemo(()=>{const l=t<0?1:2,c=s*.2;return[{frequency:l,amplitude:e?.bass?e.bass/255*.3:c,color:"#FF4444"},{frequency:l*1.5,amplitude:e?.midLow?e.midLow/255*.3:c*.8,color:"#FF8844"},{frequency:l*2,amplitude:e?.mid?e.mid/255*.3:c*.6,color:"#FFDD44"},{frequency:l*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:c*.4,color:"#44DDFF"},{frequency:l*3,amplitude:e?.treble?e.treble/255*.3:c*.2,color:"#8844FF"}]},[e,t,s]);return a.jsx("group",{children:o.map((l,c)=>a.jsx(lc,{index:c,frequency:l.frequency,amplitude:l.amplitude,color:l.color,mousePos:i,plucked:r===c},c))})},hc=({isActive:n=!1,audioData:e=null,valence:t=0,arousal:s=.5})=>{const[i,r]=x.useState({x:0,y:0}),[o,l]=x.useState(-1);x.useEffect(()=>{const u=h=>{r({x:h.clientX,y:h.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const c=u=>{const h=u.currentTarget.getBoundingClientRect(),d=u.clientY-h.top,g=Math.floor(d/h.height*5);l(g),setTimeout(()=>l(-1),1e3)};return a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:n?"auto":"none",zIndex:0},onClick:c,children:a.jsxs(ms,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(uc,{isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:o})]})})},Ya=({pattern:n,isActive:e=!1,triggerRipple:t,progress:s=0,dominantColor:i="#D4AF37",layer:r="foreground",placement:o="center",sizePx:l,opacity:c,audioData:u=null,valence:h=0,arousal:d=.5,onComplete:g})=>{const[f,m]=x.useState(!1),[p,_]=x.useState(!1);return x.useEffect(()=>{const y=()=>{m(window.innerWidth<768)},w=window.matchMedia("(prefers-reduced-motion: reduce)");_(w.matches),y(),window.addEventListener("resize",y);const S=E=>{_(E.matches)};return w.addEventListener("change",S),()=>{window.removeEventListener("resize",y),w.removeEventListener("change",S)}},[]),f||p||n==="none"?null:a.jsxs(a.Fragment,{children:[n==="spiral"&&a.jsx(sc,{isActive:e}),n==="lissajous"&&a.jsx(ic,{isActive:e}),n==="ripples"&&a.jsx(rc,{isActive:e,triggerRipple:t}),n==="polyhedron"&&a.jsx(cc,{isActive:e,progress:s,dominantColor:i,onComplete:g,layer:r,placement:o,sizePx:l,opacity:c}),n==="stringVibration"&&a.jsx(hc,{isActive:e,audioData:u,valence:h,arousal:d})]})},Ot="https://airia-beyond.onrender.com";async function ti(n){const e=await fetch(`${Ot}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate image")}return e.json()}async function dc(n,e){const t=await fetch(`${Ot}/api/job/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get job status")}return t.json()}async function Js(n,e,t=60,s=2e3,i){for(let r=0;r<t;r++){if(i?.aborted)throw new DOMException("Aborted","AbortError");const o=await dc(n,i);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,s))}throw new Error("Job polling timeout")}async function mc(n){const e=await fetch(`${Ot}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to chat")}return e.json()}async function pc(n){const e=await fetch(`${Ot}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to refine event")}return e.json()}async function fc(n){const e=await fetch(`${Ot}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to name album title")}return e.json()}async function gc(n){const e=await fetch(`${Ot}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to resolve music preview")}return e.json()}async function Qs(n){const e=await Ke(`${Ot}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate music")}return e.json()}async function vc(n,e){const t=await Ke(`${Ot}/api/music/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get music job status")}return t.json()}async function is(n,e,t=60,s=2e3,i){for(let r=0;r<t;r++){if(i?.aborted)throw new DOMException("Aborted","AbortError");const o=await vc(n,i);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,s))}throw new Error("Music job polling timeout")}const _c="airia_onboarding_data";function yc(){try{const n=localStorage.getItem(_c);if(!n)return null;const e=JSON.parse(n);return!e||typeof e!="object"?null:e}catch{return null}}function ca(n){return Math.max(0,Math.min(1,n))}function bc(n){return Math.max(-1,Math.min(1,n))}function la(n){switch(String(n??"").trim()){case"穏やか":return{valence:.15,arousal:.25};case"嬉しい":return{valence:.65,arousal:.65};case"不安":return{valence:-.55,arousal:.65};case"疲れ":return{valence:-.2,arousal:.25};case"怒り":return{valence:-.65,arousal:.85};case"悲しい":return{valence:-.7,arousal:.35};case"興奮":return{valence:.5,arousal:.9};case"退屈":return{valence:-.1,arousal:.15};default:return{valence:0,arousal:.45}}}function xc(n){const e=new Set,t=n.recentMomentEmotion||n.dailyPatternEmotion,s=String(t??"").trim();e.add("余韻"),e.add("光"),s==="不安"?(e.add("霧"),e.add("揺れ")):s==="穏やか"?(e.add("水面"),e.add("静寂")):s==="疲れ"?(e.add("夜"),e.add("静寂")):s==="嬉しい"?(e.add("風"),e.add("朝")):s==="悲しい"?(e.add("影"),e.add("雨")):s==="怒り"?(e.add("火"),e.add("鋭さ")):s==="興奮"?(e.add("閃光"),e.add("躍動")):s==="退屈"&&(e.add("無音"),e.add("空"));const i=String(n.emotionalGoal??"").trim();return i.includes("集中")&&e.add("集中"),(i.includes("安心")||i.includes("安"))&&e.add("安心"),i.includes("眠")&&e.add("眠り"),i.includes("整")&&e.add("整う"),[...e].slice(0,5)}function wc(n){const e=n.recentMomentEmotion||n.dailyPatternEmotion||"未指定",t=String(n.emotionalGoal??"").trim(),s=String(n.emotionalTrigger??"").trim();return{emotionalProfile:[`startMode:${n.startMode||"未指定"}`,`mood:${e}`,t?`goal:${t.slice(0,80)}`:null,s?`trigger:${s.slice(0,60)}`:null].filter(Boolean).join(" / "),preferences:{...n,startMode:n.startMode}}}function Nc(n){const e=la(n.recentMomentEmotion),t=la(n.dailyPatternEmotion),s=bc((e.valence+t.valence)/2),i=ca((e.arousal+t.arousal)/2),r=ca(n.startMode==="create"?.78:.68),o=xc(n),l=.65,c=n.startMode==="create"?210:180;return{valence:s,arousal:i,focus:r,motif_tags:o,confidence:l,duration:c}}function Sc(n){const e=String(n.title).trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),i=Math.abs(s.split("").reduce((o,l)=>o*33+l.charCodeAt(0),7))%360,r=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${i} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(i+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(i+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${ua(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${ua(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">Generated from onboarding</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(r)}`}function ua(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}const pi="airia_pending_chat_generation_v1",fi="airia_pending_onboarding_generation_v1";function $n(){try{const n=localStorage.getItem(pi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="chat"||!e.musicJobId?null:e}catch{return null}}function ha(n){try{localStorage.setItem(pi,JSON.stringify(n))}catch{}}function da(){try{localStorage.removeItem(pi)}catch{}}function Ss(){try{const n=localStorage.getItem(fi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="onboarding"||!e.musicJobId||!e.request||!e.coverDataUrl?null:e}catch{return null}}function ma(n){try{localStorage.setItem(fi,JSON.stringify(n))}catch{}}function Ns(){try{localStorage.removeItem(fi)}catch{}}function Ha({open:n,title:e,description:t,cancelLabel:s="キャンセル",confirmLabel:i="実行",confirmTone:r="primary",onCancel:o,onConfirm:l}){return x.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&o(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&l()};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,o,l]),n?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"confirm-dialog-backdrop",onClick:o}),a.jsxs("div",{className:"confirm-dialog",role:"dialog","aria-modal":"true","aria-label":e,children:[a.jsxs("div",{className:"confirm-dialog-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"confirm-dialog-eyebrow",children:"確認"}),a.jsx("h2",{className:"confirm-dialog-title",children:e})]}),a.jsx("button",{className:"confirm-dialog-close",onClick:o,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),t?a.jsx("div",{className:"confirm-dialog-body",children:t}):null,a.jsxs("div",{className:"confirm-dialog-actions",children:[a.jsx("button",{className:"btn btn-secondary",onClick:o,children:s}),a.jsx("button",{className:r==="danger"?"btn btn-primary confirm-dialog-danger":"btn btn-primary",onClick:l,children:i})]}),a.jsx("div",{className:"confirm-dialog-shortcut",children:"確定: クリック / (Ctrl+Enter)"})]})]}):null}function Xa({active:n,statusText:e,elapsedSec:t=0,onCancel:s}){if(!n)return null;const r=.85-.35*Math.max(0,Math.min(1,t/22));return a.jsxs("div",{className:"gen-frost",style:{"--frost":r},"aria-live":"polite","aria-busy":"true",children:[a.jsx("div",{className:"gen-frost-surface"}),a.jsxs("div",{className:"gen-frost-card",role:"status",children:[a.jsx("div",{className:"gen-frost-title",children:"生成中"}),a.jsxs("div",{className:"gen-frost-status",children:[e||"進行中…",a.jsxs("span",{className:"gen-frost-elapsed",children:["（",t,"s）"]})]}),s?a.jsx("button",{className:"gen-frost-cancel",onClick:s,type:"button",children:"キャンセル"}):null]})]})}const Tc=({onExit:n})=>{const{albums:e,addAlbum:t,selectAlbum:s}=bt(),{requestPlayAlbum:i}=Rt(),{addToast:r}=Ms(),[o,l]=x.useState(!1),[c,u]=x.useState(null),[h,d]=x.useState(0),[g,f]=x.useState(!1),[m,p]=x.useState(null),[_,y]=x.useState(null),[w,S]=x.useState(null),[E,b]=x.useState(0),[T,j]=x.useState(!1),v=x.useRef(!1),N=x.useRef(null),A=x.useRef(!1),[D,M]=x.useState(!1),P=x.useMemo(()=>e.filter(U=>U.musicData),[e]);x.useEffect(()=>{const U=Ss();j(!!U),U&&!A.current&&(A.current=!0,r("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]);const I=U=>{u(U),l(!0)},F=()=>{l(!1),u(null),d(0),f(!1),p(null),y(null),S(null),b(0),N.current?.abort(),N.current=null,Ns(),j(!1),v.current=!1};x.useEffect(()=>{if(!g||!w)return;b(Math.max(0,Math.floor((Date.now()-w)/1e3)));const U=window.setInterval(()=>{b(Math.max(0,Math.floor((Date.now()-w)/1e3)))},1e3);return()=>window.clearInterval(U)},[g,w]);const V=U=>U.recentMomentEmotion||U.dailyPatternEmotion||"穏やか",O=async()=>{if(!c||g)return;const U=Ss();if(!U)return;p(null),y("再開中…"),f(!0),S(U.startedAt||Date.now()),b(0),r("info","生成を再開しています…"),N.current?.abort();const Q=new AbortController;N.current=Q;try{const B=await is(U.musicJobId,R=>{R.status==="queued"?y("順番待ち…"):R.status==="running"?y("生成中…"):R.status==="succeeded"?y("仕上げ中…"):R.status==="failed"&&y("失敗しました")},90,2e3,Q.signal);if(B.status!=="succeeded"||!B.midiData||!B.result)throw new Error(B.errorMessage||B.error||"曲生成に失敗しました");y("保存しています…");const C=t({title:U.title,mood:U.mood,duration:U.request.duration,imageDataURL:U.coverDataUrl,thumbnailUrl:U.coverDataUrl,metadata:{valence:U.request.valence,arousal:U.request.arousal,focus:U.request.focus,motif_tags:U.request.motif_tags,confidence:U.request.confidence,provider:"rule-based"},musicData:B.midiData,musicFormat:"midi",musicMetadata:{key:B.result.key,tempo:B.result.tempo,timeSignature:B.result.timeSignature,form:B.result.form,character:B.result.character,duration:U.request.duration,createdAt:new Date().toISOString(),provider:B.provider},sessionData:{onboarding:c}});s(C.id),i(C,[C,...P]),Ns(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(B){if(B instanceof DOMException&&B.name==="AbortError"){y("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}p(B instanceof Error?B.message:"曲生成に失敗しました"),y(null),r("error",B instanceof Error?B.message:"曲生成に失敗しました")}finally{f(!1),N.current=null}},G=async()=>{if(g||!c)return;const U=Ss();if(!U)return;p(null),y("再生成を開始しています…"),f(!0),S(Date.now()),b(0),r("info","同じ条件で再生成を開始しました。"),N.current?.abort();const Q=new AbortController;N.current=Q;try{const B=await Qs(U.request);ma({...U,startedAt:Date.now(),musicJobId:B.jobId}),j(!0);const C=await is(B.jobId,k=>{k.status==="queued"?y("順番待ち…"):k.status==="running"?y("生成中…"):k.status==="succeeded"?y("仕上げ中…"):k.status==="failed"&&y("失敗しました")},90,2e3,Q.signal);if(C.status!=="succeeded"||!C.midiData||!C.result)throw new Error(C.errorMessage||C.error||"曲生成に失敗しました");y("保存しています…");const R=t({title:U.title,mood:U.mood,duration:U.request.duration,imageDataURL:U.coverDataUrl,thumbnailUrl:U.coverDataUrl,metadata:{valence:U.request.valence,arousal:U.request.arousal,focus:U.request.focus,motif_tags:U.request.motif_tags,confidence:U.request.confidence,provider:"rule-based"},musicData:C.midiData,musicFormat:"midi",musicMetadata:{key:C.result.key,tempo:C.result.tempo,timeSignature:C.result.timeSignature,form:C.result.form,character:C.result.character,duration:U.request.duration,createdAt:new Date().toISOString(),provider:C.provider},sessionData:{onboarding:c}});s(R.id),i(R,[R,...P]),Ns(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(B){if(B instanceof DOMException&&B.name==="AbortError"){y("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}const C=B instanceof Error?B.message:"曲生成に失敗しました";p(C),y(null),r("error",C)}finally{f(!1),N.current=null}},Y=async()=>{if(!c||g)return;p(null),y("準備中…"),f(!0),S(Date.now()),b(0),N.current?.abort();const U=new AbortController;N.current=U;try{const Q=V(c),B=`${Date.now()}`,C=Sc({title:"はじめの一曲",mood:Q,seed:B}),R=Nc(c);y("作曲を開始しています…");const k=await Qs({...R,seed:Number(B.slice(-9))});ma({v:1,kind:"onboarding",startedAt:Date.now(),musicJobId:k.jobId,request:{...R,seed:Number(B.slice(-9))},mood:Q,title:"はじめの一曲",coverDataUrl:C}),j(!0),r("info","生成を開始しました。完了まで待つか、あとで再開できます。"),y("生成中…（1〜2分かかることがあります）");const W=await is(k.jobId,Ee=>{Ee.status==="queued"?y("順番待ち…"):Ee.status==="running"?y("生成中…"):Ee.status==="succeeded"?y("仕上げ中…"):Ee.status==="failed"&&y("失敗しました")},90,2e3,U.signal);if(W.status!=="succeeded"||!W.midiData||!W.result)throw new Error(W.errorMessage||W.error||"曲生成に失敗しました");y("保存しています…");const oe=t({title:"はじめの一曲",mood:Q,duration:R.duration,imageDataURL:C,thumbnailUrl:C,metadata:{valence:R.valence,arousal:R.arousal,focus:R.focus,motif_tags:R.motif_tags,confidence:R.confidence,provider:"rule-based"},musicData:W.midiData,musicFormat:"midi",musicMetadata:{key:W.result.key,tempo:W.result.tempo,timeSignature:W.result.timeSignature,form:W.result.form,character:W.result.character,duration:R.duration,createdAt:new Date().toISOString(),provider:W.provider},sessionData:{onboarding:c}});s(oe.id),i(oe,[oe,...P]),Ns(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(Q){if(Q instanceof DOMException&&Q.name==="AbortError"){y("キャンセルしました"),S(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。");return}p(Q instanceof Error?Q.message:"曲生成に失敗しました"),y(null),S(null),b(0),r("error",Q instanceof Error?Q.message:"曲生成に失敗しました")}finally{f(!1),N.current=null}},H=()=>{g&&(N.current?.abort(),f(!1),y("キャンセルしました"),S(null),b(0),r("info","生成を中断しました。あとで再開できます。"))},X=()=>{Ns(),j(!1),y(null),p(null),r("info","保留中の生成を破棄しました。")},ee=()=>{g&&(N.current?.abort(),N.current=null,f(!1),y("キャンセルしました"),S(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。"))};return x.useEffect(()=>{!o||!c||v.current||c.startMode==="create"&&(v.current=!0,Ss()?O():Y())},[o,c]),a.jsxs("div",{className:"room-content onboarding-room","data-no-swipe":"true",children:[a.jsx(Xa,{active:g,statusText:_,elapsedSec:E,onCancel:ee}),a.jsx(Ha,{open:D,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>M(!1),onConfirm:()=>{M(!1),X()}}),!o&&a.jsx(Ya,{pattern:"polyhedron",isActive:!0,progress:h,layer:"background",placement:"center",sizePx:420,opacity:.16}),a.jsx("h1",{className:"room-title",children:"はじめに"}),a.jsx("p",{className:"room-subtitle",children:"あなたに合う体験へ整えます"}),o?a.jsxs("div",{className:"onboarding-complete",children:[a.jsx("h2",{className:"blend-text",children:"完了しました！"}),a.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",a.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),m?a.jsx("div",{className:"form-error",children:m}):null,_?a.jsxs("div",{className:"onboarding-generate-status",children:[_,w?a.jsxs("span",{className:"onboarding-generate-elapsed",children:["（",E,"s）"]}):null]}):null,a.jsxs("div",{className:"button-group",children:[a.jsx("button",{className:"btn btn-secondary",onClick:F,children:"回答を編集"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>void Y(),disabled:g,"data-no-swipe":!0,title:"オンボーディング回答から1曲生成して、そのまま再生します",children:g?"1曲生成中…":"1曲作ってはじめる"}),!g&&T?a.jsx("button",{className:"btn btn-secondary",onClick:()=>void O(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!g&&T&&m?a.jsx("button",{className:"btn btn-secondary",onClick:()=>void G(),"data-no-swipe":!0,type:"button",title:"失敗・停止した場合に、同じ条件で作り直します",children:"再生成"}):null,!g&&T?a.jsx("button",{className:"btn btn-secondary",onClick:()=>M(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null,g?a.jsx("button",{className:"btn btn-secondary",onClick:H,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,a.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!c)return;const U=JSON.stringify(c,null,2),Q=new Blob([U],{type:"application/json"}),B=URL.createObjectURL(Q),C=document.createElement("a");C.href=B,C.download="getting_started_profile.json",C.click(),URL.revokeObjectURL(B)},children:"プロフィールをダウンロード"}),a.jsx("button",{className:"btn btn-success",onClick:()=>{n?.()},children:"はじめる"})]})]}):a.jsx(ec,{onComplete:I,onProgressChange:d})]})},jc=void 0,kc=({onBack:n})=>{const{loginWithGoogle:e,loginWithApple:t,loading:s}=As(),i=L.useRef(null),[r,o]=L.useState(null);L.useEffect(()=>{o(null)},[e]);const l=async()=>{o(null);{o("Apple Client ID が未設定です");return}},c=!!jc;return a.jsx("div",{className:"room-content auth-room",children:a.jsxs("div",{className:"auth-card","data-no-swipe":"true",children:[n?a.jsx("div",{style:{marginBottom:8},children:a.jsx("button",{className:"btn",onClick:n,disabled:s,children:"← 戻る"})}):null,a.jsx("h1",{className:"auth-title",children:"AIRIA"}),a.jsx("p",{className:"auth-subtitle",children:"はじめるにはログインが必要です"}),a.jsxs("div",{className:"auth-actions",children:[a.jsx("div",{className:`auth-google ${c?"":"disabled"}`,children:c?a.jsx("div",{ref:i}):a.jsx("button",{className:"btn",disabled:!0,children:"Googleでログイン（未設定）"})}),a.jsxs("button",{className:"btn btn-apple",onClick:()=>void l(),disabled:s||!0,children:["Appleでログイン","（未設定）"]})]}),r&&a.jsx("div",{className:"auth-error",children:r}),a.jsx("div",{className:"auth-note",children:a.jsx("p",{children:"プレリリースでは Google / Apple ログインのみ対応します。"})})]})})},Cc=({onStart:n,onOpenTerms:e,onOpenPrivacy:t})=>{const s=i=>{const r=document.getElementById(i);r&&"scrollIntoView"in r&&r.scrollIntoView({behavior:"smooth",block:"start"})};return a.jsxs("div",{className:"room-content landing-room",children:[a.jsx("div",{className:"landing-hero","data-no-swipe":"true",children:a.jsxs("div",{className:"landing-hero-inner",children:[a.jsxs("div",{className:"landing-hero-copy",children:[a.jsxs("div",{className:"landing-hero-toprow",children:[a.jsx("div",{className:"landing-eyebrow",children:"MOOD → IMAGE → MUSIC"}),(t||e)&&a.jsxs("div",{className:"landing-legal","aria-label":"Legal",children:[t?a.jsx("button",{type:"button",className:"landing-legal-link",onClick:t,children:"Privacy"}):null,t&&e?a.jsx("span",{className:"landing-legal-sep","aria-hidden":"true",children:"·"}):null,e?a.jsx("button",{type:"button",className:"landing-legal-link",onClick:e,children:"Terms"}):null]})]}),a.jsxs("h1",{className:"landing-title",children:["AIRIA BEYOND",a.jsx("span",{className:"landing-title-sub",children:"感情を、作品に変える。"})]}),a.jsxs("p",{className:"landing-lead",children:["その日の気分を記録して、抽象画とクラシック風の音楽へ。",a.jsx("br",{}),"“言葉にならない”を、見える・聴ける形にして保存します。"]}),a.jsxs("div",{className:"landing-cta",children:[a.jsx("button",{className:"btn btn-primary landing-cta-primary",onClick:n,children:"ログインしてはじめる"}),a.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>s("landing-how"),"aria-label":"AIRIAの使い方へスクロール",children:"どうやって動く？"})]}),a.jsxs("div",{className:"landing-meta",children:[a.jsx("span",{className:"landing-chip",children:"プレリリース"}),a.jsx("span",{className:"landing-chip",children:"Google / Apple ログイン"}),a.jsx("span",{className:"landing-chip",children:"生成失敗でも止めない設計"}),a.jsx("span",{className:"landing-chip",children:"最短ルート：ログイン → 「創作から」"})]})]}),a.jsxs("div",{className:"landing-hero-cover","aria-label":"サンプルプレビュー",children:[a.jsxs("div",{className:"landing-cover-card",children:[a.jsxs("div",{className:"landing-cover-top",children:[a.jsx("div",{className:"landing-cover-kicker",children:"Today’s Session"}),a.jsx("div",{className:"landing-cover-date",children:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),a.jsx("div",{className:"landing-cover-title",children:"静けさと余白"}),a.jsx("div",{className:"landing-cover-sub",children:"穏やか / 3:00 / Focus 0.62"}),a.jsx("div",{className:"landing-cover-image",role:"img","aria-label":"生成イメージのモック"}),a.jsxs("div",{className:"landing-cover-bottom",children:[a.jsxs("div",{className:"landing-cover-pills",children:[a.jsx("span",{className:"landing-pill",children:"Valence"}),a.jsx("span",{className:"landing-pill",children:"Arousal"}),a.jsx("span",{className:"landing-pill",children:"Motif"})]}),a.jsxs("div",{className:"landing-cover-wave","aria-hidden":"true",children:[a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"}),a.jsx("div",{className:"landing-wave-bar"})]})]})]}),a.jsx("div",{className:"landing-cover-note",children:"これは体験イメージです。実際の生成はあなたの入力に合わせて変化します。"})]})]})}),a.jsxs("section",{className:"landing-section",id:"landing-how",children:[a.jsxs("div",{className:"landing-section-head",children:[a.jsx("h2",{className:"landing-h2",children:"体験は“記事”のように読み進められる"}),a.jsx("p",{className:"landing-sub",children:"AIRIAは、ただの生成ツールではなく「自分の状態を読み解くための記録」です。 迷いにくい導線と、気持ちよく続くUIを優先しました。"})]}),a.jsxs("div",{className:"landing-steps","data-no-swipe":"true",children:[a.jsxs("article",{className:"landing-step",children:[a.jsx("div",{className:"landing-step-no",children:"01"}),a.jsx("h3",{className:"landing-h3",children:"気分を入力"}),a.jsx("p",{className:"landing-p",children:"短い質問に答えるだけ。言語化が苦手でもOK。"})]}),a.jsxs("article",{className:"landing-step",children:[a.jsx("div",{className:"landing-step-no",children:"02"}),a.jsx("h3",{className:"landing-h3",children:"抽象画を生成"}),a.jsx("p",{className:"landing-p",children:"色・構図・質感で、その日の“温度”を可視化します。"})]}),a.jsxs("article",{className:"landing-step",children:[a.jsx("div",{className:"landing-step-no",children:"03"}),a.jsx("h3",{className:"landing-h3",children:"音楽を生成"}),a.jsx("p",{className:"landing-p",children:"クラシック風の短編。再生バーからすぐ聴けます。"})]}),a.jsxs("article",{className:"landing-step",children:[a.jsx("div",{className:"landing-step-no",children:"04"}),a.jsx("h3",{className:"landing-h3",children:"保存・共有"}),a.jsx("p",{className:"landing-p",children:"Socialに公開、反応を受け取る。非公開・削除も可能です。"})]})]}),a.jsx("div",{className:"landing-divider"}),a.jsxs("div",{className:"landing-grid","data-no-swipe":"true",children:[a.jsxs("article",{className:"landing-card",children:[a.jsx("h3",{className:"landing-h3",children:"止まらない体験"}),a.jsx("p",{className:"landing-p",children:"生成が失敗しても、placeholderや緊急MIDIで進行します。待ち時間のストレスを最小化。"})]}),a.jsxs("article",{className:"landing-card",children:[a.jsx("h3",{className:"landing-h3",children:"説明可能性"}),a.jsx("p",{className:"landing-p",children:"“なぜこの作品になったか”を見える形で提示。ブラックボックス感を減らします。"})]}),a.jsxs("article",{className:"landing-card",children:[a.jsx("h3",{className:"landing-h3",children:"運用前提の設計"}),a.jsx("p",{className:"landing-p",children:"OAuth-only、レート制限、通知（任意）など、プレリリースでも破綻しにくい土台を用意。"})]})]})]}),a.jsxs("section",{className:"landing-section landing-section-narrow",children:[a.jsxs("div",{className:"landing-section-head",children:[a.jsx("h2",{className:"landing-h2",children:"コンセプト"}),a.jsx("p",{className:"landing-sub",children:"“感情を作品に変える”は、自己理解の入り口になる。"})]}),a.jsxs("article",{className:"landing-article","data-no-swipe":"true",children:[a.jsx("p",{className:"landing-article-p",children:"気分は、言葉で説明しきれないことが多い。AIRIAは、入力を起点に「視覚」と「音楽」でその輪郭をつくります。 生成物は正解ではなく、あなたが自分を読み解くための“鏡”。"}),a.jsx("p",{className:"landing-article-p",children:"だからUIは、派手さよりも継続性を優先。余白、静けさ、そして必要なときだけ現れる強い導線。 アプリ全体がひとつの短い文章のように流れる設計です。"}),a.jsxs("div",{className:"landing-quote",children:[a.jsx("div",{className:"landing-quote-mark","aria-hidden":"true",children:"“"}),a.jsxs("div",{children:[a.jsx("div",{className:"landing-quote-text",children:"今日を作品として保存できると、気分は“消費”ではなく“蓄積”になる。"}),a.jsx("div",{className:"landing-quote-sub",children:"AIRIA BEYOND / Design note"})]})]})]})]}),a.jsxs("section",{className:"landing-section landing-bottom","data-no-swipe":"true",children:[a.jsxs("div",{className:"landing-bottom-inner",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"landing-h2",children:"準備はできましたか？"}),a.jsx("p",{className:"landing-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),a.jsxs("div",{className:"landing-bottom-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:n,children:"ログインしてはじめる"}),a.jsx("button",{className:"btn",onClick:()=>s("landing-how"),children:"もう一度読む"})]})]}),a.jsxs("footer",{className:"landing-footer",children:[a.jsxs("div",{className:"landing-footer-row",children:[a.jsx("div",{className:"landing-footer-brand",children:"AIRIA BEYOND"}),a.jsx("div",{className:"landing-footer-note",children:"Pre-release / OAuth-only"})]}),(t||e)&&a.jsxs("div",{className:"landing-footer-links","aria-label":"Legal",children:[t?a.jsx("button",{type:"button",className:"landing-footer-link",onClick:t,children:"プライバシー"}):null,e?a.jsx("button",{type:"button",className:"landing-footer-link",onClick:e,children:"利用規約"}):null]})]})]})]})},Ac=()=>a.jsxs("div",{className:"legal-page",children:[a.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[a.jsx("h2",{children:"1. サービスの概要 / Service Overview"}),a.jsx("p",{children:"AIRIA BEYONDは、AI搭載の感情分析・クラシック音楽・絵画生成アプリケーションです。 ユーザーの感情状態を分析し、それに基づいてクラシック音楽や絵画を生成します。"}),a.jsx("p",{children:"AIRIA BEYOND is an AI-powered application for emotion analysis, classical music, and painting generation. It analyzes users' emotional states and generates classical music and paintings based on the analysis."})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"2. データの取り扱い / Data Handling"}),a.jsx("p",{children:"個人を特定できる情報は送信されません。セッションデータ、生成された画像・音楽は ブラウザのローカルストレージに保存されます。"}),a.jsx("p",{children:"No personally identifiable information is transmitted. Session data, generated images and music are stored in browser's local storage."})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"3. 使用制限 / Usage Restrictions"}),a.jsx("p",{children:"本サービスは個人的な使用のみを目的としています。商用利用には事前の許可が必要です。"}),a.jsx("p",{children:"This service is intended for personal use only. Commercial use requires prior permission."})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"4. 免責事項 / Disclaimer"}),a.jsx("p",{children:"本サービスは「現状のまま」提供されます。生成されたコンテンツの正確性や適切性について 保証しません。"}),a.jsx("p",{children:'This service is provided "as is". We do not guarantee the accuracy or appropriateness of generated content.'})]}),a.jsx("div",{className:"legal-note",children:"プレリリース期間中は仕様が更新される場合があります。重要な変更はアプリ内のお知らせで通知します。"})]}),Mc=()=>a.jsxs("div",{className:"legal-page",children:[a.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[a.jsx("h2",{children:"1. 収集する情報 / Information We Collect"}),a.jsxs("ul",{children:[a.jsx("li",{children:"セッションデータ（気分、時間） / Session data (mood, duration)"}),a.jsx("li",{children:"生成された画像・音楽 / Generated images and music"}),a.jsx("li",{children:"アクセスログ / Access logs"}),a.jsx("li",{children:"パフォーマンス指標 / Performance metrics"})]})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"2. データの使用目的 / Purpose of Data Use"}),a.jsx("p",{children:"収集したデータは以下の目的で使用されます："}),a.jsxs("ul",{children:[a.jsx("li",{children:"サービスの提供と改善 / Service provision and improvement"}),a.jsx("li",{children:"パフォーマンスの監視 / Performance monitoring"}),a.jsx("li",{children:"エラーのトラッキングと修正 / Error tracking and fixing"})]})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"3. データの保存 / Data Storage"}),a.jsx("p",{children:"ユーザーデータは主にブラウザのローカルストレージに保存されます。 サーバー側では一時的な処理のみが行われます。"}),a.jsx("p",{children:"User data is primarily stored in browser's local storage. Server-side processing is temporary only."}),a.jsx("div",{className:"legal-note",children:"ログインによりサーバー側にユーザー情報が保存されます（例: ハンドル、表示名、フォロー関係）。 メール通知を有効化した場合は、通知先としてメールアドレスを保存します。"})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"4. 第三者サービス / Third-Party Services"}),a.jsx("p",{children:"本サービスは以下の第三者サービスを使用します："}),a.jsxs("ul",{children:[a.jsx("li",{children:"Replicate (画像生成 / Image generation)"}),a.jsx("li",{children:"OpenAI (感情分析 / Emotion analysis)"}),a.jsx("li",{children:"Render (APIホスティング / API hosting)"}),a.jsx("li",{children:"GitHub Pages (フロントエンド配信 / Frontend hosting)"}),a.jsx("li",{children:"Sentry (エラートラッキング / Error tracking) - オプション"}),a.jsx("li",{children:"Resend / SMTP (メール通知 / Email notifications) - オプション"})]})]}),a.jsxs("section",{className:"legal-section",children:[a.jsx("h2",{children:"5. お問い合わせ / Contact"}),a.jsx("p",{children:"プライバシーに関するご質問は、GitHubリポジトリのIssueにてお問い合わせください。"}),a.jsx("p",{children:"For privacy-related questions, please contact us via GitHub repository Issues."})]})]}),pa=({kind:n,onBack:e,onStart:t})=>{const s=n==="terms"?"利用規約":"プライバシーポリシー",i=n==="terms"?"Terms of Service":"Privacy Policy";return a.jsxs("div",{className:"room-content legal-room","data-no-swipe":"true",children:[a.jsxs("div",{className:"legal-topbar",children:[a.jsx("button",{className:"btn",onClick:e,children:"← 戻る"}),a.jsx("div",{className:"legal-topbar-spacer"}),a.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインへ"})]}),a.jsxs("header",{className:"legal-hero",children:[a.jsx("div",{className:"legal-hero-kicker",children:"AIRIA BEYOND / Legal"}),a.jsxs("h1",{className:"legal-hero-title",children:[s,a.jsx("span",{className:"legal-hero-sub",children:i})]}),a.jsx("p",{className:"legal-hero-lead",children:"ここに書かれていることは“堅い文章”ですが、AIRIAが守ろうとしているのは体験の安心感です。 わからない点があれば、GitHubのIssueから相談できます。"})]}),a.jsx("main",{className:"legal-body",children:n==="terms"?a.jsx(Ac,{}):a.jsx(Mc,{})}),a.jsx("div",{className:"legal-bottom","data-no-swipe":"true",children:a.jsxs("div",{className:"legal-bottom-inner",children:[a.jsxs("div",{children:[a.jsx("div",{className:"legal-bottom-title",children:"続きはアプリで"}),a.jsx("div",{className:"legal-bottom-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),a.jsxs("div",{className:"legal-bottom-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインしてはじめる"}),a.jsx("button",{className:"btn",onClick:e,children:"戻る"})]})]})})]})};function Ec(n,e,t){try{n(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(s){console.error("[CausalLog] Failed to log album creation stage:",s)}}function Qt(n,e,t,s,i){try{const o=e(t)?.errors||[];n(t,{errors:[...o,{stage:s,error:i,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",s)}catch(r){console.error("[CausalLog] Failed to log error:",r)}}function zn(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function Ic(n){const e=String(n.title??"").trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),i=String(n.note).trim()||"Placeholder cover",r=Math.abs(s.split("").reduce((l,c)=>l*33+c.charCodeAt(0),7))%360,o=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${r} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(r+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(r+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${zn(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${zn(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">${zn(i).slice(0,64)}</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(o)}`}function Dc({open:n,mood:e,defaultTitle:t,onCancel:s,onSubmit:i}){const[r,o]=x.useState(t??"");x.useEffect(()=>{n&&o(t??"")},[n,t]);const l=x.useMemo(()=>r.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[r]);return x.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&s(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&i(r)};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,s,i,r]),n?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"album-title-backdrop",onClick:s}),a.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[a.jsxs("div",{className:"album-title-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),a.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),a.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),a.jsx("button",{className:"album-title-close",onClick:s,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),a.jsxs("div",{className:"album-title-body",children:[a.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),a.jsx("input",{id:"album-title-input",className:"album-title-input",value:r,placeholder:"例：雨上がりの余白",onChange:c=>o(c.target.value),autoFocus:!0}),a.jsx("div",{className:"album-title-hint",children:l}),a.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),a.jsxs("div",{className:"album-title-actions",children:[a.jsx("button",{className:"btn btn-secondary",onClick:s,children:"キャンセル"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>i(r),children:"保存"})]})]})]}):null}function Yn(){return new Date().toISOString()}function Hn(n,e){return Ic({title:n?.brief?.theme?.title,mood:n?.image?.mood,seed:n?.image?.seed,note:e})}function Xn(n){return n?.effectiveProvider||n?.provider||(n?.status==="succeeded"?"image":"placeholder")}function Rc(){const{albums:n,addAlbum:e,selectAlbum:t}=bt(),{createLog:s,updateLog:i,getLog:r}=Wa(),{requestPlayAlbum:o}=Rt(),{navigateToRoom:l}=wt(),{addToast:c}=Ms(),[u,h]=x.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[d,g]=x.useState(""),[f,m]=x.useState(!1),[p,_]=x.useState(null),[y,w]=x.useState([]),[S,E]=x.useState(null),[b,T]=x.useState(!1),[j,v]=x.useState(null),[N,A]=x.useState(null),[D,M]=x.useState(0),P=x.useRef(null),[I,F]=x.useState(!1),[V,O]=x.useState(!1),G=x.useRef(!1),[Y,H]=x.useState(!1),[X,ee]=x.useState(!1),[U,Q]=x.useState(null),[B,C]=x.useState(null),[R,k]=x.useState(!1),W=x.useRef(null),[oe,Ee]=x.useState(null),[et,Vn]=x.useState({}),[xs,$]=x.useState({}),[J,ve]=x.useState({}),he=x.useMemo(()=>u.filter(q=>q.role==="user"),[u]),ie=x.useMemo(()=>{const q=yc();return q?wc(q):null},[]),me=x.useMemo(()=>n.filter(q=>q.musicData),[n]);x.useEffect(()=>{const q=$n();F(!!q),q&&!G.current&&(G.current=!0,c("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]),x.useEffect(()=>()=>{P.current?.abort(),P.current=null,W.current&&(W.current.pause(),W.current.src="",W.current=null)},[]),x.useEffect(()=>{if(!b||!N)return;M(Math.max(0,Math.floor((Date.now()-N)/1e3)));const q=window.setInterval(()=>{M(Math.max(0,Math.floor((Date.now()-N)/1e3)))},1e3);return()=>window.clearInterval(q)},[b,N]);function Ve(){b&&(P.current?.abort(),P.current=null,T(!1),v("キャンセルしました"),A(null),M(0),O(!1),c("info","生成を中断しました。あとで再開できます。"))}function ct(){da(),F(!1),v(null),_(null),O(!1),c("info","保留中の生成を破棄しました。")}async function qt(){const q=$n();if(!q||b)return;_(null),O(!1),T(!0),v("再生成を開始しています…"),A(Date.now()),M(0),c("info","同じ条件で再生成を開始しました。"),P.current?.abort();const ae=new AbortController;P.current=ae;try{const z=q.refined,Z=Hn(z,"Image unavailable");let pe=null;try{v("画像生成を開始しています…"),pe=(await ti(z.image)).jobId}catch(Ie){pe=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const be=Ie instanceof Error?Ie.message:"image job start failed";q.causalLogId&&Qt(i,r,q.causalLogId,"image-generation-start",be)}v("作曲を開始しています…");const ye=await Qs(z.music);ha({...q,startedAt:Date.now(),imageJobId:pe,musicJobId:ye.jobId,coverDataUrl:q.coverDataUrl||Z}),F(!0);const Ne=pe?Js(pe,Ie=>{Ie.status==="queued"?v("順番待ち…"):Ie.status==="running"?v("画像を生成中…"):Ie.status==="succeeded"?v("画像ができました。仕上げ中…"):Ie.status==="failed"&&v("画像生成に失敗しました")},90,2e3,ae.signal).catch(Ie=>{const be=Ie instanceof Error?Ie.message:"image polling failed";return q.causalLogId&&Qt(i,r,q.causalLogId,"image-generation-poll",be),null}):Promise.resolve(null),[ze,Ce]=await Promise.all([Ne,is(ye.jobId,Ie=>{Ie.status==="queued"?v("順番待ち…"):Ie.status==="running"?v("作曲中…"):Ie.status==="succeeded"?v("作曲ができました。仕上げ中…"):Ie.status==="failed"&&v("作曲に失敗しました")},90,2e3,ae.signal)]),le=ze?.status==="succeeded"&&ze?.resultUrl?ze.resultUrl:Z;if(ze?.status==="succeeded"&&ze?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ce.status!=="succeeded"||!Ce.midiData||!Ce.result)throw new Error("曲生成に失敗しました");const Kt=z?.brief?.theme?.title||"";Q({title:Kt,mood:z?.image?.mood,duration:z?.image?.duration,imageDataURL:le,thumbnailUrl:le,metadata:{valence:z?.analysisLike?.valence,arousal:z?.analysisLike?.arousal,focus:z?.analysisLike?.focus,motif_tags:z?.analysisLike?.motif_tags,confidence:z?.analysisLike?.confidence,stylePreset:z?.image?.stylePreset,provider:Xn(ze)},musicData:Ce.midiData,musicFormat:"midi",musicMetadata:{key:Ce.result.key,tempo:Ce.result.tempo,timeSignature:Ce.result.timeSignature,form:Ce.result.form,character:Ce.result.character,duration:z?.music?.duration,createdAt:Yn(),provider:Ce.provider},sessionData:{brief:z?.brief,recommendations:q.sessionRecommendations??y,messages:q.sessionMessages??u},causalLogId:q.causalLogId??void 0}),C(q.causalLogId??null),ee(!0),v(null),O(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(z){if(z instanceof DOMException&&z.name==="AbortError"){v("キャンセルしました"),O(!1);return}const Z=z instanceof Error?z.message:"再生成に失敗しました";_(Z),O(!0),c("error",Z)}finally{T(!1),P.current=null}}async function ws(){const q=$n();if(!q||b)return;_(null),O(!1),T(!0),v("再開中…"),A(q.startedAt||Date.now()),M(0),c("info","生成を再開しています…"),P.current?.abort();const ae=new AbortController;P.current=ae;try{const z=q.refined,Z=q.coverDataUrl||Hn(z,"Image unavailable"),pe=q.imageJobId?Js(q.imageJobId,le=>{le.status==="queued"?v("順番待ち…"):le.status==="running"?v("画像を生成中…"):le.status==="succeeded"?v("画像ができました。仕上げ中…"):le.status==="failed"&&v("画像生成に失敗しました")},90,2e3,ae.signal).catch(le=>{const Kt=le instanceof Error?le.message:"image polling failed";return q.causalLogId&&Qt(i,r,q.causalLogId,"image-generation-poll",Kt),null}):Promise.resolve(null),[ye,Ne]=await Promise.all([pe,is(q.musicJobId,le=>{le.status==="queued"?v("順番待ち…"):le.status==="running"?v("作曲中…"):le.status==="succeeded"?v("作曲ができました。仕上げ中…"):le.status==="failed"&&v("作曲に失敗しました")},90,2e3,ae.signal)]),ze=ye?.status==="succeeded"&&ye?.resultUrl?ye.resultUrl:Z;if(ye?.status==="succeeded"&&ye?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ne.status!=="succeeded"||!Ne.midiData||!Ne.result)throw new Error("曲生成に失敗しました");const Ce=z?.brief?.theme?.title||"";Q({title:Ce,mood:z?.image?.mood,duration:z?.image?.duration,imageDataURL:ze,thumbnailUrl:ze,metadata:{valence:z?.analysisLike?.valence,arousal:z?.analysisLike?.arousal,focus:z?.analysisLike?.focus,motif_tags:z?.analysisLike?.motif_tags,confidence:z?.analysisLike?.confidence,stylePreset:z?.image?.stylePreset,provider:Xn(ye)},musicData:Ne.midiData,musicFormat:"midi",musicMetadata:{key:Ne.result.key,tempo:Ne.result.tempo,timeSignature:Ne.result.timeSignature,form:Ne.result.form,character:Ne.result.character,duration:z?.music?.duration,createdAt:Yn(),provider:Ne.provider},sessionData:{brief:z?.brief,recommendations:q.sessionRecommendations??y,messages:q.sessionMessages??u},causalLogId:q.causalLogId??void 0}),C(q.causalLogId??null),ee(!0),v(null),F(!0),O(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(z){if(z instanceof DOMException&&z.name==="AbortError"){v("キャンセルしました"),O(!1);return}const Z=z instanceof Error?z.message:"再開に失敗しました";_(Z),O(!0),c("error",Z)}finally{T(!1),P.current=null}}const tt=q=>`${q.composer}::${q.title}`;async function qn(q){const ae=tt(q);if(et[ae])return et[ae];if(xs[ae])return null;$(z=>({...z,[ae]:!0})),ve(z=>({...z,[ae]:null}));try{const z=await gc({composer:q.composer,title:q.title});return Vn(Z=>({...Z,[ae]:z})),z}catch(z){const Z=z instanceof Error?z.message:"プレビュー取得に失敗しました";return ve(pe=>({...pe,[ae]:Z})),null}finally{$(z=>({...z,[ae]:!1}))}}async function uo(q){const ae=tt(q);if(oe===ae){W.current?.pause(),Ee(null);return}const Z=await qn(q),pe=Z?.previewUrl,ye=Z?.trackUrl;if(!pe){ye&&window.open(ye,"_blank","noopener,noreferrer");return}try{W.current||(W.current=new Audio),W.current.pause(),W.current.src=pe,W.current.currentTime=0,await W.current.play(),Ee(ae),W.current.onended=()=>{Ee(Ne=>Ne===ae?null:Ne)}}catch(Ne){ve(ze=>({...ze,[ae]:Ne instanceof Error?Ne.message:"再生に失敗しました"}))}}async function Ki(){const q=d.trim();if(!q)return;_(null),m(!0);const ae=[...u,{role:"user",content:q}];h(ae),g("");try{const z=await mc({messages:ae,onboardingData:ie??void 0});h(Z=>[...Z,{role:"assistant",content:z.assistant_message}]),w(z.recommendations??[]),E(z.event_suggestion??null)}catch(z){const Z=z instanceof Error?z.message:"送信に失敗しました";_(Z),h(pe=>[...pe,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{m(!1)}}async function ho(){_(null),O(!1),T(!0),v("準備中…"),A(Date.now()),M(0),P.current?.abort();const q=new AbortController;P.current=q;const ae=`chat_${Date.now()}`,z=s(ae,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{v("イベントを整えています…");const Z=await pc({messages:u,onboardingData:ie??void 0}),pe=Hn(Z,"Image unavailable");let ye=null;try{v("画像生成を開始しています…"),ye=(await ti(Z.image)).jobId}catch(be){ye=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Wn=be instanceof Error?be.message:"image job start failed";Qt(i,r,z,"image-generation-start",Wn)}v("作曲を開始しています…");const Ne=await Qs(Z.music);ha({v:1,kind:"chat",startedAt:Date.now(),imageJobId:ye,musicJobId:Ne.jobId,coverDataUrl:pe,refined:Z,sessionMessages:u,sessionRecommendations:y,causalLogId:z}),F(!0),c("info","生成を開始しました。完了まで待つか、あとで再開できます。");const ze=ye?Js(ye,be=>{be.status==="queued"?v("順番待ち…"):be.status==="running"?v("画像を生成中…"):be.status==="succeeded"?v("画像ができました。仕上げ中…"):be.status==="failed"&&v("画像生成に失敗しました")},90,2e3,q.signal).catch(be=>{const Wn=be instanceof Error?be.message:"image polling failed";return Qt(i,r,z,"image-generation-poll",Wn),null}):Promise.resolve(null),[Ce,le]=await Promise.all([ze,is(Ne.jobId,be=>{be.status==="queued"?v("順番待ち…"):be.status==="running"?v("作曲中…"):be.status==="succeeded"?v("作曲ができました。仕上げ中…"):be.status==="failed"&&v("作曲に失敗しました")},90,2e3,q.signal)]);if(q.signal.aborted){v("キャンセルしました");return}const Kt=Ce?.status==="succeeded"&&Ce?.resultUrl?Ce.resultUrl:pe;if(Ce?.status==="succeeded"&&Ce?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),le.status!=="succeeded"||!le.midiData||!le.result)throw new Error("曲生成に失敗しました");v("保存の準備をしています…");const Ie=Z?.brief?.theme?.title||"";Q({title:Ie,mood:Z.image.mood,duration:Z.image.duration,imageDataURL:Kt,thumbnailUrl:Kt,metadata:{valence:Z.analysisLike.valence,arousal:Z.analysisLike.arousal,focus:Z.analysisLike.focus,motif_tags:Z.analysisLike.motif_tags,confidence:Z.analysisLike.confidence,stylePreset:Z.image.stylePreset,provider:Xn(Ce)},musicData:le.midiData,musicFormat:"midi",musicMetadata:{key:le.result.key,tempo:le.result.tempo,timeSignature:le.result.timeSignature,form:le.result.form,character:le.result.character,duration:Z.music.duration,createdAt:Yn(),provider:le.provider},sessionData:{brief:Z.brief,recommendations:y,messages:u},causalLogId:z}),C(z),ee(!0),c("success","生成が完了しました。タイトルを決めて保存できます。"),O(!1),v(null),A(null),M(0),E(null),h(be=>[...be,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(Z){if(Z instanceof DOMException&&Z.name==="AbortError"){v("キャンセルしました"),A(null),M(0),h(ye=>[...ye,{role:"assistant",content:"生成をキャンセルしたよ。必要ならまた「今すぐ1曲つくる」で再開できる。"}]),c("info","生成をキャンセルしました。あとで再開できます。"),O(!1);return}const pe=Z instanceof Error?Z.message:"生成イベントに失敗しました";v(null),A(null),M(0),_(pe),c("error",pe),O(!0),Qt(i,r,z,"generation-event",pe),h(ye=>[...ye,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{T(!1),P.current=null}}async function mo(q){if(!U){ee(!1);return}const ae=q.trim();try{k(!0);let z=ae;if(!z)try{z=(await fc({mood:U.mood,motifTags:U?.metadata?.motif_tags,character:U?.musicMetadata?.character,brief:U?.sessionData?.brief,messages:U?.sessionData?.messages})).title}catch{z=""}const Z=e({...U,title:z||void 0});t(Z.id),o(Z,[Z,...me]),l("music"),c("success","保存して再生を開始しました。"),da(),F(!1),B&&Ec(i,B,{albumId:"local",title:z||U.mood}),E(null),h(pe=>[...pe,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{k(!1),ee(!1),Q(null),C(null)}}return a.jsxs("div",{className:"chatSession",children:[a.jsx(Xa,{active:b,statusText:j,elapsedSec:D,onCancel:Ve}),a.jsx(Ha,{open:Y,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>H(!1),onConfirm:()=>{H(!1),ct()}}),a.jsx(Dc,{open:X,mood:U?.mood||"穏やか",defaultTitle:U?.title,onCancel:()=>{R||(ee(!1),Q(null),C(null))},onSubmit:q=>{R||mo(q)}}),a.jsxs("div",{className:"chatHeader",children:[a.jsxs("div",{className:"chatTitle",children:[a.jsx("div",{className:"chatTitleMain",children:"対話"}),a.jsx("div",{className:"chatTitleSub",children:"話すだけで、レコメンドと創作が進む"})]}),a.jsxs("div",{className:"chatHeaderRight",children:[a.jsx("button",{className:"chatPrimary",onClick:ho,disabled:b,"data-no-swipe":!0,title:S?.reason||"会話の内容をもとに1曲生成します",children:b?"生成中…":S?.shouldTrigger?"生成イベントを開始":"今すぐ1曲つくる"}),!b&&I?a.jsx("button",{className:"chatCancel",onClick:()=>void ws(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!b&&I&&V?a.jsx("button",{className:"chatCancel",onClick:()=>void qt(),"data-no-swipe":!0,type:"button",title:"同じ条件で生成をやり直します（失敗・停止時向け）",children:"再生成"}):null,b?a.jsx("button",{className:"chatCancel",onClick:Ve,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,!b&&I?a.jsx("button",{className:"chatCancel",onClick:()=>H(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null]})]}),j?a.jsxs("div",{className:"chatGenStatus",children:[j,N?a.jsxs("span",{className:"chatGenElapsed",children:["（",D,"s）"]}):null]}):null,S&&!S.shouldTrigger?a.jsx("div",{className:"chatHint",children:S.reason}):null,a.jsxs("div",{className:"chatLayout",children:[a.jsxs("div",{className:"chatMain",children:[a.jsx("div",{className:"chatBody",children:u.map((q,ae)=>a.jsx("div",{className:`chatMsg ${q.role==="user"?"user":"assistant"}`,children:a.jsx("div",{className:"chatBubble",children:q.content})},ae))}),a.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[p?a.jsx("div",{className:"chatError",children:p}):null,a.jsxs("div",{className:"chatComposer",children:[a.jsx("textarea",{className:"chatInput",placeholder:he.length===0?"今日のことを一言で":"続けて話して",value:d,onChange:q=>g(q.target.value),onKeyDown:q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),f||Ki())},rows:2}),a.jsx("button",{className:"chatSend",onClick:Ki,disabled:f||!d.trim(),children:f?"送信中…":"送信"})]})]})]}),a.jsxs("aside",{className:"chatSide","aria-label":"レコメンド",children:[a.jsxs("div",{className:"chatSideHeader",children:[a.jsx("div",{className:"chatSideTitle",children:"いまのレコメンド"}),a.jsx("div",{className:"chatSideHint",children:"30秒プレビュー（可能な場合）"})]}),y.length>0?a.jsx("ul",{className:"chatRecsList",children:y.slice(0,4).map((q,ae)=>a.jsxs("li",{className:"chatRecItem",children:[a.jsxs("div",{className:"chatRecMain",children:[a.jsx("span",{className:"chatRecComposer",children:q.composer}),a.jsx("span",{className:"chatRecSep",children:"—"}),a.jsx("span",{className:"chatRecTitle",children:q.title}),q.era?a.jsxs("span",{className:"chatRecEra",children:["(",q.era,")"]}):null]}),a.jsx("div",{className:"chatRecWhy",children:q.why}),a.jsxs("div",{className:"chatRecActions",children:[a.jsx("button",{className:"chatRecPlay",onClick:()=>void uo(q),disabled:!!xs[tt(q)],"data-no-swipe":!0,children:oe===tt(q)?"停止":xs[tt(q)]?"取得中…":"再生"}),et[tt(q)]?.trackUrl?a.jsx("a",{className:"chatRecOpen",href:et[tt(q)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),J[tt(q)]?a.jsx("div",{className:"chatRecErr",children:J[tt(q)]}):null]},ae))}):a.jsx("div",{className:"chatRecsEmpty",children:"会話をすると、ここにおすすめが出ます。"})]})]})]})}const Oc=()=>a.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative"},children:a.jsx(Rc,{})}),Pc=({album:n,position:e,onClick:t,isSelected:s})=>{const i=x.useRef(null),r=x.useRef(null),o=x.useRef(0),l=.22,c=1.8,u=.55,h=n.gallery?.spineColor||"#111111",d=n.title||n.mood,g=x.useMemo(()=>new Date(n.createdAt).toLocaleDateString("ja-JP",{year:"2-digit",month:"2-digit",day:"2-digit"}),[n.createdAt]),f=bo(xo,n.imageDataURL);return x.useEffect(()=>{f.colorSpace=wo,f.anisotropy=4,f.needsUpdate=!0},[f]),Ht((m,p)=>{const _=s?1:0;if(o.current=Kn.lerp(o.current,_,1-Math.exp(-8*p)),r.current){const y=o.current;r.current.position.z=u/2+.04+y*.7,r.current.position.y=y*.08,r.current.scale.setScalar(.92+y*.08),r.current.visible=y>.01}if(i.current){const y=o.current;i.current.scale.y=1+y*.02}}),a.jsxs("group",{position:e,children:[a.jsxs("mesh",{ref:i,onClick:t,castShadow:!0,receiveShadow:!0,children:[a.jsx("boxGeometry",{args:[l,c,u]}),a.jsx("meshStandardMaterial",{color:h,roughness:.9,metalness:.05})]}),a.jsxs("group",{position:[l/2-.05,c/2-.12,u/2+.03],children:[n.isPublic&&a.jsxs("mesh",{position:[0,0,0],children:[a.jsx("boxGeometry",{args:[.06,.06,.02]}),a.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1})]}),n.isFavorite&&a.jsxs("mesh",{position:[0,-.08,0],children:[a.jsx("boxGeometry",{args:[.06,.06,.02]}),a.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1})]})]}),a.jsxs("group",{position:[0,0,u/2+.01],children:[a.jsx(ea,{fontSize:.12,color:h==="#111111"?"#f5f5f5":"#111111",anchorX:"center",anchorY:"middle",maxWidth:.9,children:d}),a.jsx(ea,{position:[0,-.16,0],fontSize:.08,color:h==="#111111"?"#f5f5f5":"#111111",fillOpacity:h==="#111111"?.75:.55,anchorX:"center",anchorY:"middle",maxWidth:.9,children:g})]}),a.jsxs("group",{ref:r,position:[0,.05,u/2+.04],visible:!1,children:[a.jsxs("mesh",{onClick:t,castShadow:!0,children:[a.jsx("planeGeometry",{args:[1.1,1.55]}),a.jsx("meshStandardMaterial",{map:f,roughness:.85,metalness:0})]}),a.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[1.14,1.6]}),a.jsx("meshStandardMaterial",{color:"#ffffff",roughness:1,metalness:0,opacity:.6,transparent:!0})]})]})]})},Fc=({albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})=>{const[i,r]=x.useState(null),o=x.useRef(null),l=x.useRef(0),c=x.useRef(0),u=.32,h=Math.max(0,(n.length-1)*u),d=x.useMemo(()=>n.map((g,f)=>({x:-f*u,y:0,z:0})),[n,u]);return Ht((g,f)=>{const m=s.current,p=.0022,_=m.wheelPx*p,y=m.dragPx*p;_!==0&&(c.current+=_*26,m.wheelPx=0),y!==0&&(l.current-=y,c.current=Kn.lerp(c.current,-y*60,.35),m.dragPx=0);const w=m.isDragging?.88:.92;c.current*=Math.pow(w,f*60),l.current+=c.current*f;const S=.9,E=40;if(l.current<-S?(l.current=-S,c.current*=-.35):l.current>h+S&&(l.current=h+S,c.current*=-.35),l.current<0?c.current+=(0-l.current)*E*f:l.current>h&&(c.current-=(l.current-h)*E*f),!m.isDragging&&Math.abs(c.current)<.15&&n.length>0){const j=Math.max(0,Math.min(n.length-1,Math.round(l.current/u)))*u;l.current=Kn.lerp(l.current,j,1-Math.exp(-10*f))}o.current&&(o.current.position.x=l.current)}),a.jsxs("group",{children:[a.jsxs("mesh",{position:[0,-1.05,-.25],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[30,6]}),a.jsx("meshStandardMaterial",{color:"#f5f5f5",roughness:1,metalness:0})]}),a.jsxs("mesh",{position:[0,.4,-.6],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[30,8]}),a.jsx("meshStandardMaterial",{color:"#fafafa",roughness:1,metalness:0})]}),a.jsx("group",{ref:o,children:n.map((g,f)=>{const m=d[f],p=[m.x,m.y,m.z];return a.jsx(Pc,{album:g,position:p,onClick:()=>{r(g.id),l.current=f*u,c.current=0,e(g.id)},isSelected:i===g.id},g.id)})}),a.jsx("ambientLight",{intensity:.55}),a.jsx("directionalLight",{position:[4,6,6],intensity:.65,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),a.jsx("directionalLight",{position:[-3,3,4],intensity:.22})]})},Lc=({albums:n,onBookClick:e,constellationEnabled:t})=>{const s=x.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0});return a.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:i=>{i.preventDefault();const r=Math.abs(i.deltaX)>Math.abs(i.deltaY)?i.deltaX:i.deltaY;s.current.wheelPx+=r},onPointerDown:i=>{i.currentTarget.setPointerCapture(i.pointerId),s.current.isDragging=!0,s.current.lastPointerX=i.clientX},onPointerMove:i=>{if(!s.current.isDragging)return;const r=i.clientX-s.current.lastPointerX;s.current.lastPointerX=i.clientX,s.current.dragPx+=r},onPointerUp:i=>{try{i.currentTarget.releasePointerCapture(i.pointerId)}catch{}s.current.isDragging=!1},onPointerCancel:()=>{s.current.isDragging=!1},children:a.jsx(ms,{shadows:!0,camera:{position:[0,1.1,6.5],fov:32},gl:{alpha:!0,antialias:!0},children:a.jsx(x.Suspense,{fallback:null,children:a.jsx(Fc,{albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})})})})},Gt=({title:n,mood:e,imageUrl:t,meta:s,badges:i=[],variant:r="default",className:o})=>a.jsxs("div",{className:`album-card album-card-${r} ${o||""}`.trim(),children:[a.jsx("div",{className:"album-card-image",children:a.jsx("img",{src:t,alt:n,loading:"lazy"})}),a.jsxs("div",{className:"album-card-body",children:[a.jsx("div",{className:"album-card-title",children:n}),e&&a.jsx("div",{className:"album-card-mood",children:e}),s&&a.jsx("div",{className:"album-card-meta",children:s}),i.length>0&&a.jsx("div",{className:"album-card-badges",children:i.map(l=>a.jsx("span",{className:`album-badge tone-${l.tone||"default"}`,children:l.label},l.label))})]})]}),Vc=({title:n,description:e,actionLabel:t,onAction:s,icon:i})=>a.jsxs("div",{className:"empty-state",children:[i&&a.jsx("div",{className:"empty-icon",children:i}),a.jsx("h2",{className:"empty-title",children:n}),a.jsx("p",{className:"empty-description",children:e}),t&&s&&a.jsx("button",{onClick:s,className:"empty-cta-button",children:t})]}),en=({trigger:n,children:e,placement:t="bottom",triggerClassName:s,triggerAriaLabel:i,triggerAriaHaspopup:r,onOpenChange:o})=>{const[l,c]=x.useState(!1),u=x.useRef(null),h=x.useRef(null),d=x.useId(),g=()=>{c(!1),o?.(!1),h.current?.focus()},f=()=>{c(m=>{const p=!m;return o?.(p),p})};return x.useEffect(()=>{if(!l)return;const m=_=>{u.current?.contains(_.target)||g()},p=_=>{_.key==="Escape"&&(_.preventDefault(),g())};return document.addEventListener("mousedown",m),document.addEventListener("keydown",p),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("keydown",p)}},[l]),a.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[a.jsx("button",{ref:h,type:"button",className:`popover-trigger ${s||""}`.trim(),onClick:f,"aria-expanded":l,"aria-controls":l?d:void 0,"aria-label":i,"aria-haspopup":r,children:n}),l&&a.jsx("div",{className:"popover-panel",id:d,children:typeof e=="function"?e({close:g}):e})]})},tn=({items:n,autoFocus:e=!0})=>{const[t,s]=L.useState(0),i=L.useRef([]);L.useEffect(()=>{if(!e||n.length===0)return;const l=i.current[0];l&&l.focus()},[e,n.length]);const r=l=>{const c=Math.max(0,Math.min(n.length-1,l));s(c),i.current[c]?.focus()},o=l=>{if(n.length!==0){if(l.key==="ArrowDown"){l.preventDefault(),r(t+1);return}if(l.key==="ArrowUp"){l.preventDefault(),r(t-1);return}if(l.key==="Home"){l.preventDefault(),r(0);return}if(l.key==="End"){l.preventDefault(),r(n.length-1);return}}};return a.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:o,children:n.map((l,c)=>a.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:c===t?0:-1,ref:u=>{i.current[c]=u},onFocus:()=>s(c),onClick:()=>{s(c),l.onSelect()},type:"button",children:l.label},l.id))})},Ja=({items:n,value:e,onChange:t,ariaLabel:s="タブ"})=>{const i=x.useId();return a.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[a.jsx("div",{className:"tabs-list",role:"tablist","aria-label":s,children:n.map(r=>a.jsx("button",{id:`${i}-${r.id}-tab`,role:"tab","aria-selected":e===r.id,"aria-controls":`${i}-${r.id}-panel`,className:`tab-button ${e===r.id?"is-active":""}`,onClick:()=>t(r.id),type:"button",children:r.label},r.id))}),n.map(r=>a.jsx("div",{id:`${i}-${r.id}-panel`,role:"tabpanel","aria-labelledby":`${i}-${r.id}-tab`,hidden:e!==r.id,className:"tab-panel",children:r.content},r.id))]})},si=({options:n,value:e,onChange:t,ariaLabel:s="選択"})=>a.jsx("div",{className:"segmented-control",role:"group","aria-label":s,"data-no-swipe":"true",children:n.map(i=>a.jsx("button",{type:"button",className:`segmented-item ${e===i.id?"is-active":""}`,"aria-pressed":e===i.id,onClick:()=>t(i.id),children:i.label},i.id))}),qc=()=>{const{albums:n,selectAlbum:e,updateAlbum:t}=bt(),{getSelectedAlbum:s}=bt(),i=s(),{requestPlayAlbum:r}=Rt(),{navigateToRoom:o}=wt(),[l,c]=L.useState("shelf"),[u,h]=L.useState("all"),[d,g]=L.useState("new"),[f,m]=L.useState("public"),p=v=>{e(v)},_=L.useMemo(()=>n.filter(v=>v.musicData),[n]),y=!!i,w=!!i?.musicData,S=L.useMemo(()=>{const v=n.filter(A=>u==="public"?A.isPublic:u==="private"?!A.isPublic:u==="favorite"?A.isFavorite:!0),N=A=>{const D=Number(A.duration||0);return(A.musicData?1e3:0)+D};return v.slice().sort((A,D)=>d==="duration"?(D.duration||0)-(A.duration||0):d==="popular"?N(D)-N(A):String(D.createdAt).localeCompare(String(A.createdAt)))},[n,u,d]),E=d==="popular"?"人気順":d==="duration"?"長さ順":"新しい順",b=a.jsxs("div",{className:"bookshelf-container",children:[a.jsxs("div",{className:`gallery-shelf-stage ${S.length===0?"empty":""}`,children:[a.jsx(Lc,{albums:S,onBookClick:p,constellationEnabled:!1}),a.jsx("div",{className:"bookshelf-overlay-grid","aria-hidden":"true",children:S.map(v=>!v.gallery||!(v.isPublic||v.isFavorite)?null:a.jsx("div",{className:`bookshelf-badge ${i?.id===v.id?"is-selected":""}`,style:{gridColumn:v.gallery.positionIndex+1,gridRow:v.gallery.shelfIndex+1},children:v.isPublic||v.isFavorite?f==="favorite"&&v.isFavorite?a.jsxs("span",{className:"badge-chip badge-favorite badge-compact is-priority",children:[a.jsx("span",{className:"badge-dot"}),"お気に入り"]}):v.isPublic?a.jsxs("span",{className:`badge-chip badge-public badge-compact ${f==="public"?"is-priority":""}`.trim(),children:[a.jsx("span",{className:"badge-dot"}),"公開"]}):a.jsxs("span",{className:"badge-chip badge-favorite badge-compact",children:[a.jsx("span",{className:"badge-dot"}),"お気に入り"]}):null},v.id))}),S.length===0&&a.jsx("div",{className:"empty-shelf-overlay",children:a.jsx(Vc,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>o("main"),icon:a.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),a.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[a.jsxs("div",{className:"gallery-selection",children:[a.jsx("div",{className:"gallery-selection-label",children:"選択中"}),a.jsx("div",{className:"gallery-selection-value",children:i?i.title||i.mood:"未選択"})]}),a.jsxs("div",{className:"gallery-actions",children:[a.jsx("button",{className:"btn btn-primary",disabled:!y,onClick:()=>o("album"),children:"開く"}),a.jsx("button",{className:"btn btn-primary",disabled:!w||!i,onClick:()=>{i&&r(i,_)},children:"再生"}),a.jsx("button",{className:"btn",disabled:!y,onClick:()=>o("social"),children:"公開"}),a.jsx(en,{triggerClassName:"btn",trigger:a.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:v})=>a.jsx(tn,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{o("album"),v()}},{id:"publish",label:"SNSに公開",onSelect:()=>{o("social"),v()}},{id:"play",label:"再生",onSelect:()=>{i&&(r(i,_),v())}},{id:"favorite",label:i?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{i&&(t(i.id,{isFavorite:!i.isFavorite}),v())}},{id:"public",label:i?.isPublic?"非公開にする":"公開にする",onSelect:()=>{i&&(t(i.id,{isPublic:!i.isPublic}),v())}}]})})]})]})]}),T=a.jsx("div",{className:"gallery-focus",children:i?a.jsxs("div",{className:"gallery-focus-card room-card",children:[a.jsx(Gt,{title:i.title||i.mood,mood:i.mood,imageUrl:i.imageDataURL,meta:`作成日: ${new Date(i.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:i.musicData?"再生可能":"音声なし",tone:i.musicData?"success":"default"},...i.isPublic?[{label:"公開中",tone:"info"}]:[],...i.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),a.jsxs("div",{className:"gallery-focus-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:()=>o("album"),children:"詳細へ"}),a.jsx("button",{className:"btn btn-primary",disabled:!i.musicData,onClick:()=>r(i,_),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>o("social"),children:"公開"})]})]}):a.jsxs("div",{className:"gallery-focus-empty room-card",children:[a.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),a.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),j=[{id:"shelf",label:"Shelf",content:b},{id:"focus",label:"Focus",content:T}];return a.jsxs("div",{className:"room-content gallery-room",children:[a.jsx(Ya,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),a.jsx("h1",{className:"room-title",children:"GALLERY"}),a.jsx("p",{className:"room-subtitle",children:"スクロールで時間を辿り、クリックで選ぶ"}),a.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[a.jsxs("div",{className:"gallery-toolbar-left",children:[a.jsx(si,{value:u,onChange:v=>h(v),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),a.jsxs("div",{className:"gallery-filter-tags",children:[a.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),a.jsx("span",{className:"filter-tag",children:E}),a.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",f==="public"?"公開":"お気に入り"]})]})]}),a.jsxs("div",{className:"gallery-toolbar-right",children:[a.jsx(si,{value:f,onChange:v=>m(v),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),a.jsx(en,{triggerClassName:"btn",trigger:a.jsxs("span",{children:["並び替え: ",E]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:v})=>a.jsx(tn,{items:[{id:"new",label:"新しい順",onSelect:()=>{g("new"),v()}},{id:"popular",label:"人気順",onSelect:()=>{g("popular"),v()}},{id:"duration",label:"長さ順",onSelect:()=>{g("duration"),v()}}]})})]})]}),a.jsx(Ja,{items:j,value:l,onChange:c,ariaLabel:"ギャラリー表示"})]})},Wc=2147483647,Bc=({log:n})=>{if(!n)return a.jsxs("div",{className:"explainability-panel",children:[a.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),a.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const s=Math.round(t/1e3);if(s<60)return`${s}秒`;const i=Math.floor(s/60),r=s%60;return`${i}分${r}秒`};return a.jsxs("div",{className:"explainability-panel",children:[a.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),n.analysis&&a.jsxs("div",{className:"explainability-section timeline-section",children:[a.jsx("h4",{className:"section-title",children:"生成フロー"}),a.jsxs("div",{className:"timeline",children:[a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"入力"}),a.jsx("span",{className:"timeline-value",children:new Date(n.input.timestamp).toLocaleTimeString("ja-JP")})]}),n.analysis&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"解析"}),a.jsxs("span",{className:"timeline-value",children:[e(n.analysis.duration)," (",n.analysis.provider,")"]})]}),n.imageGeneration&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"画像生成"}),a.jsxs("span",{className:"timeline-value",children:[e(n.imageGeneration.duration)," (",n.imageGeneration.provider,")"]})]}),n.musicGeneration&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"音楽生成"}),a.jsxs("span",{className:"timeline-value",children:[e(n.musicGeneration.duration)," (",n.musicGeneration.provider,")"]})]}),n.album&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"完成"}),a.jsxs("span",{className:"timeline-value",children:["合計: ",e(n.totalDuration)]})]})]})]}),n.analysis&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"感情分析"}),a.jsxs("div",{className:"analysis-explanation",children:[a.jsxs("div",{className:"ir-values",children:[a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Valence:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${(n.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:n.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.valence.toFixed(2)})]}),a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Arousal:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Focus:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),a.jsxs("div",{className:"motif-tags",children:[a.jsx("strong",{children:"モチーフタグ:"})," ",n.analysis.intermediateRepresentation.motif_tags.join("、")]}),a.jsxs("div",{className:"reasoning-text",children:[a.jsx("strong",{children:"理由:"})," ",n.analysis.reasoning]})]})]}),n.imageGeneration&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),a.jsxs("div",{className:"image-explanation",children:[a.jsx("p",{className:"reasoning-text",children:n.imageGeneration.reasoning}),a.jsxs("div",{className:"image-details",children:[a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"スタイル:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.stylePreset})]}),n.imageGeneration.seed&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"Seed:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.seed})]}),a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"モデル:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.model})]})]})]})]}),n.musicGeneration&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),a.jsxs("div",{className:"music-explanation",children:[a.jsx("p",{className:"reasoning-text",children:n.musicGeneration.reasoning}),a.jsx("div",{className:"music-details",children:n.musicGeneration.structure&&typeof n.musicGeneration.structure=="object"&&a.jsxs(a.Fragment,{children:[n.musicGeneration.structure.key&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"調:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.key})]}),n.musicGeneration.structure.tempo&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"テンポ:"}),a.jsxs("span",{className:"detail-value",children:[n.musicGeneration.structure.tempo," BPM"]})]}),n.musicGeneration.structure.timeSignature&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"拍子:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.timeSignature})]}),n.musicGeneration.structure.form&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"形式:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.form})]})]})})]})]}),n.errors&&n.errors.length>0&&a.jsxs("div",{className:"explainability-section error-section",children:[a.jsx("h4",{className:"section-title",children:"エラー"}),a.jsx("div",{className:"errors-list",children:n.errors.map((t,s)=>a.jsxs("div",{className:"error-item",children:[a.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),a.jsx("span",{className:"error-message",children:t.error})]},s))})]})]})},Uc=({dominantColors:n=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:s=0,highlightedLayer:i=-1})=>{const r=x.useRef(null),o=x.useRef(),l=x.useRef([]);return x.useEffect(()=>{const c=r.current;if(!c)return;const u=c.getContext("2d");if(!u)return;const h=()=>{const m=c.parentElement;m&&(c.width=m.clientWidth,c.height=m.clientHeight)};h(),window.addEventListener("resize",h);const d=Math.min(5,n.length+2);l.current=Array.from({length:d},(m,p)=>({radius:50+p*30,maxRadius:200+p*50,color:n[p%n.length]||"#D4AF37",phase:p*Math.PI*2/d,phaseSpeed:5e-4+p*2e-4}));let g=0;const f=m=>{const p=m-g;g=m,u.clearRect(0,0,c.width,c.height);const _=c.width/2,y=c.height/2;l.current.forEach((w,S)=>{w.phase+=w.phaseSpeed*p;const E=Math.sin(w.phase),b=20+(e?t*30:0),T=w.radius+E*b,j=.1,v=.3,N=s*.2,A=i===S?.3:0,D=e?t*.15:0,M=Math.min(v,j+N+A+D),P=u.createRadialGradient(_,y,T-20,_,y,T+20);P.addColorStop(0,`${w.color}00`),P.addColorStop(.5,`${w.color}${Math.floor(M*255).toString(16).padStart(2,"0")}`),P.addColorStop(1,`${w.color}00`),u.fillStyle=P,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(_,y,T,0,Math.PI*2),u.fill()}),o.current=requestAnimationFrame(f)};return o.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",h),o.current&&cancelAnimationFrame(o.current),u.clearRect(0,0,c.width,c.height)}},[n,e,t,s,i]),a.jsx("canvas",{ref:r,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},Gc=()=>{const[n,e]=x.useState({x:0,y:0});return x.useEffect(()=>{const t=s=>{e({x:s.clientX,y:s.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),n},$c=(n,e=200)=>{const[t,s]=x.useState(0),i=Gc();return x.useEffect(()=>{if(!n.current)return;const r=n.current.getBoundingClientRect(),o=r.left+r.width/2,l=r.top+r.height/2,c=Math.sqrt(Math.pow(i.x-o,2)+Math.pow(i.y-l,2)),u=Math.max(0,1-c/e);s(u)},[i,n,e]),t},zc=()=>{const{getSelectedAlbum:n,selectAlbum:e,addAlbum:t,updateAlbum:s}=bt(),{getLog:i}=Wa(),{state:r,requestPlayAlbum:o}=Rt(),{navigateToRoom:l}=wt(),c=n(),[u,h]=x.useState("");x.useEffect(()=>{h(c?.memo||"")},[c?.id]);const d=c?.causalLogId?i(c.causalLogId):void 0,[g,f]=x.useState(!1),[m,p]=x.useState(null),[_,y]=x.useState(!1),w=x.useRef(null),S=$c(w,300),[E,b]=x.useState(-1),T=M=>{const P=w.current;if(!P)return;const I=P.getBoundingClientRect(),F=(M.clientX-I.left)/Math.max(1,I.width),V=(M.clientY-I.top)/Math.max(1,I.height),O=Math.max(0,Math.min(1,F)),G=Math.max(0,Math.min(1,V)),Y=(O-.5)*10,H=(.5-G)*7;P.style.setProperty("--tilt-x",`${H.toFixed(2)}deg`),P.style.setProperty("--tilt-y",`${Y.toFixed(2)}deg`),P.style.setProperty("--shine-x",`${(O*100).toFixed(1)}%`),P.style.setProperty("--shine-y",`${(G*100).toFixed(1)}%`)},j=()=>{const M=w.current;M&&(M.style.setProperty("--tilt-x","0deg"),M.style.setProperty("--tilt-y","0deg"),M.style.setProperty("--shine-x","50%"),M.style.setProperty("--shine-y","45%"))},v=c?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],N=r.playbackState===ut.PLAYING&&r.currentAlbum?.id===c?.id,A=()=>{e(null),l("gallery")},D=async()=>{if(!c||!c.metadata){p("メタデータが見つかりません");return}try{f(!0),p(null),y(!1);const M=Math.floor(Math.random()*Wc),P=await ti({mood:c.mood,duration:c.duration,motifTags:c.metadata.motif_tags||[],stylePreset:c.metadata.stylePreset,seed:M,valence:c.metadata.valence,arousal:c.metadata.arousal,focus:c.metadata.focus,confidence:c.metadata.confidence}),I=await Js(P.jobId,F=>{console.log("Regenerate status:",F)});if(I.status==="succeeded"&&I.resultUrl)t({mood:c.mood,duration:c.duration,imageDataURL:I.resultUrl,sessionData:c.sessionData,metadata:{...c.metadata,seed:M}}),y(!0),setTimeout(()=>y(!1),3e3);else throw new Error(I.errorMessage||"再生成に失敗しました")}catch(M){p(M instanceof Error?M.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",M)}finally{f(!1)}};return c?a.jsxs("div",{className:"room-content album-room",children:[a.jsxs("div",{className:"album-header room-header",children:[a.jsxs("div",{className:"album-header-left",children:[a.jsx("h1",{className:"album-title",children:c.title||c.mood}),a.jsxs("p",{className:"album-subtitle",children:["ムード: ",c.mood," ・ 選択したアルバムの詳細"]})]}),a.jsxs("div",{className:"album-header-actions room-header-actions",children:[a.jsx("button",{className:"btn back-to-gallery-btn",onClick:A,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),a.jsx("button",{className:"btn btn-primary",disabled:!c.musicData,onClick:()=>o(c),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>l("social"),children:"公開"}),a.jsx(en,{triggerClassName:"btn",trigger:a.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:M})=>a.jsx(tn,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{l("gallery"),M()}},{id:"publish",label:"SNSに公開",onSelect:()=>{l("social"),M()}},{id:"play",label:"再生",onSelect:()=>{o(c),M()}},{id:"favorite",label:c.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{s(c.id,{isFavorite:!c.isFavorite}),M()}},{id:"public",label:c.isPublic?"非公開にする":"公開にする",onSelect:()=>{s(c.id,{isPublic:!c.isPublic}),M()}}]})})]})]}),a.jsxs("div",{className:"album-details",children:[a.jsxs("div",{className:`album-image-container ${N?"is-playing":""}`,ref:w,onMouseMove:T,onMouseLeave:j,children:[a.jsx(Uc,{dominantColors:v,isPlaying:N,beatAmplitude:0,mouseProximity:S,highlightedLayer:E}),a.jsx("img",{src:c.imageDataURL,alt:`${c.mood}のセッション画像`,className:"album-image"})]}),a.jsxs("div",{className:"album-metadata",children:[a.jsx("div",{className:"album-summary-card",children:a.jsx(Gt,{variant:"compact",title:c.title||c.mood,mood:c.mood,imageUrl:c.imageDataURL,meta:`作成日: ${new Date(c.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:c.musicData?"再生可能":"音声なし",tone:c.musicData?"success":"default"},...c.isPublic?[{label:"公開中",tone:"info"}]:[],...c.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),a.jsxs("section",{className:"metadata-section","aria-label":"アルバムメモ",children:[a.jsx("h2",{className:"metadata-section-title",children:"メモ（ひとこと）"}),a.jsx("textarea",{className:"album-memo-input",value:u,onChange:M=>h(M.target.value),onBlur:()=>{const M=u.trim();(c.memo||"")!==M&&s(c.id,{memo:M||void 0})},placeholder:"この作品にひとこと。気づき、風景、だれにも見せないメモでも。",rows:3}),a.jsx("div",{className:"album-memo-hint",children:"フォーカスが外れると自動で保存します。"})]}),a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"基本情報"}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"ムード"}),a.jsx("span",{className:"metadata-value",children:c.mood})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"セッション時間"}),a.jsxs("span",{className:"metadata-value",children:[c.duration,"秒"]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"作成日"}),a.jsx("span",{className:"metadata-value",children:new Date(c.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),c.metadata&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"感情分析 (IR)"}),c.metadata.valence!==void 0&&a.jsxs("div",{className:"metadata-item",onMouseEnter:()=>b(0),onMouseLeave:()=>b(-1),children:[a.jsx("span",{className:"metadata-label",children:"Valence"}),a.jsxs("span",{className:"metadata-value",children:[c.metadata.valence.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.valence>0?"明るい":"暗い",")"]})]})]}),c.metadata.arousal!==void 0&&a.jsxs("div",{className:"metadata-item",onMouseEnter:()=>b(1),onMouseLeave:()=>b(-1),children:[a.jsx("span",{className:"metadata-label",children:"Arousal"}),a.jsxs("span",{className:"metadata-value",children:[c.metadata.arousal.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.arousal>.6?"動的":"静的",")"]})]})]}),c.metadata.focus!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"Focus"}),a.jsxs("span",{className:"metadata-value",children:[c.metadata.focus.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),c.metadata.confidence!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"信頼度"}),a.jsxs("span",{className:"metadata-value",children:[Math.round(c.metadata.confidence*100),"%"]})]}),c.metadata.motif_tags&&c.metadata.motif_tags.length>0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"モチーフ"}),a.jsx("span",{className:"metadata-value metadata-tags",children:c.metadata.motif_tags.join(", ")})]})]}),a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"生成パラメータ"}),c.metadata.stylePreset&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"スタイル"}),a.jsx("span",{className:"metadata-value",children:c.metadata.stylePreset})]}),c.metadata.seed!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"シード"}),a.jsx("span",{className:"metadata-value metadata-id",children:c.metadata.seed})]}),c.metadata.provider&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"生成方法"}),a.jsx("span",{className:"metadata-value",children:c.metadata.provider==="replicate"?"Replicate (SDXL)":c.metadata.provider==="local"?"ローカル生成":c.metadata.provider})]})]}),c.musicMetadata&&a.jsxs("div",{className:"metadata-section",children:[a.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"調"}),a.jsx("span",{className:"metadata-value",children:c.musicMetadata.key})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"テンポ"}),a.jsxs("span",{className:"metadata-value",children:[c.musicMetadata.tempo," BPM"]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"拍子"}),a.jsx("span",{className:"metadata-value",children:c.musicMetadata.timeSignature})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"形式"}),a.jsx("span",{className:"metadata-value",children:c.musicMetadata.form})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"性格"}),a.jsx("span",{className:"metadata-value",children:c.musicMetadata.character})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"生成方法"}),a.jsx("span",{className:"metadata-value",children:c.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":c.musicMetadata.provider==="rule-based"?"ルールベース":c.musicMetadata.provider})]}),c.musicData&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"フォーマット"}),a.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(c.musicData.length/1024)," KB)"]})]})]}),c.metadata.provider==="replicate"&&a.jsxs("div",{className:"album-actions",children:[a.jsx("button",{className:"regenerate-btn",onClick:D,disabled:g,children:g?"再生成中...":"再生成 (新しいシード)"}),_&&a.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),m&&a.jsx("div",{className:"regenerate-error",children:m})]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"アルバムID"}),a.jsx("span",{className:"metadata-value metadata-id",children:c.id})]})]}),a.jsx(Bc,{log:d})]})]}):a.jsxs("div",{className:"room-content album-room",children:[a.jsx("h1",{className:"room-title",children:"ALBUM"}),a.jsx("p",{className:"room-subtitle",children:"アルバム詳細"}),a.jsxs("div",{className:"album-empty",children:[a.jsx("p",{children:"アルバムが選択されていません"}),a.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})]})},Yc=()=>{const{albums:n,getSelectedAlbum:e,selectAlbum:t}=bt(),s=e(),{navigateToRoom:i}=wt(),{requestPlayAlbum:r}=Rt(),[o,l]=L.useState("now"),c=n.filter(d=>d.musicData),u=s&&s.musicData?a.jsxs("div",{className:"music-panel",children:[a.jsx(Gt,{title:s.title||s.mood,mood:s.mood,imageUrl:s.imageDataURL,meta:`作成日: ${new Date(s.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...s.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...s.isPublic?[{label:"公開",tone:"info"}]:[]]}),s.musicMetadata&&a.jsxs("div",{className:"music-meta-grid room-card",children:[a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"調"}),a.jsx("span",{children:s.musicMetadata.key})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"テンポ"}),a.jsxs("span",{children:[s.musicMetadata.tempo," BPM"]})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"拍子"}),a.jsx("span",{children:s.musicMetadata.timeSignature})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"形式"}),a.jsx("span",{children:s.musicMetadata.form})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"性格"}),a.jsx("span",{children:s.musicMetadata.character})]})]}),a.jsxs("div",{className:"music-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:()=>r(s,c),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})]})]}):a.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),h=a.jsxs("div",{className:"music-panel",children:[a.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",c.length,"件"]}),c.length>0?a.jsx("div",{className:"music-library-grid",children:c.map(d=>a.jsx("button",{className:"album-card-button",onClick:()=>{t(d.id),r(d,c)},children:a.jsx(Gt,{title:d.title||d.mood,mood:d.mood,imageUrl:d.imageDataURL,meta:d.musicMetadata?`${d.musicMetadata.key} | ${d.musicMetadata.tempo} BPM | ${d.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...d.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...d.isPublic?[{label:"公開",tone:"info"}]:[]]})},d.id))}):a.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return a.jsxs("div",{className:"room-content music-room",children:[a.jsxs("div",{className:"room-header music-header",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"MUSIC"}),a.jsx("p",{className:"room-subtitle",children:"選択したアルバムを再生する"})]}),a.jsx("div",{className:"room-header-actions",children:a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})})]}),a.jsx(Ja,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:h}],value:o,onChange:l,ariaLabel:"音楽タブ"})]})},Pt="https://airia-beyond.onrender.com";async function Hc(n=50,e="all"){const t=await Ke(`${Pt}/api/social/posts?limit=${encodeURIComponent(String(n))}&mode=${encodeURIComponent(String(e))}`);if(!t.ok)throw new Error(`Failed to load posts: ${t.status}`);return t.json()}async function Xc(n=50){const e=await Ke(`${Pt}/api/social/me/posts?limit=${encodeURIComponent(String(n))}`),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to load my posts: ${e.status}`);return t}async function Jc(n){const e=await Ke(`${Pt}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function Zc(n){const e=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function Kc(n,e){const t=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to comment: ${t.status}`);return s}async function Qc(n){const e=await Ke(`${Pt}/api/social/users/${encodeURIComponent(n)}/follow`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to follow: ${e.status}`);return t}async function Za(n,e){const t=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:e})}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to update post: ${t.status}`);return s}async function Ka(n){const e=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to delete post: ${e.status}`);return t}const el={comment:a.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:a.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:a.jsxs(a.Fragment,{children:[a.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),a.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:a.jsx("path",{d:"M6 9l6 6 6-6"}),more:a.jsxs(a.Fragment,{children:[a.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),a.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},$s=({name:n,size:e=16,className:t})=>a.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:el[n]}),tl=()=>{const{albums:n,getSelectedAlbum:e,updateAlbum:t}=bt(),s=e(),{navigateToRoom:i}=wt(),[r,o]=L.useState([]),[l,c]=L.useState(!1),[u,h]=L.useState(null),{user:d,logout:g,updateFollowingIds:f}=As(),[m,p]=L.useState(""),[_,y]=L.useState(s?.id||(n[0]?.id??"")),[w,S]=L.useState(!1),[E,b]=L.useState({}),[T,j]=L.useState(null),[v,N]=L.useState("all"),[A,D]=L.useState({}),[M,P]=L.useState(null),I=L.useCallback(()=>{try{const R=String(window.location.hash||"").match(/^#social\/(.+)$/);if(R&&R[1])return decodeURIComponent(R[1])}catch{}try{const C="airia_social_focus_post_v1",R=localStorage.getItem(C);if(R)return localStorage.removeItem(C),String(R)}catch{}return null},[]),F=async C=>{const R=`${window.location.origin}/#social/${C}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(R);else{const k=document.createElement("input");k.value=R,document.body.appendChild(k),k.select(),document.execCommand("copy"),document.body.removeChild(k)}h("リンクをコピーしました"),setTimeout(()=>h(null),1500)}catch(k){h(k instanceof Error?k.message:String(k))}},V=L.useCallback(async()=>{c(!0),h(null);try{const C=await Hc(50,v);o(C.posts||[]);const R=M||I();R&&(P(R),D(k=>({...k,[R]:!0})),window.setTimeout(()=>{const k=document.querySelector(`[data-post-id="${CSS.escape(R)}"]`);k&&"scrollIntoView"in k&&k.scrollIntoView({block:"start",behavior:"smooth"})},60))}catch(C){h(C instanceof Error?C.message:String(C))}finally{c(!1)}},[I,v,M]);L.useEffect(()=>{V()},[V]),L.useEffect(()=>{s?.id&&y(s.id)},[s?.id]);const O=L.useMemo(()=>n.find(C=>C.id===_)||null,[n,_]),G=!!d&&!!O?.imageDataURL&&!w,Y=async()=>{if(!d){h("投稿にはログインが必要です");return}if(O){S(!0),h(null);try{const C=await Jc({caption:m,album:{title:O.title||O.mood,mood:O.mood,imageUrl:O.thumbnailUrl||O.imageDataURL,createdAt:O.createdAt}});o(R=>[C,...R]),O.isPublic||t(O.id,{isPublic:!0}),p("")}catch(C){h(C instanceof Error?C.message:String(C))}finally{S(!1)}}},H=async C=>{if(!d){h("いいねにはログインが必要です");return}try{const R=await Zc(C);o(k=>k.map(W=>W.id===C?R:W))}catch(R){h(R instanceof Error?R.message:String(R))}},X=async C=>{if(!d){h("コメントにはログインが必要です");return}const R=(E[C]||"").trim();if(R){j(C),h(null);try{const k=await Kc(C,{text:R});o(W=>W.map(oe=>oe.id===C?{...oe,comments:Array.isArray(oe.comments)?[...oe.comments,k]:[k]}:oe)),b(W=>({...W,[C]:""}))}catch(k){h(k instanceof Error?k.message:String(k))}finally{j(null)}}},ee=async C=>{if(!d){h("フォローにはログインが必要です");return}try{const R=await Qc(C);f(R.followingIds)}catch(R){h(R instanceof Error?R.message:String(R))}},U=C=>{D(R=>({...R,[C]:!R[C]}))},Q=async C=>{if(!d){h("操作にはログインが必要です");return}const k=(String(C.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";h(null);try{const W=await Za(C.id,k);o(oe=>oe.map(Ee=>Ee.id===C.id?W:Ee))}catch(W){h(W instanceof Error?W.message:String(W))}},B=async C=>{if(!d){h("操作にはログインが必要です");return}const R=C.album?.title||C.album?.mood||"投稿";if(window.confirm(`削除しますか？

${R}
この操作は取り消せません。`)){h(null);try{await Ka(C.id),o(k=>k.filter(W=>W.id!==C.id))}catch(k){h(k instanceof Error?k.message:String(k))}}};return a.jsxs("div",{className:"room-content social-room",children:[a.jsxs("div",{className:"social-header",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"SOCIAL"}),a.jsx("p",{className:"room-subtitle",children:"作品を公開して、反応を集める"})]}),a.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"}),a.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"更新"})]})]}),a.jsx("div",{className:"social-filter","data-no-swipe":"true",children:a.jsx(si,{value:v,onChange:C=>N(C),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),a.jsx("div",{className:"social-auth","data-no-swipe":"true","aria-label":"ログイン",children:a.jsxs("div",{className:"social-auth-row",children:[a.jsxs("div",{className:"social-auth-me",children:[a.jsx("div",{className:"social-auth-title",children:"ログイン中"}),a.jsxs("div",{className:"social-auth-handle",children:["@",d?.handle||"..."]}),a.jsx("div",{className:"social-auth-sub",children:d?.displayName||""})]}),a.jsxs("div",{className:"social-auth-actions",children:[a.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"再読み込み"}),a.jsx("button",{className:"btn",onClick:()=>void g(),disabled:!d,children:"ログアウト"})]})]})}),a.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[a.jsxs("div",{className:"social-compose-grid",children:[a.jsxs("label",{className:"social-field",children:[a.jsx("span",{className:"social-label",children:"公開するアルバム"}),a.jsxs("select",{className:"social-select",value:_,onChange:C=>y(C.target.value),children:[n.length===0&&a.jsx("option",{value:"",children:"（アルバムがありません）"}),n.map(C=>a.jsx("option",{value:C.id,children:C.title||C.mood},C.id))]})]}),a.jsxs("label",{className:"social-field social-field-wide",children:[a.jsx("span",{className:"social-label",children:"キャプション"}),a.jsx("textarea",{className:"social-textarea",value:m,onChange:C=>p(C.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),a.jsxs("div",{className:"social-compose-actions",children:[a.jsx("button",{className:"btn btn-primary",disabled:!G,onClick:Y,children:w?"公開中…":"公開する"}),O&&a.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:a.jsx(Gt,{variant:"compact",title:O.title||O.mood,mood:O.mood,imageUrl:O.thumbnailUrl||O.imageDataURL,badges:[{label:O.musicData?"再生可能":"音声なし",tone:O.musicData?"success":"default"}]})})]}),u&&a.jsx("div",{className:"social-error",children:u})]}),a.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[l&&r.length===0&&a.jsx("div",{className:"social-muted",children:"読み込み中…"}),!l&&r.length===0&&a.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),r.map(C=>a.jsxs("article",{className:"social-post","data-no-swipe":"true","data-post-id":C.id,children:[a.jsxs("header",{className:"social-post-header",children:[a.jsxs("div",{className:"social-post-author",children:[C.author?.handle?`@${C.author.handle}`:C.authorName||"anonymous",C.author?.displayName&&a.jsx("span",{className:"social-post-author-sub",children:C.author.displayName})]}),a.jsx("div",{className:"social-post-date",children:new Date(C.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),C.author?.id&&d?.id!==C.author.id&&a.jsx("div",{className:"social-post-follow","data-no-swipe":"true",children:a.jsx("button",{className:`btn ${d?.followingIds?.includes(C.author.id)?"btn-primary":""}`,onClick:()=>void ee(C.author.id),disabled:!d,children:d?.followingIds?.includes(C.author.id)?"フォロー中":"フォロー"})}),a.jsx("div",{className:"social-post-album",children:a.jsx(Gt,{title:C.album?.title||"album",mood:C.album?.mood,imageUrl:C.album?.imageUrl,meta:C.album?.createdAt?`作成日: ${new Date(C.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:String(C.visibility||"public").toLowerCase()==="private"?"非公開":"公開作品",tone:String(C.visibility||"public").toLowerCase()==="private"?"default":"info"}]})}),C.caption&&a.jsx("div",{className:"social-post-caption",children:C.caption}),a.jsxs("div",{className:"social-post-actions",children:[a.jsxs("button",{className:`btn social-action ${A[C.id]?"is-active":""}`,onClick:()=>U(C.id),"aria-expanded":!!A[C.id],"aria-controls":`post-comments-${C.id}`,"aria-label":A[C.id]?"コメントを閉じる":"コメントを開く",children:[a.jsxs("span",{className:"social-action-main",children:[a.jsx($s,{name:A[C.id]?"chevronDown":"comment",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:A[C.id]?"閉じる":"コメント"})]}),a.jsx("span",{className:"social-count-chip",children:Array.isArray(C.comments)?C.comments.length:0})]}),a.jsxs("button",{className:`btn social-action ${C.viewerHasLiked?"is-active":""}`,onClick:()=>void H(C.id),disabled:!d,children:[a.jsxs("span",{className:"social-action-main",children:[a.jsx($s,{name:"heart",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:"いいね"})]}),a.jsx("span",{className:"social-count-chip",children:C.likes||0})]}),a.jsx("button",{className:"btn social-action",onClick:()=>void F(C.id),children:a.jsxs("span",{className:"social-action-main",children:[a.jsx($s,{name:"link",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:"共有"})]})}),a.jsx(en,{triggerClassName:"btn social-action social-action-iconOnly",trigger:a.jsx($s,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:R})=>a.jsx(tn,{items:(()=>{const k=!!d?.id&&!!C.author?.id&&d.id===C.author.id,W=[{id:"copy",label:"リンクをコピー",onSelect:()=>{F(C.id),R()}}];if(k){const oe=String(C.visibility||"public").toLowerCase()==="private";W.push({id:"vis",label:oe?"公開にする":"非公開にする",onSelect:()=>{Q(C),R()}}),W.push({id:"delete",label:"削除",onSelect:()=>{B(C),R()}})}else W.push({id:"report",label:"通報する",onSelect:()=>{h("通報を受け付けました"),R()}});return W})()})})]}),A[C.id]&&a.jsxs("div",{className:"social-post-comments",id:`post-comments-${C.id}`,children:[(C.comments||[]).slice(-6).map(R=>a.jsxs("div",{className:"social-comment",children:[a.jsx("span",{className:"social-comment-author",children:R.authorName||"anonymous"}),a.jsx("span",{className:"social-comment-text",children:R.text})]},R.id)),a.jsxs("div",{className:"social-comment-compose",children:[a.jsx("input",{className:"social-input",value:E[C.id]||"",onChange:R=>b(k=>({...k,[C.id]:R.target.value})),placeholder:d?"コメントを書く":"ログインしてコメント",maxLength:240,disabled:!d}),a.jsx("button",{className:"btn btn-primary",disabled:!d||T===C.id,onClick:()=>void X(C.id),children:T===C.id?"送信中…":"送信"})]})]})]},C.id))]})]})};function sl(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}const nl=()=>{const{user:n}=As(),{navigateToRoom:e}=wt(),t=p=>{try{localStorage.setItem("airia_social_focus_post_v1",String(p))}catch{}e("social")},[s,i]=L.useState(!1),[r,o]=L.useState(null),[l,c]=L.useState([]),[u,h]=L.useState(null),d=L.useCallback(async()=>{if(n){i(!0),o(null);try{const p=await Xc(120);c(p.posts||[])}catch(p){o(p instanceof Error?p.message:String(p))}finally{i(!1)}}},[n]);L.useEffect(()=>{d()},[d]);const g=L.useMemo(()=>l.reduce((p,_)=>p+(Number(_.likes)||0),0),[l]),f=async p=>{const y=(String(p.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";h(p.id),o(null);try{const w=await Za(p.id,y);c(S=>S.map(E=>E.id===p.id?w:E))}catch(w){o(w instanceof Error?w.message:String(w))}finally{h(null)}},m=async p=>{const _=p.album?.title||p.album?.mood||"投稿";if(window.confirm(`削除しますか？

${_}
この操作は取り消せません。`)){h(p.id),o(null);try{await Ka(p.id),c(y=>y.filter(w=>w.id!==p.id))}catch(y){o(y instanceof Error?y.message:String(y))}finally{h(null)}}};return a.jsxs("div",{className:"room-content mypage-room",children:[a.jsxs("div",{className:"mypage-header","data-no-swipe":"true",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"MY"}),a.jsx("p",{className:"room-subtitle",children:"あなたのプロフィールと投稿"})]}),a.jsxs("div",{className:"mypage-header-actions",children:[a.jsx("button",{className:"btn",onClick:()=>e("settings"),children:"設定へ"}),a.jsx("button",{className:"btn",onClick:()=>void d(),disabled:s||!n,children:"更新"})]})]}),a.jsxs("div",{className:"mypage-card",children:[a.jsxs("section",{className:"mypage-section",children:[a.jsx("h2",{className:"mypage-title",children:"プロフィール"}),a.jsxs("div",{className:"mypage-profile",children:[a.jsx("div",{className:"mypage-avatar","aria-hidden":"true",children:(n?.displayName||n?.handle||"A").slice(0,1).toUpperCase()}),a.jsxs("div",{className:"mypage-profile-meta",children:[a.jsxs("div",{className:"mypage-handle",children:["@",n?.handle||"..."]}),a.jsx("div",{className:"mypage-name",children:n?.displayName||""}),n?.bio?a.jsx("div",{className:"mypage-bio",children:n.bio}):a.jsx("div",{className:"mypage-bio muted",children:"自己紹介は未設定です"})]})]})]}),a.jsxs("section",{className:"mypage-section",children:[a.jsx("h2",{className:"mypage-title",children:"サマリー"}),a.jsxs("div",{className:"mypage-stats",children:[a.jsxs("div",{className:"mypage-stat",children:[a.jsx("div",{className:"mypage-stat-k",children:"投稿"}),a.jsx("div",{className:"mypage-stat-v",children:l.length})]}),a.jsxs("div",{className:"mypage-stat",children:[a.jsx("div",{className:"mypage-stat-k",children:"合計いいね"}),a.jsx("div",{className:"mypage-stat-v",children:g})]}),a.jsxs("div",{className:"mypage-stat",children:[a.jsx("div",{className:"mypage-stat-k",children:"フォロー中"}),a.jsx("div",{className:"mypage-stat-v",children:n?.followingIds?.length||0})]})]})]}),a.jsxs("section",{className:"mypage-section","data-no-swipe":"true",children:[a.jsxs("div",{className:"mypage-row",children:[a.jsx("h2",{className:"mypage-title",children:"あなたの投稿"}),a.jsx("button",{className:"btn",onClick:()=>e("social"),children:"Socialへ"})]}),r&&a.jsx("div",{className:"mypage-error",children:r}),s&&a.jsx("div",{className:"mypage-muted",children:"読み込み中…"}),!s&&l.length===0&&a.jsx("div",{className:"mypage-muted",children:"まだ投稿がありません"}),a.jsx("div",{className:"mypage-posts",children:l.map(p=>a.jsxs("article",{className:"mypage-post",children:[a.jsxs("div",{className:"mypage-post-top",children:[a.jsxs("div",{className:"mypage-post-title",children:[p.album?.title||p.album?.mood||"作品",String(p.visibility||"public").toLowerCase()==="private"?a.jsx("span",{className:"mypage-visibility mypage-visibility-private",children:"非公開"}):a.jsx("span",{className:"mypage-visibility",children:"公開"})]}),a.jsx("div",{className:"mypage-post-time",children:sl(p.createdAt)})]}),p.caption?a.jsx("div",{className:"mypage-post-caption",children:p.caption}):null,a.jsxs("div",{className:"mypage-post-meta",children:[a.jsxs("span",{children:["♥ ",p.likes]}),a.jsxs("span",{children:["💬 ",p.comments?.length||0]}),a.jsxs("div",{className:"mypage-post-actions",children:[a.jsx("button",{className:"btn",onClick:()=>t(p.id),disabled:u===p.id,children:"開く"}),a.jsx("button",{className:"btn",onClick:()=>void f(p),disabled:u===p.id,children:String(p.visibility||"public").toLowerCase()==="private"?"公開にする":"非公開にする"}),a.jsx("button",{className:"btn",onClick:()=>void m(p),disabled:u===p.id,children:"削除"})]})]})]},p.id))})]})]})]})};function il(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})}const al=()=>{const{user:n,logout:e,updateProfile:t,loading:s}=As(),{addToast:i}=Ms(),[r,o]=L.useState(n?.displayName||""),[l,c]=L.useState(n?.bio||""),[u,h]=L.useState(!1);L.useEffect(()=>{o(n?.displayName||""),c(n?.bio||"")},[n?.displayName,n?.bio]);const d=!!n&&!u&&(r.trim()!==(n?.displayName||"")||l.trim()!==(n?.bio||"")),g=async()=>{if(n){h(!0);try{await t({displayName:r.trim()||void 0,bio:l.trim()||""}),i("success","プロフィールを保存しました")}catch(m){i("error",m instanceof Error?m.message:"保存に失敗しました")}finally{h(!1)}}},f=async()=>{try{await e()}catch{}};return a.jsxs("div",{className:"room-content settings-room",children:[a.jsxs("div",{className:"settings-header","data-no-swipe":"true",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"SETTINGS"}),a.jsx("p",{className:"room-subtitle",children:"アカウントとプロフィール"})]}),a.jsx("div",{className:"settings-header-actions",children:a.jsx("button",{className:"btn",onClick:()=>void f(),disabled:!n||s,children:"ログアウト"})})]}),a.jsxs("div",{className:"settings-card",children:[a.jsxs("section",{className:"settings-section",children:[a.jsx("h2",{className:"settings-title",children:"アカウント"}),a.jsxs("div",{className:"settings-kv",children:[a.jsxs("div",{className:"settings-kv-row",children:[a.jsx("div",{className:"settings-k",children:"ハンドル"}),a.jsxs("div",{className:"settings-v",children:["@",n?.handle||"..."]})]}),a.jsxs("div",{className:"settings-kv-row",children:[a.jsx("div",{className:"settings-k",children:"作成日"}),a.jsx("div",{className:"settings-v",children:n?.createdAt?il(n.createdAt):""})]})]})]}),a.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[a.jsx("h2",{className:"settings-title",children:"プロフィール"}),a.jsxs("div",{className:"settings-grid",children:[a.jsxs("label",{className:"settings-field",children:[a.jsx("span",{className:"settings-label",children:"表示名"}),a.jsx("input",{className:"settings-input",value:r,onChange:m=>o(m.target.value),maxLength:32,placeholder:"あなたの名前"})]}),a.jsxs("label",{className:"settings-field settings-field-wide",children:[a.jsx("span",{className:"settings-label",children:"自己紹介"}),a.jsx("textarea",{className:"settings-textarea",value:l,onChange:m=>c(m.target.value),maxLength:160,rows:4,placeholder:"一言（任意）"})]})]}),a.jsxs("div",{className:"settings-actions",children:[a.jsx("button",{className:"btn btn-primary",disabled:!d,onClick:()=>void g(),children:u?"保存中…":"保存する"}),a.jsx("div",{className:"settings-muted",children:"プレリリースでは基本項目のみ編集できます。"})]})]}),a.jsxs("section",{className:"settings-section",children:[a.jsx("h2",{className:"settings-title",children:"通知"}),a.jsx("p",{className:"settings-muted",children:"メール通知は次フェーズで追加予定です。"})]})]})]})},rl=({label:n,children:e,placement:t="top"})=>{const s=x.useId(),[i,r]=x.useState(!1),o=[e.props["aria-describedby"],s].filter(Boolean).join(" ");return a.jsxs("span",{className:`tooltip-wrapper tooltip-${t}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),onFocusCapture:()=>r(!0),onBlurCapture:()=>r(!1),"data-no-swipe":"true",children:[L.cloneElement(e,{"aria-describedby":o}),a.jsx("span",{id:s,role:"tooltip",className:`tooltip-bubble ${i?"is-open":""}`,children:n})]})},fa="airia_theme";function ol(n){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n==="system"?e?"dark":"light":n;document.documentElement.setAttribute("data-theme",t)}const cl=()=>{const{addToast:n}=Ms(),{navigateToRoom:e}=wt(),[t,s]=L.useState(()=>{try{return localStorage.getItem(fa)||"system"}catch{return"system"}}),i=l=>{s(l);try{localStorage.setItem(fa,l)}catch{}ol(l)},[r,o]=L.useState(!1);return a.jsxs("div",{className:"room-content info-room",children:[a.jsx("h1",{className:"room-title",children:"INFO"}),a.jsx("p",{className:"room-subtitle",children:"このアプリについて"}),a.jsxs("div",{className:"info-card",children:[a.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[a.jsx("h2",{className:"info-title",children:"フィードバック"}),a.jsx("p",{className:"info-text",children:"不便・バグ・改善案はもちろん、良かった点も歓迎です。短くても大丈夫。"}),a.jsx("div",{className:"info-actions",children:a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>e("feedback"),children:"フィードバックを書く"})})]}),a.jsxs("section",{className:"info-section",children:[a.jsx("h2",{className:"info-title",children:"目的"}),a.jsx("p",{className:"info-text",children:"この体験の目的は、「より貴方らしい芸術」を日常の中で生み出せること。"}),a.jsx("p",{className:"info-text",children:"そして、気持ちの変化に合わせて「ずっと寄り添える」相棒になることです。"})]}),a.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[a.jsxs("div",{className:"info-actions",children:[a.jsx("h2",{className:"info-title",children:"テーマ"}),a.jsx(rl,{label:"見やすさに合わせて切り替えできます",children:a.jsx("span",{className:"info-badge","aria-hidden":"true",children:"?"})})]}),a.jsx("div",{className:"info-actions",children:a.jsx("div",{className:"theme-toggle",role:"group","aria-label":"テーマ切り替え",children:[{id:"system",label:"システム"},{id:"light",label:"ライト"},{id:"dark",label:"ダーク"},{id:"high-contrast",label:"高コントラスト"}].map(l=>a.jsx("button",{type:"button",className:"theme-button","aria-pressed":t===l.id,onClick:()=>i(l.id),children:l.label},l.id))})}),a.jsx("p",{className:"info-text",children:"見やすさに合わせて切り替えられます。"})]}),a.jsxs("section",{className:"info-section",children:[a.jsxs("div",{className:"info-actions",children:[a.jsx("h2",{className:"info-title",children:"リンク"}),a.jsx("button",{type:"button",className:"info-reset",onClick:()=>o(!0),children:"アプリ情報"})]}),a.jsx("ul",{className:"info-list",children:a.jsx("li",{children:a.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})})})]}),null]}),a.jsxs(za,{open:r,onOpenChange:o,title:"AIRIA BEYOND",description:"あなたの一日を、作品へ。",footer:a.jsx("button",{className:"btn btn-primary",onClick:()=>o(!1),children:"閉じる"}),children:[a.jsx("p",{className:"info-text",children:"会話と気分の手がかりから、あなたに合うレコメンドや創作を少しずつ育てていきます。"}),a.jsx("p",{className:"info-text",children:"まだプレリリース段階です。気づいたことがあれば、ぜひフィードバックを送ってください。"})]})]})},ll=()=>{const{navigateToRoom:n}=wt(),{addToast:e}=Ms(),[t,s]=L.useState(!1),[i,r]=L.useState(null),[o,l]=L.useState(!1),[c,u]=L.useState(""),[h,d]=L.useState(""),[g,f]=L.useState(""),[m,p]=L.useState(""),[_,y]=L.useState(""),[w,S]=L.useState(""),[E,b]=L.useState(""),[T,j]=L.useState(""),[v,N]=L.useState(""),[A,D]=L.useState(""),[M,P]=L.useState(""),[I,F]=L.useState(!0),[V,O]=L.useState(!1),[G,Y]=L.useState(null),[H,X]=L.useState(""),[ee,U]=L.useState(!1),Q=L.useMemo(()=>(g.trim().length>0||m.trim().length>0||_.trim().length>0||w.trim().length>0||E.trim().length>0)&&!t,[E,w,t,m,_,g]),B=async()=>{Y(null),O(!0);try{const k=await fetch("/api/diagnostics/image",{method:"GET"}),W=await k.json().catch(()=>({}));if(!k.ok)throw new Error(W?.message||"診断情報の取得に失敗しました");const oe=JSON.stringify(W,null,2);X(oe),e("success","診断情報を取得しました。必要ならコピーして送れます。")}catch(k){const W=k instanceof Error?k.message:"診断情報の取得に失敗しました";Y(W),e("error",W)}finally{O(!1)}},C=async()=>{const k=H.trim();if(!k){e("info","先に「診断情報を取得」を押してください。");return}try{await navigator.clipboard.writeText(k),e("success","診断情報をコピーしました。")}catch{try{const W=document.createElement("textarea");W.value=k,W.style.position="fixed",W.style.left="-9999px",document.body.appendChild(W),W.select(),document.execCommand("copy"),document.body.removeChild(W),e("success","診断情報をコピーしました。")}catch{e("error","コピーに失敗しました。手動で選択してコピーしてください。")}}},R=async()=>{if(Q){r(null),l(!1),s(!0);try{const k=await fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:c||void 0,rating:h||void 0,title:g||void 0,message:m||void 0,steps:_||void 0,expected:w||void 0,actual:E||void 0,device:T||void 0,browser:v||void 0,name:A||void 0,contact:M||void 0,allowFollowUp:I,diagnostics:ee&&H.trim().length>0?H:void 0})}),W=await k.json().catch(()=>({}));if(!k.ok)throw new Error(W?.message||"送信に失敗しました");l(!0),e("success","フィードバックを送信しました。ありがとうございます。"),u(""),d(""),f(""),p(""),y(""),S(""),b(""),j(""),N("")}catch(k){const W=k instanceof Error?k.message:"送信に失敗しました";r(W),e("error",W)}finally{s(!1)}}};return a.jsxs("div",{className:"room-content feedback-room",children:[a.jsxs("div",{className:"feedback-header","data-no-swipe":"true",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"FEEDBACK"}),a.jsx("p",{className:"room-subtitle",children:"改善のために、気づいたことを教えてください"})]}),a.jsx("div",{className:"feedback-header-actions",children:a.jsx("button",{className:"btn btn-secondary",onClick:()=>n("info"),children:"Infoへ"})})]}),a.jsxs("div",{className:"feedback-hero","data-no-swipe":"true",children:[a.jsxs("div",{className:"feedback-hero-top",children:[a.jsx("h2",{className:"feedback-hero-title",children:"フィードバックを送ってください"}),a.jsxs("p",{className:"feedback-hero-sub",children:["不便・バグ・改善案はもちろん、良かった点も歓迎です。",a.jsx("br",{}),"一部だけの回答でも送信できます。"]})]}),a.jsxs("div",{className:"feedback-grid",children:[a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"カテゴリ"}),a.jsxs("select",{className:"feedback-input",value:c,onChange:k=>u(k.target.value),children:[a.jsx("option",{value:"",children:"未選択"}),a.jsx("option",{value:"bug",children:"バグ"}),a.jsx("option",{value:"ux",children:"使いにくい"}),a.jsx("option",{value:"feature",children:"要望"}),a.jsx("option",{value:"praise",children:"良かった"}),a.jsx("option",{value:"other",children:"その他"})]})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"気持ち（任意）"}),a.jsxs("select",{className:"feedback-input",value:h,onChange:k=>d(k.target.value),children:[a.jsx("option",{value:"",children:"未選択"}),a.jsx("option",{value:"great",children:"最高だった"}),a.jsx("option",{value:"good",children:"良かった"}),a.jsx("option",{value:"ok",children:"ふつう"}),a.jsx("option",{value:"frustrating",children:"困った"}),a.jsx("option",{value:"broken",children:"壊れてる"})]})]}),a.jsxs("div",{className:"feedback-field feedback-span-2",children:[a.jsx("label",{className:"feedback-label",children:"タイトル（任意）"}),a.jsx("input",{className:"feedback-input",value:g,onChange:k=>f(k.target.value),placeholder:"例：再開ボタンが効かない / 背景が綺麗で好き"})]}),a.jsxs("div",{className:"feedback-field feedback-span-2",children:[a.jsx("label",{className:"feedback-label",children:"本文（任意）"}),a.jsx("textarea",{className:"feedback-textarea",value:m,onChange:k=>p(k.target.value),placeholder:"気づいたことを自由に。短くてもOK。",rows:5})]}),a.jsxs("div",{className:"feedback-field feedback-span-2",children:[a.jsx("label",{className:"feedback-label",children:"再現手順（任意・バグ向け）"}),a.jsx("textarea",{className:"feedback-textarea",value:_,onChange:k=>y(k.target.value),placeholder:`例：
1) Chatで「今すぐ1曲」
2) キャンセル
3) 再開
→ エラー`,rows:4})]}),a.jsxs("div",{className:"feedback-field feedback-span-2 feedback-split",children:[a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"期待したこと（任意）"}),a.jsx("textarea",{className:"feedback-textarea",value:w,onChange:k=>S(k.target.value),rows:3})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"実際に起きたこと（任意）"}),a.jsx("textarea",{className:"feedback-textarea",value:E,onChange:k=>b(k.target.value),rows:3})]})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"端末（任意）"}),a.jsx("input",{className:"feedback-input",value:T,onChange:k=>j(k.target.value),placeholder:"例：iPhone / Windows"})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"ブラウザ（任意）"}),a.jsx("input",{className:"feedback-input",value:v,onChange:k=>N(k.target.value),placeholder:"例：Safari / Chrome"})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"お名前（任意）"}),a.jsx("input",{className:"feedback-input",value:A,onChange:k=>D(k.target.value),placeholder:"匿名でもOK"})]}),a.jsxs("div",{className:"feedback-field",children:[a.jsx("label",{className:"feedback-label",children:"連絡先（任意）"}),a.jsx("input",{className:"feedback-input",value:M,onChange:k=>P(k.target.value),placeholder:"返信が必要な場合だけ"})]}),a.jsxs("label",{className:"feedback-check feedback-span-2",children:[a.jsx("input",{type:"checkbox",checked:I,onChange:k=>F(k.target.checked)}),"必要があれば追加で質問してもよい（任意）"]}),a.jsxs("div",{className:"feedback-actions feedback-span-2",children:[a.jsx("button",{type:"button",className:"btn btn-primary feedback-submit",disabled:!Q,onClick:()=>void R(),children:t?"送信中…":"送信する"}),a.jsx("div",{className:"feedback-hint",children:o?"送信完了。ありがとうございます。":"※ タイトル/本文/再現手順など、どれか1つでも書けば送信できます。"}),i?a.jsx("div",{className:"feedback-error",children:i}):null]})]})]}),a.jsxs("div",{className:"diagnostics-card","data-no-swipe":"true",children:[a.jsxs("div",{className:"diagnostics-top",children:[a.jsx("h2",{className:"diagnostics-title",children:"困ったとき（診断情報）"}),a.jsx("p",{className:"diagnostics-sub",children:"画像生成がうまくいかない時は、診断情報をコピーしてフィードバックに貼り付けると原因特定が早くなります。"})]}),a.jsxs("div",{className:"diagnostics-actions",children:[a.jsx("button",{type:"button",className:"btn btn-secondary",disabled:V,onClick:()=>void B(),children:V?"取得中…":"診断情報を取得"}),a.jsx("button",{type:"button",className:"btn btn-secondary",disabled:!H.trim(),onClick:()=>void C(),children:"コピー"}),a.jsxs("label",{className:"diagnostics-attach",children:[a.jsx("input",{type:"checkbox",checked:ee,onChange:k=>U(k.target.checked)}),"フィードバック送信に添付する（任意）"]})]}),a.jsx("p",{className:"diagnostics-note",children:"※ 個人情報は含めませんが、接続先URL・エラー概要・最近のジョブ情報が含まれることがあります。"}),a.jsx("textarea",{className:"diagnostics-textarea",value:H,onChange:k=>X(k.target.value),placeholder:"ここに診断情報が表示されます（取得ボタンを押してください）",rows:7}),G?a.jsx("div",{className:"diagnostics-error",children:G}):null]})]})},ul=({onDismiss:n})=>{const[e,t]=x.useState("enter");x.useEffect(()=>{const i=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>n(),2900)];return()=>{i.forEach(r=>clearTimeout(r))}},[n]);const s=()=>{t("exit"),window.setTimeout(n,260)};return a.jsxs("div",{className:`splash-screen splash-${e}`,onClick:s,role:"button",tabIndex:0,onKeyDown:i=>{(i.key==="Enter"||i.key===" ")&&s()},"aria-label":"クリックして開始",children:[a.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[a.jsx("div",{className:"splash-orbit"}),a.jsx("div",{className:"splash-grain"})]}),a.jsxs("div",{className:"splash-content",children:[a.jsx("div",{className:"splash-mark","aria-hidden":"true",children:a.jsx("div",{className:"splash-monogram",children:"A"})}),a.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),a.jsx("div",{className:"splash-rule","aria-hidden":"true"}),a.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),a.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},Qa="15.1.22",ga=(n,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:n}),va=(n,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:n}),ni=(n,e)=>({startTime:e,type:"setValue",value:n}),er=(n,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:n}),tr=(n,e,{startTime:t,target:s,timeConstant:i})=>s+(e-s)*Math.exp((t-n)/i),ts=n=>n.type==="exponentialRampToValue",sn=n=>n.type==="linearRampToValue",Ct=n=>ts(n)||sn(n),gi=n=>n.type==="setValue",_t=n=>n.type==="setValueCurve",nn=(n,e,t,s)=>{const i=n[e];return i===void 0?s:Ct(i)||gi(i)?i.value:_t(i)?i.values[i.values.length-1]:tr(t,nn(n,e-1,i.startTime,s),i)},_a=(n,e,t,s,i)=>t===void 0?[s.insertTime,i]:Ct(t)?[t.endTime,t.value]:gi(t)?[t.startTime,t.value]:_t(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,nn(n,e-1,t.startTime,i)],ii=n=>n.type==="cancelAndHold",ai=n=>n.type==="cancelScheduledValues",jt=n=>ii(n)||ai(n)?n.cancelTime:ts(n)||sn(n)?n.endTime:n.startTime,ya=(n,e,t,{endTime:s,value:i})=>t===i?i:0<t&&0<i||t<0&&i<0?t*(i/t)**((n-e)/(s-e)):0,ba=(n,e,t,{endTime:s,value:i})=>t+(n-e)/(s-e)*(i-t),hl=(n,e)=>{const t=Math.floor(e),s=Math.ceil(e);return t===s?n[t]:(1-(e-t))*n[t]+(1-(s-e))*n[s]},dl=(n,{duration:e,startTime:t,values:s})=>{const i=(n-t)/e*(s.length-1);return hl(s,i)},zs=n=>n.type==="setTarget";class ml{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=jt(e);if(ii(e)||ai(e)){const s=this._automationEvents.findIndex(r=>ai(e)&&_t(r)?r.startTime+r.duration>=t:jt(r)>=t),i=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),ii(e)){const r=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&Ct(i)){if(r!==void 0&&zs(r))throw new Error("The internal list is malformed.");const o=r===void 0?i.insertTime:_t(r)?r.startTime+r.duration:jt(r),l=r===void 0?this._defaultValue:_t(r)?r.values[r.values.length-1]:r.value,c=ts(i)?ya(t,o,l,i):ba(t,o,l,i),u=ts(i)?ga(c,t,this._currenTime):va(c,t,this._currenTime);this._automationEvents.push(u)}if(r!==void 0&&zs(r)&&this._automationEvents.push(ni(this.getValue(t),t)),r!==void 0&&_t(r)&&r.startTime+r.duration>t){const o=t-r.startTime,l=(r.values.length-1)/r.duration,c=Math.max(2,1+Math.ceil(o*l)),u=o/(c-1)*l,h=r.values.slice(0,c);if(u<1)for(let d=1;d<c;d+=1){const g=u*d%1;h[d]=r.values[d-1]*(1-g)+r.values[d]*g}this._automationEvents[this._automationEvents.length-1]=er(h,r.startTime,o)}}}else{const s=this._automationEvents.findIndex(o=>jt(o)>t),i=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(i!==void 0&&_t(i)&&jt(i)+i.duration>t)return!1;const r=ts(e)?ga(e.value,e.endTime,this._currenTime):sn(e)?va(e.value,t,this._currenTime):e;if(s===-1)this._automationEvents.push(r);else{if(_t(e)&&t+e.duration>jt(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,r)}}return!0}flush(e){const t=this._automationEvents.findIndex(s=>jt(s)>e);if(t>1){const s=this._automationEvents.slice(t-1),i=s[0];zs(i)&&s.unshift(ni(nn(this._automationEvents,t-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=s}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(o=>jt(o)>e),s=this._automationEvents[t],i=(t===-1?this._automationEvents.length:t)-1,r=this._automationEvents[i];if(r!==void 0&&zs(r)&&(s===void 0||!Ct(s)||s.insertTime>e))return tr(e,nn(this._automationEvents,i-1,r.startTime,this._defaultValue),r);if(r!==void 0&&gi(r)&&(s===void 0||!Ct(s)))return r.value;if(r!==void 0&&_t(r)&&(s===void 0||!Ct(s)||r.startTime+r.duration>e))return e<r.startTime+r.duration?dl(e,r):r.values[r.values.length-1];if(r!==void 0&&Ct(r)&&(s===void 0||!Ct(s)))return r.value;if(s!==void 0&&ts(s)){const[o,l]=_a(this._automationEvents,i,r,s,this._defaultValue);return ya(e,o,l,s)}if(s!==void 0&&sn(s)){const[o,l]=_a(this._automationEvents,i,r,s,this._defaultValue);return ba(e,o,l,s)}return this._defaultValue}}const pl=n=>({cancelTime:n,type:"cancelAndHold"}),fl=n=>({cancelTime:n,type:"cancelScheduledValues"}),gl=(n,e)=>({endTime:e,type:"exponentialRampToValue",value:n}),vl=(n,e)=>({endTime:e,type:"linearRampToValue",value:n}),_l=(n,e,t)=>({startTime:e,target:n,timeConstant:t,type:"setTarget"}),yl=()=>new DOMException("","AbortError"),bl=n=>(e,t,[s,i,r],o)=>{n(e[i],[t,s,r],l=>l[0]===t&&l[1]===s,o)},xl=n=>(e,t,s)=>{const i=[];for(let r=0;r<s.numberOfInputs;r+=1)i.push(new Set);n.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},wl=n=>(e,t)=>{n.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},rs=new WeakSet,sr=new WeakMap,vi=new WeakMap,nr=new WeakMap,_i=new WeakMap,yn=new WeakMap,ir=new WeakMap,ri=new WeakMap,oi=new WeakMap,ci=new WeakMap,ar={construct(){return ar}},Nl=n=>{try{const e=new Proxy(n,ar);new e}catch{return!1}return!0},xa=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,wa=(n,e)=>{const t=[];let s=n.replace(/^[\s]+/,""),i=s.match(xa);for(;i!==null;){const r=i[1].slice(1,-1),o=i[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,e).toString());t.push(o),s=s.slice(i[0].length).replace(/^[\s]+/,""),i=s.match(xa)}return[t.join(";"),s]},Na=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Sa=n=>{if(!Nl(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Sl=(n,e,t,s,i,r,o,l,c,u,h,d,g)=>{let f=0;return(m,p,_={credentials:"omit"})=>{const y=h.get(m);if(y!==void 0&&y.has(p))return Promise.resolve();const w=u.get(m);if(w!==void 0){const b=w.get(p);if(b!==void 0)return b}const S=r(m),E=S.audioWorklet===void 0?i(p).then(([b,T])=>{const[j,v]=wa(b,T),N=`${j};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${v}
})})(window,'_AWGS')`;return t(N)}).then(()=>{const b=g._AWGS.pop();if(b===void 0)throw new SyntaxError;s(S.currentTime,S.sampleRate,()=>b(class{},void 0,(T,j)=>{if(T.trim()==="")throw e();const v=oi.get(S);if(v!==void 0){if(v.has(T))throw e();Sa(j),Na(j.parameterDescriptors),v.set(T,j)}else Sa(j),Na(j.parameterDescriptors),oi.set(S,new Map([[T,j]]))},S.sampleRate,void 0,void 0))}):Promise.all([i(p),Promise.resolve(n(d,d))]).then(([[b,T],j])=>{const v=f+1;f=v;const[N,A]=wa(b,T),I=`${N};((AudioWorkletProcessor,registerProcessor)=>{${A}
})(${j?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${j?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${j?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${v}',class extends AudioWorkletProcessor{process(){return !1}})`,F=new Blob([I],{type:"application/javascript; charset=utf-8"}),V=URL.createObjectURL(F);return S.audioWorklet.addModule(V,_).then(()=>{if(l(S))return S;const O=o(S);return O.audioWorklet.addModule(V,_).then(()=>O)}).then(O=>{if(c===null)throw new SyntaxError;try{new c(O,`__sac${v}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(V))});return w===void 0?u.set(m,new Map([[p,E]])):w.set(p,E),E.then(()=>{const b=h.get(m);b===void 0?h.set(m,new Set([p])):b.add(p)}).finally(()=>{const b=u.get(m);b!==void 0&&b.delete(p)}),E}},it=(n,e)=>{const t=n.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},bn=(n,e)=>{const t=Array.from(n).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[s]=t;return n.delete(s),s},rr=(n,e,t,s)=>{const i=it(n,e),r=bn(i,o=>o[0]===t&&o[1]===s);return i.size===0&&n.delete(e),r},Es=n=>it(ir,n),os=n=>{if(rs.has(n))throw new Error("The AudioNode is already stored.");rs.add(n),Es(n).forEach(e=>e(!0))},or=n=>"port"in n,Is=n=>{if(!rs.has(n))throw new Error("The AudioNode is not stored.");rs.delete(n),Es(n).forEach(e=>e(!1))},li=(n,e)=>{!or(n)&&e.every(t=>t.size===0)&&Is(n)},Tl=(n,e,t,s,i,r,o,l,c,u,h,d,g)=>{const f=new WeakMap;return(m,p,_,y,w)=>{const{activeInputs:S,passiveInputs:E}=r(p),{outputs:b}=r(m),T=l(m),j=v=>{const N=c(p),A=c(m);if(v){const D=rr(E,m,_,y);n(S,m,D,!1),!w&&!d(m)&&t(A,N,_,y),g(p)&&os(p)}else{const D=s(S,m,_,y);e(E,y,D,!1),!w&&!d(m)&&i(A,N,_,y);const M=o(p);if(M===0)h(p)&&li(p,S);else{const P=f.get(p);P!==void 0&&clearTimeout(P),f.set(p,setTimeout(()=>{h(p)&&li(p,S)},M*1e3))}}};return u(b,[p,_,y],v=>v[0]===p&&v[1]===_&&v[2]===y,!0)?(T.add(j),h(m)?n(S,m,[_,y,j],!0):e(E,y,[m,_,j],!0),!0):!1}},jl=n=>(e,t,[s,i,r],o)=>{const l=e.get(s);l===void 0?e.set(s,new Set([[i,t,r]])):n(l,[i,t,r],c=>c[0]===i&&c[1]===t,o)},kl=n=>(e,t)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(s).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(s),s.disconnect()};t.addEventListener("ended",i)},Cl=n=>(e,t)=>{n(e).add(t)},Al={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},Ml=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=i(l),h={...Al,...c},d=s(u,h),g=r(u)?e():null;super(l,!1,d,g),this._nativeAnalyserNode=d}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(l){this._nativeAnalyserNode.fftSize=l}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(l){const c=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=l,!(l>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=c,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(l){const c=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=l,!(this._nativeAnalyserNode.maxDecibels>l))throw this._nativeAnalyserNode.minDecibels=c,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(l){this._nativeAnalyserNode.smoothingTimeConstant=l}getByteFrequencyData(l){this._nativeAnalyserNode.getByteFrequencyData(l)}getByteTimeDomainData(l){this._nativeAnalyserNode.getByteTimeDomainData(l)}getFloatFrequencyData(l){this._nativeAnalyserNode.getFloatFrequencyData(l)}getFloatTimeDomainData(l){this._nativeAnalyserNode.getFloatTimeDomainData(l)}},Le=(n,e)=>n.context===e,El=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,fftSize:l.fftSize,maxDecibels:l.maxDecibels,minDecibels:l.minDecibels,smoothingTimeConstant:l.smoothingTimeConstant};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(r,o)}}},an=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},pt=()=>new DOMException("","IndexSizeError"),yi=n=>{n.getChannelData=(e=>t=>{try{return e.call(n,t)}catch(s){throw s.code===12?pt():s}})(n.getChannelData)},Il={numberOfChannels:1},Dl=(n,e,t,s,i,r,o,l)=>{let c=null;return class cr{constructor(h){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:d,numberOfChannels:g,sampleRate:f}={...Il,...h};c===null&&(c=new i(1,1,44100));const m=s!==null&&e(r,r)?new s({length:d,numberOfChannels:g,sampleRate:f}):c.createBuffer(g,d,f);if(m.numberOfChannels===0)throw t();return typeof m.copyFromChannel!="function"?(o(m),yi(m)):e(an,()=>an(m))||l(m),n.add(m),m}static[Symbol.hasInstance](h){return h!==null&&typeof h=="object"&&Object.getPrototypeOf(h)===cr.prototype||n.has(h)}}},Ue=-34028234663852886e22,qe=-Ue,yt=n=>rs.has(n),Rl={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Ol=(n,e,t,s,i,r,o,l)=>class extends n{constructor(u,h){const d=r(u),g={...Rl,...h},f=i(d,g),m=o(d),p=m?e():null;super(u,!1,f,p),this._audioBufferSourceNodeRenderer=p,this._isBufferNullified=!1,this._isBufferSet=g.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,m,f.playbackRate,qe,Ue)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const h=typeof u=="function"?l(this,u):null;this._nativeAudioBufferSourceNode.onended=h;const d=this._nativeAudioBufferSourceNode.onended;this._onended=d!==null&&d===h?u:d}get playbackRate(){return this._playbackRate}start(u=0,h=0,d){if(this._nativeAudioBufferSourceNode.start(u,h,d),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=d===void 0?[u,h]:[u,h,d]),this.context.state!=="closed"){os(this);const g=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",g),yt(this)&&Is(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",g)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},Pl=(n,e,t,s,i)=>()=>{const r=new WeakMap;let o=null,l=null;const c=async(u,h)=>{let d=t(u);const g=Le(d,h);if(!g){const f={buffer:d.buffer,channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,loop:d.loop,loopEnd:d.loopEnd,loopStart:d.loopStart,playbackRate:d.playbackRate.value};d=e(h,f),o!==null&&d.start(...o),l!==null&&d.stop(l)}return r.set(h,d),g?await n(h,u.playbackRate,d.playbackRate):await s(h,u.playbackRate,d.playbackRate),await i(u,h,d),d};return{set start(u){o=u},set stop(u){l=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):c(u,h)}}},Fl=n=>"playbackRate"in n,Ll=n=>"frequency"in n&&"gain"in n,Vl=n=>"offset"in n,ql=n=>!("frequency"in n)&&"gain"in n,Wl=n=>"detune"in n&&"frequency"in n&&!("gain"in n),Bl=n=>"pan"in n,We=n=>it(sr,n),Ds=n=>it(nr,n),ui=(n,e)=>{const{activeInputs:t}=We(n);t.forEach(i=>i.forEach(([r])=>{e.includes(n)||ui(r,[...e,n])}));const s=Fl(n)?[n.playbackRate]:or(n)?Array.from(n.parameters.values()):Ll(n)?[n.Q,n.detune,n.frequency,n.gain]:Vl(n)?[n.offset]:ql(n)?[n.gain]:Wl(n)?[n.detune,n.frequency]:Bl(n)?[n.pan]:[];for(const i of s){const r=Ds(i);r!==void 0&&r.activeInputs.forEach(([o])=>ui(o,e))}yt(n)&&Is(n)},lr=n=>{ui(n.destination,[])},Ul=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),Gl=(n,e,t,s,i,r,o,l,c)=>class extends n{constructor(h={}){if(c===null)throw new Error("Missing the native AudioContext constructor.");let d;try{d=new c(h)}catch(m){throw m.code===12&&m.message==="sampleRate is not in range"?t():m}if(d===null)throw s();if(!Ul(h.latencyHint))throw new TypeError(`The provided value '${h.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(h.sampleRate!==void 0&&d.sampleRate!==h.sampleRate)throw t();super(d,2);const{latencyHint:g}=h,{sampleRate:f}=d;if(this._baseLatency=typeof d.baseLatency=="number"?d.baseLatency:g==="balanced"?512/f:g==="interactive"||g===void 0?256/f:g==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(g*f/128)))*128/f,this._nativeAudioContext=d,c.name==="webkitAudioContext"?(this._nativeGainNode=d.createGain(),this._nativeOscillatorNode=d.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(d.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,d.state==="running"){this._state="suspended";const m=()=>{this._state==="suspended"&&(this._state=null),d.removeEventListener("statechange",m)};d.addEventListener("statechange",m)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),lr(this)}))}createMediaElementSource(h){return new i(this,{mediaElement:h})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(h){return new o(this,{mediaStream:h})}createMediaStreamTrackSource(h){return new l(this,{mediaStreamTrack:h})}resume(){return this._state==="suspended"?new Promise((h,d)=>{const g=()=>{this._nativeAudioContext.removeEventListener("statechange",g),this._nativeAudioContext.state==="running"?h():this.resume().then(h,d)};this._nativeAudioContext.addEventListener("statechange",g)}):this._nativeAudioContext.resume().catch(h=>{throw h===void 0||h.code===15?e():h})}suspend(){return this._nativeAudioContext.suspend().catch(h=>{throw h===void 0?e():h})}},$l=(n,e,t,s,i,r,o,l)=>class extends n{constructor(u,h){const d=r(u),g=o(d),f=i(d,h,g),m=g?e(l):null;super(u,!1,f,m),this._isNodeOfNativeOfflineAudioContext=g,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},zl=n=>{const e=new WeakMap,t=async(s,i)=>{const r=i.destination;return e.set(i,r),await n(s,i,r),r};return{render(s,i){const r=e.get(i);return r!==void 0?Promise.resolve(r):t(s,i)}}},Yl=(n,e,t,s,i,r,o,l)=>(c,u)=>{const h=u.listener,d=()=>{const b=new Float32Array(1),T=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),j=o(u);let v=!1,N=[0,0,-1,0,1,0],A=[0,0,0];const D=()=>{if(v)return;v=!0;const F=s(u,256,9,0);F.onaudioprocess=({inputBuffer:V})=>{const O=[r(V,b,0),r(V,b,1),r(V,b,2),r(V,b,3),r(V,b,4),r(V,b,5)];O.some((Y,H)=>Y!==N[H])&&(h.setOrientation(...O),N=O);const G=[r(V,b,6),r(V,b,7),r(V,b,8)];G.some((Y,H)=>Y!==A[H])&&(h.setPosition(...G),A=G)},T.connect(F)},M=F=>V=>{V!==N[F]&&(N[F]=V,h.setOrientation(...N))},P=F=>V=>{V!==A[F]&&(A[F]=V,h.setPosition(...A))},I=(F,V,O)=>{const G=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:V});G.connect(T,0,F),G.start(),Object.defineProperty(G.offset,"defaultValue",{get(){return V}});const Y=n({context:c},j,G.offset,qe,Ue);return l(Y,"value",H=>()=>H.call(Y),H=>X=>{try{H.call(Y,X)}catch(ee){if(ee.code!==9)throw ee}D(),j&&O(X)}),Y.cancelAndHoldAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.cancelAndHoldAtTime),Y.cancelScheduledValues=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.cancelScheduledValues),Y.exponentialRampToValueAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.exponentialRampToValueAtTime),Y.linearRampToValueAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.linearRampToValueAtTime),Y.setTargetAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.setTargetAtTime),Y.setValueAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.setValueAtTime),Y.setValueCurveAtTime=(H=>j?()=>{throw i()}:(...X)=>{const ee=H.apply(Y,X);return D(),ee})(Y.setValueCurveAtTime),Y};return{forwardX:I(0,0,M(0)),forwardY:I(1,0,M(1)),forwardZ:I(2,-1,M(2)),positionX:I(6,0,P(0)),positionY:I(7,0,P(1)),positionZ:I(8,0,P(2)),upX:I(3,0,M(3)),upY:I(4,1,M(4)),upZ:I(5,0,M(5))}},{forwardX:g,forwardY:f,forwardZ:m,positionX:p,positionY:_,positionZ:y,upX:w,upY:S,upZ:E}=h.forwardX===void 0?d():h;return{get forwardX(){return g},get forwardY(){return f},get forwardZ(){return m},get positionX(){return p},get positionY(){return _},get positionZ(){return y},get upX(){return w},get upY(){return S},get upZ(){return E}}},rn=n=>"context"in n,Rs=n=>rn(n[0]),Xt=(n,e,t,s)=>{for(const i of n)if(t(i)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(e),!0},Ta=(n,e,[t,s],i)=>{Xt(n,[e,t,s],r=>r[0]===e&&r[1]===t,i)},ja=(n,[e,t,s],i)=>{const r=n.get(e);r===void 0?n.set(e,new Set([[t,s]])):Xt(r,[t,s],o=>o[0]===t,i)},ps=n=>"inputs"in n,on=(n,e,t,s)=>{if(ps(e)){const i=e.inputs[s];return n.connect(i,t,0),[i,t,0]}return n.connect(e,t,s),[e,t,s]},ur=(n,e,t)=>{for(const s of n)if(s[0]===e&&s[1]===t)return n.delete(s),s;return null},Hl=(n,e,t)=>bn(n,s=>s[0]===e&&s[1]===t),hr=(n,e)=>{if(!Es(n).delete(e))throw new Error("Missing the expected event listener.")},dr=(n,e,t)=>{const s=it(n,e),i=bn(s,r=>r[0]===t);return s.size===0&&n.delete(e),i},cn=(n,e,t,s)=>{ps(e)?n.disconnect(e.inputs[s],t,0):n.disconnect(e,t,s)},de=n=>it(vi,n),Ts=n=>it(_i,n),$t=n=>ri.has(n),Zs=n=>!rs.has(n),ka=(n,e)=>new Promise(t=>{if(e!==null)t(!0);else{const s=n.createScriptProcessor(256,1,1),i=n.createGain(),r=n.createBuffer(1,2,44100),o=r.getChannelData(0);o[0]=1,o[1]=1;const l=n.createBufferSource();l.buffer=r,l.loop=!0,l.connect(s).connect(n.destination),l.connect(i),l.disconnect(i),s.onaudioprocess=c=>{const u=c.inputBuffer.getChannelData(0);Array.prototype.some.call(u,h=>h===1)?t(!0):t(!1),l.stop(),s.onaudioprocess=null,l.disconnect(s),s.disconnect(n.destination)},l.start()}}),Jn=(n,e)=>{const t=new Map;for(const s of n)for(const i of s){const r=t.get(i);t.set(i,r===void 0?1:r+1)}t.forEach((s,i)=>e(i,s))},ln=n=>"context"in n,Xl=n=>{const e=new Map;n.connect=(t=>(s,i=0,r=0)=>{const o=ln(s)?t(s,i,r):t(s,i),l=e.get(s);return l===void 0?e.set(s,[{input:r,output:i}]):l.every(c=>c.input!==r||c.output!==i)&&l.push({input:r,output:i}),o})(n.connect.bind(n)),n.disconnect=(t=>(s,i,r)=>{if(t.apply(n),s===void 0)e.clear();else if(typeof s=="number")for(const[o,l]of e){const c=l.filter(u=>u.output!==s);c.length===0?e.delete(o):e.set(o,c)}else if(e.has(s))if(i===void 0)e.delete(s);else{const o=e.get(s);if(o!==void 0){const l=o.filter(c=>c.output!==i&&(c.input!==r||r===void 0));l.length===0?e.delete(s):e.set(s,l)}}for(const[o,l]of e)l.forEach(c=>{ln(o)?n.connect(o,c.output,c.input):n.connect(o,c.output)})})(n.disconnect)},Jl=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:r}=Ds(e),{outputs:o}=We(n),l=Es(n),c=u=>{const h=de(n),d=Ts(e);if(u){const g=dr(r,n,t);Ta(i,n,g,!1),!s&&!$t(n)&&h.connect(d,t)}else{const g=Hl(i,n,t);ja(r,g,!1),!s&&!$t(n)&&h.disconnect(d,t)}};return Xt(o,[e,t],u=>u[0]===e&&u[1]===t,!0)?(l.add(c),yt(n)?Ta(i,n,[t,c],!0):ja(r,[n,t,c],!0),!0):!1},Zl=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:r}=We(e),o=ur(i[s],n,t);return o===null?[rr(r,n,t,s)[2],!1]:[o[2],!0]},Kl=(n,e,t)=>{const{activeInputs:s,passiveInputs:i}=Ds(e),r=ur(s,n,t);return r===null?[dr(i,n,t)[1],!1]:[r[2],!0]},bi=(n,e,t,s,i)=>{const[r,o]=Zl(n,t,s,i);if(r!==null&&(hr(n,r),o&&!e&&!$t(n)&&cn(de(n),de(t),s,i)),yt(t)){const{activeInputs:l}=We(t);li(t,l)}},xi=(n,e,t,s)=>{const[i,r]=Kl(n,t,s);i!==null&&(hr(n,i),r&&!e&&!$t(n)&&de(n).disconnect(Ts(t),s))},Ql=(n,e)=>{const t=We(n),s=[];for(const i of t.outputs)Rs(i)?bi(n,e,...i):xi(n,e,...i),s.push(i[0]);return t.outputs.clear(),s},eu=(n,e,t)=>{const s=We(n),i=[];for(const r of s.outputs)r[1]===t&&(Rs(r)?bi(n,e,...r):xi(n,e,...r),i.push(r[0]),s.outputs.delete(r));return i},tu=(n,e,t,s,i)=>{const r=We(n);return Array.from(r.outputs).filter(o=>o[0]===t&&(s===void 0||o[1]===s)&&(i===void 0||o[2]===i)).map(o=>(Rs(o)?bi(n,e,...o):xi(n,e,...o),r.outputs.delete(o),o[0]))},su=(n,e,t,s,i,r,o,l,c,u,h,d,g,f,m,p)=>class extends u{constructor(y,w,S,E){super(S),this._context=y,this._nativeAudioNode=S;const b=h(y);d(b)&&t(ka,()=>ka(b,p))!==!0&&Xl(S),vi.set(this,S),ir.set(this,new Set),y.state!=="closed"&&w&&os(this),n(this,E,S)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(y){this._nativeAudioNode.channelCount=y}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(y){this._nativeAudioNode.channelCountMode=y}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(y){this._nativeAudioNode.channelInterpretation=y}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(y,w=0,S=0){if(w<0||w>=this._nativeAudioNode.numberOfOutputs)throw i();const E=h(this._context),b=m(E);if(g(y)||f(y))throw r();if(rn(y)){const v=de(y);try{const A=on(this._nativeAudioNode,v,w,S),D=Zs(this);(b||D)&&this._nativeAudioNode.disconnect(...A),this.context.state!=="closed"&&!D&&Zs(y)&&os(y)}catch(A){throw A.code===12?r():A}if(e(this,y,w,S,b)){const A=c([this],y);Jn(A,s(b))}return y}const T=Ts(y);if(T.name==="playbackRate"&&T.maxValue===1024)throw o();try{this._nativeAudioNode.connect(T,w),(b||Zs(this))&&this._nativeAudioNode.disconnect(T,w)}catch(v){throw v.code===12?r():v}if(Jl(this,y,w,b)){const v=c([this],y);Jn(v,s(b))}}disconnect(y,w,S){let E;const b=h(this._context),T=m(b);if(y===void 0)E=Ql(this,T);else if(typeof y=="number"){if(y<0||y>=this.numberOfOutputs)throw i();E=eu(this,T,y)}else{if(w!==void 0&&(w<0||w>=this.numberOfOutputs)||rn(y)&&S!==void 0&&(S<0||S>=y.numberOfInputs))throw i();if(E=tu(this,T,y,w,S),E.length===0)throw r()}for(const j of E){const v=c([this],j);Jn(v,l)}}},nu=(n,e,t,s,i,r,o,l,c,u,h,d,g)=>(f,m,p,_=null,y=null)=>{const w=p.value,S=new ml(w),E=m?s(S):null,b={get defaultValue(){return w},get maxValue(){return _===null?p.maxValue:_},get minValue(){return y===null?p.minValue:y},get value(){return p.value},set value(T){p.value=T,b.setValueAtTime(T,f.context.currentTime)},cancelAndHoldAtTime(T){if(typeof p.cancelAndHoldAtTime=="function")E===null&&S.flush(f.context.currentTime),S.add(i(T)),p.cancelAndHoldAtTime(T);else{const j=Array.from(S).pop();E===null&&S.flush(f.context.currentTime),S.add(i(T));const v=Array.from(S).pop();p.cancelScheduledValues(T),j!==v&&v!==void 0&&(v.type==="exponentialRampToValue"?p.exponentialRampToValueAtTime(v.value,v.endTime):v.type==="linearRampToValue"?p.linearRampToValueAtTime(v.value,v.endTime):v.type==="setValue"?p.setValueAtTime(v.value,v.startTime):v.type==="setValueCurve"&&p.setValueCurveAtTime(v.values,v.startTime,v.duration))}return b},cancelScheduledValues(T){return E===null&&S.flush(f.context.currentTime),S.add(r(T)),p.cancelScheduledValues(T),b},exponentialRampToValueAtTime(T,j){if(T===0)throw new RangeError;if(!Number.isFinite(j)||j<0)throw new RangeError;const v=f.context.currentTime;return E===null&&S.flush(v),Array.from(S).length===0&&(S.add(u(w,v)),p.setValueAtTime(w,v)),S.add(o(T,j)),p.exponentialRampToValueAtTime(T,j),b},linearRampToValueAtTime(T,j){const v=f.context.currentTime;return E===null&&S.flush(v),Array.from(S).length===0&&(S.add(u(w,v)),p.setValueAtTime(w,v)),S.add(l(T,j)),p.linearRampToValueAtTime(T,j),b},setTargetAtTime(T,j,v){return E===null&&S.flush(f.context.currentTime),S.add(c(T,j,v)),p.setTargetAtTime(T,j,v),b},setValueAtTime(T,j){return E===null&&S.flush(f.context.currentTime),S.add(u(T,j)),p.setValueAtTime(T,j),b},setValueCurveAtTime(T,j,v){const N=T instanceof Float32Array?T:new Float32Array(T);if(d!==null&&d.name==="webkitAudioContext"){const A=j+v,D=f.context.sampleRate,M=Math.ceil(j*D),P=Math.floor(A*D),I=P-M,F=new Float32Array(I);for(let O=0;O<I;O+=1){const G=(N.length-1)/v*((M+O)/D-j),Y=Math.floor(G),H=Math.ceil(G);F[O]=Y===H?N[Y]:(1-(G-Y))*N[Y]+(1-(H-G))*N[H]}E===null&&S.flush(f.context.currentTime),S.add(h(F,j,v)),p.setValueCurveAtTime(F,j,v);const V=P/D;V<A&&g(b,F[F.length-1],V),g(b,N[N.length-1],A)}else E===null&&S.flush(f.context.currentTime),S.add(h(N,j,v)),p.setValueCurveAtTime(N,j,v);return b}};return t.set(b,p),e.set(b,f),n(b,E),b},iu=n=>({replay(e){for(const t of n)if(t.type==="exponentialRampToValue"){const{endTime:s,value:i}=t;e.exponentialRampToValueAtTime(i,s)}else if(t.type==="linearRampToValue"){const{endTime:s,value:i}=t;e.linearRampToValueAtTime(i,s)}else if(t.type==="setTarget"){const{startTime:s,target:i,timeConstant:r}=t;e.setTargetAtTime(i,s,r)}else if(t.type==="setValue"){const{startTime:s,value:i}=t;e.setValueAtTime(i,s)}else if(t.type==="setValueCurve"){const{duration:s,startTime:i,values:r}=t;e.setValueCurveAtTime(r,i,s)}else throw new Error("Can't apply an unknown automation.")}});class mr{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((s,i)=>e.call(t,s,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const au={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},ru=(n,e,t,s,i,r,o,l,c,u,h,d,g,f)=>class extends e{constructor(p,_,y){var w;const S=l(p),E=c(S),b=h({...au,...y});g(b);const T=oi.get(S),j=T?.get(_),v=E||S.state!=="closed"?S:(w=o(S))!==null&&w!==void 0?w:S,N=i(v,E?null:p.baseLatency,u,_,j,b),A=E?s(_,b,j):null;super(p,!0,N,A);const D=[];N.parameters.forEach((P,I)=>{const F=t(this,E,P);D.push([I,F])}),this._nativeAudioWorkletNode=N,this._onprocessorerror=null,this._parameters=new mr(D),E&&n(S,this);const{activeInputs:M}=r(this);d(N,M)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(p){const _=typeof p=="function"?f(this,p):null;this._nativeAudioWorkletNode.onprocessorerror=_;const y=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=y!==null&&y===_?p:y}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function un(n,e,t,s,i){if(typeof n.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),n.copyFromChannel(e[t],s,i);else{const r=n.getChannelData(s);if(e[t].byteLength===0)e[t]=r.slice(i,i+128);else{const o=new Float32Array(r.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(o)}}}const pr=(n,e,t,s,i)=>{typeof n.copyToChannel=="function"?e[t].byteLength!==0&&n.copyToChannel(e[t],s,i):e[t].byteLength!==0&&n.getChannelData(s).set(e[t],i)},hn=(n,e)=>{const t=[];for(let s=0;s<n;s+=1){const i=[],r=typeof e=="number"?e:e[s];for(let o=0;o<r;o+=1)i.push(new Float32Array(128));t.push(i)}return t},ou=(n,e)=>{const t=it(ci,n),s=de(e);return it(t,s)},cu=async(n,e,t,s,i,r,o)=>{const l=e===null?Math.ceil(n.context.length/128)*128:e.length,c=s.channelCount*s.numberOfInputs,u=i.reduce((_,y)=>_+y,0),h=u===0?null:t.createBuffer(u,l,t.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const d=We(n),g=await ou(t,n),f=hn(s.numberOfInputs,s.channelCount),m=hn(s.numberOfOutputs,i),p=Array.from(n.parameters.keys()).reduce((_,y)=>({..._,[y]:new Float32Array(128)}),{});for(let _=0;_<l;_+=128){if(s.numberOfInputs>0&&e!==null)for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<s.channelCount;w+=1)un(e,f[y],w,w,_);r.parameterDescriptors!==void 0&&e!==null&&r.parameterDescriptors.forEach(({name:y},w)=>{un(e,p,y,c+w,_)});for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<i[y];w+=1)m[y][w].byteLength===0&&(m[y][w]=new Float32Array(128));try{const y=f.map((S,E)=>d.activeInputs[E].size===0?[]:S),w=o(_/t.sampleRate,t.sampleRate,()=>g.process(y,m,p));if(h!==null)for(let S=0,E=0;S<s.numberOfOutputs;S+=1){for(let b=0;b<i[S];b+=1)pr(h,m[S],b,E+b,_);E+=i[S]}if(!w)break}catch(y){n.dispatchEvent(new ErrorEvent("processorerror",{colno:y.colno,filename:y.filename,lineno:y.lineno,message:y.message}));break}}return h},lu=(n,e,t,s,i,r,o,l,c,u,h,d,g,f,m,p)=>(_,y,w)=>{const S=new WeakMap;let E=null;const b=async(T,j)=>{let v=h(T),N=null;const A=Le(v,j),D=Array.isArray(y.outputChannelCount)?y.outputChannelCount:Array.from(y.outputChannelCount);if(d===null){const M=D.reduce((V,O)=>V+O,0),P=i(j,{channelCount:Math.max(1,M),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,M)}),I=[];for(let V=0;V<T.numberOfOutputs;V+=1)I.push(s(j,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:D[V]}));const F=o(j,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1});F.connect=e.bind(null,I),F.disconnect=c.bind(null,I),N=[P,I,F]}else A||(v=new d(j,_));if(S.set(j,N===null?v:N[2]),N!==null){if(E===null){if(w===void 0)throw new Error("Missing the processor constructor.");if(g===null)throw new Error("Missing the native OfflineAudioContext constructor.");const O=T.channelCount*T.numberOfInputs,G=w.parameterDescriptors===void 0?0:w.parameterDescriptors.length,Y=O+G;E=cu(T,Y===0?null:await(async()=>{const X=new g(Y,Math.ceil(T.context.length/128)*128,j.sampleRate),ee=[],U=[];for(let C=0;C<y.numberOfInputs;C+=1)ee.push(o(X,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1})),U.push(i(X,{channelCount:y.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:y.channelCount}));const Q=await Promise.all(Array.from(T.parameters.values()).map(async C=>{const R=r(X,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:C.value});return await f(X,C,R.offset),R})),B=s(X,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,O+G)});for(let C=0;C<y.numberOfInputs;C+=1){ee[C].connect(U[C]);for(let R=0;R<y.channelCount;R+=1)U[C].connect(B,R,C*y.channelCount+R)}for(const[C,R]of Q.entries())R.connect(B,0,O+C),R.start(0);return B.connect(X.destination),await Promise.all(ee.map(C=>m(T,X,C))),p(X)})(),j,y,D,w,u)}const M=await E,P=t(j,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[I,F,V]=N;M!==null&&(P.buffer=M,P.start(0)),P.connect(I);for(let O=0,G=0;O<T.numberOfOutputs;O+=1){const Y=F[O];for(let H=0;H<D[O];H+=1)I.connect(Y,G+H,H);G+=D[O]}return V}if(A)for(const[M,P]of T.parameters.entries())await n(j,P,v.parameters.get(M));else for(const[M,P]of T.parameters.entries())await f(j,P,v.parameters.get(M));return await m(T,j,v),v};return{render(T,j){l(j,T);const v=S.get(j);return v!==void 0?Promise.resolve(v):b(T,j)}}},uu=(n,e,t,s,i,r,o,l,c,u,h,d,g,f,m,p,_,y,w,S)=>class extends m{constructor(b,T){super(b,T),this._nativeContext=b,this._audioWorklet=n===void 0?void 0:{addModule:(j,v)=>n(this,j,v)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new i(this)}createBuffer(b,T,j){return new t({length:T,numberOfChannels:b,sampleRate:j})}createBufferSource(){return new s(this)}createChannelMerger(b=6){return new r(this,{numberOfInputs:b})}createChannelSplitter(b=6){return new o(this,{numberOfOutputs:b})}createConstantSource(){return new l(this)}createConvolver(){return new c(this)}createDelay(b=1){return new h(this,{maxDelayTime:b})}createDynamicsCompressor(){return new d(this)}createGain(){return new g(this)}createIIRFilter(b,T){return new f(this,{feedback:T,feedforward:b})}createOscillator(){return new p(this)}createPanner(){return new _(this)}createPeriodicWave(b,T,j={disableNormalization:!1}){return new y(this,{...j,imag:T,real:b})}createStereoPanner(){return new w(this)}createWaveShaper(){return new S(this)}decodeAudioData(b,T,j){return u(this._nativeContext,b).then(v=>(typeof T=="function"&&T(v),v),v=>{throw typeof j=="function"&&j(v),v})}},hu={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},du=(n,e,t,s,i,r,o,l)=>class extends n{constructor(u,h){const d=r(u),g={...hu,...h},f=i(d,g),m=o(d),p=m?t():null;super(u,!1,f,p),this._Q=e(this,m,f.Q,qe,Ue),this._detune=e(this,m,f.detune,1200*Math.log2(qe),-1200*Math.log2(qe)),this._frequency=e(this,m,f.frequency,u.sampleRate/2,0),this._gain=e(this,m,f.gain,40*Math.log10(qe),Ue),this._nativeBiquadFilterNode=f,l(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,h,d){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,h,d)}catch(g){throw g.code===11?s():g}if(u.length!==h.length||h.length!==d.length)throw s()}},mu=(n,e,t,s,i)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const h=Le(u,c);if(!h){const d={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(c,d)}return r.set(c,u),h?(await n(c,l.Q,u.Q),await n(c,l.detune,u.detune),await n(c,l.frequency,u.frequency),await n(c,l.gain,u.gain)):(await s(c,l.Q,u.Q),await s(c,l.detune,u.detune),await s(c,l.frequency,u.frequency),await s(c,l.gain,u.gain)),await i(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},pu=(n,e)=>(t,s)=>{const i=e.get(t);if(i!==void 0)return i;const r=n.get(t);if(r!==void 0)return r;try{const o=s();return o instanceof Promise?(n.set(t,o),o.catch(()=>!1).then(l=>(n.delete(t),e.set(t,l),l))):(e.set(t,o),o)}catch{return e.set(t,!1),!1}},fu={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},gu=(n,e,t,s,i)=>class extends n{constructor(o,l){const c=s(o),u={...fu,...l},h=t(c,u),d=i(c)?e():null;super(o,!1,h,d)}},vu=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfInputs:l.numberOfInputs};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(r,o)}}},_u={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},yu=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=s(l),h=r({..._u,...c}),d=t(u,h),g=i(u)?e():null;super(l,!1,d,g)}},bu=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfOutputs:l.numberOfOutputs};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(r,o)}}},xu=n=>(e,t,s)=>n(t,e,s),wu=n=>(e,t,s=0,i=0)=>{const r=e[s];if(r===void 0)throw n();return ln(t)?r.connect(t,0,i):r.connect(t,0)},Nu=n=>(e,t)=>{const s=n(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return s.buffer=i,s.loop=!0,s.connect(t),s.start(),()=>{s.stop(),s.disconnect(t)}},Su={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Tu=(n,e,t,s,i,r,o)=>class extends n{constructor(c,u){const h=i(c),d={...Su,...u},g=s(h,d),f=r(h),m=f?t():null;super(c,!1,g,m),this._constantSourceNodeRenderer=m,this._nativeConstantSourceNode=g,this._offset=e(this,f,g.offset,qe,Ue),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeConstantSourceNode.onended=u;const h=this._nativeConstantSourceNode.onended;this._onended=h!==null&&h===u?c:h}start(c=0){if(this._nativeConstantSourceNode.start(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=c),this.context.state!=="closed"){os(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),yt(this)&&Is(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(c=0){this._nativeConstantSourceNode.stop(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=c)}},ju=(n,e,t,s,i)=>()=>{const r=new WeakMap;let o=null,l=null;const c=async(u,h)=>{let d=t(u);const g=Le(d,h);if(!g){const f={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,offset:d.offset.value};d=e(h,f),o!==null&&d.start(o),l!==null&&d.stop(l)}return r.set(h,d),g?await n(h,u.offset,d.offset):await s(h,u.offset,d.offset),await i(u,h,d),d};return{set start(u){o=u},set stop(u){l=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):c(u,h)}}},ku=n=>e=>(n[0]=e,n[0]),Cu={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Au=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=s(l),h={...Cu,...c},d=t(u,h),f=i(u)?e():null;super(l,!1,d,f),this._isBufferNullified=!1,this._nativeConvolverNode=d,h.buffer!==null&&r(this,h.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(l){if(this._nativeConvolverNode.buffer=l,l===null&&this._nativeConvolverNode.buffer!==null){const c=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=c.createBuffer(1,1,c.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(l){this._nativeConvolverNode.normalize=l}},Mu=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={buffer:l.buffer,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,disableNormalization:!l.normalize};l=n(o,u)}return s.set(o,l),ps(l)?await t(r,o,l.inputs[0]):await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(r,o)}}},Eu=(n,e)=>(t,s,i)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,s,i)}catch(r){throw r.name==="SyntaxError"?n():r}},Iu=()=>new DOMException("","DataCloneError"),Ca=n=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(s=>{const i=()=>{t.onmessage=null,e.close(),t.close(),s()};t.onmessage=()=>i();try{e.postMessage(n,[n])}catch{}finally{i()}})},Du=(n,e,t,s,i,r,o,l,c,u,h)=>(d,g)=>{const f=o(d)?d:r(d);if(i.has(g)){const m=t();return Promise.reject(m)}try{i.add(g)}catch{}return e(c,()=>c(f))?f.decodeAudioData(g).then(m=>(Ca(g).catch(()=>{}),e(l,()=>l(m))||h(m),n.add(m),m)):new Promise((m,p)=>{const _=async()=>{try{await Ca(g)}catch{}},y=w=>{p(w),_()};try{f.decodeAudioData(g,w=>{typeof w.copyFromChannel!="function"&&(u(w),yi(w)),n.add(w),_().then(()=>m(w))},w=>{y(w===null?s():w)})}catch(w){y(w)}})},Ru=(n,e,t,s,i,r,o,l)=>(c,u)=>{const h=e.get(c);if(h===void 0)throw new Error("Missing the expected cycle count.");const d=r(c.context),g=l(d);if(h===u){if(e.delete(c),!g&&o(c)){const f=s(c),{outputs:m}=t(c);for(const p of m)if(Rs(p)){const _=s(p[0]);n(f,_,p[1],p[2])}else{const _=i(p[0]);f.connect(_,p[1])}}}else e.set(c,h-u)},Ou={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Pu=(n,e,t,s,i,r,o)=>class extends n{constructor(c,u){const h=i(c),d={...Ou,...u},g=s(h,d),f=r(h),m=f?t(d.maxDelayTime):null;super(c,!1,g,m),this._delayTime=e(this,f,g.delayTime),o(this,d.maxDelayTime)}get delayTime(){return this._delayTime}},Fu=(n,e,t,s,i)=>r=>{const o=new WeakMap,l=async(c,u)=>{let h=t(c);const d=Le(h,u);if(!d){const g={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,delayTime:h.delayTime.value,maxDelayTime:r};h=e(u,g)}return o.set(u,h),d?await n(u,c.delayTime,h.delayTime):await s(u,c.delayTime,h.delayTime),await i(c,u,h),h};return{render(c,u){const h=o.get(u);return h!==void 0?Promise.resolve(h):l(c,u)}}},Lu=n=>(e,t,s,i)=>n(e[i],r=>r[0]===t&&r[1]===s),Vu=n=>(e,t)=>{n(e).delete(t)},qu=n=>"delayTime"in n,Wu=(n,e,t)=>function s(i,r){const o=rn(r)?r:t(n,r);if(qu(o))return[];if(i[0]===o)return[i];if(i.includes(o))return[];const{outputs:l}=e(o);return Array.from(l).map(c=>s([...i,o],c[0])).reduce((c,u)=>c.concat(u),[])},Ys=(n,e,t)=>{const s=e[t];if(s===void 0)throw n();return s},Bu=n=>(e,t=void 0,s=void 0,i=0)=>t===void 0?e.forEach(r=>r.disconnect()):typeof t=="number"?Ys(n,e,t).disconnect():ln(t)?s===void 0?e.forEach(r=>r.disconnect(t)):i===void 0?Ys(n,e,s).disconnect(t,0):Ys(n,e,s).disconnect(t,0,i):s===void 0?e.forEach(r=>r.disconnect(t)):Ys(n,e,s).disconnect(t,0),Uu={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Gu=(n,e,t,s,i,r,o,l)=>class extends n{constructor(u,h){const d=r(u),g={...Uu,...h},f=s(d,g),m=o(d),p=m?t():null;super(u,!1,f,p),this._attack=e(this,m,f.attack),this._knee=e(this,m,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,m,f.ratio),this._release=e(this,m,f.release),this._threshold=e(this,m,f.threshold),l(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const h=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=h,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const h=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=h,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},$u=(n,e,t,s,i)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const h=Le(u,c);if(!h){const d={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(c,d)}return r.set(c,u),h?(await n(c,l.attack,u.attack),await n(c,l.knee,u.knee),await n(c,l.ratio,u.ratio),await n(c,l.release,u.release),await n(c,l.threshold,u.threshold)):(await s(c,l.attack,u.attack),await s(c,l.knee,u.knee),await s(c,l.ratio,u.ratio),await s(c,l.release,u.release),await s(c,l.threshold,u.threshold)),await i(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},zu=()=>new DOMException("","EncodingError"),Yu=n=>e=>new Promise((t,s)=>{if(n===null){s(new SyntaxError);return}const i=n.document.head;if(i===null)s(new SyntaxError);else{const r=n.document.createElement("script"),o=new Blob([e],{type:"application/javascript"}),l=URL.createObjectURL(o),c=n.onerror,u=()=>{n.onerror=c,URL.revokeObjectURL(l)};n.onerror=(h,d,g,f,m)=>{if(d===l||d===n.location.href&&g===1&&f===1)return u(),s(m),!1;if(c!==null)return c(h,d,g,f,m)},r.onerror=()=>{u(),s(new SyntaxError)},r.onload=()=>{u(),t()},r.src=l,r.type="module",i.appendChild(r)}}),Hu=n=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,s,i){if(s!==null){let r=this._listeners.get(s);r===void 0&&(r=n(this,s),typeof s=="function"&&this._listeners.set(s,r)),this._nativeEventTarget.addEventListener(t,r,i)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,s,i){const r=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(t,r===void 0?null:r,i)}},Xu=n=>(e,t,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},Ju=n=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw n()},Zu={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Ku=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=i(l),h={...Zu,...c},d=s(u,h),g=r(u),f=g?t():null;super(l,!1,d,f),this._gain=e(this,g,d.gain,qe,Ue)}get gain(){return this._gain}},Qu=(n,e,t,s,i)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const h=Le(u,c);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(c,d)}return r.set(c,u),h?await n(c,l.gain,u.gain):await s(c,l.gain,u.gain),await i(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},eh=(n,e)=>t=>e(n,t),th=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},sh=n=>e=>{var t;return(t=n.get(e))!==null&&t!==void 0?t:0},nh=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},ih=n=>e=>n.get(e),De=()=>new DOMException("","InvalidStateError"),ah=n=>e=>{const t=n.get(e);if(t===void 0)throw De();return t},rh=(n,e)=>t=>{let s=n.get(t);if(s!==void 0)return s;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new e(1,1,44100),n.set(t,s),s},oh=n=>e=>{const t=n.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},xn=()=>new DOMException("","InvalidAccessError"),ch=n=>{n.getFrequencyResponse=(e=>(t,s,i)=>{if(t.length!==s.length||s.length!==i.length)throw xn();return e.call(n,t,s,i)})(n.getFrequencyResponse)},lh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},uh=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=s(l),h=i(u),d={...lh,...c},g=e(u,h?null:l.baseLatency,d),f=h?t(d.feedback,d.feedforward):null;super(l,!1,g,f),ch(g),this._nativeIIRFilterNode=g,r(this,1)}getFrequencyResponse(l,c,u){return this._nativeIIRFilterNode.getFrequencyResponse(l,c,u)}},fr=(n,e,t,s,i,r,o,l,c,u,h)=>{const d=u.length;let g=l;for(let f=0;f<d;f+=1){let m=t[0]*u[f];for(let p=1;p<i;p+=1){const _=g-p&c-1;m+=t[p]*r[_],m-=n[p]*o[_]}for(let p=i;p<s;p+=1)m+=t[p]*r[g-p&c-1];for(let p=i;p<e;p+=1)m-=n[p]*o[g-p&c-1];r[g]=u[f],o[g]=m,g=g+1&c-1,h[f]=m}return g},hh=(n,e,t,s)=>{const i=t instanceof Float64Array?t:new Float64Array(t),r=s instanceof Float64Array?s:new Float64Array(s),o=i.length,l=r.length,c=Math.min(o,l);if(i[0]!==1){for(let m=0;m<o;m+=1)r[m]/=i[0];for(let m=1;m<l;m+=1)i[m]/=i[0]}const u=32,h=new Float32Array(u),d=new Float32Array(u),g=e.createBuffer(n.numberOfChannels,n.length,n.sampleRate),f=n.numberOfChannels;for(let m=0;m<f;m+=1){const p=n.getChannelData(m),_=g.getChannelData(m);h.fill(0),d.fill(0),fr(i,o,r,l,c,h,d,0,u,p,_)}return g},dh=(n,e,t,s,i)=>(r,o)=>{const l=new WeakMap;let c=null;const u=async(h,d)=>{let g=null,f=e(h);const m=Le(f,d);if(d.createIIRFilter===void 0?g=n(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):m||(f=d.createIIRFilter(o,r)),l.set(d,g===null?f:g),g!==null){if(c===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const _=new t(h.context.destination.channelCount,h.context.length,d.sampleRate);c=(async()=>{await s(h,_,_.destination);const y=await i(_);return hh(y,d,r,o)})()}const p=await c;return g.buffer=p,g.start(0),g}return await s(h,d,f),f};return{render(h,d){const g=l.get(d);return g!==void 0?Promise.resolve(g):u(h,d)}}},mh=(n,e,t,s,i,r)=>o=>(l,c)=>{const u=n.get(l);if(u===void 0){if(!o&&r(l)){const h=s(l),{outputs:d}=t(l);for(const g of d)if(Rs(g)){const f=s(g[0]);e(h,f,g[1],g[2])}else{const f=i(g[0]);h.disconnect(f,g[1])}}n.set(l,c)}else n.set(l,u+c)},ph=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},fh=(n,e)=>t=>n.has(t)||e(t),gh=(n,e)=>t=>n.has(t)||e(t),vh=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},_h=n=>e=>n!==null&&e instanceof n,yh=n=>e=>n!==null&&typeof n.AudioNode=="function"&&e instanceof n.AudioNode,bh=n=>e=>n!==null&&typeof n.AudioParam=="function"&&e instanceof n.AudioParam,xh=(n,e)=>t=>n(t)||e(t),wh=n=>e=>n!==null&&e instanceof n,Nh=n=>n!==null&&n.isSecureContext,Sh=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r),c=e(l,o);if(s(l))throw TypeError();super(r,!0,c,null),this._nativeMediaElementAudioSourceNode=c}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},Th={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},jh=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r);if(s(l))throw new TypeError;const c={...Th,...o},u=e(l,c);super(r,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},kh=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r),c=e(l,o);if(s(l))throw new TypeError;super(r,!0,c,null),this._nativeMediaStreamAudioSourceNode=c}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},Ch=(n,e,t)=>class extends n{constructor(i,r){const o=t(i),l=e(o,r);super(i,!0,l,null)}},Ah=(n,e,t,s,i,r)=>class extends t{constructor(l,c){super(l),this._nativeContext=l,yn.set(this,l),s(l)&&i.set(l,new Set),this._destination=new n(this,c),this._listener=e(this,l),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(l){const c=typeof l=="function"?r(this,l):null;this._nativeContext.onstatechange=c;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===c?l:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},js=n=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=n.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},Mh=(n,e)=>(t,s,i)=>{const r=new Set;return t.connect=(o=>(l,c=0,u=0)=>{const h=r.size===0;if(e(l))return o.call(t,l,c,u),n(r,[l,c,u],d=>d[0]===l&&d[1]===c&&d[2]===u,!0),h&&s(),l;o.call(t,l,c),n(r,[l,c],d=>d[0]===l&&d[1]===c,!0),h&&s()})(t.connect),t.disconnect=(o=>(l,c,u)=>{const h=r.size>0;if(l===void 0)o.apply(t),r.clear();else if(typeof l=="number"){o.call(t,l);for(const g of r)g[1]===l&&r.delete(g)}else{e(l)?o.call(t,l,c,u):o.call(t,l,c);for(const g of r)g[0]===l&&(c===void 0||g[1]===c)&&(u===void 0||g[2]===u)&&r.delete(g)}const d=r.size===0;h&&d&&i()})(t.disconnect),t},ge=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t]&&(n[t]=s)},Me=(n,e)=>{ge(n,e,"channelCount"),ge(n,e,"channelCountMode"),ge(n,e,"channelInterpretation")},Aa=n=>typeof n.getFloatTimeDomainData=="function",Eh=n=>{n.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);n.getByteTimeDomainData(t);const s=Math.max(t.length,n.fftSize);for(let i=0;i<s;i+=1)e[i]=(t[i]-128)*.0078125;return e}},Ih=(n,e)=>(t,s)=>{const i=t.createAnalyser();if(Me(i,s),!(s.maxDecibels>s.minDecibels))throw e();return ge(i,s,"fftSize"),ge(i,s,"maxDecibels"),ge(i,s,"minDecibels"),ge(i,s,"smoothingTimeConstant"),n(Aa,()=>Aa(i))||Eh(i),i},Dh=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,xe=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t].value&&(n[t].value=s)},Rh=n=>{n.start=(e=>{let t=!1;return(s=0,i=0,r)=>{if(t)throw De();e.call(n,s,i,r),t=!0}})(n.start)},wi=n=>{n.start=(e=>(t=0,s=0,i)=>{if(typeof i=="number"&&i<0||s<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(n,t,s,i)})(n.start)},Ni=n=>{n.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(n,t)})(n.stop)},Oh=(n,e,t,s,i,r,o,l,c,u,h)=>(d,g)=>{const f=d.createBufferSource();return Me(f,g),xe(f,g,"playbackRate"),ge(f,g,"buffer"),ge(f,g,"loop"),ge(f,g,"loopEnd"),ge(f,g,"loopStart"),e(t,()=>t(d))||Rh(f),e(s,()=>s(d))||c(f),e(i,()=>i(d))||u(f,d),e(r,()=>r(d))||wi(f),e(o,()=>o(d))||h(f,d),e(l,()=>l(d))||Ni(f),n(d,f),f},Ph=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,Fh=(n,e)=>(t,s,i)=>{const r=t.destination;if(r.channelCount!==s)try{r.channelCount=s}catch{}i&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:s});const o=n(t,{channelCount:s,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return e(o,"channelCount",l=>()=>l.call(o),l=>c=>{l.call(o,c);try{r.channelCount=c}catch(u){if(c>r.maxChannelCount)throw u}}),e(o,"channelCountMode",l=>()=>l.call(o),l=>c=>{l.call(o,c),r.channelCountMode=c}),e(o,"channelInterpretation",l=>()=>l.call(o),l=>c=>{l.call(o,c),r.channelInterpretation=c}),Object.defineProperty(o,"maxChannelCount",{get:()=>r.maxChannelCount}),o.connect(r),o},Lh=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,Vh=n=>{const{port1:e}=new MessageChannel;try{e.postMessage(n)}finally{e.close()}},qh=(n,e,t,s,i)=>(r,o,l,c,u,h)=>{if(l!==null)try{const d=new l(r,c,h),g=new Map;let f=null;if(Object.defineProperties(d,{channelCount:{get:()=>h.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>f,set:m=>{typeof f=="function"&&d.removeEventListener("processorerror",f),f=typeof m=="function"?m:null,typeof f=="function"&&d.addEventListener("processorerror",f)}}}),d.addEventListener=(m=>(...p)=>{if(p[0]==="processorerror"){const _=typeof p[1]=="function"?p[1]:typeof p[1]=="object"&&p[1]!==null&&typeof p[1].handleEvent=="function"?p[1].handleEvent:null;if(_!==null){const y=g.get(p[1]);y!==void 0?p[1]=y:(p[1]=w=>{w.type==="error"?(Object.defineProperties(w,{type:{value:"processorerror"}}),_(w)):_(new ErrorEvent(p[0],{...w}))},g.set(_,p[1]))}}return m.call(d,"error",p[1],p[2]),m.call(d,...p)})(d.addEventListener),d.removeEventListener=(m=>(...p)=>{if(p[0]==="processorerror"){const _=g.get(p[1]);_!==void 0&&(g.delete(p[1]),p[1]=_)}return m.call(d,"error",p[1],p[2]),m.call(d,p[0],p[1],p[2])})(d.removeEventListener),h.numberOfOutputs!==0){const m=t(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return d.connect(m).connect(r.destination),i(d,()=>m.disconnect(),()=>m.connect(r.destination))}return d}catch(d){throw d.code===11?s():d}if(u===void 0)throw s();return Vh(h),e(r,o,u,h)},gr=(n,e)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*e))))),Wh=n=>new Promise((e,t)=>{const{port1:s,port2:i}=new MessageChannel;s.onmessage=({data:r})=>{s.close(),i.close(),e(r)},s.onmessageerror=({data:r})=>{s.close(),i.close(),t(r)},i.postMessage(n)}),Bh=async(n,e)=>{const t=await Wh(e);return new n(t)},Uh=(n,e,t,s)=>{let i=ci.get(n);i===void 0&&(i=new WeakMap,ci.set(n,i));const r=Bh(t,s);return i.set(e,r),r},Gh=(n,e,t,s,i,r,o,l,c,u,h,d,g)=>(f,m,p,_)=>{if(_.numberOfInputs===0&&_.numberOfOutputs===0)throw c();const y=Array.isArray(_.outputChannelCount)?_.outputChannelCount:Array.from(_.outputChannelCount);if(y.some($=>$<1))throw c();if(y.length!==_.numberOfOutputs)throw e();if(_.channelCountMode!=="explicit")throw c();const w=_.channelCount*_.numberOfInputs,S=y.reduce(($,J)=>$+J,0),E=p.parameterDescriptors===void 0?0:p.parameterDescriptors.length;if(w+E>6||S>6)throw c();const b=new MessageChannel,T=[],j=[];for(let $=0;$<_.numberOfInputs;$+=1)T.push(o(f,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1})),j.push(i(f,{channelCount:_.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:_.channelCount}));const v=[];if(p.parameterDescriptors!==void 0)for(const{defaultValue:$,maxValue:J,minValue:ve,name:he}of p.parameterDescriptors){const ie=r(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:_.parameterData[he]!==void 0?_.parameterData[he]:$===void 0?0:$});Object.defineProperties(ie.offset,{defaultValue:{get:()=>$===void 0?0:$},maxValue:{get:()=>J===void 0?qe:J},minValue:{get:()=>ve===void 0?Ue:ve}}),v.push(ie)}const N=s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,w+E)}),A=gr(m,f.sampleRate),D=l(f,A,w+E,Math.max(1,S)),M=i(f,{channelCount:Math.max(1,S),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,S)}),P=[];for(let $=0;$<_.numberOfOutputs;$+=1)P.push(s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:y[$]}));for(let $=0;$<_.numberOfInputs;$+=1){T[$].connect(j[$]);for(let J=0;J<_.channelCount;J+=1)j[$].connect(N,J,$*_.channelCount+J)}const I=new mr(p.parameterDescriptors===void 0?[]:p.parameterDescriptors.map(({name:$},J)=>{const ve=v[J];return ve.connect(N,0,w+J),ve.start(0),[$,ve.offset]}));N.connect(D);let F=_.channelInterpretation,V=null;const O=_.numberOfOutputs===0?[D]:P,G={get bufferSize(){return A},get channelCount(){return _.channelCount},set channelCount($){throw t()},get channelCountMode(){return _.channelCountMode},set channelCountMode($){throw t()},get channelInterpretation(){return F},set channelInterpretation($){for(const J of T)J.channelInterpretation=$;F=$},get context(){return D.context},get inputs(){return T},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},get onprocessorerror(){return V},set onprocessorerror($){typeof V=="function"&&G.removeEventListener("processorerror",V),V=typeof $=="function"?$:null,typeof V=="function"&&G.addEventListener("processorerror",V)},get parameters(){return I},get port(){return b.port2},addEventListener(...$){return D.addEventListener($[0],$[1],$[2])},connect:n.bind(null,O),disconnect:u.bind(null,O),dispatchEvent(...$){return D.dispatchEvent($[0])},removeEventListener(...$){return D.removeEventListener($[0],$[1],$[2])}},Y=new Map;b.port1.addEventListener=($=>(...J)=>{if(J[0]==="message"){const ve=typeof J[1]=="function"?J[1]:typeof J[1]=="object"&&J[1]!==null&&typeof J[1].handleEvent=="function"?J[1].handleEvent:null;if(ve!==null){const he=Y.get(J[1]);he!==void 0?J[1]=he:(J[1]=ie=>{h(f.currentTime,f.sampleRate,()=>ve(ie))},Y.set(ve,J[1]))}}return $.call(b.port1,J[0],J[1],J[2])})(b.port1.addEventListener),b.port1.removeEventListener=($=>(...J)=>{if(J[0]==="message"){const ve=Y.get(J[1]);ve!==void 0&&(Y.delete(J[1]),J[1]=ve)}return $.call(b.port1,J[0],J[1],J[2])})(b.port1.removeEventListener);let H=null;Object.defineProperty(b.port1,"onmessage",{get:()=>H,set:$=>{typeof H=="function"&&b.port1.removeEventListener("message",H),H=typeof $=="function"?$:null,typeof H=="function"&&(b.port1.addEventListener("message",H),b.port1.start())}}),p.prototype.port=b.port1;let X=null;Uh(f,G,p,_).then($=>X=$);const U=hn(_.numberOfInputs,_.channelCount),Q=hn(_.numberOfOutputs,y),B=p.parameterDescriptors===void 0?[]:p.parameterDescriptors.reduce(($,{name:J})=>({...$,[J]:new Float32Array(128)}),{});let C=!0;const R=()=>{_.numberOfOutputs>0&&D.disconnect(M);for(let $=0,J=0;$<_.numberOfOutputs;$+=1){const ve=P[$];for(let he=0;he<y[$];he+=1)M.disconnect(ve,J+he,he);J+=y[$]}},k=new Map;D.onaudioprocess=({inputBuffer:$,outputBuffer:J})=>{if(X!==null){const ve=d(G);for(let he=0;he<A;he+=128){for(let ie=0;ie<_.numberOfInputs;ie+=1)for(let me=0;me<_.channelCount;me+=1)un($,U[ie],me,me,he);p.parameterDescriptors!==void 0&&p.parameterDescriptors.forEach(({name:ie},me)=>{un($,B,ie,w+me,he)});for(let ie=0;ie<_.numberOfInputs;ie+=1)for(let me=0;me<y[ie];me+=1)Q[ie][me].byteLength===0&&(Q[ie][me]=new Float32Array(128));try{const ie=U.map((Ve,ct)=>{if(ve[ct].size>0)return k.set(ct,A/128),Ve;const ws=k.get(ct);return ws===void 0?[]:(Ve.every(tt=>tt.every(qn=>qn===0))&&(ws===1?k.delete(ct):k.set(ct,ws-1)),Ve)});C=h(f.currentTime+he/f.sampleRate,f.sampleRate,()=>X.process(ie,Q,B));for(let Ve=0,ct=0;Ve<_.numberOfOutputs;Ve+=1){for(let qt=0;qt<y[Ve];qt+=1)pr(J,Q[Ve],qt,ct+qt,he);ct+=y[Ve]}}catch(ie){C=!1,G.dispatchEvent(new ErrorEvent("processorerror",{colno:ie.colno,filename:ie.filename,lineno:ie.lineno,message:ie.message}))}if(!C){for(let ie=0;ie<_.numberOfInputs;ie+=1){T[ie].disconnect(j[ie]);for(let me=0;me<_.channelCount;me+=1)j[he].disconnect(N,me,ie*_.channelCount+me)}if(p.parameterDescriptors!==void 0){const ie=p.parameterDescriptors.length;for(let me=0;me<ie;me+=1){const Ve=v[me];Ve.disconnect(N,0,w+me),Ve.stop()}}N.disconnect(D),D.onaudioprocess=null,W?R():et();break}}}};let W=!1;const oe=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Ee=()=>D.connect(oe).connect(f.destination),et=()=>{D.disconnect(oe),oe.disconnect()},Vn=()=>{if(C){et(),_.numberOfOutputs>0&&D.connect(M);for(let $=0,J=0;$<_.numberOfOutputs;$+=1){const ve=P[$];for(let he=0;he<y[$];he+=1)M.connect(ve,J+he,he);J+=y[$]}}W=!0},xs=()=>{C&&(Ee(),R()),W=!1};return Ee(),g(G,Vn,xs)},vr=(n,e)=>{const t=n.createBiquadFilter();return Me(t,e),xe(t,e,"Q"),xe(t,e,"detune"),xe(t,e,"frequency"),xe(t,e,"gain"),ge(t,e,"type"),t},$h=(n,e)=>(t,s)=>{const i=t.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&e(t,i),Me(i,s),i},zh=n=>{const e=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw De()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw De()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw De()}})},Os=(n,e)=>{const t=n.createChannelSplitter(e.numberOfOutputs);return Me(t,e),zh(t),t},Yh=(n,e,t,s,i)=>(r,o)=>{if(r.createConstantSource===void 0)return t(r,o);const l=r.createConstantSource();return Me(l,o),xe(l,o,"offset"),e(s,()=>s(r))||wi(l),e(i,()=>i(r))||Ni(l),n(r,l),l},fs=(n,e)=>(n.connect=e.connect.bind(e),n.disconnect=e.disconnect.bind(e),n),Hh=(n,e,t,s)=>(i,{offset:r,...o})=>{const l=i.createBuffer(1,2,44100),c=e(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(i,{...o,gain:r}),h=l.getChannelData(0);h[0]=1,h[1]=1,c.buffer=l,c.loop=!0;const d={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(m){u.channelCount=m},get channelCountMode(){return u.channelCountMode},set channelCountMode(m){u.channelCountMode=m},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(m){u.channelInterpretation=m},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return c.onended},set onended(m){c.onended=m},addEventListener(...m){return c.addEventListener(m[0],m[1],m[2])},dispatchEvent(...m){return c.dispatchEvent(m[0])},removeEventListener(...m){return c.removeEventListener(m[0],m[1],m[2])},start(m=0){c.start.call(c,m)},stop(m=0){c.stop.call(c,m)}},g=()=>c.connect(u),f=()=>c.disconnect(u);return n(i,c),s(fs(d,u),g,f)},Xh=(n,e)=>(t,s)=>{const i=t.createConvolver();if(Me(i,s),s.disableNormalization===i.normalize&&(i.normalize=!s.disableNormalization),ge(i,s,"buffer"),s.channelCount>2||(e(i,"channelCount",r=>()=>r.call(i),r=>o=>{if(o>2)throw n();return r.call(i,o)}),s.channelCountMode==="max"))throw n();return e(i,"channelCountMode",r=>()=>r.call(i),r=>o=>{if(o==="max")throw n();return r.call(i,o)}),i},_r=(n,e)=>{const t=n.createDelay(e.maxDelayTime);return Me(t,e),xe(t,e,"delayTime"),t},Jh=n=>(e,t)=>{const s=e.createDynamicsCompressor();if(Me(s,t),t.channelCount>2||t.channelCountMode==="max")throw n();return xe(s,t,"attack"),xe(s,t,"knee"),xe(s,t,"ratio"),xe(s,t,"release"),xe(s,t,"threshold"),s},$e=(n,e)=>{const t=n.createGain();return Me(t,e),xe(t,e,"gain"),t},Zh=n=>(e,t,s)=>{if(e.createIIRFilter===void 0)return n(e,t,s);const i=e.createIIRFilter(s.feedforward,s.feedback);return Me(i,s),i};function Kh(n,e){const t=e[0]*e[0]+e[1]*e[1];return[(n[0]*e[0]+n[1]*e[1])/t,(n[1]*e[0]-n[0]*e[1])/t]}function Qh(n,e){return[n[0]*e[0]-n[1]*e[1],n[0]*e[1]+n[1]*e[0]]}function Ma(n,e){let t=[0,0];for(let s=n.length-1;s>=0;s-=1)t=Qh(t,e),t[0]+=n[s];return t}const ed=(n,e,t,s)=>(i,r,{channelCount:o,channelCountMode:l,channelInterpretation:c,feedback:u,feedforward:h})=>{const d=gr(r,i.sampleRate),g=u instanceof Float64Array?u:new Float64Array(u),f=h instanceof Float64Array?h:new Float64Array(h),m=g.length,p=f.length,_=Math.min(m,p);if(m===0||m>20)throw s();if(g[0]===0)throw e();if(p===0||p>20)throw s();if(f[0]===0)throw e();if(g[0]!==1){for(let v=0;v<p;v+=1)f[v]/=g[0];for(let v=1;v<m;v+=1)g[v]/=g[0]}const y=t(i,d,o,o);y.channelCount=o,y.channelCountMode=l,y.channelInterpretation=c;const w=32,S=[],E=[],b=[];for(let v=0;v<o;v+=1){S.push(0);const N=new Float32Array(w),A=new Float32Array(w);N.fill(0),A.fill(0),E.push(N),b.push(A)}y.onaudioprocess=v=>{const N=v.inputBuffer,A=v.outputBuffer,D=N.numberOfChannels;for(let M=0;M<D;M+=1){const P=N.getChannelData(M),I=A.getChannelData(M);S[M]=fr(g,m,f,p,_,E[M],b[M],S[M],w,P,I)}};const T=i.sampleRate/2;return fs({get bufferSize(){return d},get channelCount(){return y.channelCount},set channelCount(v){y.channelCount=v},get channelCountMode(){return y.channelCountMode},set channelCountMode(v){y.channelCountMode=v},get channelInterpretation(){return y.channelInterpretation},set channelInterpretation(v){y.channelInterpretation=v},get context(){return y.context},get inputs(){return[y]},get numberOfInputs(){return y.numberOfInputs},get numberOfOutputs(){return y.numberOfOutputs},addEventListener(...v){return y.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return y.dispatchEvent(v[0])},getFrequencyResponse(v,N,A){if(v.length!==N.length||N.length!==A.length)throw n();const D=v.length;for(let M=0;M<D;M+=1){const P=-Math.PI*(v[M]/T),I=[Math.cos(P),Math.sin(P)],F=Ma(f,I),V=Ma(g,I),O=Kh(F,V);N[M]=Math.sqrt(O[0]*O[0]+O[1]*O[1]),A[M]=Math.atan2(O[1],O[0])}},removeEventListener(...v){return y.removeEventListener(v[0],v[1],v[2])}},y)},td=(n,e)=>n.createMediaElementSource(e.mediaElement),sd=(n,e)=>{const t=n.createMediaStreamDestination();return Me(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},nd=(n,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((r,o)=>r.id<o.id?-1:r.id>o.id?1:0);const s=t.slice(0,1),i=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(i,"mediaStream",{value:e}),i},id=(n,e)=>(t,{mediaStreamTrack:s})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(s);const i=new MediaStream([s]),r=t.createMediaStreamSource(i);if(s.kind!=="audio")throw n();if(e(t))throw new TypeError;return r},ad=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,rd=(n,e,t,s,i,r)=>(o,l)=>{const c=o.createOscillator();return Me(c,l),xe(c,l,"detune"),xe(c,l,"frequency"),l.periodicWave!==void 0?c.setPeriodicWave(l.periodicWave):ge(c,l,"type"),e(t,()=>t(o))||wi(c),e(s,()=>s(o))||r(c,o),e(i,()=>i(o))||Ni(c),n(o,c),c},od=n=>(e,t)=>{const s=e.createPanner();return s.orientationX===void 0?n(e,t):(Me(s,t),xe(s,t,"orientationX"),xe(s,t,"orientationY"),xe(s,t,"orientationZ"),xe(s,t,"positionX"),xe(s,t,"positionY"),xe(s,t,"positionZ"),ge(s,t,"coneInnerAngle"),ge(s,t,"coneOuterAngle"),ge(s,t,"coneOuterGain"),ge(s,t,"distanceModel"),ge(s,t,"maxDistance"),ge(s,t,"panningModel"),ge(s,t,"refDistance"),ge(s,t,"rolloffFactor"),s)},cd=(n,e,t,s,i,r,o,l,c,u)=>(h,{coneInnerAngle:d,coneOuterAngle:g,coneOuterGain:f,distanceModel:m,maxDistance:p,orientationX:_,orientationY:y,orientationZ:w,panningModel:S,positionX:E,positionY:b,positionZ:T,refDistance:j,rolloffFactor:v,...N})=>{const A=h.createPanner();if(N.channelCount>2||N.channelCountMode==="max")throw o();Me(A,N);const D={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M=t(h,{...D,channelInterpretation:"speakers",numberOfInputs:6}),P=s(h,{...N,gain:1}),I=s(h,{...D,gain:1}),F=s(h,{...D,gain:0}),V=s(h,{...D,gain:0}),O=s(h,{...D,gain:0}),G=s(h,{...D,gain:0}),Y=s(h,{...D,gain:0}),H=i(h,256,6,1),X=r(h,{...D,curve:new Float32Array([1,1]),oversample:"none"});let ee=[_,y,w],U=[E,b,T];const Q=new Float32Array(1);H.onaudioprocess=({inputBuffer:k})=>{const W=[c(k,Q,0),c(k,Q,1),c(k,Q,2)];W.some((Ee,et)=>Ee!==ee[et])&&(A.setOrientation(...W),ee=W);const oe=[c(k,Q,3),c(k,Q,4),c(k,Q,5)];oe.some((Ee,et)=>Ee!==U[et])&&(A.setPosition(...oe),U=oe)},Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(V.gain,"defaultValue",{get:()=>0}),Object.defineProperty(O.gain,"defaultValue",{get:()=>0}),Object.defineProperty(G.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Y.gain,"defaultValue",{get:()=>0});const B={get bufferSize(){},get channelCount(){return A.channelCount},set channelCount(k){if(k>2)throw o();P.channelCount=k,A.channelCount=k},get channelCountMode(){return A.channelCountMode},set channelCountMode(k){if(k==="max")throw o();P.channelCountMode=k,A.channelCountMode=k},get channelInterpretation(){return A.channelInterpretation},set channelInterpretation(k){P.channelInterpretation=k,A.channelInterpretation=k},get coneInnerAngle(){return A.coneInnerAngle},set coneInnerAngle(k){A.coneInnerAngle=k},get coneOuterAngle(){return A.coneOuterAngle},set coneOuterAngle(k){A.coneOuterAngle=k},get coneOuterGain(){return A.coneOuterGain},set coneOuterGain(k){if(k<0||k>1)throw e();A.coneOuterGain=k},get context(){return A.context},get distanceModel(){return A.distanceModel},set distanceModel(k){A.distanceModel=k},get inputs(){return[P]},get maxDistance(){return A.maxDistance},set maxDistance(k){if(k<0)throw new RangeError;A.maxDistance=k},get numberOfInputs(){return A.numberOfInputs},get numberOfOutputs(){return A.numberOfOutputs},get orientationX(){return I.gain},get orientationY(){return F.gain},get orientationZ(){return V.gain},get panningModel(){return A.panningModel},set panningModel(k){A.panningModel=k},get positionX(){return O.gain},get positionY(){return G.gain},get positionZ(){return Y.gain},get refDistance(){return A.refDistance},set refDistance(k){if(k<0)throw new RangeError;A.refDistance=k},get rolloffFactor(){return A.rolloffFactor},set rolloffFactor(k){if(k<0)throw new RangeError;A.rolloffFactor=k},addEventListener(...k){return P.addEventListener(k[0],k[1],k[2])},dispatchEvent(...k){return P.dispatchEvent(k[0])},removeEventListener(...k){return P.removeEventListener(k[0],k[1],k[2])}};d!==B.coneInnerAngle&&(B.coneInnerAngle=d),g!==B.coneOuterAngle&&(B.coneOuterAngle=g),f!==B.coneOuterGain&&(B.coneOuterGain=f),m!==B.distanceModel&&(B.distanceModel=m),p!==B.maxDistance&&(B.maxDistance=p),_!==B.orientationX.value&&(B.orientationX.value=_),y!==B.orientationY.value&&(B.orientationY.value=y),w!==B.orientationZ.value&&(B.orientationZ.value=w),S!==B.panningModel&&(B.panningModel=S),E!==B.positionX.value&&(B.positionX.value=E),b!==B.positionY.value&&(B.positionY.value=b),T!==B.positionZ.value&&(B.positionZ.value=T),j!==B.refDistance&&(B.refDistance=j),v!==B.rolloffFactor&&(B.rolloffFactor=v),(ee[0]!==1||ee[1]!==0||ee[2]!==0)&&A.setOrientation(...ee),(U[0]!==0||U[1]!==0||U[2]!==0)&&A.setPosition(...U);const C=()=>{P.connect(A),n(P,X,0,0),X.connect(I).connect(M,0,0),X.connect(F).connect(M,0,1),X.connect(V).connect(M,0,2),X.connect(O).connect(M,0,3),X.connect(G).connect(M,0,4),X.connect(Y).connect(M,0,5),M.connect(H).connect(h.destination)},R=()=>{P.disconnect(A),l(P,X,0,0),X.disconnect(I),I.disconnect(M),X.disconnect(F),F.disconnect(M),X.disconnect(V),V.disconnect(M),X.disconnect(O),O.disconnect(M),X.disconnect(G),G.disconnect(M),X.disconnect(Y),Y.disconnect(M),M.disconnect(H),H.disconnect(h.destination)};return u(fs(B,A),C,R)},ld=n=>(e,{disableNormalization:t,imag:s,real:i})=>{const r=s instanceof Float32Array?s:new Float32Array(s),o=i instanceof Float32Array?i:new Float32Array(i),l=e.createPeriodicWave(o,r,{disableNormalization:t});if(Array.from(s).length<2)throw n();return l},Ps=(n,e,t,s)=>n.createScriptProcessor(e,t,s),ud=(n,e)=>(t,s)=>{const i=s.channelCountMode;if(i==="clamped-max")throw e();if(t.createStereoPanner===void 0)return n(t,s);const r=t.createStereoPanner();return Me(r,s),xe(r,s,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>i,set:o=>{if(o!==i)throw e()}}),r},hd=(n,e,t,s,i,r)=>{const l=new Float32Array([1,1]),c=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...u,oversample:"none"},d=(m,p,_,y)=>{const w=new Float32Array(16385),S=new Float32Array(16385);for(let N=0;N<16385;N+=1){const A=N/16384*c;w[N]=Math.cos(A),S[N]=Math.sin(A)}const E=t(m,{...u,gain:0}),b=s(m,{...h,curve:w}),T=s(m,{...h,curve:l}),j=t(m,{...u,gain:0}),v=s(m,{...h,curve:S});return{connectGraph(){p.connect(E),p.connect(T.inputs===void 0?T:T.inputs[0]),p.connect(j),T.connect(_),_.connect(b.inputs===void 0?b:b.inputs[0]),_.connect(v.inputs===void 0?v:v.inputs[0]),b.connect(E.gain),v.connect(j.gain),E.connect(y,0,0),j.connect(y,0,1)},disconnectGraph(){p.disconnect(E),p.disconnect(T.inputs===void 0?T:T.inputs[0]),p.disconnect(j),T.disconnect(_),_.disconnect(b.inputs===void 0?b:b.inputs[0]),_.disconnect(v.inputs===void 0?v:v.inputs[0]),b.disconnect(E.gain),v.disconnect(j.gain),E.disconnect(y,0,0),j.disconnect(y,0,1)}}},g=(m,p,_,y)=>{const w=new Float32Array(16385),S=new Float32Array(16385),E=new Float32Array(16385),b=new Float32Array(16385),T=Math.floor(16385/2);for(let O=0;O<16385;O+=1)if(O>T){const G=(O-T)/(16384-T)*c;w[O]=Math.cos(G),S[O]=Math.sin(G),E[O]=0,b[O]=1}else{const G=O/(16384-T)*c;w[O]=1,S[O]=0,E[O]=Math.cos(G),b[O]=Math.sin(G)}const j=e(m,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),v=t(m,{...u,gain:0}),N=s(m,{...h,curve:w}),A=t(m,{...u,gain:0}),D=s(m,{...h,curve:S}),M=s(m,{...h,curve:l}),P=t(m,{...u,gain:0}),I=s(m,{...h,curve:E}),F=t(m,{...u,gain:0}),V=s(m,{...h,curve:b});return{connectGraph(){p.connect(j),p.connect(M.inputs===void 0?M:M.inputs[0]),j.connect(v,0),j.connect(A,0),j.connect(P,1),j.connect(F,1),M.connect(_),_.connect(N.inputs===void 0?N:N.inputs[0]),_.connect(D.inputs===void 0?D:D.inputs[0]),_.connect(I.inputs===void 0?I:I.inputs[0]),_.connect(V.inputs===void 0?V:V.inputs[0]),N.connect(v.gain),D.connect(A.gain),I.connect(P.gain),V.connect(F.gain),v.connect(y,0,0),P.connect(y,0,0),A.connect(y,0,1),F.connect(y,0,1)},disconnectGraph(){p.disconnect(j),p.disconnect(M.inputs===void 0?M:M.inputs[0]),j.disconnect(v,0),j.disconnect(A,0),j.disconnect(P,1),j.disconnect(F,1),M.disconnect(_),_.disconnect(N.inputs===void 0?N:N.inputs[0]),_.disconnect(D.inputs===void 0?D:D.inputs[0]),_.disconnect(I.inputs===void 0?I:I.inputs[0]),_.disconnect(V.inputs===void 0?V:V.inputs[0]),N.disconnect(v.gain),D.disconnect(A.gain),I.disconnect(P.gain),V.disconnect(F.gain),v.disconnect(y,0,0),P.disconnect(y,0,0),A.disconnect(y,0,1),F.disconnect(y,0,1)}}},f=(m,p,_,y,w)=>{if(p===1)return d(m,_,y,w);if(p===2)return g(m,_,y,w);throw i()};return(m,{channelCount:p,channelCountMode:_,pan:y,...w})=>{if(_==="max")throw i();const S=n(m,{...w,channelCount:1,channelCountMode:_,numberOfInputs:2}),E=t(m,{...w,channelCount:p,channelCountMode:_,gain:1}),b=t(m,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:y});let{connectGraph:T,disconnectGraph:j}=f(m,p,E,b,S);Object.defineProperty(b.gain,"defaultValue",{get:()=>0}),Object.defineProperty(b.gain,"maxValue",{get:()=>1}),Object.defineProperty(b.gain,"minValue",{get:()=>-1});const v={get bufferSize(){},get channelCount(){return E.channelCount},set channelCount(M){E.channelCount!==M&&(N&&j(),{connectGraph:T,disconnectGraph:j}=f(m,M,E,b,S),N&&T()),E.channelCount=M},get channelCountMode(){return E.channelCountMode},set channelCountMode(M){if(M==="clamped-max"||M==="max")throw i();E.channelCountMode=M},get channelInterpretation(){return E.channelInterpretation},set channelInterpretation(M){E.channelInterpretation=M},get context(){return E.context},get inputs(){return[E]},get numberOfInputs(){return E.numberOfInputs},get numberOfOutputs(){return E.numberOfOutputs},get pan(){return b.gain},addEventListener(...M){return E.addEventListener(M[0],M[1],M[2])},dispatchEvent(...M){return E.dispatchEvent(M[0])},removeEventListener(...M){return E.removeEventListener(M[0],M[1],M[2])}};let N=!1;const A=()=>{T(),N=!0},D=()=>{j(),N=!1};return r(fs(v,S),A,D)}},dd=(n,e,t,s,i,r,o)=>(l,c)=>{const u=l.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&l.createGain().gain.automationRate===void 0)return t(l,c);Me(u,c);const h=c.curve===null||c.curve instanceof Float32Array?c.curve:new Float32Array(c.curve);if(h!==null&&h.length<2)throw e();ge(u,{curve:h},"curve"),ge(u,c,"oversample");let d=null,g=!1;return o(u,"curve",p=>()=>p.call(u),p=>_=>(p.call(u,_),g&&(s(_)&&d===null?d=n(l,u):!s(_)&&d!==null&&(d(),d=null)),_)),i(u,()=>{g=!0,s(u.curve)&&(d=n(l,u))},()=>{g=!1,d!==null&&(d(),d=null)})},md=(n,e,t,s,i)=>(r,{curve:o,oversample:l,...c})=>{const u=r.createWaveShaper(),h=r.createWaveShaper();Me(u,c),Me(h,c);const d=t(r,{...c,gain:1}),g=t(r,{...c,gain:-1}),f=t(r,{...c,gain:1}),m=t(r,{...c,gain:-1});let p=null,_=!1,y=null;const w={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(b){d.channelCount=b,g.channelCount=b,u.channelCount=b,f.channelCount=b,h.channelCount=b,m.channelCount=b},get channelCountMode(){return u.channelCountMode},set channelCountMode(b){d.channelCountMode=b,g.channelCountMode=b,u.channelCountMode=b,f.channelCountMode=b,h.channelCountMode=b,m.channelCountMode=b},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(b){d.channelInterpretation=b,g.channelInterpretation=b,u.channelInterpretation=b,f.channelInterpretation=b,h.channelInterpretation=b,m.channelInterpretation=b},get context(){return u.context},get curve(){return y},set curve(b){if(b!==null&&b.length<2)throw e();if(b===null)u.curve=b,h.curve=b;else{const T=b.length,j=new Float32Array(T+2-T%2),v=new Float32Array(T+2-T%2);j[0]=b[0],v[0]=-b[T-1];const N=Math.ceil((T+1)/2),A=(T+1)/2-1;for(let D=1;D<N;D+=1){const M=D/N*A,P=Math.floor(M),I=Math.ceil(M);j[D]=P===I?b[P]:(1-(M-P))*b[P]+(1-(I-M))*b[I],v[D]=P===I?-b[T-1-P]:-((1-(M-P))*b[T-1-P])-(1-(I-M))*b[T-1-I]}j[N]=T%2===1?b[N-1]:(b[N-2]+b[N-1])/2,u.curve=j,h.curve=v}y=b,_&&(s(y)&&p===null?p=n(r,d):p!==null&&(p(),p=null))},get inputs(){return[d]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(b){u.oversample=b,h.oversample=b},addEventListener(...b){return d.addEventListener(b[0],b[1],b[2])},dispatchEvent(...b){return d.dispatchEvent(b[0])},removeEventListener(...b){return d.removeEventListener(b[0],b[1],b[2])}};o!==null&&(w.curve=o instanceof Float32Array?o:new Float32Array(o)),l!==w.oversample&&(w.oversample=l);const S=()=>{d.connect(u).connect(f),d.connect(g).connect(h).connect(m).connect(f),_=!0,s(y)&&(p=n(r,d))},E=()=>{d.disconnect(u),u.disconnect(f),d.disconnect(g),g.disconnect(h),h.disconnect(m),m.disconnect(f),_=!1,p!==null&&(p(),p=null)};return i(fs(w,f),S,E)},Be=()=>new DOMException("","NotSupportedError"),pd={numberOfChannels:1},fd=(n,e,t,s,i)=>class extends n{constructor(o,l,c){let u;if(typeof o=="number"&&l!==void 0&&c!==void 0)u={length:l,numberOfChannels:o,sampleRate:c};else if(typeof o=="object")u=o;else throw new Error("The given parameters are not valid.");const{length:h,numberOfChannels:d,sampleRate:g}={...pd,...u},f=s(d,h,g);e(js,()=>js(f))||f.addEventListener("statechange",(()=>{let m=0;const p=_=>{this._state==="running"&&(m>0?(f.removeEventListener("statechange",p),_.stopImmediatePropagation(),this._waitForThePromiseToSettle(_)):m+=1)};return p})()),super(f,d),this._length=h,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,lr(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},gd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},vd=(n,e,t,s,i,r,o)=>class extends n{constructor(c,u){const h=i(c),d={...gd,...u},g=t(h,d),f=r(h),m=f?s():null,p=c.sampleRate/2;super(c,!1,g,m),this._detune=e(this,f,g.detune,153600,-153600),this._frequency=e(this,f,g.frequency,p,-p),this._nativeOscillatorNode=g,this._onended=null,this._oscillatorNodeRenderer=m,this._oscillatorNodeRenderer!==null&&d.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=d.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeOscillatorNode.onended=u;const h=this._nativeOscillatorNode.onended;this._onended=h!==null&&h===u?c:h}get type(){return this._nativeOscillatorNode.type}set type(c){this._nativeOscillatorNode.type=c,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(c){this._nativeOscillatorNode.setPeriodicWave(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=c)}start(c=0){if(this._nativeOscillatorNode.start(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=c),this.context.state!=="closed"){os(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),yt(this)&&Is(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(c=0){this._nativeOscillatorNode.stop(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=c)}},_d=(n,e,t,s,i)=>()=>{const r=new WeakMap;let o=null,l=null,c=null;const u=async(h,d)=>{let g=t(h);const f=Le(g,d);if(!f){const m={channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,detune:g.detune.value,frequency:g.frequency.value,periodicWave:o===null?void 0:o,type:g.type};g=e(d,m),l!==null&&g.start(l),c!==null&&g.stop(c)}return r.set(d,g),f?(await n(d,h.detune,g.detune),await n(d,h.frequency,g.frequency)):(await s(d,h.detune,g.detune),await s(d,h.frequency,g.frequency)),await i(h,d,g),g};return{set periodicWave(h){o=h},set start(h){l=h},set stop(h){c=h},render(h,d){const g=r.get(d);return g!==void 0?Promise.resolve(g):u(h,d)}}},yd={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},bd=(n,e,t,s,i,r,o)=>class extends n{constructor(c,u){const h=i(c),d={...yd,...u},g=t(h,d),f=r(h),m=f?s():null;super(c,!1,g,m),this._nativePannerNode=g,this._orientationX=e(this,f,g.orientationX,qe,Ue),this._orientationY=e(this,f,g.orientationY,qe,Ue),this._orientationZ=e(this,f,g.orientationZ,qe,Ue),this._positionX=e(this,f,g.positionX,qe,Ue),this._positionY=e(this,f,g.positionY,qe,Ue),this._positionZ=e(this,f,g.positionZ,qe,Ue),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(c){this._nativePannerNode.coneInnerAngle=c}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(c){this._nativePannerNode.coneOuterAngle=c}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(c){this._nativePannerNode.coneOuterGain=c}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(c){this._nativePannerNode.distanceModel=c}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(c){this._nativePannerNode.maxDistance=c}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(c){this._nativePannerNode.panningModel=c}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(c){this._nativePannerNode.refDistance=c}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(c){this._nativePannerNode.rolloffFactor=c}},xd=(n,e,t,s,i,r,o,l,c,u)=>()=>{const h=new WeakMap;let d=null;const g=async(f,m)=>{let p=null,_=r(f);const y={channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation},w={...y,coneInnerAngle:_.coneInnerAngle,coneOuterAngle:_.coneOuterAngle,coneOuterGain:_.coneOuterGain,distanceModel:_.distanceModel,maxDistance:_.maxDistance,panningModel:_.panningModel,refDistance:_.refDistance,rolloffFactor:_.rolloffFactor},S=Le(_,m);if("bufferSize"in _)p=s(m,{...y,gain:1});else if(!S){const E={...w,orientationX:_.orientationX.value,orientationY:_.orientationY.value,orientationZ:_.orientationZ.value,positionX:_.positionX.value,positionY:_.positionY.value,positionZ:_.positionZ.value};_=i(m,E)}if(h.set(m,p===null?_:p),p!==null){if(d===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const D=new o(6,f.context.length,m.sampleRate),M=e(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});M.connect(D.destination),d=(async()=>{const P=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(I,F)=>{const V=t(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:F===0?1:0});return await l(D,I,V.offset),V}));for(let I=0;I<6;I+=1)P[I].connect(M,0,I),P[I].start(0);return u(D)})()}const E=await d,b=s(m,{...y,gain:1});await c(f,m,b);const T=[];for(let D=0;D<E.numberOfChannels;D+=1)T.push(E.getChannelData(D));let j=[T[0][0],T[1][0],T[2][0]],v=[T[3][0],T[4][0],T[5][0]],N=s(m,{...y,gain:1}),A=i(m,{...w,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]});b.connect(N).connect(A.inputs[0]),A.connect(p);for(let D=128;D<E.length;D+=128){const M=[T[0][D],T[1][D],T[2][D]],P=[T[3][D],T[4][D],T[5][D]];if(M.some((I,F)=>I!==j[F])||P.some((I,F)=>I!==v[F])){j=M,v=P;const I=D/m.sampleRate;N.gain.setValueAtTime(0,I),N=s(m,{...y,gain:0}),A=i(m,{...w,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]}),N.gain.setValueAtTime(1,I),b.connect(N).connect(A.inputs[0]),A.connect(p)}}return p}return S?(await n(m,f.orientationX,_.orientationX),await n(m,f.orientationY,_.orientationY),await n(m,f.orientationZ,_.orientationZ),await n(m,f.positionX,_.positionX),await n(m,f.positionY,_.positionY),await n(m,f.positionZ,_.positionZ)):(await l(m,f.orientationX,_.orientationX),await l(m,f.orientationY,_.orientationY),await l(m,f.orientationZ,_.orientationZ),await l(m,f.positionX,_.positionX),await l(m,f.positionY,_.positionY),await l(m,f.positionZ,_.positionZ)),ps(_)?await c(f,m,_.inputs[0]):await c(f,m,_),_};return{render(f,m){const p=h.get(m);return p!==void 0?Promise.resolve(p):g(f,m)}}},wd={disableNormalization:!1},Nd=(n,e,t,s)=>class yr{constructor(r,o){const l=e(r),c=s({...wd,...o}),u=n(l,c);return t.add(u),u}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===yr.prototype||t.has(r)}},Sd=(n,e)=>(t,s,i)=>(n(s).replay(i),e(s,t,i)),Td=(n,e,t)=>async(s,i,r)=>{const o=n(s);await Promise.all(o.activeInputs.map((l,c)=>Array.from(l).map(async([u,h])=>{const g=await e(u).render(u,i),f=s.context.destination;!t(u)&&(s!==f||!t(s))&&g.connect(r,h,c)})).reduce((l,c)=>[...l,...c],[]))},jd=(n,e,t)=>async(s,i,r)=>{const o=e(s);await Promise.all(Array.from(o.activeInputs).map(async([l,c])=>{const h=await n(l).render(l,i);t(l)||h.connect(r,c)}))},kd=(n,e,t,s)=>i=>n(js,()=>js(i))?Promise.resolve(n(s,s)).then(r=>{if(!r){const o=t(i,512,0,1);i.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>i.currentTime,o.connect(i.destination)}return i.startRendering()}):new Promise(r=>{const o=e(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=l=>{o.disconnect(),r(l.renderedBuffer)},o.connect(i.destination),i.startRendering()}),Cd=n=>(e,t)=>{n.set(e,t)},Ad=n=>(e,t)=>n.set(e,t),Md=(n,e,t,s,i,r,o,l)=>(c,u)=>t(c).render(c,u).then(()=>Promise.all(Array.from(s(u)).map(h=>t(h).render(h,u)))).then(()=>i(u)).then(h=>(typeof h.copyFromChannel!="function"?(o(h),yi(h)):e(r,()=>r(h))||l(h),n.add(h),h)),Ed={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Id=(n,e,t,s,i,r)=>class extends n{constructor(l,c){const u=i(l),h={...Ed,...c},d=t(u,h),g=r(u),f=g?s():null;super(l,!1,d,f),this._pan=e(this,g,d.pan)}get pan(){return this._pan}},Dd=(n,e,t,s,i)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const h=Le(u,c);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(c,d)}return r.set(c,u),h?await n(c,l.pan,u.pan):await s(c,l.pan,u.pan),ps(u)?await i(l,c,u.inputs[0]):await i(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Rd=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},Od=(n,e)=>async()=>{if(n===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new e(1,128,44100),i=URL.createObjectURL(t);let r=!1,o=!1;try{await s.audioWorklet.addModule(i);const l=new n(s,"a",{numberOfOutputs:0}),c=s.createOscillator();l.port.onmessage=()=>r=!0,l.onprocessorerror=()=>o=!0,c.connect(l),c.start(0),await s.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(i)}return r&&!o},Pd=(n,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{t.oncomplete=()=>{s.disconnect(),i(t.currentTime!==0)},t.startRendering()})},Fd=()=>new DOMException("","UnknownError"),Ld={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Vd=(n,e,t,s,i,r,o)=>class extends n{constructor(c,u){const h=i(c),d={...Ld,...u},g=t(h,d),m=r(h)?s():null;super(c,!0,g,m),this._isCurveNullified=!1,this._nativeWaveShaperNode=g,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(c){if(c===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(c.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=c}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(c){this._nativeWaveShaperNode.oversample=c}},qd=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,curve:l.curve,oversample:l.oversample};l=n(o,u)}return s.set(o,l),ps(l)?await t(r,o,l.inputs[0]):await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(r,o)}}},Wd=()=>typeof window>"u"?null:window,Bd=(n,e)=>t=>{t.copyFromChannel=(s,i,r=0)=>{const o=n(r),l=n(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),h=s.length;for(let d=o<0?-o:0;d+o<c&&d<h;d+=1)s[d]=u[d+o]},t.copyToChannel=(s,i,r=0)=>{const o=n(r),l=n(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),h=s.length;for(let d=o<0?-o:0;d+o<c&&d<h;d+=1)u[d+o]=s[d]}},Ud=n=>e=>{e.copyFromChannel=(t=>(s,i,r=0)=>{const o=n(r),l=n(i);if(o<e.length)return t.call(e,s,l,o)})(e.copyFromChannel),e.copyToChannel=(t=>(s,i,r=0)=>{const o=n(r),l=n(i);if(o<e.length)return t.call(e,s,l,o)})(e.copyToChannel)},Gd=n=>(e,t)=>{const s=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=s),n(e,"buffer",i=>()=>{const r=i.call(e);return r===s?null:r},i=>r=>i.call(e,r===null?s:r))},$d=(n,e)=>(t,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const i=t.createBufferSource();e(s,()=>{const l=s.numberOfInputs;for(let c=0;c<l;c+=1)i.connect(s,0,c)},()=>i.disconnect(s))},br=(n,e,t)=>n.copyFromChannel===void 0?n.getChannelData(t)[0]:(n.copyFromChannel(e,t),e[0]),xr=n=>{if(n===null)return!1;const e=n.length;return e%2!==0?n[Math.floor(e/2)]!==0:n[e/2-1]+n[e/2]!==0},Fs=(n,e,t,s)=>{let i=n;for(;!i.hasOwnProperty(e);)i=Object.getPrototypeOf(i);const{get:r,set:o}=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(n,e,{get:t(r),set:s(o)})},zd=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),Yd=n=>({...n,channelCount:n.numberOfOutputs}),Hd=n=>{const{imag:e,real:t}=n;return e===void 0?t===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(t,()=>0),real:t}:t===void 0?{...n,imag:e,real:Array.from(e,()=>0)}:{...n,imag:e,real:t}},wr=(n,e,t)=>{try{n.setValueAtTime(e,t)}catch(s){if(s.code!==9)throw s;wr(n,e,t+1e-7)}},Xd=n=>{const e=n.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},Jd=n=>{const e=n.createBufferSource(),t=n.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},Zd=n=>{const e=n.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},Si=n=>{const e=n.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},Nr=n=>{const e=n.createBuffer(1,1,44100),t=n.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Ti=n=>{const e=n.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},Kd=n=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(n)}finally{e.close(),t.close()}},Qd=n=>{n.start=(e=>(t=0,s=0,i)=>{const r=n.buffer,o=r===null?s:Math.min(r.duration,s);r!==null&&o>r.duration-.5/n.context.sampleRate?e.call(n,t,0,0):e.call(n,t,o,i)})(n.start)},Sr=(n,e)=>{const t=e.createGain();n.connect(t);const s=(i=>()=>{i.call(n,t),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),fs(n,t),n.stop=(i=>{let r=!1;return(o=0)=>{if(r)try{i.call(n,o)}catch{t.gain.setValueAtTime(0,o)}else i.call(n,o),r=!0}})(n.stop)},gs=(n,e)=>t=>{const s={value:n};return Object.defineProperties(t,{currentTarget:s,target:s}),typeof e=="function"?e.call(n,t):e.handleEvent.call(n,t)},em=bl(Xt),tm=jl(Xt),sm=Lu(bn),Tr=new WeakMap,nm=sh(Tr),at=pu(new Map,new WeakMap),dt=Wd(),jr=Ih(at,pt),ji=th(We),Oe=Td(We,ji,$t),im=El(jr,de,Oe),ue=ah(yn),Nt=ad(dt),ce=wh(Nt),kr=new WeakMap,Cr=Hu(gs),Ls=Ph(dt),ki=_h(Ls),Ci=yh(dt),Ar=bh(dt),ks=Lh(dt),Se=su(xl(sr),Tl(em,tm,on,sm,cn,We,nm,Es,de,Xt,yt,$t,Zs),at,mh(ri,cn,We,de,Ts,yt),pt,xn,Be,Ru(on,ri,We,de,Ts,ue,yt,ce),Wu(kr,We,it),Cr,ue,ki,Ci,Ar,ce,ks),am=Ml(Se,im,pt,jr,ue,ce),Ai=new WeakSet,Ea=Dh(dt),Mr=ku(new Uint32Array(1)),Mi=Bd(Mr,pt),Ei=Ud(Mr),Er=Dl(Ai,at,Be,Ea,Nt,Rd(Ea),Mi,Ei),wn=kl($e),Ir=jd(ji,Ds,$t),ft=xu(Ir),vs=Oh(wn,at,Xd,Jd,Zd,Si,Nr,Ti,Qd,Gd(Fs),Sr),gt=Sd(nh(Ds),Ir),rm=Pl(ft,vs,de,gt,Oe),rt=nu(wl(nr),kr,_i,iu,pl,fl,gl,vl,_l,ni,er,Ls,wr),om=Ol(Se,rm,rt,De,vs,ue,ce,gs),cm=$l(Se,zl,pt,De,Fh($e,Fs),ue,ce,Oe),lm=mu(ft,vr,de,gt,Oe),Jt=Ad(Tr),um=du(Se,rt,lm,xn,vr,ue,ce,Jt),Ft=Mh(Xt,Ci),hm=$d(De,Ft),Lt=$h(Ls,hm),dm=vu(Lt,de,Oe),mm=gu(Se,dm,Lt,ue,ce),pm=bu(Os,de,Oe),fm=yu(Se,pm,Os,ue,ce,Yd),gm=Hh(wn,vs,$e,Ft),_s=Yh(wn,at,gm,Si,Ti),vm=ju(ft,_s,de,gt,Oe),_m=Tu(Se,rt,vm,_s,ue,ce,gs),Dr=Xh(Be,Fs),ym=Mu(Dr,de,Oe),bm=Au(Se,ym,Dr,ue,ce,Jt),xm=Fu(ft,_r,de,gt,Oe),wm=Pu(Se,rt,xm,_r,ue,ce,Jt),Rr=Jh(Be),Nm=$u(ft,Rr,de,gt,Oe),Sm=Gu(Se,rt,Nm,Rr,Be,ue,ce,Jt),Tm=Qu(ft,$e,de,gt,Oe),jm=Ku(Se,rt,Tm,$e,ue,ce),km=ed(xn,De,Ps,Be),Nn=kd(at,$e,Ps,Pd($e,Nt)),Cm=dh(vs,de,Nt,Oe,Nn),Am=Zh(km),Mm=uh(Se,Am,Cm,ue,ce,Jt),Em=Yl(rt,Lt,_s,Ps,Be,br,ce,Fs),Or=new WeakMap,Im=Ah(cm,Em,Cr,ce,Or,gs),Pr=rd(wn,at,Si,Nr,Ti,Sr),Dm=_d(ft,Pr,de,gt,Oe),Rm=vd(Se,rt,Pr,Dm,ue,ce,gs),Fr=Nu(vs),Om=md(Fr,De,$e,xr,Ft),Sn=dd(Fr,De,Om,xr,Ft,Ls,Fs),Pm=cd(on,De,Lt,$e,Ps,Sn,Be,cn,br,Ft),Lr=od(Pm),Fm=xd(ft,Lt,_s,$e,Lr,de,Nt,gt,Oe,Nn),Lm=bd(Se,rt,Lr,Fm,ue,ce,Jt),Vm=ld(pt),qm=Nd(Vm,ue,new WeakSet,Hd),Wm=hd(Lt,Os,$e,Sn,Be,Ft),Vr=ud(Wm,Be),Bm=Dd(ft,Vr,de,gt,Oe),Um=Id(Se,rt,Vr,Bm,ue,ce),Gm=qd(Sn,de,Oe),$m=Vd(Se,De,Sn,Gm,ue,ce,Jt),qr=Nh(dt),Ii=Xu(dt),Wr=new WeakMap,zm=rh(Wr,Nt),Ym=qr?Sl(at,Be,Yu(dt),Ii,Ju(yl),ue,zm,ce,ks,new WeakMap,new WeakMap,Od(ks,Nt),dt):void 0,Hm=xh(ki,ce),Xm=Du(Ai,at,Iu,zu,new WeakSet,ue,Hm,an,js,Mi,Ei),Br=uu(Ym,am,Er,om,um,mm,fm,_m,bm,Xm,wm,Sm,jm,Mm,Im,Rm,Lm,qm,Um,$m),Jm=Sh(Se,td,ue,ce),Zm=jh(Se,sd,ue,ce),Km=kh(Se,nd,ue,ce),Qm=id(De,ce),ep=Ch(Se,Qm,ue),tp=Gl(Br,De,Be,Fd,Jm,Zm,Km,ep,Ls),Di=oh(Or),sp=Cl(Di),Ur=wu(pt),np=Vu(Di),Gr=Bu(pt),$r=new WeakMap,ip=eh($r,it),ap=Gh(Ur,pt,De,Lt,Os,_s,$e,Ps,Be,Gr,Ii,ip,Ft),rp=qh(De,ap,$e,Be,Ft),op=lu(ft,Ur,vs,Lt,Os,_s,$e,np,Gr,Ii,de,ks,Nt,gt,Oe,Nn),cp=ih(Wr),lp=Cd($r),Ia=qr?ru(sp,Se,rt,op,rp,We,cp,ue,ce,ks,zd,lp,Kd,gs):void 0,up=Eu(Be,Nt),hp=Md(Ai,at,ji,Di,Nn,an,Mi,Ei),dp=fd(Br,at,De,up,hp),mp=ph(yn,ki),pp=fh(vi,Ci),fp=gh(_i,Ar),gp=vh(yn,ce);function Je(n){return n===void 0}function se(n){return n!==void 0}function vp(n){return typeof n=="function"}function mt(n){return typeof n=="number"}function At(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function zr(n){return typeof n=="boolean"}function Ge(n){return Array.isArray(n)}function xt(n){return typeof n=="string"}function Hs(n){return xt(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function K(n,e){if(!n)throw new Error(e)}function Et(n,e,t=1/0){if(!(e<=n&&n<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${n}`)}function Yr(n){!n.isOffline&&n.state!=="running"&&Tn('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Hr=!1,Da=!1;function Ra(n){Hr=n}function _p(n){Je(n)&&Hr&&!Da&&(Da=!0,Tn("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let Xr=console;function yp(...n){Xr.log(...n)}function Tn(...n){Xr.warn(...n)}function bp(n){return new tp(n)}function xp(n,e,t){return new dp(n,e,t)}const Ye=typeof self=="object"?self:null,wp=Ye&&(Ye.hasOwnProperty("AudioContext")||Ye.hasOwnProperty("webkitAudioContext"));function Np(n,e,t){return K(se(Ia),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof Ye?.BaseAudioContext?Ye?.AudioWorkletNode:Ia)(n,e,t)}function ot(n,e,t,s){var i=arguments.length,r=i<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,e,t,s);else for(var l=n.length-1;l>=0;l--)(o=n[l])&&(r=(i<3?o(r):i>3?o(e,t,r):o(e,t))||r);return i>3&&r&&Object.defineProperty(e,t,r),r}function ke(n,e,t,s){function i(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function l(h){try{u(s.next(h))}catch(d){o(d)}}function c(h){try{u(s.throw(h))}catch(d){o(d)}}function u(h){h.done?r(h.value):i(h.value).then(l,c)}u((s=s.apply(n,e||[])).next())})}class Sp{constructor(e,t,s,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),s=new Worker(t);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function zt(n){return fp(n)}function Mt(n){return pp(n)}function Ks(n){return gp(n)}function es(n){return mp(n)}function Tp(n){return n instanceof Er}function jp(n,e){return n==="value"||zt(e)||Mt(e)||Tp(e)}function Ut(n,...e){if(!e.length)return n;const t=e.shift();if(At(n)&&At(t))for(const s in t)jp(s,t[s])?n[s]=t[s]:At(t[s])?(n[s]||Object.assign(n,{[s]:{}}),Ut(n[s],t[s])):Object.assign(n,{[s]:t[s]});return Ut(n,...e)}function kp(n,e){return n.length===e.length&&n.every((t,s)=>e[s]===t)}function te(n,e,t=[],s){const i={},r=Array.from(e);if(At(r[0])&&s&&!Reflect.has(r[0],s)&&(Object.keys(r[0]).some(l=>Reflect.has(n,l))||(Ut(i,{[s]:r[0]}),t.splice(t.indexOf(s),1),r.shift())),r.length===1&&At(r[0]))Ut(i,r[0]);else for(let o=0;o<t.length;o++)se(r[o])&&(i[t[o]]=r[o]);return Ut(n,i)}function Cp(n){return n.constructor.getDefaults()}function ht(n,e){return Je(n)?e:n}function hi(n,e){return e.forEach(t=>{Reflect.has(n,t)&&delete n[t]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class St{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||Ye&&this.toString()===Ye.TONE_DEBUG_CLASS)&&yp(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}St.version=Qa;const Ri=1e-6;function cs(n,e){return n>e+Ri}function di(n,e){return cs(n,e)||st(n,e)}function dn(n,e){return n+Ri<e}function st(n,e){return Math.abs(n-e)<Ri}function Ap(n,e,t){return Math.max(Math.min(n,t),e)}class Qe extends St{constructor(){super(),this.name="Timeline",this._timeline=[];const e=te(Qe.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(K(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];K(di(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const s=this._search(e,t);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const s=this._search(e,t);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const s=this._search(e);return s-1>=0?this._timeline[s-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(st(this._timeline[t].time,e)){for(let s=t;s>=0&&st(this._timeline[s].time,e);s--)t=s;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&di(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let s=0;const i=this._timeline.length;let r=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;s<r;){let o=Math.floor(s+(r-s)/2);const l=this._timeline[o],c=this._timeline[o+1];if(st(l[t],e)){for(let u=o;u<this._timeline.length;u++){const h=this._timeline[u];if(st(h[t],e))o=u;else break}return o}else{if(dn(l[t],e)&&cs(c[t],e))return o;cs(l[t],e)?r=o:s=o+1}}return-1}_iterate(e,t=0,s=this._timeline.length-1){this._timeline.slice(t,s+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const s=this._search(e);return s!==-1&&this._iterate(t,0,s),this}forEachAfter(e,t){const s=this._search(e);return this._iterate(t,s+1),this}forEachBetween(e,t,s){let i=this._search(e),r=this._search(t);return i!==-1&&r!==-1?(this._timeline[i].time!==e&&(i+=1),this._timeline[r].time===t&&(r-=1),this._iterate(s,i,r)):i===-1&&this._iterate(s,0,r),this}forEachFrom(e,t){let s=this._search(e);for(;s>=0&&this._timeline[s].time>=e;)s--;return this._iterate(t,s+1),this}forEachAtTime(e,t){const s=this._search(e);if(s!==-1&&st(this._timeline[s].time,e)){let i=s;for(let r=s;r>=0&&st(this._timeline[r].time,e);r--)i=r;this._iterate(r=>{t(r)},i,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Jr=[];function jn(n){Jr.push(n)}function Mp(n){Jr.forEach(e=>e(n))}const Zr=[];function kn(n){Zr.push(n)}function Ep(n){Zr.forEach(e=>e(n))}class Vs extends St{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(i=>{Je(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(t)}),this}once(e,t){const s=(...i)=>{t(...i),this.off(e,s)};return this.on(e,s),this}off(e,t){return e.split(/\W+/).forEach(i=>{if(Je(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(Je(t))this._events[i]=[];else{const r=this._events[i];for(let o=r.length-1;o>=0;o--)r[o]===t&&r.splice(o,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const s=this._events[e].slice(0);for(let i=0,r=s.length;i<r;i++)s[i].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const s=Object.getOwnPropertyDescriptor(Vs.prototype,t);Object.defineProperty(e.prototype,t,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class Kr extends Vs{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class qs extends Kr{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new Qe,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=te(qs.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=bp({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new Sp(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(Mp(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,s){return this._context.createBuffer(e,t,s)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,s){return this._context.createPeriodicWave(e,t,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return K(es(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return K(es(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return K(es(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){K(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){K(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){K(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){K(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Np(this.rawContext,e,t)}addAudioWorkletModule(e){return ke(this,void 0,void 0,function*(){K(se(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return ke(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return es(this._context)?this._context.resume():Promise.resolve()}close(){return ke(this,void 0,void 0,function*(){es(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&Ep(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),s=t.getChannelData(0);for(let r=0;r<s.length;r++)s[r]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:s+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const s=++this._timeoutIds,i=()=>{const r=this.now();this._timeouts.add({callback:()=>{e(),i()},id:s,time:r+t})};return i(),s}}class Ip extends Kr{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,s){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return ke(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function we(n,e){Ge(e)?e.forEach(t=>we(n,t)):Object.defineProperty(n,e,{enumerable:!0,writable:!1})}function Qr(n,e){Ge(e)?e.forEach(t=>Qr(n,t)):Object.defineProperty(n,e,{writable:!0})}const re=()=>{};class fe extends St{constructor(){super(),this.name="ToneAudioBuffer",this.onload=re;const e=te(fe.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,xt(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:re,onload:re,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:He().sampleRate}set(e){return e instanceof fe?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return ke(this,void 0,void 0,function*(){const t=fe.load(e).then(s=>{this.set(s),this.onload(this)});fe.downloads.push(t);try{yield t}finally{const s=fe.downloads.indexOf(t);fe.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=Ge(e)&&e[0].length>0,s=t?e.length:1,i=t?e[0].length:e.length,r=He(),o=r.createBuffer(s,i,r.sampleRate),l=!t&&s===1?[e]:e;for(let c=0;c<s;c++)o.copyToChannel(l[c],c);return this._buffer=o,this}toMono(e){if(mt(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const s=this.numberOfChannels;for(let i=0;i<s;i++){const r=this.toArray(i);for(let o=0;o<r.length;o++)t[o]+=r[o]}t=t.map(i=>i/s),this.fromArray(t)}return this}toArray(e){if(mt(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let s=0;s<this.numberOfChannels;s++)t[s]=this.getChannelData(s);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){K(this.loaded,"Buffer is not loaded");const s=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);K(s<i,"The start time must be less than the end time");const r=i-s,o=He().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let l=0;l<this.numberOfChannels;l++)o.copyToChannel(this.getChannelData(l).subarray(s,i),l);return new fe(o)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new fe().fromArray(e)}static fromUrl(e){return ke(this,void 0,void 0,function*(){return yield new fe().load(e)})}static load(e){return ke(this,void 0,void 0,function*(){const t=fe.baseUrl===""||fe.baseUrl.endsWith("/")?fe.baseUrl:fe.baseUrl+"/",s=yield fetch(t+e);if(!s.ok)throw new Error(`could not load url: ${e}`);const i=yield s.arrayBuffer();return yield He().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),s=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return ke(this,void 0,void 0,function*(){for(yield Promise.resolve();fe.downloads.length;)yield fe.downloads[0]})}}fe.baseUrl="";fe.downloads=[];class Oi extends qs{constructor(){super({clockSource:"offline",context:Ks(arguments[0])?arguments[0]:xp(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:Ks(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Ks(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return ke(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const s=Math.floor(this.sampleRate/128);e&&t%s===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return ke(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new fe(t)})}close(){return Promise.resolve()}}const eo=new Ip;let Wt=eo;function He(){return Wt===eo&&wp&&Dp(new qs),Wt}function Dp(n,e=!1){e&&Wt.dispose(),es(n)?Wt=new qs(n):Ks(n)?Wt=new Oi(n):Wt=n}function to(){return Wt.resume()}if(Ye&&!Ye.TONE_SILENCE_LOGGING){const e=` * Tone.js v${Qa} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function Rp(n){return Math.pow(10,n/20)}function Op(n){return 20*(Math.log(n)/Math.LN10)}function so(n){return Math.pow(2,n/12)}let Cn=440;function Pp(){return Cn}function Fp(n){Cn=n}function Bt(n){return Math.round(no(n))}function no(n){return 69+12*Math.log2(n/Cn)}function io(n){return Cn*Math.pow(2,(n-69)/12)}class Pi extends St{constructor(e,t,s){super(),this.defaultUnits="s",this._val=t,this._units=s,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const s=parseInt(e,10),i=t==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/s)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,s)=>{let i=0;return e&&e!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i+=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i+=this._beatsToUnits(parseFloat(s)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Pi&&this.fromType(this._val),Je(this._val))return this._noArg();if(xt(this._val)&&Je(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(At(this._val)){let e=0;for(const t in this._val)if(se(this._val[t])){const s=this._val[t],i=new this.constructor(this.context,t).valueOf()*s;e+=i}return e}if(se(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return xt(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class nt extends Pi{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new nt(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const s=new this.constructor(this.context,e).valueOf(),i=this.valueOf(),l=Math.round(i/s)*s-i;return i+l*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let r=1;r<9;r++){const o=Math.pow(2,r);t.push(o+"n."),t.push(o+"n"),t.push(o+"t")}t.push("0");let s=t[0],i=new nt(this.context,t[0]).toSeconds();return t.forEach(r=>{const o=new nt(this.context,r).toSeconds();Math.abs(o-e)<Math.abs(i-e)&&(s=r,i=o)}),s}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const s=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const r=i.toString();return r.length>3&&(i=parseFloat(parseFloat(r).toFixed(3))),[s,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Bt(this.toFrequency())}_now(){return this.context.now()}}class Xe extends nt{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Pp()}static set A4(e){Fp(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:Xe.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const i=Lp[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?i:Xe.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,s){let i=1;return e&&e!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i*=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i*=this._beatsToUnits(parseFloat(s)/4)),i}}})}transpose(e){return new Xe(this.context,this.valueOf()*so(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return Bt(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/Xe.A4);let s=Math.round(12*t)+57;const i=Math.floor(s/12);return i<0&&(s+=-12*i),Vp[s%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return io(e)}static ftom(e){return Bt(e)}}const Lp={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},Vp=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class as extends nt{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Pe extends St{constructor(){super();const e=te(Pe.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:He()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return _p(e),new nt(this.context,e).toSeconds()}toFrequency(e){return new Xe(this.context,e).toFrequency()}toTicks(e){return new as(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(s=>{Je(e[s])&&delete t[s]}),t}get(){const e=Cp(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const s=this[t];se(s)&&se(s.value)&&se(s.setValueAtTime)?e[t]=s.value:s instanceof Pe?e[t]=s._getPartialProperties(e[t]):Ge(s)||mt(s)||xt(s)||zr(s)?e[t]=s:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&se(this[t])&&(this[t]&&se(this[t].value)&&se(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Pe?this[t].set(e[t]):this[t]=e[t])}),this}}class Ws extends Qe{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,s){return Et(t,0),this.add(Object.assign({},s,{state:e,time:t})),this}getLastState(e,t){const s=this._search(t);for(let i=s;i>=0;i--){const r=this._timeline[i];if(r.state===e)return r}}getNextState(e,t){const s=this._search(t);if(s!==-1)for(let i=s;i<this._timeline.length;i++){const r=this._timeline[i];if(r.state===e)return r}}}class _e extends Pe{constructor(){const e=te(_e.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,K(se(e.param)&&(zt(e.param)||e.param instanceof _e),"param must be an AudioParam");!zt(e.param);)e.param=e.param._param;this._swappable=se(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new Qe(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,se(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Pe.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return se(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return se(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return se(this.maxValue)&&se(this.minValue)&&Et(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?Rp(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?Op(e):e}setValueAtTime(e,t){const s=this.toSeconds(t),i=this._fromType(e);return K(isFinite(i)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,s),this._events.add({time:s,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,s),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),s=this._events.getAfter(t),i=this._events.get(t);let r=this._initialValue;if(i===null)r=this._initialValue;else if(i.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const o=this._events.getBefore(i.time);let l;o===null?l=this._initialValue:l=o.value,i.type==="setTargetAtTime"&&(r=this._exponentialApproach(i.time,l,i.value,i.constant,t))}else if(s===null)r=i.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let o=i.value;if(i.type==="setTargetAtTime"){const l=this._events.getBefore(i.time);l===null?o=this._initialValue:o=l.value}s.type==="linearRampToValueAtTime"?r=this._linearInterpolate(i.time,o,s.time,s.value,t):r=this._exponentialInterpolate(i.time,o,s.time,s.value,t)}else r=i.value;return this._toType(r)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const s=this._fromType(e),i=this.toSeconds(t);return K(isFinite(s)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this._events.add({time:i,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(s,i),this}exponentialRampToValueAtTime(e,t){let s=this._fromType(e);s=st(s,0)?this._minOutput:s,this._assertRange(s);const i=this.toSeconds(t);return K(isFinite(s)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(s,i),this}exponentialRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(e,s+this.toSeconds(t)),this}linearRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(e,s+this.toSeconds(t)),this}targetRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(e,s,t),this}exponentialApproachValueAtTime(e,t,s){t=this.toSeconds(t),s=this.toSeconds(s);const i=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+s*.9),this.linearRampToValueAtTime(e,t+s),this}setTargetAtTime(e,t,s){const i=this._fromType(e);K(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(t);return this._assertRange(i),K(isFinite(i)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:s,time:r,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,r,s),this._param.setTargetAtTime(i,r,s),this}setValueCurveAtTime(e,t,s,i=1){s=this.toSeconds(s),t=this.toSeconds(t);const r=this._fromType(e[0])*i;this.setValueAtTime(this._toType(r),t);const o=s/(e.length-1);for(let l=1;l<e.length;l++){const c=this._fromType(e[l])*i;this.linearRampToValueAtTime(this._toType(c),t+l*o)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return K(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),s=this._fromType(this.getValueAtTime(t));K(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+s);const i=this._events.get(t),r=this._events.getAfter(t);return i&&st(i.time,t)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),t):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),t)),this._events.add({time:t,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,t),this}rampTo(e,t=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,s):this.linearRampTo(e,t,s),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const s=this._events.get(t);if(s&&s.type==="setTargetAtTime"){const i=this._events.getAfter(s.time),r=i?i.time:t+2,o=(r-t)/10;for(let l=t;l<r;l+=o)e.linearRampToValueAtTime(this.getValueAtTime(l),l)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?e.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?e.setTargetAtTime(i.value,i.time,i.constant):e[i.type](i.value,i.time)}),this}setParam(e){K(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,s,i,r){return s+(t-s)*Math.exp(-(r-e)/i)}_linearInterpolate(e,t,s,i,r){return t+(i-t)*((r-e)/(s-e))}_exponentialInterpolate(e,t,s,i,r){return t*Math.pow(i/t,(r-e)/(s-e))}}class ne extends Pe{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return se(this.input)?zt(this.input)||this.input instanceof _e?1:this.input.numberOfInputs:0}get numberOfOutputs(){return se(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return se(e)&&(e instanceof ne||Mt(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(s=>{s.channelCount=e.channelCount,s.channelCountMode=e.channelCountMode,s.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();K(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,s=0){return ys(this,e,t,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Tn("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,s=0){return qp(this,e,t,s),this}chain(...e){return mi(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),se(this.input)&&(this.input instanceof ne?this.input.dispose():Mt(this.input)&&this.input.disconnect()),se(this.output)&&(this.output instanceof ne?this.output.dispose():Mt(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function mi(...n){const e=n.shift();n.reduce((t,s)=>(t instanceof ne?t.connect(s):Mt(t)&&ys(t,s),s),e)}function ys(n,e,t=0,s=0){for(K(se(n),"Cannot connect from undefined node"),K(se(e),"Cannot connect to undefined node"),(e instanceof ne||Mt(e))&&K(e.numberOfInputs>0,"Cannot connect to node with no inputs"),K(n.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof ne||e instanceof _e;)se(e.input)&&(e=e.input);for(;n instanceof ne;)se(n.output)&&(n=n.output);zt(e)?n.connect(e,t):n.connect(e,t,s)}function qp(n,e,t=0,s=0){if(se(e))for(;e instanceof ne;)e=e.input;for(;!Mt(n);)se(n.output)&&(n=n.output);zt(e)?n.disconnect(e,t):Mt(e)?n.disconnect(e,t,s):n.disconnect()}class Fe extends ne{constructor(){const e=te(Fe.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new _e({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),we(this,"gain")}static getDefaults(){return Object.assign(ne.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class ls extends ne{constructor(e){super(e),this.onended=re,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Fe({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const s=this.toSeconds(t);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(ne.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:re})}_startGain(e,t=1){K(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=e+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+s):this._gainNode.gain.exponentialApproachValueAtTime(t,e,s)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){K(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==re&&(this.onended(this),this.onended=re,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),K(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=re,this}}class Fi extends ls{constructor(){const e=te(Fi.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),ys(this._source,this._gainNode),this.offset=new _e({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(ls.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Re extends ne{constructor(){const e=te(Re.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Fi({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ne.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,s=0){return Li(this,e,t,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,s){return this._param.exponentialRampTo(e,t,s),this}linearRampTo(e,t,s){return this._param.linearRampTo(e,t,s),this}targetRampTo(e,t,s){return this._param.targetRampTo(e,t,s),this}exponentialApproachValueAtTime(e,t,s){return this._param.exponentialApproachValueAtTime(e,t,s),this}setTargetAtTime(e,t,s){return this._param.setTargetAtTime(e,t,s),this}setValueCurveAtTime(e,t,s,i){return this._param.setValueCurveAtTime(e,t,s,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,s){return this._param.rampTo(e,t,s),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Li(n,e,t,s){(e instanceof _e||zt(e)||e instanceof Re&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof Re&&(e.overridden=!0)),ys(n,e,t,s)}class Vi extends _e{constructor(){const e=te(Vi.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new Qe(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(_e.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,s){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),r=this._events.get(t),o=Math.round(Math.max(1/s,1));for(let l=0;l<=o;l++){const c=s*l+t,u=this._exponentialApproach(r.time,r.value,i,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}setValueAtTime(e,t){const s=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(s),r=this._events.previousEvent(i),o=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(o,0),this}linearRampToValueAtTime(e,t){const s=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(s),r=this._events.previousEvent(i),o=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const s=this._fromType(e),i=this._events.get(t),r=Math.round(Math.max((t-i.time)*10,1)),o=(t-i.time)/r;for(let l=0;l<=r;l++){const c=o*l+i.time,u=this._exponentialInterpolate(i.time,i.value,t,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Je(e.ticks)){const o=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(o,e.time)}const s=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const r=this._events.get(t);return r&&r.time===t&&r.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(s+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),s=this._events.get(t);return Math.max(this._getTicksUntilEvent(s,t),0)}getDurationOfTicks(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-s}getTimeOfTick(e){const t=this._events.get(e,"ticks"),s=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&s&&s.type==="linearRampToValueAtTime"&&t.value!==s.value){const i=this._fromType(this.getValueAtTime(t.time)),o=(this._fromType(this.getValueAtTime(s.time))-i)/(s.time-t.time),l=Math.sqrt(Math.pow(i,2)-2*o*(t.ticks-e)),c=(-i+l)/o,u=(-i-l)/o;return(c>0?c:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const s=this.toSeconds(t),i=this.toSeconds(e),r=this.getTicksAtTime(s);return this.getTicksAtTime(s+i)-r}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class qi extends Re{constructor(){const e=te(qi.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Vi({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(Re.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class Wi extends Pe{constructor(){const e=te(Wi.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new Ws,this._tickOffset=new Qe,this._ticksAtTime=new Qe,this._secondsAtTime=new Qe,this.frequency=new qi({context:this.context,units:e.units,value:e.frequency}),we(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Pe.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const s=this.toSeconds(e);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),se(t)&&this.setTicksAtTime(t,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const s=this._state.get(t);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),s=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),r={state:"paused",time:t};this._state.add(r);let o=i||s,l=i?i.ticks:0,c=null;return this._state.forEachBetween(o.time,t+this.sampleTime,u=>{let h=o.time;const d=this._tickOffset.get(u.time);d&&d.time>=o.time&&(l=d.ticks,h=d.time),o.state==="started"&&u.state!=="started"&&(l+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(h),u.time!==r.time&&(c={state:u.state,time:u.time,ticks:l})),o=u}),this._state.remove(r),c&&this._ticksAtTime.add(c),l}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),s=this.frequency.timeToTicks(e,t);this.setTicksAtTime(s,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),s={state:"paused",time:e};this._state.add(s);const i=this._secondsAtTime.get(e);let r=i||t,o=i?i.seconds:0,l=null;return this._state.forEachBetween(r.time,e+this.sampleTime,c=>{let u=r.time;const h=this._tickOffset.get(c.time);h&&h.time>=r.time&&(o=h.seconds,u=h.time),r.state==="started"&&c.state!=="started"&&(o+=c.time-u,c.time!==s.time&&(l={state:c.state,time:c.time,seconds:o})),r=c}),this._state.remove(s),l&&this._secondsAtTime.add(l),o}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const s=this._tickOffset.get(t),i=this._state.get(t),r=Math.max(s.time,i.time),o=this.frequency.getTicksAtTime(r)+e-s.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(e,t,s){let i=this._state.get(e);this._state.forEachBetween(e,t,o=>{i&&i.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(i.time,e),o.time-this.sampleTime,s),i=o});let r=null;if(i&&i.state==="started"){const o=Math.max(i.time,e),l=this.frequency.getTicksAtTime(o),c=this.frequency.getTicksAtTime(i.time),u=l-c;let h=Math.ceil(u)-u;h=st(h,1)?0:h;let d=this.frequency.getTimeOfTick(l+h);for(;d<t;){try{s(d,Math.round(this.getTicksAtTime(d)))}catch(g){r=g;break}d+=this.frequency.getDurationOfTicks(1,d)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class An extends Pe{constructor(){const e=te(An.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=re,this._lastUpdate=0,this._state=new Ws("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new Wi({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,we(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Pe.getDefaults(),{callback:re,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){Yr(this.context);const s=this.toSeconds(e);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,t),s<this._lastUpdate&&this.emit("start",s,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(i+e,s)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,s=>{switch(s.state){case"started":const i=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,i);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(e,t,(s,i)=>{this.callback(s,i)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Vs.mixin(An);class bs extends ne{constructor(){const e=te(bs.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new Fe({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,we(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Bi extends ne{constructor(){const e=te(Bi.getDefaults(),arguments);super(e),this.name="Destination",this.input=new bs({context:this.context}),this.output=new Fe({context:this.context}),this.volume=this.input.volume,mi(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),mi(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}jn(n=>{n.destination=new Bi({context:n})});kn(n=>{n.destination.dispose()});class Wp extends ne{constructor(){super(...arguments),this.name="Listener",this.positionX=new _e({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new _e({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new _e({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new _e({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new _e({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new _e({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new _e({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new _e({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new _e({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ne.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}jn(n=>{n.listener=new Wp({context:n})});kn(n=>{n.listener.dispose()});class Ui extends St{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=te(Ui.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const s=e.urls[t];this.add(t,s,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:re,onload:re,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return K(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,s=re,i=re){return xt(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new fe(this.baseUrl+t,s,i))):this._buffers.set(e.toString(),new fe(t,s,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class mn extends Xe{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return Bt(super._frequencyToUnits(e))}_ticksToUnits(e){return Bt(super._ticksToUnits(e))}_beatsToUnits(e){return Bt(super._beatsToUnits(e))}_secondsToUnits(e){return Bt(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return io(this.toMidi())}transpose(e){return new mn(this.context,this.toMidi()+e)}}class Ae extends as{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class Bp extends Pe{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new Qe,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}jn(n=>{n.draw=new Bp({context:n})});kn(n=>{n.draw.dispose()});class Up extends St{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){K(se(e.time),"Events must have a time property"),K(se(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new Gp(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const s of t)if(s.event===e){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let s,i=null;if(t>0)if(e.left.right===null)s=e.left,s.right=e.right,i=s;else{for(s=e.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,i=s.parent,s.left=e.left,s.right=e.right)}else if(e.right.left===null)s=e.right,s.left=e.left,i=s;else{for(s=e.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,i=s.parent,s.left=e.left,s.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=s:e.parent.right=s:this._setRoot(s),i&&this._rebalance(i)}e.dispose()}_rotateLeft(e){const t=e.parent,s=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,s=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let s=t[0];for(let i=1;i<t.length;i++)t[i].low>s.low&&(s=t[i]);return s.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(s=>t.push(s)),t.forEach(s=>{s.event&&e(s.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const s=[];this._root.search(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}forEachFrom(e,t){if(this._root!==null){const s=[];this._root.searchAfter(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class Gp{constructor(e,t,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class $p extends St{constructor(e){super(),this.name="TimelineValue",this._timeline=new Qe({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class us extends ne{constructor(){super(te(us.getDefaults(),arguments,["context"]))}connect(e,t=0,s=0){return Li(this,e,t,s),this}}class Bs extends us{constructor(){const e=te(Bs.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Ge(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):vp(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(Re.getDefaults(),{length:1024})}setMap(e,t=1024){const s=new Float32Array(t);for(let i=0,r=t;i<r;i++){const o=i/(r-1)*2-1;s[i]=e(o,i)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(s=>s.includes(e));K(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Gi extends us{constructor(){const e=te(Gi.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new Bs({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(us.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class It{constructor(e,t){this.id=It._eventId++,this._remainderTime=0;const s=Object.assign(It.getDefaults(),t);this.transport=e,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:re,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}It._eventId=0;class $i extends It{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign($i.getDefaults(),t);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},It.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return dn(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ae(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){dn(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ae(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);cs(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Mn extends Pe{constructor(){const e=te(Mn.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new $p(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new Qe,this._repeatedEvents=new Up,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new An({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),we(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Pe.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const s=t%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(s*Math.PI)*this._swingAmount;e+=new Ae(this.context,this._swingTicks*2/3).toSeconds()*i}Ra(!0),this._timeline.forEachAtTime(t,s=>s.invoke(e)),Ra(!1)}schedule(e,t){const s=new It(this,{callback:e,time:new as(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(e,t,s,i=1/0){const r=new $i(this,{callback:e,duration:new nt(this.context,i).toTicks(),interval:new nt(this.context,t).toTicks(),time:new as(this.context,s).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(e,t){const s=new It(this,{callback:e,once:!0,time:new as(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(t,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new Ae(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let s;return se(t)&&(s=this.toTicks(t)),this._clock.start(e,s),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){Ge(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new nt(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new nt(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new Ae(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new Ae(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),s=this._clock.frequency.timeToTicks(e,t);this.ticks=s}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(t),i=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,t),r=t+i;this.emit("stop",r),this._clock.setTicksAtTime(e,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),s=this.getTicksAtTime(t),i=e-s%e;return this._clock.nextTickTime(i,t)}}syncSignal(e,t){const s=this.now();let i=this.bpm,r=1/(60/i.getValueAtTime(s)/this.PPQ),o=[];if(e.units==="time"){const c=.015625/r,u=new Fe(c),h=new Gi(-1),d=new Fe(c);i.chain(u,h,d),i=d,r=1/r,o=[u,h,d]}t||(e.getValueAtTime(s)!==0?t=e.getValueAtTime(s)/r:t=0);const l=new Fe(t);return i.connect(l),l.connect(e._param),o.push(l),this._syncedSignals.push({initial:e.value,nodes:o,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const s=this._syncedSignals[t];s.signal===e&&(s.nodes.forEach(i=>i.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),Qr(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Vs.mixin(Mn);jn(n=>{n.transport=new Mn({context:n})});kn(n=>{n.transport.dispose()});class Ze extends ne{constructor(e){super(e),this.input=void 0,this._state=new Ws("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=re,this._syncedStop=re,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new bs({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,we(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,onstop:re,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,s){let i=Je(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")K(cs(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,s);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const r=this._state.get(i);r&&(r.offset=this.toSeconds(ht(t,0)),r.duration=s?this.toSeconds(s):void 0);const o=this.context.transport.schedule(l=>{this._start(l,t,s)},i);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else Yr(this.context),this._start(i,t,s);return this}stop(e){let t=Je(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||se(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const s=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(s)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,s){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(cs(t,0)){const s=this._state.get(t);if(s&&s.state==="started"&&s.time!==t){const i=t-this.toSeconds(s.time);let r;s.duration&&(r=this.toSeconds(s.duration)-i),this._start(e,this.toSeconds(s.offset)+i,r)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=re,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class En extends ls{constructor(){const e=te(En.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,ys(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new _e({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new fe(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(ls.getDefaults(),{url:new fe,loop:!1,loopEnd:0,loopStart:0,onload:re,onerror:re,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,s,i=1){K(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(e);this._startGain(r,i),this.loop?t=ht(t,this.loopStart):t=ht(t,0);let o=Math.max(this.toSeconds(t),0);if(this.loop){const l=this.toSeconds(this.loopEnd)||this.buffer.duration,c=this.toSeconds(this.loopStart),u=l-c;di(o,l)&&(o=(o-c)%u+c),st(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,dn(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,o)),se(s)){let l=this.toSeconds(s);l=Math.max(l,0),this.stop(r+l)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function Zt(n,e){return ke(this,void 0,void 0,function*(){const t=e/n.context.sampleRate,s=new Oi(1,t,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/t,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class zi extends ls{constructor(){const e=te(zi.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],ys(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new _e({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new _e({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),we(this,["frequency","detune"])}static getDefaults(){return Object.assign(ls.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class je extends Ze{constructor(){const e=te(je.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new Re({context:this.context,units:"frequency",value:e.frequency}),we(this,"frequency"),this.detune=new Re({context:this.context,units:"cents",value:e.detune}),we(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),s=new zi({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return je._periodicWaveCache.find(t=>t.phase===this._phase&&kp(t.partials,this._partials));{const e=je._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const s=this._getCachedPeriodicWave();if(se(s)){const{partials:i,wave:r}=s;this._wave=r,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,r]=this._getRealImaginary(e,this._phase),o=this.context.createPeriodicWave(i,r);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),je._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),je._periodicWaveCache.length>100&&je._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Et(e,0);let t=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(t=s[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const i=new Float32Array(e);this._partials.forEach((r,o)=>i[o]=r),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(e,t){let i=2048;const r=new Float32Array(i),o=new Float32Array(i);let l=1;if(e==="custom"){if(l=this._partials.length+1,this._partialCount=this._partials.length,i=l,this._partials.length===0)return[r,o]}else{const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);c?(l=parseInt(c[2],10)+1,this._partialCount=parseInt(c[2],10),e=c[1],l=Math.max(l,2),i=l):this._partialCount=0,this._partials=[]}for(let c=1;c<i;++c){const u=2/(c*Math.PI);let h;switch(e){case"sine":h=c<=l?1:0,this._partials[c-1]=h;break;case"square":h=c&1?2*u:0,this._partials[c-1]=h;break;case"sawtooth":h=u*(c&1?1:-1),this._partials[c-1]=h;break;case"triangle":c&1?h=2*(u*u)*(c-1>>1&1?-1:1):h=0,this._partials[c-1]=h;break;case"custom":h=this._partials[c-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}h!==0?(r[c]=-h*Math.sin(t*c),o[c]=h*Math.cos(t*c)):(r[c]=0,o[c]=0)}return[r,o]}_inverseFFT(e,t,s){let i=0;const r=e.length;for(let o=0;o<r;o++)i+=e[o]*Math.cos(o*s)+t[o]*Math.sin(o*s);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let s=0;const i=Math.PI*2,r=32;for(let o=0;o<r;o++)s=Math.max(this._inverseFFT(e,t,o/r*i),s);return Ap(-this._inverseFFT(e,t,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}je._periodicWaveCache=[];class zp extends us{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Bs({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class hs extends Re{constructor(){const e=te(hs.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Fe({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Re.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class In extends Ze{constructor(){const e=te(In.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new zp({context:this.context}),this._modulationNode=new Fe({context:this.context}),this._carrier=new je({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new je({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new hs({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),we(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(je.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Dn extends Ze{constructor(){const e=te(Dn.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new Fe({context:this.context,gain:0}),this._carrier=new je({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new Re({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new je({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new hs({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new hs({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),we(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(je.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Us extends Ze{constructor(){const e=te(Us.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new Fe({context:this.context,gain:0}),this._thresh=new Bs({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new Re({context:this.context,units:"audioRange",value:e.width}),this._triangle=new je({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),we(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Rn extends Ze{constructor(){const e=te(Rn.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new Re({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Re({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,we(this,["frequency","detune"])}static getDefaults(){return Object.assign(je.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,s=e/(this._oscillators.length-1);this._forEach((i,r)=>i.detune.value=t+s*r)}}get count(){return this._oscillators.length}set count(e){if(Et(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const s=new je({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):re});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[t]=s}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,s)=>t.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class On extends Ze{constructor(){const e=te(On.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new hs({context:this.context,value:2}),this._pulse=new Us({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new je({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),we(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Oa={am:In,fat:Rn,fm:Dn,oscillator:je,pulse:Us,pwm:On};class pn extends Ze{constructor(){const e=te(pn.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new Re({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Re({context:this.context,units:"cents",value:e.detune}),we(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(je.getDefaults(),Dn.getDefaults(),In.getDefaults(),Rn.getDefaults(),Us.getDefaults(),On.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=Oa[e],s=this.now();if(this._oscillator){const i=this._oscillator;i.stop(s),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof Oa[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&mt(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&mt(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&xt(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Zt(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function ao(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Et(r,n,e),t.set(this,r)}})}}function Tt(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Et(this.toSeconds(r),n,e),t.set(this,r)}})}}class Pn extends Ze{constructor(){const e=te(Pn.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new fe({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(Ze.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:re,onerror:re,playbackRate:1,reverse:!1})}load(e){return ke(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=re){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,s){return super.start(e,t,s),this}_start(e,t,s){this._loop?t=ht(t,this._loopStart):t=ht(t,0);const i=this.toSeconds(t),r=s;s=ht(s,Math.max(this._buffer.duration-i,0));let o=this.toSeconds(s);o=o/this._playbackRate,e=this.toSeconds(e);const l=new En({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+o),this._state.setStateAtTime("stopped",e+o,{implicitEnd:!0})),this._activeSources.add(l),this._loop&&Je(r)?l.start(e,i):l.start(e,i,o-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(s=>s.stop(t))}restart(e,t,s){return super.restart(e,t,s),this}_restart(e,t,s){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(e),this._start(e,t,s)}seek(e,t){const s=this.toSeconds(t);if(this._state.getValueAtTime(s)==="started"){const i=this.toSeconds(e);this._stop(s),this._start(s,i)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Et(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Et(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),s=this._state.getNextState("stopped",t);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}ot([Tt(0)],Pn.prototype,"fadeIn",void 0);ot([Tt(0)],Pn.prototype,"fadeOut",void 0);class Vt extends ne{constructor(){const e=te(Vt.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new Re({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(ne.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(xt(e))return e;{let s;for(s in Xs)if(Xs[s][t]===e)return s;return e}}_setCurve(e,t,s){if(xt(s)&&Reflect.has(Xs,s)){const i=Xs[s];At(i)?e!=="_decayCurve"&&(this[e]=i[t]):this[e]=i}else if(Ge(s)&&e!=="_decayCurve")this[e]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let i=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),o=this.getValueAtTime(e);if(o>0){const l=1/i;i=(1-o)/l}if(i<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,i,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,i,e);else{this._sig.cancelAndHoldAtTime(e);let l=this._attackCurve;for(let c=1;c<l.length;c++)if(l[c-1]<=o&&o<=l[c]){l=this._attackCurve.slice(c),l[0]=o;break}this._sig.setValueCurveAtTime(l,e,i,t)}if(r&&this.sustain<1){const l=t*this.sustain,c=e+i;this.log("decay",c),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(l,r+c):this._sig.exponentialApproachValueAtTime(l,c,r)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,e):(K(Ge(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,s,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,s=1){return t=this.toSeconds(t),this.triggerAttack(t,s),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,s=0){return Li(this,e,t,s),this}asArray(){return ke(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,s=new Oi(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=i+this.toSeconds(this.release),o=r*.1,l=r+o,c=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/l,decay:t*this.toSeconds(this.decay)/l,release:t*this.toSeconds(this.release)/l,context:s}));return c._sig.toDestination(),c.triggerAttackRelease(t*(i+o)/l,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}ot([Tt(0)],Vt.prototype,"attack",void 0);ot([Tt(0)],Vt.prototype,"decay",void 0);ot([ao(0,1)],Vt.prototype,"sustain",void 0);ot([Tt(0)],Vt.prototype,"release",void 0);const Xs=(()=>{let e,t;const s=[];for(e=0;e<128;e++)s[e]=Math.sin(e/127*(Math.PI/2));const i=[],r=6.4;for(e=0;e<127;e++){t=e/127;const g=Math.sin(t*(Math.PI*2)*r-Math.PI/2)+1;i[e]=g/10+t*.83}i[127]=1;const o=[],l=5;for(e=0;e<128;e++)o[e]=Math.ceil(e/127*l)/l;const c=[];for(e=0;e<128;e++)t=e/127,c[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const g=Math.pow(t,3)*4+.2,f=Math.cos(g*Math.PI*2*t);u[e]=Math.abs(f*(1-t))}function h(g){const f=new Array(g.length);for(let m=0;m<g.length;m++)f[m]=1-g[m];return f}function d(g){return g.slice(0).reverse()}return{bounce:{In:h(u),Out:u},cosine:{In:s,Out:d(s)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:h(i)},sine:{In:c,Out:h(c)},step:{In:o,Out:h(o)}}})();class Dt extends ne{constructor(){const e=te(Dt.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new bs({context:this.context,volume:e.volume}),this.volume=this._volume.volume,we(this,"volume")}static getDefaults(){return Object.assign(ne.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const s=this["_original_"+e]=this[e];this[e]=(...i)=>{const r=i[t],o=this.context.transport.schedule(l=>{i[t]=l,s.apply(this,i)},r);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,s,i){const r=this.toSeconds(s),o=this.toSeconds(t);return this.triggerAttack(e,r,i),this.triggerRelease(r+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class Yt extends Dt{constructor(){const e=te(Yt.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(Dt.getDefaults(),{detune:0,onsilence:re,portamento:0})}triggerAttack(e,t,s=1){this.log("triggerAttack",e,t,s);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,s),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const s=this.toSeconds(t),i=e instanceof Xe?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,r,s)}else this.frequency.setValueAtTime(i,s);return this}}ot([Tt(0)],Yt.prototype,"portamento",void 0);class Yi extends Vt{constructor(){super(te(Yi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Fe({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class ds extends Yt{constructor(){const e=te(ds.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new pn(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Yi(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),we(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(Yt.getDefaults(),{envelope:Object.assign(hi(Vt.getDefaults(),Object.keys(ne.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(hi(pn.getDefaults(),[...Object.keys(Ze.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+s+i)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Fn extends ds{constructor(){const e=te(Fn.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,we(this,["oscillator","envelope"])}static getDefaults(){return Ut(Yt.getDefaults(),ds.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const s=this.toSeconds(t),i=this.toFrequency(e instanceof Xe?e.toFrequency():e),r=i*this.octaves;return this.oscillator.frequency.setValueAtTime(r,s),this.oscillator.frequency.exponentialRampToValueAtTime(i,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}ot([ao(0)],Fn.prototype,"octaves",void 0);ot([Tt(0)],Fn.prototype,"pitchDecay",void 0);const ro=new Set;function Hi(n){ro.add(n)}function oo(n,e){const t=`registerProcessor("${n}", ${e})`;ro.add(t)}const Yp=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Hi(Yp);const Hp=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Hi(Hp);const Xp=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Hi(Xp);const Jp="feedback-comb-filter",Zp=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;oo(Jp,Zp);class Xi extends Dt{constructor(){const e=te(Xi.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=i=>this.releaseAll(i),K(!mt(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Dt.getDefaults(),{maxPolyphony:32,options:{},voice:ds})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(s=>s.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return K(e instanceof Yt,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else Tn("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,s){e.forEach(i=>{const r=new mn(this.context,i).toMidi(),o=this._getNextAvailableVoice();o&&(o.triggerAttack(i,t,s),this._activeVoices.push({midi:r,voice:o,released:!1}),this.log("triggerAttack",i,t))})}_triggerRelease(e,t){e.forEach(s=>{const i=new mn(this.context,s).toMidi(),r=this._activeVoices.find(({midi:o,released:l})=>o===i&&!l);r&&(r.voice.triggerRelease(t),r.released=!0,this.log("triggerRelease",s,t))})}_scheduleEvent(e,t,s,i){K(!this.disposed,"Synth was already disposed"),s<=this.now()?e==="attack"?this._triggerAttack(t,s,i):this._triggerRelease(t,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,s,i)},s-this.now())}triggerAttack(e,t,s){Array.isArray(e)||(e=[e]);const i=this.toSeconds(t);return this._scheduleEvent("attack",e,i,s),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const s=this.toSeconds(t);return this._scheduleEvent("release",e,s),this}triggerAttackRelease(e,t,s,i){const r=this.toSeconds(s);if(this.triggerAttack(e,r,i),Ge(t)){K(Ge(e),"If the duration is an array, the notes must also be an array"),e=e;for(let o=0;o<e.length;o++){const l=t[Math.min(o,t.length-1)],c=this.toSeconds(l);K(c>0,"The duration must be greater than 0"),this.triggerRelease(e[o],r+c)}}else{const o=this.toSeconds(t);K(o>0,"The duration must be greater than 0"),this.triggerRelease(e,r+o)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=hi(e,["onsilence","context"]);return this.options=Ut(this.options,t),this._voices.forEach(s=>s.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Ln extends Dt{constructor(){const e=te(Ln.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(s=>{const i=parseInt(s,10);if(K(Hs(s)||mt(i)&&isFinite(i),`url key is neither a note or midi pitch: ${s}`),Hs(s)){const r=new Xe(this.context,s).toMidi();t[r]=e.urls[s]}else mt(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new Ui({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(Dt.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:re,onerror:re,release:.1,urls:{}})}_findClosest(e){let s=0;for(;s<96;){if(this._buffers.has(e+s))return-s;if(this._buffers.has(e-s))return s;s++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,s=1){return this.log("triggerAttack",e,t,s),Array.isArray(e)||(e=[e]),e.forEach(i=>{const r=no(new Xe(this.context,i).toFrequency()),o=Math.round(r),l=r-o,c=this._findClosest(o),u=o-c,h=this._buffers.get(u),d=so(c+l),g=new En({url:h,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:d}).connect(this.output);g.start(t,0,h.duration/d,s),Ge(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(g),g.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),m=f.indexOf(g);m!==-1&&f.splice(m,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(s=>{const i=new Xe(this.context,s).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const r=this._activeSources.get(i);t=this.toSeconds(t),r.forEach(o=>{o.stop(t)}),this._activeSources.set(i,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,s,i=1){const r=this.toSeconds(s);return this.triggerAttack(e,r,i),Ge(t)?(K(Ge(e),"notes must be an array when duration is array"),e.forEach((o,l)=>{const c=t[Math.min(l,t.length-1)];this.triggerRelease(o,r+this.toSeconds(c))})):this.triggerRelease(e,r+this.toSeconds(t)),this}add(e,t,s){if(K(Hs(e)||isFinite(e),`note must be a pitch or midi: ${e}`),Hs(e)){const i=new Xe(this.context,e).toMidi();this._buffers.add(i,t,s)}else this._buffers.add(e,t,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}ot([Tt(0)],Ln.prototype,"attack",void 0);ot([Tt(0)],Ln.prototype,"release",void 0);class ss extends Pe{constructor(){const e=te(ss.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new Ws("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Pe.getDefaults(),{callback:re,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let s;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const i=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||mt(this._loop)&&this._loop>1){s=1/0,mt(this._loop)&&(s=this._loop*this._getLoopDuration());const r=this._state.getAfter(i);r!==null&&(s=Math.min(s,r.time-i)),s!==1/0&&(s=new Ae(this.context,s));const o=new Ae(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),o,new Ae(this.context,i),s)}else t.id=this.context.transport.schedule(this._tick.bind(this),new Ae(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const s=this._state.getBefore(t);let i=t;s!==null&&(i=s.time),this._rescheduleEvents(i)}return this}cancel(e){e=ht(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,s=>{this.context.transport.clear(s.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;zr(this.humanize)||(s=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*s}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new Ae(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new Ae(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const s=this._getLoopDuration();return(e-t.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class fn extends ss{constructor(){const e=te(fn.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new Ws("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{Ge(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(ss.getDefaults(),{events:[]})}start(e,t){const s=this.toTicks(e);if(this._state.getValueAtTime(s)!=="started"){t=ht(t,this._loop?this._loopStart:0),this._loop?t=ht(t,this._loopStart):t=ht(t,0);const i=this.toTicks(t);this._state.add({id:-1,offset:i,state:"started",time:s}),this._forEach(r=>{this._startNote(r,s,i)})}return this}_startNote(e,t,s){t-=s,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<s&&(t+=this._getLoopDuration()),e.start(new Ae(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=s&&(e.loop=!1,e.start(new Ae(this.context,t))):e.startOffset>=s&&e.start(new Ae(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(s=>{s.stop(e)}),this}at(e,t){const s=new as(this.context,e).toTicks(),i=new Ae(this.context,1).toSeconds(),r=this._events.values();let o=r.next();for(;!o.done;){const l=o.value;if(Math.abs(s-l.startOffset)<i)return se(t)&&(l.value=t),l;o=r.next()}return se(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const s=this.toTicks(e);let i;return t instanceof ss?(i=t,i.callback=this._tick.bind(this)):i=new ss({callback:this._tick.bind(this),context:this.context,value:t}),i.startOffset=s,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new Ae(this.context,t.time))})}remove(e,t){return At(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(s=>{s.startOffset===e&&(Je(t)||se(t)&&s.value===t)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof fn?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(s=>{s[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new Ae(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new Ae(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class Ji extends ne{constructor(){const e=te(Ji.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new _e({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",we(this,"pan")}static getDefaults(){return Object.assign(ne.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const Kp="bit-crusher",Qp=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;oo(Kp,Qp);class Te extends ne{constructor(){const e=te(Te.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new Fe({context:this.context}),Te._allSolos.has(this.context)||Te._allSolos.set(this.context,new Set),Te._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(ne.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),Te._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){Te._soloed.has(this.context)||Te._soloed.set(this.context,new Set),Te._soloed.get(this.context).add(this)}_removeSolo(){Te._soloed.has(this.context)&&Te._soloed.get(this.context).delete(this)}_isSoloed(){return Te._soloed.has(this.context)&&Te._soloed.get(this.context).has(this)}_noSolos(){return!Te._soloed.has(this.context)||Te._soloed.has(this.context)&&Te._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),Te._allSolos.get(this.context).delete(this),this._removeSolo(),this}}Te._allSolos=new Map;Te._soloed=new Map;class Zi extends ne{constructor(){const e=te(Zi.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new Ji({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new bs({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,we(this,["pan","volume"])}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class ns extends ne{constructor(){const e=te(ns.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new Te({solo:e.solo,context:this.context}),this._panVol=this.output=new Zi({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),we(this,["pan","volume"])}static getDefaults(){return Object.assign(ne.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return ns.buses.has(e)||ns.buses.set(e,new Fe({context:this.context})),ns.buses.get(e)}send(e,t=0){const s=this._getBus(e),i=new Fe({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(s),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}ns.buses=new Map;He().transport;function vt(){return He().transport}He().destination;He().destination;function ef(){return He().destination}He().listener;He().draw;const tf=He();class sf{constructor(e={}){lt(this,"synth",null);lt(this,"part",null);lt(this,"isPlaying",!1);lt(this,"isPaused",!1);lt(this,"duration",0);lt(this,"options");lt(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);const i=this.parseMIDIToNotes(s);this.synth||(this.synth=new Xi(ds,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new fn((r,o)=>{this.synth?.triggerAttackRelease(o.name,o.duration,r,o.velocity)},i),this.duration=this.calculateDuration(i),this.part.loop=!1}catch(t){const s=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(s),s}}parseMIDIToNotes(e){const t=[],s=["C4","D4","E4","F4","G4","A4","B4","C5"];let i=0;for(let r=0;r<16;r++)t.push({time:`${i}`,name:s[r%s.length],duration:"4n",velocity:.7}),i+=.5;return t}calculateDuration(e){if(e.length===0)return 0;const t=e[e.length-1],s=parseFloat(t.time),r={"1n":2,"2n":1,"4n":.5,"8n":.25,"16n":.125}[t.duration]||.5;return s+r}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await to(),this.isPaused?(vt().start(),this.isPaused=!1):(this.part.start(0),vt().start()),this.isPlaying=!0,this.startProgressTracking(),vt().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(vt().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){vt().stop(),vt().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));vt().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:vt().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=vt().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let Zn=null;function nf(){return Zn||(Zn=new sf),Zn}const af=({album:n,isPlaying:e,currentTime:t,duration:s,onPlayPause:i,onExpand:r})=>{if(!n)return null;const o=s>0?Math.max(0,Math.min(1,t/s)):0,l=c=>{c.stopPropagation()};return a.jsxs("div",{className:"spotify-square-dock",role:"button",tabIndex:0,"aria-label":"プレイヤーを開く",onClick:r,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),r())},"data-no-swipe":!0,children:[a.jsx("img",{className:"spotify-square-dock-art",src:n.imageDataURL,alt:n.title||n.mood,draggable:!1}),a.jsx("div",{className:"spotify-square-dock-overlay","aria-hidden":"true"}),a.jsx("button",{className:"spotify-square-dock-play",onClick:c=>{l(c),i()},onMouseDown:l,onTouchStart:l,"aria-label":e?"一時停止":"再生",title:e?"一時停止":"再生",children:e?"⏸":"▶"}),a.jsx("div",{className:"spotify-square-dock-progress","aria-hidden":"true",children:a.jsx("div",{className:"spotify-square-dock-progressFill",style:{width:`${Math.round(o*100)}%`}})}),a.jsx("div",{className:"spotify-square-dock-hint","aria-hidden":"true",children:a.jsx("div",{className:"spotify-square-dock-title",children:n.title||n.mood})})]})},rf=({isPlaying:n,canPrevious:e,canNext:t,shuffle:s,repeat:i,onPlayPause:r,onPrevious:o,onNext:l,onShuffle:c,onRepeat:u,expanded:h=!1})=>{const d=()=>a.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:a.jsx("polygon",{points:"8,6 8,18 18,12"})}),g=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),a.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),f=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),a.jsx("polygon",{points:"18,6 10,12 18,18"})]}),m=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("polygon",{points:"6,6 14,12 6,18"}),a.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),p=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),a.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),_=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("path",{d:"M7 7h10v4"}),a.jsx("path",{d:"M17 17H7v-4"}),a.jsx("path",{d:"M17 7l3 3-3 3"}),a.jsx("path",{d:"M7 17l-3-3 3-3"})]});return a.jsxs("div",{className:`playback-controls ${h?"expanded":""}`,children:[h&&a.jsx("button",{className:`control-button secondary ${s?"active":""}`,onClick:c,"aria-label":"Shuffle",title:"Shuffle",children:a.jsx(p,{})}),a.jsx("button",{className:"control-button",onClick:o,disabled:!e,"aria-label":"Previous",title:"Previous track",children:a.jsx(f,{})}),a.jsx("button",{className:"control-button primary",onClick:r,"aria-label":n?"Pause":"Play",title:n?"Pause":"Play",children:n?a.jsx(g,{}):a.jsx(d,{})}),a.jsx("button",{className:"control-button",onClick:l,disabled:!t,"aria-label":"Next",title:"Next track",children:a.jsx(m,{})}),h&&a.jsxs("button",{className:`control-button secondary ${i!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${i}`,title:`Repeat: ${i}`,children:[a.jsx(_,{}),i==="one"&&a.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},of=({currentTime:n,duration:e,onSeek:t,color:s="#D4AF37"})=>{const[i,r]=x.useState(!1),o=x.useRef(null),l=f=>{if(!isFinite(f)||f<0)return"0:00";const m=Math.floor(f/60),p=Math.floor(f%60);return`${m}:${p.toString().padStart(2,"0")}`},c=f=>{if(!o.current||e===0)return;const m=o.current.getBoundingClientRect(),p=f-m.left,y=Math.max(0,Math.min(1,p/m.width))*e;t(y)},u=f=>{r(!0),c(f.clientX)},h=f=>{i&&c(f.clientX)},d=()=>{r(!1)};L.useEffect(()=>{if(i)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",d),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",d)}},[i]);const g=e>0?n/e*100:0;return a.jsxs("div",{className:"seek-bar-container",children:[a.jsx("span",{className:"seek-time current",children:l(n)}),a.jsx("div",{ref:o,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":n,children:a.jsx("div",{className:"seek-progress",style:{width:`${g}%`,background:`linear-gradient(90deg, ${s}cc, ${s})`},children:a.jsx("div",{className:"seek-thumb"})})}),a.jsx("span",{className:"seek-time total",children:l(e)})]})},cf=({volume:n,isMuted:e,onVolumeChange:t,onMuteToggle:s,expanded:i=!1})=>{const[r,o]=x.useState(!1),l=x.useRef(null),c=e||n===0?"muted":n<.5?"low":"high",u=m=>{if(!l.current)return;const p=l.current.getBoundingClientRect(),_=m-p.left,y=Math.max(0,Math.min(1,_/p.width));t(y)},h=m=>{o(!0),u(m.clientX)},d=m=>{r&&u(m.clientX)},g=()=>{o(!1)};L.useEffect(()=>{if(r)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",g),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",g)}},[r]);const f=e?0:n;return a.jsxs("div",{className:`volume-control ${i?"expanded":""}`,children:[a.jsxs("button",{className:`volume-icon ${c}`,onClick:s,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[a.jsx("span",{className:"volume-core"}),a.jsx("span",{className:"volume-wave wave-1"}),a.jsx("span",{className:"volume-wave wave-2"})]}),a.jsx("div",{ref:l,className:"volume-slider",onMouseDown:h,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(f*100),children:a.jsx("div",{className:"volume-fill",style:{width:`${f*100}%`},children:a.jsx("div",{className:"volume-thumb"})})})]})},lf=({queue:n,currentIndex:e,onSkipTo:t})=>{const s=n.slice(e+1,e+4);if(s.length===0)return null;const i=r=>{const o=Math.floor(r/60),l=Math.floor(r%60);return`${o}:${l.toString().padStart(2,"0")}`};return a.jsxs("div",{className:"queue-preview",children:[a.jsx("div",{className:"queue-label",children:"Up Next"}),a.jsx("div",{className:"queue-items",children:s.map((r,o)=>a.jsx("div",{className:"queue-item",onClick:()=>t(e+o+1),role:"button",tabIndex:0,onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t(e+o+1))},children:a.jsx(Gt,{variant:"compact",className:"queue-album-card",title:r.title||r.mood,mood:r.mood,imageUrl:r.imageDataURL,meta:i(r.musicMetadata?.duration||r.duration),badges:[...r.musicData?[{label:"再生",tone:"success"}]:[],...r.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...r.isPublic?[{label:"公開",tone:"info"}]:[]]})},r.id))})]})};class uf{static draw(e,t,s,i,r,o){const l=this.smoothData(t);this.drawGrid(e,s,i),e.lineWidth=3,e.strokeStyle=this.getGradient(e,r,s),e.shadowBlur=o?8:4,e.shadowColor=r,e.beginPath();const c=s/l.length;let u=0;for(let h=0;h<l.length;h++){const g=l[h]/128*i/2;if(h===0)e.moveTo(u,g);else{const f=(u+c*h)/2,m=(g+l[h-1]/128*i/2)/2;e.quadraticCurveTo(u,l[h-1]/128*i/2,f,m)}u=c*h}e.lineTo(s,i/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-i),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let i=0;i<e.length;i++){let r=0,o=0;for(let l=-3;l<=3;l++){const c=i+l;c>=0&&c<e.length&&(r+=e[c],o++)}t.push(r/o)}return t}static drawGrid(e,t,s){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const i=5;for(let r=0;r<i;r++){const o=s/(i-1)*r;e.beginPath(),e.moveTo(0,o),e.lineTo(t,o),e.stroke()}}static getGradient(e,t,s){const i=e.createLinearGradient(0,0,s,0);return i.addColorStop(0,t),i.addColorStop(.5,this.lightenColor(t,20)),i.addColorStop(1,t),i}static lightenColor(e,t){const s=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+i),o=Math.min(255,(s>>8&255)+i),l=Math.min(255,(s&255)+i);return`#${(r<<16|o<<8|l).toString(16).padStart(6,"0")}`}}class co{static draw(e,t,s,i,r,o){const d=(s-640)/2,g=Math.floor(t.length/64),f=[];for(let _=0;_<64;_++){let y=0;for(let S=0;S<g;S++){const E=_*g+S;E<t.length&&(y+=t[E])}const w=y/g;f.push(w)}const m=this.smoothTransitions(f),p=this.createBarGradient(e,r,64,10,d);for(let _=0;_<64;_++){const y=d+_*10,w=m[_]/255*(i*.4);e.fillStyle=p,this.drawRoundedBar(e,y,i/2-w,8,w,4),o&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,y,i/2+2,8,w*.5,4),e.restore()),e.shadowBlur=o?4:0,e.shadowColor=r}e.shadowBlur=0,o&&this.drawParticles(e,m,d,10,i,r)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],s=.7;for(let i=0;i<e.length;i++){const r=this.previousHeights[i]||0,o=e[i],l=r*s+o*(1-s);t.push(l)}return this.previousHeights=t,t}static drawRoundedBar(e,t,s,i,r,o){e.beginPath(),e.moveTo(t,s+r),e.lineTo(t,s+o),e.arcTo(t,s,t+i,s,o),e.lineTo(t+i,s+o),e.arcTo(t+i,s,t+i,s+r,o),e.lineTo(t+i,s+r),e.closePath(),e.fill()}static createBarGradient(e,t,s,i,r){const o=e.createLinearGradient(r,0,r+s*i,0);return o.addColorStop(0,t),o.addColorStop(.5,this.adjustHue(t,30)),o.addColorStop(1,this.adjustHue(t,60)),o}static drawParticles(e,t,s,i,r,o){for(let c=0;c<t.length;c++)if(t[c]>200){const u=s+c*i+i/2,h=t[c]/255*(r*.4),d=r/2-h-10;e.fillStyle=o,e.globalAlpha=.5,e.beginPath(),e.arc(u,d,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const s=parseInt(e.replace("#",""),16),i=s>>16&255,r=s>>8&255,o=s&255,l=1+t/360,c=Math.min(255,i*l),u=Math.min(255,r*l),h=Math.min(255,o*l);return`#${(Math.floor(c)<<16|Math.floor(u)<<8|Math.floor(h)).toString(16).padStart(6,"0")}`}}lt(co,"previousHeights",[]);class lo{static draw(e,t,s,i,r,o){const l=s/2,c=i/2,u=Math.min(s,i)*.15,h=Math.min(s,i)*.45;o&&(this.rotation+=360/(60*60));const d=Math.min(t.length,180),g=Math.PI*2/d;for(let f=0;f<d;f++){const m=t[Math.floor(f*(t.length/d))],p=m/255*(h-u),_=f*g+this.rotation*(Math.PI/180),y=l+Math.cos(_)*u,w=c+Math.sin(_)*u,S=l+Math.cos(_)*(u+p),E=c+Math.sin(_)*(u+p),b=f/d*360;if(e.strokeStyle=`hsla(${b}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(y,w),e.lineTo(S,E),e.stroke(),o&&m>200){const T=l+Math.cos(_)*(u+p+5),j=c+Math.sin(_)*(u+p+5);e.fillStyle=`hsla(${b}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(T,j,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.arc(l,c,u,0,Math.PI*2),e.stroke(),o){const f=this.getAverageAmplitude(t),m=h+f/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=r,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=r,e.beginPath(),e.arc(l,c,m,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let s=0;s<e.length;s++)t+=e[s];return t/e.length}}lt(lo,"rotation",0);const hf=({mode:n,frequencyData:e,timeDomainData:t,isPlaying:s,dominantColor:i="#D4AF37",width:r=800,height:o=200,mini:l=!1})=>{const c=x.useRef(null),u=x.useRef(null),h=x.useRef(0);return x.useEffect(()=>{const d=c.current;if(!d)return;const g=d.getContext("2d");if(!g)return;const f=l?1:Math.min(window.devicePixelRatio||1,2);d.width=r*f,d.height=o*f,d.style.width=`${r}px`,d.style.height=`${o}px`,g.scale(f,f);const p=1e3/(l?30:60),_=y=>{if(y-h.current<p){u.current=requestAnimationFrame(_);return}h.current=y,g.clearRect(0,0,r,o),n==="waveform"&&t?uf.draw(g,t,r,o,i,s):n==="spectrum"&&e?co.draw(g,e,r,o,i,s):n==="radial"&&e&&lo.draw(g,e,r,o,i,s),u.current=requestAnimationFrame(_)};return u.current=requestAnimationFrame(_),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[n,e,t,s,i,r,o,l]),a.jsx("canvas",{ref:c,style:{display:"block",margin:"0 auto",borderRadius:l?"4px":"8px"}})},df=({tags:n,centerX:e,centerY:t,isPlaying:s})=>{const[i,r]=x.useState([]),o=x.useRef(null),l=x.useRef(Date.now());x.useEffect(()=>{const u=[220,260,300,340,380],h=[12,10,8,6,4],d=n.map((f,m)=>360/n.length*m),g=n.slice(0,5).map((f,m)=>({text:f,radius:u[m]||300,speed:h[m]||8,angle:d[m]||0,scale:1,opacity:.6}));r(g)},[n]),x.useEffect(()=>{if(!s){o.current!==null&&(cancelAnimationFrame(o.current),o.current=null);return}const u=()=>{const h=Date.now(),d=(h-l.current)/1e3;l.current=h,r(g=>g.map((f,m)=>{let p=f.angle+f.speed*d;p=p%360;const _=m*.5,w=1+Math.sin((h/3e3+_)*Math.PI*2)*.05,S=.55+Math.sin((h/3e3+_)*Math.PI*2)*.15;return{...f,angle:p,scale:w,opacity:S}})),o.current=requestAnimationFrame(u)};return o.current=requestAnimationFrame(u),()=>{o.current!==null&&cancelAnimationFrame(o.current)}},[s]);const c=u=>u*Math.PI/180;return a.jsx("div",{className:"motif-orbit",children:i.map((u,h)=>{const d=e+u.radius*Math.cos(c(u.angle)),g=t+u.radius*Math.sin(c(u.angle));return a.jsx("div",{className:"motif-tag",style:{left:`${d}px`,top:`${g}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${h}`)})})},mf=({album:n,isPlaying:e,currentTime:t,duration:s,volume:i,isMuted:r,shuffle:o,repeat:l,canPrevious:c,canNext:u,visualizationMode:h,queue:d,queueIndex:g,frequencyData:f,timeDomainData:m,onPlayPause:p,onPrevious:_,onNext:y,onSeek:w,onVolumeChange:S,onMuteToggle:E,onShuffle:b,onRepeat:T,onVisualizationModeChange:j,onSkipToIndex:v,onClose:N})=>{const{updateAlbum:A}=bt(),D=n?.id||null,[M,P]=x.useState("");x.useEffect(()=>{P(n?.memo||"")},[D]),x.useEffect(()=>{const O=G=>{G.key==="Escape"?N():G.key===" "&&G.target===document.body?(G.preventDefault(),p()):G.key==="ArrowLeft"?w(Math.max(0,t-5)):G.key==="ArrowRight"?w(Math.min(s,t+5)):G.key==="ArrowUp"?S(Math.min(1,i+.1)):G.key==="ArrowDown"?S(Math.max(0,i-.1)):G.key==="m"||G.key==="M"?E():G.key==="n"||G.key==="N"?y():(G.key==="p"||G.key==="P")&&_()};return document.addEventListener("keydown",O),()=>document.removeEventListener("keydown",O)},[t,s,i,N,p,w,S,E,y,_]);const I="#D4AF37",F=n?.metadata?.motif_tags||[],V=x.useMemo(()=>"メモ（ひとこと）。聴きながら思い出したこと、今の気分、景色…",[]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"expanded-player-backdrop",onClick:N}),a.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[a.jsx("button",{className:"expanded-player-close",onClick:N,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),a.jsx("button",{className:"expanded-player-minimize",onClick:N,"aria-label":"Minimize player",title:"Minimize",children:"-"}),a.jsxs("div",{className:"expanded-player-content",children:[a.jsxs("div",{className:"expanded-player-album-section",children:[a.jsx("div",{className:"expanded-player-album-container",children:n&&a.jsxs(a.Fragment,{children:[a.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"expanded-player-album-image"}),F.length>0&&a.jsx(df,{tags:F,centerX:200,centerY:200,isPlaying:e})]})}),n&&a.jsxs("div",{className:"expanded-player-album-meta",children:[a.jsx("h2",{className:"expanded-player-album-title",children:n.title||n.mood}),n.musicMetadata&&a.jsxs("p",{className:"expanded-player-album-details",children:[n.musicMetadata.key," • ",n.musicMetadata.tempo," BPM • ",n.musicMetadata.timeSignature]}),n.musicMetadata?.character&&a.jsx("p",{className:"expanded-player-album-character",children:n.musicMetadata.character}),a.jsxs("div",{className:"expanded-player-memo",children:[a.jsx("div",{className:"expanded-player-memo-label",children:"メモ"}),a.jsx("textarea",{className:"expanded-player-memo-input",value:M,onChange:O=>P(O.target.value),onBlur:()=>{if(!n)return;const O=M.trim();(n.memo||"")!==O&&A(n.id,{memo:O||void 0})},placeholder:V,rows:2})]})]})]}),a.jsxs("div",{className:"expanded-player-visualization-section",children:[a.jsx(hf,{mode:h,frequencyData:f,timeDomainData:m,isPlaying:e,dominantColor:I,width:800,height:200}),a.jsxs("div",{className:"visualization-mode-toggle",children:[a.jsx("button",{className:h==="waveform"?"active":"",onClick:()=>j("waveform"),title:"Waveform",children:"波形"}),a.jsx("button",{className:h==="spectrum"?"active":"",onClick:()=>j("spectrum"),title:"Spectrum Bars",children:"バー"}),a.jsx("button",{className:h==="radial"?"active":"",onClick:()=>j("radial"),title:"Radial Spectrum",children:"円形"})]})]}),a.jsxs("div",{className:"expanded-player-controls-section",children:[a.jsx(rf,{isPlaying:e,canPrevious:c,canNext:u,shuffle:o,repeat:l,onPlayPause:p,onPrevious:_,onNext:y,onShuffle:b,onRepeat:T,expanded:!0}),a.jsx(of,{currentTime:t,duration:s,onSeek:w,color:I}),a.jsx(cf,{volume:i,isMuted:r,onVolumeChange:S,onMuteToggle:E,expanded:!0})]}),a.jsx(lf,{queue:d,currentIndex:g,onSkipTo:v})]})]})]})},pf=({album:n,queue:e=[]})=>{const{state:t,setPlaybackState:s,setCurrentTime:i,setDuration:r,setVolume:o,toggleMute:l,toggleShuffle:c,cycleRepeat:u,toggleExpanded:h,setVisualizationMode:d,play:g,pause:f,next:m,previous:p,skipToIndex:_,setQueue:y,setCurrentAlbumFull:w}=Rt(),S=x.useRef(nf()),E=x.useRef(null),b=x.useRef(null),T=x.useRef(null),j=x.useRef(null),v=x.useRef(0),N=x.useRef(0),[A,D]=x.useState(null),[M,P]=x.useState(null);x.useEffect(()=>((async()=>{try{await to();const k=tf.createAnalyser();k.fftSize=2048,k.smoothingTimeConstant=.8,ef().connect(k),E.current=k,b.current=new Uint8Array(k.frequencyBinCount),T.current=new Uint8Array(k.frequencyBinCount)}catch(k){console.error("Failed to initialize analyser:",k)}})(),()=>{if(E.current)try{E.current.disconnect()}catch{}}),[]),x.useEffect(()=>{if(e.length>0){const R=n?e.findIndex(k=>k.id===n.id):0;y(e,Math.max(0,R))}else n&&y([n],0)},[n,e,y]),x.useEffect(()=>{const R=t.currentAlbum||n;R?.musicData&&(I(R),w(R))},[t.currentAlbum?.id,n?.id]),x.useEffect(()=>{t.playRequestId>0&&(v.current=t.playRequestId)},[t.playRequestId]),x.useEffect(()=>{const R=t.currentAlbum||n,k=v.current;if(!R?.musicData||k===0||k===N.current)return;let W=!1;return(async()=>{try{if(await I(R),W)return;await F(),N.current=k}catch(oe){console.error("[EnhancedMiniPlayer] Autoplay failed:",oe)}})(),()=>{W=!0}},[t.currentAlbum?.id,n?.id,t.playRequestId]),x.useEffect(()=>{if(t.playbackState===ut.PLAYING&&E.current){let R;const k=()=>{!E.current||!b.current||!T.current||(E.current.getByteFrequencyData(b.current),E.current.getByteTimeDomainData(T.current),D(new Uint8Array(b.current)),P(new Uint8Array(T.current)),R=requestAnimationFrame(k))};return R=requestAnimationFrame(k),()=>{R&&cancelAnimationFrame(R)}}},[t.playbackState]);const I=async R=>{try{const k=S.current;await k.loadMIDI(R.musicData);const W=k.getState();r(W.duration)}catch(k){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",k)}},F=async()=>{try{s(ut.LOADING);const R=S.current;await R.play(),g();const k=window.setInterval(()=>{const W=R.getState();i(W.currentTime),r(W.duration),!W.isPlaying&&!W.isPaused&&(clearInterval(k),O())},100);j.current=k}catch(R){console.error("Failed to start playback:",R),s(ut.STOPPED)}},V=()=>{S.current.pause(),f(),j.current&&(clearInterval(j.current),j.current=null)},O=()=>{t.repeat==="one"?(X(0),F()):Y()},G=()=>{t.playbackState===ut.PLAYING?V():F()},Y=()=>{m(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},H=()=>{p(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},X=R=>{S.current.seek(R),i(R)},ee=R=>{o(R)},U=R=>{_(R),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},Q=t.queueIndex>0||t.repeat==="all",B=t.queueIndex<t.queue.length-1||t.repeat==="all",C=t.playbackState===ut.PLAYING;return x.useEffect(()=>()=>{j.current&&clearInterval(j.current)},[]),a.jsxs(a.Fragment,{children:[!t.isExpanded&&a.jsx(af,{album:t.currentAlbum,isPlaying:C,currentTime:t.currentTime,duration:t.duration,onPlayPause:G,onExpand:h}),t.isExpanded&&a.jsx(mf,{album:t.currentAlbum,isPlaying:C,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:Q,canNext:B,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:A,timeDomainData:M,onPlayPause:G,onPrevious:H,onNext:Y,onSeek:X,onVolumeChange:ee,onMuteToggle:l,onShuffle:c,onRepeat:u,onVisualizationModeChange:d,onSkipToIndex:U,onClose:h})]})};function ff(){const{state:n}=Rt(),e=!!n.currentAlbumImage&&(n.playbackState===ut.PLAYING||n.playbackState===ut.PAUSED),t=x.useMemo(()=>`${n.currentAlbum?.id||"none"}:${n.playbackState}`,[n.currentAlbum?.id,n.playbackState]),[s,i]=x.useState(!1);return x.useEffect(()=>{const r=window.setTimeout(()=>i(e),e?40:0);return()=>window.clearTimeout(r)},[e]),n.currentAlbumImage?a.jsx("div",{className:`playback-backdrop ${s?"is-active":""} ${n.playbackState===ut.PLAYING?"is-playing":""}`,style:{backgroundImage:`url(${n.currentAlbumImage})`},"aria-hidden":"true"},t):null}function gf(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function vf(){try{new Function('return import("web-vitals")')().then(e=>{const t=s=>{console.log("[Web Vitals]",s)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}function _f(){const n=document.createElement("script");n.type="module",n.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const e=document.createElement("script");e.type="module",e.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(n),document.head.appendChild(e)}gf(),vf(),_f();const yf="airia_onboarding_data",bf="airia_theme",Pa="airia_post_onboarding_room",kt="airia_preauth_view_v1";function Fa(){try{const n=String(window.location.hash||"").trim().toLowerCase();return n==="#terms"?"terms":n==="#privacy"?"privacy":n==="#login"?"auth":null}catch{return null}}function xf(){try{const n=localStorage.getItem(bf),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n||"system",s=t==="system"?e?"dark":"light":t;document.documentElement.setAttribute("data-theme",s)}catch{document.documentElement.setAttribute("data-theme","light")}}function La(){try{if(Ss())return!1;const n=localStorage.getItem(yf);return n?!!JSON.parse(n)?.completedAt:!1}catch{return!1}}function wf(){try{const n=localStorage.getItem(Pa);if(!n)return null;localStorage.removeItem(Pa);const e=String(n);return["main","gallery","album","music","social","me","settings","info","feedback"].includes(e)?e:null}catch{return null}}const Nf=()=>{const[n,e]=x.useState(!0),[t,s]=x.useState(()=>{try{const S=Fa();if(S)return S;const E=sessionStorage.getItem(kt);return E==="auth"||E==="terms"||E==="privacy"?E:"landing"}catch{return"landing"}}),[i,r]=x.useState(()=>{try{return La()}catch{return!1}}),{getSelectedAlbum:o,albums:l}=bt(),{state:c}=Rt(),{user:u,loading:h}=As(),d=o();x.useEffect(()=>{const S=()=>{const E=Fa();if(E){s(E);try{sessionStorage.setItem(kt,E)}catch{}return}try{const T=sessionStorage.getItem(kt)==="auth"?"auth":"landing";s(T),sessionStorage.setItem(kt,T)}catch{s("landing")}};return window.addEventListener("hashchange",S),()=>window.removeEventListener("hashchange",S)},[]);const g=L.useCallback(()=>{s("auth");try{sessionStorage.setItem(kt,"auth"),window.location.hash="#login"}catch{}},[]),f=L.useCallback(()=>{s("landing");try{sessionStorage.setItem(kt,"landing"),window.location.hash=""}catch{}},[]),m=L.useCallback(()=>{s("terms");try{sessionStorage.setItem(kt,"terms"),window.location.hash="#terms"}catch{}},[]),p=L.useCallback(()=>{s("privacy");try{sessionStorage.setItem(kt,"privacy"),window.location.hash="#privacy"}catch{}},[]);x.useEffect(()=>{xf()},[]);const _=l.filter(S=>S.musicData),y=i?[{id:"main",name:"Main",component:a.jsx(Oc,{})},{id:"gallery",name:"Gallery",component:a.jsx(qc,{})},{id:"album",name:"Album",component:a.jsx(zc,{})},{id:"music",name:"Music",component:a.jsx(Yc,{})},{id:"social",name:"Social",component:a.jsx(tl,{})},{id:"me",name:"My",component:a.jsx(nl,{})},{id:"settings",name:"Settings",component:a.jsx(al,{})},{id:"info",name:"Info",component:a.jsx(cl,{})},{id:"feedback",name:"Feedback",component:a.jsx(ll,{})}]:[{id:"onboarding",name:"はじめに",component:a.jsx(Tc,{onExit:()=>{r(La())}})}],w=i?wf()??"main":"onboarding";return a.jsxs(a.Fragment,{children:[n&&a.jsx(ul,{onDismiss:()=>e(!1)}),!n&&a.jsxs(a.Fragment,{children:[a.jsx(ff,{}),a.jsx("div",{className:"app-ui-layer",children:h?a.jsx("div",{style:{padding:24,opacity:.8},children:"Loading..."}):u?a.jsxs(a.Fragment,{children:[a.jsx($o,{rooms:y,initialRoom:w},i?"onboarded":"needs-onboarding"),a.jsx(pf,{album:d||void 0,queue:_})]}):t==="auth"?a.jsx(kc,{onBack:f}):t==="terms"?a.jsx(pa,{kind:"terms",onBack:f,onStart:g}):t==="privacy"?a.jsx(pa,{kind:"privacy",onBack:f,onStart:g}):a.jsx(Cc,{onStart:g,onOpenTerms:m,onOpenPrivacy:p})})]})]})},Sf=()=>a.jsx(L.StrictMode,{children:a.jsx(Fo,{children:a.jsx(Co,{children:a.jsx(Io,{children:a.jsx(So,{children:a.jsx(Ro,{children:a.jsx(Oo,{children:a.jsx(Nf,{})})})})})})})});No.createRoot(document.getElementById("root")).render(a.jsx(Sf,{}));
//# sourceMappingURL=index-MPsf7d_z.js.map
