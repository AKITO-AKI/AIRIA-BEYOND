var _o=Object.defineProperty;var bo=(n,e,t)=>e in n?_o(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var dt=(n,e,t)=>bo(n,typeof e!="symbol"?e+"":e,t);import{r as w,j as i,R as V,a as xo,C as _s,u as Jt,V as Gt,B as Os,L as wo,b as ei,c as na,M as No,d as So,T as jo,S as To,H as ko,e as ti,f as Co,P as Ao,g as Mo}from"./vendor-three-B0AUARpK.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const $n=n=>{if(!n)return 30;const e=20,t=60,s=30,a=180,r=Math.max(s,Math.min(a,n));return e+(r-s)/(a-s)*(t-e)},ia=n=>{const t=Math.floor(n/10),s=n%10;return{shelfIndex:Math.min(t,4),positionIndex:s}},Gn=n=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let s=0;s<n.length;s++)t=(t<<5)-t+n.charCodeAt(s),t=t&t;return e[Math.abs(t)%e.length]},$a=w.createContext(void 0),aa="airia-albums",Eo=({children:n})=>{const[e,t]=w.useState([]),[s,a]=w.useState(null);w.useEffect(()=>{try{const u=localStorage.getItem(aa);if(u){const h=JSON.parse(u);t(h)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),w.useEffect(()=>{try{localStorage.setItem(aa,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const r=u=>{const h={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()},d=ia(0),m=$n(h.musicMetadata?.duration),f=Gn(h.imageDataURL),p={...h,gallery:{shelfIndex:d.shelfIndex,positionIndex:d.positionIndex,thickness:m,spineColor:f}};return t(g=>[p,...g].map((_,S)=>{const C=ia(S),I=$n(_.musicMetadata?.duration),b=_.gallery?.spineColor||Gn(_.imageDataURL);return{..._,gallery:{shelfIndex:C.shelfIndex,positionIndex:C.positionIndex,thickness:I,spineColor:b}}})),p},c=(u,h)=>{t(d=>d.map(m=>{if(m.id!==u)return m;const f={...m,...h};if(h.imageDataURL){const p=f.gallery?.spineColor||Gn(f.imageDataURL);return{...f,gallery:{...f.gallery||{shelfIndex:0,positionIndex:0,thickness:$n(f.musicMetadata?.duration),spineColor:p},spineColor:p}}}return f}))},l=u=>{a(u)},o=()=>s&&e.find(u=>u.id===s)||null;return i.jsx($a.Provider,{value:{albums:e,selectedAlbumId:s,addAlbum:r,updateAlbum:c,selectAlbum:l,getSelectedAlbum:o},children:n})},wt=()=>{const n=w.useContext($a);if(n===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return n},Ga=w.createContext(void 0),zn="airia-causal-logs",Io=30;function Do(n){return n&&{mood:n.mood,duration:n.duration,timestamp:n.timestamp,customInput:n.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:n.onboardingAnswers?"[onboarding data - summary only]":void 0}}function Po(n){const e=new Date;return e.setDate(e.getDate()-Io),n.filter(t=>new Date(t.createdAt)>=e)}const Oo=({children:n})=>{const[e,t]=w.useState([]);w.useEffect(()=>{try{const d=localStorage.getItem(zn);if(d){const f=JSON.parse(d).map(g=>({...g,createdAt:new Date(g.createdAt),input:{...g.input,timestamp:new Date(g.input.timestamp)},analysis:g.analysis?{...g.analysis,timestamp:new Date(g.analysis.timestamp)}:void 0,imageGeneration:g.imageGeneration?{...g.imageGeneration,timestamp:new Date(g.imageGeneration.timestamp)}:void 0,musicGeneration:g.musicGeneration?{...g.musicGeneration,timestamp:new Date(g.musicGeneration.timestamp)}:void 0,album:g.album?{...g.album,timestamp:new Date(g.album.timestamp)}:void 0,errors:g.errors?.map(y=>({...y,timestamp:new Date(y.timestamp)}))})),p=Po(f);t(p)}}catch(d){console.error("[CausalLog] Failed to load logs from localStorage:",d)}},[]),w.useEffect(()=>{try{localStorage.setItem(zn,JSON.stringify(e))}catch(d){console.error("[CausalLog] Failed to save logs to localStorage:",d)}},[e]);const s=(d,m)=>{const f=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,p={id:f,sessionId:d,createdAt:new Date,input:Do(m),totalDuration:0,success:!1};return t(g=>[...g,p]),console.log("[CausalLog] Created log:",f,"for session:",d),f},a=d=>e.find(m=>m.id===d),r=d=>e.find(m=>m.sessionId===d),c=(d,m)=>{t(f=>f.map(p=>{if(p.id===d){const g={...p,...m};if(g.analysis||g.imageGeneration||g.musicGeneration){const y=[g.analysis?.duration||0,g.imageGeneration?.duration||0,g.musicGeneration?.duration||0];g.totalDuration=y.reduce((_,S)=>_+S,0)}return g}return p})),console.log("[CausalLog] Updated log:",d)},l=d=>{t(m=>m.filter(f=>f.id!==d)),console.log("[CausalLog] Deleted log:",d)},o=()=>{t([]),localStorage.removeItem(zn),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(d=>({id:d.id,sessionId:d.sessionId,createdAt:d.createdAt,success:d.success,totalDuration:d.totalDuration,albumId:d.album?.albumId})),h=d=>{const m=a(d);if(!m)throw new Error(`Log ${d} not found`);return JSON.stringify(m,null,2)};return i.jsx(Ga.Provider,{value:{logs:e,createLog:s,getLog:a,getLogBySessionId:r,updateLog:c,deleteLog:l,clearAllLogs:o,getLogSummaries:u,exportLog:h},children:n})},za=()=>{const n=w.useContext(Ga);if(n===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return n},Zt="https://airia-beyond.onrender.com",si="airia_auth_token_v1";function en(){try{return String(localStorage.getItem(si)||"")}catch{return""}}function is(n){try{n?localStorage.setItem(si,n):localStorage.removeItem(si)}catch{}}async function tt(n,e={}){const t=en(),s=new Headers(e.headers||{});return t&&s.set("Authorization",`Bearer ${t}`),fetch(n,{...e,headers:s})}async function Kt(n){return n.json().catch(()=>null)}async function Ro(n){const e=await fetch(`${Zt}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Kt(e);if(!e.ok)throw new Error(t?.message||`Failed to register: ${e.status}`);return t}async function Fo(n){const e=await fetch(`${Zt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Kt(e);if(!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);return t}async function Lo(n){const e=await fetch(`${Zt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Kt(e);if(!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);return t}async function ra(n,e){const t=await fetch(`${Zt}/api/auth/oauth/${encodeURIComponent(n)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await Kt(t);if(!t.ok)throw new Error(s?.message||`Failed to login: ${t.status}`);return s}async function Vo(){const n=await tt(`${Zt}/api/auth/me`),e=await Kt(n);if(!n.ok)throw new Error(e?.message||`Failed to load me: ${n.status}`);return e}async function qo(){const n=await tt(`${Zt}/api/auth/logout`,{method:"POST"}),e=await Kt(n);if(!n.ok)throw new Error(e?.message||`Failed to logout: ${n.status}`);return e}async function Wo(n){const e=await tt(`${Zt}/api/auth/me`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Kt(e);if(!e.ok)throw new Error(t?.message||`Failed to update profile: ${e.status}`);return t}const Ya=V.createContext(null);function xn(){const n=V.useContext(Ya);if(!n)throw new Error("useAuth must be used within AuthProvider");return n}const Bo=({children:n})=>{const[e,t]=V.useState(null),[s,a]=V.useState(!0),[r,c]=V.useState(!1),[l,o]=V.useState(()=>en()),u=V.useRef(0),h=V.useRef(!1),d=V.useCallback(()=>(u.current+=1,u.current),[]),m=V.useCallback(N=>u.current===N,[]),f=V.useCallback(async()=>{const N=d(),j=en();if(o(j),!j){m(N)&&(t(null),a(!1));return}try{const v=j,x=await Vo();if(!m(N)||en()!==v)return;t(x.user),x.user||(is(null),o(""))}catch(v){if(!m(N))return;const x=v instanceof Error?v.message:String(v);/failed to fetch/i.test(x)||/networkerror/i.test(x)||/load failed/i.test(x)||/timeout/i.test(x)||t(null)}finally{m(N)&&a(!1)}},[d,m]);V.useEffect(()=>{h.current||(h.current=!0,f())},[f]);const p=V.useCallback(async N=>{const j=d();c(!0);try{const v=await ra("google",{idToken:N});if(!m(j))return;is(v.token),o(v.token),t(v.user)}finally{m(j)&&c(!1)}},[d,m]),g=V.useCallback(async(N,j)=>{const v=d();c(!0);try{const x=await ra("apple",{idToken:N,user:j||void 0});if(!m(v))return;is(x.token),o(x.token),t(x.user)}finally{m(v)&&c(!1)}},[d,m]),y=V.useCallback(async N=>{const j=d();c(!0);try{const v=String(N?.identifier||"").trim(),x=String(N?.password||""),M=v.includes("@")?await Lo({email:v,password:x}):await Fo({handle:v,password:x});if(!m(j))return;is(M.token),o(M.token),t(M.user)}finally{m(j)&&c(!1)}},[d,m]),_=V.useCallback(async N=>{const j=d();c(!0);try{const v=String(N?.email||"").trim(),x=String(N?.password||""),M=N?.displayName,E=N?.handle,D=await Ro({email:v,password:x,displayName:M,handle:E});if(!m(j))return;is(D.token),o(D.token),t(D.user)}finally{m(j)&&c(!1)}},[d,m]),S=V.useCallback(async()=>{const N=d();c(!0);try{await qo().catch(()=>null)}finally{if(!m(N))return;is(null),o(""),t(null),c(!1)}},[d,m]),C=V.useCallback(async N=>{const j=d();c(!0);try{const v=await Wo(N);if(!m(j))return;t(v.user)}finally{m(j)&&c(!1)}},[d,m]),I=V.useCallback(N=>{t(j=>j&&{...j,followingIds:Array.isArray(N)?N:[]})},[]),b={user:e,bootLoading:s,busy:r,token:l,refresh:f,loginWithGoogle:p,loginWithApple:g,loginWithPassword:y,registerWithPassword:_,logout:S,updateProfile:C,updateFollowingIds:I};return i.jsx(Ya.Provider,{value:b,children:n})};var ht=(n=>(n.STOPPED="STOPPED",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.LOADING="LOADING",n))(ht||{});const Xa=w.createContext(void 0),Uo=.7,$o=({children:n})=>{const[e,t]=w.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:Uo,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),s=w.useCallback(v=>{t(x=>({...x,playbackState:v?"PLAYING":"PAUSED"}))},[]),a=w.useCallback((v,x)=>{t(M=>({...M,currentAlbumImage:v,currentTrackTitle:x}))},[]),r=w.useCallback(v=>{t(x=>({...x,playbackState:v}))},[]),c=w.useCallback(v=>{t(x=>({...x,currentAlbum:v,currentAlbumImage:v?.imageDataURL,currentTrackTitle:v?v.title||v.mood:void 0}))},[]),l=w.useCallback((v,x=0)=>{t(M=>({...M,queue:v,queueIndex:x,currentAlbum:v[x]||null,currentAlbumImage:v[x]?.imageDataURL,currentTrackTitle:v[x]?v[x].title||v[x].mood:void 0}))},[]),o=w.useCallback(v=>{t(x=>({...x,currentTime:v}))},[]),u=w.useCallback(v=>{t(x=>({...x,duration:v}))},[]),h=w.useCallback(v=>{const x=Math.max(0,Math.min(1,v));t(M=>({...M,volume:x}))},[]),d=w.useCallback(()=>{t(v=>({...v,isMuted:!v.isMuted}))},[]),m=w.useCallback(()=>{t(v=>({...v,shuffle:!v.shuffle}))},[]),f=w.useCallback(()=>{t(v=>{const x=["off","all","one"],E=(x.indexOf(v.repeat)+1)%x.length;return{...v,repeat:x[E]}})},[]),p=w.useCallback(()=>{t(v=>({...v,isExpanded:!v.isExpanded}))},[]),g=w.useCallback(v=>{t(x=>({...x,isExpanded:v}))},[]),y=w.useCallback(v=>{t(x=>({...x,visualizationMode:v}))},[]),_=w.useCallback((v,x)=>{t(M=>{const E=x&&x.length>0?x:M.queue,D=E.length>0?E:[v],R=Math.max(0,D.findIndex(F=>F.id===v.id)),T=D[R]||v;return{...M,queue:D,queueIndex:R,currentAlbum:T,currentAlbumImage:T.imageDataURL,currentTrackTitle:T.title||T.mood,currentTime:0,playRequestId:M.playRequestId+1,isExpanded:!0}})},[]),S=w.useCallback(()=>{t(v=>({...v,playbackState:"PLAYING"}))},[]),C=w.useCallback(()=>{t(v=>({...v,playbackState:"PAUSED"}))},[]),I=w.useCallback(()=>{t(v=>({...v,playbackState:"STOPPED",currentTime:0}))},[]),b=w.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;let x=v.queueIndex+1;if(x>=v.queue.length)if(v.repeat==="all")x=0;else return{...v,playbackState:"STOPPED"};const M=v.queue[x];return{...v,queueIndex:x,currentAlbum:M,currentAlbumImage:M.imageDataURL,currentTrackTitle:M.mood,currentTime:0}})},[]),N=w.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;if(v.currentTime>3)return{...v,currentTime:0};let x=v.queueIndex-1;if(x<0)if(v.repeat==="all")x=v.queue.length-1;else return v;const M=v.queue[x];return{...v,queueIndex:x,currentAlbum:M,currentAlbumImage:M.imageDataURL,currentTrackTitle:M.mood,currentTime:0}})},[]),j=w.useCallback(v=>{t(x=>{if(v<0||v>=x.queue.length)return x;const M=x.queue[v];return{...x,queueIndex:v,currentAlbum:M,currentAlbumImage:M.imageDataURL,currentTrackTitle:M.mood,currentTime:0}})},[]);return i.jsx(Xa.Provider,{value:{state:e,setPlaying:s,setCurrentAlbum:a,setPlaybackState:r,setCurrentAlbumFull:c,setQueue:l,setCurrentTime:o,setDuration:u,setVolume:h,toggleMute:d,toggleShuffle:m,cycleRepeat:f,toggleExpanded:p,setExpanded:g,setVisualizationMode:y,requestPlayAlbum:_,play:S,pause:C,stop:I,next:b,previous:N,skipToIndex:j},children:n})},Rt=()=>{const n=w.useContext(Xa);if(!n)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return n},Ha=w.createContext(void 0),bs=()=>{const n=w.useContext(Ha);if(!n)throw new Error("useToast must be used within ToastProvider");return n},Go=({children:n})=>{const[e,t]=w.useState([]),s=w.useCallback((r,c,l=4e3)=>{const o=`toast-${Date.now()}-${Math.random()}`,u={id:o,type:r,message:c,duration:l};t(d=>[...d,u]);const h=setTimeout(()=>{a(o)},l);return()=>clearTimeout(h)},[]),a=w.useCallback(r=>{t(c=>c.filter(l=>l.id!==r))},[]);return i.jsxs(Ha.Provider,{value:{toasts:e,addToast:s,removeToast:a},children:[n,i.jsx(zo,{toasts:e})]})},zo=({toasts:n})=>i.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:n.map(e=>i.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[i.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),i.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class Yo extends w.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(a=>{a.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?i.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[i.jsx("h1",{children:"エラーが発生しました"}),i.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),i.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const Ja=w.createContext(void 0),Xo=({value:n,children:e})=>i.jsx(Ja.Provider,{value:n,children:e}),St=()=>{const n=w.useContext(Ja);if(!n)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return n},Za=({open:n,onOpenChange:e,title:t,description:s,children:a,footer:r,size:c="md"})=>{const l=w.useId(),o=w.useId();return w.useEffect(()=>{if(!n)return;const u=h=>{h.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[n,e]),n?xo.createPortal(i.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[i.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),i.jsxs("div",{className:`dialog-surface dialog-${c}`,role:"dialog","aria-modal":"true","aria-labelledby":l,"aria-describedby":s?o:void 0,children:[i.jsxs("header",{className:"dialog-header",children:[i.jsxs("div",{children:[i.jsx("h2",{id:l,className:"dialog-title",children:t}),s&&i.jsx("p",{id:o,className:"dialog-description",children:s})]}),i.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),i.jsx("div",{className:"dialog-body",children:a}),r?i.jsx("footer",{className:"dialog-footer",children:r}):null]})]}),document.body):null},oa="airia_feedback_nudge_open_count_v1",ca="airia_feedback_nudge_last_shown_at_v1";function Ho(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function Jo(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Zo(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function Ko(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Qo(n){return n?(Date.now()-n)/(24*60*60*1e3):Number.POSITIVE_INFINITY}const ec=()=>{const{currentRoomId:n,navigateToRoom:e}=St(),[t,s]=V.useState(!1),a=V.useRef(null);V.useEffect(()=>{if(n==="onboarding"||n==="feedback")return;const c=Ho(oa)+1;Jo(oa,c);const l=Zo(ca);if(Qo(l)<10||c<4)return;const u=c<10?.05:.08;if(!(Math.random()>u))return a.current=window.setTimeout(()=>{document.visibilityState==="visible"&&(Ko(ca,Date.now()),s(!0))},7e3),()=>{a.current&&window.clearTimeout(a.current),a.current=null}},[n]);const r=()=>{s(!1),e("feedback")};return i.jsx(Za,{open:t,onOpenChange:s,title:"フィードバックしませんか？",description:"短くてOK。気づいたことを教えてください。",size:"sm",footer:i.jsxs(i.Fragment,{children:[i.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>s(!1),children:"今はしない"}),i.jsx("button",{type:"button",className:"btn btn-primary",onClick:r,children:"書く"})]}),children:i.jsx("p",{style:{margin:0,lineHeight:1.7},children:"バグ報告・改善案・良かった点、どれでも歓迎です。 送信時に診断情報も添付できるので、原因調査が早くなります。"})})},tc=({rooms:n,initialRoom:e="main"})=>{const t=n.findIndex(T=>T.id===e),[s,a]=w.useState(t>=0?t:0),[r,c]=w.useState(!1),[l,o]=w.useState(0),[u,h]=w.useState(0),[d,m]=w.useState(0),[f,p]=w.useState(null),g=w.useRef(null),y=T=>T instanceof Element?!!T.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,_=T=>{y(T.target)||(c(!0),o(T.touches[0].clientX),h(T.touches[0].clientY),p(null))},S=T=>{if(!r)return;const F=T.touches[0].clientX,q=T.touches[0].clientY,L=F-l,B=q-u;if(!f){const G=Math.abs(L),X=Math.abs(B);if(G<6&&X<6)return;if(X>G*1.2){p("vertical"),c(!1),m(0);return}p("horizontal")}f==="horizontal"&&(T.preventDefault(),m(L))},C=()=>{if(!r)return;c(!1),Math.abs(d)>100&&(d>0&&s>0?a(s-1):d<0&&s<n.length-1&&a(s+1)),m(0),p(null)},I=T=>{y(T.target)||(c(!0),o(T.clientX),h(T.clientY),p(null))},b=T=>{if(!r)return;T.preventDefault();const F=T.clientX-l,q=T.clientY-u;if(!f){const L=Math.abs(F),B=Math.abs(q);if(L<6&&B<6)return;if(B>L*1.2){p("vertical"),c(!1),m(0);return}p("horizontal")}f==="horizontal"&&m(F)},N=()=>{if(!r)return;c(!1),Math.abs(d)>100&&(d>0&&s>0?a(s-1):d<0&&s<n.length-1&&a(s+1)),m(0),p(null)},j=()=>{r&&(Math.abs(d)>100&&(d>0&&s>0?a(s-1):d<0&&s<n.length-1&&a(s+1)),c(!1),m(0),p(null))},v=T=>{a(T),m(0)},x=g.current?.clientWidth||window.innerWidth||1,M=-s*100+d/x*100,E=n[s]?.id,D=E!=="onboarding",R=T=>{const F=T==="settings"?"me":T,q=n.findIndex(L=>L.id===F);q>=0&&v(q)};return i.jsxs(Xo,{value:{currentRoomId:E,navigateToRoom:R},children:[i.jsx(ec,{}),i.jsxs("div",{className:`room-navigator ${D?"":"indicators-hidden"}`,children:[D&&i.jsx("div",{className:"room-indicators","aria-label":"ルームナビゲーション",children:n.map((T,F)=>i.jsx("button",{className:`room-indicator ${F===s?"active":""}`,onClick:()=>v(F),"aria-current":F===s?"page":void 0,"aria-label":`${T.name}へ移動`,children:i.jsx("span",{className:"room-indicator-label",children:T.name})},T.id))}),i.jsx("div",{ref:g,className:"rooms-container",onTouchStart:_,onTouchMove:S,onTouchEnd:C,onMouseDown:I,onMouseMove:b,onMouseUp:N,onMouseLeave:j,style:{transform:`translateX(${M}%)`,transition:r?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:n.map(T=>i.jsx("div",{className:"room",children:T.component},T.id))})]})]})},la="airia_onboarding_data",sc=[{value:"talk",title:"会話から",desc:"やさしく整えてから、次へ"},{value:"create",title:"創作から",desc:"早く作品に進みたい"}],nc=[{value:"今日",title:"今日",desc:"いちばん最近の出来事"},{value:"今週",title:"今週",desc:"数日の範囲"},{value:"今月",title:"今月",desc:"少し長め"},{value:"少し前",title:"少し前",desc:"はっきりしない/覚えてない"}],ic=[{value:"朝",title:"朝",desc:"スタートを整えたい"},{value:"昼",title:"昼",desc:"途中で乱れやすい"},{value:"夕方",title:"夕方",desc:"疲れが出やすい"},{value:"夜",title:"夜",desc:"余韻が残る/考えが巡る"}],ua=[{value:"穏やか",title:"穏やか",desc:"静か/落ち着く"},{value:"嬉しい",title:"嬉しい",desc:"軽い高揚/前向き"},{value:"不安",title:"不安",desc:"ざわつく/心配"},{value:"疲れ",title:"疲れ",desc:"消耗/休みたい"}],ac=[{value:"達成/うまくいった",title:"達成",desc:"うまくいった/進んだ"},{value:"不確実/心配",title:"心配",desc:"先が読めない/不確実"},{value:"人間関係",title:"人",desc:"誰かとのやり取り"},{value:"体力/睡眠",title:"体",desc:"寝不足/疲労/体調"}],rc=[{value:"仕事/学業",title:"仕事",desc:"締切/評価/責任"},{value:"人間関係",title:"人間関係",desc:"距離感/言葉/空気"},{value:"体調/睡眠",title:"体調",desc:"疲れ/睡眠/コンディション"},{value:"SNS/情報",title:"情報",desc:"比較/ニュース/刺激"}],oc=[{value:"評価や期待が気になる",title:"評価",desc:"期待に応えたい/怖い"},{value:"比較してしまう",title:"比較",desc:"周りと比べて落ちる"},{value:"疲れると増幅する",title:"疲労",desc:"体力が落ちると不安が増える"},{value:"言語化できず溜まる",title:"未消化",desc:"うまく言えず残る"}],cc=[{value:"落ち着いて集中したい",title:"集中",desc:"静かに深く入りたい"},{value:"安心して眠りたい",title:"眠り",desc:"夜にほどけたい"},{value:"不安を小さくしたい",title:"安心",desc:"ざわつきを鎮めたい"},{value:"気分を切り替えたい",title:"切替",desc:"短時間で整えたい"}],lc=[{value:"1週間以内",title:"1週間",desc:"短期で変えたい"},{value:"1ヶ月以内",title:"1ヶ月",desc:"少しずつ整える"},{value:"3ヶ月以内",title:"3ヶ月",desc:"習慣化したい"},{value:"長期的",title:"長期",desc:"ゆっくり育てる"}],uc=({onComplete:n,onProgressChange:e})=>{const[t,s]=w.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),a={key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"choices",options:sc},r={key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"choices",options:nc},c={key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"choices",options:ua},l={key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"一番近い理由を選んでください。",kind:"choices",options:ac},o={key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"choices",options:ic},u={key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"choices",options:ua},h={key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"一番近いものを選んでください。",kind:"choices",options:rc},d={key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"一番近いものを選んでください。",kind:"choices",options:oc},m={key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"choices",options:cc},f={key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"choices",options:lc},p=V.useMemo(()=>t.startMode==="create"?[a,c,m,f]:[a,r,c,l,o,u,h,d,m,f],[t.startMode]),[g,y]=w.useState(0),_=p.length;w.useEffect(()=>{g>p.length-1&&y(Math.max(0,p.length-1))},[g,p.length]),w.useEffect(()=>{const v=_>0?g/_:0;e?.(Math.min(v,.999))},[g,_,e]),w.useEffect(()=>{const v=localStorage.getItem(la);if(v)try{const x=JSON.parse(v);s(x)}catch(x){console.error("Failed to parse saved onboarding data:",x)}},[]);const S=v=>{localStorage.setItem(la,JSON.stringify(v))},C=(v,x)=>{const M={...t,[v]:x};s(M),S(M),g<_-1&&y(g+1)},I=()=>{g<_-1&&(S(t),y(g+1))},b=()=>{g>0&&(S(t),y(g-1))},N=()=>{const x={...t,recentMomentWhen:t.recentMomentWhen||"最近",dailyPatternWhen:t.dailyPatternWhen||(t.startMode==="create"?"夜":""),recentMomentEmotion:t.recentMomentEmotion||t.dailyPatternEmotion,dailyPatternEmotion:t.dailyPatternEmotion||t.recentMomentEmotion,recentMomentWhy:t.recentMomentWhy||"未指定",emotionalTrigger:t.emotionalTrigger||"未指定",emotionalTriggerWhy:t.emotionalTriggerWhy||"未指定",emotionalGoal:t.emotionalGoal||"落ち着いて集中したい",emotionalGoalTimeframe:t.emotionalGoalTimeframe||"1ヶ月以内",completedAt:new Date().toISOString()};s(x),S(x),n&&n(x)},j=()=>{const v=p[g];return String(t[v.key]??"").trim().length>0};return i.jsxs("div",{className:"onboarding-form",children:[i.jsxs("div",{className:"onboarding-header",children:[i.jsx("h2",{className:"blend-text",children:"はじめに"}),i.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),i.jsx("div",{className:"progress-bar",children:i.jsx("div",{className:"progress-fill",style:{width:`${(g+1)/_*100}%`}})}),i.jsxs("p",{className:"step-indicator",children:["ステップ ",g+1," / ",_]})]}),i.jsx("div",{className:"question-container",children:(()=>{const v=p[g];return i.jsxs("div",{className:"question-step",children:[i.jsx("h3",{className:"question-title",children:v.title}),v.description?i.jsx("p",{className:"question-description",children:v.description}):null,i.jsx("div",{className:"form-group",children:i.jsx("div",{className:"choice-grid",role:"group","aria-label":v.title,children:v.options.map(x=>{const E=String(t[v.key]??"")===x.value;return i.jsxs("button",{type:"button",className:`choice-btn ${E?"is-selected":""}`,onClick:()=>C(v.key,x.value),"aria-pressed":E,children:[i.jsx("div",{className:"choice-title",children:x.title}),x.desc?i.jsx("div",{className:"choice-desc",children:x.desc}):null]},x.value)})})})]})})()}),i.jsx("div",{className:"onboarding-actions","data-no-swipe":"true","aria-label":"オンボーディング操作",children:i.jsxs("div",{className:"button-group",children:[g>0&&i.jsx("button",{className:"btn btn-secondary",onClick:b,type:"button",children:"← 戻る"}),g<_-1?i.jsx("button",{className:"btn btn-primary",onClick:I,disabled:!j(),type:"button",children:"次へ →"}):i.jsx("button",{className:"btn btn-success",onClick:N,disabled:!j(),type:"button",children:"完了"})]})})]})},dc=({isActive:n})=>{const e=w.useRef(null),t=w.useRef(null);Jt(o=>{if(!e.current)return;e.current.rotation.z+=n?.002:.001;const u=Math.sin(o.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=n?.6:.3)});const s=[],a=5,r=50,c=a*r;for(let o=0;o<c;o++){const u=o/r,h=u*Math.PI*2,d=u*.5;s.push(new Gt(Math.cos(h)*d,Math.sin(h)*d,u*.1))}const l=new Os().setFromPoints(s);return i.jsx("line",{ref:e,geometry:l,children:i.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},hc=({isActive:n=!1})=>i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(_s,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(dc,{isActive:n})]})}),mc=({isActive:n})=>{const e=w.useRef(null),t=w.useRef(null);Jt(u=>{if(!e.current)return;e.current.rotation.z+=n?.001:5e-4;const h=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(h),t.current&&(t.current.opacity=n?.5:.25)});const s=[],a=200,r=3,c=2,l=Math.PI/2;for(let u=0;u<=a;u++){const h=u/a*Math.PI*2,d=Math.sin(r*h+l)*1.5,m=Math.sin(c*h)*1.5,f=0;s.push(new Gt(d,m,f))}const o=new Os().setFromPoints(s);return i.jsx("line",{ref:e,geometry:o,children:i.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},pc=({isActive:n=!1})=>i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(_s,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(mc,{isActive:n})]})}),fc=({isActive:n,ripples:e})=>{const t=w.useRef(null);Jt(a=>{if(!t.current)return;const r=a.clock.elapsedTime;t.current.children.forEach((c,l)=>{if(e[l]){const o=r-e[l].startTime,u=3;if(o<u){const h=1+o*.5;c.scale.setScalar(h);const d=1-o/u;c instanceof wo&&(c.material.opacity=d*(n?.6:.3))}else c.visible=!1}})});const s=()=>{const a=[];for(let l=0;l<=64;l++){const o=l/64*Math.PI*2;a.push(new Gt(Math.cos(o)*1,Math.sin(o)*1,0))}return new Os().setFromPoints(a)};return i.jsx("group",{ref:t,children:e.slice(-5).map(a=>i.jsx("line",{geometry:s(),children:i.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},a.id))})},gc=({isActive:n=!1,triggerRipple:e})=>{const[t,s]=w.useState([]),a=w.useRef(0);return w.useEffect(()=>{if(e){const r={id:a.current++,startTime:Date.now()/1e3};s(c=>[...c,r].slice(-5))}},[e]),w.useEffect(()=>{if(!n)return;const r=setInterval(()=>{const c={id:a.current++,startTime:Date.now()/1e3};s(l=>[...l,c].slice(-5))},2e3);return()=>clearInterval(r)},[n]),i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(_s,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(fc,{isActive:n,ripples:t})]})})},vc=({isActive:n,progress:e,dominantColor:t,onComplete:s,mousePos:a})=>{const r=w.useRef(null),c=w.useRef(null),[l,o]=w.useState(!1),[u,h]=w.useState(0),d=w.useMemo(()=>new ei(t),[t]),m=w.useMemo(()=>{const f=new Os,p=new Float32Array(100*3),g=new Float32Array(100*3);for(let y=0;y<100;y++){const _=Math.random()*Math.PI*2,S=Math.acos(2*Math.random()-1),C=1;p[y*3]=C*Math.sin(S)*Math.cos(_),p[y*3+1]=C*Math.sin(S)*Math.sin(_),p[y*3+2]=C*Math.cos(S),g[y*3]=p[y*3]*.02,g[y*3+1]=p[y*3+1]*.02,g[y*3+2]=p[y*3+2]*.02}return f.setAttribute("position",new na(p,3)),f.setAttribute("velocity",new na(g,3)),f},[]);return Jt(f=>{if(!r.current)return;const p=n?2*Math.PI/(30*60):2*Math.PI/(60*60);if(r.current.rotation.y+=p,r.current.rotation.x+=p*.5,n&&a.x!==0&&a.y!==0){const _=(a.x/window.innerWidth-.5)*.5,S=(a.y/window.innerHeight-.5)*.5;r.current.rotation.y+=(_-r.current.rotation.y)*.1,r.current.rotation.x+=(S-r.current.rotation.x)*.1}const g=20,y=Math.floor(e*g);if(y!==u&&y<g&&h(y),e>=1&&!l&&(o(!0),setTimeout(()=>{s?.()},1500)),l&&c.current){const _=m.getAttribute("position"),S=m.getAttribute("velocity");for(let C=0;C<100;C++)_.setXYZ(C,_.getX(C)+S.getX(C),_.getY(C)+S.getY(C),_.getZ(C)+S.getZ(C));_.needsUpdate=!0,r.current.material instanceof No&&(r.current.material.opacity=Math.max(0,r.current.material.opacity-.02))}}),i.jsxs("group",{children:[!l&&i.jsxs("mesh",{ref:r,children:[i.jsx("icosahedronGeometry",{args:[1,0]}),i.jsx("meshStandardMaterial",{color:d,transparent:!0,opacity:.8,wireframe:!1,emissive:d,emissiveIntensity:u/20})]}),l&&i.jsx("points",{ref:c,geometry:m,children:i.jsx("pointsMaterial",{color:d,size:.05,transparent:!0,opacity:.8})})]})},yc=({isActive:n=!1,progress:e=0,onComplete:t,dominantColor:s="#D4AF37",layer:a="foreground",placement:r="center",sizePx:c=400,opacity:l})=>{const[o,u]=w.useState({x:0,y:0});w.useEffect(()=>{const f=p=>{u({x:p.clientX,y:p.clientY})};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]);const h=(()=>{switch(r){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),d=a==="background",m=typeof l=="number"?l:d?.14:1;return i.jsx("div",{style:{width:"100%",height:`${c}px`,position:"absolute",...h,transform:"translate(-50%, -50%)",pointerEvents:d?"none":n?"auto":"none",zIndex:d?-1:0,opacity:m},children:i.jsxs(_s,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx("pointLight",{position:[10,10,10],intensity:1}),i.jsx(vc,{isActive:n,progress:e,dominantColor:s,onComplete:t,mousePos:o})]})})},_c=({index:n,frequency:e,amplitude:t,color:s,mousePos:a,plucked:r})=>{const c=w.useRef(null),[l,o]=w.useState(0),[u,h]=w.useState(0),d=w.useMemo(()=>{const f=[];for(let y=0;y<100;y++){const _=y/100*4-2;f.push(new Gt(_,0,0))}return f},[]);Jt(f=>{if(!c.current)return;const p=c.current.geometry.attributes.position,g=4,y=100;o(S=>S+e*.01),r&&h(S=>S+.2);const _=r?Math.exp(-u)*.5:0;for(let S=0;S<y;S++){const C=S/y*g-g/2,I=(a.x/window.innerWidth-.5)*8,b=(a.y/window.innerHeight-.5)*6,N=(n-2)*.4,j=Math.sqrt(Math.pow(I-C,2)+Math.pow(b-N,2)),v=Math.max(0,1-j/2)*.3,x=(t+v+_)*Math.sin(e*C+l),M=x,E=x*.2;p.setXYZ(S,C,M,E)}p.needsUpdate=!0,c.current.position.y=(n-2)*.4});const m=w.useMemo(()=>new Os().setFromPoints(d),[d]);return i.jsx("line",{ref:c,geometry:m,children:i.jsx("lineBasicMaterial",{color:s,linewidth:2,transparent:!0,opacity:.8})})},bc=({isActive:n,audioData:e,valence:t,arousal:s,mousePos:a,pluckedIndex:r})=>{const c=w.useMemo(()=>{const l=t<0?1:2,o=s*.2;return[{frequency:l,amplitude:e?.bass?e.bass/255*.3:o,color:"#FF4444"},{frequency:l*1.5,amplitude:e?.midLow?e.midLow/255*.3:o*.8,color:"#FF8844"},{frequency:l*2,amplitude:e?.mid?e.mid/255*.3:o*.6,color:"#FFDD44"},{frequency:l*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:o*.4,color:"#44DDFF"},{frequency:l*3,amplitude:e?.treble?e.treble/255*.3:o*.2,color:"#8844FF"}]},[e,t,s]);return i.jsx("group",{children:c.map((l,o)=>i.jsx(_c,{index:o,frequency:l.frequency,amplitude:l.amplitude,color:l.color,mousePos:a,plucked:r===o},o))})},xc=({isActive:n=!1,audioData:e=null,valence:t=0,arousal:s=.5})=>{const[a,r]=w.useState({x:0,y:0}),[c,l]=w.useState(-1);w.useEffect(()=>{const u=h=>{r({x:h.clientX,y:h.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const o=u=>{const h=u.currentTarget.getBoundingClientRect(),d=u.clientY-h.top,m=Math.floor(d/h.height*5);l(m),setTimeout(()=>l(-1),1e3)};return i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:n?"auto":"none",zIndex:0},onClick:o,children:i.jsxs(_s,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(bc,{isActive:n,audioData:e,valence:t,arousal:s,mousePos:a,pluckedIndex:c})]})})},Ka=({pattern:n,isActive:e=!1,triggerRipple:t,progress:s=0,dominantColor:a="#D4AF37",layer:r="foreground",placement:c="center",sizePx:l,opacity:o,audioData:u=null,valence:h=0,arousal:d=.5,onComplete:m})=>{const[f,p]=w.useState(!1),[g,y]=w.useState(!1);return w.useEffect(()=>{const _=()=>{p(window.innerWidth<768)},S=window.matchMedia("(prefers-reduced-motion: reduce)");y(S.matches),_(),window.addEventListener("resize",_);const C=I=>{y(I.matches)};return S.addEventListener("change",C),()=>{window.removeEventListener("resize",_),S.removeEventListener("change",C)}},[]),f||g||n==="none"?null:i.jsxs(i.Fragment,{children:[n==="spiral"&&i.jsx(hc,{isActive:e}),n==="lissajous"&&i.jsx(pc,{isActive:e}),n==="ripples"&&i.jsx(gc,{isActive:e,triggerRipple:t}),n==="polyhedron"&&i.jsx(yc,{isActive:e,progress:s,dominantColor:a,onComplete:m,layer:r,placement:c,sizePx:l,opacity:o}),n==="stringVibration"&&i.jsx(xc,{isActive:e,audioData:u,valence:h,arousal:d})]})},Ft="https://airia-beyond.onrender.com";async function ni(n){const e=await fetch(`${Ft}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate image")}return e.json()}async function wc(n,e){const t=await fetch(`${Ft}/api/job/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get job status")}return t.json()}async function tn(n,e,t=60,s=2e3,a){for(let r=0;r<t;r++){if(a?.aborted)throw new DOMException("Aborted","AbortError");const c=await wc(n,a);if(e&&e(c),c.status==="succeeded"||c.status==="failed")return c;await new Promise(l=>setTimeout(l,s))}throw new Error("Job polling timeout")}async function Nc(n){const e=await fetch(`${Ft}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to chat")}return e.json()}async function Sc(n){const e=await fetch(`${Ft}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to refine event")}return e.json()}async function jc(n){const e=await fetch(`${Ft}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to name album title")}return e.json()}async function Tc(n){const e=await fetch(`${Ft}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to resolve music preview")}return e.json()}async function an(n){const e=await tt(`${Ft}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate music")}return e.json()}async function kc(n,e){const t=await tt(`${Ft}/api/music/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get music job status")}return t.json()}async function us(n,e,t=60,s=2e3,a){for(let r=0;r<t;r++){if(a?.aborted)throw new DOMException("Aborted","AbortError");const c=await kc(n,a);if(e&&e(c),c.status==="succeeded"||c.status==="failed")return c;await new Promise(l=>setTimeout(l,s))}throw new Error("Music job polling timeout")}const Cc="airia_onboarding_data";function Ac(){try{const n=localStorage.getItem(Cc);if(!n)return null;const e=JSON.parse(n);return!e||typeof e!="object"?null:e}catch{return null}}function da(n){return Math.max(0,Math.min(1,n))}function Mc(n){return Math.max(-1,Math.min(1,n))}function ha(n){switch(String(n??"").trim()){case"穏やか":return{valence:.15,arousal:.25};case"嬉しい":return{valence:.65,arousal:.65};case"不安":return{valence:-.55,arousal:.65};case"疲れ":return{valence:-.2,arousal:.25};case"怒り":return{valence:-.65,arousal:.85};case"悲しい":return{valence:-.7,arousal:.35};case"興奮":return{valence:.5,arousal:.9};case"退屈":return{valence:-.1,arousal:.15};default:return{valence:0,arousal:.45}}}function Ec(n){const e=new Set,t=n.recentMomentEmotion||n.dailyPatternEmotion,s=String(t??"").trim();e.add("余韻"),e.add("光"),s==="不安"?(e.add("霧"),e.add("揺れ")):s==="穏やか"?(e.add("水面"),e.add("静寂")):s==="疲れ"?(e.add("夜"),e.add("静寂")):s==="嬉しい"?(e.add("風"),e.add("朝")):s==="悲しい"?(e.add("影"),e.add("雨")):s==="怒り"?(e.add("火"),e.add("鋭さ")):s==="興奮"?(e.add("閃光"),e.add("躍動")):s==="退屈"&&(e.add("無音"),e.add("空"));const a=String(n.emotionalGoal??"").trim();return a.includes("集中")&&e.add("集中"),(a.includes("安心")||a.includes("安"))&&e.add("安心"),a.includes("眠")&&e.add("眠り"),a.includes("整")&&e.add("整う"),[...e].slice(0,5)}function Ic(n){const e=n.recentMomentEmotion||n.dailyPatternEmotion||"未指定",t=String(n.emotionalGoal??"").trim(),s=String(n.emotionalTrigger??"").trim();return{emotionalProfile:[`startMode:${n.startMode||"未指定"}`,`mood:${e}`,t?`goal:${t.slice(0,80)}`:null,s?`trigger:${s.slice(0,60)}`:null].filter(Boolean).join(" / "),preferences:{...n,startMode:n.startMode}}}function Dc(n){const e=ha(n.recentMomentEmotion),t=ha(n.dailyPatternEmotion),s=Mc((e.valence+t.valence)/2),a=da((e.arousal+t.arousal)/2),r=da(n.startMode==="create"?.78:.68),c=Ec(n),l=.65,o=n.startMode==="create"?210:180;return{valence:s,arousal:a,focus:r,motif_tags:c,confidence:l,duration:o}}function Pc(n){const e=String(n.title).trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),a=Math.abs(s.split("").reduce((c,l)=>c*33+l.charCodeAt(0),7))%360,r=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${a} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(a+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(a+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${ma(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${ma(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">Generated from onboarding</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(r)}`}function ma(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}const vi="airia_pending_chat_generation_v1",yi="airia_pending_onboarding_generation_v1";function Yn(){try{const n=localStorage.getItem(vi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="chat"||!e.musicJobId?null:e}catch{return null}}function pa(n){try{localStorage.setItem(vi,JSON.stringify(n))}catch{}}function fa(){try{localStorage.removeItem(vi)}catch{}}function Ms(){try{const n=localStorage.getItem(yi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="onboarding"||!e.musicJobId||!e.request||!e.coverDataUrl?null:e}catch{return null}}function ga(n){try{localStorage.setItem(yi,JSON.stringify(n))}catch{}}function As(){try{localStorage.removeItem(yi)}catch{}}function Qa({open:n,title:e,description:t,cancelLabel:s="キャンセル",confirmLabel:a="実行",confirmTone:r="primary",onCancel:c,onConfirm:l}){return w.useEffect(()=>{if(!n)return;const o=u=>{u.key==="Escape"&&c(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&l()};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[n,c,l]),n?i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"confirm-dialog-backdrop",onClick:c}),i.jsxs("div",{className:"confirm-dialog",role:"dialog","aria-modal":"true","aria-label":e,children:[i.jsxs("div",{className:"confirm-dialog-header",children:[i.jsxs("div",{children:[i.jsx("div",{className:"confirm-dialog-eyebrow",children:"確認"}),i.jsx("h2",{className:"confirm-dialog-title",children:e})]}),i.jsx("button",{className:"confirm-dialog-close",onClick:c,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),t?i.jsx("div",{className:"confirm-dialog-body",children:t}):null,i.jsxs("div",{className:"confirm-dialog-actions",children:[i.jsx("button",{className:"btn btn-secondary",onClick:c,children:s}),i.jsx("button",{className:r==="danger"?"btn btn-primary confirm-dialog-danger":"btn btn-primary",onClick:l,children:a})]}),i.jsx("div",{className:"confirm-dialog-shortcut",children:"確定: クリック / (Ctrl+Enter)"})]})]}):null}function er({active:n,statusText:e,elapsedSec:t=0,onCancel:s}){if(!n)return null;const r=.85-.35*Math.max(0,Math.min(1,t/22));return i.jsxs("div",{className:"gen-frost",style:{"--frost":r},"aria-live":"polite","aria-busy":"true",children:[i.jsx("div",{className:"gen-frost-surface"}),i.jsxs("div",{className:"gen-frost-card",role:"status",children:[i.jsx("div",{className:"gen-frost-title",children:"生成中"}),i.jsxs("div",{className:"gen-frost-status",children:[e||"進行中…",i.jsxs("span",{className:"gen-frost-elapsed",children:["（",t,"s）"]})]}),s?i.jsx("button",{className:"gen-frost-cancel",onClick:s,type:"button",children:"キャンセル"}):null]})]})}const Oc=({onExit:n})=>{const{albums:e,addAlbum:t,selectAlbum:s}=wt(),{requestPlayAlbum:a}=Rt(),{addToast:r}=bs(),[c,l]=w.useState(!1),[o,u]=w.useState(null),[h,d]=w.useState(0),[m,f]=w.useState(!1),[p,g]=w.useState(null),[y,_]=w.useState(null),[S,C]=w.useState(null),[I,b]=w.useState(0),[N,j]=w.useState(!1),v=w.useRef(!1),x=w.useRef(null),M=w.useRef(!1),[E,D]=w.useState(!1),R=w.useMemo(()=>e.filter($=>$.musicData),[e]);w.useEffect(()=>{const $=Ms();j(!!$),$&&!M.current&&(M.current=!0,r("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]);const T=$=>{u($),l(!0)},F=()=>{l(!1),u(null),d(0),f(!1),g(null),_(null),C(null),b(0),x.current?.abort(),x.current=null,As(),j(!1),v.current=!1};w.useEffect(()=>{if(!m||!S)return;b(Math.max(0,Math.floor((Date.now()-S)/1e3)));const $=window.setInterval(()=>{b(Math.max(0,Math.floor((Date.now()-S)/1e3)))},1e3);return()=>window.clearInterval($)},[m,S]);const q=$=>$.recentMomentEmotion||$.dailyPatternEmotion||"穏やか",L=async()=>{if(!o||m)return;const $=Ms();if(!$)return;g(null),_("再開中…"),f(!0),C($.startedAt||Date.now()),b(0),r("info","生成を再開しています…"),x.current?.abort();const Q=new AbortController;x.current=Q;try{const O=await us($.musicJobId,P=>{P.status==="queued"?_("順番待ち…"):P.status==="running"?_("生成中…"):P.status==="succeeded"?_("仕上げ中…"):P.status==="failed"&&_("失敗しました")},90,2e3,Q.signal);if(O.status!=="succeeded"||!O.midiData||!O.result)throw new Error(O.errorMessage||O.error||"曲生成に失敗しました");_("保存しています…");const k=t({title:$.title,mood:$.mood,duration:$.request.duration,imageDataURL:$.coverDataUrl,thumbnailUrl:$.coverDataUrl,metadata:{valence:$.request.valence,arousal:$.request.arousal,focus:$.request.focus,motif_tags:$.request.motif_tags,confidence:$.request.confidence,provider:"rule-based"},musicData:O.midiData,musicFormat:"midi",musicMetadata:{key:O.result.key,tempo:O.result.tempo,timeSignature:O.result.timeSignature,form:O.result.form,character:O.result.character,duration:$.request.duration,createdAt:new Date().toISOString(),provider:O.provider},sessionData:{onboarding:o}});s(k.id),a(k,[k,...R]),As(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(O){if(O instanceof DOMException&&O.name==="AbortError"){_("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}g(O instanceof Error?O.message:"曲生成に失敗しました"),_(null),r("error",O instanceof Error?O.message:"曲生成に失敗しました")}finally{f(!1),x.current=null}},B=async()=>{if(m||!o)return;const $=Ms();if(!$)return;g(null),_("再生成を開始しています…"),f(!0),C(Date.now()),b(0),r("info","同じ条件で再生成を開始しました。"),x.current?.abort();const Q=new AbortController;x.current=Q;try{const O=await an($.request);ga({...$,startedAt:Date.now(),musicJobId:O.jobId}),j(!0);const k=await us(O.jobId,A=>{A.status==="queued"?_("順番待ち…"):A.status==="running"?_("生成中…"):A.status==="succeeded"?_("仕上げ中…"):A.status==="failed"&&_("失敗しました")},90,2e3,Q.signal);if(k.status!=="succeeded"||!k.midiData||!k.result)throw new Error(k.errorMessage||k.error||"曲生成に失敗しました");_("保存しています…");const P=t({title:$.title,mood:$.mood,duration:$.request.duration,imageDataURL:$.coverDataUrl,thumbnailUrl:$.coverDataUrl,metadata:{valence:$.request.valence,arousal:$.request.arousal,focus:$.request.focus,motif_tags:$.request.motif_tags,confidence:$.request.confidence,provider:"rule-based"},musicData:k.midiData,musicFormat:"midi",musicMetadata:{key:k.result.key,tempo:k.result.tempo,timeSignature:k.result.timeSignature,form:k.result.form,character:k.result.character,duration:$.request.duration,createdAt:new Date().toISOString(),provider:k.provider},sessionData:{onboarding:o}});s(P.id),a(P,[P,...R]),As(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(O){if(O instanceof DOMException&&O.name==="AbortError"){_("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}const k=O instanceof Error?O.message:"曲生成に失敗しました";g(k),_(null),r("error",k)}finally{f(!1),x.current=null}},G=async()=>{if(!o||m)return;g(null),_("準備中…"),f(!0),C(Date.now()),b(0),x.current?.abort();const $=new AbortController;x.current=$;try{const Q=q(o),O=`${Date.now()}`,k=Pc({title:"はじめの一曲",mood:Q,seed:O}),P=Dc(o);_("作曲を開始しています…");const A=await an({...P,seed:Number(O.slice(-9))});ga({v:1,kind:"onboarding",startedAt:Date.now(),musicJobId:A.jobId,request:{...P,seed:Number(O.slice(-9))},mood:Q,title:"はじめの一曲",coverDataUrl:k}),j(!0),r("info","生成を開始しました。完了まで待つか、あとで再開できます。"),_("生成中…（1〜2分かかることがあります）");const W=await us(A.jobId,ae=>{ae.status==="queued"?_("順番待ち…"):ae.status==="running"?_("生成中…"):ae.status==="succeeded"?_("仕上げ中…"):ae.status==="failed"&&_("失敗しました")},90,2e3,$.signal);if(W.status!=="succeeded"||!W.midiData||!W.result)throw new Error(W.errorMessage||W.error||"曲生成に失敗しました");_("保存しています…");const Z=t({title:"はじめの一曲",mood:Q,duration:P.duration,imageDataURL:k,thumbnailUrl:k,metadata:{valence:P.valence,arousal:P.arousal,focus:P.focus,motif_tags:P.motif_tags,confidence:P.confidence,provider:"rule-based"},musicData:W.midiData,musicFormat:"midi",musicMetadata:{key:W.result.key,tempo:W.result.tempo,timeSignature:W.result.timeSignature,form:W.result.form,character:W.result.character,duration:P.duration,createdAt:new Date().toISOString(),provider:W.provider},sessionData:{onboarding:o}});s(Z.id),a(Z,[Z,...R]),As(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(Q){if(Q instanceof DOMException&&Q.name==="AbortError"){_("キャンセルしました"),C(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。");return}g(Q instanceof Error?Q.message:"曲生成に失敗しました"),_(null),C(null),b(0),r("error",Q instanceof Error?Q.message:"曲生成に失敗しました")}finally{f(!1),x.current=null}},X=()=>{m&&(x.current?.abort(),f(!1),_("キャンセルしました"),C(null),b(0),r("info","生成を中断しました。あとで再開できます。"))},H=()=>{As(),j(!1),_(null),g(null),r("info","保留中の生成を破棄しました。")},K=()=>{m&&(x.current?.abort(),x.current=null,f(!1),_("キャンセルしました"),C(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。"))};return w.useEffect(()=>{!c||!o||v.current||o.startMode==="create"&&(v.current=!0,Ms()?L():G())},[c,o]),i.jsxs("div",{className:"room-content onboarding-room","data-no-swipe":"true",children:[i.jsx(er,{active:m,statusText:y,elapsedSec:I,onCancel:K}),i.jsx(Qa,{open:E,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>D(!1),onConfirm:()=>{D(!1),H()}}),!c&&i.jsx(Ka,{pattern:"polyhedron",isActive:!0,progress:h,layer:"background",placement:"center",sizePx:420,opacity:.16}),i.jsx("h1",{className:"room-title",children:"はじめに"}),i.jsx("p",{className:"room-subtitle",children:"あなたに合う体験へ整えます"}),c?i.jsxs("div",{className:"onboarding-complete",children:[i.jsx("h2",{className:"blend-text",children:"完了しました！"}),i.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",i.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),p?i.jsx("div",{className:"form-error",children:p}):null,y?i.jsxs("div",{className:"onboarding-generate-status",children:[y,S?i.jsxs("span",{className:"onboarding-generate-elapsed",children:["（",I,"s）"]}):null]}):null,i.jsxs("div",{className:"button-group",children:[i.jsx("button",{className:"btn btn-secondary",onClick:F,children:"回答を編集"}),i.jsx("button",{className:"btn btn-primary",onClick:()=>void G(),disabled:m,"data-no-swipe":!0,title:"オンボーディング回答から1曲生成して、そのまま再生します",children:m?"1曲生成中…":"1曲作ってはじめる"}),!m&&N?i.jsx("button",{className:"btn btn-secondary",onClick:()=>void L(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!m&&N&&p?i.jsx("button",{className:"btn btn-secondary",onClick:()=>void B(),"data-no-swipe":!0,type:"button",title:"失敗・停止した場合に、同じ条件で作り直します",children:"再生成"}):null,!m&&N?i.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null,m?i.jsx("button",{className:"btn btn-secondary",onClick:X,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,i.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!o)return;const $=JSON.stringify(o,null,2),Q=new Blob([$],{type:"application/json"}),O=URL.createObjectURL(Q),k=document.createElement("a");k.href=O,k.download="getting_started_profile.json",k.click(),URL.revokeObjectURL(O)},children:"プロフィールをダウンロード"}),i.jsx("button",{className:"btn btn-success",onClick:()=>{n?.()},children:"はじめる"})]})]}):i.jsx(uc,{onComplete:T,onProgressChange:d})]})},Rc=void 0,Fc=({onBack:n})=>{const{loginWithGoogle:e,loginWithApple:t,loginWithPassword:s,registerWithPassword:a,busy:r}=xn(),c=V.useRef(null),[l,o]=V.useState(null),[u,h]=V.useState(null),[d,m]=V.useState(()=>{try{return String(window.location.hash||"").toLowerCase()==="#signup"?"signup":"login"}catch{return"login"}});V.useEffect(()=>{try{const R=String(window.location.hash||"").toLowerCase();R==="#signup"&&m("signup"),R==="#login"&&m("login")}catch{}},[]),V.useEffect(()=>{o(null),h(null)},[e]);const f=async()=>{o(null),h(null);{o("Apple Client ID が未設定です");return}},p=!!Rc,[g,y]=V.useState(""),[_,S]=V.useState(""),[C,I]=V.useState(""),[b,N]=V.useState(""),[j,v]=V.useState(""),x=!!(g.trim()&&_),M=!!(b.trim()&&j),E=async R=>{R.preventDefault(),o(null),h(null);try{await a({email:g,password:_,displayName:C||void 0})}catch(T){o(T instanceof Error?T.message:String(T))}},D=async R=>{R.preventDefault(),o(null),h(null);try{await s({identifier:b,password:j})}catch(T){o(T instanceof Error?T.message:String(T))}};return i.jsx("div",{className:"room-content auth-room",children:i.jsxs("div",{className:"auth-card","data-no-swipe":"true",children:[n?i.jsx("div",{style:{marginBottom:8},children:i.jsx("button",{className:"btn",onClick:n,disabled:r,children:"← 戻る"})}):null,i.jsxs("div",{className:"auth-tabs",role:"tablist","aria-label":"認証モード",children:[i.jsx("button",{type:"button",role:"tab","aria-selected":d==="signup",className:`auth-tab ${d==="signup"?"active":""}`,onClick:()=>{m("signup");try{window.location.hash="#signup"}catch{}},disabled:r,children:"新規登録"}),i.jsx("button",{type:"button",role:"tab","aria-selected":d==="login",className:`auth-tab ${d==="login"?"active":""}`,onClick:()=>{m("login");try{window.location.hash="#login"}catch{}},disabled:r,children:"ログイン"})]}),i.jsx("h1",{className:"auth-title",children:"AIRIA"}),i.jsx("p",{className:"auth-subtitle",children:d==="signup"?"無料で始める（初回ログイン＝登録）":"おかえりなさい。ログインして続ける"}),r?i.jsx("div",{className:"auth-loading","aria-live":"polite","aria-busy":"true",children:i.jsxs("div",{className:"auth-loading-row",children:[i.jsx("div",{className:"auth-spinner","aria-hidden":"true"}),i.jsxs("div",{children:[i.jsx("div",{className:"auth-loading-title",children:"処理中…"}),i.jsx("div",{className:"auth-loading-sub",children:"通信環境によっては時間がかかる場合があります。安全にログイン処理を行っています。"})]})]})}):null,i.jsx("div",{className:"auth-note",children:d==="signup"?i.jsx(i.Fragment,{children:i.jsx("p",{children:"メール/パスワード、または Google / Apple でアカウントを作成できます。"})}):i.jsxs(i.Fragment,{children:[i.jsx("p",{children:"メール/パスワード、または以前使った Google / Apple でログインしてください。"}),i.jsxs("p",{children:["初めての方は"," ",i.jsx("button",{type:"button",className:"auth-inline-link",onClick:()=>{m("signup");try{window.location.hash="#signup"}catch{}},disabled:r,children:"新規登録"}),"。"]})]})}),d==="signup"?i.jsxs("form",{className:"auth-form",onSubmit:R=>void E(R),children:[i.jsxs("label",{className:"auth-label",children:["メールアドレス",i.jsx("input",{className:"auth-input",type:"email",value:g,onChange:R=>y(R.target.value),placeholder:"you@example.com",autoComplete:"email",disabled:r,required:!0})]}),i.jsxs("label",{className:"auth-label",children:["パスワード（6文字以上）",i.jsx("input",{className:"auth-input",type:"password",value:_,onChange:R=>S(R.target.value),placeholder:"••••••",autoComplete:"new-password",disabled:r,required:!0,minLength:6})]}),i.jsxs("label",{className:"auth-label",children:["表示名（任意）",i.jsx("input",{className:"auth-input",type:"text",value:C,onChange:R=>I(R.target.value),placeholder:"AIRIAユーザー",autoComplete:"nickname",disabled:r})]}),i.jsx("button",{className:"btn auth-submit",type:"submit",disabled:r||!x,children:r?"作成中…":"メールで新規登録"})]}):i.jsxs("form",{className:"auth-form",onSubmit:R=>void D(R),children:[i.jsxs("label",{className:"auth-label",children:["メールアドレス / ハンドル",i.jsx("input",{className:"auth-input",type:"text",value:b,onChange:R=>N(R.target.value),placeholder:"you@example.com または your_handle",autoComplete:"username",disabled:r,required:!0})]}),i.jsxs("label",{className:"auth-label",children:["パスワード",i.jsx("input",{className:"auth-input",type:"password",value:j,onChange:R=>v(R.target.value),placeholder:"••••••",autoComplete:"current-password",disabled:r,required:!0})]}),i.jsx("button",{className:"btn auth-submit",type:"submit",disabled:r||!M,children:r?"ログイン中…":"メールでログイン"})]}),i.jsxs("div",{className:"auth-sep","aria-hidden":"true",children:[i.jsx("span",{}),i.jsx("div",{children:"または"}),i.jsx("span",{})]}),i.jsxs("div",{className:"auth-actions",children:[i.jsx("div",{className:`auth-google ${p?"":"disabled"}`,children:p?i.jsx("div",{ref:c}):i.jsx("button",{className:"btn",disabled:!0,children:"Googleでログイン（未設定）"})}),i.jsxs("button",{className:"btn btn-apple",onClick:()=>void f(),disabled:r||!0,children:["Appleでログイン","（未設定）"]})]}),l&&i.jsx("div",{className:"auth-error",children:l}),u&&i.jsx("div",{className:"auth-success",children:u})]})})},Lc=({onStart:n,onOpenTerms:e,onOpenPrivacy:t})=>{const s=a=>{const r=document.getElementById(a);r&&"scrollIntoView"in r&&r.scrollIntoView({behavior:"smooth",block:"start"})};return i.jsxs("div",{className:"room-content landing-room",children:[i.jsx("div",{className:"landing-hero","data-no-swipe":"true",children:i.jsxs("div",{className:"landing-hero-inner",children:[i.jsxs("div",{className:"landing-hero-copy",children:[i.jsxs("div",{className:"landing-hero-toprow",children:[i.jsx("div",{className:"landing-eyebrow",children:"MOOD → IMAGE → MUSIC"}),(t||e)&&i.jsxs("div",{className:"landing-legal","aria-label":"Legal",children:[t?i.jsx("button",{type:"button",className:"landing-legal-link",onClick:t,children:"Privacy"}):null,t&&e?i.jsx("span",{className:"landing-legal-sep","aria-hidden":"true",children:"·"}):null,e?i.jsx("button",{type:"button",className:"landing-legal-link",onClick:e,children:"Terms"}):null]})]}),i.jsxs("h1",{className:"landing-title",children:["AIRIA BEYOND",i.jsx("span",{className:"landing-title-sub",children:"感情を、作品に変える。"})]}),i.jsxs("p",{className:"landing-lead",children:["その日の気分を記録して、抽象画とクラシック風の音楽へ。",i.jsx("br",{}),"“言葉にならない”を、見える・聴ける形にして保存します。"]}),i.jsxs("div",{className:"landing-cta",children:[i.jsx("button",{className:"btn btn-primary landing-cta-primary",onClick:()=>{try{window.location.hash="#signup"}catch{}n()},children:"無料で新規登録"}),i.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>{try{window.location.hash="#login"}catch{}n()},children:"ログイン"}),i.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>s("landing-how"),"aria-label":"AIRIAの使い方へスクロール",children:"どうやって動く？"})]}),i.jsxs("div",{className:"landing-meta",children:[i.jsx("span",{className:"landing-chip",children:"プレリリース"}),i.jsx("span",{className:"landing-chip",children:"Google / Apple ログイン"}),i.jsx("span",{className:"landing-chip",children:"生成失敗でも止めない設計"}),i.jsx("span",{className:"landing-chip",children:"最短ルート：ログイン → 「創作から」"})]}),i.jsx("div",{className:"landing-signup-note",children:"初めての方も、このボタンでOKです（初回ログイン＝新規登録）。パスワード登録はありません。"})]}),i.jsxs("div",{className:"landing-hero-cover","aria-label":"サンプルプレビュー",children:[i.jsxs("div",{className:"landing-cover-card",children:[i.jsxs("div",{className:"landing-cover-top",children:[i.jsx("div",{className:"landing-cover-kicker",children:"Today’s Session"}),i.jsx("div",{className:"landing-cover-date",children:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),i.jsx("div",{className:"landing-cover-title",children:"静けさと余白"}),i.jsx("div",{className:"landing-cover-sub",children:"穏やか / 3:00 / Focus 0.62"}),i.jsx("div",{className:"landing-cover-image",role:"img","aria-label":"生成イメージのモック"}),i.jsxs("div",{className:"landing-cover-bottom",children:[i.jsxs("div",{className:"landing-cover-pills",children:[i.jsx("span",{className:"landing-pill",children:"Valence"}),i.jsx("span",{className:"landing-pill",children:"Arousal"}),i.jsx("span",{className:"landing-pill",children:"Motif"})]}),i.jsxs("div",{className:"landing-cover-wave","aria-hidden":"true",children:[i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"})]})]})]}),i.jsx("div",{className:"landing-cover-note",children:"これは体験イメージです。実際の生成はあなたの入力に合わせて変化します。"})]})]})}),i.jsxs("section",{className:"landing-section",id:"landing-how",children:[i.jsxs("div",{className:"landing-section-head",children:[i.jsx("h2",{className:"landing-h2",children:"体験は“記事”のように読み進められる"}),i.jsx("p",{className:"landing-sub",children:"AIRIAは、ただの生成ツールではなく「自分の状態を読み解くための記録」です。 迷いにくい導線と、気持ちよく続くUIを優先しました。"})]}),i.jsxs("div",{className:"landing-steps","data-no-swipe":"true",children:[i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"01"}),i.jsx("h3",{className:"landing-h3",children:"気分を入力"}),i.jsx("p",{className:"landing-p",children:"短い質問に答えるだけ。言語化が苦手でもOK。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"02"}),i.jsx("h3",{className:"landing-h3",children:"抽象画を生成"}),i.jsx("p",{className:"landing-p",children:"色・構図・質感で、その日の“温度”を可視化します。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"03"}),i.jsx("h3",{className:"landing-h3",children:"音楽を生成"}),i.jsx("p",{className:"landing-p",children:"クラシック風の短編。再生バーからすぐ聴けます。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"04"}),i.jsx("h3",{className:"landing-h3",children:"保存・共有"}),i.jsx("p",{className:"landing-p",children:"Socialに公開、反応を受け取る。非公開・削除も可能です。"})]})]}),i.jsx("div",{className:"landing-divider"}),i.jsxs("div",{className:"landing-grid","data-no-swipe":"true",children:[i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"止まらない体験"}),i.jsx("p",{className:"landing-p",children:"生成が失敗しても、placeholderや緊急MIDIで進行します。待ち時間のストレスを最小化。"})]}),i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"説明可能性"}),i.jsx("p",{className:"landing-p",children:"“なぜこの作品になったか”を見える形で提示。ブラックボックス感を減らします。"})]}),i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"運用前提の設計"}),i.jsx("p",{className:"landing-p",children:"OAuth-only、レート制限、通知（任意）など、プレリリースでも破綻しにくい土台を用意。"})]})]})]}),i.jsxs("section",{className:"landing-section landing-section-narrow",children:[i.jsxs("div",{className:"landing-section-head",children:[i.jsx("h2",{className:"landing-h2",children:"コンセプト"}),i.jsx("p",{className:"landing-sub",children:"“感情を作品に変える”は、自己理解の入り口になる。"})]}),i.jsxs("article",{className:"landing-article","data-no-swipe":"true",children:[i.jsx("p",{className:"landing-article-p",children:"気分は、言葉で説明しきれないことが多い。AIRIAは、入力を起点に「視覚」と「音楽」でその輪郭をつくります。 生成物は正解ではなく、あなたが自分を読み解くための“鏡”。"}),i.jsx("p",{className:"landing-article-p",children:"だからUIは、派手さよりも継続性を優先。余白、静けさ、そして必要なときだけ現れる強い導線。 アプリ全体がひとつの短い文章のように流れる設計です。"}),i.jsxs("div",{className:"landing-quote",children:[i.jsx("div",{className:"landing-quote-mark","aria-hidden":"true",children:"“"}),i.jsxs("div",{children:[i.jsx("div",{className:"landing-quote-text",children:"今日を作品として保存できると、気分は“消費”ではなく“蓄積”になる。"}),i.jsx("div",{className:"landing-quote-sub",children:"AIRIA BEYOND / Design note"})]})]})]})]}),i.jsxs("section",{className:"landing-section landing-bottom","data-no-swipe":"true",children:[i.jsxs("div",{className:"landing-bottom-inner",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"landing-h2",children:"準備はできましたか？"}),i.jsx("p",{className:"landing-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),i.jsxs("div",{className:"landing-bottom-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:n,children:"ログインしてはじめる"}),i.jsx("button",{className:"btn",onClick:()=>s("landing-how"),children:"もう一度読む"})]})]}),i.jsxs("footer",{className:"landing-footer",children:[i.jsxs("div",{className:"landing-footer-row",children:[i.jsx("div",{className:"landing-footer-brand",children:"AIRIA BEYOND"}),i.jsx("div",{className:"landing-footer-note",children:"Pre-release / OAuth-only"})]}),(t||e)&&i.jsxs("div",{className:"landing-footer-links","aria-label":"Legal",children:[t?i.jsx("button",{type:"button",className:"landing-footer-link",onClick:t,children:"プライバシー"}):null,e?i.jsx("button",{type:"button",className:"landing-footer-link",onClick:e,children:"利用規約"}):null]})]})]})]})},Vc=()=>i.jsxs("div",{className:"legal-page",children:[i.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[i.jsx("h2",{children:"1. サービスの概要 / Service Overview"}),i.jsx("p",{children:"AIRIA BEYONDは、AI搭載の感情分析・クラシック音楽・絵画生成アプリケーションです。 ユーザーの感情状態を分析し、それに基づいてクラシック音楽や絵画を生成します。"}),i.jsx("p",{children:"AIRIA BEYOND is an AI-powered application for emotion analysis, classical music, and painting generation. It analyzes users' emotional states and generates classical music and paintings based on the analysis."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"2. データの取り扱い / Data Handling"}),i.jsx("p",{children:"個人を特定できる情報は送信されません。セッションデータ、生成された画像・音楽は ブラウザのローカルストレージに保存されます。"}),i.jsx("p",{children:"No personally identifiable information is transmitted. Session data, generated images and music are stored in browser's local storage."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"3. 使用制限 / Usage Restrictions"}),i.jsx("p",{children:"本サービスは個人的な使用のみを目的としています。商用利用には事前の許可が必要です。"}),i.jsx("p",{children:"This service is intended for personal use only. Commercial use requires prior permission."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"4. 免責事項 / Disclaimer"}),i.jsx("p",{children:"本サービスは「現状のまま」提供されます。生成されたコンテンツの正確性や適切性について 保証しません。"}),i.jsx("p",{children:'This service is provided "as is". We do not guarantee the accuracy or appropriateness of generated content.'})]}),i.jsx("div",{className:"legal-note",children:"プレリリース期間中は仕様が更新される場合があります。重要な変更はアプリ内のお知らせで通知します。"})]}),qc=()=>i.jsxs("div",{className:"legal-page",children:[i.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[i.jsx("h2",{children:"1. 収集する情報 / Information We Collect"}),i.jsxs("ul",{children:[i.jsx("li",{children:"セッションデータ（気分、時間） / Session data (mood, duration)"}),i.jsx("li",{children:"生成された画像・音楽 / Generated images and music"}),i.jsx("li",{children:"アクセスログ / Access logs"}),i.jsx("li",{children:"パフォーマンス指標 / Performance metrics"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"2. データの使用目的 / Purpose of Data Use"}),i.jsx("p",{children:"収集したデータは以下の目的で使用されます："}),i.jsxs("ul",{children:[i.jsx("li",{children:"サービスの提供と改善 / Service provision and improvement"}),i.jsx("li",{children:"パフォーマンスの監視 / Performance monitoring"}),i.jsx("li",{children:"エラーのトラッキングと修正 / Error tracking and fixing"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"3. データの保存 / Data Storage"}),i.jsx("p",{children:"ユーザーデータは主にブラウザのローカルストレージに保存されます。 サーバー側では一時的な処理のみが行われます。"}),i.jsx("p",{children:"User data is primarily stored in browser's local storage. Server-side processing is temporary only."}),i.jsx("div",{className:"legal-note",children:"ログインによりサーバー側にユーザー情報が保存されます（例: ハンドル、表示名、フォロー関係）。 メール通知を有効化した場合は、通知先としてメールアドレスを保存します。"})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"4. 第三者サービス / Third-Party Services"}),i.jsx("p",{children:"本サービスは以下の第三者サービスを使用します："}),i.jsxs("ul",{children:[i.jsx("li",{children:"Replicate (画像生成 / Image generation)"}),i.jsx("li",{children:"OpenAI (感情分析 / Emotion analysis)"}),i.jsx("li",{children:"Render (APIホスティング / API hosting)"}),i.jsx("li",{children:"GitHub Pages (フロントエンド配信 / Frontend hosting)"}),i.jsx("li",{children:"Sentry (エラートラッキング / Error tracking) - オプション"}),i.jsx("li",{children:"Resend / SMTP (メール通知 / Email notifications) - オプション"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"5. お問い合わせ / Contact"}),i.jsx("p",{children:"プライバシーに関するご質問は、GitHubリポジトリのIssueにてお問い合わせください。"}),i.jsx("p",{children:"For privacy-related questions, please contact us via GitHub repository Issues."})]})]}),va=({kind:n,onBack:e,onStart:t})=>{const s=n==="terms"?"利用規約":"プライバシーポリシー",a=n==="terms"?"Terms of Service":"Privacy Policy";return i.jsxs("div",{className:"room-content legal-room","data-no-swipe":"true",children:[i.jsxs("div",{className:"legal-topbar",children:[i.jsx("button",{className:"btn",onClick:e,children:"← 戻る"}),i.jsx("div",{className:"legal-topbar-spacer"}),i.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインへ"})]}),i.jsxs("header",{className:"legal-hero",children:[i.jsx("div",{className:"legal-hero-kicker",children:"AIRIA BEYOND / Legal"}),i.jsxs("h1",{className:"legal-hero-title",children:[s,i.jsx("span",{className:"legal-hero-sub",children:a})]}),i.jsx("p",{className:"legal-hero-lead",children:"ここに書かれていることは“堅い文章”ですが、AIRIAが守ろうとしているのは体験の安心感です。 わからない点があれば、GitHubのIssueから相談できます。"})]}),i.jsx("main",{className:"legal-body",children:n==="terms"?i.jsx(Vc,{}):i.jsx(qc,{})}),i.jsx("div",{className:"legal-bottom","data-no-swipe":"true",children:i.jsxs("div",{className:"legal-bottom-inner",children:[i.jsxs("div",{children:[i.jsx("div",{className:"legal-bottom-title",children:"続きはアプリで"}),i.jsx("div",{className:"legal-bottom-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),i.jsxs("div",{className:"legal-bottom-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインしてはじめる"}),i.jsx("button",{className:"btn",onClick:e,children:"戻る"})]})]})})]})};function Wc(n,e,t){try{n(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(s){console.error("[CausalLog] Failed to log album creation stage:",s)}}function as(n,e,t,s,a){try{const c=e(t)?.errors||[];n(t,{errors:[...c,{stage:s,error:a,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",s)}catch(r){console.error("[CausalLog] Failed to log error:",r)}}function Xn(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function Bc(n){const e=String(n.title??"").trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),a=String(n.note).trim()||"Placeholder cover",r=Math.abs(s.split("").reduce((l,o)=>l*33+o.charCodeAt(0),7))%360,c=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${r} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(r+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(r+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${Xn(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${Xn(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">${Xn(a).slice(0,64)}</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(c)}`}function Uc({open:n,mood:e,defaultTitle:t,onCancel:s,onSubmit:a}){const[r,c]=w.useState(t??"");w.useEffect(()=>{n&&c(t??"")},[n,t]);const l=w.useMemo(()=>r.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[r]);return w.useEffect(()=>{if(!n)return;const o=u=>{u.key==="Escape"&&s(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&a(r)};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[n,s,a,r]),n?i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"album-title-backdrop",onClick:s}),i.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[i.jsxs("div",{className:"album-title-header",children:[i.jsxs("div",{children:[i.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),i.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),i.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),i.jsx("button",{className:"album-title-close",onClick:s,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),i.jsxs("div",{className:"album-title-body",children:[i.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),i.jsx("input",{id:"album-title-input",className:"album-title-input",value:r,placeholder:"例：雨上がりの余白",onChange:o=>c(o.target.value),autoFocus:!0}),i.jsx("div",{className:"album-title-hint",children:l}),i.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),i.jsxs("div",{className:"album-title-actions",children:[i.jsx("button",{className:"btn btn-secondary",onClick:s,children:"キャンセル"}),i.jsx("button",{className:"btn btn-primary",onClick:()=>a(r),children:"保存"})]})]})]}):null}function Hn(){return new Date().toISOString()}function Jn(n,e){return Bc({title:n?.brief?.theme?.title,mood:n?.image?.mood,seed:n?.image?.seed,note:e})}function Zn(n){return n?.effectiveProvider||n?.provider||(n?.status==="succeeded"?"image":"placeholder")}function $c(){const{albums:n,addAlbum:e,selectAlbum:t}=wt(),{createLog:s,updateLog:a,getLog:r}=za(),{requestPlayAlbum:c}=Rt(),{navigateToRoom:l}=St(),{addToast:o}=bs(),[u,h]=w.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[d,m]=w.useState(""),[f,p]=w.useState(!1),[g,y]=w.useState(null),[_,S]=w.useState([]),[C,I]=w.useState(null),[b,N]=w.useState(!1),[j,v]=w.useState(null),[x,M]=w.useState(null),[E,D]=w.useState(0),R=w.useRef(null),[T,F]=w.useState(!1),[q,L]=w.useState(!1),B=w.useRef(!1),[G,X]=w.useState(!1),[H,K]=w.useState(!1),[$,Q]=w.useState(null),[O,k]=w.useState(null),[P,A]=w.useState(!1),W=w.useRef(null),[Z,ae]=w.useState(null),[Te,lt]=w.useState({}),[$e,z]=w.useState({}),[J,ue]=w.useState({}),me=w.useMemo(()=>u.filter(U=>U.role==="user"),[u]),re=w.useMemo(()=>{const U=Ac();return U?Ic(U):null},[]),fe=w.useMemo(()=>n.filter(U=>U.musicData),[n]);w.useEffect(()=>{const U=Yn();F(!!U),U&&!B.current&&(B.current=!0,o("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]),w.useEffect(()=>()=>{R.current?.abort(),R.current=null,W.current&&(W.current.pause(),W.current.src="",W.current=null)},[]),w.useEffect(()=>{if(!b||!x)return;D(Math.max(0,Math.floor((Date.now()-x)/1e3)));const U=window.setInterval(()=>{D(Math.max(0,Math.floor((Date.now()-x)/1e3)))},1e3);return()=>window.clearInterval(U)},[b,x]);function qe(){b&&(R.current?.abort(),R.current=null,N(!1),v("キャンセルしました"),M(null),D(0),L(!1),o("info","生成を中断しました。あとで再開できます。"))}function ut(){fa(),F(!1),v(null),y(null),L(!1),o("info","保留中の生成を破棄しました。")}async function Wt(){const U=Yn();if(!U||b)return;y(null),L(!1),N(!0),v("再生成を開始しています…"),M(Date.now()),D(0),o("info","同じ条件で再生成を開始しました。"),R.current?.abort();const oe=new AbortController;R.current=oe;try{const Y=U.refined,ee=Jn(Y,"Image unavailable");let ge=null;try{v("画像生成を開始しています…"),ge=(await ni(Y.image)).jobId}catch(De){ge=null,o("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const xe=De instanceof Error?De.message:"image job start failed";U.causalLogId&&as(a,r,U.causalLogId,"image-generation-start",xe)}v("作曲を開始しています…");const be=await an(Y.music);pa({...U,startedAt:Date.now(),imageJobId:ge,musicJobId:be.jobId,coverDataUrl:U.coverDataUrl||ee}),F(!0);const Se=ge?tn(ge,De=>{De.status==="queued"?v("順番待ち…"):De.status==="running"?v("画像を生成中…"):De.status==="succeeded"?v("画像ができました。仕上げ中…"):De.status==="failed"&&v("画像生成に失敗しました")},90,2e3,oe.signal).catch(De=>{const xe=De instanceof Error?De.message:"image polling failed";return U.causalLogId&&as(a,r,U.causalLogId,"image-generation-poll",xe),null}):Promise.resolve(null),[Xe,Me]=await Promise.all([Se,us(be.jobId,De=>{De.status==="queued"?v("順番待ち…"):De.status==="running"?v("作曲中…"):De.status==="succeeded"?v("作曲ができました。仕上げ中…"):De.status==="failed"&&v("作曲に失敗しました")},90,2e3,oe.signal)]),de=Xe?.status==="succeeded"&&Xe?.resultUrl?Xe.resultUrl:ee;if(Xe?.status==="succeeded"&&Xe?.resultUrl||o("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Me.status!=="succeeded"||!Me.midiData||!Me.result)throw new Error("曲生成に失敗しました");const ns=Y?.brief?.theme?.title||"";Q({title:ns,mood:Y?.image?.mood,duration:Y?.image?.duration,imageDataURL:de,thumbnailUrl:de,metadata:{valence:Y?.analysisLike?.valence,arousal:Y?.analysisLike?.arousal,focus:Y?.analysisLike?.focus,motif_tags:Y?.analysisLike?.motif_tags,confidence:Y?.analysisLike?.confidence,stylePreset:Y?.image?.stylePreset,provider:Zn(Xe)},musicData:Me.midiData,musicFormat:"midi",musicMetadata:{key:Me.result.key,tempo:Me.result.tempo,timeSignature:Me.result.timeSignature,form:Me.result.form,character:Me.result.character,duration:Y?.music?.duration,createdAt:Hn(),provider:Me.provider},sessionData:{brief:Y?.brief,recommendations:U.sessionRecommendations??_,messages:U.sessionMessages??u},causalLogId:U.causalLogId??void 0}),k(U.causalLogId??null),K(!0),v(null),L(!1),o("success","生成が完了しました。タイトルを決めて保存できます。")}catch(Y){if(Y instanceof DOMException&&Y.name==="AbortError"){v("キャンセルしました"),L(!1);return}const ee=Y instanceof Error?Y.message:"再生成に失敗しました";y(ee),L(!0),o("error",ee)}finally{N(!1),R.current=null}}async function Cs(){const U=Yn();if(!U||b)return;y(null),L(!1),N(!0),v("再開中…"),M(U.startedAt||Date.now()),D(0),o("info","生成を再開しています…"),R.current?.abort();const oe=new AbortController;R.current=oe;try{const Y=U.refined,ee=U.coverDataUrl||Jn(Y,"Image unavailable"),ge=U.imageJobId?tn(U.imageJobId,de=>{de.status==="queued"?v("順番待ち…"):de.status==="running"?v("画像を生成中…"):de.status==="succeeded"?v("画像ができました。仕上げ中…"):de.status==="failed"&&v("画像生成に失敗しました")},90,2e3,oe.signal).catch(de=>{const ns=de instanceof Error?de.message:"image polling failed";return U.causalLogId&&as(a,r,U.causalLogId,"image-generation-poll",ns),null}):Promise.resolve(null),[be,Se]=await Promise.all([ge,us(U.musicJobId,de=>{de.status==="queued"?v("順番待ち…"):de.status==="running"?v("作曲中…"):de.status==="succeeded"?v("作曲ができました。仕上げ中…"):de.status==="failed"&&v("作曲に失敗しました")},90,2e3,oe.signal)]),Xe=be?.status==="succeeded"&&be?.resultUrl?be.resultUrl:ee;if(be?.status==="succeeded"&&be?.resultUrl||o("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Se.status!=="succeeded"||!Se.midiData||!Se.result)throw new Error("曲生成に失敗しました");const Me=Y?.brief?.theme?.title||"";Q({title:Me,mood:Y?.image?.mood,duration:Y?.image?.duration,imageDataURL:Xe,thumbnailUrl:Xe,metadata:{valence:Y?.analysisLike?.valence,arousal:Y?.analysisLike?.arousal,focus:Y?.analysisLike?.focus,motif_tags:Y?.analysisLike?.motif_tags,confidence:Y?.analysisLike?.confidence,stylePreset:Y?.image?.stylePreset,provider:Zn(be)},musicData:Se.midiData,musicFormat:"midi",musicMetadata:{key:Se.result.key,tempo:Se.result.tempo,timeSignature:Se.result.timeSignature,form:Se.result.form,character:Se.result.character,duration:Y?.music?.duration,createdAt:Hn(),provider:Se.provider},sessionData:{brief:Y?.brief,recommendations:U.sessionRecommendations??_,messages:U.sessionMessages??u},causalLogId:U.causalLogId??void 0}),k(U.causalLogId??null),K(!0),v(null),F(!0),L(!1),o("success","生成が完了しました。タイトルを決めて保存できます。")}catch(Y){if(Y instanceof DOMException&&Y.name==="AbortError"){v("キャンセルしました"),L(!1);return}const ee=Y instanceof Error?Y.message:"再開に失敗しました";y(ee),L(!0),o("error",ee)}finally{N(!1),R.current=null}}const st=U=>`${U.composer}::${U.title}`;async function Bn(U){const oe=st(U);if(Te[oe])return Te[oe];if($e[oe])return null;z(Y=>({...Y,[oe]:!0})),ue(Y=>({...Y,[oe]:null}));try{const Y=await Tc({composer:U.composer,title:U.title});return lt(ee=>({...ee,[oe]:Y})),Y}catch(Y){const ee=Y instanceof Error?Y.message:"プレビュー取得に失敗しました";return ue(ge=>({...ge,[oe]:ee})),null}finally{z(Y=>({...Y,[oe]:!1}))}}async function go(U){const oe=st(U);if(Z===oe){W.current?.pause(),ae(null);return}const ee=await Bn(U),ge=ee?.previewUrl,be=ee?.trackUrl;if(!ge){be&&window.open(be,"_blank","noopener,noreferrer");return}try{W.current||(W.current=new Audio),W.current.pause(),W.current.src=ge,W.current.currentTime=0,await W.current.play(),ae(oe),W.current.onended=()=>{ae(Se=>Se===oe?null:Se)}}catch(Se){ue(Xe=>({...Xe,[oe]:Se instanceof Error?Se.message:"再生に失敗しました"}))}}async function sa(){const U=d.trim();if(!U)return;y(null),p(!0);const oe=[...u,{role:"user",content:U}];h(oe),m("");try{const Y=await Nc({messages:oe,onboardingData:re??void 0});h(ee=>[...ee,{role:"assistant",content:Y.assistant_message}]),S(Y.recommendations??[]),I(Y.event_suggestion??null)}catch(Y){const ee=Y instanceof Error?Y.message:"送信に失敗しました";y(ee),h(ge=>[...ge,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{p(!1)}}async function vo(){y(null),L(!1),N(!0),v("準備中…"),M(Date.now()),D(0),R.current?.abort();const U=new AbortController;R.current=U;const oe=`chat_${Date.now()}`,Y=s(oe,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{v("イベントを整えています…");const ee=await Sc({messages:u,onboardingData:re??void 0}),ge=Jn(ee,"Image unavailable");let be=null;try{v("画像生成を開始しています…"),be=(await ni(ee.image)).jobId}catch(xe){be=null,o("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Un=xe instanceof Error?xe.message:"image job start failed";as(a,r,Y,"image-generation-start",Un)}v("作曲を開始しています…");const Se=await an(ee.music);pa({v:1,kind:"chat",startedAt:Date.now(),imageJobId:be,musicJobId:Se.jobId,coverDataUrl:ge,refined:ee,sessionMessages:u,sessionRecommendations:_,causalLogId:Y}),F(!0),o("info","生成を開始しました。完了まで待つか、あとで再開できます。");const Xe=be?tn(be,xe=>{xe.status==="queued"?v("順番待ち…"):xe.status==="running"?v("画像を生成中…"):xe.status==="succeeded"?v("画像ができました。仕上げ中…"):xe.status==="failed"&&v("画像生成に失敗しました")},90,2e3,U.signal).catch(xe=>{const Un=xe instanceof Error?xe.message:"image polling failed";return as(a,r,Y,"image-generation-poll",Un),null}):Promise.resolve(null),[Me,de]=await Promise.all([Xe,us(Se.jobId,xe=>{xe.status==="queued"?v("順番待ち…"):xe.status==="running"?v("作曲中…"):xe.status==="succeeded"?v("作曲ができました。仕上げ中…"):xe.status==="failed"&&v("作曲に失敗しました")},90,2e3,U.signal)]);if(U.signal.aborted){v("キャンセルしました");return}const ns=Me?.status==="succeeded"&&Me?.resultUrl?Me.resultUrl:ge;if(Me?.status==="succeeded"&&Me?.resultUrl||o("warning","画像が取得できなかったため、プレースホルダーで続行します。"),de.status!=="succeeded"||!de.midiData||!de.result)throw new Error("曲生成に失敗しました");v("保存の準備をしています…");const De=ee?.brief?.theme?.title||"";Q({title:De,mood:ee.image.mood,duration:ee.image.duration,imageDataURL:ns,thumbnailUrl:ns,metadata:{valence:ee.analysisLike.valence,arousal:ee.analysisLike.arousal,focus:ee.analysisLike.focus,motif_tags:ee.analysisLike.motif_tags,confidence:ee.analysisLike.confidence,stylePreset:ee.image.stylePreset,provider:Zn(Me)},musicData:de.midiData,musicFormat:"midi",musicMetadata:{key:de.result.key,tempo:de.result.tempo,timeSignature:de.result.timeSignature,form:de.result.form,character:de.result.character,duration:ee.music.duration,createdAt:Hn(),provider:de.provider},sessionData:{brief:ee.brief,recommendations:_,messages:u},causalLogId:Y}),k(Y),K(!0),o("success","生成が完了しました。タイトルを決めて保存できます。"),L(!1),v(null),M(null),D(0),I(null),h(xe=>[...xe,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(ee){if(ee instanceof DOMException&&ee.name==="AbortError"){v("キャンセルしました"),M(null),D(0),h(be=>[...be,{role:"assistant",content:"生成をキャンセルしたよ。必要ならまた「今すぐ1曲つくる」で再開できる。"}]),o("info","生成をキャンセルしました。あとで再開できます。"),L(!1);return}const ge=ee instanceof Error?ee.message:"生成イベントに失敗しました";v(null),M(null),D(0),y(ge),o("error",ge),L(!0),as(a,r,Y,"generation-event",ge),h(be=>[...be,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{N(!1),R.current=null}}async function yo(U){if(!$){K(!1);return}const oe=U.trim();try{A(!0);let Y=oe;if(!Y)try{Y=(await jc({mood:$.mood,motifTags:$?.metadata?.motif_tags,character:$?.musicMetadata?.character,brief:$?.sessionData?.brief,messages:$?.sessionData?.messages})).title}catch{Y=""}const ee=e({...$,title:Y||void 0});t(ee.id),c(ee,[ee,...fe]),l("music"),o("success","保存して再生を開始しました。"),fa(),F(!1),O&&Wc(a,O,{albumId:"local",title:Y||$.mood}),I(null),h(ge=>[...ge,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{A(!1),K(!1),Q(null),k(null)}}return i.jsxs("div",{className:"chatSession",children:[i.jsx(er,{active:b,statusText:j,elapsedSec:E,onCancel:qe}),i.jsx(Qa,{open:G,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>X(!1),onConfirm:()=>{X(!1),ut()}}),i.jsx(Uc,{open:H,mood:$?.mood||"穏やか",defaultTitle:$?.title,onCancel:()=>{P||(K(!1),Q(null),k(null))},onSubmit:U=>{P||yo(U)}}),i.jsxs("div",{className:"chatHeader",children:[i.jsxs("div",{className:"chatTitle",children:[i.jsx("div",{className:"chatTitleMain",children:"対話"}),i.jsx("div",{className:"chatTitleSub",children:"話すだけで、レコメンドと創作が進む"})]}),i.jsxs("div",{className:"chatHeaderRight",children:[i.jsx("button",{className:"chatPrimary",onClick:vo,disabled:b,"data-no-swipe":!0,title:C?.reason||"会話の内容をもとに1曲生成します",children:b?"生成中…":C?.shouldTrigger?"生成イベントを開始":"今すぐ1曲つくる"}),!b&&T?i.jsx("button",{className:"chatCancel",onClick:()=>void Cs(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!b&&T&&q?i.jsx("button",{className:"chatCancel",onClick:()=>void Wt(),"data-no-swipe":!0,type:"button",title:"同じ条件で生成をやり直します（失敗・停止時向け）",children:"再生成"}):null,b?i.jsx("button",{className:"chatCancel",onClick:qe,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,!b&&T?i.jsx("button",{className:"chatCancel",onClick:()=>X(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null]})]}),j?i.jsxs("div",{className:"chatGenStatus",children:[j,x?i.jsxs("span",{className:"chatGenElapsed",children:["（",E,"s）"]}):null]}):null,C&&!C.shouldTrigger?i.jsx("div",{className:"chatHint",children:C.reason}):null,i.jsxs("div",{className:"chatLayout",children:[i.jsxs("div",{className:"chatMain",children:[i.jsx("div",{className:"chatBody",children:u.map((U,oe)=>i.jsx("div",{className:`chatMsg ${U.role==="user"?"user":"assistant"}`,children:i.jsx("div",{className:"chatBubble",children:U.content})},oe))}),i.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[g?i.jsx("div",{className:"chatError",children:g}):null,i.jsxs("div",{className:"chatComposer",children:[i.jsx("textarea",{className:"chatInput",placeholder:me.length===0?"今日のことを一言で":"続けて話して",value:d,onChange:U=>m(U.target.value),onKeyDown:U=>{U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),f||sa())},rows:2}),i.jsx("button",{className:"chatSend",onClick:sa,disabled:f||!d.trim(),children:f?"送信中…":"送信"})]})]})]}),i.jsxs("aside",{className:"chatSide","aria-label":"レコメンド",children:[i.jsxs("div",{className:"chatSideHeader",children:[i.jsx("div",{className:"chatSideTitle",children:"いまのレコメンド"}),i.jsx("div",{className:"chatSideHint",children:"30秒プレビュー（可能な場合）"})]}),_.length>0?i.jsx("ul",{className:"chatRecsList",children:_.slice(0,4).map((U,oe)=>i.jsxs("li",{className:"chatRecItem",children:[i.jsxs("div",{className:"chatRecMain",children:[i.jsx("span",{className:"chatRecComposer",children:U.composer}),i.jsx("span",{className:"chatRecSep",children:"—"}),i.jsx("span",{className:"chatRecTitle",children:U.title}),U.era?i.jsxs("span",{className:"chatRecEra",children:["(",U.era,")"]}):null]}),i.jsx("div",{className:"chatRecWhy",children:U.why}),i.jsxs("div",{className:"chatRecActions",children:[i.jsx("button",{className:"chatRecPlay",onClick:()=>void go(U),disabled:!!$e[st(U)],"data-no-swipe":!0,children:Z===st(U)?"停止":$e[st(U)]?"取得中…":"再生"}),Te[st(U)]?.trackUrl?i.jsx("a",{className:"chatRecOpen",href:Te[st(U)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),J[st(U)]?i.jsx("div",{className:"chatRecErr",children:J[st(U)]}):null]},oe))}):i.jsx("div",{className:"chatRecsEmpty",children:"会話をすると、ここにおすすめが出ます。"})]})]})]})}const Gc=()=>i.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative"},children:i.jsx($c,{})}),zc=({album:n,basePosition:e,isFocused:t,dimmed:s,focusedPosition:a,faceOut:r,dragging:c,onPointerDown:l,onPointerMove:o,onPointerUp:u,onClick:h,onDoubleClick:d})=>{const m=w.useRef(null),f=w.useRef(null),p=w.useRef(null),g=w.useRef(0),[y,_]=V.useState(!1),S=.22,C=1.45,I=.55,b=n.gallery?.spineColor||"#111111",N=w.useMemo(()=>{const E=new ei(b);return s&&E.lerp(new ei("#bdbdbd"),.72),`#${E.getHexString()}`},[b,s]),j=s?"#b5b5b5":"#ffffff",v=n.title||n.mood,x=w.useMemo(()=>new Date(n.createdAt).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}),[n.createdAt]),M=So(jo,n.imageDataURL);return w.useEffect(()=>{M.colorSpace=To,M.anisotropy=4,M.needsUpdate=!0},[M]),Jt((E,D)=>{if(m.current){const T=t&&a?a:e;if(c)m.current.position.set(T[0],T[1],T[2]);else{const q=1-Math.exp(-(t?10:12)*D);m.current.position.lerp(new Gt(T[0],T[1],T[2]),q)}}const R=r||c?1:0;if(g.current=ti.lerp(g.current,R,1-Math.exp(-8*D)),p.current){const T=g.current;p.current.position.z=I/2+.04+T*.85,p.current.position.y=.05+T*.06,p.current.scale.setScalar(.92+T*.08),p.current.visible=T>.01}if(f.current){const T=g.current;f.current.scale.y=1+T*.02}if(m.current&&!c){const T=t?1.06:s?.985:1,F=1-Math.exp(-10*D),q=m.current.scale.x,L=ti.lerp(q,T,F);m.current.scale.setScalar(L)}}),i.jsxs("group",{ref:m,children:[i.jsxs("mesh",{ref:f,onPointerDown:l,onPointerMove:o,onPointerUp:u,onClick:E=>{E.stopPropagation(),h?.()},onDoubleClick:E=>{E.stopPropagation(),d?.()},onPointerOver:E=>{E.stopPropagation(),_(!0)},onPointerOut:E=>{E.stopPropagation(),_(!1)},castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[S,C,I]}),i.jsx("meshStandardMaterial",{color:N,roughness:.9,metalness:.05,emissive:t?"#ffffff":"#000000",emissiveIntensity:t?.12:0})]}),i.jsxs("group",{position:[S/2-.05,C/2-.12,I/2+.03],children:[n.isPublic&&i.jsxs("mesh",{position:[0,0,0],children:[i.jsx("boxGeometry",{args:[.06,.06,.02]}),i.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1,transparent:!!s,opacity:s?.25:1})]}),n.isFavorite&&i.jsxs("mesh",{position:[0,-.08,0],children:[i.jsx("boxGeometry",{args:[.06,.06,.02]}),i.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1,transparent:!!s,opacity:s?.25:1})]})]}),y&&!c&&!s?i.jsx(ko,{position:[0,C/2+.22,I/2+.06],center:!0,style:{pointerEvents:"none"},transform:!0,distanceFactor:8,children:i.jsxs("div",{className:"book-tooltip",children:[i.jsx("div",{className:"book-tooltip-title",children:v}),i.jsx("div",{className:"book-tooltip-sub",children:x})]})}):null,i.jsxs("group",{ref:p,position:[0,.05,I/2+.04],visible:!1,children:[i.jsxs("mesh",{onPointerDown:l,onPointerMove:o,onPointerUp:u,onClick:E=>{E.stopPropagation(),h?.()},onDoubleClick:E=>{E.stopPropagation(),d?.()},castShadow:!0,children:[i.jsx("planeGeometry",{args:[1.1,1.55]}),i.jsx("meshStandardMaterial",{map:M,roughness:.85,metalness:0,color:j})]}),i.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[1.14,1.6]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:1,metalness:0,opacity:s?.18:.6,transparent:!0})]})]})]})},Yc=({albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s,inputRef:a})=>{const{viewport:r}=Co(),c=w.useRef(null),[l,o]=w.useState(()=>n.map(O=>O.id)),[u,h]=w.useState({}),[d,m]=w.useState(null),f=d!==null,p=w.useRef(0),g=w.useRef(0),y=w.useRef({activeId:null,pointerId:null,startSlot:-1,hoverSlot:-1,moved:!1,startClientX:0,startClientY:0,dragPos:null});w.useEffect(()=>{o(O=>{const k=n.map(W=>W.id),P=new Set(O),A=[];for(const W of k)P.has(W)||A.push(W);for(const W of O)k.includes(W)&&A.push(W);return A.length?A:k})},[n]),w.useEffect(()=>{d?a.current.blockPan=!0:y.current.activeId||(a.current.blockPan=!1)},[d,a]);const _=w.useMemo(()=>{const O=new Map;for(const k of n)O.set(k.id,k);return O},[n]),S=3,C=.3,I=.22,b=.6,j=Math.max(14,Math.ceil(Math.max(1,l.length)/S)),v=(j-1)*C+I,x=v+b*2,M=w.useMemo(()=>[1.35,.05,-1.25],[]),E=w.useMemo(()=>Math.max(0,x/2-r.width/2+.4),[x,r.width]),D=(O,k,P)=>Math.max(k,Math.min(P,O)),R=(O,k,P)=>{const A=O.slice(),[W]=A.splice(k,1);return A.splice(P,0,W),A},T=O=>{const k=Math.max(0,O),P=Math.min(S-1,Math.floor(k/j)),A=k%j,W=-v/2+A*C,Z=M[P]??M[0];return{x:W,y:Z,z:0,shelfIndex:P,col:A}},F=[0,.55,1.55],q=()=>{m(O=>{if(!O)return null;const k=O;return h(P=>({...P,[k]:!1})),null}),y.current.activeId||(a.current.blockPan=!1)},L=O=>{D(Math.round((M[0]-O.y)/(M[0]-M[M.length-1])*(S-1)),0,S-1);let k=0,P=1/0;for(let Z=0;Z<M.length;Z+=1){const ae=Math.abs(O.y-M[Z]);ae<P&&(P=ae,k=Z)}const A=D(O.x,-v/2,v/2),W=D(Math.round((A+v/2)/C),0,j-1);return k*j+W};Jt((O,k)=>{const P=a.current;if(!!y.current.activeId){P.wheelPx=0,P.dragPx=0,P.isDragging=!1;return}const W=.0022,Z=P.wheelPx*W,ae=P.dragPx*W;Z!==0&&(g.current+=Z*26,P.wheelPx=0),ae!==0&&(p.current+=ae,g.current=ti.lerp(g.current,ae*60,.35),P.dragPx=0);const Te=P.isDragging?.88:.92;g.current*=Math.pow(Te,k*60),p.current+=g.current*k;const lt=32;p.current<-E?(p.current=-E,g.current*=-.35):p.current>E&&(p.current=E,g.current*=-.35),p.current<-E?g.current+=(-E-p.current)*lt*k:p.current>E&&(g.current-=(p.current-E)*lt*k),c.current&&(c.current.position.x=D(p.current,-E,E))});const[B,G]=w.useState(-1),X=(O,k,P)=>{a.current.blockPan=!0,y.current.activeId=O,y.current.pointerId=Number(k?.pointerId??-1),y.current.startSlot=P,y.current.hoverSlot=P,y.current.moved=!1,y.current.startClientX=Number(k?.clientX??k?.nativeEvent?.clientX??0),y.current.startClientY=Number(k?.clientY??k?.nativeEvent?.clientY??0);const A=T(P);y.current.dragPos={x:A.x,y:A.y,z:.85},G(P);try{k.stopPropagation?.(),k?.nativeEvent?.target?.setPointerCapture?.(k.pointerId)}catch{}},H=O=>{if(!y.current.activeId)return;const P=y.current.pointerId;if(P!==null&&Number(O?.pointerId??-1)!==P||!c.current)return;const A=Number(O?.clientX??O?.nativeEvent?.clientX??0),W=Number(O?.clientY??O?.nativeEvent?.clientY??0),Z=A-y.current.startClientX,ae=W-y.current.startClientY;!y.current.moved&&Z*Z+ae*ae>36&&(y.current.moved=!0);const Te=O?.ray;if(!Te)return;const lt=new Ao(new Gt(0,0,1),-.25),$e=new Gt;if(!Te.intersectPlane(lt,$e))return;const J=c.current.worldToLocal($e.clone()),ue=L(J);y.current.hoverSlot=ue,y.current.dragPos={x:D(J.x,-v/2,v/2),y:J.y,z:.85},G(ue)},K=(O,k)=>{if(y.current.activeId!==O)return;const P=y.current.startSlot,A=y.current.hoverSlot,W=y.current.moved;y.current.activeId=null,y.current.pointerId=null,y.current.startSlot=-1,y.current.hoverSlot=-1,y.current.moved=!1,y.current.dragPos=null,G(-1),a.current.blockPan=!1;try{k?.nativeEvent?.target?.releasePointerCapture?.(k.pointerId)}catch{}if(!W){d===O?(t||e)(O):e(O);return}P>=0&&A>=0&&P!==A&&o(Z=>{const ae=Math.max(0,Math.min(Z.length-1,P)),Te=Math.max(0,Math.min(Z.length-1,A));return R(Z,ae,Te)})},$=O=>{m(k=>k===O?null:O),h(k=>({...k,[O]:!0})),e(O)},Q=O=>{const k=y.current.activeId;k&&K(k,O)};return i.jsxs("group",{children:[i.jsxs("mesh",{position:[0,-2.15,0],receiveShadow:!0,rotation:[-Math.PI/2,0,0],children:[i.jsx("planeGeometry",{args:[40,20]}),i.jsx("meshStandardMaterial",{color:"#fbfbfb",roughness:1,metalness:0})]}),i.jsxs("mesh",{position:[0,.1,-1.05],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[40,10]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:1,metalness:0})]}),i.jsxs("group",{ref:c,children:[i.jsxs("mesh",{position:[0,.05,.26],onPointerDown:O=>{d&&(y.current.activeId||(O.stopPropagation(),q()))},onPointerMove:O=>H(O),onPointerUp:O=>Q(O),onPointerCancel:O=>Q(O),children:[i.jsx("planeGeometry",{args:[Math.max(14,x+4),7]}),i.jsx("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1})]}),f?i.jsxs("mesh",{position:[0,.05,-.15],raycast:null,children:[i.jsx("planeGeometry",{args:[Math.max(18,x+10),9]}),i.jsx("meshBasicMaterial",{color:"#0b0b0b",opacity:.12,transparent:!0,depthWrite:!1})]}):null,i.jsxs("group",{position:[0,.05,-.25],children:[i.jsxs("mesh",{position:[-x/2+.08,0,0],castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[.16,3.8,.9]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.95,metalness:0})]}),i.jsxs("mesh",{position:[x/2-.08,0,0],castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[.16,3.8,.9]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.95,metalness:0})]}),i.jsxs("mesh",{position:[0,1.95,0],castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[x,.18,.9]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.95,metalness:0})]}),i.jsxs("mesh",{position:[0,-1.95,0],castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[x,.18,.9]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.95,metalness:0})]}),M.map((O,k)=>i.jsxs("mesh",{position:[0,O-.78,0],castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[x-.22,.14,.88]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:.96,metalness:0})]},k))]}),B>=0?i.jsxs("mesh",{position:[T(B).x,T(B).y-.78+.09,.32],rotation:[-Math.PI/2,0,0],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[.34,.72]}),i.jsx("meshStandardMaterial",{color:"#d9d9d9",opacity:.45,transparent:!0,roughness:1,metalness:0})]}):null,l.map((O,k)=>{const P=_.get(O);if(!P)return null;const A=T(k),W=y.current.activeId===O,Z=W?y.current.dragPos:null,ae=d===O,Te=f&&!ae,lt=Z?[Z.x,Z.y,Z.z]:[A.x,A.y,f&&!ae?.12:.25];return i.jsx(zc,{album:P,basePosition:lt,isFocused:ae,dimmed:Te,focusedPosition:F,faceOut:!!u[P.id],dragging:W,onPointerDown:$e=>X(P.id,$e,k),onPointerMove:$e=>H($e),onPointerUp:$e=>K(P.id,$e),onClick:()=>{d===O?(t||e)(O):e(O)},onDoubleClick:()=>$(O)},P.id)})]}),f?i.jsx("pointLight",{position:[0,.8,3.6],intensity:.45,distance:12,decay:2}):null,i.jsx("ambientLight",{intensity:.55}),i.jsx("hemisphereLight",{args:["#ffffff","#e9e9e9",.35]}),i.jsx("directionalLight",{position:[4,6,6],intensity:.7,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),i.jsx("directionalLight",{position:[-3,3,4],intensity:.22})]})},Xc=({albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s})=>{const a=w.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0,blockPan:!1});return i.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:r=>{if(r.preventDefault(),a.current.blockPan)return;const c=Math.abs(r.deltaX)>Math.abs(r.deltaY)?r.deltaX:r.deltaY;a.current.wheelPx+=c},onPointerDown:r=>{a.current.blockPan||(r.currentTarget.setPointerCapture(r.pointerId),a.current.isDragging=!0,a.current.lastPointerX=r.clientX)},onPointerMove:r=>{if(a.current.blockPan||!a.current.isDragging)return;const c=r.clientX-a.current.lastPointerX;a.current.lastPointerX=r.clientX,a.current.dragPx+=c},onPointerUp:r=>{try{r.currentTarget.releasePointerCapture(r.pointerId)}catch{}a.current.isDragging=!1,a.current.blockPan=!1},onPointerCancel:()=>{a.current.isDragging=!1,a.current.blockPan=!1},children:i.jsx(_s,{shadows:!0,camera:{position:[0,.55,7.2],fov:34},gl:{alpha:!0,antialias:!0},children:i.jsx(w.Suspense,{fallback:null,children:i.jsx(Yc,{albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s,inputRef:a})})})})},zt=({title:n,mood:e,imageUrl:t,meta:s,badges:a=[],variant:r="default",className:c})=>i.jsxs("div",{className:`album-card album-card-${r} ${c||""}`.trim(),children:[i.jsx("div",{className:"album-card-image",children:i.jsx("img",{src:t,alt:n,loading:"lazy"})}),i.jsxs("div",{className:"album-card-body",children:[i.jsx("div",{className:"album-card-title",children:n}),e&&i.jsx("div",{className:"album-card-mood",children:e}),s&&i.jsx("div",{className:"album-card-meta",children:s}),a.length>0&&i.jsx("div",{className:"album-card-badges",children:a.map(l=>i.jsx("span",{className:`album-badge tone-${l.tone||"default"}`,children:l.label},l.label))})]})]}),Hc=({title:n,description:e,actionLabel:t,onAction:s,icon:a})=>i.jsxs("div",{className:"empty-state",children:[a&&i.jsx("div",{className:"empty-icon",children:a}),i.jsx("h2",{className:"empty-title",children:n}),i.jsx("p",{className:"empty-description",children:e}),t&&s&&i.jsx("button",{onClick:s,className:"empty-cta-button",children:t})]}),rn=({trigger:n,children:e,placement:t="bottom",triggerClassName:s,triggerAriaLabel:a,triggerAriaHaspopup:r,onOpenChange:c})=>{const[l,o]=w.useState(!1),u=w.useRef(null),h=w.useRef(null),d=w.useId(),m=()=>{o(!1),c?.(!1),h.current?.focus()},f=()=>{o(p=>{const g=!p;return c?.(g),g})};return w.useEffect(()=>{if(!l)return;const p=y=>{u.current?.contains(y.target)||m()},g=y=>{y.key==="Escape"&&(y.preventDefault(),m())};return document.addEventListener("mousedown",p),document.addEventListener("keydown",g),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",g)}},[l]),i.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[i.jsx("button",{ref:h,type:"button",className:`popover-trigger ${s||""}`.trim(),onClick:f,"aria-expanded":l,"aria-controls":l?d:void 0,"aria-label":a,"aria-haspopup":r,children:n}),l&&i.jsx("div",{className:"popover-panel",id:d,children:typeof e=="function"?e({close:m}):e})]})},on=({items:n,autoFocus:e=!0})=>{const[t,s]=V.useState(0),a=V.useRef([]);V.useEffect(()=>{if(!e||n.length===0)return;const l=a.current[0];l&&l.focus()},[e,n.length]);const r=l=>{const o=Math.max(0,Math.min(n.length-1,l));s(o),a.current[o]?.focus()},c=l=>{if(n.length!==0){if(l.key==="ArrowDown"){l.preventDefault(),r(t+1);return}if(l.key==="ArrowUp"){l.preventDefault(),r(t-1);return}if(l.key==="Home"){l.preventDefault(),r(0);return}if(l.key==="End"){l.preventDefault(),r(n.length-1);return}}};return i.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:c,children:n.map((l,o)=>i.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:o===t?0:-1,ref:u=>{a.current[o]=u},onFocus:()=>s(o),onClick:()=>{s(o),l.onSelect()},type:"button",children:l.label},l.id))})},tr=({items:n,value:e,onChange:t,ariaLabel:s="タブ"})=>{const a=w.useId();return i.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[i.jsx("div",{className:"tabs-list",role:"tablist","aria-label":s,children:n.map(r=>i.jsx("button",{id:`${a}-${r.id}-tab`,role:"tab","aria-selected":e===r.id,"aria-controls":`${a}-${r.id}-panel`,className:`tab-button ${e===r.id?"is-active":""}`,onClick:()=>t(r.id),type:"button",children:r.label},r.id))}),n.map(r=>i.jsx("div",{id:`${a}-${r.id}-panel`,role:"tabpanel","aria-labelledby":`${a}-${r.id}-tab`,hidden:e!==r.id,className:"tab-panel",children:r.content},r.id))]})},ii=({options:n,value:e,onChange:t,ariaLabel:s="選択"})=>i.jsx("div",{className:"segmented-control",role:"group","aria-label":s,"data-no-swipe":"true",children:n.map(a=>i.jsx("button",{type:"button",className:`segmented-item ${e===a.id?"is-active":""}`,"aria-pressed":e===a.id,onClick:()=>t(a.id),children:a.label},a.id))}),Jc=()=>{const{albums:n,selectAlbum:e,updateAlbum:t}=wt(),{getSelectedAlbum:s}=wt(),a=s(),{requestPlayAlbum:r}=Rt(),{navigateToRoom:c}=St(),[l,o]=V.useState("shelf"),[u,h]=V.useState("all"),[d,m]=V.useState("new"),[f,p]=V.useState("public"),g=x=>{e(x)},y=x=>{e(x),c("album")},_=V.useMemo(()=>n.filter(x=>x.musicData),[n]),S=!!a,C=!!a?.musicData,I=V.useMemo(()=>{const x=n.filter(E=>u==="public"?E.isPublic:u==="private"?!E.isPublic:u==="favorite"?E.isFavorite:!0),M=E=>{const D=Number(E.duration||0);return(E.musicData?1e3:0)+D};return x.slice().sort((E,D)=>d==="duration"?(D.duration||0)-(E.duration||0):d==="popular"?M(D)-M(E):String(D.createdAt).localeCompare(String(E.createdAt)))},[n,u,d]),b=d==="popular"?"人気順":d==="duration"?"長さ順":"新しい順",N=i.jsxs("div",{className:"bookshelf-container",children:[i.jsxs("div",{className:`gallery-shelf-stage ${I.length===0?"empty":""}`,children:[i.jsx(Xc,{albums:I,onBookClick:g,onBookOpen:y,constellationEnabled:!1}),I.length===0&&i.jsx("div",{className:"empty-shelf-overlay",children:i.jsx(Hc,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>c("main"),icon:i.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),i.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[i.jsxs("div",{className:"gallery-selection",children:[i.jsx("div",{className:"gallery-selection-label",children:"選択中"}),i.jsx("div",{className:"gallery-selection-value",children:a?a.title||a.mood:"未選択"})]}),i.jsxs("div",{className:"gallery-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!S,onClick:()=>c("album"),children:"開く"}),i.jsx("button",{className:"btn btn-primary",disabled:!C||!a,onClick:()=>{a&&r(a,_)},children:"再生"}),i.jsx("button",{className:"btn",disabled:!S,onClick:()=>c("social"),children:"公開"}),i.jsx(rn,{triggerClassName:"btn",trigger:i.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:x})=>i.jsx(on,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{c("album"),x()}},{id:"publish",label:"SNSに公開",onSelect:()=>{c("social"),x()}},{id:"play",label:"再生",onSelect:()=>{a&&(r(a,_),x())}},{id:"favorite",label:a?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{a&&(t(a.id,{isFavorite:!a.isFavorite}),x())}},{id:"public",label:a?.isPublic?"非公開にする":"公開にする",onSelect:()=>{a&&(t(a.id,{isPublic:!a.isPublic}),x())}}]})})]})]})]}),j=i.jsx("div",{className:"gallery-focus",children:a?i.jsxs("div",{className:"gallery-focus-card room-card",children:[i.jsx(zt,{title:a.title||a.mood,mood:a.mood,imageUrl:a.imageDataURL,meta:`作成日: ${new Date(a.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:a.musicData?"再生可能":"音声なし",tone:a.musicData?"success":"default"},...a.isPublic?[{label:"公開中",tone:"info"}]:[],...a.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),i.jsxs("div",{className:"gallery-focus-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:()=>c("album"),children:"詳細へ"}),i.jsx("button",{className:"btn btn-primary",disabled:!a.musicData,onClick:()=>r(a,_),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>c("social"),children:"公開"})]})]}):i.jsxs("div",{className:"gallery-focus-empty room-card",children:[i.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),i.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),v=[{id:"shelf",label:"Shelf",content:N},{id:"focus",label:"Focus",content:j}];return i.jsxs("div",{className:"room-content gallery-room",children:[i.jsx(Ka,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),i.jsx("h1",{className:"room-title",children:"GALLERY"}),i.jsx("p",{className:"room-subtitle",children:"スクロールで時間を辿り、クリックで選ぶ"}),i.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"gallery-toolbar-left",children:[i.jsx(ii,{value:u,onChange:x=>h(x),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),i.jsxs("div",{className:"gallery-filter-tags",children:[i.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),i.jsx("span",{className:"filter-tag",children:b}),i.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",f==="public"?"公開":"お気に入り"]})]})]}),i.jsxs("div",{className:"gallery-toolbar-right",children:[i.jsx(ii,{value:f,onChange:x=>p(x),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),i.jsx(rn,{triggerClassName:"btn",trigger:i.jsxs("span",{children:["並び替え: ",b]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:x})=>i.jsx(on,{items:[{id:"new",label:"新しい順",onSelect:()=>{m("new"),x()}},{id:"popular",label:"人気順",onSelect:()=>{m("popular"),x()}},{id:"duration",label:"長さ順",onSelect:()=>{m("duration"),x()}}]})})]})]}),i.jsx(tr,{items:v,value:l,onChange:o,ariaLabel:"ギャラリー表示"})]})},Zc=2147483647,Kc=({log:n})=>{if(!n)return i.jsxs("div",{className:"explainability-panel",children:[i.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),i.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const s=Math.round(t/1e3);if(s<60)return`${s}秒`;const a=Math.floor(s/60),r=s%60;return`${a}分${r}秒`};return i.jsxs("div",{className:"explainability-panel",children:[i.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),n.analysis&&i.jsxs("div",{className:"explainability-section timeline-section",children:[i.jsx("h4",{className:"section-title",children:"生成フロー"}),i.jsxs("div",{className:"timeline",children:[i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"入力"}),i.jsx("span",{className:"timeline-value",children:new Date(n.input.timestamp).toLocaleTimeString("ja-JP")})]}),n.analysis&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"解析"}),i.jsxs("span",{className:"timeline-value",children:[e(n.analysis.duration)," (",n.analysis.provider,")"]})]}),n.imageGeneration&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"画像生成"}),i.jsxs("span",{className:"timeline-value",children:[e(n.imageGeneration.duration)," (",n.imageGeneration.provider,")"]})]}),n.musicGeneration&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"音楽生成"}),i.jsxs("span",{className:"timeline-value",children:[e(n.musicGeneration.duration)," (",n.musicGeneration.provider,")"]})]}),n.album&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"完成"}),i.jsxs("span",{className:"timeline-value",children:["合計: ",e(n.totalDuration)]})]})]})]}),n.analysis&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"感情分析"}),i.jsxs("div",{className:"analysis-explanation",children:[i.jsxs("div",{className:"ir-values",children:[i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Valence:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${(n.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:n.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.valence.toFixed(2)})]}),i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Arousal:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Focus:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),i.jsxs("div",{className:"motif-tags",children:[i.jsx("strong",{children:"モチーフタグ:"})," ",n.analysis.intermediateRepresentation.motif_tags.join("、")]}),i.jsxs("div",{className:"reasoning-text",children:[i.jsx("strong",{children:"理由:"})," ",n.analysis.reasoning]})]})]}),n.imageGeneration&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),i.jsxs("div",{className:"image-explanation",children:[i.jsx("p",{className:"reasoning-text",children:n.imageGeneration.reasoning}),i.jsxs("div",{className:"image-details",children:[i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"スタイル:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.stylePreset})]}),n.imageGeneration.seed&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"Seed:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.seed})]}),i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"モデル:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.model})]})]})]})]}),n.musicGeneration&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),i.jsxs("div",{className:"music-explanation",children:[i.jsx("p",{className:"reasoning-text",children:n.musicGeneration.reasoning}),i.jsx("div",{className:"music-details",children:n.musicGeneration.structure&&typeof n.musicGeneration.structure=="object"&&i.jsxs(i.Fragment,{children:[n.musicGeneration.structure.key&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"調:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.key})]}),n.musicGeneration.structure.tempo&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"テンポ:"}),i.jsxs("span",{className:"detail-value",children:[n.musicGeneration.structure.tempo," BPM"]})]}),n.musicGeneration.structure.timeSignature&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"拍子:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.timeSignature})]}),n.musicGeneration.structure.form&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"形式:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.form})]})]})})]})]}),n.errors&&n.errors.length>0&&i.jsxs("div",{className:"explainability-section error-section",children:[i.jsx("h4",{className:"section-title",children:"エラー"}),i.jsx("div",{className:"errors-list",children:n.errors.map((t,s)=>i.jsxs("div",{className:"error-item",children:[i.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),i.jsx("span",{className:"error-message",children:t.error})]},s))})]})]})},Qc=({dominantColors:n=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:s=0,highlightedLayer:a=-1})=>{const r=w.useRef(null),c=w.useRef(),l=w.useRef([]);return w.useEffect(()=>{const o=r.current;if(!o)return;const u=o.getContext("2d");if(!u)return;const h=()=>{const p=o.parentElement;p&&(o.width=p.clientWidth,o.height=p.clientHeight)};h(),window.addEventListener("resize",h);const d=Math.min(5,n.length+2);l.current=Array.from({length:d},(p,g)=>({radius:50+g*30,maxRadius:200+g*50,color:n[g%n.length]||"#D4AF37",phase:g*Math.PI*2/d,phaseSpeed:5e-4+g*2e-4}));let m=0;const f=p=>{const g=p-m;m=p,u.clearRect(0,0,o.width,o.height);const y=o.width/2,_=o.height/2;l.current.forEach((S,C)=>{S.phase+=S.phaseSpeed*g;const I=Math.sin(S.phase),b=20+(e?t*30:0),N=S.radius+I*b,j=.1,v=.3,x=s*.2,M=a===C?.3:0,E=e?t*.15:0,D=Math.min(v,j+x+M+E),R=u.createRadialGradient(y,_,N-20,y,_,N+20);R.addColorStop(0,`${S.color}00`),R.addColorStop(.5,`${S.color}${Math.floor(D*255).toString(16).padStart(2,"0")}`),R.addColorStop(1,`${S.color}00`),u.fillStyle=R,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(y,_,N,0,Math.PI*2),u.fill()}),c.current=requestAnimationFrame(f)};return c.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",h),c.current&&cancelAnimationFrame(c.current),u.clearRect(0,0,o.width,o.height)}},[n,e,t,s,a]),i.jsx("canvas",{ref:r,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},el=()=>{const[n,e]=w.useState({x:0,y:0});return w.useEffect(()=>{const t=s=>{e({x:s.clientX,y:s.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),n},tl=(n,e=200)=>{const[t,s]=w.useState(0),a=el();return w.useEffect(()=>{if(!n.current)return;const r=n.current.getBoundingClientRect(),c=r.left+r.width/2,l=r.top+r.height/2,o=Math.sqrt(Math.pow(a.x-c,2)+Math.pow(a.y-l,2)),u=Math.max(0,1-o/e);s(u)},[a,n,e]),t},sl=()=>{const{getSelectedAlbum:n,selectAlbum:e,addAlbum:t,updateAlbum:s}=wt(),{getLog:a}=za(),{state:r,requestPlayAlbum:c}=Rt(),{navigateToRoom:l}=St(),o=n(),u=T=>{const F=new Date(T);return Number.isNaN(F.getTime())?"":F.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},[h,d]=w.useState("");w.useEffect(()=>{d(o?.memo||"")},[o?.id]);const m=o?.causalLogId?a(o.causalLogId):void 0,f=(T,F=2400)=>{try{const q=JSON.stringify(T,null,2)??"";return q.length<=F?q:`${q.slice(0,F)}
…(truncated)`}catch{return""}},[p,g]=w.useState(!1),[y,_]=w.useState(null),[S,C]=w.useState(!1),I=w.useRef(null),b=tl(I,300),[N,j]=w.useState(-1),v=T=>{const F=I.current;if(!F)return;const q=F.getBoundingClientRect(),L=(T.clientX-q.left)/Math.max(1,q.width),B=(T.clientY-q.top)/Math.max(1,q.height),G=Math.max(0,Math.min(1,L)),X=Math.max(0,Math.min(1,B)),H=(G-.5)*10,K=(.5-X)*7;F.style.setProperty("--tilt-x",`${K.toFixed(2)}deg`),F.style.setProperty("--tilt-y",`${H.toFixed(2)}deg`),F.style.setProperty("--shine-x",`${(G*100).toFixed(1)}%`),F.style.setProperty("--shine-y",`${(X*100).toFixed(1)}%`)},x=()=>{const T=I.current;T&&(T.style.setProperty("--tilt-x","0deg"),T.style.setProperty("--tilt-y","0deg"),T.style.setProperty("--shine-x","50%"),T.style.setProperty("--shine-y","45%"))},M=o?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],E=r.playbackState===ht.PLAYING&&r.currentAlbum?.id===o?.id,D=()=>{e(null),l("gallery")},R=async()=>{if(!o||!o.metadata){_("メタデータが見つかりません");return}try{g(!0),_(null),C(!1);const T=Math.floor(Math.random()*Zc),F=await ni({mood:o.mood,duration:o.duration,motifTags:o.metadata.motif_tags||[],stylePreset:o.metadata.stylePreset,seed:T,valence:o.metadata.valence,arousal:o.metadata.arousal,focus:o.metadata.focus,confidence:o.metadata.confidence}),q=await tn(F.jobId,L=>{console.log("Regenerate status:",L)});if(q.status==="succeeded"&&q.resultUrl)t({mood:o.mood,duration:o.duration,imageDataURL:q.resultUrl,sessionData:o.sessionData,metadata:{...o.metadata,seed:T}}),C(!0),setTimeout(()=>C(!1),3e3);else throw new Error(q.errorMessage||"再生成に失敗しました")}catch(T){_(T instanceof Error?T.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",T)}finally{g(!1)}};return o?i.jsxs("div",{className:"room-content album-room",children:[i.jsxs("div",{className:"album-header room-header",children:[i.jsxs("div",{className:"album-header-left",children:[i.jsx("h1",{className:"album-title",children:o.title||o.mood}),i.jsxs("p",{className:"album-subtitle",children:["ムード: ",o.mood," ・ 選択したアルバムの詳細"]})]}),i.jsxs("div",{className:"album-header-actions room-header-actions",children:[i.jsx("button",{className:"btn back-to-gallery-btn",onClick:D,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),i.jsx("button",{className:"btn btn-primary",disabled:!o.musicData,onClick:()=>c(o),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>l("social"),children:"公開"}),i.jsx(rn,{triggerClassName:"btn",trigger:i.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:T})=>i.jsx(on,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{l("gallery"),T()}},{id:"publish",label:"SNSに公開",onSelect:()=>{l("social"),T()}},{id:"play",label:"再生",onSelect:()=>{c(o),T()}},{id:"favorite",label:o.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{s(o.id,{isFavorite:!o.isFavorite}),T()}},{id:"public",label:o.isPublic?"非公開にする":"公開にする",onSelect:()=>{s(o.id,{isPublic:!o.isPublic}),T()}}]})})]})]}),i.jsxs("div",{className:"album-details",children:[i.jsx("div",{className:"album-media",children:i.jsxs("div",{className:`album-image-container ${E?"is-playing":""}`,ref:I,onMouseMove:v,onMouseLeave:x,children:[i.jsx(Qc,{dominantColors:M,isPlaying:E,beatAmplitude:0,mouseProximity:b,highlightedLayer:N}),i.jsx("img",{src:o.imageDataURL,alt:`${o.mood}のセッション画像`,className:"album-image"})]})}),i.jsxs("div",{className:"album-metadata",children:[i.jsxs("div",{className:"album-meta-card","data-no-swipe":"true",children:[i.jsx("div",{className:"album-meta-title",children:"作品情報"}),i.jsxs("div",{className:"album-meta-grid",children:[i.jsx("div",{className:"album-meta-k",children:"タイトル"}),i.jsx("div",{className:"album-meta-v",children:o.title||o.mood}),i.jsx("div",{className:"album-meta-k",children:"作成"}),i.jsx("div",{className:"album-meta-v",children:o.createdAt?u(o.createdAt):""}),i.jsx("div",{className:"album-meta-k",children:"公開"}),i.jsx("div",{className:"album-meta-v",children:o.isPublic?"公開":"非公開"}),i.jsx("div",{className:"album-meta-k",children:"お気に入り"}),i.jsx("div",{className:"album-meta-v",children:o.isFavorite?"Yes":"No"}),i.jsx("div",{className:"album-meta-k",children:"長さ"}),i.jsx("div",{className:"album-meta-v",children:o.duration?`${o.duration} sec`:""}),i.jsx("div",{className:"album-meta-k",children:"ムード"}),i.jsx("div",{className:"album-meta-v",children:o.mood}),i.jsx("div",{className:"album-meta-k",children:"ID"}),i.jsx("div",{className:"album-meta-v album-meta-id",children:o.id})]})]}),i.jsx("div",{className:"album-summary-card",children:i.jsx(zt,{variant:"compact",title:o.title||o.mood,mood:o.mood,imageUrl:o.imageDataURL,meta:`作成日: ${new Date(o.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:o.musicData?"再生可能":"音声なし",tone:o.musicData?"success":"default"},...o.isPublic?[{label:"公開中",tone:"info"}]:[],...o.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),i.jsxs("section",{className:"metadata-section","aria-label":"アルバムメモ",children:[i.jsx("h2",{className:"metadata-section-title",children:"メモ（ひとこと）"}),i.jsx("textarea",{className:"album-memo-input",value:h,onChange:T=>d(T.target.value),onBlur:()=>{const T=h.trim();(o.memo||"")!==T&&s(o.id,{memo:T||void 0})},placeholder:"この作品にひとこと。気づき、風景、だれにも見せないメモでも。",rows:3}),i.jsx("div",{className:"album-memo-hint",children:"フォーカスが外れると自動で保存します。"})]}),o.metadata&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"metadata-section",children:[i.jsx("h3",{className:"metadata-section-title",children:"分析結果 (IR)"}),o.metadata.valence!==void 0&&i.jsxs("div",{className:"metadata-item",onMouseEnter:()=>j(0),onMouseLeave:()=>j(-1),children:[i.jsx("span",{className:"metadata-label",children:"Valence"}),i.jsxs("span",{className:"metadata-value",children:[o.metadata.valence.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",o.metadata.valence>0?"明るい":"暗い",")"]})]})]}),o.metadata.arousal!==void 0&&i.jsxs("div",{className:"metadata-item",onMouseEnter:()=>j(1),onMouseLeave:()=>j(-1),children:[i.jsx("span",{className:"metadata-label",children:"Arousal"}),i.jsxs("span",{className:"metadata-value",children:[o.metadata.arousal.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",o.metadata.arousal>.6?"動的":"静的",")"]})]})]}),o.metadata.focus!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"Focus"}),i.jsxs("span",{className:"metadata-value",children:[o.metadata.focus.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",o.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),o.metadata.confidence!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"信頼度"}),i.jsxs("span",{className:"metadata-value",children:[Math.round(o.metadata.confidence*100),"%"]})]}),o.metadata.motif_tags&&o.metadata.motif_tags.length>0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"モチーフ"}),i.jsx("span",{className:"metadata-value metadata-tags",children:o.metadata.motif_tags.join(", ")})]})]}),i.jsxs("div",{className:"metadata-section",children:[i.jsx("h3",{className:"metadata-section-title",children:"生成情報"}),o.metadata.stylePreset&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"スタイル"}),i.jsx("span",{className:"metadata-value",children:o.metadata.stylePreset})]}),o.metadata.seed!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"シード"}),i.jsx("span",{className:"metadata-value metadata-id",children:o.metadata.seed})]}),o.metadata.provider&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"生成方法"}),i.jsx("span",{className:"metadata-value",children:o.metadata.provider==="replicate"?"Replicate (SDXL)":o.metadata.provider==="local"?"ローカル生成":o.metadata.provider})]})]}),(o.metadata.prompt||o.metadata.negativePrompt)&&i.jsxs("details",{className:"metadata-section album-details-toggle",children:[i.jsx("summary",{className:"metadata-section-title",children:"プロンプト"}),o.metadata.prompt?i.jsxs("div",{className:"album-text-block",children:[i.jsx("div",{className:"album-text-label",children:"Prompt"}),i.jsx("pre",{className:"album-text-pre",children:o.metadata.prompt})]}):null,o.metadata.negativePrompt?i.jsxs("div",{className:"album-text-block",children:[i.jsx("div",{className:"album-text-label",children:"Negative"}),i.jsx("pre",{className:"album-text-pre",children:o.metadata.negativePrompt})]}):null]}),o.musicMetadata&&i.jsxs("div",{className:"metadata-section",children:[i.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"調"}),i.jsx("span",{className:"metadata-value",children:o.musicMetadata.key})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"テンポ"}),i.jsxs("span",{className:"metadata-value",children:[o.musicMetadata.tempo," BPM"]})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"拍子"}),i.jsx("span",{className:"metadata-value",children:o.musicMetadata.timeSignature})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"形式"}),i.jsx("span",{className:"metadata-value",children:o.musicMetadata.form})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"性格"}),i.jsx("span",{className:"metadata-value",children:o.musicMetadata.character})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"生成方法"}),i.jsx("span",{className:"metadata-value",children:o.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":o.musicMetadata.provider==="rule-based"?"ルールベース":o.musicMetadata.provider})]}),o.musicData&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"フォーマット"}),i.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(o.musicData.length/1024)," KB)"]})]})]}),o.metadata.provider==="replicate"&&i.jsxs("div",{className:"album-actions",children:[i.jsx("button",{className:"regenerate-btn",onClick:R,disabled:p,children:p?"再生成中...":"再生成 (新しいシード)"}),S&&i.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),y&&i.jsx("div",{className:"regenerate-error",children:y})]})]}),o.sessionData?i.jsxs("details",{className:"metadata-section album-details-toggle",children:[i.jsx("summary",{className:"metadata-section-title",children:"セッションデータ（概要）"}),i.jsxs("div",{className:"album-text-block",children:[i.jsx("div",{className:"album-text-label",children:"Keys"}),i.jsx("div",{className:"album-text-inline",children:typeof o.sessionData=="object"&&o.sessionData!==null?Object.keys(o.sessionData).slice(0,24).join(", "):typeof o.sessionData})]}),i.jsxs("div",{className:"album-text-block",children:[i.jsx("div",{className:"album-text-label",children:"Preview"}),i.jsx("pre",{className:"album-text-pre",children:f(o.sessionData)})]})]}):null,o.causalLogId||m?i.jsxs("div",{className:"metadata-section",children:[i.jsx("h3",{className:"metadata-section-title",children:"因果ログ"}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"Log ID"}),i.jsx("span",{className:"metadata-value metadata-id",children:o.causalLogId||""})]}),m?i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"成功"}),i.jsx("span",{className:"metadata-value",children:m.success?"Yes":"No"})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"総所要時間"}),i.jsxs("span",{className:"metadata-value",children:[Math.round((m.totalDuration||0)*10)/10," sec"]})]}),m.errors&&m.errors.length>0?i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"エラー"}),i.jsxs("span",{className:"metadata-value",children:[m.errors.length," 件"]})]}):null]}):null]}):null]}),i.jsx(Kc,{log:m})]})]}):i.jsxs("div",{className:"room-content album-room",children:[i.jsx("h1",{className:"room-title",children:"ALBUM"}),i.jsx("p",{className:"room-subtitle",children:"アルバム詳細"}),i.jsxs("div",{className:"album-empty",children:[i.jsx("p",{children:"アルバムが選択されていません"}),i.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})]})},nl=()=>{const{albums:n,getSelectedAlbum:e,selectAlbum:t}=wt(),s=e(),{navigateToRoom:a}=St(),{requestPlayAlbum:r}=Rt(),[c,l]=V.useState("now"),o=n.filter(d=>d.musicData),u=s&&s.musicData?i.jsxs("div",{className:"music-panel",children:[i.jsx(zt,{title:s.title||s.mood,mood:s.mood,imageUrl:s.imageDataURL,meta:`作成日: ${new Date(s.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...s.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...s.isPublic?[{label:"公開",tone:"info"}]:[]]}),s.musicMetadata&&i.jsxs("div",{className:"music-meta-grid room-card",children:[i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"調"}),i.jsx("span",{children:s.musicMetadata.key})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"テンポ"}),i.jsxs("span",{children:[s.musicMetadata.tempo," BPM"]})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"拍子"}),i.jsx("span",{children:s.musicMetadata.timeSignature})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"形式"}),i.jsx("span",{children:s.musicMetadata.form})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"性格"}),i.jsx("span",{children:s.musicMetadata.character})]})]}),i.jsxs("div",{className:"music-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:()=>r(s,o),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"})]})]}):i.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),h=i.jsxs("div",{className:"music-panel",children:[i.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",o.length,"件"]}),o.length>0?i.jsx("div",{className:"music-library-grid",children:o.map(d=>i.jsx("button",{className:"album-card-button",onClick:()=>{t(d.id),r(d,o)},children:i.jsx(zt,{title:d.title||d.mood,mood:d.mood,imageUrl:d.imageDataURL,meta:d.musicMetadata?`${d.musicMetadata.key} | ${d.musicMetadata.tempo} BPM | ${d.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...d.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...d.isPublic?[{label:"公開",tone:"info"}]:[]]})},d.id))}):i.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return i.jsxs("div",{className:"room-content music-room",children:[i.jsxs("div",{className:"room-header music-header",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"MUSIC"}),i.jsx("p",{className:"room-subtitle",children:"選択したアルバムを再生する"})]}),i.jsx("div",{className:"room-header-actions",children:i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"})})]}),i.jsx(tr,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:h}],value:c,onChange:l,ariaLabel:"音楽タブ"})]})},Qt="https://airia-beyond.onrender.com";async function il(n=50,e="all"){const t=await tt(`${Qt}/api/social/posts?limit=${encodeURIComponent(String(n))}&mode=${encodeURIComponent(String(e))}`);if(!t.ok)throw new Error(`Failed to load posts: ${t.status}`);return t.json()}async function al(n){const e=await tt(`${Qt}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function rl(n){const e=await tt(`${Qt}/api/social/posts/${encodeURIComponent(n)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function ol(n,e){const t=await tt(`${Qt}/api/social/posts/${encodeURIComponent(n)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to comment: ${t.status}`);return s}async function cl(n){const e=await tt(`${Qt}/api/social/users/${encodeURIComponent(n)}/follow`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to follow: ${e.status}`);return t}async function ll(n,e){const t=await tt(`${Qt}/api/social/posts/${encodeURIComponent(n)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:e})}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to update post: ${t.status}`);return s}async function ul(n){const e=await tt(`${Qt}/api/social/posts/${encodeURIComponent(n)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to delete post: ${e.status}`);return t}const dl={comment:i.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:i.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:i.jsxs(i.Fragment,{children:[i.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),i.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:i.jsx("path",{d:"M6 9l6 6 6-6"}),more:i.jsxs(i.Fragment,{children:[i.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),i.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),i.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},Hs=({name:n,size:e=16,className:t})=>i.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:dl[n]}),hl=()=>{const{albums:n,getSelectedAlbum:e,updateAlbum:t}=wt(),s=e(),{navigateToRoom:a}=St(),[r,c]=V.useState([]),[l,o]=V.useState(!1),[u,h]=V.useState(null),{user:d,logout:m,updateFollowingIds:f}=xn(),[p,g]=V.useState(""),[y,_]=V.useState(s?.id||(n[0]?.id??"")),[S,C]=V.useState(!1),[I,b]=V.useState({}),[N,j]=V.useState(null),[v,x]=V.useState("all"),[M,E]=V.useState({}),[D,R]=V.useState(null),T=V.useCallback(()=>{try{const P=String(window.location.hash||"").match(/^#social\/(.+)$/);if(P&&P[1])return decodeURIComponent(P[1])}catch{}try{const k="airia_social_focus_post_v1",P=localStorage.getItem(k);if(P)return localStorage.removeItem(k),String(P)}catch{}return null},[]),F=async k=>{const P=`${window.location.origin}/#social/${k}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(P);else{const A=document.createElement("input");A.value=P,document.body.appendChild(A),A.select(),document.execCommand("copy"),document.body.removeChild(A)}h("リンクをコピーしました"),setTimeout(()=>h(null),1500)}catch(A){h(A instanceof Error?A.message:String(A))}},q=V.useCallback(async()=>{o(!0),h(null);try{const k=await il(50,v);c(k.posts||[]);const P=D||T();P&&(R(P),E(A=>({...A,[P]:!0})),window.setTimeout(()=>{const A=document.querySelector(`[data-post-id="${CSS.escape(P)}"]`);A&&"scrollIntoView"in A&&A.scrollIntoView({block:"start",behavior:"smooth"})},60))}catch(k){h(k instanceof Error?k.message:String(k))}finally{o(!1)}},[T,v,D]);V.useEffect(()=>{q()},[q]),V.useEffect(()=>{s?.id&&_(s.id)},[s?.id]);const L=V.useMemo(()=>n.find(k=>k.id===y)||null,[n,y]),B=!!d&&!!L?.imageDataURL&&!S,G=async()=>{if(!d){h("投稿にはログインが必要です");return}if(L){C(!0),h(null);try{const k=await al({caption:p,album:{title:L.title||L.mood,mood:L.mood,imageUrl:L.thumbnailUrl||L.imageDataURL,createdAt:L.createdAt}});c(P=>[k,...P]),L.isPublic||t(L.id,{isPublic:!0}),g("")}catch(k){h(k instanceof Error?k.message:String(k))}finally{C(!1)}}},X=async k=>{if(!d){h("いいねにはログインが必要です");return}try{const P=await rl(k);c(A=>A.map(W=>W.id===k?P:W))}catch(P){h(P instanceof Error?P.message:String(P))}},H=async k=>{if(!d){h("コメントにはログインが必要です");return}const P=(I[k]||"").trim();if(P){j(k),h(null);try{const A=await ol(k,{text:P});c(W=>W.map(Z=>Z.id===k?{...Z,comments:Array.isArray(Z.comments)?[...Z.comments,A]:[A]}:Z)),b(W=>({...W,[k]:""}))}catch(A){h(A instanceof Error?A.message:String(A))}finally{j(null)}}},K=async k=>{if(!d){h("フォローにはログインが必要です");return}try{const P=await cl(k);f(P.followingIds)}catch(P){h(P instanceof Error?P.message:String(P))}},$=k=>{E(P=>({...P,[k]:!P[k]}))},Q=async k=>{if(!d){h("操作にはログインが必要です");return}const A=(String(k.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";h(null);try{const W=await ll(k.id,A);c(Z=>Z.map(ae=>ae.id===k.id?W:ae))}catch(W){h(W instanceof Error?W.message:String(W))}},O=async k=>{if(!d){h("操作にはログインが必要です");return}const P=k.album?.title||k.album?.mood||"投稿";if(window.confirm(`削除しますか？

${P}
この操作は取り消せません。`)){h(null);try{await ul(k.id),c(A=>A.filter(W=>W.id!==k.id))}catch(A){h(A instanceof Error?A.message:String(A))}}};return i.jsxs("div",{className:"room-content social-room",children:[i.jsxs("div",{className:"social-header",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"SOCIAL"}),i.jsx("p",{className:"room-subtitle",children:"作品を公開して、反応を集める"})]}),i.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"}),i.jsx("button",{className:"btn",onClick:()=>void q(),disabled:l,children:"更新"})]})]}),i.jsx("div",{className:"social-filter","data-no-swipe":"true",children:i.jsx(ii,{value:v,onChange:k=>x(k),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),i.jsx("div",{className:"social-auth","data-no-swipe":"true","aria-label":"ログイン",children:i.jsxs("div",{className:"social-auth-row",children:[i.jsxs("div",{className:"social-auth-me",children:[i.jsx("div",{className:"social-auth-title",children:"ログイン中"}),i.jsxs("div",{className:"social-auth-handle",children:["@",d?.handle||"..."]}),i.jsx("div",{className:"social-auth-sub",children:d?.displayName||""})]}),i.jsxs("div",{className:"social-auth-actions",children:[i.jsx("button",{className:"btn",onClick:()=>void q(),disabled:l,children:"再読み込み"}),i.jsx("button",{className:"btn",onClick:()=>void m(),disabled:!d,children:"ログアウト"})]})]})}),i.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[i.jsxs("div",{className:"social-compose-grid",children:[i.jsxs("label",{className:"social-field",children:[i.jsx("span",{className:"social-label",children:"公開するアルバム"}),i.jsxs("select",{className:"social-select",value:y,onChange:k=>_(k.target.value),children:[n.length===0&&i.jsx("option",{value:"",children:"（アルバムがありません）"}),n.map(k=>i.jsx("option",{value:k.id,children:k.title||k.mood},k.id))]})]}),i.jsxs("label",{className:"social-field social-field-wide",children:[i.jsx("span",{className:"social-label",children:"キャプション"}),i.jsx("textarea",{className:"social-textarea",value:p,onChange:k=>g(k.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),i.jsxs("div",{className:"social-compose-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!B,onClick:G,children:S?"公開中…":"公開する"}),L&&i.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:i.jsx(zt,{variant:"compact",title:L.title||L.mood,mood:L.mood,imageUrl:L.thumbnailUrl||L.imageDataURL,badges:[{label:L.musicData?"再生可能":"音声なし",tone:L.musicData?"success":"default"}]})})]}),u&&i.jsx("div",{className:"social-error",children:u})]}),i.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[l&&r.length===0&&i.jsx("div",{className:"social-muted",children:"読み込み中…"}),!l&&r.length===0&&i.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),r.map(k=>i.jsxs("article",{className:"social-post","data-no-swipe":"true","data-post-id":k.id,children:[i.jsxs("header",{className:"social-post-header",children:[i.jsxs("div",{className:"social-post-author",children:[k.author?.handle?`@${k.author.handle}`:k.authorName||"anonymous",k.author?.displayName&&i.jsx("span",{className:"social-post-author-sub",children:k.author.displayName})]}),i.jsx("div",{className:"social-post-date",children:new Date(k.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),k.author?.id&&d?.id!==k.author.id&&i.jsx("div",{className:"social-post-follow","data-no-swipe":"true",children:i.jsx("button",{className:`btn ${d?.followingIds?.includes(k.author.id)?"btn-primary":""}`,onClick:()=>void K(k.author.id),disabled:!d,children:d?.followingIds?.includes(k.author.id)?"フォロー中":"フォロー"})}),i.jsx("div",{className:"social-post-album",children:i.jsx(zt,{title:k.album?.title||"album",mood:k.album?.mood,imageUrl:k.album?.imageUrl,meta:k.album?.createdAt?`作成日: ${new Date(k.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:String(k.visibility||"public").toLowerCase()==="private"?"非公開":"公開作品",tone:String(k.visibility||"public").toLowerCase()==="private"?"default":"info"}]})}),k.caption&&i.jsx("div",{className:"social-post-caption",children:k.caption}),i.jsxs("div",{className:"social-post-actions",children:[i.jsxs("button",{className:`btn social-action ${M[k.id]?"is-active":""}`,onClick:()=>$(k.id),"aria-expanded":!!M[k.id],"aria-controls":`post-comments-${k.id}`,"aria-label":M[k.id]?"コメントを閉じる":"コメントを開く",children:[i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:M[k.id]?"chevronDown":"comment",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:M[k.id]?"閉じる":"コメント"})]}),i.jsx("span",{className:"social-count-chip",children:Array.isArray(k.comments)?k.comments.length:0})]}),i.jsxs("button",{className:`btn social-action ${k.viewerHasLiked?"is-active":""}`,onClick:()=>void X(k.id),disabled:!d,children:[i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:"heart",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:"いいね"})]}),i.jsx("span",{className:"social-count-chip",children:k.likes||0})]}),i.jsx("button",{className:"btn social-action",onClick:()=>void F(k.id),children:i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:"link",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:"共有"})]})}),i.jsx(rn,{triggerClassName:"btn social-action social-action-iconOnly",trigger:i.jsx(Hs,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:P})=>i.jsx(on,{items:(()=>{const A=!!d?.id&&!!k.author?.id&&d.id===k.author.id,W=[{id:"copy",label:"リンクをコピー",onSelect:()=>{F(k.id),P()}}];if(A){const Z=String(k.visibility||"public").toLowerCase()==="private";W.push({id:"vis",label:Z?"公開にする":"非公開にする",onSelect:()=>{Q(k),P()}}),W.push({id:"delete",label:"削除",onSelect:()=>{O(k),P()}})}else W.push({id:"report",label:"通報する",onSelect:()=>{h("通報を受け付けました"),P()}});return W})()})})]}),M[k.id]&&i.jsxs("div",{className:"social-post-comments",id:`post-comments-${k.id}`,children:[(k.comments||[]).slice(-6).map(P=>i.jsxs("div",{className:"social-comment",children:[i.jsx("span",{className:"social-comment-author",children:P.authorName||"anonymous"}),i.jsx("span",{className:"social-comment-text",children:P.text})]},P.id)),i.jsxs("div",{className:"social-comment-compose",children:[i.jsx("input",{className:"social-input",value:I[k.id]||"",onChange:P=>b(A=>({...A,[k.id]:P.target.value})),placeholder:d?"コメントを書く":"ログインしてコメント",maxLength:240,disabled:!d}),i.jsx("button",{className:"btn btn-primary",disabled:!d||N===k.id,onClick:()=>void H(k.id),children:N===k.id?"送信中…":"送信"})]})]})]},k.id))]})]})},_i="https://airia-beyond.onrender.com",ai="airia_admin_token_v1";function Es(){try{return String(localStorage.getItem(ai)||"")}catch{return""}}function sr(n){try{n?localStorage.setItem(ai,n):localStorage.removeItem(ai)}catch{}}async function nr(n){return n.json().catch(()=>null)}async function ml(n,e){const t=new URL(`${_i}/api/admin/audit`);t.searchParams.set("limit",String(n.limit)),n.sinceId!==void 0&&t.searchParams.set("sinceId",String(n.sinceId)),n.type&&t.searchParams.set("type",String(n.type)),n.actorId&&t.searchParams.set("actorId",String(n.actorId));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),a=await nr(s);if(!s.ok)throw new Error(a?.message||a?.error||`Failed to load audit: ${s.status}`);return a}function pl(n){const e=new URL(`${_i}/api/admin/audit/stream`);return e.searchParams.set("token",n),e.toString()}async function ya(n,e){const t=new URL(`${_i}/api/admin/metrics`);t.searchParams.set("days",String(n||30));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),a=await nr(s);if(!s.ok)throw new Error(a?.message||a?.error||`Failed to load metrics: ${s.status}`);return a}function fl(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})}const gl=()=>{const{user:n,logout:e,updateProfile:t,busy:s}=xn(),{navigateToRoom:a}=St(),{addToast:r}=bs(),[c,l]=V.useState(n?.displayName||""),[o,u]=V.useState(n?.bio||""),[h,d]=V.useState(!1),[m,f]=V.useState(Es());V.useEffect(()=>{l(n?.displayName||""),u(n?.bio||"")},[n?.displayName,n?.bio]),V.useEffect(()=>{f(Es())},[]);const p=!!n&&!h&&(c.trim()!==(n?.displayName||"")||o.trim()!==(n?.bio||"")),g=async()=>{if(n){d(!0);try{await t({displayName:c.trim()||void 0,bio:o.trim()||""}),r("success","プロフィールを保存しました")}catch(S){r("error",S instanceof Error?S.message:"保存に失敗しました")}finally{d(!1)}}},y=async()=>{try{await e()}catch{}},_=()=>{const S=m.trim();sr(S||null),r("success",S?"Admin token を保存しました":"Admin token をクリアしました")};return i.jsxs("div",{className:"room-content settings-room",children:[i.jsxs("div",{className:"settings-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"MY"}),i.jsx("p",{className:"room-subtitle",children:"プロフィールと設定"})]}),i.jsx("div",{className:"settings-header-actions",children:i.jsx("button",{className:"btn",onClick:()=>void y(),disabled:!n||s,children:"ログアウト"})})]}),i.jsxs("div",{className:"settings-card",children:[i.jsxs("section",{className:"settings-section",children:[i.jsx("h2",{className:"settings-title",children:"アカウント"}),i.jsxs("div",{className:"settings-kv",children:[i.jsxs("div",{className:"settings-kv-row",children:[i.jsx("div",{className:"settings-k",children:"ハンドル"}),i.jsxs("div",{className:"settings-v",children:["@",n?.handle||"..."]})]}),i.jsxs("div",{className:"settings-kv-row",children:[i.jsx("div",{className:"settings-k",children:"作成日"}),i.jsx("div",{className:"settings-v",children:n?.createdAt?fl(n.createdAt):""})]})]})]}),i.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"settings-title",children:"プロフィール"}),i.jsxs("div",{className:"settings-grid",children:[i.jsxs("label",{className:"settings-field",children:[i.jsx("span",{className:"settings-label",children:"表示名"}),i.jsx("input",{className:"settings-input",value:c,onChange:S=>l(S.target.value),maxLength:32,placeholder:"あなたの名前"})]}),i.jsxs("label",{className:"settings-field settings-field-wide",children:[i.jsx("span",{className:"settings-label",children:"自己紹介"}),i.jsx("textarea",{className:"settings-textarea",value:o,onChange:S=>u(S.target.value),maxLength:160,rows:4,placeholder:"一言（任意）"})]})]}),i.jsxs("div",{className:"settings-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!p,onClick:()=>void g(),children:h?"保存中…":"保存する"}),i.jsx("div",{className:"settings-muted",children:"プレリリースでは基本項目のみ編集できます。"})]})]}),i.jsxs("section",{className:"settings-section",children:[i.jsx("h2",{className:"settings-title",children:"通知"}),i.jsx("p",{className:"settings-muted",children:"メール通知は次フェーズで追加予定です。"})]}),i.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"settings-title",children:"Admin"}),i.jsx("div",{className:"settings-grid",children:i.jsxs("label",{className:"settings-field settings-field-wide",children:[i.jsx("span",{className:"settings-label",children:"ADMIN_TOKEN"}),i.jsx("input",{className:"settings-input",value:m,onChange:S=>f(S.target.value),placeholder:"サーバの ADMIN_TOKEN",type:"password",autoComplete:"off"})]})}),i.jsxs("div",{className:"settings-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:_,children:"保存"}),i.jsx("button",{className:"btn",onClick:()=>{_(),m.trim()&&a("admin")},disabled:!m.trim(),children:"Adminログへ"}),i.jsx("div",{className:"settings-muted",children:"Adminログは ADMIN_TOKEN を知っている人のみ利用できます。"})]})]})]})]})};function vl(n){const e=new Date(n);return Number.isNaN(e.getTime())?n:e.toLocaleString("ja-JP",{hour12:!1})}function yl(n){const e=n.actor;if(!e)return"anonymous";const t=e.handle?`@${e.handle}`:e.id,s=e.displayName?String(e.displayName):"";return s?`${s} (${t})`:t}const _l=()=>{const{addToast:n}=bs(),[e,t]=V.useState(Es()),[s,a]=V.useState(Es()),[r,c]=V.useState([]),[l,o]=V.useState(!1),[u,h]=V.useState(null),[d,m]=V.useState(null),[f,p]=V.useState(30),[g,y]=V.useState(""),[_,S]=V.useState(""),[C,I]=V.useState(!1),[b,N]=V.useState(!0),j=V.useRef(null),v=V.useCallback(()=>{if(j.current)try{j.current.close()}catch{}j.current=null,I(!1)},[]),x=V.useCallback(T=>{if(v(),!!T)try{const F=new EventSource(pl(T));j.current=F,F.addEventListener("hello",()=>{I(!0),h(null)}),F.addEventListener("audit",q=>{try{const L=JSON.parse(String(q.data||"null"));if(!L||typeof L!="object")return;c(B=>[L,...B].slice(0,2e3))}catch{}}),F.onerror=()=>{I(!1)}}catch(F){h(F instanceof Error?F.message:String(F)),I(!1)}},[v]),M=V.useCallback(async()=>{const T=(s||"").trim();if(!T){h("ADMIN_TOKEN を入力してください");return}o(!0),h(null);try{const F=await ml({limit:200,type:g.trim(),actorId:_.trim()},T);c(F.events||[]);const q=await ya(f,T);m(q)}catch(F){h(F instanceof Error?F.message:String(F))}finally{o(!1)}},[s,g,_,f]);V.useEffect(()=>{const T=(s||"").trim();if(!T)return;let F=!1;const q=async()=>{try{const B=await ya(f,T);F||m(B)}catch{}};q();const L=window.setInterval(q,6e4);return()=>{F=!0,window.clearInterval(L)}},[s,f]),V.useEffect(()=>{if(b&&s)return x(s),()=>v()},[b,s,x,v]);const E=()=>{const T=e.trim();sr(T||null),a(T),n("success",T?"Admin token を保存しました":"Admin token をクリアしました"),T&&b&&x(T),T||v()},D=()=>c([]),R=V.useMemo(()=>{const T=g.trim().toLowerCase(),F=_.trim();return r.filter(q=>{if(T&&!String(q.type||"").toLowerCase().includes(T))return!1;if(F){const L=String(q.actor?.id||""),B=String(q.actor?.handle||"");if(F!==L&&F!==B)return!1}return!0})},[r,g,_]);return i.jsxs("div",{className:"room-content admin-room",children:[i.jsxs("div",{className:"admin-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"ADMIN"}),i.jsx("p",{className:"room-subtitle",children:"ユーザーアクション監視ログ（リアルタイム）"})]}),i.jsxs("div",{className:"admin-header-actions",children:[i.jsx("span",{className:`admin-pill ${C?"ok":"ng"}`,children:C?"LIVE":"OFFLINE"}),i.jsx("button",{className:"btn",onClick:()=>void M(),disabled:l||!s,children:l?"読込中…":"最新を取得"}),i.jsx("button",{className:"btn btn-secondary",onClick:D,disabled:r.length===0,children:"表示クリア"})]})]}),i.jsxs("div",{className:"admin-metrics","data-no-swipe":"true",children:[i.jsxs("div",{className:"admin-metrics-top",children:[i.jsxs("div",{className:"admin-metrics-cards",children:[i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"総ユーザー数"}),i.jsx("div",{className:"admin-metric-v",children:d?.totals?.users??"—"})]}),i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"総アクション数"}),i.jsx("div",{className:"admin-metric-v",children:d?.totals?.actions??"—"})]}),i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"期間"}),i.jsxs("div",{className:"admin-metric-v",children:["直近 ",f," 日"]})]})]}),i.jsxs("div",{className:"admin-metrics-days",children:[i.jsx("button",{className:`btn ${f===7?"btn-primary":""}`,onClick:()=>p(7),children:"7日"}),i.jsx("button",{className:`btn ${f===14?"btn-primary":""}`,onClick:()=>p(14),children:"14日"}),i.jsx("button",{className:`btn ${f===30?"btn-primary":""}`,onClick:()=>p(30),children:"30日"})]})]}),i.jsxs("div",{className:"admin-charts",children:[i.jsx(_a,{title:"ユーザー増加（新規/日）",points:d?.series?.newUsersPerDay||[]}),i.jsx(_a,{title:"アクション数（/日）",points:d?.series?.actionsPerDay||[]})]})]}),i.jsxs("div",{className:"admin-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"admin-grid",children:[i.jsxs("label",{className:"admin-field admin-field-wide",children:[i.jsx("span",{className:"admin-label",children:"ADMIN_TOKEN"}),i.jsx("input",{className:"admin-input",value:e,onChange:T=>t(T.target.value),placeholder:"Bearer token（サーバの ADMIN_TOKEN）",type:"password",autoComplete:"off"})]}),i.jsxs("div",{className:"admin-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:E,children:"保存"}),i.jsx("button",{className:"btn",onClick:()=>C?v():x(s),disabled:!s,children:C?"切断":"接続"}),i.jsxs("label",{className:"admin-toggle",children:[i.jsx("input",{type:"checkbox",checked:b,onChange:T=>N(T.target.checked)}),"自動接続"]})]}),i.jsxs("label",{className:"admin-field",children:[i.jsx("span",{className:"admin-label",children:"type filter"}),i.jsx("input",{className:"admin-input",value:g,onChange:T=>y(T.target.value),placeholder:"social.post"})]}),i.jsxs("label",{className:"admin-field",children:[i.jsx("span",{className:"admin-label",children:"actor filter"}),i.jsx("input",{className:"admin-input",value:_,onChange:T=>S(T.target.value),placeholder:"user id or handle"})]})]}),u&&i.jsx("div",{className:"admin-error",children:u}),!s&&i.jsx("div",{className:"admin-hint",children:"まず ADMIN_TOKEN を入力して「保存」してください。"})]}),i.jsx("div",{className:"admin-list","data-no-swipe":"true",children:R.length===0?i.jsx("div",{className:"admin-empty",children:"ログがありません。操作してイベントを発生させてください。"}):R.map(T=>i.jsx(bl,{evt:T,onCopy:()=>{const F=JSON.stringify(T,null,2);navigator.clipboard.writeText(F).then(()=>n("success","コピーしました")).catch(()=>n("error","コピーできませんでした"))}},T.id))})]})},_a=({title:n,points:e})=>{const t=Math.max(1,...e.map(r=>Number(r.value||0))),s=e[e.length-1],a=e.reduce((r,c)=>r+(Number(c.value)||0),0);return i.jsxs("div",{className:"admin-chart",children:[i.jsxs("div",{className:"admin-chart-top",children:[i.jsx("div",{className:"admin-chart-title",children:n}),i.jsxs("div",{className:"admin-chart-meta",children:["合計 ",a," / 最新 ",s?.value??0]})]}),i.jsx("div",{className:"admin-chart-bars","aria-label":n,children:e.map(r=>i.jsx("div",{className:"admin-chart-bar",title:`${r.day}: ${r.value}`,children:i.jsx("div",{className:"admin-chart-barFill",style:{height:`${Math.round(Number(r.value||0)/t*100)}%`}})},r.day))}),i.jsxs("div",{className:"admin-chart-axis",children:[i.jsx("span",{children:e[0]?.day||""}),i.jsx("span",{children:e[e.length-1]?.day||""})]})]})},bl=({evt:n,onCopy:e})=>{const[t,s]=V.useState(!1);return i.jsxs("div",{className:"admin-row",children:[i.jsxs("button",{className:"admin-row-main",onClick:()=>s(a=>!a),"aria-expanded":t,children:[i.jsxs("div",{className:"admin-row-top",children:[i.jsx("div",{className:"admin-row-type",children:n.type}),i.jsx("div",{className:"admin-row-ts",children:vl(n.ts)})]}),i.jsxs("div",{className:"admin-row-mid",children:[i.jsx("div",{className:"admin-row-actor",children:yl(n)}),i.jsx("div",{className:"admin-row-summary",children:n.summary||""})]}),n.request?.path?i.jsxs("div",{className:"admin-row-path",children:[n.request.method," ",n.request.path]}):null]}),i.jsx("div",{className:"admin-row-actions","data-no-swipe":"true",children:i.jsx("button",{className:"btn btn-secondary",onClick:e,children:"JSONコピー"})}),t?i.jsx("pre",{className:"admin-row-json",children:JSON.stringify(n,null,2)}):null]})},xl=({label:n,children:e,placement:t="top"})=>{const s=w.useId(),[a,r]=w.useState(!1),c=[e.props["aria-describedby"],s].filter(Boolean).join(" ");return i.jsxs("span",{className:`tooltip-wrapper tooltip-${t}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),onFocusCapture:()=>r(!0),onBlurCapture:()=>r(!1),"data-no-swipe":"true",children:[V.cloneElement(e,{"aria-describedby":c}),i.jsx("span",{id:s,role:"tooltip",className:`tooltip-bubble ${a?"is-open":""}`,children:n})]})},ba="airia_theme";function wl(n){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n==="system"?e?"dark":"light":n;document.documentElement.setAttribute("data-theme",t)}const Nl=()=>{const{addToast:n}=bs(),{navigateToRoom:e}=St(),[t,s]=V.useState(()=>{try{return localStorage.getItem(ba)||"system"}catch{return"system"}}),a=l=>{s(l);try{localStorage.setItem(ba,l)}catch{}wl(l)},[r,c]=V.useState(!1);return i.jsxs("div",{className:"room-content info-room",children:[i.jsx("h1",{className:"room-title",children:"INFO"}),i.jsx("p",{className:"room-subtitle",children:"このアプリについて"}),i.jsxs("div",{className:"info-card",children:[i.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"info-title",children:"フィードバック"}),i.jsx("p",{className:"info-text",children:"不便・バグ・改善案はもちろん、良かった点も歓迎です。短くても大丈夫。"}),i.jsx("div",{className:"info-actions",children:i.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>e("feedback"),children:"フィードバックを書く"})})]}),i.jsxs("section",{className:"info-section",children:[i.jsx("h2",{className:"info-title",children:"目的"}),i.jsx("p",{className:"info-text",children:"この体験の目的は、「より貴方らしい芸術」を日常の中で生み出せること。"}),i.jsx("p",{className:"info-text",children:"そして、気持ちの変化に合わせて「ずっと寄り添える」相棒になることです。"})]}),i.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[i.jsxs("div",{className:"info-actions",children:[i.jsx("h2",{className:"info-title",children:"テーマ"}),i.jsx(xl,{label:"見やすさに合わせて切り替えできます",children:i.jsx("span",{className:"info-badge","aria-hidden":"true",children:"?"})})]}),i.jsx("div",{className:"info-actions",children:i.jsx("div",{className:"theme-toggle",role:"group","aria-label":"テーマ切り替え",children:[{id:"system",label:"システム"},{id:"light",label:"ライト"},{id:"dark",label:"ダーク"},{id:"high-contrast",label:"高コントラスト"}].map(l=>i.jsx("button",{type:"button",className:"theme-button","aria-pressed":t===l.id,onClick:()=>a(l.id),children:l.label},l.id))})}),i.jsx("p",{className:"info-text",children:"見やすさに合わせて切り替えられます。"})]}),i.jsxs("section",{className:"info-section",children:[i.jsxs("div",{className:"info-actions",children:[i.jsx("h2",{className:"info-title",children:"リンク"}),i.jsx("button",{type:"button",className:"info-reset",onClick:()=>c(!0),children:"アプリ情報"})]}),i.jsx("ul",{className:"info-list",children:i.jsx("li",{children:i.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})})})]}),null]}),i.jsxs(Za,{open:r,onOpenChange:c,title:"AIRIA BEYOND",description:"あなたの一日を、作品へ。",footer:i.jsx("button",{className:"btn btn-primary",onClick:()=>c(!1),children:"閉じる"}),children:[i.jsx("p",{className:"info-text",children:"会話と気分の手がかりから、あなたに合うレコメンドや創作を少しずつ育てていきます。"}),i.jsx("p",{className:"info-text",children:"まだプレリリース段階です。気づいたことがあれば、ぜひフィードバックを送ってください。"})]})]})},Sl=()=>{const{navigateToRoom:n}=St(),{addToast:e}=bs(),[t,s]=V.useState(!1),[a,r]=V.useState(null),[c,l]=V.useState(!1),[o,u]=V.useState(""),[h,d]=V.useState(""),[m,f]=V.useState(""),[p,g]=V.useState(""),[y,_]=V.useState(""),[S,C]=V.useState(""),[I,b]=V.useState(""),[N,j]=V.useState(""),[v,x]=V.useState(""),[M,E]=V.useState(""),[D,R]=V.useState(""),[T,F]=V.useState(!0),[q,L]=V.useState(!1),[B,G]=V.useState(null),[X,H]=V.useState(""),[K,$]=V.useState(!1),Q=V.useMemo(()=>(m.trim().length>0||p.trim().length>0||y.trim().length>0||S.trim().length>0||I.trim().length>0)&&!t,[I,S,t,p,y,m]),O=async()=>{G(null),L(!0);try{const A=await fetch("/api/diagnostics/image",{method:"GET"}),W=await A.json().catch(()=>({}));if(!A.ok)throw new Error(W?.message||"診断情報の取得に失敗しました");const Z=JSON.stringify(W,null,2);H(Z),e("success","診断情報を取得しました。必要ならコピーして送れます。")}catch(A){const W=A instanceof Error?A.message:"診断情報の取得に失敗しました";G(W),e("error",W)}finally{L(!1)}},k=async()=>{const A=X.trim();if(!A){e("info","先に「診断情報を取得」を押してください。");return}try{await navigator.clipboard.writeText(A),e("success","診断情報をコピーしました。")}catch{try{const W=document.createElement("textarea");W.value=A,W.style.position="fixed",W.style.left="-9999px",document.body.appendChild(W),W.select(),document.execCommand("copy"),document.body.removeChild(W),e("success","診断情報をコピーしました。")}catch{e("error","コピーに失敗しました。手動で選択してコピーしてください。")}}},P=async()=>{if(Q){r(null),l(!1),s(!0);try{const A=await fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:o||void 0,rating:h||void 0,title:m||void 0,message:p||void 0,steps:y||void 0,expected:S||void 0,actual:I||void 0,device:N||void 0,browser:v||void 0,name:M||void 0,contact:D||void 0,allowFollowUp:T,diagnostics:K&&X.trim().length>0?X:void 0})}),W=await A.json().catch(()=>({}));if(!A.ok)throw new Error(W?.message||"送信に失敗しました");l(!0),e("success","フィードバックを送信しました。ありがとうございます。"),u(""),d(""),f(""),g(""),_(""),C(""),b(""),j(""),x("")}catch(A){const W=A instanceof Error?A.message:"送信に失敗しました";r(W),e("error",W)}finally{s(!1)}}};return i.jsxs("div",{className:"room-content feedback-room",children:[i.jsxs("div",{className:"feedback-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"FEEDBACK"}),i.jsx("p",{className:"room-subtitle",children:"改善のために、気づいたことを教えてください"})]}),i.jsx("div",{className:"feedback-header-actions",children:i.jsx("button",{className:"btn btn-secondary",onClick:()=>n("info"),children:"Infoへ"})})]}),i.jsxs("div",{className:"feedback-hero","data-no-swipe":"true",children:[i.jsxs("div",{className:"feedback-hero-top",children:[i.jsx("h2",{className:"feedback-hero-title",children:"フィードバックを送ってください"}),i.jsxs("p",{className:"feedback-hero-sub",children:["不便・バグ・改善案はもちろん、良かった点も歓迎です。",i.jsx("br",{}),"一部だけの回答でも送信できます。"]})]}),i.jsxs("div",{className:"feedback-grid",children:[i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"カテゴリ"}),i.jsxs("select",{className:"feedback-input",value:o,onChange:A=>u(A.target.value),children:[i.jsx("option",{value:"",children:"未選択"}),i.jsx("option",{value:"bug",children:"バグ"}),i.jsx("option",{value:"ux",children:"使いにくい"}),i.jsx("option",{value:"feature",children:"要望"}),i.jsx("option",{value:"praise",children:"良かった"}),i.jsx("option",{value:"other",children:"その他"})]})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"気持ち（任意）"}),i.jsxs("select",{className:"feedback-input",value:h,onChange:A=>d(A.target.value),children:[i.jsx("option",{value:"",children:"未選択"}),i.jsx("option",{value:"great",children:"最高だった"}),i.jsx("option",{value:"good",children:"良かった"}),i.jsx("option",{value:"ok",children:"ふつう"}),i.jsx("option",{value:"frustrating",children:"困った"}),i.jsx("option",{value:"broken",children:"壊れてる"})]})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"タイトル（任意）"}),i.jsx("input",{className:"feedback-input",value:m,onChange:A=>f(A.target.value),placeholder:"例：再開ボタンが効かない / 背景が綺麗で好き"})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"本文（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:p,onChange:A=>g(A.target.value),placeholder:"気づいたことを自由に。短くてもOK。",rows:5})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"再現手順（任意・バグ向け）"}),i.jsx("textarea",{className:"feedback-textarea",value:y,onChange:A=>_(A.target.value),placeholder:`例：
1) Chatで「今すぐ1曲」
2) キャンセル
3) 再開
→ エラー`,rows:4})]}),i.jsxs("div",{className:"feedback-field feedback-span-2 feedback-split",children:[i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"期待したこと（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:S,onChange:A=>C(A.target.value),rows:3})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"実際に起きたこと（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:I,onChange:A=>b(A.target.value),rows:3})]})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"端末（任意）"}),i.jsx("input",{className:"feedback-input",value:N,onChange:A=>j(A.target.value),placeholder:"例：iPhone / Windows"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"ブラウザ（任意）"}),i.jsx("input",{className:"feedback-input",value:v,onChange:A=>x(A.target.value),placeholder:"例：Safari / Chrome"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"お名前（任意）"}),i.jsx("input",{className:"feedback-input",value:M,onChange:A=>E(A.target.value),placeholder:"匿名でもOK"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"連絡先（任意）"}),i.jsx("input",{className:"feedback-input",value:D,onChange:A=>R(A.target.value),placeholder:"返信が必要な場合だけ"})]}),i.jsxs("label",{className:"feedback-check feedback-span-2",children:[i.jsx("input",{type:"checkbox",checked:T,onChange:A=>F(A.target.checked)}),"必要があれば追加で質問してもよい（任意）"]}),i.jsxs("div",{className:"feedback-actions feedback-span-2",children:[i.jsx("button",{type:"button",className:"btn btn-primary feedback-submit",disabled:!Q,onClick:()=>void P(),children:t?"送信中…":"送信する"}),i.jsx("div",{className:"feedback-hint",children:c?"送信完了。ありがとうございます。":"※ タイトル/本文/再現手順など、どれか1つでも書けば送信できます。"}),a?i.jsx("div",{className:"feedback-error",children:a}):null]})]})]}),i.jsxs("div",{className:"diagnostics-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"diagnostics-top",children:[i.jsx("h2",{className:"diagnostics-title",children:"困ったとき（診断情報）"}),i.jsx("p",{className:"diagnostics-sub",children:"画像生成がうまくいかない時は、診断情報をコピーしてフィードバックに貼り付けると原因特定が早くなります。"})]}),i.jsxs("div",{className:"diagnostics-actions",children:[i.jsx("button",{type:"button",className:"btn btn-secondary",disabled:q,onClick:()=>void O(),children:q?"取得中…":"診断情報を取得"}),i.jsx("button",{type:"button",className:"btn btn-secondary",disabled:!X.trim(),onClick:()=>void k(),children:"コピー"}),i.jsxs("label",{className:"diagnostics-attach",children:[i.jsx("input",{type:"checkbox",checked:K,onChange:A=>$(A.target.checked)}),"フィードバック送信に添付する（任意）"]})]}),i.jsx("p",{className:"diagnostics-note",children:"※ 個人情報は含めませんが、接続先URL・エラー概要・最近のジョブ情報が含まれることがあります。"}),i.jsx("textarea",{className:"diagnostics-textarea",value:X,onChange:A=>H(A.target.value),placeholder:"ここに診断情報が表示されます（取得ボタンを押してください）",rows:7}),B?i.jsx("div",{className:"diagnostics-error",children:B}):null]})]})},jl=({onDismiss:n})=>{const[e,t]=w.useState("enter");w.useEffect(()=>{const a=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>n(),2900)];return()=>{a.forEach(r=>clearTimeout(r))}},[n]);const s=()=>{t("exit"),window.setTimeout(n,260)};return i.jsxs("div",{className:`splash-screen splash-${e}`,onClick:s,role:"button",tabIndex:0,onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&s()},"aria-label":"クリックして開始",children:[i.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[i.jsx("div",{className:"splash-orbit"}),i.jsx("div",{className:"splash-grain"})]}),i.jsxs("div",{className:"splash-content",children:[i.jsx("div",{className:"splash-mark","aria-hidden":"true",children:i.jsx("div",{className:"splash-monogram",children:"A"})}),i.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),i.jsx("div",{className:"splash-rule","aria-hidden":"true"}),i.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),i.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},ir="15.1.22",xa=(n,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:n}),wa=(n,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:n}),ri=(n,e)=>({startTime:e,type:"setValue",value:n}),ar=(n,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:n}),rr=(n,e,{startTime:t,target:s,timeConstant:a})=>s+(e-s)*Math.exp((t-n)/a),os=n=>n.type==="exponentialRampToValue",cn=n=>n.type==="linearRampToValue",Mt=n=>os(n)||cn(n),bi=n=>n.type==="setValue",bt=n=>n.type==="setValueCurve",ln=(n,e,t,s)=>{const a=n[e];return a===void 0?s:Mt(a)||bi(a)?a.value:bt(a)?a.values[a.values.length-1]:rr(t,ln(n,e-1,a.startTime,s),a)},Na=(n,e,t,s,a)=>t===void 0?[s.insertTime,a]:Mt(t)?[t.endTime,t.value]:bi(t)?[t.startTime,t.value]:bt(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,ln(n,e-1,t.startTime,a)],oi=n=>n.type==="cancelAndHold",ci=n=>n.type==="cancelScheduledValues",Ct=n=>oi(n)||ci(n)?n.cancelTime:os(n)||cn(n)?n.endTime:n.startTime,Sa=(n,e,t,{endTime:s,value:a})=>t===a?a:0<t&&0<a||t<0&&a<0?t*(a/t)**((n-e)/(s-e)):0,ja=(n,e,t,{endTime:s,value:a})=>t+(n-e)/(s-e)*(a-t),Tl=(n,e)=>{const t=Math.floor(e),s=Math.ceil(e);return t===s?n[t]:(1-(e-t))*n[t]+(1-(s-e))*n[s]},kl=(n,{duration:e,startTime:t,values:s})=>{const a=(n-t)/e*(s.length-1);return Tl(s,a)},Js=n=>n.type==="setTarget";class Cl{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=Ct(e);if(oi(e)||ci(e)){const s=this._automationEvents.findIndex(r=>ci(e)&&bt(r)?r.startTime+r.duration>=t:Ct(r)>=t),a=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),oi(e)){const r=this._automationEvents[this._automationEvents.length-1];if(a!==void 0&&Mt(a)){if(r!==void 0&&Js(r))throw new Error("The internal list is malformed.");const c=r===void 0?a.insertTime:bt(r)?r.startTime+r.duration:Ct(r),l=r===void 0?this._defaultValue:bt(r)?r.values[r.values.length-1]:r.value,o=os(a)?Sa(t,c,l,a):ja(t,c,l,a),u=os(a)?xa(o,t,this._currenTime):wa(o,t,this._currenTime);this._automationEvents.push(u)}if(r!==void 0&&Js(r)&&this._automationEvents.push(ri(this.getValue(t),t)),r!==void 0&&bt(r)&&r.startTime+r.duration>t){const c=t-r.startTime,l=(r.values.length-1)/r.duration,o=Math.max(2,1+Math.ceil(c*l)),u=c/(o-1)*l,h=r.values.slice(0,o);if(u<1)for(let d=1;d<o;d+=1){const m=u*d%1;h[d]=r.values[d-1]*(1-m)+r.values[d]*m}this._automationEvents[this._automationEvents.length-1]=ar(h,r.startTime,c)}}}else{const s=this._automationEvents.findIndex(c=>Ct(c)>t),a=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(a!==void 0&&bt(a)&&Ct(a)+a.duration>t)return!1;const r=os(e)?xa(e.value,e.endTime,this._currenTime):cn(e)?wa(e.value,t,this._currenTime):e;if(s===-1)this._automationEvents.push(r);else{if(bt(e)&&t+e.duration>Ct(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,r)}}return!0}flush(e){const t=this._automationEvents.findIndex(s=>Ct(s)>e);if(t>1){const s=this._automationEvents.slice(t-1),a=s[0];Js(a)&&s.unshift(ri(ln(this._automationEvents,t-2,a.startTime,this._defaultValue),a.startTime)),this._automationEvents=s}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(c=>Ct(c)>e),s=this._automationEvents[t],a=(t===-1?this._automationEvents.length:t)-1,r=this._automationEvents[a];if(r!==void 0&&Js(r)&&(s===void 0||!Mt(s)||s.insertTime>e))return rr(e,ln(this._automationEvents,a-1,r.startTime,this._defaultValue),r);if(r!==void 0&&bi(r)&&(s===void 0||!Mt(s)))return r.value;if(r!==void 0&&bt(r)&&(s===void 0||!Mt(s)||r.startTime+r.duration>e))return e<r.startTime+r.duration?kl(e,r):r.values[r.values.length-1];if(r!==void 0&&Mt(r)&&(s===void 0||!Mt(s)))return r.value;if(s!==void 0&&os(s)){const[c,l]=Na(this._automationEvents,a,r,s,this._defaultValue);return Sa(e,c,l,s)}if(s!==void 0&&cn(s)){const[c,l]=Na(this._automationEvents,a,r,s,this._defaultValue);return ja(e,c,l,s)}return this._defaultValue}}const Al=n=>({cancelTime:n,type:"cancelAndHold"}),Ml=n=>({cancelTime:n,type:"cancelScheduledValues"}),El=(n,e)=>({endTime:e,type:"exponentialRampToValue",value:n}),Il=(n,e)=>({endTime:e,type:"linearRampToValue",value:n}),Dl=(n,e,t)=>({startTime:e,target:n,timeConstant:t,type:"setTarget"}),Pl=()=>new DOMException("","AbortError"),Ol=n=>(e,t,[s,a,r],c)=>{n(e[a],[t,s,r],l=>l[0]===t&&l[1]===s,c)},Rl=n=>(e,t,s)=>{const a=[];for(let r=0;r<s.numberOfInputs;r+=1)a.push(new Set);n.set(e,{activeInputs:a,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},Fl=n=>(e,t)=>{n.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},hs=new WeakSet,or=new WeakMap,xi=new WeakMap,cr=new WeakMap,wi=new WeakMap,wn=new WeakMap,lr=new WeakMap,li=new WeakMap,ui=new WeakMap,di=new WeakMap,ur={construct(){return ur}},Ll=n=>{try{const e=new Proxy(n,ur);new e}catch{return!1}return!0},Ta=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,ka=(n,e)=>{const t=[];let s=n.replace(/^[\s]+/,""),a=s.match(Ta);for(;a!==null;){const r=a[1].slice(1,-1),c=a[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,e).toString());t.push(c),s=s.slice(a[0].length).replace(/^[\s]+/,""),a=s.match(Ta)}return[t.join(";"),s]},Ca=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Aa=n=>{if(!Ll(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Vl=(n,e,t,s,a,r,c,l,o,u,h,d,m)=>{let f=0;return(p,g,y={credentials:"omit"})=>{const _=h.get(p);if(_!==void 0&&_.has(g))return Promise.resolve();const S=u.get(p);if(S!==void 0){const b=S.get(g);if(b!==void 0)return b}const C=r(p),I=C.audioWorklet===void 0?a(g).then(([b,N])=>{const[j,v]=ka(b,N),x=`${j};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${v}
})})(window,'_AWGS')`;return t(x)}).then(()=>{const b=m._AWGS.pop();if(b===void 0)throw new SyntaxError;s(C.currentTime,C.sampleRate,()=>b(class{},void 0,(N,j)=>{if(N.trim()==="")throw e();const v=ui.get(C);if(v!==void 0){if(v.has(N))throw e();Aa(j),Ca(j.parameterDescriptors),v.set(N,j)}else Aa(j),Ca(j.parameterDescriptors),ui.set(C,new Map([[N,j]]))},C.sampleRate,void 0,void 0))}):Promise.all([a(g),Promise.resolve(n(d,d))]).then(([[b,N],j])=>{const v=f+1;f=v;const[x,M]=ka(b,N),T=`${x};((AudioWorkletProcessor,registerProcessor)=>{${M}
})(${j?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${j?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${j?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${v}',class extends AudioWorkletProcessor{process(){return !1}})`,F=new Blob([T],{type:"application/javascript; charset=utf-8"}),q=URL.createObjectURL(F);return C.audioWorklet.addModule(q,y).then(()=>{if(l(C))return C;const L=c(C);return L.audioWorklet.addModule(q,y).then(()=>L)}).then(L=>{if(o===null)throw new SyntaxError;try{new o(L,`__sac${v}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(q))});return S===void 0?u.set(p,new Map([[g,I]])):S.set(g,I),I.then(()=>{const b=h.get(p);b===void 0?h.set(p,new Set([g])):b.add(g)}).finally(()=>{const b=u.get(p);b!==void 0&&b.delete(g)}),I}},at=(n,e)=>{const t=n.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},Nn=(n,e)=>{const t=Array.from(n).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[s]=t;return n.delete(s),s},dr=(n,e,t,s)=>{const a=at(n,e),r=Nn(a,c=>c[0]===t&&c[1]===s);return a.size===0&&n.delete(e),r},Rs=n=>at(lr,n),ms=n=>{if(hs.has(n))throw new Error("The AudioNode is already stored.");hs.add(n),Rs(n).forEach(e=>e(!0))},hr=n=>"port"in n,Fs=n=>{if(!hs.has(n))throw new Error("The AudioNode is not stored.");hs.delete(n),Rs(n).forEach(e=>e(!1))},hi=(n,e)=>{!hr(n)&&e.every(t=>t.size===0)&&Fs(n)},ql=(n,e,t,s,a,r,c,l,o,u,h,d,m)=>{const f=new WeakMap;return(p,g,y,_,S)=>{const{activeInputs:C,passiveInputs:I}=r(g),{outputs:b}=r(p),N=l(p),j=v=>{const x=o(g),M=o(p);if(v){const E=dr(I,p,y,_);n(C,p,E,!1),!S&&!d(p)&&t(M,x,y,_),m(g)&&ms(g)}else{const E=s(C,p,y,_);e(I,_,E,!1),!S&&!d(p)&&a(M,x,y,_);const D=c(g);if(D===0)h(g)&&hi(g,C);else{const R=f.get(g);R!==void 0&&clearTimeout(R),f.set(g,setTimeout(()=>{h(g)&&hi(g,C)},D*1e3))}}};return u(b,[g,y,_],v=>v[0]===g&&v[1]===y&&v[2]===_,!0)?(N.add(j),h(p)?n(C,p,[y,_,j],!0):e(I,_,[p,y,j],!0),!0):!1}},Wl=n=>(e,t,[s,a,r],c)=>{const l=e.get(s);l===void 0?e.set(s,new Set([[a,t,r]])):n(l,[a,t,r],o=>o[0]===a&&o[1]===t,c)},Bl=n=>(e,t)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(s).connect(e.destination);const a=()=>{t.removeEventListener("ended",a),t.disconnect(s),s.disconnect()};t.addEventListener("ended",a)},Ul=n=>(e,t)=>{n(e).add(t)},$l={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},Gl=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=a(l),h={...$l,...o},d=s(u,h),m=r(u)?e():null;super(l,!1,d,m),this._nativeAnalyserNode=d}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(l){this._nativeAnalyserNode.fftSize=l}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(l){const o=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=l,!(l>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=o,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(l){const o=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=l,!(this._nativeAnalyserNode.maxDecibels>l))throw this._nativeAnalyserNode.minDecibels=o,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(l){this._nativeAnalyserNode.smoothingTimeConstant=l}getByteFrequencyData(l){this._nativeAnalyserNode.getByteFrequencyData(l)}getByteTimeDomainData(l){this._nativeAnalyserNode.getByteTimeDomainData(l)}getFloatFrequencyData(l){this._nativeAnalyserNode.getFloatFrequencyData(l)}getFloatTimeDomainData(l){this._nativeAnalyserNode.getFloatTimeDomainData(l)}},Ve=(n,e)=>n.context===e,zl=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,c)=>{let l=e(r);if(!Ve(l,c)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,fftSize:l.fftSize,maxDecibels:l.maxDecibels,minDecibels:l.minDecibels,smoothingTimeConstant:l.smoothingTimeConstant};l=n(c,u)}return s.set(c,l),await t(r,c,l),l};return{render(r,c){const l=s.get(c);return l!==void 0?Promise.resolve(l):a(r,c)}}},un=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},gt=()=>new DOMException("","IndexSizeError"),Ni=n=>{n.getChannelData=(e=>t=>{try{return e.call(n,t)}catch(s){throw s.code===12?gt():s}})(n.getChannelData)},Yl={numberOfChannels:1},Xl=(n,e,t,s,a,r,c,l)=>{let o=null;return class mr{constructor(h){if(a===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:d,numberOfChannels:m,sampleRate:f}={...Yl,...h};o===null&&(o=new a(1,1,44100));const p=s!==null&&e(r,r)?new s({length:d,numberOfChannels:m,sampleRate:f}):o.createBuffer(m,d,f);if(p.numberOfChannels===0)throw t();return typeof p.copyFromChannel!="function"?(c(p),Ni(p)):e(un,()=>un(p))||l(p),n.add(p),p}static[Symbol.hasInstance](h){return h!==null&&typeof h=="object"&&Object.getPrototypeOf(h)===mr.prototype||n.has(h)}}},Ge=-34028234663852886e22,We=-Ge,xt=n=>hs.has(n),Hl={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Jl=(n,e,t,s,a,r,c,l)=>class extends n{constructor(u,h){const d=r(u),m={...Hl,...h},f=a(d,m),p=c(d),g=p?e():null;super(u,!1,f,g),this._audioBufferSourceNodeRenderer=g,this._isBufferNullified=!1,this._isBufferSet=m.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,p,f.playbackRate,We,Ge)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const h=typeof u=="function"?l(this,u):null;this._nativeAudioBufferSourceNode.onended=h;const d=this._nativeAudioBufferSourceNode.onended;this._onended=d!==null&&d===h?u:d}get playbackRate(){return this._playbackRate}start(u=0,h=0,d){if(this._nativeAudioBufferSourceNode.start(u,h,d),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=d===void 0?[u,h]:[u,h,d]),this.context.state!=="closed"){ms(this);const m=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",m),xt(this)&&Fs(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",m)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},Zl=(n,e,t,s,a)=>()=>{const r=new WeakMap;let c=null,l=null;const o=async(u,h)=>{let d=t(u);const m=Ve(d,h);if(!m){const f={buffer:d.buffer,channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,loop:d.loop,loopEnd:d.loopEnd,loopStart:d.loopStart,playbackRate:d.playbackRate.value};d=e(h,f),c!==null&&d.start(...c),l!==null&&d.stop(l)}return r.set(h,d),m?await n(h,u.playbackRate,d.playbackRate):await s(h,u.playbackRate,d.playbackRate),await a(u,h,d),d};return{set start(u){c=u},set stop(u){l=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):o(u,h)}}},Kl=n=>"playbackRate"in n,Ql=n=>"frequency"in n&&"gain"in n,eu=n=>"offset"in n,tu=n=>!("frequency"in n)&&"gain"in n,su=n=>"detune"in n&&"frequency"in n&&!("gain"in n),nu=n=>"pan"in n,Be=n=>at(or,n),Ls=n=>at(cr,n),mi=(n,e)=>{const{activeInputs:t}=Be(n);t.forEach(a=>a.forEach(([r])=>{e.includes(n)||mi(r,[...e,n])}));const s=Kl(n)?[n.playbackRate]:hr(n)?Array.from(n.parameters.values()):Ql(n)?[n.Q,n.detune,n.frequency,n.gain]:eu(n)?[n.offset]:tu(n)?[n.gain]:su(n)?[n.detune,n.frequency]:nu(n)?[n.pan]:[];for(const a of s){const r=Ls(a);r!==void 0&&r.activeInputs.forEach(([c])=>mi(c,e))}xt(n)&&Fs(n)},pr=n=>{mi(n.destination,[])},iu=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),au=(n,e,t,s,a,r,c,l,o)=>class extends n{constructor(h={}){if(o===null)throw new Error("Missing the native AudioContext constructor.");let d;try{d=new o(h)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?t():p}if(d===null)throw s();if(!iu(h.latencyHint))throw new TypeError(`The provided value '${h.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(h.sampleRate!==void 0&&d.sampleRate!==h.sampleRate)throw t();super(d,2);const{latencyHint:m}=h,{sampleRate:f}=d;if(this._baseLatency=typeof d.baseLatency=="number"?d.baseLatency:m==="balanced"?512/f:m==="interactive"||m===void 0?256/f:m==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(m*f/128)))*128/f,this._nativeAudioContext=d,o.name==="webkitAudioContext"?(this._nativeGainNode=d.createGain(),this._nativeOscillatorNode=d.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(d.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,d.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),d.removeEventListener("statechange",p)};d.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),pr(this)}))}createMediaElementSource(h){return new a(this,{mediaElement:h})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(h){return new c(this,{mediaStream:h})}createMediaStreamTrackSource(h){return new l(this,{mediaStreamTrack:h})}resume(){return this._state==="suspended"?new Promise((h,d)=>{const m=()=>{this._nativeAudioContext.removeEventListener("statechange",m),this._nativeAudioContext.state==="running"?h():this.resume().then(h,d)};this._nativeAudioContext.addEventListener("statechange",m)}):this._nativeAudioContext.resume().catch(h=>{throw h===void 0||h.code===15?e():h})}suspend(){return this._nativeAudioContext.suspend().catch(h=>{throw h===void 0?e():h})}},ru=(n,e,t,s,a,r,c,l)=>class extends n{constructor(u,h){const d=r(u),m=c(d),f=a(d,h,m),p=m?e(l):null;super(u,!1,f,p),this._isNodeOfNativeOfflineAudioContext=m,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},ou=n=>{const e=new WeakMap,t=async(s,a)=>{const r=a.destination;return e.set(a,r),await n(s,a,r),r};return{render(s,a){const r=e.get(a);return r!==void 0?Promise.resolve(r):t(s,a)}}},cu=(n,e,t,s,a,r,c,l)=>(o,u)=>{const h=u.listener,d=()=>{const b=new Float32Array(1),N=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),j=c(u);let v=!1,x=[0,0,-1,0,1,0],M=[0,0,0];const E=()=>{if(v)return;v=!0;const F=s(u,256,9,0);F.onaudioprocess=({inputBuffer:q})=>{const L=[r(q,b,0),r(q,b,1),r(q,b,2),r(q,b,3),r(q,b,4),r(q,b,5)];L.some((G,X)=>G!==x[X])&&(h.setOrientation(...L),x=L);const B=[r(q,b,6),r(q,b,7),r(q,b,8)];B.some((G,X)=>G!==M[X])&&(h.setPosition(...B),M=B)},N.connect(F)},D=F=>q=>{q!==x[F]&&(x[F]=q,h.setOrientation(...x))},R=F=>q=>{q!==M[F]&&(M[F]=q,h.setPosition(...M))},T=(F,q,L)=>{const B=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:q});B.connect(N,0,F),B.start(),Object.defineProperty(B.offset,"defaultValue",{get(){return q}});const G=n({context:o},j,B.offset,We,Ge);return l(G,"value",X=>()=>X.call(G),X=>H=>{try{X.call(G,H)}catch(K){if(K.code!==9)throw K}E(),j&&L(H)}),G.cancelAndHoldAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.cancelAndHoldAtTime),G.cancelScheduledValues=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.cancelScheduledValues),G.exponentialRampToValueAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.exponentialRampToValueAtTime),G.linearRampToValueAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.linearRampToValueAtTime),G.setTargetAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.setTargetAtTime),G.setValueAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.setValueAtTime),G.setValueCurveAtTime=(X=>j?()=>{throw a()}:(...H)=>{const K=X.apply(G,H);return E(),K})(G.setValueCurveAtTime),G};return{forwardX:T(0,0,D(0)),forwardY:T(1,0,D(1)),forwardZ:T(2,-1,D(2)),positionX:T(6,0,R(0)),positionY:T(7,0,R(1)),positionZ:T(8,0,R(2)),upX:T(3,0,D(3)),upY:T(4,1,D(4)),upZ:T(5,0,D(5))}},{forwardX:m,forwardY:f,forwardZ:p,positionX:g,positionY:y,positionZ:_,upX:S,upY:C,upZ:I}=h.forwardX===void 0?d():h;return{get forwardX(){return m},get forwardY(){return f},get forwardZ(){return p},get positionX(){return g},get positionY(){return y},get positionZ(){return _},get upX(){return S},get upY(){return C},get upZ(){return I}}},dn=n=>"context"in n,Vs=n=>dn(n[0]),es=(n,e,t,s)=>{for(const a of n)if(t(a)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(e),!0},Ma=(n,e,[t,s],a)=>{es(n,[e,t,s],r=>r[0]===e&&r[1]===t,a)},Ea=(n,[e,t,s],a)=>{const r=n.get(e);r===void 0?n.set(e,new Set([[t,s]])):es(r,[t,s],c=>c[0]===t,a)},xs=n=>"inputs"in n,hn=(n,e,t,s)=>{if(xs(e)){const a=e.inputs[s];return n.connect(a,t,0),[a,t,0]}return n.connect(e,t,s),[e,t,s]},fr=(n,e,t)=>{for(const s of n)if(s[0]===e&&s[1]===t)return n.delete(s),s;return null},lu=(n,e,t)=>Nn(n,s=>s[0]===e&&s[1]===t),gr=(n,e)=>{if(!Rs(n).delete(e))throw new Error("Missing the expected event listener.")},vr=(n,e,t)=>{const s=at(n,e),a=Nn(s,r=>r[0]===t);return s.size===0&&n.delete(e),a},mn=(n,e,t,s)=>{xs(e)?n.disconnect(e.inputs[s],t,0):n.disconnect(e,t,s)},pe=n=>at(xi,n),Is=n=>at(wi,n),Yt=n=>li.has(n),sn=n=>!hs.has(n),Ia=(n,e)=>new Promise(t=>{if(e!==null)t(!0);else{const s=n.createScriptProcessor(256,1,1),a=n.createGain(),r=n.createBuffer(1,2,44100),c=r.getChannelData(0);c[0]=1,c[1]=1;const l=n.createBufferSource();l.buffer=r,l.loop=!0,l.connect(s).connect(n.destination),l.connect(a),l.disconnect(a),s.onaudioprocess=o=>{const u=o.inputBuffer.getChannelData(0);Array.prototype.some.call(u,h=>h===1)?t(!0):t(!1),l.stop(),s.onaudioprocess=null,l.disconnect(s),s.disconnect(n.destination)},l.start()}}),Kn=(n,e)=>{const t=new Map;for(const s of n)for(const a of s){const r=t.get(a);t.set(a,r===void 0?1:r+1)}t.forEach((s,a)=>e(a,s))},pn=n=>"context"in n,uu=n=>{const e=new Map;n.connect=(t=>(s,a=0,r=0)=>{const c=pn(s)?t(s,a,r):t(s,a),l=e.get(s);return l===void 0?e.set(s,[{input:r,output:a}]):l.every(o=>o.input!==r||o.output!==a)&&l.push({input:r,output:a}),c})(n.connect.bind(n)),n.disconnect=(t=>(s,a,r)=>{if(t.apply(n),s===void 0)e.clear();else if(typeof s=="number")for(const[c,l]of e){const o=l.filter(u=>u.output!==s);o.length===0?e.delete(c):e.set(c,o)}else if(e.has(s))if(a===void 0)e.delete(s);else{const c=e.get(s);if(c!==void 0){const l=c.filter(o=>o.output!==a&&(o.input!==r||r===void 0));l.length===0?e.delete(s):e.set(s,l)}}for(const[c,l]of e)l.forEach(o=>{pn(c)?n.connect(c,o.output,o.input):n.connect(c,o.output)})})(n.disconnect)},du=(n,e,t,s)=>{const{activeInputs:a,passiveInputs:r}=Ls(e),{outputs:c}=Be(n),l=Rs(n),o=u=>{const h=pe(n),d=Is(e);if(u){const m=vr(r,n,t);Ma(a,n,m,!1),!s&&!Yt(n)&&h.connect(d,t)}else{const m=lu(a,n,t);Ea(r,m,!1),!s&&!Yt(n)&&h.disconnect(d,t)}};return es(c,[e,t],u=>u[0]===e&&u[1]===t,!0)?(l.add(o),xt(n)?Ma(a,n,[t,o],!0):Ea(r,[n,t,o],!0),!0):!1},hu=(n,e,t,s)=>{const{activeInputs:a,passiveInputs:r}=Be(e),c=fr(a[s],n,t);return c===null?[dr(r,n,t,s)[2],!1]:[c[2],!0]},mu=(n,e,t)=>{const{activeInputs:s,passiveInputs:a}=Ls(e),r=fr(s,n,t);return r===null?[vr(a,n,t)[1],!1]:[r[2],!0]},Si=(n,e,t,s,a)=>{const[r,c]=hu(n,t,s,a);if(r!==null&&(gr(n,r),c&&!e&&!Yt(n)&&mn(pe(n),pe(t),s,a)),xt(t)){const{activeInputs:l}=Be(t);hi(t,l)}},ji=(n,e,t,s)=>{const[a,r]=mu(n,t,s);a!==null&&(gr(n,a),r&&!e&&!Yt(n)&&pe(n).disconnect(Is(t),s))},pu=(n,e)=>{const t=Be(n),s=[];for(const a of t.outputs)Vs(a)?Si(n,e,...a):ji(n,e,...a),s.push(a[0]);return t.outputs.clear(),s},fu=(n,e,t)=>{const s=Be(n),a=[];for(const r of s.outputs)r[1]===t&&(Vs(r)?Si(n,e,...r):ji(n,e,...r),a.push(r[0]),s.outputs.delete(r));return a},gu=(n,e,t,s,a)=>{const r=Be(n);return Array.from(r.outputs).filter(c=>c[0]===t&&(s===void 0||c[1]===s)&&(a===void 0||c[2]===a)).map(c=>(Vs(c)?Si(n,e,...c):ji(n,e,...c),r.outputs.delete(c),c[0]))},vu=(n,e,t,s,a,r,c,l,o,u,h,d,m,f,p,g)=>class extends u{constructor(_,S,C,I){super(C),this._context=_,this._nativeAudioNode=C;const b=h(_);d(b)&&t(Ia,()=>Ia(b,g))!==!0&&uu(C),xi.set(this,C),lr.set(this,new Set),_.state!=="closed"&&S&&ms(this),n(this,I,C)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(_){this._nativeAudioNode.channelCount=_}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(_){this._nativeAudioNode.channelCountMode=_}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(_){this._nativeAudioNode.channelInterpretation=_}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(_,S=0,C=0){if(S<0||S>=this._nativeAudioNode.numberOfOutputs)throw a();const I=h(this._context),b=p(I);if(m(_)||f(_))throw r();if(dn(_)){const v=pe(_);try{const M=hn(this._nativeAudioNode,v,S,C),E=sn(this);(b||E)&&this._nativeAudioNode.disconnect(...M),this.context.state!=="closed"&&!E&&sn(_)&&ms(_)}catch(M){throw M.code===12?r():M}if(e(this,_,S,C,b)){const M=o([this],_);Kn(M,s(b))}return _}const N=Is(_);if(N.name==="playbackRate"&&N.maxValue===1024)throw c();try{this._nativeAudioNode.connect(N,S),(b||sn(this))&&this._nativeAudioNode.disconnect(N,S)}catch(v){throw v.code===12?r():v}if(du(this,_,S,b)){const v=o([this],_);Kn(v,s(b))}}disconnect(_,S,C){let I;const b=h(this._context),N=p(b);if(_===void 0)I=pu(this,N);else if(typeof _=="number"){if(_<0||_>=this.numberOfOutputs)throw a();I=fu(this,N,_)}else{if(S!==void 0&&(S<0||S>=this.numberOfOutputs)||dn(_)&&C!==void 0&&(C<0||C>=_.numberOfInputs))throw a();if(I=gu(this,N,_,S,C),I.length===0)throw r()}for(const j of I){const v=o([this],j);Kn(v,l)}}},yu=(n,e,t,s,a,r,c,l,o,u,h,d,m)=>(f,p,g,y=null,_=null)=>{const S=g.value,C=new Cl(S),I=p?s(C):null,b={get defaultValue(){return S},get maxValue(){return y===null?g.maxValue:y},get minValue(){return _===null?g.minValue:_},get value(){return g.value},set value(N){g.value=N,b.setValueAtTime(N,f.context.currentTime)},cancelAndHoldAtTime(N){if(typeof g.cancelAndHoldAtTime=="function")I===null&&C.flush(f.context.currentTime),C.add(a(N)),g.cancelAndHoldAtTime(N);else{const j=Array.from(C).pop();I===null&&C.flush(f.context.currentTime),C.add(a(N));const v=Array.from(C).pop();g.cancelScheduledValues(N),j!==v&&v!==void 0&&(v.type==="exponentialRampToValue"?g.exponentialRampToValueAtTime(v.value,v.endTime):v.type==="linearRampToValue"?g.linearRampToValueAtTime(v.value,v.endTime):v.type==="setValue"?g.setValueAtTime(v.value,v.startTime):v.type==="setValueCurve"&&g.setValueCurveAtTime(v.values,v.startTime,v.duration))}return b},cancelScheduledValues(N){return I===null&&C.flush(f.context.currentTime),C.add(r(N)),g.cancelScheduledValues(N),b},exponentialRampToValueAtTime(N,j){if(N===0)throw new RangeError;if(!Number.isFinite(j)||j<0)throw new RangeError;const v=f.context.currentTime;return I===null&&C.flush(v),Array.from(C).length===0&&(C.add(u(S,v)),g.setValueAtTime(S,v)),C.add(c(N,j)),g.exponentialRampToValueAtTime(N,j),b},linearRampToValueAtTime(N,j){const v=f.context.currentTime;return I===null&&C.flush(v),Array.from(C).length===0&&(C.add(u(S,v)),g.setValueAtTime(S,v)),C.add(l(N,j)),g.linearRampToValueAtTime(N,j),b},setTargetAtTime(N,j,v){return I===null&&C.flush(f.context.currentTime),C.add(o(N,j,v)),g.setTargetAtTime(N,j,v),b},setValueAtTime(N,j){return I===null&&C.flush(f.context.currentTime),C.add(u(N,j)),g.setValueAtTime(N,j),b},setValueCurveAtTime(N,j,v){const x=N instanceof Float32Array?N:new Float32Array(N);if(d!==null&&d.name==="webkitAudioContext"){const M=j+v,E=f.context.sampleRate,D=Math.ceil(j*E),R=Math.floor(M*E),T=R-D,F=new Float32Array(T);for(let L=0;L<T;L+=1){const B=(x.length-1)/v*((D+L)/E-j),G=Math.floor(B),X=Math.ceil(B);F[L]=G===X?x[G]:(1-(B-G))*x[G]+(1-(X-B))*x[X]}I===null&&C.flush(f.context.currentTime),C.add(h(F,j,v)),g.setValueCurveAtTime(F,j,v);const q=R/E;q<M&&m(b,F[F.length-1],q),m(b,x[x.length-1],M)}else I===null&&C.flush(f.context.currentTime),C.add(h(x,j,v)),g.setValueCurveAtTime(x,j,v);return b}};return t.set(b,g),e.set(b,f),n(b,I),b},_u=n=>({replay(e){for(const t of n)if(t.type==="exponentialRampToValue"){const{endTime:s,value:a}=t;e.exponentialRampToValueAtTime(a,s)}else if(t.type==="linearRampToValue"){const{endTime:s,value:a}=t;e.linearRampToValueAtTime(a,s)}else if(t.type==="setTarget"){const{startTime:s,target:a,timeConstant:r}=t;e.setTargetAtTime(a,s,r)}else if(t.type==="setValue"){const{startTime:s,value:a}=t;e.setValueAtTime(a,s)}else if(t.type==="setValueCurve"){const{duration:s,startTime:a,values:r}=t;e.setValueCurveAtTime(r,a,s)}else throw new Error("Can't apply an unknown automation.")}});class yr{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((s,a)=>e.call(t,s,a,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const bu={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},xu=(n,e,t,s,a,r,c,l,o,u,h,d,m,f)=>class extends e{constructor(g,y,_){var S;const C=l(g),I=o(C),b=h({...bu,..._});m(b);const N=ui.get(C),j=N?.get(y),v=I||C.state!=="closed"?C:(S=c(C))!==null&&S!==void 0?S:C,x=a(v,I?null:g.baseLatency,u,y,j,b),M=I?s(y,b,j):null;super(g,!0,x,M);const E=[];x.parameters.forEach((R,T)=>{const F=t(this,I,R);E.push([T,F])}),this._nativeAudioWorkletNode=x,this._onprocessorerror=null,this._parameters=new yr(E),I&&n(C,this);const{activeInputs:D}=r(this);d(x,D)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(g){const y=typeof g=="function"?f(this,g):null;this._nativeAudioWorkletNode.onprocessorerror=y;const _=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=_!==null&&_===y?g:_}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function fn(n,e,t,s,a){if(typeof n.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),n.copyFromChannel(e[t],s,a);else{const r=n.getChannelData(s);if(e[t].byteLength===0)e[t]=r.slice(a,a+128);else{const c=new Float32Array(r.buffer,a*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(c)}}}const _r=(n,e,t,s,a)=>{typeof n.copyToChannel=="function"?e[t].byteLength!==0&&n.copyToChannel(e[t],s,a):e[t].byteLength!==0&&n.getChannelData(s).set(e[t],a)},gn=(n,e)=>{const t=[];for(let s=0;s<n;s+=1){const a=[],r=typeof e=="number"?e:e[s];for(let c=0;c<r;c+=1)a.push(new Float32Array(128));t.push(a)}return t},wu=(n,e)=>{const t=at(di,n),s=pe(e);return at(t,s)},Nu=async(n,e,t,s,a,r,c)=>{const l=e===null?Math.ceil(n.context.length/128)*128:e.length,o=s.channelCount*s.numberOfInputs,u=a.reduce((y,_)=>y+_,0),h=u===0?null:t.createBuffer(u,l,t.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const d=Be(n),m=await wu(t,n),f=gn(s.numberOfInputs,s.channelCount),p=gn(s.numberOfOutputs,a),g=Array.from(n.parameters.keys()).reduce((y,_)=>({...y,[_]:new Float32Array(128)}),{});for(let y=0;y<l;y+=128){if(s.numberOfInputs>0&&e!==null)for(let _=0;_<s.numberOfInputs;_+=1)for(let S=0;S<s.channelCount;S+=1)fn(e,f[_],S,S,y);r.parameterDescriptors!==void 0&&e!==null&&r.parameterDescriptors.forEach(({name:_},S)=>{fn(e,g,_,o+S,y)});for(let _=0;_<s.numberOfInputs;_+=1)for(let S=0;S<a[_];S+=1)p[_][S].byteLength===0&&(p[_][S]=new Float32Array(128));try{const _=f.map((C,I)=>d.activeInputs[I].size===0?[]:C),S=c(y/t.sampleRate,t.sampleRate,()=>m.process(_,p,g));if(h!==null)for(let C=0,I=0;C<s.numberOfOutputs;C+=1){for(let b=0;b<a[C];b+=1)_r(h,p[C],b,I+b,y);I+=a[C]}if(!S)break}catch(_){n.dispatchEvent(new ErrorEvent("processorerror",{colno:_.colno,filename:_.filename,lineno:_.lineno,message:_.message}));break}}return h},Su=(n,e,t,s,a,r,c,l,o,u,h,d,m,f,p,g)=>(y,_,S)=>{const C=new WeakMap;let I=null;const b=async(N,j)=>{let v=h(N),x=null;const M=Ve(v,j),E=Array.isArray(_.outputChannelCount)?_.outputChannelCount:Array.from(_.outputChannelCount);if(d===null){const D=E.reduce((q,L)=>q+L,0),R=a(j,{channelCount:Math.max(1,D),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,D)}),T=[];for(let q=0;q<N.numberOfOutputs;q+=1)T.push(s(j,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:E[q]}));const F=c(j,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1});F.connect=e.bind(null,T),F.disconnect=o.bind(null,T),x=[R,T,F]}else M||(v=new d(j,y));if(C.set(j,x===null?v:x[2]),x!==null){if(I===null){if(S===void 0)throw new Error("Missing the processor constructor.");if(m===null)throw new Error("Missing the native OfflineAudioContext constructor.");const L=N.channelCount*N.numberOfInputs,B=S.parameterDescriptors===void 0?0:S.parameterDescriptors.length,G=L+B;I=Nu(N,G===0?null:await(async()=>{const H=new m(G,Math.ceil(N.context.length/128)*128,j.sampleRate),K=[],$=[];for(let k=0;k<_.numberOfInputs;k+=1)K.push(c(H,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1})),$.push(a(H,{channelCount:_.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:_.channelCount}));const Q=await Promise.all(Array.from(N.parameters.values()).map(async k=>{const P=r(H,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:k.value});return await f(H,k,P.offset),P})),O=s(H,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,L+B)});for(let k=0;k<_.numberOfInputs;k+=1){K[k].connect($[k]);for(let P=0;P<_.channelCount;P+=1)$[k].connect(O,P,k*_.channelCount+P)}for(const[k,P]of Q.entries())P.connect(O,0,L+k),P.start(0);return O.connect(H.destination),await Promise.all(K.map(k=>p(N,H,k))),g(H)})(),j,_,E,S,u)}const D=await I,R=t(j,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[T,F,q]=x;D!==null&&(R.buffer=D,R.start(0)),R.connect(T);for(let L=0,B=0;L<N.numberOfOutputs;L+=1){const G=F[L];for(let X=0;X<E[L];X+=1)T.connect(G,B+X,X);B+=E[L]}return q}if(M)for(const[D,R]of N.parameters.entries())await n(j,R,v.parameters.get(D));else for(const[D,R]of N.parameters.entries())await f(j,R,v.parameters.get(D));return await p(N,j,v),v};return{render(N,j){l(j,N);const v=C.get(j);return v!==void 0?Promise.resolve(v):b(N,j)}}},ju=(n,e,t,s,a,r,c,l,o,u,h,d,m,f,p,g,y,_,S,C)=>class extends p{constructor(b,N){super(b,N),this._nativeContext=b,this._audioWorklet=n===void 0?void 0:{addModule:(j,v)=>n(this,j,v)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new a(this)}createBuffer(b,N,j){return new t({length:N,numberOfChannels:b,sampleRate:j})}createBufferSource(){return new s(this)}createChannelMerger(b=6){return new r(this,{numberOfInputs:b})}createChannelSplitter(b=6){return new c(this,{numberOfOutputs:b})}createConstantSource(){return new l(this)}createConvolver(){return new o(this)}createDelay(b=1){return new h(this,{maxDelayTime:b})}createDynamicsCompressor(){return new d(this)}createGain(){return new m(this)}createIIRFilter(b,N){return new f(this,{feedback:N,feedforward:b})}createOscillator(){return new g(this)}createPanner(){return new y(this)}createPeriodicWave(b,N,j={disableNormalization:!1}){return new _(this,{...j,imag:N,real:b})}createStereoPanner(){return new S(this)}createWaveShaper(){return new C(this)}decodeAudioData(b,N,j){return u(this._nativeContext,b).then(v=>(typeof N=="function"&&N(v),v),v=>{throw typeof j=="function"&&j(v),v})}},Tu={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},ku=(n,e,t,s,a,r,c,l)=>class extends n{constructor(u,h){const d=r(u),m={...Tu,...h},f=a(d,m),p=c(d),g=p?t():null;super(u,!1,f,g),this._Q=e(this,p,f.Q,We,Ge),this._detune=e(this,p,f.detune,1200*Math.log2(We),-1200*Math.log2(We)),this._frequency=e(this,p,f.frequency,u.sampleRate/2,0),this._gain=e(this,p,f.gain,40*Math.log10(We),Ge),this._nativeBiquadFilterNode=f,l(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,h,d){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,h,d)}catch(m){throw m.code===11?s():m}if(u.length!==h.length||h.length!==d.length)throw s()}},Cu=(n,e,t,s,a)=>()=>{const r=new WeakMap,c=async(l,o)=>{let u=t(l);const h=Ve(u,o);if(!h){const d={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(o,d)}return r.set(o,u),h?(await n(o,l.Q,u.Q),await n(o,l.detune,u.detune),await n(o,l.frequency,u.frequency),await n(o,l.gain,u.gain)):(await s(o,l.Q,u.Q),await s(o,l.detune,u.detune),await s(o,l.frequency,u.frequency),await s(o,l.gain,u.gain)),await a(l,o,u),u};return{render(l,o){const u=r.get(o);return u!==void 0?Promise.resolve(u):c(l,o)}}},Au=(n,e)=>(t,s)=>{const a=e.get(t);if(a!==void 0)return a;const r=n.get(t);if(r!==void 0)return r;try{const c=s();return c instanceof Promise?(n.set(t,c),c.catch(()=>!1).then(l=>(n.delete(t),e.set(t,l),l))):(e.set(t,c),c)}catch{return e.set(t,!1),!1}},Mu={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Eu=(n,e,t,s,a)=>class extends n{constructor(c,l){const o=s(c),u={...Mu,...l},h=t(o,u),d=a(o)?e():null;super(c,!1,h,d)}},Iu=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,c)=>{let l=e(r);if(!Ve(l,c)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfInputs:l.numberOfInputs};l=n(c,u)}return s.set(c,l),await t(r,c,l),l};return{render(r,c){const l=s.get(c);return l!==void 0?Promise.resolve(l):a(r,c)}}},Du={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Pu=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=s(l),h=r({...Du,...o}),d=t(u,h),m=a(u)?e():null;super(l,!1,d,m)}},Ou=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,c)=>{let l=e(r);if(!Ve(l,c)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfOutputs:l.numberOfOutputs};l=n(c,u)}return s.set(c,l),await t(r,c,l),l};return{render(r,c){const l=s.get(c);return l!==void 0?Promise.resolve(l):a(r,c)}}},Ru=n=>(e,t,s)=>n(t,e,s),Fu=n=>(e,t,s=0,a=0)=>{const r=e[s];if(r===void 0)throw n();return pn(t)?r.connect(t,0,a):r.connect(t,0)},Lu=n=>(e,t)=>{const s=n(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),a=e.createBuffer(1,2,44100);return s.buffer=a,s.loop=!0,s.connect(t),s.start(),()=>{s.stop(),s.disconnect(t)}},Vu={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},qu=(n,e,t,s,a,r,c)=>class extends n{constructor(o,u){const h=a(o),d={...Vu,...u},m=s(h,d),f=r(h),p=f?t():null;super(o,!1,m,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=m,this._offset=e(this,f,m.offset,We,Ge),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(o){const u=typeof o=="function"?c(this,o):null;this._nativeConstantSourceNode.onended=u;const h=this._nativeConstantSourceNode.onended;this._onended=h!==null&&h===u?o:h}start(o=0){if(this._nativeConstantSourceNode.start(o),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=o),this.context.state!=="closed"){ms(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),xt(this)&&Fs(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(o=0){this._nativeConstantSourceNode.stop(o),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=o)}},Wu=(n,e,t,s,a)=>()=>{const r=new WeakMap;let c=null,l=null;const o=async(u,h)=>{let d=t(u);const m=Ve(d,h);if(!m){const f={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,offset:d.offset.value};d=e(h,f),c!==null&&d.start(c),l!==null&&d.stop(l)}return r.set(h,d),m?await n(h,u.offset,d.offset):await s(h,u.offset,d.offset),await a(u,h,d),d};return{set start(u){c=u},set stop(u){l=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):o(u,h)}}},Bu=n=>e=>(n[0]=e,n[0]),Uu={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},$u=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=s(l),h={...Uu,...o},d=t(u,h),f=a(u)?e():null;super(l,!1,d,f),this._isBufferNullified=!1,this._nativeConvolverNode=d,h.buffer!==null&&r(this,h.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(l){if(this._nativeConvolverNode.buffer=l,l===null&&this._nativeConvolverNode.buffer!==null){const o=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=o.createBuffer(1,1,o.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(l){this._nativeConvolverNode.normalize=l}},Gu=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,c)=>{let l=e(r);if(!Ve(l,c)){const u={buffer:l.buffer,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,disableNormalization:!l.normalize};l=n(c,u)}return s.set(c,l),xs(l)?await t(r,c,l.inputs[0]):await t(r,c,l),l};return{render(r,c){const l=s.get(c);return l!==void 0?Promise.resolve(l):a(r,c)}}},zu=(n,e)=>(t,s,a)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,s,a)}catch(r){throw r.name==="SyntaxError"?n():r}},Yu=()=>new DOMException("","DataCloneError"),Da=n=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(s=>{const a=()=>{t.onmessage=null,e.close(),t.close(),s()};t.onmessage=()=>a();try{e.postMessage(n,[n])}catch{}finally{a()}})},Xu=(n,e,t,s,a,r,c,l,o,u,h)=>(d,m)=>{const f=c(d)?d:r(d);if(a.has(m)){const p=t();return Promise.reject(p)}try{a.add(m)}catch{}return e(o,()=>o(f))?f.decodeAudioData(m).then(p=>(Da(m).catch(()=>{}),e(l,()=>l(p))||h(p),n.add(p),p)):new Promise((p,g)=>{const y=async()=>{try{await Da(m)}catch{}},_=S=>{g(S),y()};try{f.decodeAudioData(m,S=>{typeof S.copyFromChannel!="function"&&(u(S),Ni(S)),n.add(S),y().then(()=>p(S))},S=>{_(S===null?s():S)})}catch(S){_(S)}})},Hu=(n,e,t,s,a,r,c,l)=>(o,u)=>{const h=e.get(o);if(h===void 0)throw new Error("Missing the expected cycle count.");const d=r(o.context),m=l(d);if(h===u){if(e.delete(o),!m&&c(o)){const f=s(o),{outputs:p}=t(o);for(const g of p)if(Vs(g)){const y=s(g[0]);n(f,y,g[1],g[2])}else{const y=a(g[0]);f.connect(y,g[1])}}}else e.set(o,h-u)},Ju={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Zu=(n,e,t,s,a,r,c)=>class extends n{constructor(o,u){const h=a(o),d={...Ju,...u},m=s(h,d),f=r(h),p=f?t(d.maxDelayTime):null;super(o,!1,m,p),this._delayTime=e(this,f,m.delayTime),c(this,d.maxDelayTime)}get delayTime(){return this._delayTime}},Ku=(n,e,t,s,a)=>r=>{const c=new WeakMap,l=async(o,u)=>{let h=t(o);const d=Ve(h,u);if(!d){const m={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,delayTime:h.delayTime.value,maxDelayTime:r};h=e(u,m)}return c.set(u,h),d?await n(u,o.delayTime,h.delayTime):await s(u,o.delayTime,h.delayTime),await a(o,u,h),h};return{render(o,u){const h=c.get(u);return h!==void 0?Promise.resolve(h):l(o,u)}}},Qu=n=>(e,t,s,a)=>n(e[a],r=>r[0]===t&&r[1]===s),ed=n=>(e,t)=>{n(e).delete(t)},td=n=>"delayTime"in n,sd=(n,e,t)=>function s(a,r){const c=dn(r)?r:t(n,r);if(td(c))return[];if(a[0]===c)return[a];if(a.includes(c))return[];const{outputs:l}=e(c);return Array.from(l).map(o=>s([...a,c],o[0])).reduce((o,u)=>o.concat(u),[])},Zs=(n,e,t)=>{const s=e[t];if(s===void 0)throw n();return s},nd=n=>(e,t=void 0,s=void 0,a=0)=>t===void 0?e.forEach(r=>r.disconnect()):typeof t=="number"?Zs(n,e,t).disconnect():pn(t)?s===void 0?e.forEach(r=>r.disconnect(t)):a===void 0?Zs(n,e,s).disconnect(t,0):Zs(n,e,s).disconnect(t,0,a):s===void 0?e.forEach(r=>r.disconnect(t)):Zs(n,e,s).disconnect(t,0),id={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},ad=(n,e,t,s,a,r,c,l)=>class extends n{constructor(u,h){const d=r(u),m={...id,...h},f=s(d,m),p=c(d),g=p?t():null;super(u,!1,f,g),this._attack=e(this,p,f.attack),this._knee=e(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,p,f.ratio),this._release=e(this,p,f.release),this._threshold=e(this,p,f.threshold),l(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const h=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=h,a()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const h=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=h,a()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},rd=(n,e,t,s,a)=>()=>{const r=new WeakMap,c=async(l,o)=>{let u=t(l);const h=Ve(u,o);if(!h){const d={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(o,d)}return r.set(o,u),h?(await n(o,l.attack,u.attack),await n(o,l.knee,u.knee),await n(o,l.ratio,u.ratio),await n(o,l.release,u.release),await n(o,l.threshold,u.threshold)):(await s(o,l.attack,u.attack),await s(o,l.knee,u.knee),await s(o,l.ratio,u.ratio),await s(o,l.release,u.release),await s(o,l.threshold,u.threshold)),await a(l,o,u),u};return{render(l,o){const u=r.get(o);return u!==void 0?Promise.resolve(u):c(l,o)}}},od=()=>new DOMException("","EncodingError"),cd=n=>e=>new Promise((t,s)=>{if(n===null){s(new SyntaxError);return}const a=n.document.head;if(a===null)s(new SyntaxError);else{const r=n.document.createElement("script"),c=new Blob([e],{type:"application/javascript"}),l=URL.createObjectURL(c),o=n.onerror,u=()=>{n.onerror=o,URL.revokeObjectURL(l)};n.onerror=(h,d,m,f,p)=>{if(d===l||d===n.location.href&&m===1&&f===1)return u(),s(p),!1;if(o!==null)return o(h,d,m,f,p)},r.onerror=()=>{u(),s(new SyntaxError)},r.onload=()=>{u(),t()},r.src=l,r.type="module",a.appendChild(r)}}),ld=n=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,s,a){if(s!==null){let r=this._listeners.get(s);r===void 0&&(r=n(this,s),typeof s=="function"&&this._listeners.set(s,r)),this._nativeEventTarget.addEventListener(t,r,a)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,s,a){const r=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(t,r===void 0?null:r,a)}},ud=n=>(e,t,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},dd=n=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw n()},hd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},md=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=a(l),h={...hd,...o},d=s(u,h),m=r(u),f=m?t():null;super(l,!1,d,f),this._gain=e(this,m,d.gain,We,Ge)}get gain(){return this._gain}},pd=(n,e,t,s,a)=>()=>{const r=new WeakMap,c=async(l,o)=>{let u=t(l);const h=Ve(u,o);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(o,d)}return r.set(o,u),h?await n(o,l.gain,u.gain):await s(o,l.gain,u.gain),await a(l,o,u),u};return{render(l,o){const u=r.get(o);return u!==void 0?Promise.resolve(u):c(l,o)}}},fd=(n,e)=>t=>e(n,t),gd=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},vd=n=>e=>{var t;return(t=n.get(e))!==null&&t!==void 0?t:0},yd=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},_d=n=>e=>n.get(e),Pe=()=>new DOMException("","InvalidStateError"),bd=n=>e=>{const t=n.get(e);if(t===void 0)throw Pe();return t},xd=(n,e)=>t=>{let s=n.get(t);if(s!==void 0)return s;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new e(1,1,44100),n.set(t,s),s},wd=n=>e=>{const t=n.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},Sn=()=>new DOMException("","InvalidAccessError"),Nd=n=>{n.getFrequencyResponse=(e=>(t,s,a)=>{if(t.length!==s.length||s.length!==a.length)throw Sn();return e.call(n,t,s,a)})(n.getFrequencyResponse)},Sd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},jd=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=s(l),h=a(u),d={...Sd,...o},m=e(u,h?null:l.baseLatency,d),f=h?t(d.feedback,d.feedforward):null;super(l,!1,m,f),Nd(m),this._nativeIIRFilterNode=m,r(this,1)}getFrequencyResponse(l,o,u){return this._nativeIIRFilterNode.getFrequencyResponse(l,o,u)}},br=(n,e,t,s,a,r,c,l,o,u,h)=>{const d=u.length;let m=l;for(let f=0;f<d;f+=1){let p=t[0]*u[f];for(let g=1;g<a;g+=1){const y=m-g&o-1;p+=t[g]*r[y],p-=n[g]*c[y]}for(let g=a;g<s;g+=1)p+=t[g]*r[m-g&o-1];for(let g=a;g<e;g+=1)p-=n[g]*c[m-g&o-1];r[m]=u[f],c[m]=p,m=m+1&o-1,h[f]=p}return m},Td=(n,e,t,s)=>{const a=t instanceof Float64Array?t:new Float64Array(t),r=s instanceof Float64Array?s:new Float64Array(s),c=a.length,l=r.length,o=Math.min(c,l);if(a[0]!==1){for(let p=0;p<c;p+=1)r[p]/=a[0];for(let p=1;p<l;p+=1)a[p]/=a[0]}const u=32,h=new Float32Array(u),d=new Float32Array(u),m=e.createBuffer(n.numberOfChannels,n.length,n.sampleRate),f=n.numberOfChannels;for(let p=0;p<f;p+=1){const g=n.getChannelData(p),y=m.getChannelData(p);h.fill(0),d.fill(0),br(a,c,r,l,o,h,d,0,u,g,y)}return m},kd=(n,e,t,s,a)=>(r,c)=>{const l=new WeakMap;let o=null;const u=async(h,d)=>{let m=null,f=e(h);const p=Ve(f,d);if(d.createIIRFilter===void 0?m=n(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=d.createIIRFilter(c,r)),l.set(d,m===null?f:m),m!==null){if(o===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const y=new t(h.context.destination.channelCount,h.context.length,d.sampleRate);o=(async()=>{await s(h,y,y.destination);const _=await a(y);return Td(_,d,r,c)})()}const g=await o;return m.buffer=g,m.start(0),m}return await s(h,d,f),f};return{render(h,d){const m=l.get(d);return m!==void 0?Promise.resolve(m):u(h,d)}}},Cd=(n,e,t,s,a,r)=>c=>(l,o)=>{const u=n.get(l);if(u===void 0){if(!c&&r(l)){const h=s(l),{outputs:d}=t(l);for(const m of d)if(Vs(m)){const f=s(m[0]);e(h,f,m[1],m[2])}else{const f=a(m[0]);h.disconnect(f,m[1])}}n.set(l,o)}else n.set(l,u+o)},Ad=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Md=(n,e)=>t=>n.has(t)||e(t),Ed=(n,e)=>t=>n.has(t)||e(t),Id=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Dd=n=>e=>n!==null&&e instanceof n,Pd=n=>e=>n!==null&&typeof n.AudioNode=="function"&&e instanceof n.AudioNode,Od=n=>e=>n!==null&&typeof n.AudioParam=="function"&&e instanceof n.AudioParam,Rd=(n,e)=>t=>n(t)||e(t),Fd=n=>e=>n!==null&&e instanceof n,Ld=n=>n!==null&&n.isSecureContext,Vd=(n,e,t,s)=>class extends n{constructor(r,c){const l=t(r),o=e(l,c);if(s(l))throw TypeError();super(r,!0,o,null),this._nativeMediaElementAudioSourceNode=o}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},qd={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Wd=(n,e,t,s)=>class extends n{constructor(r,c){const l=t(r);if(s(l))throw new TypeError;const o={...qd,...c},u=e(l,o);super(r,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},Bd=(n,e,t,s)=>class extends n{constructor(r,c){const l=t(r),o=e(l,c);if(s(l))throw new TypeError;super(r,!0,o,null),this._nativeMediaStreamAudioSourceNode=o}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},Ud=(n,e,t)=>class extends n{constructor(a,r){const c=t(a),l=e(c,r);super(a,!0,l,null)}},$d=(n,e,t,s,a,r)=>class extends t{constructor(l,o){super(l),this._nativeContext=l,wn.set(this,l),s(l)&&a.set(l,new Set),this._destination=new n(this,o),this._listener=e(this,l),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(l){const o=typeof l=="function"?r(this,l):null;this._nativeContext.onstatechange=o;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===o?l:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},Ds=n=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=n.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},Gd=(n,e)=>(t,s,a)=>{const r=new Set;return t.connect=(c=>(l,o=0,u=0)=>{const h=r.size===0;if(e(l))return c.call(t,l,o,u),n(r,[l,o,u],d=>d[0]===l&&d[1]===o&&d[2]===u,!0),h&&s(),l;c.call(t,l,o),n(r,[l,o],d=>d[0]===l&&d[1]===o,!0),h&&s()})(t.connect),t.disconnect=(c=>(l,o,u)=>{const h=r.size>0;if(l===void 0)c.apply(t),r.clear();else if(typeof l=="number"){c.call(t,l);for(const m of r)m[1]===l&&r.delete(m)}else{e(l)?c.call(t,l,o,u):c.call(t,l,o);for(const m of r)m[0]===l&&(o===void 0||m[1]===o)&&(u===void 0||m[2]===u)&&r.delete(m)}const d=r.size===0;h&&d&&a()})(t.disconnect),t},ye=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t]&&(n[t]=s)},Ie=(n,e)=>{ye(n,e,"channelCount"),ye(n,e,"channelCountMode"),ye(n,e,"channelInterpretation")},Pa=n=>typeof n.getFloatTimeDomainData=="function",zd=n=>{n.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);n.getByteTimeDomainData(t);const s=Math.max(t.length,n.fftSize);for(let a=0;a<s;a+=1)e[a]=(t[a]-128)*.0078125;return e}},Yd=(n,e)=>(t,s)=>{const a=t.createAnalyser();if(Ie(a,s),!(s.maxDecibels>s.minDecibels))throw e();return ye(a,s,"fftSize"),ye(a,s,"maxDecibels"),ye(a,s,"minDecibels"),ye(a,s,"smoothingTimeConstant"),n(Pa,()=>Pa(a))||zd(a),a},Xd=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,we=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t].value&&(n[t].value=s)},Hd=n=>{n.start=(e=>{let t=!1;return(s=0,a=0,r)=>{if(t)throw Pe();e.call(n,s,a,r),t=!0}})(n.start)},Ti=n=>{n.start=(e=>(t=0,s=0,a)=>{if(typeof a=="number"&&a<0||s<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(n,t,s,a)})(n.start)},ki=n=>{n.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(n,t)})(n.stop)},Jd=(n,e,t,s,a,r,c,l,o,u,h)=>(d,m)=>{const f=d.createBufferSource();return Ie(f,m),we(f,m,"playbackRate"),ye(f,m,"buffer"),ye(f,m,"loop"),ye(f,m,"loopEnd"),ye(f,m,"loopStart"),e(t,()=>t(d))||Hd(f),e(s,()=>s(d))||o(f),e(a,()=>a(d))||u(f,d),e(r,()=>r(d))||Ti(f),e(c,()=>c(d))||h(f,d),e(l,()=>l(d))||ki(f),n(d,f),f},Zd=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,Kd=(n,e)=>(t,s,a)=>{const r=t.destination;if(r.channelCount!==s)try{r.channelCount=s}catch{}a&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:s});const c=n(t,{channelCount:s,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return e(c,"channelCount",l=>()=>l.call(c),l=>o=>{l.call(c,o);try{r.channelCount=o}catch(u){if(o>r.maxChannelCount)throw u}}),e(c,"channelCountMode",l=>()=>l.call(c),l=>o=>{l.call(c,o),r.channelCountMode=o}),e(c,"channelInterpretation",l=>()=>l.call(c),l=>o=>{l.call(c,o),r.channelInterpretation=o}),Object.defineProperty(c,"maxChannelCount",{get:()=>r.maxChannelCount}),c.connect(r),c},Qd=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,eh=n=>{const{port1:e}=new MessageChannel;try{e.postMessage(n)}finally{e.close()}},th=(n,e,t,s,a)=>(r,c,l,o,u,h)=>{if(l!==null)try{const d=new l(r,o,h),m=new Map;let f=null;if(Object.defineProperties(d,{channelCount:{get:()=>h.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&d.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&d.addEventListener("processorerror",f)}}}),d.addEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const y=typeof g[1]=="function"?g[1]:typeof g[1]=="object"&&g[1]!==null&&typeof g[1].handleEvent=="function"?g[1].handleEvent:null;if(y!==null){const _=m.get(g[1]);_!==void 0?g[1]=_:(g[1]=S=>{S.type==="error"?(Object.defineProperties(S,{type:{value:"processorerror"}}),y(S)):y(new ErrorEvent(g[0],{...S}))},m.set(y,g[1]))}}return p.call(d,"error",g[1],g[2]),p.call(d,...g)})(d.addEventListener),d.removeEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const y=m.get(g[1]);y!==void 0&&(m.delete(g[1]),g[1]=y)}return p.call(d,"error",g[1],g[2]),p.call(d,g[0],g[1],g[2])})(d.removeEventListener),h.numberOfOutputs!==0){const p=t(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return d.connect(p).connect(r.destination),a(d,()=>p.disconnect(),()=>p.connect(r.destination))}return d}catch(d){throw d.code===11?s():d}if(u===void 0)throw s();return eh(h),e(r,c,u,h)},xr=(n,e)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*e))))),sh=n=>new Promise((e,t)=>{const{port1:s,port2:a}=new MessageChannel;s.onmessage=({data:r})=>{s.close(),a.close(),e(r)},s.onmessageerror=({data:r})=>{s.close(),a.close(),t(r)},a.postMessage(n)}),nh=async(n,e)=>{const t=await sh(e);return new n(t)},ih=(n,e,t,s)=>{let a=di.get(n);a===void 0&&(a=new WeakMap,di.set(n,a));const r=nh(t,s);return a.set(e,r),r},ah=(n,e,t,s,a,r,c,l,o,u,h,d,m)=>(f,p,g,y)=>{if(y.numberOfInputs===0&&y.numberOfOutputs===0)throw o();const _=Array.isArray(y.outputChannelCount)?y.outputChannelCount:Array.from(y.outputChannelCount);if(_.some(z=>z<1))throw o();if(_.length!==y.numberOfOutputs)throw e();if(y.channelCountMode!=="explicit")throw o();const S=y.channelCount*y.numberOfInputs,C=_.reduce((z,J)=>z+J,0),I=g.parameterDescriptors===void 0?0:g.parameterDescriptors.length;if(S+I>6||C>6)throw o();const b=new MessageChannel,N=[],j=[];for(let z=0;z<y.numberOfInputs;z+=1)N.push(c(f,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1})),j.push(a(f,{channelCount:y.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:y.channelCount}));const v=[];if(g.parameterDescriptors!==void 0)for(const{defaultValue:z,maxValue:J,minValue:ue,name:me}of g.parameterDescriptors){const re=r(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:y.parameterData[me]!==void 0?y.parameterData[me]:z===void 0?0:z});Object.defineProperties(re.offset,{defaultValue:{get:()=>z===void 0?0:z},maxValue:{get:()=>J===void 0?We:J},minValue:{get:()=>ue===void 0?Ge:ue}}),v.push(re)}const x=s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,S+I)}),M=xr(p,f.sampleRate),E=l(f,M,S+I,Math.max(1,C)),D=a(f,{channelCount:Math.max(1,C),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,C)}),R=[];for(let z=0;z<y.numberOfOutputs;z+=1)R.push(s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:_[z]}));for(let z=0;z<y.numberOfInputs;z+=1){N[z].connect(j[z]);for(let J=0;J<y.channelCount;J+=1)j[z].connect(x,J,z*y.channelCount+J)}const T=new yr(g.parameterDescriptors===void 0?[]:g.parameterDescriptors.map(({name:z},J)=>{const ue=v[J];return ue.connect(x,0,S+J),ue.start(0),[z,ue.offset]}));x.connect(E);let F=y.channelInterpretation,q=null;const L=y.numberOfOutputs===0?[E]:R,B={get bufferSize(){return M},get channelCount(){return y.channelCount},set channelCount(z){throw t()},get channelCountMode(){return y.channelCountMode},set channelCountMode(z){throw t()},get channelInterpretation(){return F},set channelInterpretation(z){for(const J of N)J.channelInterpretation=z;F=z},get context(){return E.context},get inputs(){return N},get numberOfInputs(){return y.numberOfInputs},get numberOfOutputs(){return y.numberOfOutputs},get onprocessorerror(){return q},set onprocessorerror(z){typeof q=="function"&&B.removeEventListener("processorerror",q),q=typeof z=="function"?z:null,typeof q=="function"&&B.addEventListener("processorerror",q)},get parameters(){return T},get port(){return b.port2},addEventListener(...z){return E.addEventListener(z[0],z[1],z[2])},connect:n.bind(null,L),disconnect:u.bind(null,L),dispatchEvent(...z){return E.dispatchEvent(z[0])},removeEventListener(...z){return E.removeEventListener(z[0],z[1],z[2])}},G=new Map;b.port1.addEventListener=(z=>(...J)=>{if(J[0]==="message"){const ue=typeof J[1]=="function"?J[1]:typeof J[1]=="object"&&J[1]!==null&&typeof J[1].handleEvent=="function"?J[1].handleEvent:null;if(ue!==null){const me=G.get(J[1]);me!==void 0?J[1]=me:(J[1]=re=>{h(f.currentTime,f.sampleRate,()=>ue(re))},G.set(ue,J[1]))}}return z.call(b.port1,J[0],J[1],J[2])})(b.port1.addEventListener),b.port1.removeEventListener=(z=>(...J)=>{if(J[0]==="message"){const ue=G.get(J[1]);ue!==void 0&&(G.delete(J[1]),J[1]=ue)}return z.call(b.port1,J[0],J[1],J[2])})(b.port1.removeEventListener);let X=null;Object.defineProperty(b.port1,"onmessage",{get:()=>X,set:z=>{typeof X=="function"&&b.port1.removeEventListener("message",X),X=typeof z=="function"?z:null,typeof X=="function"&&(b.port1.addEventListener("message",X),b.port1.start())}}),g.prototype.port=b.port1;let H=null;ih(f,B,g,y).then(z=>H=z);const $=gn(y.numberOfInputs,y.channelCount),Q=gn(y.numberOfOutputs,_),O=g.parameterDescriptors===void 0?[]:g.parameterDescriptors.reduce((z,{name:J})=>({...z,[J]:new Float32Array(128)}),{});let k=!0;const P=()=>{y.numberOfOutputs>0&&E.disconnect(D);for(let z=0,J=0;z<y.numberOfOutputs;z+=1){const ue=R[z];for(let me=0;me<_[z];me+=1)D.disconnect(ue,J+me,me);J+=_[z]}},A=new Map;E.onaudioprocess=({inputBuffer:z,outputBuffer:J})=>{if(H!==null){const ue=d(B);for(let me=0;me<M;me+=128){for(let re=0;re<y.numberOfInputs;re+=1)for(let fe=0;fe<y.channelCount;fe+=1)fn(z,$[re],fe,fe,me);g.parameterDescriptors!==void 0&&g.parameterDescriptors.forEach(({name:re},fe)=>{fn(z,O,re,S+fe,me)});for(let re=0;re<y.numberOfInputs;re+=1)for(let fe=0;fe<_[re];fe+=1)Q[re][fe].byteLength===0&&(Q[re][fe]=new Float32Array(128));try{const re=$.map((qe,ut)=>{if(ue[ut].size>0)return A.set(ut,M/128),qe;const Cs=A.get(ut);return Cs===void 0?[]:(qe.every(st=>st.every(Bn=>Bn===0))&&(Cs===1?A.delete(ut):A.set(ut,Cs-1)),qe)});k=h(f.currentTime+me/f.sampleRate,f.sampleRate,()=>H.process(re,Q,O));for(let qe=0,ut=0;qe<y.numberOfOutputs;qe+=1){for(let Wt=0;Wt<_[qe];Wt+=1)_r(J,Q[qe],Wt,ut+Wt,me);ut+=_[qe]}}catch(re){k=!1,B.dispatchEvent(new ErrorEvent("processorerror",{colno:re.colno,filename:re.filename,lineno:re.lineno,message:re.message}))}if(!k){for(let re=0;re<y.numberOfInputs;re+=1){N[re].disconnect(j[re]);for(let fe=0;fe<y.channelCount;fe+=1)j[me].disconnect(x,fe,re*y.channelCount+fe)}if(g.parameterDescriptors!==void 0){const re=g.parameterDescriptors.length;for(let fe=0;fe<re;fe+=1){const qe=v[fe];qe.disconnect(x,0,S+fe),qe.stop()}}x.disconnect(E),E.onaudioprocess=null,W?P():Te();break}}}};let W=!1;const Z=c(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),ae=()=>E.connect(Z).connect(f.destination),Te=()=>{E.disconnect(Z),Z.disconnect()},lt=()=>{if(k){Te(),y.numberOfOutputs>0&&E.connect(D);for(let z=0,J=0;z<y.numberOfOutputs;z+=1){const ue=R[z];for(let me=0;me<_[z];me+=1)D.connect(ue,J+me,me);J+=_[z]}}W=!0},$e=()=>{k&&(ae(),P()),W=!1};return ae(),m(B,lt,$e)},wr=(n,e)=>{const t=n.createBiquadFilter();return Ie(t,e),we(t,e,"Q"),we(t,e,"detune"),we(t,e,"frequency"),we(t,e,"gain"),ye(t,e,"type"),t},rh=(n,e)=>(t,s)=>{const a=t.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&e(t,a),Ie(a,s),a},oh=n=>{const e=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw Pe()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw Pe()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw Pe()}})},qs=(n,e)=>{const t=n.createChannelSplitter(e.numberOfOutputs);return Ie(t,e),oh(t),t},ch=(n,e,t,s,a)=>(r,c)=>{if(r.createConstantSource===void 0)return t(r,c);const l=r.createConstantSource();return Ie(l,c),we(l,c,"offset"),e(s,()=>s(r))||Ti(l),e(a,()=>a(r))||ki(l),n(r,l),l},ws=(n,e)=>(n.connect=e.connect.bind(e),n.disconnect=e.disconnect.bind(e),n),lh=(n,e,t,s)=>(a,{offset:r,...c})=>{const l=a.createBuffer(1,2,44100),o=e(a,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(a,{...c,gain:r}),h=l.getChannelData(0);h[0]=1,h[1]=1,o.buffer=l,o.loop=!0;const d={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(p){u.channelCount=p},get channelCountMode(){return u.channelCountMode},set channelCountMode(p){u.channelCountMode=p},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(p){u.channelInterpretation=p},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return o.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return o.onended},set onended(p){o.onended=p},addEventListener(...p){return o.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return o.dispatchEvent(p[0])},removeEventListener(...p){return o.removeEventListener(p[0],p[1],p[2])},start(p=0){o.start.call(o,p)},stop(p=0){o.stop.call(o,p)}},m=()=>o.connect(u),f=()=>o.disconnect(u);return n(a,o),s(ws(d,u),m,f)},uh=(n,e)=>(t,s)=>{const a=t.createConvolver();if(Ie(a,s),s.disableNormalization===a.normalize&&(a.normalize=!s.disableNormalization),ye(a,s,"buffer"),s.channelCount>2||(e(a,"channelCount",r=>()=>r.call(a),r=>c=>{if(c>2)throw n();return r.call(a,c)}),s.channelCountMode==="max"))throw n();return e(a,"channelCountMode",r=>()=>r.call(a),r=>c=>{if(c==="max")throw n();return r.call(a,c)}),a},Nr=(n,e)=>{const t=n.createDelay(e.maxDelayTime);return Ie(t,e),we(t,e,"delayTime"),t},dh=n=>(e,t)=>{const s=e.createDynamicsCompressor();if(Ie(s,t),t.channelCount>2||t.channelCountMode==="max")throw n();return we(s,t,"attack"),we(s,t,"knee"),we(s,t,"ratio"),we(s,t,"release"),we(s,t,"threshold"),s},Ye=(n,e)=>{const t=n.createGain();return Ie(t,e),we(t,e,"gain"),t},hh=n=>(e,t,s)=>{if(e.createIIRFilter===void 0)return n(e,t,s);const a=e.createIIRFilter(s.feedforward,s.feedback);return Ie(a,s),a};function mh(n,e){const t=e[0]*e[0]+e[1]*e[1];return[(n[0]*e[0]+n[1]*e[1])/t,(n[1]*e[0]-n[0]*e[1])/t]}function ph(n,e){return[n[0]*e[0]-n[1]*e[1],n[0]*e[1]+n[1]*e[0]]}function Oa(n,e){let t=[0,0];for(let s=n.length-1;s>=0;s-=1)t=ph(t,e),t[0]+=n[s];return t}const fh=(n,e,t,s)=>(a,r,{channelCount:c,channelCountMode:l,channelInterpretation:o,feedback:u,feedforward:h})=>{const d=xr(r,a.sampleRate),m=u instanceof Float64Array?u:new Float64Array(u),f=h instanceof Float64Array?h:new Float64Array(h),p=m.length,g=f.length,y=Math.min(p,g);if(p===0||p>20)throw s();if(m[0]===0)throw e();if(g===0||g>20)throw s();if(f[0]===0)throw e();if(m[0]!==1){for(let v=0;v<g;v+=1)f[v]/=m[0];for(let v=1;v<p;v+=1)m[v]/=m[0]}const _=t(a,d,c,c);_.channelCount=c,_.channelCountMode=l,_.channelInterpretation=o;const S=32,C=[],I=[],b=[];for(let v=0;v<c;v+=1){C.push(0);const x=new Float32Array(S),M=new Float32Array(S);x.fill(0),M.fill(0),I.push(x),b.push(M)}_.onaudioprocess=v=>{const x=v.inputBuffer,M=v.outputBuffer,E=x.numberOfChannels;for(let D=0;D<E;D+=1){const R=x.getChannelData(D),T=M.getChannelData(D);C[D]=br(m,p,f,g,y,I[D],b[D],C[D],S,R,T)}};const N=a.sampleRate/2;return ws({get bufferSize(){return d},get channelCount(){return _.channelCount},set channelCount(v){_.channelCount=v},get channelCountMode(){return _.channelCountMode},set channelCountMode(v){_.channelCountMode=v},get channelInterpretation(){return _.channelInterpretation},set channelInterpretation(v){_.channelInterpretation=v},get context(){return _.context},get inputs(){return[_]},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},addEventListener(...v){return _.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return _.dispatchEvent(v[0])},getFrequencyResponse(v,x,M){if(v.length!==x.length||x.length!==M.length)throw n();const E=v.length;for(let D=0;D<E;D+=1){const R=-Math.PI*(v[D]/N),T=[Math.cos(R),Math.sin(R)],F=Oa(f,T),q=Oa(m,T),L=mh(F,q);x[D]=Math.sqrt(L[0]*L[0]+L[1]*L[1]),M[D]=Math.atan2(L[1],L[0])}},removeEventListener(...v){return _.removeEventListener(v[0],v[1],v[2])}},_)},gh=(n,e)=>n.createMediaElementSource(e.mediaElement),vh=(n,e)=>{const t=n.createMediaStreamDestination();return Ie(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},yh=(n,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((r,c)=>r.id<c.id?-1:r.id>c.id?1:0);const s=t.slice(0,1),a=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(a,"mediaStream",{value:e}),a},_h=(n,e)=>(t,{mediaStreamTrack:s})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(s);const a=new MediaStream([s]),r=t.createMediaStreamSource(a);if(s.kind!=="audio")throw n();if(e(t))throw new TypeError;return r},bh=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,xh=(n,e,t,s,a,r)=>(c,l)=>{const o=c.createOscillator();return Ie(o,l),we(o,l,"detune"),we(o,l,"frequency"),l.periodicWave!==void 0?o.setPeriodicWave(l.periodicWave):ye(o,l,"type"),e(t,()=>t(c))||Ti(o),e(s,()=>s(c))||r(o,c),e(a,()=>a(c))||ki(o),n(c,o),o},wh=n=>(e,t)=>{const s=e.createPanner();return s.orientationX===void 0?n(e,t):(Ie(s,t),we(s,t,"orientationX"),we(s,t,"orientationY"),we(s,t,"orientationZ"),we(s,t,"positionX"),we(s,t,"positionY"),we(s,t,"positionZ"),ye(s,t,"coneInnerAngle"),ye(s,t,"coneOuterAngle"),ye(s,t,"coneOuterGain"),ye(s,t,"distanceModel"),ye(s,t,"maxDistance"),ye(s,t,"panningModel"),ye(s,t,"refDistance"),ye(s,t,"rolloffFactor"),s)},Nh=(n,e,t,s,a,r,c,l,o,u)=>(h,{coneInnerAngle:d,coneOuterAngle:m,coneOuterGain:f,distanceModel:p,maxDistance:g,orientationX:y,orientationY:_,orientationZ:S,panningModel:C,positionX:I,positionY:b,positionZ:N,refDistance:j,rolloffFactor:v,...x})=>{const M=h.createPanner();if(x.channelCount>2||x.channelCountMode==="max")throw c();Ie(M,x);const E={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},D=t(h,{...E,channelInterpretation:"speakers",numberOfInputs:6}),R=s(h,{...x,gain:1}),T=s(h,{...E,gain:1}),F=s(h,{...E,gain:0}),q=s(h,{...E,gain:0}),L=s(h,{...E,gain:0}),B=s(h,{...E,gain:0}),G=s(h,{...E,gain:0}),X=a(h,256,6,1),H=r(h,{...E,curve:new Float32Array([1,1]),oversample:"none"});let K=[y,_,S],$=[I,b,N];const Q=new Float32Array(1);X.onaudioprocess=({inputBuffer:A})=>{const W=[o(A,Q,0),o(A,Q,1),o(A,Q,2)];W.some((ae,Te)=>ae!==K[Te])&&(M.setOrientation(...W),K=W);const Z=[o(A,Q,3),o(A,Q,4),o(A,Q,5)];Z.some((ae,Te)=>ae!==$[Te])&&(M.setPosition(...Z),$=Z)},Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(q.gain,"defaultValue",{get:()=>0}),Object.defineProperty(L.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(G.gain,"defaultValue",{get:()=>0});const O={get bufferSize(){},get channelCount(){return M.channelCount},set channelCount(A){if(A>2)throw c();R.channelCount=A,M.channelCount=A},get channelCountMode(){return M.channelCountMode},set channelCountMode(A){if(A==="max")throw c();R.channelCountMode=A,M.channelCountMode=A},get channelInterpretation(){return M.channelInterpretation},set channelInterpretation(A){R.channelInterpretation=A,M.channelInterpretation=A},get coneInnerAngle(){return M.coneInnerAngle},set coneInnerAngle(A){M.coneInnerAngle=A},get coneOuterAngle(){return M.coneOuterAngle},set coneOuterAngle(A){M.coneOuterAngle=A},get coneOuterGain(){return M.coneOuterGain},set coneOuterGain(A){if(A<0||A>1)throw e();M.coneOuterGain=A},get context(){return M.context},get distanceModel(){return M.distanceModel},set distanceModel(A){M.distanceModel=A},get inputs(){return[R]},get maxDistance(){return M.maxDistance},set maxDistance(A){if(A<0)throw new RangeError;M.maxDistance=A},get numberOfInputs(){return M.numberOfInputs},get numberOfOutputs(){return M.numberOfOutputs},get orientationX(){return T.gain},get orientationY(){return F.gain},get orientationZ(){return q.gain},get panningModel(){return M.panningModel},set panningModel(A){M.panningModel=A},get positionX(){return L.gain},get positionY(){return B.gain},get positionZ(){return G.gain},get refDistance(){return M.refDistance},set refDistance(A){if(A<0)throw new RangeError;M.refDistance=A},get rolloffFactor(){return M.rolloffFactor},set rolloffFactor(A){if(A<0)throw new RangeError;M.rolloffFactor=A},addEventListener(...A){return R.addEventListener(A[0],A[1],A[2])},dispatchEvent(...A){return R.dispatchEvent(A[0])},removeEventListener(...A){return R.removeEventListener(A[0],A[1],A[2])}};d!==O.coneInnerAngle&&(O.coneInnerAngle=d),m!==O.coneOuterAngle&&(O.coneOuterAngle=m),f!==O.coneOuterGain&&(O.coneOuterGain=f),p!==O.distanceModel&&(O.distanceModel=p),g!==O.maxDistance&&(O.maxDistance=g),y!==O.orientationX.value&&(O.orientationX.value=y),_!==O.orientationY.value&&(O.orientationY.value=_),S!==O.orientationZ.value&&(O.orientationZ.value=S),C!==O.panningModel&&(O.panningModel=C),I!==O.positionX.value&&(O.positionX.value=I),b!==O.positionY.value&&(O.positionY.value=b),N!==O.positionZ.value&&(O.positionZ.value=N),j!==O.refDistance&&(O.refDistance=j),v!==O.rolloffFactor&&(O.rolloffFactor=v),(K[0]!==1||K[1]!==0||K[2]!==0)&&M.setOrientation(...K),($[0]!==0||$[1]!==0||$[2]!==0)&&M.setPosition(...$);const k=()=>{R.connect(M),n(R,H,0,0),H.connect(T).connect(D,0,0),H.connect(F).connect(D,0,1),H.connect(q).connect(D,0,2),H.connect(L).connect(D,0,3),H.connect(B).connect(D,0,4),H.connect(G).connect(D,0,5),D.connect(X).connect(h.destination)},P=()=>{R.disconnect(M),l(R,H,0,0),H.disconnect(T),T.disconnect(D),H.disconnect(F),F.disconnect(D),H.disconnect(q),q.disconnect(D),H.disconnect(L),L.disconnect(D),H.disconnect(B),B.disconnect(D),H.disconnect(G),G.disconnect(D),D.disconnect(X),X.disconnect(h.destination)};return u(ws(O,M),k,P)},Sh=n=>(e,{disableNormalization:t,imag:s,real:a})=>{const r=s instanceof Float32Array?s:new Float32Array(s),c=a instanceof Float32Array?a:new Float32Array(a),l=e.createPeriodicWave(c,r,{disableNormalization:t});if(Array.from(s).length<2)throw n();return l},Ws=(n,e,t,s)=>n.createScriptProcessor(e,t,s),jh=(n,e)=>(t,s)=>{const a=s.channelCountMode;if(a==="clamped-max")throw e();if(t.createStereoPanner===void 0)return n(t,s);const r=t.createStereoPanner();return Ie(r,s),we(r,s,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>a,set:c=>{if(c!==a)throw e()}}),r},Th=(n,e,t,s,a,r)=>{const l=new Float32Array([1,1]),o=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...u,oversample:"none"},d=(p,g,y,_)=>{const S=new Float32Array(16385),C=new Float32Array(16385);for(let x=0;x<16385;x+=1){const M=x/16384*o;S[x]=Math.cos(M),C[x]=Math.sin(M)}const I=t(p,{...u,gain:0}),b=s(p,{...h,curve:S}),N=s(p,{...h,curve:l}),j=t(p,{...u,gain:0}),v=s(p,{...h,curve:C});return{connectGraph(){g.connect(I),g.connect(N.inputs===void 0?N:N.inputs[0]),g.connect(j),N.connect(y),y.connect(b.inputs===void 0?b:b.inputs[0]),y.connect(v.inputs===void 0?v:v.inputs[0]),b.connect(I.gain),v.connect(j.gain),I.connect(_,0,0),j.connect(_,0,1)},disconnectGraph(){g.disconnect(I),g.disconnect(N.inputs===void 0?N:N.inputs[0]),g.disconnect(j),N.disconnect(y),y.disconnect(b.inputs===void 0?b:b.inputs[0]),y.disconnect(v.inputs===void 0?v:v.inputs[0]),b.disconnect(I.gain),v.disconnect(j.gain),I.disconnect(_,0,0),j.disconnect(_,0,1)}}},m=(p,g,y,_)=>{const S=new Float32Array(16385),C=new Float32Array(16385),I=new Float32Array(16385),b=new Float32Array(16385),N=Math.floor(16385/2);for(let L=0;L<16385;L+=1)if(L>N){const B=(L-N)/(16384-N)*o;S[L]=Math.cos(B),C[L]=Math.sin(B),I[L]=0,b[L]=1}else{const B=L/(16384-N)*o;S[L]=1,C[L]=0,I[L]=Math.cos(B),b[L]=Math.sin(B)}const j=e(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),v=t(p,{...u,gain:0}),x=s(p,{...h,curve:S}),M=t(p,{...u,gain:0}),E=s(p,{...h,curve:C}),D=s(p,{...h,curve:l}),R=t(p,{...u,gain:0}),T=s(p,{...h,curve:I}),F=t(p,{...u,gain:0}),q=s(p,{...h,curve:b});return{connectGraph(){g.connect(j),g.connect(D.inputs===void 0?D:D.inputs[0]),j.connect(v,0),j.connect(M,0),j.connect(R,1),j.connect(F,1),D.connect(y),y.connect(x.inputs===void 0?x:x.inputs[0]),y.connect(E.inputs===void 0?E:E.inputs[0]),y.connect(T.inputs===void 0?T:T.inputs[0]),y.connect(q.inputs===void 0?q:q.inputs[0]),x.connect(v.gain),E.connect(M.gain),T.connect(R.gain),q.connect(F.gain),v.connect(_,0,0),R.connect(_,0,0),M.connect(_,0,1),F.connect(_,0,1)},disconnectGraph(){g.disconnect(j),g.disconnect(D.inputs===void 0?D:D.inputs[0]),j.disconnect(v,0),j.disconnect(M,0),j.disconnect(R,1),j.disconnect(F,1),D.disconnect(y),y.disconnect(x.inputs===void 0?x:x.inputs[0]),y.disconnect(E.inputs===void 0?E:E.inputs[0]),y.disconnect(T.inputs===void 0?T:T.inputs[0]),y.disconnect(q.inputs===void 0?q:q.inputs[0]),x.disconnect(v.gain),E.disconnect(M.gain),T.disconnect(R.gain),q.disconnect(F.gain),v.disconnect(_,0,0),R.disconnect(_,0,0),M.disconnect(_,0,1),F.disconnect(_,0,1)}}},f=(p,g,y,_,S)=>{if(g===1)return d(p,y,_,S);if(g===2)return m(p,y,_,S);throw a()};return(p,{channelCount:g,channelCountMode:y,pan:_,...S})=>{if(y==="max")throw a();const C=n(p,{...S,channelCount:1,channelCountMode:y,numberOfInputs:2}),I=t(p,{...S,channelCount:g,channelCountMode:y,gain:1}),b=t(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:_});let{connectGraph:N,disconnectGraph:j}=f(p,g,I,b,C);Object.defineProperty(b.gain,"defaultValue",{get:()=>0}),Object.defineProperty(b.gain,"maxValue",{get:()=>1}),Object.defineProperty(b.gain,"minValue",{get:()=>-1});const v={get bufferSize(){},get channelCount(){return I.channelCount},set channelCount(D){I.channelCount!==D&&(x&&j(),{connectGraph:N,disconnectGraph:j}=f(p,D,I,b,C),x&&N()),I.channelCount=D},get channelCountMode(){return I.channelCountMode},set channelCountMode(D){if(D==="clamped-max"||D==="max")throw a();I.channelCountMode=D},get channelInterpretation(){return I.channelInterpretation},set channelInterpretation(D){I.channelInterpretation=D},get context(){return I.context},get inputs(){return[I]},get numberOfInputs(){return I.numberOfInputs},get numberOfOutputs(){return I.numberOfOutputs},get pan(){return b.gain},addEventListener(...D){return I.addEventListener(D[0],D[1],D[2])},dispatchEvent(...D){return I.dispatchEvent(D[0])},removeEventListener(...D){return I.removeEventListener(D[0],D[1],D[2])}};let x=!1;const M=()=>{N(),x=!0},E=()=>{j(),x=!1};return r(ws(v,C),M,E)}},kh=(n,e,t,s,a,r,c)=>(l,o)=>{const u=l.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&l.createGain().gain.automationRate===void 0)return t(l,o);Ie(u,o);const h=o.curve===null||o.curve instanceof Float32Array?o.curve:new Float32Array(o.curve);if(h!==null&&h.length<2)throw e();ye(u,{curve:h},"curve"),ye(u,o,"oversample");let d=null,m=!1;return c(u,"curve",g=>()=>g.call(u),g=>y=>(g.call(u,y),m&&(s(y)&&d===null?d=n(l,u):!s(y)&&d!==null&&(d(),d=null)),y)),a(u,()=>{m=!0,s(u.curve)&&(d=n(l,u))},()=>{m=!1,d!==null&&(d(),d=null)})},Ch=(n,e,t,s,a)=>(r,{curve:c,oversample:l,...o})=>{const u=r.createWaveShaper(),h=r.createWaveShaper();Ie(u,o),Ie(h,o);const d=t(r,{...o,gain:1}),m=t(r,{...o,gain:-1}),f=t(r,{...o,gain:1}),p=t(r,{...o,gain:-1});let g=null,y=!1,_=null;const S={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(b){d.channelCount=b,m.channelCount=b,u.channelCount=b,f.channelCount=b,h.channelCount=b,p.channelCount=b},get channelCountMode(){return u.channelCountMode},set channelCountMode(b){d.channelCountMode=b,m.channelCountMode=b,u.channelCountMode=b,f.channelCountMode=b,h.channelCountMode=b,p.channelCountMode=b},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(b){d.channelInterpretation=b,m.channelInterpretation=b,u.channelInterpretation=b,f.channelInterpretation=b,h.channelInterpretation=b,p.channelInterpretation=b},get context(){return u.context},get curve(){return _},set curve(b){if(b!==null&&b.length<2)throw e();if(b===null)u.curve=b,h.curve=b;else{const N=b.length,j=new Float32Array(N+2-N%2),v=new Float32Array(N+2-N%2);j[0]=b[0],v[0]=-b[N-1];const x=Math.ceil((N+1)/2),M=(N+1)/2-1;for(let E=1;E<x;E+=1){const D=E/x*M,R=Math.floor(D),T=Math.ceil(D);j[E]=R===T?b[R]:(1-(D-R))*b[R]+(1-(T-D))*b[T],v[E]=R===T?-b[N-1-R]:-((1-(D-R))*b[N-1-R])-(1-(T-D))*b[N-1-T]}j[x]=N%2===1?b[x-1]:(b[x-2]+b[x-1])/2,u.curve=j,h.curve=v}_=b,y&&(s(_)&&g===null?g=n(r,d):g!==null&&(g(),g=null))},get inputs(){return[d]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(b){u.oversample=b,h.oversample=b},addEventListener(...b){return d.addEventListener(b[0],b[1],b[2])},dispatchEvent(...b){return d.dispatchEvent(b[0])},removeEventListener(...b){return d.removeEventListener(b[0],b[1],b[2])}};c!==null&&(S.curve=c instanceof Float32Array?c:new Float32Array(c)),l!==S.oversample&&(S.oversample=l);const C=()=>{d.connect(u).connect(f),d.connect(m).connect(h).connect(p).connect(f),y=!0,s(_)&&(g=n(r,d))},I=()=>{d.disconnect(u),u.disconnect(f),d.disconnect(m),m.disconnect(h),h.disconnect(p),p.disconnect(f),y=!1,g!==null&&(g(),g=null)};return a(ws(S,f),C,I)},Ue=()=>new DOMException("","NotSupportedError"),Ah={numberOfChannels:1},Mh=(n,e,t,s,a)=>class extends n{constructor(c,l,o){let u;if(typeof c=="number"&&l!==void 0&&o!==void 0)u={length:l,numberOfChannels:c,sampleRate:o};else if(typeof c=="object")u=c;else throw new Error("The given parameters are not valid.");const{length:h,numberOfChannels:d,sampleRate:m}={...Ah,...u},f=s(d,h,m);e(Ds,()=>Ds(f))||f.addEventListener("statechange",(()=>{let p=0;const g=y=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",g),y.stopImmediatePropagation(),this._waitForThePromiseToSettle(y)):p+=1)};return g})()),super(f,d),this._length=h,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",a(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,pr(this)}))}_waitForThePromiseToSettle(c){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(c):setTimeout(()=>this._waitForThePromiseToSettle(c))}},Eh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Ih=(n,e,t,s,a,r,c)=>class extends n{constructor(o,u){const h=a(o),d={...Eh,...u},m=t(h,d),f=r(h),p=f?s():null,g=o.sampleRate/2;super(o,!1,m,p),this._detune=e(this,f,m.detune,153600,-153600),this._frequency=e(this,f,m.frequency,g,-g),this._nativeOscillatorNode=m,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&d.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=d.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(o){const u=typeof o=="function"?c(this,o):null;this._nativeOscillatorNode.onended=u;const h=this._nativeOscillatorNode.onended;this._onended=h!==null&&h===u?o:h}get type(){return this._nativeOscillatorNode.type}set type(o){this._nativeOscillatorNode.type=o,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(o){this._nativeOscillatorNode.setPeriodicWave(o),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=o)}start(o=0){if(this._nativeOscillatorNode.start(o),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=o),this.context.state!=="closed"){ms(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),xt(this)&&Fs(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(o=0){this._nativeOscillatorNode.stop(o),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=o)}},Dh=(n,e,t,s,a)=>()=>{const r=new WeakMap;let c=null,l=null,o=null;const u=async(h,d)=>{let m=t(h);const f=Ve(m,d);if(!f){const p={channelCount:m.channelCount,channelCountMode:m.channelCountMode,channelInterpretation:m.channelInterpretation,detune:m.detune.value,frequency:m.frequency.value,periodicWave:c===null?void 0:c,type:m.type};m=e(d,p),l!==null&&m.start(l),o!==null&&m.stop(o)}return r.set(d,m),f?(await n(d,h.detune,m.detune),await n(d,h.frequency,m.frequency)):(await s(d,h.detune,m.detune),await s(d,h.frequency,m.frequency)),await a(h,d,m),m};return{set periodicWave(h){c=h},set start(h){l=h},set stop(h){o=h},render(h,d){const m=r.get(d);return m!==void 0?Promise.resolve(m):u(h,d)}}},Ph={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Oh=(n,e,t,s,a,r,c)=>class extends n{constructor(o,u){const h=a(o),d={...Ph,...u},m=t(h,d),f=r(h),p=f?s():null;super(o,!1,m,p),this._nativePannerNode=m,this._orientationX=e(this,f,m.orientationX,We,Ge),this._orientationY=e(this,f,m.orientationY,We,Ge),this._orientationZ=e(this,f,m.orientationZ,We,Ge),this._positionX=e(this,f,m.positionX,We,Ge),this._positionY=e(this,f,m.positionY,We,Ge),this._positionZ=e(this,f,m.positionZ,We,Ge),c(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(o){this._nativePannerNode.coneInnerAngle=o}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(o){this._nativePannerNode.coneOuterAngle=o}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(o){this._nativePannerNode.coneOuterGain=o}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(o){this._nativePannerNode.distanceModel=o}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(o){this._nativePannerNode.maxDistance=o}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(o){this._nativePannerNode.panningModel=o}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(o){this._nativePannerNode.refDistance=o}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(o){this._nativePannerNode.rolloffFactor=o}},Rh=(n,e,t,s,a,r,c,l,o,u)=>()=>{const h=new WeakMap;let d=null;const m=async(f,p)=>{let g=null,y=r(f);const _={channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation},S={..._,coneInnerAngle:y.coneInnerAngle,coneOuterAngle:y.coneOuterAngle,coneOuterGain:y.coneOuterGain,distanceModel:y.distanceModel,maxDistance:y.maxDistance,panningModel:y.panningModel,refDistance:y.refDistance,rolloffFactor:y.rolloffFactor},C=Ve(y,p);if("bufferSize"in y)g=s(p,{..._,gain:1});else if(!C){const I={...S,orientationX:y.orientationX.value,orientationY:y.orientationY.value,orientationZ:y.orientationZ.value,positionX:y.positionX.value,positionY:y.positionY.value,positionZ:y.positionZ.value};y=a(p,I)}if(h.set(p,g===null?y:g),g!==null){if(d===null){if(c===null)throw new Error("Missing the native OfflineAudioContext constructor.");const E=new c(6,f.context.length,p.sampleRate),D=e(E,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});D.connect(E.destination),d=(async()=>{const R=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(T,F)=>{const q=t(E,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:F===0?1:0});return await l(E,T,q.offset),q}));for(let T=0;T<6;T+=1)R[T].connect(D,0,T),R[T].start(0);return u(E)})()}const I=await d,b=s(p,{..._,gain:1});await o(f,p,b);const N=[];for(let E=0;E<I.numberOfChannels;E+=1)N.push(I.getChannelData(E));let j=[N[0][0],N[1][0],N[2][0]],v=[N[3][0],N[4][0],N[5][0]],x=s(p,{..._,gain:1}),M=a(p,{...S,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]});b.connect(x).connect(M.inputs[0]),M.connect(g);for(let E=128;E<I.length;E+=128){const D=[N[0][E],N[1][E],N[2][E]],R=[N[3][E],N[4][E],N[5][E]];if(D.some((T,F)=>T!==j[F])||R.some((T,F)=>T!==v[F])){j=D,v=R;const T=E/p.sampleRate;x.gain.setValueAtTime(0,T),x=s(p,{..._,gain:0}),M=a(p,{...S,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]}),x.gain.setValueAtTime(1,T),b.connect(x).connect(M.inputs[0]),M.connect(g)}}return g}return C?(await n(p,f.orientationX,y.orientationX),await n(p,f.orientationY,y.orientationY),await n(p,f.orientationZ,y.orientationZ),await n(p,f.positionX,y.positionX),await n(p,f.positionY,y.positionY),await n(p,f.positionZ,y.positionZ)):(await l(p,f.orientationX,y.orientationX),await l(p,f.orientationY,y.orientationY),await l(p,f.orientationZ,y.orientationZ),await l(p,f.positionX,y.positionX),await l(p,f.positionY,y.positionY),await l(p,f.positionZ,y.positionZ)),xs(y)?await o(f,p,y.inputs[0]):await o(f,p,y),y};return{render(f,p){const g=h.get(p);return g!==void 0?Promise.resolve(g):m(f,p)}}},Fh={disableNormalization:!1},Lh=(n,e,t,s)=>class Sr{constructor(r,c){const l=e(r),o=s({...Fh,...c}),u=n(l,o);return t.add(u),u}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===Sr.prototype||t.has(r)}},Vh=(n,e)=>(t,s,a)=>(n(s).replay(a),e(s,t,a)),qh=(n,e,t)=>async(s,a,r)=>{const c=n(s);await Promise.all(c.activeInputs.map((l,o)=>Array.from(l).map(async([u,h])=>{const m=await e(u).render(u,a),f=s.context.destination;!t(u)&&(s!==f||!t(s))&&m.connect(r,h,o)})).reduce((l,o)=>[...l,...o],[]))},Wh=(n,e,t)=>async(s,a,r)=>{const c=e(s);await Promise.all(Array.from(c.activeInputs).map(async([l,o])=>{const h=await n(l).render(l,a);t(l)||h.connect(r,o)}))},Bh=(n,e,t,s)=>a=>n(Ds,()=>Ds(a))?Promise.resolve(n(s,s)).then(r=>{if(!r){const c=t(a,512,0,1);a.oncomplete=()=>{c.onaudioprocess=null,c.disconnect()},c.onaudioprocess=()=>a.currentTime,c.connect(a.destination)}return a.startRendering()}):new Promise(r=>{const c=e(a,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});a.oncomplete=l=>{c.disconnect(),r(l.renderedBuffer)},c.connect(a.destination),a.startRendering()}),Uh=n=>(e,t)=>{n.set(e,t)},$h=n=>(e,t)=>n.set(e,t),Gh=(n,e,t,s,a,r,c,l)=>(o,u)=>t(o).render(o,u).then(()=>Promise.all(Array.from(s(u)).map(h=>t(h).render(h,u)))).then(()=>a(u)).then(h=>(typeof h.copyFromChannel!="function"?(c(h),Ni(h)):e(r,()=>r(h))||l(h),n.add(h),h)),zh={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Yh=(n,e,t,s,a,r)=>class extends n{constructor(l,o){const u=a(l),h={...zh,...o},d=t(u,h),m=r(u),f=m?s():null;super(l,!1,d,f),this._pan=e(this,m,d.pan)}get pan(){return this._pan}},Xh=(n,e,t,s,a)=>()=>{const r=new WeakMap,c=async(l,o)=>{let u=t(l);const h=Ve(u,o);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(o,d)}return r.set(o,u),h?await n(o,l.pan,u.pan):await s(o,l.pan,u.pan),xs(u)?await a(l,o,u.inputs[0]):await a(l,o,u),u};return{render(l,o){const u=r.get(o);return u!==void 0?Promise.resolve(u):c(l,o)}}},Hh=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},Jh=(n,e)=>async()=>{if(n===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new e(1,128,44100),a=URL.createObjectURL(t);let r=!1,c=!1;try{await s.audioWorklet.addModule(a);const l=new n(s,"a",{numberOfOutputs:0}),o=s.createOscillator();l.port.onmessage=()=>r=!0,l.onprocessorerror=()=>c=!0,o.connect(l),o.start(0),await s.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(a)}return r&&!c},Zh=(n,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(a=>{t.oncomplete=()=>{s.disconnect(),a(t.currentTime!==0)},t.startRendering()})},Kh=()=>new DOMException("","UnknownError"),Qh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},em=(n,e,t,s,a,r,c)=>class extends n{constructor(o,u){const h=a(o),d={...Qh,...u},m=t(h,d),p=r(h)?s():null;super(o,!0,m,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=m,c(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(o){if(o===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(o.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=o}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(o){this._nativeWaveShaperNode.oversample=o}},tm=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,c)=>{let l=e(r);if(!Ve(l,c)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,curve:l.curve,oversample:l.oversample};l=n(c,u)}return s.set(c,l),xs(l)?await t(r,c,l.inputs[0]):await t(r,c,l),l};return{render(r,c){const l=s.get(c);return l!==void 0?Promise.resolve(l):a(r,c)}}},sm=()=>typeof window>"u"?null:window,nm=(n,e)=>t=>{t.copyFromChannel=(s,a,r=0)=>{const c=n(r),l=n(a);if(l>=t.numberOfChannels)throw e();const o=t.length,u=t.getChannelData(l),h=s.length;for(let d=c<0?-c:0;d+c<o&&d<h;d+=1)s[d]=u[d+c]},t.copyToChannel=(s,a,r=0)=>{const c=n(r),l=n(a);if(l>=t.numberOfChannels)throw e();const o=t.length,u=t.getChannelData(l),h=s.length;for(let d=c<0?-c:0;d+c<o&&d<h;d+=1)u[d+c]=s[d]}},im=n=>e=>{e.copyFromChannel=(t=>(s,a,r=0)=>{const c=n(r),l=n(a);if(c<e.length)return t.call(e,s,l,c)})(e.copyFromChannel),e.copyToChannel=(t=>(s,a,r=0)=>{const c=n(r),l=n(a);if(c<e.length)return t.call(e,s,l,c)})(e.copyToChannel)},am=n=>(e,t)=>{const s=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=s),n(e,"buffer",a=>()=>{const r=a.call(e);return r===s?null:r},a=>r=>a.call(e,r===null?s:r))},rm=(n,e)=>(t,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const a=t.createBufferSource();e(s,()=>{const l=s.numberOfInputs;for(let o=0;o<l;o+=1)a.connect(s,0,o)},()=>a.disconnect(s))},jr=(n,e,t)=>n.copyFromChannel===void 0?n.getChannelData(t)[0]:(n.copyFromChannel(e,t),e[0]),Tr=n=>{if(n===null)return!1;const e=n.length;return e%2!==0?n[Math.floor(e/2)]!==0:n[e/2-1]+n[e/2]!==0},Bs=(n,e,t,s)=>{let a=n;for(;!a.hasOwnProperty(e);)a=Object.getPrototypeOf(a);const{get:r,set:c}=Object.getOwnPropertyDescriptor(a,e);Object.defineProperty(n,e,{get:t(r),set:s(c)})},om=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),cm=n=>({...n,channelCount:n.numberOfOutputs}),lm=n=>{const{imag:e,real:t}=n;return e===void 0?t===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(t,()=>0),real:t}:t===void 0?{...n,imag:e,real:Array.from(e,()=>0)}:{...n,imag:e,real:t}},kr=(n,e,t)=>{try{n.setValueAtTime(e,t)}catch(s){if(s.code!==9)throw s;kr(n,e,t+1e-7)}},um=n=>{const e=n.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},dm=n=>{const e=n.createBufferSource(),t=n.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},hm=n=>{const e=n.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},Ci=n=>{const e=n.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},Cr=n=>{const e=n.createBuffer(1,1,44100),t=n.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Ai=n=>{const e=n.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},mm=n=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(n)}finally{e.close(),t.close()}},pm=n=>{n.start=(e=>(t=0,s=0,a)=>{const r=n.buffer,c=r===null?s:Math.min(r.duration,s);r!==null&&c>r.duration-.5/n.context.sampleRate?e.call(n,t,0,0):e.call(n,t,c,a)})(n.start)},Ar=(n,e)=>{const t=e.createGain();n.connect(t);const s=(a=>()=>{a.call(n,t),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),ws(n,t),n.stop=(a=>{let r=!1;return(c=0)=>{if(r)try{a.call(n,c)}catch{t.gain.setValueAtTime(0,c)}else a.call(n,c),r=!0}})(n.stop)},Ns=(n,e)=>t=>{const s={value:n};return Object.defineProperties(t,{currentTarget:s,target:s}),typeof e=="function"?e.call(n,t):e.handleEvent.call(n,t)},fm=Ol(es),gm=Wl(es),vm=Qu(Nn),Mr=new WeakMap,ym=vd(Mr),rt=Au(new Map,new WeakMap),pt=sm(),Er=Yd(rt,gt),Mi=gd(Be),Re=qh(Be,Mi,Yt),_m=zl(Er,pe,Re),he=bd(wn),jt=bh(pt),le=Fd(jt),Ir=new WeakMap,Dr=ld(Ns),Us=Zd(pt),Ei=Dd(Us),Ii=Pd(pt),Pr=Od(pt),Ps=Qd(pt),je=vu(Rl(or),ql(fm,gm,hn,vm,mn,Be,ym,Rs,pe,es,xt,Yt,sn),rt,Cd(li,mn,Be,pe,Is,xt),gt,Sn,Ue,Hu(hn,li,Be,pe,Is,he,xt,le),sd(Ir,Be,at),Dr,he,Ei,Ii,Pr,le,Ps),bm=Gl(je,_m,gt,Er,he,le),Di=new WeakSet,Ra=Xd(pt),Or=Bu(new Uint32Array(1)),Pi=nm(Or,gt),Oi=im(Or),Rr=Xl(Di,rt,Ue,Ra,jt,Hh(Ra),Pi,Oi),jn=Bl(Ye),Fr=Wh(Mi,Ls,Yt),vt=Ru(Fr),Ss=Jd(jn,rt,um,dm,hm,Ci,Cr,Ai,pm,am(Bs),Ar),yt=Vh(yd(Ls),Fr),xm=Zl(vt,Ss,pe,yt,Re),ot=yu(Fl(cr),Ir,wi,_u,Al,Ml,El,Il,Dl,ri,ar,Us,kr),wm=Jl(je,xm,ot,Pe,Ss,he,le,Ns),Nm=ru(je,ou,gt,Pe,Kd(Ye,Bs),he,le,Re),Sm=Cu(vt,wr,pe,yt,Re),ts=$h(Mr),jm=ku(je,ot,Sm,Sn,wr,he,le,ts),Lt=Gd(es,Ii),Tm=rm(Pe,Lt),Vt=rh(Us,Tm),km=Iu(Vt,pe,Re),Cm=Eu(je,km,Vt,he,le),Am=Ou(qs,pe,Re),Mm=Pu(je,Am,qs,he,le,cm),Em=lh(jn,Ss,Ye,Lt),js=ch(jn,rt,Em,Ci,Ai),Im=Wu(vt,js,pe,yt,Re),Dm=qu(je,ot,Im,js,he,le,Ns),Lr=uh(Ue,Bs),Pm=Gu(Lr,pe,Re),Om=$u(je,Pm,Lr,he,le,ts),Rm=Ku(vt,Nr,pe,yt,Re),Fm=Zu(je,ot,Rm,Nr,he,le,ts),Vr=dh(Ue),Lm=rd(vt,Vr,pe,yt,Re),Vm=ad(je,ot,Lm,Vr,Ue,he,le,ts),qm=pd(vt,Ye,pe,yt,Re),Wm=md(je,ot,qm,Ye,he,le),Bm=fh(Sn,Pe,Ws,Ue),Tn=Bh(rt,Ye,Ws,Zh(Ye,jt)),Um=kd(Ss,pe,jt,Re,Tn),$m=hh(Bm),Gm=jd(je,$m,Um,he,le,ts),zm=cu(ot,Vt,js,Ws,Ue,jr,le,Bs),qr=new WeakMap,Ym=$d(Nm,zm,Dr,le,qr,Ns),Wr=xh(jn,rt,Ci,Cr,Ai,Ar),Xm=Dh(vt,Wr,pe,yt,Re),Hm=Ih(je,ot,Wr,Xm,he,le,Ns),Br=Lu(Ss),Jm=Ch(Br,Pe,Ye,Tr,Lt),kn=kh(Br,Pe,Jm,Tr,Lt,Us,Bs),Zm=Nh(hn,Pe,Vt,Ye,Ws,kn,Ue,mn,jr,Lt),Ur=wh(Zm),Km=Rh(vt,Vt,js,Ye,Ur,pe,jt,yt,Re,Tn),Qm=Oh(je,ot,Ur,Km,he,le,ts),ep=Sh(gt),tp=Lh(ep,he,new WeakSet,lm),sp=Th(Vt,qs,Ye,kn,Ue,Lt),$r=jh(sp,Ue),np=Xh(vt,$r,pe,yt,Re),ip=Yh(je,ot,$r,np,he,le),ap=tm(kn,pe,Re),rp=em(je,Pe,kn,ap,he,le,ts),Gr=Ld(pt),Ri=ud(pt),zr=new WeakMap,op=xd(zr,jt),cp=Gr?Vl(rt,Ue,cd(pt),Ri,dd(Pl),he,op,le,Ps,new WeakMap,new WeakMap,Jh(Ps,jt),pt):void 0,lp=Rd(Ei,le),up=Xu(Di,rt,Yu,od,new WeakSet,he,lp,un,Ds,Pi,Oi),Yr=ju(cp,bm,Rr,wm,jm,Cm,Mm,Dm,Om,up,Fm,Vm,Wm,Gm,Ym,Hm,Qm,tp,ip,rp),dp=Vd(je,gh,he,le),hp=Wd(je,vh,he,le),mp=Bd(je,yh,he,le),pp=_h(Pe,le),fp=Ud(je,pp,he),gp=au(Yr,Pe,Ue,Kh,dp,hp,mp,fp,Us),Fi=wd(qr),vp=Ul(Fi),Xr=Fu(gt),yp=ed(Fi),Hr=nd(gt),Jr=new WeakMap,_p=fd(Jr,at),bp=ah(Xr,gt,Pe,Vt,qs,js,Ye,Ws,Ue,Hr,Ri,_p,Lt),xp=th(Pe,bp,Ye,Ue,Lt),wp=Su(vt,Xr,Ss,Vt,qs,js,Ye,yp,Hr,Ri,pe,Ps,jt,yt,Re,Tn),Np=_d(zr),Sp=Uh(Jr),Fa=Gr?xu(vp,je,ot,wp,xp,Be,Np,he,le,Ps,om,Sp,mm,Ns):void 0,jp=zu(Ue,jt),Tp=Gh(Di,rt,Mi,Fi,Tn,un,Pi,Oi),kp=Mh(Yr,rt,Pe,jp,Tp),Cp=Ad(wn,Ei),Ap=Md(xi,Ii),Mp=Ed(wi,Pr),Ep=Id(wn,le);function Ke(n){return n===void 0}function ne(n){return n!==void 0}function Ip(n){return typeof n=="function"}function ft(n){return typeof n=="number"}function Et(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function Zr(n){return typeof n=="boolean"}function ze(n){return Array.isArray(n)}function Nt(n){return typeof n=="string"}function Ks(n){return Nt(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function te(n,e){if(!n)throw new Error(e)}function Dt(n,e,t=1/0){if(!(e<=n&&n<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${n}`)}function Kr(n){!n.isOffline&&n.state!=="running"&&Cn('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Qr=!1,La=!1;function Va(n){Qr=n}function Dp(n){Ke(n)&&Qr&&!La&&(La=!0,Cn("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let eo=console;function Pp(...n){eo.log(...n)}function Cn(...n){eo.warn(...n)}function Op(n){return new gp(n)}function Rp(n,e,t){return new kp(n,e,t)}const He=typeof self=="object"?self:null,Fp=He&&(He.hasOwnProperty("AudioContext")||He.hasOwnProperty("webkitAudioContext"));function Lp(n,e,t){return te(ne(Fa),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof He?.BaseAudioContext?He?.AudioWorkletNode:Fa)(n,e,t)}function ct(n,e,t,s){var a=arguments.length,r=a<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,e,t,s);else for(var l=n.length-1;l>=0;l--)(c=n[l])&&(r=(a<3?c(r):a>3?c(e,t,r):c(e,t))||r);return a>3&&r&&Object.defineProperty(e,t,r),r}function Ae(n,e,t,s){function a(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function l(h){try{u(s.next(h))}catch(d){c(d)}}function o(h){try{u(s.throw(h))}catch(d){c(d)}}function u(h){h.done?r(h.value):a(h.value).then(l,o)}u((s=s.apply(n,e||[])).next())})}class Vp{constructor(e,t,s,a){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(a||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),s=new Worker(t);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function Xt(n){return Mp(n)}function It(n){return Ap(n)}function nn(n){return Ep(n)}function rs(n){return Cp(n)}function qp(n){return n instanceof Rr}function Wp(n,e){return n==="value"||Xt(e)||It(e)||qp(e)}function $t(n,...e){if(!e.length)return n;const t=e.shift();if(Et(n)&&Et(t))for(const s in t)Wp(s,t[s])?n[s]=t[s]:Et(t[s])?(n[s]||Object.assign(n,{[s]:{}}),$t(n[s],t[s])):Object.assign(n,{[s]:t[s]});return $t(n,...e)}function Bp(n,e){return n.length===e.length&&n.every((t,s)=>e[s]===t)}function se(n,e,t=[],s){const a={},r=Array.from(e);if(Et(r[0])&&s&&!Reflect.has(r[0],s)&&(Object.keys(r[0]).some(l=>Reflect.has(n,l))||($t(a,{[s]:r[0]}),t.splice(t.indexOf(s),1),r.shift())),r.length===1&&Et(r[0]))$t(a,r[0]);else for(let c=0;c<t.length;c++)ne(r[c])&&(a[t[c]]=r[c]);return $t(n,a)}function Up(n){return n.constructor.getDefaults()}function mt(n,e){return Ke(n)?e:n}function pi(n,e){return e.forEach(t=>{Reflect.has(n,t)&&delete n[t]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class Tt{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||He&&this.toString()===He.TONE_DEBUG_CLASS)&&Pp(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}Tt.version=ir;const Li=1e-6;function ps(n,e){return n>e+Li}function fi(n,e){return ps(n,e)||nt(n,e)}function vn(n,e){return n+Li<e}function nt(n,e){return Math.abs(n-e)<Li}function $p(n,e,t){return Math.max(Math.min(n,t),e)}class et extends Tt{constructor(){super(),this.name="Timeline",this._timeline=[];const e=se(et.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(te(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];te(fi(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const s=this._search(e,t);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const s=this._search(e,t);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const s=this._search(e);return s-1>=0?this._timeline[s-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(nt(this._timeline[t].time,e)){for(let s=t;s>=0&&nt(this._timeline[s].time,e);s--)t=s;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&fi(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let s=0;const a=this._timeline.length;let r=a;if(a>0&&this._timeline[a-1][t]<=e)return a-1;for(;s<r;){let c=Math.floor(s+(r-s)/2);const l=this._timeline[c],o=this._timeline[c+1];if(nt(l[t],e)){for(let u=c;u<this._timeline.length;u++){const h=this._timeline[u];if(nt(h[t],e))c=u;else break}return c}else{if(vn(l[t],e)&&ps(o[t],e))return c;ps(l[t],e)?r=c:s=c+1}}return-1}_iterate(e,t=0,s=this._timeline.length-1){this._timeline.slice(t,s+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const s=this._search(e);return s!==-1&&this._iterate(t,0,s),this}forEachAfter(e,t){const s=this._search(e);return this._iterate(t,s+1),this}forEachBetween(e,t,s){let a=this._search(e),r=this._search(t);return a!==-1&&r!==-1?(this._timeline[a].time!==e&&(a+=1),this._timeline[r].time===t&&(r-=1),this._iterate(s,a,r)):a===-1&&this._iterate(s,0,r),this}forEachFrom(e,t){let s=this._search(e);for(;s>=0&&this._timeline[s].time>=e;)s--;return this._iterate(t,s+1),this}forEachAtTime(e,t){const s=this._search(e);if(s!==-1&&nt(this._timeline[s].time,e)){let a=s;for(let r=s;r>=0&&nt(this._timeline[r].time,e);r--)a=r;this._iterate(r=>{t(r)},a,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const to=[];function An(n){to.push(n)}function Gp(n){to.forEach(e=>e(n))}const so=[];function Mn(n){so.push(n)}function zp(n){so.forEach(e=>e(n))}class $s extends Tt{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(a=>{Ke(this._events)&&(this._events={}),this._events.hasOwnProperty(a)||(this._events[a]=[]),this._events[a].push(t)}),this}once(e,t){const s=(...a)=>{t(...a),this.off(e,s)};return this.on(e,s),this}off(e,t){return e.split(/\W+/).forEach(a=>{if(Ke(this._events)&&(this._events={}),this._events.hasOwnProperty(a))if(Ke(t))this._events[a]=[];else{const r=this._events[a];for(let c=r.length-1;c>=0;c--)r[c]===t&&r.splice(c,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const s=this._events[e].slice(0);for(let a=0,r=s.length;a<r;a++)s[a].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const s=Object.getOwnPropertyDescriptor($s.prototype,t);Object.defineProperty(e.prototype,t,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class no extends $s{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Gs extends no{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new et,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=se(Gs.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=Op({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new Vp(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(Gp(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,s){return this._context.createBuffer(e,t,s)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,s){return this._context.createPeriodicWave(e,t,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return te(rs(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return te(rs(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return te(rs(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){te(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){te(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){te(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){te(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Lp(this.rawContext,e,t)}addAudioWorkletModule(e){return Ae(this,void 0,void 0,function*(){te(ne(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return Ae(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return rs(this._context)?this._context.resume():Promise.resolve()}close(){return Ae(this,void 0,void 0,function*(){rs(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&zp(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),s=t.getChannelData(0);for(let r=0;r<s.length;r++)s[r]=e;const a=this._context.createBufferSource();return a.channelCount=1,a.channelCountMode="explicit",a.buffer=t,a.loop=!0,a.start(0),this._constants.set(e,a),a}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:s+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const s=++this._timeoutIds,a=()=>{const r=this.now();this._timeouts.add({callback:()=>{e(),a()},id:s,time:r+t})};return a(),s}}class Yp extends no{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,s){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return Ae(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function Ne(n,e){ze(e)?e.forEach(t=>Ne(n,t)):Object.defineProperty(n,e,{enumerable:!0,writable:!1})}function io(n,e){ze(e)?e.forEach(t=>io(n,t)):Object.defineProperty(n,e,{writable:!0})}const ce=()=>{};class ve extends Tt{constructor(){super(),this.name="ToneAudioBuffer",this.onload=ce;const e=se(ve.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,Nt(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:ce,onload:ce,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:Je().sampleRate}set(e){return e instanceof ve?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return Ae(this,void 0,void 0,function*(){const t=ve.load(e).then(s=>{this.set(s),this.onload(this)});ve.downloads.push(t);try{yield t}finally{const s=ve.downloads.indexOf(t);ve.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=ze(e)&&e[0].length>0,s=t?e.length:1,a=t?e[0].length:e.length,r=Je(),c=r.createBuffer(s,a,r.sampleRate),l=!t&&s===1?[e]:e;for(let o=0;o<s;o++)c.copyToChannel(l[o],o);return this._buffer=c,this}toMono(e){if(ft(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const s=this.numberOfChannels;for(let a=0;a<s;a++){const r=this.toArray(a);for(let c=0;c<r.length;c++)t[c]+=r[c]}t=t.map(a=>a/s),this.fromArray(t)}return this}toArray(e){if(ft(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let s=0;s<this.numberOfChannels;s++)t[s]=this.getChannelData(s);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){te(this.loaded,"Buffer is not loaded");const s=Math.floor(e*this.sampleRate),a=Math.floor(t*this.sampleRate);te(s<a,"The start time must be less than the end time");const r=a-s,c=Je().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let l=0;l<this.numberOfChannels;l++)c.copyToChannel(this.getChannelData(l).subarray(s,a),l);return new ve(c)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new ve().fromArray(e)}static fromUrl(e){return Ae(this,void 0,void 0,function*(){return yield new ve().load(e)})}static load(e){return Ae(this,void 0,void 0,function*(){const t=ve.baseUrl===""||ve.baseUrl.endsWith("/")?ve.baseUrl:ve.baseUrl+"/",s=yield fetch(t+e);if(!s.ok)throw new Error(`could not load url: ${e}`);const a=yield s.arrayBuffer();return yield Je().decodeAudioData(a)})}static supportsType(e){const t=e.split("."),s=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return Ae(this,void 0,void 0,function*(){for(yield Promise.resolve();ve.downloads.length;)yield ve.downloads[0]})}}ve.baseUrl="";ve.downloads=[];class Vi extends Gs{constructor(){super({clockSource:"offline",context:nn(arguments[0])?arguments[0]:Rp(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:nn(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=nn(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return Ae(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const s=Math.floor(this.sampleRate/128);e&&t%s===0&&(yield new Promise(a=>setTimeout(a,1)))}})}render(){return Ae(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new ve(t)})}close(){return Promise.resolve()}}const ao=new Yp;let Bt=ao;function Je(){return Bt===ao&&Fp&&Xp(new Gs),Bt}function Xp(n,e=!1){e&&Bt.dispose(),rs(n)?Bt=new Gs(n):nn(n)?Bt=new Vi(n):Bt=n}function ro(){return Bt.resume()}if(He&&!He.TONE_SILENCE_LOGGING){const e=` * Tone.js v${ir} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function Hp(n){return Math.pow(10,n/20)}function Jp(n){return 20*(Math.log(n)/Math.LN10)}function oo(n){return Math.pow(2,n/12)}let En=440;function Zp(){return En}function Kp(n){En=n}function Ut(n){return Math.round(co(n))}function co(n){return 69+12*Math.log2(n/En)}function lo(n){return En*Math.pow(2,(n-69)/12)}class qi extends Tt{constructor(e,t,s){super(),this.defaultUnits="s",this._val=t,this._units=s,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const s=parseInt(e,10),a=t==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*a:this._beatsToUnits(4/s)*a},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,s)=>{let a=0;return e&&e!=="0"&&(a+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(a+=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(a+=this._beatsToUnits(parseFloat(s)/4)),a},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof qi&&this.fromType(this._val),Ke(this._val))return this._noArg();if(Nt(this._val)&&Ke(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(Et(this._val)){let e=0;for(const t in this._val)if(ne(this._val[t])){const s=this._val[t],a=new this.constructor(this.context,t).valueOf()*s;e+=a}return e}if(ne(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return Nt(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class it extends qi{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new it(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const s=new this.constructor(this.context,e).valueOf(),a=this.valueOf(),l=Math.round(a/s)*s-a;return a+l*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let r=1;r<9;r++){const c=Math.pow(2,r);t.push(c+"n."),t.push(c+"n"),t.push(c+"t")}t.push("0");let s=t[0],a=new it(this.context,t[0]).toSeconds();return t.forEach(r=>{const c=new it(this.context,r).toSeconds();Math.abs(c-e)<Math.abs(a-e)&&(s=r,a=c)}),s}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const s=Math.floor(t/this._getTimeSignature());let a=t%1*4;t=Math.floor(t)%this._getTimeSignature();const r=a.toString();return r.length>3&&(a=parseFloat(parseFloat(r).toFixed(3))),[s,t,a].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Ut(this.toFrequency())}_now(){return this.context.now()}}class Ze extends it{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Zp()}static set A4(e){Kp(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:Ze.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const a=Qp[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?a:Ze.mtof(a)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,s){let a=1;return e&&e!=="0"&&(a*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(a*=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(a*=this._beatsToUnits(parseFloat(s)/4)),a}}})}transpose(e){return new Ze(this.context,this.valueOf()*oo(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return Ut(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/Ze.A4);let s=Math.round(12*t)+57;const a=Math.floor(s/12);return a<0&&(s+=-12*a),ef[s%12]+a.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return lo(e)}static ftom(e){return Ut(e)}}const Qp={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},ef=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class ds extends it{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Fe extends Tt{constructor(){super();const e=se(Fe.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:Je()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return Dp(e),new it(this.context,e).toSeconds()}toFrequency(e){return new Ze(this.context,e).toFrequency()}toTicks(e){return new ds(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(s=>{Ke(e[s])&&delete t[s]}),t}get(){const e=Up(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const s=this[t];ne(s)&&ne(s.value)&&ne(s.setValueAtTime)?e[t]=s.value:s instanceof Fe?e[t]=s._getPartialProperties(e[t]):ze(s)||ft(s)||Nt(s)||Zr(s)?e[t]=s:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&ne(this[t])&&(this[t]&&ne(this[t].value)&&ne(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Fe?this[t].set(e[t]):this[t]=e[t])}),this}}class zs extends et{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,s){return Dt(t,0),this.add(Object.assign({},s,{state:e,time:t})),this}getLastState(e,t){const s=this._search(t);for(let a=s;a>=0;a--){const r=this._timeline[a];if(r.state===e)return r}}getNextState(e,t){const s=this._search(t);if(s!==-1)for(let a=s;a<this._timeline.length;a++){const r=this._timeline[a];if(r.state===e)return r}}}class _e extends Fe{constructor(){const e=se(_e.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,te(ne(e.param)&&(Xt(e.param)||e.param instanceof _e),"param must be an AudioParam");!Xt(e.param);)e.param=e.param._param;this._swappable=ne(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new et(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,ne(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Fe.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return ne(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return ne(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return ne(this.maxValue)&&ne(this.minValue)&&Dt(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?Hp(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?Jp(e):e}setValueAtTime(e,t){const s=this.toSeconds(t),a=this._fromType(e);return te(isFinite(a)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(a),this.log(this.units,"setValueAtTime",e,s),this._events.add({time:s,type:"setValueAtTime",value:a}),this._param.setValueAtTime(a,s),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),s=this._events.getAfter(t),a=this._events.get(t);let r=this._initialValue;if(a===null)r=this._initialValue;else if(a.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const c=this._events.getBefore(a.time);let l;c===null?l=this._initialValue:l=c.value,a.type==="setTargetAtTime"&&(r=this._exponentialApproach(a.time,l,a.value,a.constant,t))}else if(s===null)r=a.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let c=a.value;if(a.type==="setTargetAtTime"){const l=this._events.getBefore(a.time);l===null?c=this._initialValue:c=l.value}s.type==="linearRampToValueAtTime"?r=this._linearInterpolate(a.time,c,s.time,s.value,t):r=this._exponentialInterpolate(a.time,c,s.time,s.value,t)}else r=a.value;return this._toType(r)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const s=this._fromType(e),a=this.toSeconds(t);return te(isFinite(s)&&isFinite(a),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this._events.add({time:a,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",e,a),this._param.linearRampToValueAtTime(s,a),this}exponentialRampToValueAtTime(e,t){let s=this._fromType(e);s=nt(s,0)?this._minOutput:s,this._assertRange(s);const a=this.toSeconds(t);return te(isFinite(s)&&isFinite(a),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:a,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",e,a),this._param.exponentialRampToValueAtTime(s,a),this}exponentialRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(e,s+this.toSeconds(t)),this}linearRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(e,s+this.toSeconds(t)),this}targetRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(e,s,t),this}exponentialApproachValueAtTime(e,t,s){t=this.toSeconds(t),s=this.toSeconds(s);const a=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(e,t,a),this.cancelAndHoldAtTime(t+s*.9),this.linearRampToValueAtTime(e,t+s),this}setTargetAtTime(e,t,s){const a=this._fromType(e);te(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(t);return this._assertRange(a),te(isFinite(a)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:s,time:r,type:"setTargetAtTime",value:a}),this.log(this.units,"setTargetAtTime",e,r,s),this._param.setTargetAtTime(a,r,s),this}setValueCurveAtTime(e,t,s,a=1){s=this.toSeconds(s),t=this.toSeconds(t);const r=this._fromType(e[0])*a;this.setValueAtTime(this._toType(r),t);const c=s/(e.length-1);for(let l=1;l<e.length;l++){const o=this._fromType(e[l])*a;this.linearRampToValueAtTime(this._toType(o),t+l*c)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return te(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),s=this._fromType(this.getValueAtTime(t));te(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+s);const a=this._events.get(t),r=this._events.getAfter(t);return a&&nt(a.time,t)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),t):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),t)),this._events.add({time:t,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,t),this}rampTo(e,t=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,s):this.linearRampTo(e,t,s),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const s=this._events.get(t);if(s&&s.type==="setTargetAtTime"){const a=this._events.getAfter(s.time),r=a?a.time:t+2,c=(r-t)/10;for(let l=t;l<r;l+=c)e.linearRampToValueAtTime(this.getValueAtTime(l),l)}return this._events.forEachAfter(this.context.currentTime,a=>{a.type==="cancelScheduledValues"?e.cancelScheduledValues(a.time):a.type==="setTargetAtTime"?e.setTargetAtTime(a.value,a.time,a.constant):e[a.type](a.value,a.time)}),this}setParam(e){te(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,s,a,r){return s+(t-s)*Math.exp(-(r-e)/a)}_linearInterpolate(e,t,s,a,r){return t+(a-t)*((r-e)/(s-e))}_exponentialInterpolate(e,t,s,a,r){return t*Math.pow(a/t,(r-e)/(s-e))}}class ie extends Fe{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return ne(this.input)?Xt(this.input)||this.input instanceof _e?1:this.input.numberOfInputs:0}get numberOfOutputs(){return ne(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return ne(e)&&(e instanceof ie||It(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(s=>{s.channelCount=e.channelCount,s.channelCountMode=e.channelCountMode,s.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();te(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,s=0){return Ts(this,e,t,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Cn("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,s=0){return tf(this,e,t,s),this}chain(...e){return gi(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),ne(this.input)&&(this.input instanceof ie?this.input.dispose():It(this.input)&&this.input.disconnect()),ne(this.output)&&(this.output instanceof ie?this.output.dispose():It(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function gi(...n){const e=n.shift();n.reduce((t,s)=>(t instanceof ie?t.connect(s):It(t)&&Ts(t,s),s),e)}function Ts(n,e,t=0,s=0){for(te(ne(n),"Cannot connect from undefined node"),te(ne(e),"Cannot connect to undefined node"),(e instanceof ie||It(e))&&te(e.numberOfInputs>0,"Cannot connect to node with no inputs"),te(n.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof ie||e instanceof _e;)ne(e.input)&&(e=e.input);for(;n instanceof ie;)ne(n.output)&&(n=n.output);Xt(e)?n.connect(e,t):n.connect(e,t,s)}function tf(n,e,t=0,s=0){if(ne(e))for(;e instanceof ie;)e=e.input;for(;!It(n);)ne(n.output)&&(n=n.output);Xt(e)?n.disconnect(e,t):It(e)?n.disconnect(e,t,s):n.disconnect()}class Le extends ie{constructor(){const e=se(Le.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new _e({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),Ne(this,"gain")}static getDefaults(){return Object.assign(ie.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class fs extends ie{constructor(e){super(e),this.onended=ce,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Le({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const s=this.toSeconds(t);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(ie.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:ce})}_startGain(e,t=1){te(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=e+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+s):this._gainNode.gain.exponentialApproachValueAtTime(t,e,s)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){te(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==ce&&(this.onended(this),this.onended=ce,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),te(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=ce,this}}class Wi extends fs{constructor(){const e=se(Wi.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Ts(this._source,this._gainNode),this.offset=new _e({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(fs.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Oe extends ie{constructor(){const e=se(Oe.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Wi({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ie.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,s=0){return Bi(this,e,t,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,s){return this._param.exponentialRampTo(e,t,s),this}linearRampTo(e,t,s){return this._param.linearRampTo(e,t,s),this}targetRampTo(e,t,s){return this._param.targetRampTo(e,t,s),this}exponentialApproachValueAtTime(e,t,s){return this._param.exponentialApproachValueAtTime(e,t,s),this}setTargetAtTime(e,t,s){return this._param.setTargetAtTime(e,t,s),this}setValueCurveAtTime(e,t,s,a){return this._param.setValueCurveAtTime(e,t,s,a),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,s){return this._param.rampTo(e,t,s),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Bi(n,e,t,s){(e instanceof _e||Xt(e)||e instanceof Oe&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof Oe&&(e.overridden=!0)),Ts(n,e,t,s)}class Ui extends _e{constructor(){const e=se(Ui.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new et(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(_e.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,s){t=this.toSeconds(t),this.setRampPoint(t);const a=this._fromType(e),r=this._events.get(t),c=Math.round(Math.max(1/s,1));for(let l=0;l<=c;l++){const o=s*l+t,u=this._exponentialApproach(r.time,r.value,a,s,o);this.linearRampToValueAtTime(this._toType(u),o)}return this}setValueAtTime(e,t){const s=this.toSeconds(t);super.setValueAtTime(e,t);const a=this._events.get(s),r=this._events.previousEvent(a),c=this._getTicksUntilEvent(r,s);return a.ticks=Math.max(c,0),this}linearRampToValueAtTime(e,t){const s=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const a=this._events.get(s),r=this._events.previousEvent(a),c=this._getTicksUntilEvent(r,s);return a.ticks=Math.max(c,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const s=this._fromType(e),a=this._events.get(t),r=Math.round(Math.max((t-a.time)*10,1)),c=(t-a.time)/r;for(let l=0;l<=r;l++){const o=c*l+a.time,u=this._exponentialInterpolate(a.time,a.value,t,s,o);this.linearRampToValueAtTime(this._toType(u),o)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Ke(e.ticks)){const c=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(c,e.time)}const s=this._fromType(this.getValueAtTime(e.time));let a=this._fromType(this.getValueAtTime(t));const r=this._events.get(t);return r&&r.time===t&&r.type==="setValueAtTime"&&(a=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(s+a)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),s=this._events.get(t);return Math.max(this._getTicksUntilEvent(s,t),0)}getDurationOfTicks(e,t){const s=this.toSeconds(t),a=this.getTicksAtTime(t);return this.getTimeOfTick(a+e)-s}getTimeOfTick(e){const t=this._events.get(e,"ticks"),s=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&s&&s.type==="linearRampToValueAtTime"&&t.value!==s.value){const a=this._fromType(this.getValueAtTime(t.time)),c=(this._fromType(this.getValueAtTime(s.time))-a)/(s.time-t.time),l=Math.sqrt(Math.pow(a,2)-2*c*(t.ticks-e)),o=(-a+l)/c,u=(-a-l)/c;return(o>0?o:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const s=this.toSeconds(t),a=this.toSeconds(e),r=this.getTicksAtTime(s);return this.getTicksAtTime(s+a)-r}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class $i extends Oe{constructor(){const e=se($i.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Ui({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(Oe.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class Gi extends Fe{constructor(){const e=se(Gi.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new zs,this._tickOffset=new et,this._ticksAtTime=new et,this._secondsAtTime=new et,this.frequency=new $i({context:this.context,units:e.units,value:e.frequency}),Ne(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Fe.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const s=this.toSeconds(e);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),ne(t)&&this.setTicksAtTime(t,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const s=this._state.get(t);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),s=this._state.getLastState("stopped",t),a=this._ticksAtTime.get(t),r={state:"paused",time:t};this._state.add(r);let c=a||s,l=a?a.ticks:0,o=null;return this._state.forEachBetween(c.time,t+this.sampleTime,u=>{let h=c.time;const d=this._tickOffset.get(u.time);d&&d.time>=c.time&&(l=d.ticks,h=d.time),c.state==="started"&&u.state!=="started"&&(l+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(h),u.time!==r.time&&(o={state:u.state,time:u.time,ticks:l})),c=u}),this._state.remove(r),o&&this._ticksAtTime.add(o),l}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),s=this.frequency.timeToTicks(e,t);this.setTicksAtTime(s,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),s={state:"paused",time:e};this._state.add(s);const a=this._secondsAtTime.get(e);let r=a||t,c=a?a.seconds:0,l=null;return this._state.forEachBetween(r.time,e+this.sampleTime,o=>{let u=r.time;const h=this._tickOffset.get(o.time);h&&h.time>=r.time&&(c=h.seconds,u=h.time),r.state==="started"&&o.state!=="started"&&(c+=o.time-u,o.time!==s.time&&(l={state:o.state,time:o.time,seconds:c})),r=o}),this._state.remove(s),l&&this._secondsAtTime.add(l),c}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const s=this._tickOffset.get(t),a=this._state.get(t),r=Math.max(s.time,a.time),c=this.frequency.getTicksAtTime(r)+e-s.ticks;return this.frequency.getTimeOfTick(c)}forEachTickBetween(e,t,s){let a=this._state.get(e);this._state.forEachBetween(e,t,c=>{a&&a.state==="started"&&c.state!=="started"&&this.forEachTickBetween(Math.max(a.time,e),c.time-this.sampleTime,s),a=c});let r=null;if(a&&a.state==="started"){const c=Math.max(a.time,e),l=this.frequency.getTicksAtTime(c),o=this.frequency.getTicksAtTime(a.time),u=l-o;let h=Math.ceil(u)-u;h=nt(h,1)?0:h;let d=this.frequency.getTimeOfTick(l+h);for(;d<t;){try{s(d,Math.round(this.getTicksAtTime(d)))}catch(m){r=m;break}d+=this.frequency.getDurationOfTicks(1,d)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class In extends Fe{constructor(){const e=se(In.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=ce,this._lastUpdate=0,this._state=new zs("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new Gi({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Ne(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Fe.getDefaults(),{callback:ce,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){Kr(this.context);const s=this.toSeconds(e);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,t),s<this._lastUpdate&&this.emit("start",s,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const s=this.toSeconds(t),a=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(a+e,s)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,s=>{switch(s.state){case"started":const a=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,a);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(e,t,(s,a)=>{this.callback(s,a)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}$s.mixin(In);class ks extends ie{constructor(){const e=se(ks.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new Le({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,Ne(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(ie.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class zi extends ie{constructor(){const e=se(zi.getDefaults(),arguments);super(e),this.name="Destination",this.input=new ks({context:this.context}),this.output=new Le({context:this.context}),this.volume=this.input.volume,gi(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ie.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),gi(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}An(n=>{n.destination=new zi({context:n})});Mn(n=>{n.destination.dispose()});class sf extends ie{constructor(){super(...arguments),this.name="Listener",this.positionX=new _e({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new _e({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new _e({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new _e({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new _e({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new _e({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new _e({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new _e({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new _e({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ie.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}An(n=>{n.listener=new sf({context:n})});Mn(n=>{n.listener.dispose()});class Yi extends Tt{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=se(Yi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const s=e.urls[t];this.add(t,s,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:ce,onload:ce,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return te(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,s=ce,a=ce){return Nt(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new ve(this.baseUrl+t,s,a))):this._buffers.set(e.toString(),new ve(t,s,a)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class yn extends Ze{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return Ut(super._frequencyToUnits(e))}_ticksToUnits(e){return Ut(super._ticksToUnits(e))}_beatsToUnits(e){return Ut(super._beatsToUnits(e))}_secondsToUnits(e){return Ut(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return lo(this.toMidi())}transpose(e){return new yn(this.context,this.toMidi()+e)}}class Ee extends ds{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class nf extends Fe{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new et,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}An(n=>{n.draw=new nf({context:n})});Mn(n=>{n.draw.dispose()});class af extends Tt{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){te(ne(e.time),"Events must have a time property"),te(ne(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new rf(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const s of t)if(s.event===e){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let s,a=null;if(t>0)if(e.left.right===null)s=e.left,s.right=e.right,a=s;else{for(s=e.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,a=s.parent,s.left=e.left,s.right=e.right)}else if(e.right.left===null)s=e.right,s.left=e.left,a=s;else{for(s=e.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,a=s.parent,s.left=e.left,s.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=s:e.parent.right=s:this._setRoot(s),a&&this._rebalance(a)}e.dispose()}_rotateLeft(e){const t=e.parent,s=e.isLeftChild(),a=e.right;a&&(e.right=a.left,a.left=e),t!==null?s?t.left=a:t.right=a:this._setRoot(a)}_rotateRight(e){const t=e.parent,s=e.isLeftChild(),a=e.left;a&&(e.left=a.right,a.right=e),t!==null?s?t.left=a:t.right=a:this._setRoot(a)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let s=t[0];for(let a=1;a<t.length;a++)t[a].low>s.low&&(s=t[a]);return s.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(s=>t.push(s)),t.forEach(s=>{s.event&&e(s.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const s=[];this._root.search(e,s),s.forEach(a=>{a.event&&t(a.event)})}return this}forEachFrom(e,t){if(this._root!==null){const s=[];this._root.searchAfter(e,s),s.forEach(a=>{a.event&&t(a.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class rf{constructor(e,t,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class of extends Tt{constructor(e){super(),this.name="TimelineValue",this._timeline=new et({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class gs extends ie{constructor(){super(se(gs.getDefaults(),arguments,["context"]))}connect(e,t=0,s=0){return Bi(this,e,t,s),this}}class Ys extends gs{constructor(){const e=se(Ys.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,ze(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):Ip(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(Oe.getDefaults(),{length:1024})}setMap(e,t=1024){const s=new Float32Array(t);for(let a=0,r=t;a<r;a++){const c=a/(r-1)*2-1;s[a]=e(c,a)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(s=>s.includes(e));te(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Xi extends gs{constructor(){const e=se(Xi.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new Ys({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(gs.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class Pt{constructor(e,t){this.id=Pt._eventId++,this._remainderTime=0;const s=Object.assign(Pt.getDefaults(),t);this.transport=e,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:ce,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}Pt._eventId=0;class Hi extends Pt{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(Hi.getDefaults(),t);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},Pt.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return vn(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ee(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){vn(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ee(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);ps(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Dn extends Fe{constructor(){const e=se(Dn.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new of(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new et,this._repeatedEvents=new af,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new In({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),Ne(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Fe.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const s=t%(this._swingTicks*2)/(this._swingTicks*2),a=Math.sin(s*Math.PI)*this._swingAmount;e+=new Ee(this.context,this._swingTicks*2/3).toSeconds()*a}Va(!0),this._timeline.forEachAtTime(t,s=>s.invoke(e)),Va(!1)}schedule(e,t){const s=new Pt(this,{callback:e,time:new ds(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(e,t,s,a=1/0){const r=new Hi(this,{callback:e,duration:new it(this.context,a).toTicks(),interval:new it(this.context,t).toTicks(),time:new ds(this.context,s).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(e,t){const s=new Pt(this,{callback:e,once:!0,time:new ds(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(t,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new Ee(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let s;return ne(t)&&(s=this.toTicks(t)),this._clock.start(e,s),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){ze(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new it(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new it(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new Ee(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new Ee(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),s=this._clock.frequency.timeToTicks(e,t);this.ticks=s}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(t),a=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,t),r=t+a;this.emit("stop",r),this._clock.setTicksAtTime(e,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),s=this.getTicksAtTime(t),a=e-s%e;return this._clock.nextTickTime(a,t)}}syncSignal(e,t){const s=this.now();let a=this.bpm,r=1/(60/a.getValueAtTime(s)/this.PPQ),c=[];if(e.units==="time"){const o=.015625/r,u=new Le(o),h=new Xi(-1),d=new Le(o);a.chain(u,h,d),a=d,r=1/r,c=[u,h,d]}t||(e.getValueAtTime(s)!==0?t=e.getValueAtTime(s)/r:t=0);const l=new Le(t);return a.connect(l),l.connect(e._param),c.push(l),this._syncedSignals.push({initial:e.value,nodes:c,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const s=this._syncedSignals[t];s.signal===e&&(s.nodes.forEach(a=>a.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),io(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}$s.mixin(Dn);An(n=>{n.transport=new Dn({context:n})});Mn(n=>{n.transport.dispose()});class Qe extends ie{constructor(e){super(e),this.input=void 0,this._state=new zs("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=ce,this._syncedStop=ce,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new ks({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,Ne(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(ie.getDefaults(),{mute:!1,onstop:ce,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,s){let a=Ke(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(a=this._clampToCurrentTime(a),!this._synced&&this._state.getValueAtTime(a)==="started")te(ps(a,this._state.get(a).time),"Start time must be strictly greater than previous start time"),this._state.cancel(a),this._state.setStateAtTime("started",a),this.log("restart",a),this.restart(a,t,s);else if(this.log("start",a),this._state.setStateAtTime("started",a),this._synced){const r=this._state.get(a);r&&(r.offset=this.toSeconds(mt(t,0)),r.duration=s?this.toSeconds(s):void 0);const c=this.context.transport.schedule(l=>{this._start(l,t,s)},a);this._scheduled.push(c),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>a&&this._syncedStart(this.now(),this.context.transport.seconds)}else Kr(this.context),this._start(a,t,s);return this}stop(e){let t=Ke(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||ne(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const s=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(s)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,s){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(ps(t,0)){const s=this._state.get(t);if(s&&s.state==="started"&&s.time!==t){const a=t-this.toSeconds(s.time);let r;s.duration&&(r=this.toSeconds(s.duration)-a),this._start(e,this.toSeconds(s.offset)+a,r)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=ce,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class Pn extends fs{constructor(){const e=se(Pn.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Ts(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new _e({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new ve(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(fs.getDefaults(),{url:new ve,loop:!1,loopEnd:0,loopStart:0,onload:ce,onerror:ce,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,s,a=1){te(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(e);this._startGain(r,a),this.loop?t=mt(t,this.loopStart):t=mt(t,0);let c=Math.max(this.toSeconds(t),0);if(this.loop){const l=this.toSeconds(this.loopEnd)||this.buffer.duration,o=this.toSeconds(this.loopStart),u=l-o;fi(c,l)&&(c=(c-o)%u+o),nt(c,this.buffer.duration)&&(c=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,vn(c,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,c)),ne(s)){let l=this.toSeconds(s);l=Math.max(l,0),this.stop(r+l)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function ss(n,e){return Ae(this,void 0,void 0,function*(){const t=e/n.context.sampleRate,s=new Vi(1,t,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/t,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class Ji extends fs{constructor(){const e=se(Ji.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Ts(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new _e({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new _e({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),Ne(this,["frequency","detune"])}static getDefaults(){return Object.assign(fs.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Ce extends Qe{constructor(){const e=se(Ce.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),Ne(this,"frequency"),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),Ne(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(Qe.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),s=new Ji({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Ce._periodicWaveCache.find(t=>t.phase===this._phase&&Bp(t.partials,this._partials));{const e=Ce._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const s=this._getCachedPeriodicWave();if(ne(s)){const{partials:a,wave:r}=s;this._wave=r,this._partials=a,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[a,r]=this._getRealImaginary(e,this._phase),c=this.context.createPeriodicWave(a,r);this._wave=c,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Ce._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:a,type:this._type,wave:this._wave}),Ce._periodicWaveCache.length>100&&Ce._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Dt(e,0);let t=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(t=s[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const a=new Float32Array(e);this._partials.forEach((r,c)=>a[c]=r),this._partials=Array.from(a),this.type=this._type}}_getRealImaginary(e,t){let a=2048;const r=new Float32Array(a),c=new Float32Array(a);let l=1;if(e==="custom"){if(l=this._partials.length+1,this._partialCount=this._partials.length,a=l,this._partials.length===0)return[r,c]}else{const o=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);o?(l=parseInt(o[2],10)+1,this._partialCount=parseInt(o[2],10),e=o[1],l=Math.max(l,2),a=l):this._partialCount=0,this._partials=[]}for(let o=1;o<a;++o){const u=2/(o*Math.PI);let h;switch(e){case"sine":h=o<=l?1:0,this._partials[o-1]=h;break;case"square":h=o&1?2*u:0,this._partials[o-1]=h;break;case"sawtooth":h=u*(o&1?1:-1),this._partials[o-1]=h;break;case"triangle":o&1?h=2*(u*u)*(o-1>>1&1?-1:1):h=0,this._partials[o-1]=h;break;case"custom":h=this._partials[o-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}h!==0?(r[o]=-h*Math.sin(t*o),c[o]=h*Math.cos(t*o)):(r[o]=0,c[o]=0)}return[r,c]}_inverseFFT(e,t,s){let a=0;const r=e.length;for(let c=0;c<r;c++)a+=e[c]*Math.cos(c*s)+t[c]*Math.sin(c*s);return a}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let s=0;const a=Math.PI*2,r=32;for(let c=0;c<r;c++)s=Math.max(this._inverseFFT(e,t,c/r*a),s);return $p(-this._inverseFFT(e,t,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Ce._periodicWaveCache=[];class cf extends gs{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Ys({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class vs extends Oe{constructor(){const e=se(vs.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Le({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Oe.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class On extends Qe{constructor(){const e=se(On.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new cf({context:this.context}),this._modulationNode=new Le({context:this.context}),this._carrier=new Ce({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Ce({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new vs({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Ne(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Ce.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Rn extends Qe{constructor(){const e=se(Rn.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new Le({context:this.context,gain:0}),this._carrier=new Ce({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new Ce({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new vs({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new vs({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Ne(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Ce.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Xs extends Qe{constructor(){const e=se(Xs.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new Le({context:this.context,gain:0}),this._thresh=new Ys({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new Oe({context:this.context,units:"audioRange",value:e.width}),this._triangle=new Ce({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Ne(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Qe.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Fn extends Qe{constructor(){const e=se(Fn.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,Ne(this,["frequency","detune"])}static getDefaults(){return Object.assign(Ce.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,s=e/(this._oscillators.length-1);this._forEach((a,r)=>a.detune.value=t+s*r)}}get count(){return this._oscillators.length}set count(e){if(Dt(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const s=new Ce({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):ce});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[t]=s}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,s)=>t.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class Ln extends Qe{constructor(){const e=se(Ln.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new vs({context:this.context,value:2}),this._pulse=new Xs({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Ce({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Ne(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Qe.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const qa={am:On,fat:Fn,fm:Rn,oscillator:Ce,pulse:Xs,pwm:Ln};class _n extends Qe{constructor(){const e=se(_n.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),Ne(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(Ce.getDefaults(),Rn.getDefaults(),On.getDefaults(),Fn.getDefaults(),Xs.getDefaults(),Ln.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=qa[e],s=this.now();if(this._oscillator){const a=this._oscillator;a.stop(s),this.context.setTimeout(()=>a.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof qa[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&ft(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&ft(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Nt(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return Ae(this,arguments,void 0,function*(e=1024){return ss(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function uo(n,e=1/0){const t=new WeakMap;return function(s,a){Reflect.defineProperty(s,a,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Dt(r,n,e),t.set(this,r)}})}}function kt(n,e=1/0){const t=new WeakMap;return function(s,a){Reflect.defineProperty(s,a,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Dt(this.toSeconds(r),n,e),t.set(this,r)}})}}class Vn extends Qe{constructor(){const e=se(Vn.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new ve({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(Qe.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:ce,onerror:ce,playbackRate:1,reverse:!1})}load(e){return Ae(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=ce){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,s){return super.start(e,t,s),this}_start(e,t,s){this._loop?t=mt(t,this._loopStart):t=mt(t,0);const a=this.toSeconds(t),r=s;s=mt(s,Math.max(this._buffer.duration-a,0));let c=this.toSeconds(s);c=c/this._playbackRate,e=this.toSeconds(e);const l=new Pn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+c),this._state.setStateAtTime("stopped",e+c,{implicitEnd:!0})),this._activeSources.add(l),this._loop&&Ke(r)?l.start(e,a):l.start(e,a,c-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(s=>s.stop(t))}restart(e,t,s){return super.restart(e,t,s),this}_restart(e,t,s){var a;(a=[...this._activeSources].pop())===null||a===void 0||a.stop(e),this._start(e,t,s)}seek(e,t){const s=this.toSeconds(t);if(this._state.getValueAtTime(s)==="started"){const a=this.toSeconds(e);this._stop(s),this._start(s,a)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Dt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Dt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),s=this._state.getNextState("stopped",t);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(a=>a.cancelStop())),this._activeSources.forEach(a=>{a.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}ct([kt(0)],Vn.prototype,"fadeIn",void 0);ct([kt(0)],Vn.prototype,"fadeOut",void 0);class qt extends ie{constructor(){const e=se(qt.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new Oe({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(ie.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(Nt(e))return e;{let s;for(s in Qs)if(Qs[s][t]===e)return s;return e}}_setCurve(e,t,s){if(Nt(s)&&Reflect.has(Qs,s)){const a=Qs[s];Et(a)?e!=="_decayCurve"&&(this[e]=a[t]):this[e]=a}else if(ze(s)&&e!=="_decayCurve")this[e]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let a=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),c=this.getValueAtTime(e);if(c>0){const l=1/a;a=(1-c)/l}if(a<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,a,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,a,e);else{this._sig.cancelAndHoldAtTime(e);let l=this._attackCurve;for(let o=1;o<l.length;o++)if(l[o-1]<=c&&c<=l[o]){l=this._attackCurve.slice(o),l[0]=c;break}this._sig.setValueCurveAtTime(l,e,a,t)}if(r&&this.sustain<1){const l=t*this.sustain,o=e+a;this.log("decay",o),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(l,r+o):this._sig.exponentialApproachValueAtTime(l,o,r)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,e):(te(ze(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,s,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,s=1){return t=this.toSeconds(t),this.triggerAttack(t,s),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,s=0){return Bi(this,e,t,s),this}asArray(){return Ae(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,s=new Vi(1,t,this.context.sampleRate),a=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=a+this.toSeconds(this.release),c=r*.1,l=r+c,o=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/l,decay:t*this.toSeconds(this.decay)/l,release:t*this.toSeconds(this.release)/l,context:s}));return o._sig.toDestination(),o.triggerAttackRelease(t*(a+c)/l,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}ct([kt(0)],qt.prototype,"attack",void 0);ct([kt(0)],qt.prototype,"decay",void 0);ct([uo(0,1)],qt.prototype,"sustain",void 0);ct([kt(0)],qt.prototype,"release",void 0);const Qs=(()=>{let e,t;const s=[];for(e=0;e<128;e++)s[e]=Math.sin(e/127*(Math.PI/2));const a=[],r=6.4;for(e=0;e<127;e++){t=e/127;const m=Math.sin(t*(Math.PI*2)*r-Math.PI/2)+1;a[e]=m/10+t*.83}a[127]=1;const c=[],l=5;for(e=0;e<128;e++)c[e]=Math.ceil(e/127*l)/l;const o=[];for(e=0;e<128;e++)t=e/127,o[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const m=Math.pow(t,3)*4+.2,f=Math.cos(m*Math.PI*2*t);u[e]=Math.abs(f*(1-t))}function h(m){const f=new Array(m.length);for(let p=0;p<m.length;p++)f[p]=1-m[p];return f}function d(m){return m.slice(0).reverse()}return{bounce:{In:h(u),Out:u},cosine:{In:s,Out:d(s)},exponential:"exponential",linear:"linear",ripple:{In:a,Out:h(a)},sine:{In:o,Out:h(o)},step:{In:c,Out:h(c)}}})();class Ot extends ie{constructor(){const e=se(Ot.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new ks({context:this.context,volume:e.volume}),this.volume=this._volume.volume,Ne(this,"volume")}static getDefaults(){return Object.assign(ie.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const s=this["_original_"+e]=this[e];this[e]=(...a)=>{const r=a[t],c=this.context.transport.schedule(l=>{a[t]=l,s.apply(this,a)},r);this._scheduledEvents.push(c)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,s,a){const r=this.toSeconds(s),c=this.toSeconds(t);return this.triggerAttack(e,r,a),this.triggerRelease(r+c),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class Ht extends Ot{constructor(){const e=se(Ht.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(Ot.getDefaults(),{detune:0,onsilence:ce,portamento:0})}triggerAttack(e,t,s=1){this.log("triggerAttack",e,t,s);const a=this.toSeconds(t);return this._triggerEnvelopeAttack(a,s),this.setNote(e,a),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const s=this.toSeconds(t),a=e instanceof Ze?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(a,r,s)}else this.frequency.setValueAtTime(a,s);return this}}ct([kt(0)],Ht.prototype,"portamento",void 0);class Zi extends qt{constructor(){super(se(Zi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Le({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class ys extends Ht{constructor(){const e=se(ys.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new _n(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Zi(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),Ne(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(Ht.getDefaults(),{envelope:Object.assign(pi(qt.getDefaults(),Object.keys(ie.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(pi(_n.getDefaults(),[...Object.keys(Qe.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),a=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+s+a)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class qn extends ys{constructor(){const e=se(qn.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,Ne(this,["oscillator","envelope"])}static getDefaults(){return $t(Ht.getDefaults(),ys.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const s=this.toSeconds(t),a=this.toFrequency(e instanceof Ze?e.toFrequency():e),r=a*this.octaves;return this.oscillator.frequency.setValueAtTime(r,s),this.oscillator.frequency.exponentialRampToValueAtTime(a,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}ct([uo(0)],qn.prototype,"octaves",void 0);ct([kt(0)],qn.prototype,"pitchDecay",void 0);const ho=new Set;function Ki(n){ho.add(n)}function mo(n,e){const t=`registerProcessor("${n}", ${e})`;ho.add(t)}const lf=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Ki(lf);const uf=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Ki(uf);const df=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Ki(df);const hf="feedback-comb-filter",mf=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;mo(hf,mf);class Qi extends Ot{constructor(){const e=se(Qi.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=a=>this.releaseAll(a),te(!ft(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Ot.getDefaults(),{maxPolyphony:32,options:{},voice:ys})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(s=>s.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return te(e instanceof Ht,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else Cn("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,s){e.forEach(a=>{const r=new yn(this.context,a).toMidi(),c=this._getNextAvailableVoice();c&&(c.triggerAttack(a,t,s),this._activeVoices.push({midi:r,voice:c,released:!1}),this.log("triggerAttack",a,t))})}_triggerRelease(e,t){e.forEach(s=>{const a=new yn(this.context,s).toMidi(),r=this._activeVoices.find(({midi:c,released:l})=>c===a&&!l);r&&(r.voice.triggerRelease(t),r.released=!0,this.log("triggerRelease",s,t))})}_scheduleEvent(e,t,s,a){te(!this.disposed,"Synth was already disposed"),s<=this.now()?e==="attack"?this._triggerAttack(t,s,a):this._triggerRelease(t,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,s,a)},s-this.now())}triggerAttack(e,t,s){Array.isArray(e)||(e=[e]);const a=this.toSeconds(t);return this._scheduleEvent("attack",e,a,s),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const s=this.toSeconds(t);return this._scheduleEvent("release",e,s),this}triggerAttackRelease(e,t,s,a){const r=this.toSeconds(s);if(this.triggerAttack(e,r,a),ze(t)){te(ze(e),"If the duration is an array, the notes must also be an array"),e=e;for(let c=0;c<e.length;c++){const l=t[Math.min(c,t.length-1)],o=this.toSeconds(l);te(o>0,"The duration must be greater than 0"),this.triggerRelease(e[c],r+o)}}else{const c=this.toSeconds(t);te(c>0,"The duration must be greater than 0"),this.triggerRelease(e,r+c)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=pi(e,["onsilence","context"]);return this.options=$t(this.options,t),this._voices.forEach(s=>s.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Wn extends Ot{constructor(){const e=se(Wn.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(s=>{const a=parseInt(s,10);if(te(Ks(s)||ft(a)&&isFinite(a),`url key is neither a note or midi pitch: ${s}`),Ks(s)){const r=new Ze(this.context,s).toMidi();t[r]=e.urls[s]}else ft(a)&&isFinite(a)&&(t[a]=e.urls[a])}),this._buffers=new Yi({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(Ot.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:ce,onerror:ce,release:.1,urls:{}})}_findClosest(e){let s=0;for(;s<96;){if(this._buffers.has(e+s))return-s;if(this._buffers.has(e-s))return s;s++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,s=1){return this.log("triggerAttack",e,t,s),Array.isArray(e)||(e=[e]),e.forEach(a=>{const r=co(new Ze(this.context,a).toFrequency()),c=Math.round(r),l=r-c,o=this._findClosest(c),u=c-o,h=this._buffers.get(u),d=oo(o+l),m=new Pn({url:h,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:d}).connect(this.output);m.start(t,0,h.duration/d,s),ze(this._activeSources.get(c))||this._activeSources.set(c,[]),this._activeSources.get(c).push(m),m.onended=()=>{if(this._activeSources&&this._activeSources.has(c)){const f=this._activeSources.get(c),p=f.indexOf(m);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(s=>{const a=new Ze(this.context,s).toMidi();if(this._activeSources.has(a)&&this._activeSources.get(a).length){const r=this._activeSources.get(a);t=this.toSeconds(t),r.forEach(c=>{c.stop(t)}),this._activeSources.set(a,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,s,a=1){const r=this.toSeconds(s);return this.triggerAttack(e,r,a),ze(t)?(te(ze(e),"notes must be an array when duration is array"),e.forEach((c,l)=>{const o=t[Math.min(l,t.length-1)];this.triggerRelease(c,r+this.toSeconds(o))})):this.triggerRelease(e,r+this.toSeconds(t)),this}add(e,t,s){if(te(Ks(e)||isFinite(e),`note must be a pitch or midi: ${e}`),Ks(e)){const a=new Ze(this.context,e).toMidi();this._buffers.add(a,t,s)}else this._buffers.add(e,t,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}ct([kt(0)],Wn.prototype,"attack",void 0);ct([kt(0)],Wn.prototype,"release",void 0);class cs extends Fe{constructor(){const e=se(cs.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new zs("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Fe.getDefaults(),{callback:ce,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let s;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const a=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||ft(this._loop)&&this._loop>1){s=1/0,ft(this._loop)&&(s=this._loop*this._getLoopDuration());const r=this._state.getAfter(a);r!==null&&(s=Math.min(s,r.time-a)),s!==1/0&&(s=new Ee(this.context,s));const c=new Ee(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),c,new Ee(this.context,a),s)}else t.id=this.context.transport.schedule(this._tick.bind(this),new Ee(this.context,a))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const s=this._state.getBefore(t);let a=t;s!==null&&(a=s.time),this._rescheduleEvents(a)}return this}cancel(e){e=mt(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,s=>{this.context.transport.clear(s.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;Zr(this.humanize)||(s=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*s}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new Ee(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new Ee(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const s=this._getLoopDuration();return(e-t.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class bn extends cs{constructor(){const e=se(bn.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new zs("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{ze(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(cs.getDefaults(),{events:[]})}start(e,t){const s=this.toTicks(e);if(this._state.getValueAtTime(s)!=="started"){t=mt(t,this._loop?this._loopStart:0),this._loop?t=mt(t,this._loopStart):t=mt(t,0);const a=this.toTicks(t);this._state.add({id:-1,offset:a,state:"started",time:s}),this._forEach(r=>{this._startNote(r,s,a)})}return this}_startNote(e,t,s){t-=s,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<s&&(t+=this._getLoopDuration()),e.start(new Ee(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=s&&(e.loop=!1,e.start(new Ee(this.context,t))):e.startOffset>=s&&e.start(new Ee(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(s=>{s.stop(e)}),this}at(e,t){const s=new ds(this.context,e).toTicks(),a=new Ee(this.context,1).toSeconds(),r=this._events.values();let c=r.next();for(;!c.done;){const l=c.value;if(Math.abs(s-l.startOffset)<a)return ne(t)&&(l.value=t),l;c=r.next()}return ne(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const s=this.toTicks(e);let a;return t instanceof cs?(a=t,a.callback=this._tick.bind(this)):a=new cs({callback:this._tick.bind(this),context:this.context,value:t}),a.startOffset=s,a.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(a),this._restartEvent(a),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new Ee(this.context,t.time))})}remove(e,t){return Et(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(s=>{s.startOffset===e&&(Ke(t)||ne(t)&&s.value===t)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof bn?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(s=>{s[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new Ee(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new Ee(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class ea extends ie{constructor(){const e=se(ea.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new _e({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",Ne(this,"pan")}static getDefaults(){return Object.assign(ie.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const pf="bit-crusher",ff=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;mo(pf,ff);class ke extends ie{constructor(){const e=se(ke.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new Le({context:this.context}),ke._allSolos.has(this.context)||ke._allSolos.set(this.context,new Set),ke._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(ie.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),ke._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){ke._soloed.has(this.context)||ke._soloed.set(this.context,new Set),ke._soloed.get(this.context).add(this)}_removeSolo(){ke._soloed.has(this.context)&&ke._soloed.get(this.context).delete(this)}_isSoloed(){return ke._soloed.has(this.context)&&ke._soloed.get(this.context).has(this)}_noSolos(){return!ke._soloed.has(this.context)||ke._soloed.has(this.context)&&ke._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),ke._allSolos.get(this.context).delete(this),this._removeSolo(),this}}ke._allSolos=new Map;ke._soloed=new Map;class ta extends ie{constructor(){const e=se(ta.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new ea({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new ks({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,Ne(this,["pan","volume"])}static getDefaults(){return Object.assign(ie.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class ls extends ie{constructor(){const e=se(ls.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new ke({solo:e.solo,context:this.context}),this._panVol=this.output=new ta({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Ne(this,["pan","volume"])}static getDefaults(){return Object.assign(ie.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return ls.buses.has(e)||ls.buses.set(e,new Le({context:this.context})),ls.buses.get(e)}send(e,t=0){const s=this._getBus(e),a=new Le({context:this.context,units:"decibels",gain:t});return this.connect(a),a.connect(s),a}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}ls.buses=new Map;Je().transport;function _t(){return Je().transport}Je().destination;Je().destination;function gf(){return Je().destination}Je().listener;Je().draw;const vf=Je();class yf{constructor(e={}){dt(this,"synth",null);dt(this,"part",null);dt(this,"isPlaying",!1);dt(this,"isPaused",!1);dt(this,"duration",0);dt(this,"options");dt(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);const a=this.parseMIDIToNotes(s);this.synth||(this.synth=new Qi(ys,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new bn((r,c)=>{this.synth?.triggerAttackRelease(c.name,c.duration,r,c.velocity)},a),this.duration=this.calculateDuration(a),this.part.loop=!1}catch(t){const s=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(s),s}}parseMIDIToNotes(e){const t=[],s=["C4","D4","E4","F4","G4","A4","B4","C5"];let a=0;for(let r=0;r<16;r++)t.push({time:`${a}`,name:s[r%s.length],duration:"4n",velocity:.7}),a+=.5;return t}calculateDuration(e){if(e.length===0)return 0;const t=e[e.length-1],s=parseFloat(t.time),r={"1n":2,"2n":1,"4n":.5,"8n":.25,"16n":.125}[t.duration]||.5;return s+r}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await ro(),this.isPaused?(_t().start(),this.isPaused=!1):(this.part.start(0),_t().start()),this.isPlaying=!0,this.startProgressTracking(),_t().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(_t().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){_t().stop(),_t().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));_t().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:_t().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=_t().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let Qn=null;function _f(){return Qn||(Qn=new yf),Qn}const bf=({album:n,isPlaying:e,currentTime:t,duration:s,onPlayPause:a,onExpand:r})=>{if(!n)return null;const c=s>0?Math.max(0,Math.min(1,t/s)):0,l=o=>{o.stopPropagation()};return i.jsxs("div",{className:"spotify-square-dock",role:"button",tabIndex:0,"aria-label":"プレイヤーを開く",onClick:r,onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),r())},"data-no-swipe":!0,children:[i.jsx("img",{className:"spotify-square-dock-art",src:n.imageDataURL,alt:n.title||n.mood,draggable:!1}),i.jsx("div",{className:"spotify-square-dock-overlay","aria-hidden":"true"}),i.jsx("button",{className:"spotify-square-dock-play",onClick:o=>{l(o),a()},onMouseDown:l,onTouchStart:l,"aria-label":e?"一時停止":"再生",title:e?"一時停止":"再生",children:e?"⏸":"▶"}),i.jsx("div",{className:"spotify-square-dock-progress","aria-hidden":"true",children:i.jsx("div",{className:"spotify-square-dock-progressFill",style:{width:`${Math.round(c*100)}%`}})}),i.jsx("div",{className:"spotify-square-dock-hint","aria-hidden":"true",children:i.jsx("div",{className:"spotify-square-dock-title",children:n.title||n.mood})})]})},xf=({isPlaying:n,canPrevious:e,canNext:t,shuffle:s,repeat:a,onPlayPause:r,onPrevious:c,onNext:l,onShuffle:o,onRepeat:u,expanded:h=!1})=>{const d=()=>i.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:i.jsx("polygon",{points:"8,6 8,18 18,12"})}),m=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),i.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),f=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),i.jsx("polygon",{points:"18,6 10,12 18,18"})]}),p=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("polygon",{points:"6,6 14,12 6,18"}),i.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),g=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),i.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),y=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("path",{d:"M7 7h10v4"}),i.jsx("path",{d:"M17 17H7v-4"}),i.jsx("path",{d:"M17 7l3 3-3 3"}),i.jsx("path",{d:"M7 17l-3-3 3-3"})]});return i.jsxs("div",{className:`playback-controls ${h?"expanded":""}`,children:[h&&i.jsx("button",{className:`control-button secondary ${s?"active":""}`,onClick:o,"aria-label":"Shuffle",title:"Shuffle",children:i.jsx(g,{})}),i.jsx("button",{className:"control-button",onClick:c,disabled:!e,"aria-label":"Previous",title:"Previous track",children:i.jsx(f,{})}),i.jsx("button",{className:"control-button primary",onClick:r,"aria-label":n?"Pause":"Play",title:n?"Pause":"Play",children:n?i.jsx(m,{}):i.jsx(d,{})}),i.jsx("button",{className:"control-button",onClick:l,disabled:!t,"aria-label":"Next",title:"Next track",children:i.jsx(p,{})}),h&&i.jsxs("button",{className:`control-button secondary ${a!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${a}`,title:`Repeat: ${a}`,children:[i.jsx(y,{}),a==="one"&&i.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},wf=({currentTime:n,duration:e,onSeek:t,color:s="#D4AF37"})=>{const[a,r]=w.useState(!1),c=w.useRef(null),l=f=>{if(!isFinite(f)||f<0)return"0:00";const p=Math.floor(f/60),g=Math.floor(f%60);return`${p}:${g.toString().padStart(2,"0")}`},o=f=>{if(!c.current||e===0)return;const p=c.current.getBoundingClientRect(),g=f-p.left,_=Math.max(0,Math.min(1,g/p.width))*e;t(_)},u=f=>{r(!0),o(f.clientX)},h=f=>{a&&o(f.clientX)},d=()=>{r(!1)};V.useEffect(()=>{if(a)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",d),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",d)}},[a]);const m=e>0?n/e*100:0;return i.jsxs("div",{className:"seek-bar-container",children:[i.jsx("span",{className:"seek-time current",children:l(n)}),i.jsx("div",{ref:c,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":n,children:i.jsx("div",{className:"seek-progress",style:{width:`${m}%`,background:`linear-gradient(90deg, ${s}cc, ${s})`},children:i.jsx("div",{className:"seek-thumb"})})}),i.jsx("span",{className:"seek-time total",children:l(e)})]})},Nf=({volume:n,isMuted:e,onVolumeChange:t,onMuteToggle:s,expanded:a=!1})=>{const[r,c]=w.useState(!1),l=w.useRef(null),o=e||n===0?"muted":n<.5?"low":"high",u=p=>{if(!l.current)return;const g=l.current.getBoundingClientRect(),y=p-g.left,_=Math.max(0,Math.min(1,y/g.width));t(_)},h=p=>{c(!0),u(p.clientX)},d=p=>{r&&u(p.clientX)},m=()=>{c(!1)};V.useEffect(()=>{if(r)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",m),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",m)}},[r]);const f=e?0:n;return i.jsxs("div",{className:`volume-control ${a?"expanded":""}`,children:[i.jsxs("button",{className:`volume-icon ${o}`,onClick:s,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[i.jsx("span",{className:"volume-core"}),i.jsx("span",{className:"volume-wave wave-1"}),i.jsx("span",{className:"volume-wave wave-2"})]}),i.jsx("div",{ref:l,className:"volume-slider",onMouseDown:h,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(f*100),children:i.jsx("div",{className:"volume-fill",style:{width:`${f*100}%`},children:i.jsx("div",{className:"volume-thumb"})})})]})},Sf=({queue:n,currentIndex:e,onSkipTo:t})=>{const s=n.slice(e+1,e+4);if(s.length===0)return null;const a=r=>{const c=Math.floor(r/60),l=Math.floor(r%60);return`${c}:${l.toString().padStart(2,"0")}`};return i.jsxs("div",{className:"queue-preview",children:[i.jsx("div",{className:"queue-label",children:"Up Next"}),i.jsx("div",{className:"queue-items",children:s.map((r,c)=>i.jsx("div",{className:"queue-item",onClick:()=>t(e+c+1),role:"button",tabIndex:0,onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t(e+c+1))},children:i.jsx(zt,{variant:"compact",className:"queue-album-card",title:r.title||r.mood,mood:r.mood,imageUrl:r.imageDataURL,meta:a(r.musicMetadata?.duration||r.duration),badges:[...r.musicData?[{label:"再生",tone:"success"}]:[],...r.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...r.isPublic?[{label:"公開",tone:"info"}]:[]]})},r.id))})]})};class jf{static draw(e,t,s,a,r,c){const l=this.smoothData(t);this.drawGrid(e,s,a),e.lineWidth=3,e.strokeStyle=this.getGradient(e,r,s),e.shadowBlur=c?8:4,e.shadowColor=r,e.beginPath();const o=s/l.length;let u=0;for(let h=0;h<l.length;h++){const m=l[h]/128*a/2;if(h===0)e.moveTo(u,m);else{const f=(u+o*h)/2,p=(m+l[h-1]/128*a/2)/2;e.quadraticCurveTo(u,l[h-1]/128*a/2,f,p)}u=o*h}e.lineTo(s,a/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-a),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let a=0;a<e.length;a++){let r=0,c=0;for(let l=-3;l<=3;l++){const o=a+l;o>=0&&o<e.length&&(r+=e[o],c++)}t.push(r/c)}return t}static drawGrid(e,t,s){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const a=5;for(let r=0;r<a;r++){const c=s/(a-1)*r;e.beginPath(),e.moveTo(0,c),e.lineTo(t,c),e.stroke()}}static getGradient(e,t,s){const a=e.createLinearGradient(0,0,s,0);return a.addColorStop(0,t),a.addColorStop(.5,this.lightenColor(t,20)),a.addColorStop(1,t),a}static lightenColor(e,t){const s=parseInt(e.replace("#",""),16),a=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+a),c=Math.min(255,(s>>8&255)+a),l=Math.min(255,(s&255)+a);return`#${(r<<16|c<<8|l).toString(16).padStart(6,"0")}`}}class po{static draw(e,t,s,a,r,c){const d=(s-640)/2,m=Math.floor(t.length/64),f=[];for(let y=0;y<64;y++){let _=0;for(let C=0;C<m;C++){const I=y*m+C;I<t.length&&(_+=t[I])}const S=_/m;f.push(S)}const p=this.smoothTransitions(f),g=this.createBarGradient(e,r,64,10,d);for(let y=0;y<64;y++){const _=d+y*10,S=p[y]/255*(a*.4);e.fillStyle=g,this.drawRoundedBar(e,_,a/2-S,8,S,4),c&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,_,a/2+2,8,S*.5,4),e.restore()),e.shadowBlur=c?4:0,e.shadowColor=r}e.shadowBlur=0,c&&this.drawParticles(e,p,d,10,a,r)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],s=.7;for(let a=0;a<e.length;a++){const r=this.previousHeights[a]||0,c=e[a],l=r*s+c*(1-s);t.push(l)}return this.previousHeights=t,t}static drawRoundedBar(e,t,s,a,r,c){e.beginPath(),e.moveTo(t,s+r),e.lineTo(t,s+c),e.arcTo(t,s,t+a,s,c),e.lineTo(t+a,s+c),e.arcTo(t+a,s,t+a,s+r,c),e.lineTo(t+a,s+r),e.closePath(),e.fill()}static createBarGradient(e,t,s,a,r){const c=e.createLinearGradient(r,0,r+s*a,0);return c.addColorStop(0,t),c.addColorStop(.5,this.adjustHue(t,30)),c.addColorStop(1,this.adjustHue(t,60)),c}static drawParticles(e,t,s,a,r,c){for(let o=0;o<t.length;o++)if(t[o]>200){const u=s+o*a+a/2,h=t[o]/255*(r*.4),d=r/2-h-10;e.fillStyle=c,e.globalAlpha=.5,e.beginPath(),e.arc(u,d,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const s=parseInt(e.replace("#",""),16),a=s>>16&255,r=s>>8&255,c=s&255,l=1+t/360,o=Math.min(255,a*l),u=Math.min(255,r*l),h=Math.min(255,c*l);return`#${(Math.floor(o)<<16|Math.floor(u)<<8|Math.floor(h)).toString(16).padStart(6,"0")}`}}dt(po,"previousHeights",[]);class fo{static draw(e,t,s,a,r,c){const l=s/2,o=a/2,u=Math.min(s,a)*.15,h=Math.min(s,a)*.45;c&&(this.rotation+=360/(60*60));const d=Math.min(t.length,180),m=Math.PI*2/d;for(let f=0;f<d;f++){const p=t[Math.floor(f*(t.length/d))],g=p/255*(h-u),y=f*m+this.rotation*(Math.PI/180),_=l+Math.cos(y)*u,S=o+Math.sin(y)*u,C=l+Math.cos(y)*(u+g),I=o+Math.sin(y)*(u+g),b=f/d*360;if(e.strokeStyle=`hsla(${b}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(_,S),e.lineTo(C,I),e.stroke(),c&&p>200){const N=l+Math.cos(y)*(u+g+5),j=o+Math.sin(y)*(u+g+5);e.fillStyle=`hsla(${b}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(N,j,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.arc(l,o,u,0,Math.PI*2),e.stroke(),c){const f=this.getAverageAmplitude(t),p=h+f/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=r,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=r,e.beginPath(),e.arc(l,o,p,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let s=0;s<e.length;s++)t+=e[s];return t/e.length}}dt(fo,"rotation",0);const Tf=({mode:n,frequencyData:e,timeDomainData:t,isPlaying:s,dominantColor:a="#D4AF37",width:r=800,height:c=200,mini:l=!1})=>{const o=w.useRef(null),u=w.useRef(null),h=w.useRef(0);return w.useEffect(()=>{const d=o.current;if(!d)return;const m=d.getContext("2d");if(!m)return;const f=l?1:Math.min(window.devicePixelRatio||1,2);d.width=r*f,d.height=c*f,d.style.width=`${r}px`,d.style.height=`${c}px`,m.scale(f,f);const g=1e3/(l?30:60),y=_=>{if(_-h.current<g){u.current=requestAnimationFrame(y);return}h.current=_,m.clearRect(0,0,r,c),n==="waveform"&&t?jf.draw(m,t,r,c,a,s):n==="spectrum"&&e?po.draw(m,e,r,c,a,s):n==="radial"&&e&&fo.draw(m,e,r,c,a,s),u.current=requestAnimationFrame(y)};return u.current=requestAnimationFrame(y),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[n,e,t,s,a,r,c,l]),i.jsx("canvas",{ref:o,style:{display:"block",margin:"0 auto",borderRadius:l?"4px":"8px"}})},kf=({tags:n,centerX:e,centerY:t,isPlaying:s})=>{const[a,r]=w.useState([]),c=w.useRef(null),l=w.useRef(Date.now());w.useEffect(()=>{const u=[220,260,300,340,380],h=[12,10,8,6,4],d=n.map((f,p)=>360/n.length*p),m=n.slice(0,5).map((f,p)=>({text:f,radius:u[p]||300,speed:h[p]||8,angle:d[p]||0,scale:1,opacity:.6}));r(m)},[n]),w.useEffect(()=>{if(!s){c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}const u=()=>{const h=Date.now(),d=(h-l.current)/1e3;l.current=h,r(m=>m.map((f,p)=>{let g=f.angle+f.speed*d;g=g%360;const y=p*.5,S=1+Math.sin((h/3e3+y)*Math.PI*2)*.05,C=.55+Math.sin((h/3e3+y)*Math.PI*2)*.15;return{...f,angle:g,scale:S,opacity:C}})),c.current=requestAnimationFrame(u)};return c.current=requestAnimationFrame(u),()=>{c.current!==null&&cancelAnimationFrame(c.current)}},[s]);const o=u=>u*Math.PI/180;return i.jsx("div",{className:"motif-orbit",children:a.map((u,h)=>{const d=e+u.radius*Math.cos(o(u.angle)),m=t+u.radius*Math.sin(o(u.angle));return i.jsx("div",{className:"motif-tag",style:{left:`${d}px`,top:`${m}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${h}`)})})},Cf=({album:n,isPlaying:e,currentTime:t,duration:s,volume:a,isMuted:r,shuffle:c,repeat:l,canPrevious:o,canNext:u,visualizationMode:h,queue:d,queueIndex:m,frequencyData:f,timeDomainData:p,onPlayPause:g,onPrevious:y,onNext:_,onSeek:S,onVolumeChange:C,onMuteToggle:I,onShuffle:b,onRepeat:N,onVisualizationModeChange:j,onSkipToIndex:v,onClose:x})=>{const{updateAlbum:M}=wt(),E=n?.id||null,[D,R]=w.useState("");w.useEffect(()=>{R(n?.memo||"")},[E]),w.useEffect(()=>{const L=B=>{B.key==="Escape"?x():B.key===" "&&B.target===document.body?(B.preventDefault(),g()):B.key==="ArrowLeft"?S(Math.max(0,t-5)):B.key==="ArrowRight"?S(Math.min(s,t+5)):B.key==="ArrowUp"?C(Math.min(1,a+.1)):B.key==="ArrowDown"?C(Math.max(0,a-.1)):B.key==="m"||B.key==="M"?I():B.key==="n"||B.key==="N"?_():(B.key==="p"||B.key==="P")&&y()};return document.addEventListener("keydown",L),()=>document.removeEventListener("keydown",L)},[t,s,a,x,g,S,C,I,_,y]);const T="#D4AF37",F=n?.metadata?.motif_tags||[],q=w.useMemo(()=>"メモ（ひとこと）。聴きながら思い出したこと、今の気分、景色…",[]);return i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"expanded-player-backdrop",onClick:x}),i.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[i.jsx("button",{className:"expanded-player-close",onClick:x,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),i.jsx("button",{className:"expanded-player-minimize",onClick:x,"aria-label":"Minimize player",title:"Minimize",children:"-"}),i.jsxs("div",{className:"expanded-player-content",children:[i.jsxs("div",{className:"expanded-player-album-section",children:[i.jsx("div",{className:"expanded-player-album-container",children:n&&i.jsxs(i.Fragment,{children:[i.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"expanded-player-album-image"}),F.length>0&&i.jsx(kf,{tags:F,centerX:200,centerY:200,isPlaying:e})]})}),n&&i.jsxs("div",{className:"expanded-player-album-meta",children:[i.jsx("h2",{className:"expanded-player-album-title",children:n.title||n.mood}),n.musicMetadata&&i.jsxs("p",{className:"expanded-player-album-details",children:[n.musicMetadata.key," • ",n.musicMetadata.tempo," BPM • ",n.musicMetadata.timeSignature]}),n.musicMetadata?.character&&i.jsx("p",{className:"expanded-player-album-character",children:n.musicMetadata.character}),i.jsxs("div",{className:"expanded-player-memo",children:[i.jsx("div",{className:"expanded-player-memo-label",children:"メモ"}),i.jsx("textarea",{className:"expanded-player-memo-input",value:D,onChange:L=>R(L.target.value),onBlur:()=>{if(!n)return;const L=D.trim();(n.memo||"")!==L&&M(n.id,{memo:L||void 0})},placeholder:q,rows:2})]})]})]}),i.jsxs("div",{className:"expanded-player-visualization-section",children:[i.jsx(Tf,{mode:h,frequencyData:f,timeDomainData:p,isPlaying:e,dominantColor:T,width:800,height:200}),i.jsxs("div",{className:"visualization-mode-toggle",children:[i.jsx("button",{className:h==="waveform"?"active":"",onClick:()=>j("waveform"),title:"Waveform",children:"波形"}),i.jsx("button",{className:h==="spectrum"?"active":"",onClick:()=>j("spectrum"),title:"Spectrum Bars",children:"バー"}),i.jsx("button",{className:h==="radial"?"active":"",onClick:()=>j("radial"),title:"Radial Spectrum",children:"円形"})]})]}),i.jsxs("div",{className:"expanded-player-controls-section",children:[i.jsx(xf,{isPlaying:e,canPrevious:o,canNext:u,shuffle:c,repeat:l,onPlayPause:g,onPrevious:y,onNext:_,onShuffle:b,onRepeat:N,expanded:!0}),i.jsx(wf,{currentTime:t,duration:s,onSeek:S,color:T}),i.jsx(Nf,{volume:a,isMuted:r,onVolumeChange:C,onMuteToggle:I,expanded:!0})]}),i.jsx(Sf,{queue:d,currentIndex:m,onSkipTo:v})]})]})]})},Af=({album:n,queue:e=[]})=>{const{state:t,setPlaybackState:s,setCurrentTime:a,setDuration:r,setVolume:c,toggleMute:l,toggleShuffle:o,cycleRepeat:u,toggleExpanded:h,setVisualizationMode:d,play:m,pause:f,next:p,previous:g,skipToIndex:y,setQueue:_,setCurrentAlbumFull:S}=Rt(),C=w.useRef(_f()),I=w.useRef(null),b=w.useRef(null),N=w.useRef(null),j=w.useRef(null),v=w.useRef(0),x=w.useRef(0),[M,E]=w.useState(null),[D,R]=w.useState(null);w.useEffect(()=>((async()=>{try{await ro();const A=vf.createAnalyser();A.fftSize=2048,A.smoothingTimeConstant=.8,gf().connect(A),I.current=A,b.current=new Uint8Array(A.frequencyBinCount),N.current=new Uint8Array(A.frequencyBinCount)}catch(A){console.error("Failed to initialize analyser:",A)}})(),()=>{if(I.current)try{I.current.disconnect()}catch{}}),[]),w.useEffect(()=>{if(e.length>0){const P=n?e.findIndex(A=>A.id===n.id):0;_(e,Math.max(0,P))}else n&&_([n],0)},[n,e,_]),w.useEffect(()=>{const P=t.currentAlbum||n;P?.musicData&&(T(P),S(P))},[t.currentAlbum?.id,n?.id]),w.useEffect(()=>{t.playRequestId>0&&(v.current=t.playRequestId)},[t.playRequestId]),w.useEffect(()=>{const P=t.currentAlbum||n,A=v.current;if(!P?.musicData||A===0||A===x.current)return;let W=!1;return(async()=>{try{if(await T(P),W)return;await F(),x.current=A}catch(Z){console.error("[EnhancedMiniPlayer] Autoplay failed:",Z)}})(),()=>{W=!0}},[t.currentAlbum?.id,n?.id,t.playRequestId]),w.useEffect(()=>{if(t.playbackState===ht.PLAYING&&I.current){let P;const A=()=>{!I.current||!b.current||!N.current||(I.current.getByteFrequencyData(b.current),I.current.getByteTimeDomainData(N.current),E(new Uint8Array(b.current)),R(new Uint8Array(N.current)),P=requestAnimationFrame(A))};return P=requestAnimationFrame(A),()=>{P&&cancelAnimationFrame(P)}}},[t.playbackState]);const T=async P=>{try{const A=C.current;await A.loadMIDI(P.musicData);const W=A.getState();r(W.duration)}catch(A){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",A)}},F=async()=>{try{s(ht.LOADING);const P=C.current;await P.play(),m();const A=window.setInterval(()=>{const W=P.getState();a(W.currentTime),r(W.duration),!W.isPlaying&&!W.isPaused&&(clearInterval(A),L())},100);j.current=A}catch(P){console.error("Failed to start playback:",P),s(ht.STOPPED)}},q=()=>{C.current.pause(),f(),j.current&&(clearInterval(j.current),j.current=null)},L=()=>{t.repeat==="one"?(H(0),F()):G()},B=()=>{t.playbackState===ht.PLAYING?q():F()},G=()=>{p(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},X=()=>{g(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},H=P=>{C.current.seek(P),a(P)},K=P=>{c(P)},$=P=>{y(P),requestAnimationFrame(()=>{requestAnimationFrame(()=>{F()})})},Q=t.queueIndex>0||t.repeat==="all",O=t.queueIndex<t.queue.length-1||t.repeat==="all",k=t.playbackState===ht.PLAYING;return w.useEffect(()=>()=>{j.current&&clearInterval(j.current)},[]),i.jsxs(i.Fragment,{children:[!t.isExpanded&&i.jsx(bf,{album:t.currentAlbum,isPlaying:k,currentTime:t.currentTime,duration:t.duration,onPlayPause:B,onExpand:h}),t.isExpanded&&i.jsx(Cf,{album:t.currentAlbum,isPlaying:k,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:Q,canNext:O,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:M,timeDomainData:D,onPlayPause:B,onPrevious:X,onNext:G,onSeek:H,onVolumeChange:K,onMuteToggle:l,onShuffle:o,onRepeat:u,onVisualizationModeChange:d,onSkipToIndex:$,onClose:h})]})};function Mf(){const{state:n}=Rt(),e=!!n.currentAlbumImage&&(n.playbackState===ht.PLAYING||n.playbackState===ht.PAUSED),t=w.useMemo(()=>`${n.currentAlbum?.id||"none"}:${n.playbackState}`,[n.currentAlbum?.id,n.playbackState]),[s,a]=w.useState(!1);return w.useEffect(()=>{const r=window.setTimeout(()=>a(e),e?40:0);return()=>window.clearTimeout(r)},[e]),n.currentAlbumImage?i.jsx("div",{className:`playback-backdrop ${s?"is-active":""} ${n.playbackState===ht.PLAYING?"is-playing":""}`,style:{backgroundImage:`url(${n.currentAlbumImage})`},"aria-hidden":"true"},t):null}function Ef(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function If(){try{new Function('return import("web-vitals")')().then(e=>{const t=s=>{console.log("[Web Vitals]",s)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}function Df(){const n=document.createElement("script");n.type="module",n.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const e=document.createElement("script");e.type="module",e.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(n),document.head.appendChild(e)}Ef(),If(),Df();const Pf="airia_onboarding_data",Of="airia_theme",Wa="airia_post_onboarding_room",At="airia_preauth_view_v1";function Ba(){try{const n=String(window.location.hash||"").trim().toLowerCase();return n==="#terms"?"terms":n==="#privacy"?"privacy":n==="#login"||n==="#signup"?"auth":null}catch{return null}}function Rf(){try{const n=localStorage.getItem(Of),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n||"system",s=t==="system"?e?"dark":"light":t;document.documentElement.setAttribute("data-theme",s)}catch{document.documentElement.setAttribute("data-theme","light")}}function Ua(){try{if(Ms())return!1;const n=localStorage.getItem(Pf);return n?!!JSON.parse(n)?.completedAt:!1}catch{return!1}}function Ff(){try{const n=localStorage.getItem(Wa);if(!n)return null;localStorage.removeItem(Wa);const e=String(n);return["main","gallery","album","music","social","me","settings","admin","info","feedback"].includes(e)?e:null}catch{return null}}const Lf=()=>{const[n,e]=w.useState(!0),[t,s]=w.useState(()=>{try{const b=Ba();if(b)return b;const N=sessionStorage.getItem(At);return N==="auth"||N==="terms"||N==="privacy"?N:"landing"}catch{return"landing"}}),[a,r]=w.useState(()=>{try{return Ua()}catch{return!1}}),{getSelectedAlbum:c,albums:l}=wt(),{state:o}=Rt(),{user:u,bootLoading:h}=xn(),d=c();w.useEffect(()=>{const b=()=>{const N=Ba();if(N){s(N);try{sessionStorage.setItem(At,N)}catch{}return}try{const v=sessionStorage.getItem(At)==="auth"?"auth":"landing";s(v),sessionStorage.setItem(At,v)}catch{s("landing")}};return window.addEventListener("hashchange",b),()=>window.removeEventListener("hashchange",b)},[]);const m=V.useCallback(()=>{s("auth");try{sessionStorage.setItem(At,"auth"),window.location.hash="#login"}catch{}},[]),f=V.useCallback(()=>{s("landing");try{sessionStorage.setItem(At,"landing"),window.location.hash=""}catch{}},[]),p=V.useCallback(()=>{s("terms");try{sessionStorage.setItem(At,"terms"),window.location.hash="#terms"}catch{}},[]),g=V.useCallback(()=>{s("privacy");try{sessionStorage.setItem(At,"privacy"),window.location.hash="#privacy"}catch{}},[]);w.useEffect(()=>{Rf()},[]);const y=l.filter(b=>b.musicData),_=!!(Es()||"".toLowerCase()==="true"),S=a?[{id:"main",name:"Main",component:i.jsx(Gc,{})},{id:"gallery",name:"Gallery",component:i.jsx(Jc,{})},{id:"album",name:"Album",component:i.jsx(sl,{})},{id:"music",name:"Music",component:i.jsx(nl,{})},{id:"social",name:"Social",component:i.jsx(hl,{})},{id:"me",name:"My",component:i.jsx(gl,{})},..._?[{id:"admin",name:"Admin",component:i.jsx(_l,{})}]:[],{id:"info",name:"Info",component:i.jsx(Nl,{})},{id:"feedback",name:"Feedback",component:i.jsx(Sl,{})}]:[{id:"onboarding",name:"はじめに",component:i.jsx(Oc,{onExit:()=>{r(Ua())}})}],C=a?Ff()??"main":null,I=a?C==="settings"?"me":C:"onboarding";return i.jsxs(i.Fragment,{children:[n&&i.jsx(jl,{onDismiss:()=>e(!1)}),!n&&i.jsxs(i.Fragment,{children:[i.jsx(Mf,{}),i.jsx("div",{className:"app-ui-layer",children:h?i.jsx("div",{className:"preauth-shell",children:i.jsx("div",{className:"loading-panel","aria-live":"polite","aria-busy":"true",children:i.jsx("div",{className:"loading-card",children:i.jsxs("div",{className:"loading-row",children:[i.jsx("div",{className:"loading-spinner","aria-hidden":"true"}),i.jsxs("div",{children:[i.jsx("p",{className:"loading-title",children:"ログイン状態を確認しています…"}),i.jsx("p",{className:"loading-sub",children:"通信環境によっては時間がかかる場合があります。画面はこのままでお待ちください。"})]})]})})})}):u?i.jsxs(i.Fragment,{children:[i.jsx(tc,{rooms:S,initialRoom:I},a?"onboarded":"needs-onboarding"),i.jsx(Af,{album:d||void 0,queue:y})]}):i.jsx("div",{className:"preauth-shell",children:t==="auth"?i.jsx(Fc,{onBack:f}):t==="terms"?i.jsx(va,{kind:"terms",onBack:f,onStart:m}):t==="privacy"?i.jsx(va,{kind:"privacy",onBack:f,onStart:m}):i.jsx(Lc,{onStart:m,onOpenTerms:p,onOpenPrivacy:g})})})]})]})},Vf=()=>i.jsx(V.StrictMode,{children:i.jsx(Yo,{children:i.jsx(Oo,{children:i.jsx(Bo,{children:i.jsx(Eo,{children:i.jsx($o,{children:i.jsx(Go,{children:i.jsx(Lf,{})})})})})})})});Mo.createRoot(document.getElementById("root")).render(i.jsx(Vf,{}));
//# sourceMappingURL=index-tmk-Jnvj.js.map
