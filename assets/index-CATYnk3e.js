var xo=Object.defineProperty;var wo=(n,e,t)=>e in n?xo(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var lt=(n,e,t)=>wo(n,typeof e!="symbol"?e+"":e,t);import{r as w,j as i,R as F,a as No,C as gs,u as Ht,B as Ds,V as _n,L as So,b as jo,c as sa,M as To,d as ko,T as Co,S as Ao,e as na,f as Qn,g as Eo}from"./vendor-three-l38Icqav.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const Un=n=>{if(!n)return 30;const e=20,t=60,s=30,a=180,r=Math.max(s,Math.min(a,n));return e+(r-s)/(a-s)*(t-e)},ia=n=>{const t=Math.floor(n/10),s=n%10;return{shelfIndex:Math.min(t,4),positionIndex:s}},$n=n=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let s=0;s<n.length;s++)t=(t<<5)-t+n.charCodeAt(s),t=t&t;return e[Math.abs(t)%e.length]},$a=w.createContext(void 0),aa="airia-albums",Mo=({children:n})=>{const[e,t]=w.useState([]),[s,a]=w.useState(null);w.useEffect(()=>{try{const u=localStorage.getItem(aa);if(u){const d=JSON.parse(u);t(d)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),w.useEffect(()=>{try{localStorage.setItem(aa,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const r=u=>{const d={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()},h=ia(0),g=Un(d.musicMetadata?.duration),f=$n(d.imageDataURL),p={...d,gallery:{shelfIndex:h.shelfIndex,positionIndex:h.positionIndex,thickness:g,spineColor:f}};return t(m=>[p,...m].map((y,x)=>{const S=ia(x),A=Un(y.musicMetadata?.duration),b=y.gallery?.spineColor||$n(y.imageDataURL);return{...y,gallery:{shelfIndex:S.shelfIndex,positionIndex:S.positionIndex,thickness:A,spineColor:b}}})),p},o=(u,d)=>{t(h=>h.map(g=>{if(g.id!==u)return g;const f={...g,...d};if(d.imageDataURL){const p=f.gallery?.spineColor||$n(f.imageDataURL);return{...f,gallery:{...f.gallery||{shelfIndex:0,positionIndex:0,thickness:Un(f.musicMetadata?.duration),spineColor:p},spineColor:p}}}return f}))},l=u=>{a(u)},c=()=>s&&e.find(u=>u.id===s)||null;return i.jsx($a.Provider,{value:{albums:e,selectedAlbumId:s,addAlbum:r,updateAlbum:o,selectAlbum:l,getSelectedAlbum:c},children:n})},xt=()=>{const n=w.useContext($a);if(n===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return n},Ga=w.createContext(void 0),Gn="airia-causal-logs",Io=30;function Do(n){return n&&{mood:n.mood,duration:n.duration,timestamp:n.timestamp,customInput:n.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:n.onboardingAnswers?"[onboarding data - summary only]":void 0}}function Oo(n){const e=new Date;return e.setDate(e.getDate()-Io),n.filter(t=>new Date(t.createdAt)>=e)}const Ro=({children:n})=>{const[e,t]=w.useState([]);w.useEffect(()=>{try{const h=localStorage.getItem(Gn);if(h){const f=JSON.parse(h).map(m=>({...m,createdAt:new Date(m.createdAt),input:{...m.input,timestamp:new Date(m.input.timestamp)},analysis:m.analysis?{...m.analysis,timestamp:new Date(m.analysis.timestamp)}:void 0,imageGeneration:m.imageGeneration?{...m.imageGeneration,timestamp:new Date(m.imageGeneration.timestamp)}:void 0,musicGeneration:m.musicGeneration?{...m.musicGeneration,timestamp:new Date(m.musicGeneration.timestamp)}:void 0,album:m.album?{...m.album,timestamp:new Date(m.album.timestamp)}:void 0,errors:m.errors?.map(_=>({..._,timestamp:new Date(_.timestamp)}))})),p=Oo(f);t(p)}}catch(h){console.error("[CausalLog] Failed to load logs from localStorage:",h)}},[]),w.useEffect(()=>{try{localStorage.setItem(Gn,JSON.stringify(e))}catch(h){console.error("[CausalLog] Failed to save logs to localStorage:",h)}},[e]);const s=(h,g)=>{const f=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,p={id:f,sessionId:h,createdAt:new Date,input:Do(g),totalDuration:0,success:!1};return t(m=>[...m,p]),console.log("[CausalLog] Created log:",f,"for session:",h),f},a=h=>e.find(g=>g.id===h),r=h=>e.find(g=>g.sessionId===h),o=(h,g)=>{t(f=>f.map(p=>{if(p.id===h){const m={...p,...g};if(m.analysis||m.imageGeneration||m.musicGeneration){const _=[m.analysis?.duration||0,m.imageGeneration?.duration||0,m.musicGeneration?.duration||0];m.totalDuration=_.reduce((y,x)=>y+x,0)}return m}return p})),console.log("[CausalLog] Updated log:",h)},l=h=>{t(g=>g.filter(f=>f.id!==h)),console.log("[CausalLog] Deleted log:",h)},c=()=>{t([]),localStorage.removeItem(Gn),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(h=>({id:h.id,sessionId:h.sessionId,createdAt:h.createdAt,success:h.success,totalDuration:h.totalDuration,albumId:h.album?.albumId})),d=h=>{const g=a(h);if(!g)throw new Error(`Log ${h} not found`);return JSON.stringify(g,null,2)};return i.jsx(Ga.Provider,{value:{logs:e,createLog:s,getLog:a,getLogBySessionId:r,updateLog:o,deleteLog:l,clearAllLogs:c,getLogSummaries:u,exportLog:d},children:n})},za=()=>{const n=w.useContext(Ga);if(n===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return n},Xt="https://airia-beyond.onrender.com",ei="airia_auth_token_v1";function ti(){try{return String(localStorage.getItem(ei)||"")}catch{return""}}function ts(n){try{n?localStorage.setItem(ei,n):localStorage.removeItem(ei)}catch{}}async function Ke(n,e={}){const t=ti(),s=new Headers(e.headers||{});return t&&s.set("Authorization",`Bearer ${t}`),fetch(n,{...e,headers:s})}async function Jt(n){return n.json().catch(()=>null)}async function Po(n){const e=await fetch(`${Xt}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Jt(e);if(!e.ok)throw new Error(t?.message||`Failed to register: ${e.status}`);return t}async function Fo(n){const e=await fetch(`${Xt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Jt(e);if(!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);return t}async function Lo(n){const e=await fetch(`${Xt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Jt(e);if(!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);return t}async function ra(n,e){const t=await fetch(`${Xt}/api/auth/oauth/${encodeURIComponent(n)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await Jt(t);if(!t.ok)throw new Error(s?.message||`Failed to login: ${t.status}`);return s}async function Vo(){const n=await Ke(`${Xt}/api/auth/me`),e=await Jt(n);if(!n.ok)throw new Error(e?.message||`Failed to load me: ${n.status}`);return e}async function qo(){const n=await Ke(`${Xt}/api/auth/logout`,{method:"POST"}),e=await Jt(n);if(!n.ok)throw new Error(e?.message||`Failed to logout: ${n.status}`);return e}async function Wo(n){const e=await Ke(`${Xt}/api/auth/me`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await Jt(e);if(!e.ok)throw new Error(t?.message||`Failed to update profile: ${e.status}`);return t}const Ya=F.createContext(null);function Os(){const n=F.useContext(Ya);if(!n)throw new Error("useAuth must be used within AuthProvider");return n}const Bo=({children:n})=>{const[e,t]=F.useState(null),[s,a]=F.useState(!0),[r,o]=F.useState(()=>ti()),l=F.useCallback(async()=>{const _=ti();if(o(_),!_){t(null),a(!1);return}try{const y=await Vo();t(y.user),y.user||(ts(null),o(""))}catch{t(null)}finally{a(!1)}},[]);F.useEffect(()=>{l()},[l]);const c=F.useCallback(async _=>{a(!0);try{const y=await ra("google",{idToken:_});ts(y.token),o(y.token),t(y.user)}finally{a(!1)}},[]),u=F.useCallback(async(_,y)=>{a(!0);try{const x=await ra("apple",{idToken:_,user:y||void 0});ts(x.token),o(x.token),t(x.user)}finally{a(!1)}},[]),d=F.useCallback(async _=>{a(!0);try{const y=String(_?.identifier||"").trim(),x=String(_?.password||""),S=y.includes("@")?await Lo({email:y,password:x}):await Fo({handle:y,password:x});ts(S.token),o(S.token),t(S.user)}finally{a(!1)}},[]),h=F.useCallback(async _=>{a(!0);try{const y=String(_?.email||"").trim(),x=String(_?.password||""),S=_?.displayName,A=_?.handle,b=await Po({email:y,password:x,displayName:S,handle:A});ts(b.token),o(b.token),t(b.user)}finally{a(!1)}},[]),g=F.useCallback(async()=>{a(!0);try{await qo().catch(()=>null)}finally{ts(null),o(""),t(null),a(!1)}},[]),f=F.useCallback(async _=>{a(!0);try{const y=await Wo(_);t(y.user)}finally{a(!1)}},[]),p=F.useCallback(_=>{t(y=>y&&{...y,followingIds:Array.isArray(_)?_:[]})},[]),m={user:e,loading:s,token:r,refresh:l,loginWithGoogle:c,loginWithApple:u,loginWithPassword:d,registerWithPassword:h,logout:g,updateProfile:f,updateFollowingIds:p};return i.jsx(Ya.Provider,{value:m,children:n})};var ut=(n=>(n.STOPPED="STOPPED",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.LOADING="LOADING",n))(ut||{});const Ha=w.createContext(void 0),Uo=.7,$o=({children:n})=>{const[e,t]=w.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:Uo,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),s=w.useCallback(v=>{t(N=>({...N,playbackState:v?"PLAYING":"PAUSED"}))},[]),a=w.useCallback((v,N)=>{t(E=>({...E,currentAlbumImage:v,currentTrackTitle:N}))},[]),r=w.useCallback(v=>{t(N=>({...N,playbackState:v}))},[]),o=w.useCallback(v=>{t(N=>({...N,currentAlbum:v,currentAlbumImage:v?.imageDataURL,currentTrackTitle:v?v.title||v.mood:void 0}))},[]),l=w.useCallback((v,N=0)=>{t(E=>({...E,queue:v,queueIndex:N,currentAlbum:v[N]||null,currentAlbumImage:v[N]?.imageDataURL,currentTrackTitle:v[N]?v[N].title||v[N].mood:void 0}))},[]),c=w.useCallback(v=>{t(N=>({...N,currentTime:v}))},[]),u=w.useCallback(v=>{t(N=>({...N,duration:v}))},[]),d=w.useCallback(v=>{const N=Math.max(0,Math.min(1,v));t(E=>({...E,volume:N}))},[]),h=w.useCallback(()=>{t(v=>({...v,isMuted:!v.isMuted}))},[]),g=w.useCallback(()=>{t(v=>({...v,shuffle:!v.shuffle}))},[]),f=w.useCallback(()=>{t(v=>{const N=["off","all","one"],O=(N.indexOf(v.repeat)+1)%N.length;return{...v,repeat:N[O]}})},[]),p=w.useCallback(()=>{t(v=>({...v,isExpanded:!v.isExpanded}))},[]),m=w.useCallback(v=>{t(N=>({...N,isExpanded:v}))},[]),_=w.useCallback(v=>{t(N=>({...N,visualizationMode:v}))},[]),y=w.useCallback((v,N)=>{t(E=>{const O=N&&N.length>0?N:E.queue,M=O.length>0?O:[v],D=Math.max(0,M.findIndex(L=>L.id===v.id)),k=M[D]||v;return{...E,queue:M,queueIndex:D,currentAlbum:k,currentAlbumImage:k.imageDataURL,currentTrackTitle:k.title||k.mood,currentTime:0,playRequestId:E.playRequestId+1,isExpanded:!0}})},[]),x=w.useCallback(()=>{t(v=>({...v,playbackState:"PLAYING"}))},[]),S=w.useCallback(()=>{t(v=>({...v,playbackState:"PAUSED"}))},[]),A=w.useCallback(()=>{t(v=>({...v,playbackState:"STOPPED",currentTime:0}))},[]),b=w.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;let N=v.queueIndex+1;if(N>=v.queue.length)if(v.repeat==="all")N=0;else return{...v,playbackState:"STOPPED"};const E=v.queue[N];return{...v,queueIndex:N,currentAlbum:E,currentAlbumImage:E.imageDataURL,currentTrackTitle:E.mood,currentTime:0}})},[]),T=w.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;if(v.currentTime>3)return{...v,currentTime:0};let N=v.queueIndex-1;if(N<0)if(v.repeat==="all")N=v.queue.length-1;else return v;const E=v.queue[N];return{...v,queueIndex:N,currentAlbum:E,currentAlbumImage:E.imageDataURL,currentTrackTitle:E.mood,currentTime:0}})},[]),j=w.useCallback(v=>{t(N=>{if(v<0||v>=N.queue.length)return N;const E=N.queue[v];return{...N,queueIndex:v,currentAlbum:E,currentAlbumImage:E.imageDataURL,currentTrackTitle:E.mood,currentTime:0}})},[]);return i.jsx(Ha.Provider,{value:{state:e,setPlaying:s,setCurrentAlbum:a,setPlaybackState:r,setCurrentAlbumFull:o,setQueue:l,setCurrentTime:c,setDuration:u,setVolume:d,toggleMute:h,toggleShuffle:g,cycleRepeat:f,toggleExpanded:p,setExpanded:m,setVisualizationMode:_,requestPlayAlbum:y,play:x,pause:S,stop:A,next:b,previous:T,skipToIndex:j},children:n})},Ot=()=>{const n=w.useContext(Ha);if(!n)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return n},Xa=w.createContext(void 0),vs=()=>{const n=w.useContext(Xa);if(!n)throw new Error("useToast must be used within ToastProvider");return n},Go=({children:n})=>{const[e,t]=w.useState([]),s=w.useCallback((r,o,l=4e3)=>{const c=`toast-${Date.now()}-${Math.random()}`,u={id:c,type:r,message:o,duration:l};t(h=>[...h,u]);const d=setTimeout(()=>{a(c)},l);return()=>clearTimeout(d)},[]),a=w.useCallback(r=>{t(o=>o.filter(l=>l.id!==r))},[]);return i.jsxs(Xa.Provider,{value:{toasts:e,addToast:s,removeToast:a},children:[n,i.jsx(zo,{toasts:e})]})},zo=({toasts:n})=>i.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:n.map(e=>i.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[i.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),i.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class Yo extends w.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(a=>{a.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?i.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[i.jsx("h1",{children:"エラーが発生しました"}),i.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),i.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const Ja=w.createContext(void 0),Ho=({value:n,children:e})=>i.jsx(Ja.Provider,{value:n,children:e}),pt=()=>{const n=w.useContext(Ja);if(!n)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return n},Za=({open:n,onOpenChange:e,title:t,description:s,children:a,footer:r,size:o="md"})=>{const l=w.useId(),c=w.useId();return w.useEffect(()=>{if(!n)return;const u=d=>{d.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[n,e]),n?No.createPortal(i.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[i.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),i.jsxs("div",{className:`dialog-surface dialog-${o}`,role:"dialog","aria-modal":"true","aria-labelledby":l,"aria-describedby":s?c:void 0,children:[i.jsxs("header",{className:"dialog-header",children:[i.jsxs("div",{children:[i.jsx("h2",{id:l,className:"dialog-title",children:t}),s&&i.jsx("p",{id:c,className:"dialog-description",children:s})]}),i.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),i.jsx("div",{className:"dialog-body",children:a}),r?i.jsx("footer",{className:"dialog-footer",children:r}):null]})]}),document.body):null},oa="airia_feedback_nudge_open_count_v1",ca="airia_feedback_nudge_last_shown_at_v1";function Xo(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function Jo(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Zo(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function Ko(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function Qo(n){return n?(Date.now()-n)/(24*60*60*1e3):Number.POSITIVE_INFINITY}const ec=()=>{const{currentRoomId:n,navigateToRoom:e}=pt(),[t,s]=F.useState(!1),a=F.useRef(null);F.useEffect(()=>{if(n==="onboarding"||n==="feedback")return;const o=Xo(oa)+1;Jo(oa,o);const l=Zo(ca);if(Qo(l)<10||o<4)return;const u=o<10?.05:.08;if(!(Math.random()>u))return a.current=window.setTimeout(()=>{document.visibilityState==="visible"&&(Ko(ca,Date.now()),s(!0))},7e3),()=>{a.current&&window.clearTimeout(a.current),a.current=null}},[n]);const r=()=>{s(!1),e("feedback")};return i.jsx(Za,{open:t,onOpenChange:s,title:"フィードバックしませんか？",description:"短くてOK。気づいたことを教えてください。",size:"sm",footer:i.jsxs(i.Fragment,{children:[i.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>s(!1),children:"今はしない"}),i.jsx("button",{type:"button",className:"btn btn-primary",onClick:r,children:"書く"})]}),children:i.jsx("p",{style:{margin:0,lineHeight:1.7},children:"バグ報告・改善案・良かった点、どれでも歓迎です。 送信時に診断情報も添付できるので、原因調査が早くなります。"})})},tc=({rooms:n,initialRoom:e="main"})=>{const t=n.findIndex(k=>k.id===e),[s,a]=w.useState(t>=0?t:0),[r,o]=w.useState(!1),[l,c]=w.useState(0),[u,d]=w.useState(0),[h,g]=w.useState(0),[f,p]=w.useState(null),m=w.useRef(null),_=k=>k instanceof Element?!!k.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,y=k=>{_(k.target)||(o(!0),c(k.touches[0].clientX),d(k.touches[0].clientY),p(null))},x=k=>{if(!r)return;const L=k.touches[0].clientX,V=k.touches[0].clientY,R=L-l,B=V-u;if(!f){const Y=Math.abs(R),H=Math.abs(B);if(Y<6&&H<6)return;if(H>Y*1.2){p("vertical"),o(!1),g(0);return}p("horizontal")}f==="horizontal"&&(k.preventDefault(),g(R))},S=()=>{if(!r)return;o(!1),Math.abs(h)>100&&(h>0&&s>0?a(s-1):h<0&&s<n.length-1&&a(s+1)),g(0),p(null)},A=k=>{_(k.target)||(o(!0),c(k.clientX),d(k.clientY),p(null))},b=k=>{if(!r)return;k.preventDefault();const L=k.clientX-l,V=k.clientY-u;if(!f){const R=Math.abs(L),B=Math.abs(V);if(R<6&&B<6)return;if(B>R*1.2){p("vertical"),o(!1),g(0);return}p("horizontal")}f==="horizontal"&&g(L)},T=()=>{if(!r)return;o(!1),Math.abs(h)>100&&(h>0&&s>0?a(s-1):h<0&&s<n.length-1&&a(s+1)),g(0),p(null)},j=()=>{r&&(Math.abs(h)>100&&(h>0&&s>0?a(s-1):h<0&&s<n.length-1&&a(s+1)),o(!1),g(0),p(null))},v=k=>{a(k),g(0)},N=m.current?.clientWidth||window.innerWidth||1,E=-s*100+h/N*100,O=n[s]?.id,M=O!=="onboarding",D=k=>{const L=n.findIndex(V=>V.id===k);L>=0&&v(L)};return i.jsxs(Ho,{value:{currentRoomId:O,navigateToRoom:D},children:[i.jsx(ec,{}),i.jsxs("div",{className:`room-navigator ${M?"":"indicators-hidden"}`,children:[M&&i.jsx("div",{className:"room-indicators","aria-label":"ルームナビゲーション",children:n.map((k,L)=>i.jsx("button",{className:`room-indicator ${L===s?"active":""}`,onClick:()=>v(L),"aria-current":L===s?"page":void 0,"aria-label":`${k.name}へ移動`,children:i.jsx("span",{className:"room-indicator-label",children:k.name})},k.id))}),i.jsx("div",{ref:m,className:"rooms-container",onTouchStart:y,onTouchMove:x,onTouchEnd:S,onMouseDown:A,onMouseMove:b,onMouseUp:T,onMouseLeave:j,style:{transform:`translateX(${E}%)`,transition:r?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:n.map(k=>i.jsx("div",{className:"room",children:k.component},k.id))})]})]})},la="airia_onboarding_data",sc=[{value:"talk",title:"会話から",desc:"やさしく整えてから、次へ"},{value:"create",title:"創作から",desc:"早く作品に進みたい"}],nc=[{value:"今日",title:"今日",desc:"いちばん最近の出来事"},{value:"今週",title:"今週",desc:"数日の範囲"},{value:"今月",title:"今月",desc:"少し長め"},{value:"少し前",title:"少し前",desc:"はっきりしない/覚えてない"}],ic=[{value:"朝",title:"朝",desc:"スタートを整えたい"},{value:"昼",title:"昼",desc:"途中で乱れやすい"},{value:"夕方",title:"夕方",desc:"疲れが出やすい"},{value:"夜",title:"夜",desc:"余韻が残る/考えが巡る"}],ua=[{value:"穏やか",title:"穏やか",desc:"静か/落ち着く"},{value:"嬉しい",title:"嬉しい",desc:"軽い高揚/前向き"},{value:"不安",title:"不安",desc:"ざわつく/心配"},{value:"疲れ",title:"疲れ",desc:"消耗/休みたい"}],ac=[{value:"達成/うまくいった",title:"達成",desc:"うまくいった/進んだ"},{value:"不確実/心配",title:"心配",desc:"先が読めない/不確実"},{value:"人間関係",title:"人",desc:"誰かとのやり取り"},{value:"体力/睡眠",title:"体",desc:"寝不足/疲労/体調"}],rc=[{value:"仕事/学業",title:"仕事",desc:"締切/評価/責任"},{value:"人間関係",title:"人間関係",desc:"距離感/言葉/空気"},{value:"体調/睡眠",title:"体調",desc:"疲れ/睡眠/コンディション"},{value:"SNS/情報",title:"情報",desc:"比較/ニュース/刺激"}],oc=[{value:"評価や期待が気になる",title:"評価",desc:"期待に応えたい/怖い"},{value:"比較してしまう",title:"比較",desc:"周りと比べて落ちる"},{value:"疲れると増幅する",title:"疲労",desc:"体力が落ちると不安が増える"},{value:"言語化できず溜まる",title:"未消化",desc:"うまく言えず残る"}],cc=[{value:"落ち着いて集中したい",title:"集中",desc:"静かに深く入りたい"},{value:"安心して眠りたい",title:"眠り",desc:"夜にほどけたい"},{value:"不安を小さくしたい",title:"安心",desc:"ざわつきを鎮めたい"},{value:"気分を切り替えたい",title:"切替",desc:"短時間で整えたい"}],lc=[{value:"1週間以内",title:"1週間",desc:"短期で変えたい"},{value:"1ヶ月以内",title:"1ヶ月",desc:"少しずつ整える"},{value:"3ヶ月以内",title:"3ヶ月",desc:"習慣化したい"},{value:"長期的",title:"長期",desc:"ゆっくり育てる"}],uc=({onComplete:n,onProgressChange:e})=>{const[t,s]=w.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),a={key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"choices",options:sc},r={key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"choices",options:nc},o={key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"choices",options:ua},l={key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"一番近い理由を選んでください。",kind:"choices",options:ac},c={key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"choices",options:ic},u={key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"choices",options:ua},d={key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"一番近いものを選んでください。",kind:"choices",options:rc},h={key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"一番近いものを選んでください。",kind:"choices",options:oc},g={key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"choices",options:cc},f={key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"choices",options:lc},p=F.useMemo(()=>t.startMode==="create"?[a,o,g,f]:[a,r,o,l,c,u,d,h,g,f],[t.startMode]),[m,_]=w.useState(0),y=p.length;w.useEffect(()=>{m>p.length-1&&_(Math.max(0,p.length-1))},[m,p.length]),w.useEffect(()=>{const v=y>0?m/y:0;e?.(Math.min(v,.999))},[m,y,e]),w.useEffect(()=>{const v=localStorage.getItem(la);if(v)try{const N=JSON.parse(v);s(N)}catch(N){console.error("Failed to parse saved onboarding data:",N)}},[]);const x=v=>{localStorage.setItem(la,JSON.stringify(v))},S=(v,N)=>{const E={...t,[v]:N};s(E),x(E),m<y-1&&_(m+1)},A=()=>{m<y-1&&(x(t),_(m+1))},b=()=>{m>0&&(x(t),_(m-1))},T=()=>{const N={...t,recentMomentWhen:t.recentMomentWhen||"最近",dailyPatternWhen:t.dailyPatternWhen||(t.startMode==="create"?"夜":""),recentMomentEmotion:t.recentMomentEmotion||t.dailyPatternEmotion,dailyPatternEmotion:t.dailyPatternEmotion||t.recentMomentEmotion,recentMomentWhy:t.recentMomentWhy||"未指定",emotionalTrigger:t.emotionalTrigger||"未指定",emotionalTriggerWhy:t.emotionalTriggerWhy||"未指定",emotionalGoal:t.emotionalGoal||"落ち着いて集中したい",emotionalGoalTimeframe:t.emotionalGoalTimeframe||"1ヶ月以内",completedAt:new Date().toISOString()};s(N),x(N),n&&n(N)},j=()=>{const v=p[m];return String(t[v.key]??"").trim().length>0};return i.jsxs("div",{className:"onboarding-form",children:[i.jsxs("div",{className:"onboarding-header",children:[i.jsx("h2",{className:"blend-text",children:"はじめに"}),i.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),i.jsx("div",{className:"progress-bar",children:i.jsx("div",{className:"progress-fill",style:{width:`${(m+1)/y*100}%`}})}),i.jsxs("p",{className:"step-indicator",children:["ステップ ",m+1," / ",y]})]}),i.jsx("div",{className:"question-container",children:(()=>{const v=p[m];return i.jsxs("div",{className:"question-step",children:[i.jsx("h3",{className:"question-title",children:v.title}),v.description?i.jsx("p",{className:"question-description",children:v.description}):null,i.jsx("div",{className:"form-group",children:i.jsx("div",{className:"choice-grid",role:"group","aria-label":v.title,children:v.options.map(N=>{const O=String(t[v.key]??"")===N.value;return i.jsxs("button",{type:"button",className:`choice-btn ${O?"is-selected":""}`,onClick:()=>S(v.key,N.value),"aria-pressed":O,children:[i.jsx("div",{className:"choice-title",children:N.title}),N.desc?i.jsx("div",{className:"choice-desc",children:N.desc}):null]},N.value)})})})]})})()}),i.jsx("div",{className:"onboarding-actions","data-no-swipe":"true","aria-label":"オンボーディング操作",children:i.jsxs("div",{className:"button-group",children:[m>0&&i.jsx("button",{className:"btn btn-secondary",onClick:b,type:"button",children:"← 戻る"}),m<y-1?i.jsx("button",{className:"btn btn-primary",onClick:A,disabled:!j(),type:"button",children:"次へ →"}):i.jsx("button",{className:"btn btn-success",onClick:T,disabled:!j(),type:"button",children:"完了"})]})})]})},dc=({isActive:n})=>{const e=w.useRef(null),t=w.useRef(null);Ht(c=>{if(!e.current)return;e.current.rotation.z+=n?.002:.001;const u=Math.sin(c.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=n?.6:.3)});const s=[],a=5,r=50,o=a*r;for(let c=0;c<o;c++){const u=c/r,d=u*Math.PI*2,h=u*.5;s.push(new _n(Math.cos(d)*h,Math.sin(d)*h,u*.1))}const l=new Ds().setFromPoints(s);return i.jsx("line",{ref:e,geometry:l,children:i.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},hc=({isActive:n=!1})=>i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(gs,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(dc,{isActive:n})]})}),mc=({isActive:n})=>{const e=w.useRef(null),t=w.useRef(null);Ht(u=>{if(!e.current)return;e.current.rotation.z+=n?.001:5e-4;const d=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(d),t.current&&(t.current.opacity=n?.5:.25)});const s=[],a=200,r=3,o=2,l=Math.PI/2;for(let u=0;u<=a;u++){const d=u/a*Math.PI*2,h=Math.sin(r*d+l)*1.5,g=Math.sin(o*d)*1.5,f=0;s.push(new _n(h,g,f))}const c=new Ds().setFromPoints(s);return i.jsx("line",{ref:e,geometry:c,children:i.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},pc=({isActive:n=!1})=>i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(gs,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(mc,{isActive:n})]})}),fc=({isActive:n,ripples:e})=>{const t=w.useRef(null);Ht(a=>{if(!t.current)return;const r=a.clock.elapsedTime;t.current.children.forEach((o,l)=>{if(e[l]){const c=r-e[l].startTime,u=3;if(c<u){const d=1+c*.5;o.scale.setScalar(d);const h=1-c/u;o instanceof So&&(o.material.opacity=h*(n?.6:.3))}else o.visible=!1}})});const s=()=>{const a=[];for(let l=0;l<=64;l++){const c=l/64*Math.PI*2;a.push(new _n(Math.cos(c)*1,Math.sin(c)*1,0))}return new Ds().setFromPoints(a)};return i.jsx("group",{ref:t,children:e.slice(-5).map(a=>i.jsx("line",{geometry:s(),children:i.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},a.id))})},gc=({isActive:n=!1,triggerRipple:e})=>{const[t,s]=w.useState([]),a=w.useRef(0);return w.useEffect(()=>{if(e){const r={id:a.current++,startTime:Date.now()/1e3};s(o=>[...o,r].slice(-5))}},[e]),w.useEffect(()=>{if(!n)return;const r=setInterval(()=>{const o={id:a.current++,startTime:Date.now()/1e3};s(l=>[...l,o].slice(-5))},2e3);return()=>clearInterval(r)},[n]),i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:i.jsxs(gs,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(fc,{isActive:n,ripples:t})]})})},vc=({isActive:n,progress:e,dominantColor:t,onComplete:s,mousePos:a})=>{const r=w.useRef(null),o=w.useRef(null),[l,c]=w.useState(!1),[u,d]=w.useState(0),h=w.useMemo(()=>new jo(t),[t]),g=w.useMemo(()=>{const f=new Ds,p=new Float32Array(100*3),m=new Float32Array(100*3);for(let _=0;_<100;_++){const y=Math.random()*Math.PI*2,x=Math.acos(2*Math.random()-1),S=1;p[_*3]=S*Math.sin(x)*Math.cos(y),p[_*3+1]=S*Math.sin(x)*Math.sin(y),p[_*3+2]=S*Math.cos(x),m[_*3]=p[_*3]*.02,m[_*3+1]=p[_*3+1]*.02,m[_*3+2]=p[_*3+2]*.02}return f.setAttribute("position",new sa(p,3)),f.setAttribute("velocity",new sa(m,3)),f},[]);return Ht(f=>{if(!r.current)return;const p=n?2*Math.PI/(30*60):2*Math.PI/(60*60);if(r.current.rotation.y+=p,r.current.rotation.x+=p*.5,n&&a.x!==0&&a.y!==0){const y=(a.x/window.innerWidth-.5)*.5,x=(a.y/window.innerHeight-.5)*.5;r.current.rotation.y+=(y-r.current.rotation.y)*.1,r.current.rotation.x+=(x-r.current.rotation.x)*.1}const m=20,_=Math.floor(e*m);if(_!==u&&_<m&&d(_),e>=1&&!l&&(c(!0),setTimeout(()=>{s?.()},1500)),l&&o.current){const y=g.getAttribute("position"),x=g.getAttribute("velocity");for(let S=0;S<100;S++)y.setXYZ(S,y.getX(S)+x.getX(S),y.getY(S)+x.getY(S),y.getZ(S)+x.getZ(S));y.needsUpdate=!0,r.current.material instanceof To&&(r.current.material.opacity=Math.max(0,r.current.material.opacity-.02))}}),i.jsxs("group",{children:[!l&&i.jsxs("mesh",{ref:r,children:[i.jsx("icosahedronGeometry",{args:[1,0]}),i.jsx("meshStandardMaterial",{color:h,transparent:!0,opacity:.8,wireframe:!1,emissive:h,emissiveIntensity:u/20})]}),l&&i.jsx("points",{ref:o,geometry:g,children:i.jsx("pointsMaterial",{color:h,size:.05,transparent:!0,opacity:.8})})]})},yc=({isActive:n=!1,progress:e=0,onComplete:t,dominantColor:s="#D4AF37",layer:a="foreground",placement:r="center",sizePx:o=400,opacity:l})=>{const[c,u]=w.useState({x:0,y:0});w.useEffect(()=>{const f=p=>{u({x:p.clientX,y:p.clientY})};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]);const d=(()=>{switch(r){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),h=a==="background",g=typeof l=="number"?l:h?.14:1;return i.jsx("div",{style:{width:"100%",height:`${o}px`,position:"absolute",...d,transform:"translate(-50%, -50%)",pointerEvents:h?"none":n?"auto":"none",zIndex:h?-1:0,opacity:g},children:i.jsxs(gs,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx("pointLight",{position:[10,10,10],intensity:1}),i.jsx(vc,{isActive:n,progress:e,dominantColor:s,onComplete:t,mousePos:c})]})})},_c=({index:n,frequency:e,amplitude:t,color:s,mousePos:a,plucked:r})=>{const o=w.useRef(null),[l,c]=w.useState(0),[u,d]=w.useState(0),h=w.useMemo(()=>{const f=[];for(let _=0;_<100;_++){const y=_/100*4-2;f.push(new _n(y,0,0))}return f},[]);Ht(f=>{if(!o.current)return;const p=o.current.geometry.attributes.position,m=4,_=100;c(x=>x+e*.01),r&&d(x=>x+.2);const y=r?Math.exp(-u)*.5:0;for(let x=0;x<_;x++){const S=x/_*m-m/2,A=(a.x/window.innerWidth-.5)*8,b=(a.y/window.innerHeight-.5)*6,T=(n-2)*.4,j=Math.sqrt(Math.pow(A-S,2)+Math.pow(b-T,2)),v=Math.max(0,1-j/2)*.3,N=(t+v+y)*Math.sin(e*S+l),E=N,O=N*.2;p.setXYZ(x,S,E,O)}p.needsUpdate=!0,o.current.position.y=(n-2)*.4});const g=w.useMemo(()=>new Ds().setFromPoints(h),[h]);return i.jsx("line",{ref:o,geometry:g,children:i.jsx("lineBasicMaterial",{color:s,linewidth:2,transparent:!0,opacity:.8})})},bc=({isActive:n,audioData:e,valence:t,arousal:s,mousePos:a,pluckedIndex:r})=>{const o=w.useMemo(()=>{const l=t<0?1:2,c=s*.2;return[{frequency:l,amplitude:e?.bass?e.bass/255*.3:c,color:"#FF4444"},{frequency:l*1.5,amplitude:e?.midLow?e.midLow/255*.3:c*.8,color:"#FF8844"},{frequency:l*2,amplitude:e?.mid?e.mid/255*.3:c*.6,color:"#FFDD44"},{frequency:l*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:c*.4,color:"#44DDFF"},{frequency:l*3,amplitude:e?.treble?e.treble/255*.3:c*.2,color:"#8844FF"}]},[e,t,s]);return i.jsx("group",{children:o.map((l,c)=>i.jsx(_c,{index:c,frequency:l.frequency,amplitude:l.amplitude,color:l.color,mousePos:a,plucked:r===c},c))})},xc=({isActive:n=!1,audioData:e=null,valence:t=0,arousal:s=.5})=>{const[a,r]=w.useState({x:0,y:0}),[o,l]=w.useState(-1);w.useEffect(()=>{const u=d=>{r({x:d.clientX,y:d.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const c=u=>{const d=u.currentTarget.getBoundingClientRect(),h=u.clientY-d.top,g=Math.floor(h/d.height*5);l(g),setTimeout(()=>l(-1),1e3)};return i.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:n?"auto":"none",zIndex:0},onClick:c,children:i.jsxs(gs,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[i.jsx("ambientLight",{intensity:.5}),i.jsx(bc,{isActive:n,audioData:e,valence:t,arousal:s,mousePos:a,pluckedIndex:o})]})})},Ka=({pattern:n,isActive:e=!1,triggerRipple:t,progress:s=0,dominantColor:a="#D4AF37",layer:r="foreground",placement:o="center",sizePx:l,opacity:c,audioData:u=null,valence:d=0,arousal:h=.5,onComplete:g})=>{const[f,p]=w.useState(!1),[m,_]=w.useState(!1);return w.useEffect(()=>{const y=()=>{p(window.innerWidth<768)},x=window.matchMedia("(prefers-reduced-motion: reduce)");_(x.matches),y(),window.addEventListener("resize",y);const S=A=>{_(A.matches)};return x.addEventListener("change",S),()=>{window.removeEventListener("resize",y),x.removeEventListener("change",S)}},[]),f||m||n==="none"?null:i.jsxs(i.Fragment,{children:[n==="spiral"&&i.jsx(hc,{isActive:e}),n==="lissajous"&&i.jsx(pc,{isActive:e}),n==="ripples"&&i.jsx(gc,{isActive:e,triggerRipple:t}),n==="polyhedron"&&i.jsx(yc,{isActive:e,progress:s,dominantColor:a,onComplete:g,layer:r,placement:o,sizePx:l,opacity:c}),n==="stringVibration"&&i.jsx(xc,{isActive:e,audioData:u,valence:d,arousal:h})]})},Rt="https://airia-beyond.onrender.com";async function si(n){const e=await fetch(`${Rt}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate image")}return e.json()}async function wc(n,e){const t=await fetch(`${Rt}/api/job/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get job status")}return t.json()}async function Qs(n,e,t=60,s=2e3,a){for(let r=0;r<t;r++){if(a?.aborted)throw new DOMException("Aborted","AbortError");const o=await wc(n,a);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,s))}throw new Error("Job polling timeout")}async function Nc(n){const e=await fetch(`${Rt}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to chat")}return e.json()}async function Sc(n){const e=await fetch(`${Rt}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to refine event")}return e.json()}async function jc(n){const e=await fetch(`${Rt}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to name album title")}return e.json()}async function Tc(n){const e=await fetch(`${Rt}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to resolve music preview")}return e.json()}async function sn(n){const e=await Ke(`${Rt}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate music")}return e.json()}async function kc(n,e){const t=await Ke(`${Rt}/api/music/${n}`,{signal:e});if(!t.ok){const s=await t.json();throw new Error(s.message||s.error||"Failed to get music job status")}return t.json()}async function os(n,e,t=60,s=2e3,a){for(let r=0;r<t;r++){if(a?.aborted)throw new DOMException("Aborted","AbortError");const o=await kc(n,a);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,s))}throw new Error("Music job polling timeout")}const Cc="airia_onboarding_data";function Ac(){try{const n=localStorage.getItem(Cc);if(!n)return null;const e=JSON.parse(n);return!e||typeof e!="object"?null:e}catch{return null}}function da(n){return Math.max(0,Math.min(1,n))}function Ec(n){return Math.max(-1,Math.min(1,n))}function ha(n){switch(String(n??"").trim()){case"穏やか":return{valence:.15,arousal:.25};case"嬉しい":return{valence:.65,arousal:.65};case"不安":return{valence:-.55,arousal:.65};case"疲れ":return{valence:-.2,arousal:.25};case"怒り":return{valence:-.65,arousal:.85};case"悲しい":return{valence:-.7,arousal:.35};case"興奮":return{valence:.5,arousal:.9};case"退屈":return{valence:-.1,arousal:.15};default:return{valence:0,arousal:.45}}}function Mc(n){const e=new Set,t=n.recentMomentEmotion||n.dailyPatternEmotion,s=String(t??"").trim();e.add("余韻"),e.add("光"),s==="不安"?(e.add("霧"),e.add("揺れ")):s==="穏やか"?(e.add("水面"),e.add("静寂")):s==="疲れ"?(e.add("夜"),e.add("静寂")):s==="嬉しい"?(e.add("風"),e.add("朝")):s==="悲しい"?(e.add("影"),e.add("雨")):s==="怒り"?(e.add("火"),e.add("鋭さ")):s==="興奮"?(e.add("閃光"),e.add("躍動")):s==="退屈"&&(e.add("無音"),e.add("空"));const a=String(n.emotionalGoal??"").trim();return a.includes("集中")&&e.add("集中"),(a.includes("安心")||a.includes("安"))&&e.add("安心"),a.includes("眠")&&e.add("眠り"),a.includes("整")&&e.add("整う"),[...e].slice(0,5)}function Ic(n){const e=n.recentMomentEmotion||n.dailyPatternEmotion||"未指定",t=String(n.emotionalGoal??"").trim(),s=String(n.emotionalTrigger??"").trim();return{emotionalProfile:[`startMode:${n.startMode||"未指定"}`,`mood:${e}`,t?`goal:${t.slice(0,80)}`:null,s?`trigger:${s.slice(0,60)}`:null].filter(Boolean).join(" / "),preferences:{...n,startMode:n.startMode}}}function Dc(n){const e=ha(n.recentMomentEmotion),t=ha(n.dailyPatternEmotion),s=Ec((e.valence+t.valence)/2),a=da((e.arousal+t.arousal)/2),r=da(n.startMode==="create"?.78:.68),o=Mc(n),l=.65,c=n.startMode==="create"?210:180;return{valence:s,arousal:a,focus:r,motif_tags:o,confidence:l,duration:c}}function Oc(n){const e=String(n.title).trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),a=Math.abs(s.split("").reduce((o,l)=>o*33+l.charCodeAt(0),7))%360,r=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${a} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(a+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(a+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${ma(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${ma(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">Generated from onboarding</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(r)}`}function ma(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}const gi="airia_pending_chat_generation_v1",vi="airia_pending_onboarding_generation_v1";function zn(){try{const n=localStorage.getItem(gi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="chat"||!e.musicJobId?null:e}catch{return null}}function pa(n){try{localStorage.setItem(gi,JSON.stringify(n))}catch{}}function fa(){try{localStorage.removeItem(gi)}catch{}}function Cs(){try{const n=localStorage.getItem(vi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="onboarding"||!e.musicJobId||!e.request||!e.coverDataUrl?null:e}catch{return null}}function ga(n){try{localStorage.setItem(vi,JSON.stringify(n))}catch{}}function ks(){try{localStorage.removeItem(vi)}catch{}}function Qa({open:n,title:e,description:t,cancelLabel:s="キャンセル",confirmLabel:a="実行",confirmTone:r="primary",onCancel:o,onConfirm:l}){return w.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&o(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&l()};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,o,l]),n?i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"confirm-dialog-backdrop",onClick:o}),i.jsxs("div",{className:"confirm-dialog",role:"dialog","aria-modal":"true","aria-label":e,children:[i.jsxs("div",{className:"confirm-dialog-header",children:[i.jsxs("div",{children:[i.jsx("div",{className:"confirm-dialog-eyebrow",children:"確認"}),i.jsx("h2",{className:"confirm-dialog-title",children:e})]}),i.jsx("button",{className:"confirm-dialog-close",onClick:o,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),t?i.jsx("div",{className:"confirm-dialog-body",children:t}):null,i.jsxs("div",{className:"confirm-dialog-actions",children:[i.jsx("button",{className:"btn btn-secondary",onClick:o,children:s}),i.jsx("button",{className:r==="danger"?"btn btn-primary confirm-dialog-danger":"btn btn-primary",onClick:l,children:a})]}),i.jsx("div",{className:"confirm-dialog-shortcut",children:"確定: クリック / (Ctrl+Enter)"})]})]}):null}function er({active:n,statusText:e,elapsedSec:t=0,onCancel:s}){if(!n)return null;const r=.85-.35*Math.max(0,Math.min(1,t/22));return i.jsxs("div",{className:"gen-frost",style:{"--frost":r},"aria-live":"polite","aria-busy":"true",children:[i.jsx("div",{className:"gen-frost-surface"}),i.jsxs("div",{className:"gen-frost-card",role:"status",children:[i.jsx("div",{className:"gen-frost-title",children:"生成中"}),i.jsxs("div",{className:"gen-frost-status",children:[e||"進行中…",i.jsxs("span",{className:"gen-frost-elapsed",children:["（",t,"s）"]})]}),s?i.jsx("button",{className:"gen-frost-cancel",onClick:s,type:"button",children:"キャンセル"}):null]})]})}const Rc=({onExit:n})=>{const{albums:e,addAlbum:t,selectAlbum:s}=xt(),{requestPlayAlbum:a}=Ot(),{addToast:r}=vs(),[o,l]=w.useState(!1),[c,u]=w.useState(null),[d,h]=w.useState(0),[g,f]=w.useState(!1),[p,m]=w.useState(null),[_,y]=w.useState(null),[x,S]=w.useState(null),[A,b]=w.useState(0),[T,j]=w.useState(!1),v=w.useRef(!1),N=w.useRef(null),E=w.useRef(!1),[O,M]=w.useState(!1),D=w.useMemo(()=>e.filter($=>$.musicData),[e]);w.useEffect(()=>{const $=Cs();j(!!$),$&&!E.current&&(E.current=!0,r("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]);const k=$=>{u($),l(!0)},L=()=>{l(!1),u(null),h(0),f(!1),m(null),y(null),S(null),b(0),N.current?.abort(),N.current=null,ks(),j(!1),v.current=!1};w.useEffect(()=>{if(!g||!x)return;b(Math.max(0,Math.floor((Date.now()-x)/1e3)));const $=window.setInterval(()=>{b(Math.max(0,Math.floor((Date.now()-x)/1e3)))},1e3);return()=>window.clearInterval($)},[g,x]);const V=$=>$.recentMomentEmotion||$.dailyPatternEmotion||"穏やか",R=async()=>{if(!c||g)return;const $=Cs();if(!$)return;m(null),y("再開中…"),f(!0),S($.startedAt||Date.now()),b(0),r("info","生成を再開しています…"),N.current?.abort();const Q=new AbortController;N.current=Q;try{const U=await os($.musicJobId,P=>{P.status==="queued"?y("順番待ち…"):P.status==="running"?y("生成中…"):P.status==="succeeded"?y("仕上げ中…"):P.status==="failed"&&y("失敗しました")},90,2e3,Q.signal);if(U.status!=="succeeded"||!U.midiData||!U.result)throw new Error(U.errorMessage||U.error||"曲生成に失敗しました");y("保存しています…");const I=t({title:$.title,mood:$.mood,duration:$.request.duration,imageDataURL:$.coverDataUrl,thumbnailUrl:$.coverDataUrl,metadata:{valence:$.request.valence,arousal:$.request.arousal,focus:$.request.focus,motif_tags:$.request.motif_tags,confidence:$.request.confidence,provider:"rule-based"},musicData:U.midiData,musicFormat:"midi",musicMetadata:{key:U.result.key,tempo:U.result.tempo,timeSignature:U.result.timeSignature,form:U.result.form,character:U.result.character,duration:$.request.duration,createdAt:new Date().toISOString(),provider:U.provider},sessionData:{onboarding:c}});s(I.id),a(I,[I,...D]),ks(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(U){if(U instanceof DOMException&&U.name==="AbortError"){y("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}m(U instanceof Error?U.message:"曲生成に失敗しました"),y(null),r("error",U instanceof Error?U.message:"曲生成に失敗しました")}finally{f(!1),N.current=null}},B=async()=>{if(g||!c)return;const $=Cs();if(!$)return;m(null),y("再生成を開始しています…"),f(!0),S(Date.now()),b(0),r("info","同じ条件で再生成を開始しました。"),N.current?.abort();const Q=new AbortController;N.current=Q;try{const U=await sn($.request);ga({...$,startedAt:Date.now(),musicJobId:U.jobId}),j(!0);const I=await os(U.jobId,C=>{C.status==="queued"?y("順番待ち…"):C.status==="running"?y("生成中…"):C.status==="succeeded"?y("仕上げ中…"):C.status==="failed"&&y("失敗しました")},90,2e3,Q.signal);if(I.status!=="succeeded"||!I.midiData||!I.result)throw new Error(I.errorMessage||I.error||"曲生成に失敗しました");y("保存しています…");const P=t({title:$.title,mood:$.mood,duration:$.request.duration,imageDataURL:$.coverDataUrl,thumbnailUrl:$.coverDataUrl,metadata:{valence:$.request.valence,arousal:$.request.arousal,focus:$.request.focus,motif_tags:$.request.motif_tags,confidence:$.request.confidence,provider:"rule-based"},musicData:I.midiData,musicFormat:"midi",musicMetadata:{key:I.result.key,tempo:I.result.tempo,timeSignature:I.result.timeSignature,form:I.result.form,character:I.result.character,duration:$.request.duration,createdAt:new Date().toISOString(),provider:I.provider},sessionData:{onboarding:c}});s(P.id),a(P,[P,...D]),ks(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(U){if(U instanceof DOMException&&U.name==="AbortError"){y("キャンセルしました"),r("info","生成をキャンセルしました。あとで再開できます。");return}const I=U instanceof Error?U.message:"曲生成に失敗しました";m(I),y(null),r("error",I)}finally{f(!1),N.current=null}},Y=async()=>{if(!c||g)return;m(null),y("準備中…"),f(!0),S(Date.now()),b(0),N.current?.abort();const $=new AbortController;N.current=$;try{const Q=V(c),U=`${Date.now()}`,I=Oc({title:"はじめの一曲",mood:Q,seed:U}),P=Dc(c);y("作曲を開始しています…");const C=await sn({...P,seed:Number(U.slice(-9))});ga({v:1,kind:"onboarding",startedAt:Date.now(),musicJobId:C.jobId,request:{...P,seed:Number(U.slice(-9))},mood:Q,title:"はじめの一曲",coverDataUrl:I}),j(!0),r("info","生成を開始しました。完了まで待つか、あとで再開できます。"),y("生成中…（1〜2分かかることがあります）");const W=await os(C.jobId,Me=>{Me.status==="queued"?y("順番待ち…"):Me.status==="running"?y("生成中…"):Me.status==="succeeded"?y("仕上げ中…"):Me.status==="failed"&&y("失敗しました")},90,2e3,$.signal);if(W.status!=="succeeded"||!W.midiData||!W.result)throw new Error(W.errorMessage||W.error||"曲生成に失敗しました");y("保存しています…");const oe=t({title:"はじめの一曲",mood:Q,duration:P.duration,imageDataURL:I,thumbnailUrl:I,metadata:{valence:P.valence,arousal:P.arousal,focus:P.focus,motif_tags:P.motif_tags,confidence:P.confidence,provider:"rule-based"},musicData:W.midiData,musicFormat:"midi",musicMetadata:{key:W.result.key,tempo:W.result.tempo,timeSignature:W.result.timeSignature,form:W.result.form,character:W.result.character,duration:P.duration,createdAt:new Date().toISOString(),provider:W.provider},sessionData:{onboarding:c}});s(oe.id),a(oe,[oe,...D]),ks(),j(!1),r("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(Q){if(Q instanceof DOMException&&Q.name==="AbortError"){y("キャンセルしました"),S(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。");return}m(Q instanceof Error?Q.message:"曲生成に失敗しました"),y(null),S(null),b(0),r("error",Q instanceof Error?Q.message:"曲生成に失敗しました")}finally{f(!1),N.current=null}},H=()=>{g&&(N.current?.abort(),f(!1),y("キャンセルしました"),S(null),b(0),r("info","生成を中断しました。あとで再開できます。"))},X=()=>{ks(),j(!1),y(null),m(null),r("info","保留中の生成を破棄しました。")},ee=()=>{g&&(N.current?.abort(),N.current=null,f(!1),y("キャンセルしました"),S(null),b(0),r("info","生成をキャンセルしました。あとで再開できます。"))};return w.useEffect(()=>{!o||!c||v.current||c.startMode==="create"&&(v.current=!0,Cs()?R():Y())},[o,c]),i.jsxs("div",{className:"room-content onboarding-room","data-no-swipe":"true",children:[i.jsx(er,{active:g,statusText:_,elapsedSec:A,onCancel:ee}),i.jsx(Qa,{open:O,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>M(!1),onConfirm:()=>{M(!1),X()}}),!o&&i.jsx(Ka,{pattern:"polyhedron",isActive:!0,progress:d,layer:"background",placement:"center",sizePx:420,opacity:.16}),i.jsx("h1",{className:"room-title",children:"はじめに"}),i.jsx("p",{className:"room-subtitle",children:"あなたに合う体験へ整えます"}),o?i.jsxs("div",{className:"onboarding-complete",children:[i.jsx("h2",{className:"blend-text",children:"完了しました！"}),i.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",i.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),p?i.jsx("div",{className:"form-error",children:p}):null,_?i.jsxs("div",{className:"onboarding-generate-status",children:[_,x?i.jsxs("span",{className:"onboarding-generate-elapsed",children:["（",A,"s）"]}):null]}):null,i.jsxs("div",{className:"button-group",children:[i.jsx("button",{className:"btn btn-secondary",onClick:L,children:"回答を編集"}),i.jsx("button",{className:"btn btn-primary",onClick:()=>void Y(),disabled:g,"data-no-swipe":!0,title:"オンボーディング回答から1曲生成して、そのまま再生します",children:g?"1曲生成中…":"1曲作ってはじめる"}),!g&&T?i.jsx("button",{className:"btn btn-secondary",onClick:()=>void R(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!g&&T&&p?i.jsx("button",{className:"btn btn-secondary",onClick:()=>void B(),"data-no-swipe":!0,type:"button",title:"失敗・停止した場合に、同じ条件で作り直します",children:"再生成"}):null,!g&&T?i.jsx("button",{className:"btn btn-secondary",onClick:()=>M(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null,g?i.jsx("button",{className:"btn btn-secondary",onClick:H,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,i.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!c)return;const $=JSON.stringify(c,null,2),Q=new Blob([$],{type:"application/json"}),U=URL.createObjectURL(Q),I=document.createElement("a");I.href=U,I.download="getting_started_profile.json",I.click(),URL.revokeObjectURL(U)},children:"プロフィールをダウンロード"}),i.jsx("button",{className:"btn btn-success",onClick:()=>{n?.()},children:"はじめる"})]})]}):i.jsx(uc,{onComplete:k,onProgressChange:h})]})},Pc=void 0,Fc=({onBack:n})=>{const{loginWithGoogle:e,loginWithApple:t,loginWithPassword:s,registerWithPassword:a,loading:r}=Os(),o=F.useRef(null),[l,c]=F.useState(null),[u,d]=F.useState(null),[h,g]=F.useState(()=>{try{return String(window.location.hash||"").toLowerCase()==="#signup"?"signup":"login"}catch{return"login"}});F.useEffect(()=>{try{const D=String(window.location.hash||"").toLowerCase();D==="#signup"&&g("signup"),D==="#login"&&g("login")}catch{}},[]),F.useEffect(()=>{c(null),d(null)},[e]);const f=async()=>{c(null),d(null);{c("Apple Client ID が未設定です");return}},p=!!Pc,[m,_]=F.useState(""),[y,x]=F.useState(""),[S,A]=F.useState(""),[b,T]=F.useState(""),[j,v]=F.useState(""),N=!!(m.trim()&&y),E=!!(b.trim()&&j),O=async D=>{D.preventDefault(),c(null),d(null);try{await a({email:m,password:y,displayName:S||void 0})}catch(k){c(k instanceof Error?k.message:String(k))}},M=async D=>{D.preventDefault(),c(null),d(null);try{await s({identifier:b,password:j})}catch(k){c(k instanceof Error?k.message:String(k))}};return i.jsx("div",{className:"room-content auth-room",children:i.jsxs("div",{className:"auth-card","data-no-swipe":"true",children:[n?i.jsx("div",{style:{marginBottom:8},children:i.jsx("button",{className:"btn",onClick:n,disabled:r,children:"← 戻る"})}):null,i.jsxs("div",{className:"auth-tabs",role:"tablist","aria-label":"認証モード",children:[i.jsx("button",{type:"button",role:"tab","aria-selected":h==="signup",className:`auth-tab ${h==="signup"?"active":""}`,onClick:()=>{g("signup");try{window.location.hash="#signup"}catch{}},disabled:r,children:"新規登録"}),i.jsx("button",{type:"button",role:"tab","aria-selected":h==="login",className:`auth-tab ${h==="login"?"active":""}`,onClick:()=>{g("login");try{window.location.hash="#login"}catch{}},disabled:r,children:"ログイン"})]}),i.jsx("h1",{className:"auth-title",children:"AIRIA"}),i.jsx("p",{className:"auth-subtitle",children:h==="signup"?"無料で始める（初回ログイン＝登録）":"おかえりなさい。ログインして続ける"}),i.jsx("div",{className:"auth-note",children:h==="signup"?i.jsx(i.Fragment,{children:i.jsx("p",{children:"メール/パスワード、または Google / Apple でアカウントを作成できます。"})}):i.jsxs(i.Fragment,{children:[i.jsx("p",{children:"メール/パスワード、または以前使った Google / Apple でログインしてください。"}),i.jsxs("p",{children:["初めての方は"," ",i.jsx("button",{type:"button",className:"auth-inline-link",onClick:()=>{g("signup");try{window.location.hash="#signup"}catch{}},disabled:r,children:"新規登録"}),"。"]})]})}),h==="signup"?i.jsxs("form",{className:"auth-form",onSubmit:D=>void O(D),children:[i.jsxs("label",{className:"auth-label",children:["メールアドレス",i.jsx("input",{className:"auth-input",type:"email",value:m,onChange:D=>_(D.target.value),placeholder:"you@example.com",autoComplete:"email",disabled:r,required:!0})]}),i.jsxs("label",{className:"auth-label",children:["パスワード（6文字以上）",i.jsx("input",{className:"auth-input",type:"password",value:y,onChange:D=>x(D.target.value),placeholder:"••••••",autoComplete:"new-password",disabled:r,required:!0,minLength:6})]}),i.jsxs("label",{className:"auth-label",children:["表示名（任意）",i.jsx("input",{className:"auth-input",type:"text",value:S,onChange:D=>A(D.target.value),placeholder:"AIRIAユーザー",autoComplete:"nickname",disabled:r})]}),i.jsx("button",{className:"btn auth-submit",type:"submit",disabled:r||!N,children:r?"作成中…":"メールで新規登録"})]}):i.jsxs("form",{className:"auth-form",onSubmit:D=>void M(D),children:[i.jsxs("label",{className:"auth-label",children:["メールアドレス / ハンドル",i.jsx("input",{className:"auth-input",type:"text",value:b,onChange:D=>T(D.target.value),placeholder:"you@example.com または your_handle",autoComplete:"username",disabled:r,required:!0})]}),i.jsxs("label",{className:"auth-label",children:["パスワード",i.jsx("input",{className:"auth-input",type:"password",value:j,onChange:D=>v(D.target.value),placeholder:"••••••",autoComplete:"current-password",disabled:r,required:!0})]}),i.jsx("button",{className:"btn auth-submit",type:"submit",disabled:r||!E,children:r?"ログイン中…":"メールでログイン"})]}),i.jsxs("div",{className:"auth-sep","aria-hidden":"true",children:[i.jsx("span",{}),i.jsx("div",{children:"または"}),i.jsx("span",{})]}),i.jsxs("div",{className:"auth-actions",children:[i.jsx("div",{className:`auth-google ${p?"":"disabled"}`,children:p?i.jsx("div",{ref:o}):i.jsx("button",{className:"btn",disabled:!0,children:"Googleでログイン（未設定）"})}),i.jsxs("button",{className:"btn btn-apple",onClick:()=>void f(),disabled:r||!0,children:["Appleでログイン","（未設定）"]})]}),l&&i.jsx("div",{className:"auth-error",children:l}),u&&i.jsx("div",{className:"auth-success",children:u})]})})},Lc=({onStart:n,onOpenTerms:e,onOpenPrivacy:t})=>{const s=a=>{const r=document.getElementById(a);r&&"scrollIntoView"in r&&r.scrollIntoView({behavior:"smooth",block:"start"})};return i.jsxs("div",{className:"room-content landing-room",children:[i.jsx("div",{className:"landing-hero","data-no-swipe":"true",children:i.jsxs("div",{className:"landing-hero-inner",children:[i.jsxs("div",{className:"landing-hero-copy",children:[i.jsxs("div",{className:"landing-hero-toprow",children:[i.jsx("div",{className:"landing-eyebrow",children:"MOOD → IMAGE → MUSIC"}),(t||e)&&i.jsxs("div",{className:"landing-legal","aria-label":"Legal",children:[t?i.jsx("button",{type:"button",className:"landing-legal-link",onClick:t,children:"Privacy"}):null,t&&e?i.jsx("span",{className:"landing-legal-sep","aria-hidden":"true",children:"·"}):null,e?i.jsx("button",{type:"button",className:"landing-legal-link",onClick:e,children:"Terms"}):null]})]}),i.jsxs("h1",{className:"landing-title",children:["AIRIA BEYOND",i.jsx("span",{className:"landing-title-sub",children:"感情を、作品に変える。"})]}),i.jsxs("p",{className:"landing-lead",children:["その日の気分を記録して、抽象画とクラシック風の音楽へ。",i.jsx("br",{}),"“言葉にならない”を、見える・聴ける形にして保存します。"]}),i.jsxs("div",{className:"landing-cta",children:[i.jsx("button",{className:"btn btn-primary landing-cta-primary",onClick:()=>{try{window.location.hash="#signup"}catch{}n()},children:"無料で新規登録"}),i.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>{try{window.location.hash="#login"}catch{}n()},children:"ログイン"}),i.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>s("landing-how"),"aria-label":"AIRIAの使い方へスクロール",children:"どうやって動く？"})]}),i.jsxs("div",{className:"landing-meta",children:[i.jsx("span",{className:"landing-chip",children:"プレリリース"}),i.jsx("span",{className:"landing-chip",children:"Google / Apple ログイン"}),i.jsx("span",{className:"landing-chip",children:"生成失敗でも止めない設計"}),i.jsx("span",{className:"landing-chip",children:"最短ルート：ログイン → 「創作から」"})]}),i.jsx("div",{className:"landing-signup-note",children:"初めての方も、このボタンでOKです（初回ログイン＝新規登録）。パスワード登録はありません。"})]}),i.jsxs("div",{className:"landing-hero-cover","aria-label":"サンプルプレビュー",children:[i.jsxs("div",{className:"landing-cover-card",children:[i.jsxs("div",{className:"landing-cover-top",children:[i.jsx("div",{className:"landing-cover-kicker",children:"Today’s Session"}),i.jsx("div",{className:"landing-cover-date",children:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),i.jsx("div",{className:"landing-cover-title",children:"静けさと余白"}),i.jsx("div",{className:"landing-cover-sub",children:"穏やか / 3:00 / Focus 0.62"}),i.jsx("div",{className:"landing-cover-image",role:"img","aria-label":"生成イメージのモック"}),i.jsxs("div",{className:"landing-cover-bottom",children:[i.jsxs("div",{className:"landing-cover-pills",children:[i.jsx("span",{className:"landing-pill",children:"Valence"}),i.jsx("span",{className:"landing-pill",children:"Arousal"}),i.jsx("span",{className:"landing-pill",children:"Motif"})]}),i.jsxs("div",{className:"landing-cover-wave","aria-hidden":"true",children:[i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"}),i.jsx("div",{className:"landing-wave-bar"})]})]})]}),i.jsx("div",{className:"landing-cover-note",children:"これは体験イメージです。実際の生成はあなたの入力に合わせて変化します。"})]})]})}),i.jsxs("section",{className:"landing-section",id:"landing-how",children:[i.jsxs("div",{className:"landing-section-head",children:[i.jsx("h2",{className:"landing-h2",children:"体験は“記事”のように読み進められる"}),i.jsx("p",{className:"landing-sub",children:"AIRIAは、ただの生成ツールではなく「自分の状態を読み解くための記録」です。 迷いにくい導線と、気持ちよく続くUIを優先しました。"})]}),i.jsxs("div",{className:"landing-steps","data-no-swipe":"true",children:[i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"01"}),i.jsx("h3",{className:"landing-h3",children:"気分を入力"}),i.jsx("p",{className:"landing-p",children:"短い質問に答えるだけ。言語化が苦手でもOK。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"02"}),i.jsx("h3",{className:"landing-h3",children:"抽象画を生成"}),i.jsx("p",{className:"landing-p",children:"色・構図・質感で、その日の“温度”を可視化します。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"03"}),i.jsx("h3",{className:"landing-h3",children:"音楽を生成"}),i.jsx("p",{className:"landing-p",children:"クラシック風の短編。再生バーからすぐ聴けます。"})]}),i.jsxs("article",{className:"landing-step",children:[i.jsx("div",{className:"landing-step-no",children:"04"}),i.jsx("h3",{className:"landing-h3",children:"保存・共有"}),i.jsx("p",{className:"landing-p",children:"Socialに公開、反応を受け取る。非公開・削除も可能です。"})]})]}),i.jsx("div",{className:"landing-divider"}),i.jsxs("div",{className:"landing-grid","data-no-swipe":"true",children:[i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"止まらない体験"}),i.jsx("p",{className:"landing-p",children:"生成が失敗しても、placeholderや緊急MIDIで進行します。待ち時間のストレスを最小化。"})]}),i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"説明可能性"}),i.jsx("p",{className:"landing-p",children:"“なぜこの作品になったか”を見える形で提示。ブラックボックス感を減らします。"})]}),i.jsxs("article",{className:"landing-card",children:[i.jsx("h3",{className:"landing-h3",children:"運用前提の設計"}),i.jsx("p",{className:"landing-p",children:"OAuth-only、レート制限、通知（任意）など、プレリリースでも破綻しにくい土台を用意。"})]})]})]}),i.jsxs("section",{className:"landing-section landing-section-narrow",children:[i.jsxs("div",{className:"landing-section-head",children:[i.jsx("h2",{className:"landing-h2",children:"コンセプト"}),i.jsx("p",{className:"landing-sub",children:"“感情を作品に変える”は、自己理解の入り口になる。"})]}),i.jsxs("article",{className:"landing-article","data-no-swipe":"true",children:[i.jsx("p",{className:"landing-article-p",children:"気分は、言葉で説明しきれないことが多い。AIRIAは、入力を起点に「視覚」と「音楽」でその輪郭をつくります。 生成物は正解ではなく、あなたが自分を読み解くための“鏡”。"}),i.jsx("p",{className:"landing-article-p",children:"だからUIは、派手さよりも継続性を優先。余白、静けさ、そして必要なときだけ現れる強い導線。 アプリ全体がひとつの短い文章のように流れる設計です。"}),i.jsxs("div",{className:"landing-quote",children:[i.jsx("div",{className:"landing-quote-mark","aria-hidden":"true",children:"“"}),i.jsxs("div",{children:[i.jsx("div",{className:"landing-quote-text",children:"今日を作品として保存できると、気分は“消費”ではなく“蓄積”になる。"}),i.jsx("div",{className:"landing-quote-sub",children:"AIRIA BEYOND / Design note"})]})]})]})]}),i.jsxs("section",{className:"landing-section landing-bottom","data-no-swipe":"true",children:[i.jsxs("div",{className:"landing-bottom-inner",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"landing-h2",children:"準備はできましたか？"}),i.jsx("p",{className:"landing-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),i.jsxs("div",{className:"landing-bottom-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:n,children:"ログインしてはじめる"}),i.jsx("button",{className:"btn",onClick:()=>s("landing-how"),children:"もう一度読む"})]})]}),i.jsxs("footer",{className:"landing-footer",children:[i.jsxs("div",{className:"landing-footer-row",children:[i.jsx("div",{className:"landing-footer-brand",children:"AIRIA BEYOND"}),i.jsx("div",{className:"landing-footer-note",children:"Pre-release / OAuth-only"})]}),(t||e)&&i.jsxs("div",{className:"landing-footer-links","aria-label":"Legal",children:[t?i.jsx("button",{type:"button",className:"landing-footer-link",onClick:t,children:"プライバシー"}):null,e?i.jsx("button",{type:"button",className:"landing-footer-link",onClick:e,children:"利用規約"}):null]})]})]})]})},Vc=()=>i.jsxs("div",{className:"legal-page",children:[i.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[i.jsx("h2",{children:"1. サービスの概要 / Service Overview"}),i.jsx("p",{children:"AIRIA BEYONDは、AI搭載の感情分析・クラシック音楽・絵画生成アプリケーションです。 ユーザーの感情状態を分析し、それに基づいてクラシック音楽や絵画を生成します。"}),i.jsx("p",{children:"AIRIA BEYOND is an AI-powered application for emotion analysis, classical music, and painting generation. It analyzes users' emotional states and generates classical music and paintings based on the analysis."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"2. データの取り扱い / Data Handling"}),i.jsx("p",{children:"個人を特定できる情報は送信されません。セッションデータ、生成された画像・音楽は ブラウザのローカルストレージに保存されます。"}),i.jsx("p",{children:"No personally identifiable information is transmitted. Session data, generated images and music are stored in browser's local storage."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"3. 使用制限 / Usage Restrictions"}),i.jsx("p",{children:"本サービスは個人的な使用のみを目的としています。商用利用には事前の許可が必要です。"}),i.jsx("p",{children:"This service is intended for personal use only. Commercial use requires prior permission."})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"4. 免責事項 / Disclaimer"}),i.jsx("p",{children:"本サービスは「現状のまま」提供されます。生成されたコンテンツの正確性や適切性について 保証しません。"}),i.jsx("p",{children:'This service is provided "as is". We do not guarantee the accuracy or appropriateness of generated content.'})]}),i.jsx("div",{className:"legal-note",children:"プレリリース期間中は仕様が更新される場合があります。重要な変更はアプリ内のお知らせで通知します。"})]}),qc=()=>i.jsxs("div",{className:"legal-page",children:[i.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[i.jsx("h2",{children:"1. 収集する情報 / Information We Collect"}),i.jsxs("ul",{children:[i.jsx("li",{children:"セッションデータ（気分、時間） / Session data (mood, duration)"}),i.jsx("li",{children:"生成された画像・音楽 / Generated images and music"}),i.jsx("li",{children:"アクセスログ / Access logs"}),i.jsx("li",{children:"パフォーマンス指標 / Performance metrics"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"2. データの使用目的 / Purpose of Data Use"}),i.jsx("p",{children:"収集したデータは以下の目的で使用されます："}),i.jsxs("ul",{children:[i.jsx("li",{children:"サービスの提供と改善 / Service provision and improvement"}),i.jsx("li",{children:"パフォーマンスの監視 / Performance monitoring"}),i.jsx("li",{children:"エラーのトラッキングと修正 / Error tracking and fixing"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"3. データの保存 / Data Storage"}),i.jsx("p",{children:"ユーザーデータは主にブラウザのローカルストレージに保存されます。 サーバー側では一時的な処理のみが行われます。"}),i.jsx("p",{children:"User data is primarily stored in browser's local storage. Server-side processing is temporary only."}),i.jsx("div",{className:"legal-note",children:"ログインによりサーバー側にユーザー情報が保存されます（例: ハンドル、表示名、フォロー関係）。 メール通知を有効化した場合は、通知先としてメールアドレスを保存します。"})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"4. 第三者サービス / Third-Party Services"}),i.jsx("p",{children:"本サービスは以下の第三者サービスを使用します："}),i.jsxs("ul",{children:[i.jsx("li",{children:"Replicate (画像生成 / Image generation)"}),i.jsx("li",{children:"OpenAI (感情分析 / Emotion analysis)"}),i.jsx("li",{children:"Render (APIホスティング / API hosting)"}),i.jsx("li",{children:"GitHub Pages (フロントエンド配信 / Frontend hosting)"}),i.jsx("li",{children:"Sentry (エラートラッキング / Error tracking) - オプション"}),i.jsx("li",{children:"Resend / SMTP (メール通知 / Email notifications) - オプション"})]})]}),i.jsxs("section",{className:"legal-section",children:[i.jsx("h2",{children:"5. お問い合わせ / Contact"}),i.jsx("p",{children:"プライバシーに関するご質問は、GitHubリポジトリのIssueにてお問い合わせください。"}),i.jsx("p",{children:"For privacy-related questions, please contact us via GitHub repository Issues."})]})]}),va=({kind:n,onBack:e,onStart:t})=>{const s=n==="terms"?"利用規約":"プライバシーポリシー",a=n==="terms"?"Terms of Service":"Privacy Policy";return i.jsxs("div",{className:"room-content legal-room","data-no-swipe":"true",children:[i.jsxs("div",{className:"legal-topbar",children:[i.jsx("button",{className:"btn",onClick:e,children:"← 戻る"}),i.jsx("div",{className:"legal-topbar-spacer"}),i.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインへ"})]}),i.jsxs("header",{className:"legal-hero",children:[i.jsx("div",{className:"legal-hero-kicker",children:"AIRIA BEYOND / Legal"}),i.jsxs("h1",{className:"legal-hero-title",children:[s,i.jsx("span",{className:"legal-hero-sub",children:a})]}),i.jsx("p",{className:"legal-hero-lead",children:"ここに書かれていることは“堅い文章”ですが、AIRIAが守ろうとしているのは体験の安心感です。 わからない点があれば、GitHubのIssueから相談できます。"})]}),i.jsx("main",{className:"legal-body",children:n==="terms"?i.jsx(Vc,{}):i.jsx(qc,{})}),i.jsx("div",{className:"legal-bottom","data-no-swipe":"true",children:i.jsxs("div",{className:"legal-bottom-inner",children:[i.jsxs("div",{children:[i.jsx("div",{className:"legal-bottom-title",children:"続きはアプリで"}),i.jsx("div",{className:"legal-bottom-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),i.jsxs("div",{className:"legal-bottom-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインしてはじめる"}),i.jsx("button",{className:"btn",onClick:e,children:"戻る"})]})]})})]})};function Wc(n,e,t){try{n(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(s){console.error("[CausalLog] Failed to log album creation stage:",s)}}function ss(n,e,t,s,a){try{const o=e(t)?.errors||[];n(t,{errors:[...o,{stage:s,error:a,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",s)}catch(r){console.error("[CausalLog] Failed to log error:",r)}}function Yn(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function Bc(n){const e=String(n.title??"").trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),a=String(n.note).trim()||"Placeholder cover",r=Math.abs(s.split("").reduce((l,c)=>l*33+c.charCodeAt(0),7))%360,o=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${r} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(r+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(r+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${Yn(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${Yn(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">${Yn(a).slice(0,64)}</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(o)}`}function Uc({open:n,mood:e,defaultTitle:t,onCancel:s,onSubmit:a}){const[r,o]=w.useState(t??"");w.useEffect(()=>{n&&o(t??"")},[n,t]);const l=w.useMemo(()=>r.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[r]);return w.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&s(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&a(r)};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,s,a,r]),n?i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"album-title-backdrop",onClick:s}),i.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[i.jsxs("div",{className:"album-title-header",children:[i.jsxs("div",{children:[i.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),i.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),i.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),i.jsx("button",{className:"album-title-close",onClick:s,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),i.jsxs("div",{className:"album-title-body",children:[i.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),i.jsx("input",{id:"album-title-input",className:"album-title-input",value:r,placeholder:"例：雨上がりの余白",onChange:c=>o(c.target.value),autoFocus:!0}),i.jsx("div",{className:"album-title-hint",children:l}),i.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),i.jsxs("div",{className:"album-title-actions",children:[i.jsx("button",{className:"btn btn-secondary",onClick:s,children:"キャンセル"}),i.jsx("button",{className:"btn btn-primary",onClick:()=>a(r),children:"保存"})]})]})]}):null}function Hn(){return new Date().toISOString()}function Xn(n,e){return Bc({title:n?.brief?.theme?.title,mood:n?.image?.mood,seed:n?.image?.seed,note:e})}function Jn(n){return n?.effectiveProvider||n?.provider||(n?.status==="succeeded"?"image":"placeholder")}function $c(){const{albums:n,addAlbum:e,selectAlbum:t}=xt(),{createLog:s,updateLog:a,getLog:r}=za(),{requestPlayAlbum:o}=Ot(),{navigateToRoom:l}=pt(),{addToast:c}=vs(),[u,d]=w.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[h,g]=w.useState(""),[f,p]=w.useState(!1),[m,_]=w.useState(null),[y,x]=w.useState([]),[S,A]=w.useState(null),[b,T]=w.useState(!1),[j,v]=w.useState(null),[N,E]=w.useState(null),[O,M]=w.useState(0),D=w.useRef(null),[k,L]=w.useState(!1),[V,R]=w.useState(!1),B=w.useRef(!1),[Y,H]=w.useState(!1),[X,ee]=w.useState(!1),[$,Q]=w.useState(null),[U,I]=w.useState(null),[P,C]=w.useState(!1),W=w.useRef(null),[oe,Me]=w.useState(null),[et,qn]=w.useState({}),[js,G]=w.useState({}),[J,ve]=w.useState({}),de=w.useMemo(()=>u.filter(q=>q.role==="user"),[u]),ie=w.useMemo(()=>{const q=Ac();return q?Ic(q):null},[]),me=w.useMemo(()=>n.filter(q=>q.musicData),[n]);w.useEffect(()=>{const q=zn();L(!!q),q&&!B.current&&(B.current=!0,c("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]),w.useEffect(()=>()=>{D.current?.abort(),D.current=null,W.current&&(W.current.pause(),W.current.src="",W.current=null)},[]),w.useEffect(()=>{if(!b||!N)return;M(Math.max(0,Math.floor((Date.now()-N)/1e3)));const q=window.setInterval(()=>{M(Math.max(0,Math.floor((Date.now()-N)/1e3)))},1e3);return()=>window.clearInterval(q)},[b,N]);function Ve(){b&&(D.current?.abort(),D.current=null,T(!1),v("キャンセルしました"),E(null),M(0),R(!1),c("info","生成を中断しました。あとで再開できます。"))}function ct(){fa(),L(!1),v(null),_(null),R(!1),c("info","保留中の生成を破棄しました。")}async function qt(){const q=zn();if(!q||b)return;_(null),R(!1),T(!0),v("再生成を開始しています…"),E(Date.now()),M(0),c("info","同じ条件で再生成を開始しました。"),D.current?.abort();const ae=new AbortController;D.current=ae;try{const z=q.refined,Z=Xn(z,"Image unavailable");let pe=null;try{v("画像生成を開始しています…"),pe=(await si(z.image)).jobId}catch(Ie){pe=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const be=Ie instanceof Error?Ie.message:"image job start failed";q.causalLogId&&ss(a,r,q.causalLogId,"image-generation-start",be)}v("作曲を開始しています…");const _e=await sn(z.music);pa({...q,startedAt:Date.now(),imageJobId:pe,musicJobId:_e.jobId,coverDataUrl:q.coverDataUrl||Z}),L(!0);const Ne=pe?Qs(pe,Ie=>{Ie.status==="queued"?v("順番待ち…"):Ie.status==="running"?v("画像を生成中…"):Ie.status==="succeeded"?v("画像ができました。仕上げ中…"):Ie.status==="failed"&&v("画像生成に失敗しました")},90,2e3,ae.signal).catch(Ie=>{const be=Ie instanceof Error?Ie.message:"image polling failed";return q.causalLogId&&ss(a,r,q.causalLogId,"image-generation-poll",be),null}):Promise.resolve(null),[ze,Ce]=await Promise.all([Ne,os(_e.jobId,Ie=>{Ie.status==="queued"?v("順番待ち…"):Ie.status==="running"?v("作曲中…"):Ie.status==="succeeded"?v("作曲ができました。仕上げ中…"):Ie.status==="failed"&&v("作曲に失敗しました")},90,2e3,ae.signal)]),le=ze?.status==="succeeded"&&ze?.resultUrl?ze.resultUrl:Z;if(ze?.status==="succeeded"&&ze?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ce.status!=="succeeded"||!Ce.midiData||!Ce.result)throw new Error("曲生成に失敗しました");const es=z?.brief?.theme?.title||"";Q({title:es,mood:z?.image?.mood,duration:z?.image?.duration,imageDataURL:le,thumbnailUrl:le,metadata:{valence:z?.analysisLike?.valence,arousal:z?.analysisLike?.arousal,focus:z?.analysisLike?.focus,motif_tags:z?.analysisLike?.motif_tags,confidence:z?.analysisLike?.confidence,stylePreset:z?.image?.stylePreset,provider:Jn(ze)},musicData:Ce.midiData,musicFormat:"midi",musicMetadata:{key:Ce.result.key,tempo:Ce.result.tempo,timeSignature:Ce.result.timeSignature,form:Ce.result.form,character:Ce.result.character,duration:z?.music?.duration,createdAt:Hn(),provider:Ce.provider},sessionData:{brief:z?.brief,recommendations:q.sessionRecommendations??y,messages:q.sessionMessages??u},causalLogId:q.causalLogId??void 0}),I(q.causalLogId??null),ee(!0),v(null),R(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(z){if(z instanceof DOMException&&z.name==="AbortError"){v("キャンセルしました"),R(!1);return}const Z=z instanceof Error?z.message:"再生成に失敗しました";_(Z),R(!0),c("error",Z)}finally{T(!1),D.current=null}}async function Ts(){const q=zn();if(!q||b)return;_(null),R(!1),T(!0),v("再開中…"),E(q.startedAt||Date.now()),M(0),c("info","生成を再開しています…"),D.current?.abort();const ae=new AbortController;D.current=ae;try{const z=q.refined,Z=q.coverDataUrl||Xn(z,"Image unavailable"),pe=q.imageJobId?Qs(q.imageJobId,le=>{le.status==="queued"?v("順番待ち…"):le.status==="running"?v("画像を生成中…"):le.status==="succeeded"?v("画像ができました。仕上げ中…"):le.status==="failed"&&v("画像生成に失敗しました")},90,2e3,ae.signal).catch(le=>{const es=le instanceof Error?le.message:"image polling failed";return q.causalLogId&&ss(a,r,q.causalLogId,"image-generation-poll",es),null}):Promise.resolve(null),[_e,Ne]=await Promise.all([pe,os(q.musicJobId,le=>{le.status==="queued"?v("順番待ち…"):le.status==="running"?v("作曲中…"):le.status==="succeeded"?v("作曲ができました。仕上げ中…"):le.status==="failed"&&v("作曲に失敗しました")},90,2e3,ae.signal)]),ze=_e?.status==="succeeded"&&_e?.resultUrl?_e.resultUrl:Z;if(_e?.status==="succeeded"&&_e?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ne.status!=="succeeded"||!Ne.midiData||!Ne.result)throw new Error("曲生成に失敗しました");const Ce=z?.brief?.theme?.title||"";Q({title:Ce,mood:z?.image?.mood,duration:z?.image?.duration,imageDataURL:ze,thumbnailUrl:ze,metadata:{valence:z?.analysisLike?.valence,arousal:z?.analysisLike?.arousal,focus:z?.analysisLike?.focus,motif_tags:z?.analysisLike?.motif_tags,confidence:z?.analysisLike?.confidence,stylePreset:z?.image?.stylePreset,provider:Jn(_e)},musicData:Ne.midiData,musicFormat:"midi",musicMetadata:{key:Ne.result.key,tempo:Ne.result.tempo,timeSignature:Ne.result.timeSignature,form:Ne.result.form,character:Ne.result.character,duration:z?.music?.duration,createdAt:Hn(),provider:Ne.provider},sessionData:{brief:z?.brief,recommendations:q.sessionRecommendations??y,messages:q.sessionMessages??u},causalLogId:q.causalLogId??void 0}),I(q.causalLogId??null),ee(!0),v(null),L(!0),R(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(z){if(z instanceof DOMException&&z.name==="AbortError"){v("キャンセルしました"),R(!1);return}const Z=z instanceof Error?z.message:"再開に失敗しました";_(Z),R(!0),c("error",Z)}finally{T(!1),D.current=null}}const tt=q=>`${q.composer}::${q.title}`;async function Wn(q){const ae=tt(q);if(et[ae])return et[ae];if(js[ae])return null;G(z=>({...z,[ae]:!0})),ve(z=>({...z,[ae]:null}));try{const z=await Tc({composer:q.composer,title:q.title});return qn(Z=>({...Z,[ae]:z})),z}catch(z){const Z=z instanceof Error?z.message:"プレビュー取得に失敗しました";return ve(pe=>({...pe,[ae]:Z})),null}finally{G(z=>({...z,[ae]:!1}))}}async function yo(q){const ae=tt(q);if(oe===ae){W.current?.pause(),Me(null);return}const Z=await Wn(q),pe=Z?.previewUrl,_e=Z?.trackUrl;if(!pe){_e&&window.open(_e,"_blank","noopener,noreferrer");return}try{W.current||(W.current=new Audio),W.current.pause(),W.current.src=pe,W.current.currentTime=0,await W.current.play(),Me(ae),W.current.onended=()=>{Me(Ne=>Ne===ae?null:Ne)}}catch(Ne){ve(ze=>({...ze,[ae]:Ne instanceof Error?Ne.message:"再生に失敗しました"}))}}async function ta(){const q=h.trim();if(!q)return;_(null),p(!0);const ae=[...u,{role:"user",content:q}];d(ae),g("");try{const z=await Nc({messages:ae,onboardingData:ie??void 0});d(Z=>[...Z,{role:"assistant",content:z.assistant_message}]),x(z.recommendations??[]),A(z.event_suggestion??null)}catch(z){const Z=z instanceof Error?z.message:"送信に失敗しました";_(Z),d(pe=>[...pe,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{p(!1)}}async function _o(){_(null),R(!1),T(!0),v("準備中…"),E(Date.now()),M(0),D.current?.abort();const q=new AbortController;D.current=q;const ae=`chat_${Date.now()}`,z=s(ae,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{v("イベントを整えています…");const Z=await Sc({messages:u,onboardingData:ie??void 0}),pe=Xn(Z,"Image unavailable");let _e=null;try{v("画像生成を開始しています…"),_e=(await si(Z.image)).jobId}catch(be){_e=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Bn=be instanceof Error?be.message:"image job start failed";ss(a,r,z,"image-generation-start",Bn)}v("作曲を開始しています…");const Ne=await sn(Z.music);pa({v:1,kind:"chat",startedAt:Date.now(),imageJobId:_e,musicJobId:Ne.jobId,coverDataUrl:pe,refined:Z,sessionMessages:u,sessionRecommendations:y,causalLogId:z}),L(!0),c("info","生成を開始しました。完了まで待つか、あとで再開できます。");const ze=_e?Qs(_e,be=>{be.status==="queued"?v("順番待ち…"):be.status==="running"?v("画像を生成中…"):be.status==="succeeded"?v("画像ができました。仕上げ中…"):be.status==="failed"&&v("画像生成に失敗しました")},90,2e3,q.signal).catch(be=>{const Bn=be instanceof Error?be.message:"image polling failed";return ss(a,r,z,"image-generation-poll",Bn),null}):Promise.resolve(null),[Ce,le]=await Promise.all([ze,os(Ne.jobId,be=>{be.status==="queued"?v("順番待ち…"):be.status==="running"?v("作曲中…"):be.status==="succeeded"?v("作曲ができました。仕上げ中…"):be.status==="failed"&&v("作曲に失敗しました")},90,2e3,q.signal)]);if(q.signal.aborted){v("キャンセルしました");return}const es=Ce?.status==="succeeded"&&Ce?.resultUrl?Ce.resultUrl:pe;if(Ce?.status==="succeeded"&&Ce?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),le.status!=="succeeded"||!le.midiData||!le.result)throw new Error("曲生成に失敗しました");v("保存の準備をしています…");const Ie=Z?.brief?.theme?.title||"";Q({title:Ie,mood:Z.image.mood,duration:Z.image.duration,imageDataURL:es,thumbnailUrl:es,metadata:{valence:Z.analysisLike.valence,arousal:Z.analysisLike.arousal,focus:Z.analysisLike.focus,motif_tags:Z.analysisLike.motif_tags,confidence:Z.analysisLike.confidence,stylePreset:Z.image.stylePreset,provider:Jn(Ce)},musicData:le.midiData,musicFormat:"midi",musicMetadata:{key:le.result.key,tempo:le.result.tempo,timeSignature:le.result.timeSignature,form:le.result.form,character:le.result.character,duration:Z.music.duration,createdAt:Hn(),provider:le.provider},sessionData:{brief:Z.brief,recommendations:y,messages:u},causalLogId:z}),I(z),ee(!0),c("success","生成が完了しました。タイトルを決めて保存できます。"),R(!1),v(null),E(null),M(0),A(null),d(be=>[...be,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(Z){if(Z instanceof DOMException&&Z.name==="AbortError"){v("キャンセルしました"),E(null),M(0),d(_e=>[..._e,{role:"assistant",content:"生成をキャンセルしたよ。必要ならまた「今すぐ1曲つくる」で再開できる。"}]),c("info","生成をキャンセルしました。あとで再開できます。"),R(!1);return}const pe=Z instanceof Error?Z.message:"生成イベントに失敗しました";v(null),E(null),M(0),_(pe),c("error",pe),R(!0),ss(a,r,z,"generation-event",pe),d(_e=>[..._e,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{T(!1),D.current=null}}async function bo(q){if(!$){ee(!1);return}const ae=q.trim();try{C(!0);let z=ae;if(!z)try{z=(await jc({mood:$.mood,motifTags:$?.metadata?.motif_tags,character:$?.musicMetadata?.character,brief:$?.sessionData?.brief,messages:$?.sessionData?.messages})).title}catch{z=""}const Z=e({...$,title:z||void 0});t(Z.id),o(Z,[Z,...me]),l("music"),c("success","保存して再生を開始しました。"),fa(),L(!1),U&&Wc(a,U,{albumId:"local",title:z||$.mood}),A(null),d(pe=>[...pe,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{C(!1),ee(!1),Q(null),I(null)}}return i.jsxs("div",{className:"chatSession",children:[i.jsx(er,{active:b,statusText:j,elapsedSec:O,onCancel:Ve}),i.jsx(Qa,{open:Y,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>H(!1),onConfirm:()=>{H(!1),ct()}}),i.jsx(Uc,{open:X,mood:$?.mood||"穏やか",defaultTitle:$?.title,onCancel:()=>{P||(ee(!1),Q(null),I(null))},onSubmit:q=>{P||bo(q)}}),i.jsxs("div",{className:"chatHeader",children:[i.jsxs("div",{className:"chatTitle",children:[i.jsx("div",{className:"chatTitleMain",children:"対話"}),i.jsx("div",{className:"chatTitleSub",children:"話すだけで、レコメンドと創作が進む"})]}),i.jsxs("div",{className:"chatHeaderRight",children:[i.jsx("button",{className:"chatPrimary",onClick:_o,disabled:b,"data-no-swipe":!0,title:S?.reason||"会話の内容をもとに1曲生成します",children:b?"生成中…":S?.shouldTrigger?"生成イベントを開始":"今すぐ1曲つくる"}),!b&&k?i.jsx("button",{className:"chatCancel",onClick:()=>void Ts(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!b&&k&&V?i.jsx("button",{className:"chatCancel",onClick:()=>void qt(),"data-no-swipe":!0,type:"button",title:"同じ条件で生成をやり直します（失敗・停止時向け）",children:"再生成"}):null,b?i.jsx("button",{className:"chatCancel",onClick:Ve,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,!b&&k?i.jsx("button",{className:"chatCancel",onClick:()=>H(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null]})]}),j?i.jsxs("div",{className:"chatGenStatus",children:[j,N?i.jsxs("span",{className:"chatGenElapsed",children:["（",O,"s）"]}):null]}):null,S&&!S.shouldTrigger?i.jsx("div",{className:"chatHint",children:S.reason}):null,i.jsxs("div",{className:"chatLayout",children:[i.jsxs("div",{className:"chatMain",children:[i.jsx("div",{className:"chatBody",children:u.map((q,ae)=>i.jsx("div",{className:`chatMsg ${q.role==="user"?"user":"assistant"}`,children:i.jsx("div",{className:"chatBubble",children:q.content})},ae))}),i.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[m?i.jsx("div",{className:"chatError",children:m}):null,i.jsxs("div",{className:"chatComposer",children:[i.jsx("textarea",{className:"chatInput",placeholder:de.length===0?"今日のことを一言で":"続けて話して",value:h,onChange:q=>g(q.target.value),onKeyDown:q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),f||ta())},rows:2}),i.jsx("button",{className:"chatSend",onClick:ta,disabled:f||!h.trim(),children:f?"送信中…":"送信"})]})]})]}),i.jsxs("aside",{className:"chatSide","aria-label":"レコメンド",children:[i.jsxs("div",{className:"chatSideHeader",children:[i.jsx("div",{className:"chatSideTitle",children:"いまのレコメンド"}),i.jsx("div",{className:"chatSideHint",children:"30秒プレビュー（可能な場合）"})]}),y.length>0?i.jsx("ul",{className:"chatRecsList",children:y.slice(0,4).map((q,ae)=>i.jsxs("li",{className:"chatRecItem",children:[i.jsxs("div",{className:"chatRecMain",children:[i.jsx("span",{className:"chatRecComposer",children:q.composer}),i.jsx("span",{className:"chatRecSep",children:"—"}),i.jsx("span",{className:"chatRecTitle",children:q.title}),q.era?i.jsxs("span",{className:"chatRecEra",children:["(",q.era,")"]}):null]}),i.jsx("div",{className:"chatRecWhy",children:q.why}),i.jsxs("div",{className:"chatRecActions",children:[i.jsx("button",{className:"chatRecPlay",onClick:()=>void yo(q),disabled:!!js[tt(q)],"data-no-swipe":!0,children:oe===tt(q)?"停止":js[tt(q)]?"取得中…":"再生"}),et[tt(q)]?.trackUrl?i.jsx("a",{className:"chatRecOpen",href:et[tt(q)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),J[tt(q)]?i.jsx("div",{className:"chatRecErr",children:J[tt(q)]}):null]},ae))}):i.jsx("div",{className:"chatRecsEmpty",children:"会話をすると、ここにおすすめが出ます。"})]})]})]})}const Gc=()=>i.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative"},children:i.jsx($c,{})}),zc=({album:n,position:e,onClick:t,isSelected:s})=>{const a=w.useRef(null),r=w.useRef(null),o=w.useRef(0),l=.22,c=1.8,u=.55,d=n.gallery?.spineColor||"#111111",h=n.title||n.mood,g=w.useMemo(()=>new Date(n.createdAt).toLocaleDateString("ja-JP",{year:"2-digit",month:"2-digit",day:"2-digit"}),[n.createdAt]),f=ko(Co,n.imageDataURL);return w.useEffect(()=>{f.colorSpace=Ao,f.anisotropy=4,f.needsUpdate=!0},[f]),Ht((p,m)=>{const _=s?1:0;if(o.current=Qn.lerp(o.current,_,1-Math.exp(-8*m)),r.current){const y=o.current;r.current.position.z=u/2+.04+y*.7,r.current.position.y=y*.08,r.current.scale.setScalar(.92+y*.08),r.current.visible=y>.01}if(a.current){const y=o.current;a.current.scale.y=1+y*.02}}),i.jsxs("group",{position:e,children:[i.jsxs("mesh",{ref:a,onClick:t,castShadow:!0,receiveShadow:!0,children:[i.jsx("boxGeometry",{args:[l,c,u]}),i.jsx("meshStandardMaterial",{color:d,roughness:.9,metalness:.05})]}),i.jsxs("group",{position:[l/2-.05,c/2-.12,u/2+.03],children:[n.isPublic&&i.jsxs("mesh",{position:[0,0,0],children:[i.jsx("boxGeometry",{args:[.06,.06,.02]}),i.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1})]}),n.isFavorite&&i.jsxs("mesh",{position:[0,-.08,0],children:[i.jsx("boxGeometry",{args:[.06,.06,.02]}),i.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1})]})]}),i.jsxs("group",{position:[0,0,u/2+.01],children:[i.jsx(na,{fontSize:.12,color:d==="#111111"?"#f5f5f5":"#111111",anchorX:"center",anchorY:"middle",maxWidth:.9,children:h}),i.jsx(na,{position:[0,-.16,0],fontSize:.08,color:d==="#111111"?"#f5f5f5":"#111111",fillOpacity:d==="#111111"?.75:.55,anchorX:"center",anchorY:"middle",maxWidth:.9,children:g})]}),i.jsxs("group",{ref:r,position:[0,.05,u/2+.04],visible:!1,children:[i.jsxs("mesh",{onClick:t,castShadow:!0,children:[i.jsx("planeGeometry",{args:[1.1,1.55]}),i.jsx("meshStandardMaterial",{map:f,roughness:.85,metalness:0})]}),i.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[1.14,1.6]}),i.jsx("meshStandardMaterial",{color:"#ffffff",roughness:1,metalness:0,opacity:.6,transparent:!0})]})]})]})},Yc=({albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})=>{const[a,r]=w.useState(null),o=w.useRef(null),l=w.useRef(0),c=w.useRef(0),u=.32,d=Math.max(0,(n.length-1)*u),h=w.useMemo(()=>n.map((g,f)=>({x:-f*u,y:0,z:0})),[n,u]);return Ht((g,f)=>{const p=s.current,m=.0022,_=p.wheelPx*m,y=p.dragPx*m;_!==0&&(c.current+=_*26,p.wheelPx=0),y!==0&&(l.current-=y,c.current=Qn.lerp(c.current,-y*60,.35),p.dragPx=0);const x=p.isDragging?.88:.92;c.current*=Math.pow(x,f*60),l.current+=c.current*f;const S=.9,A=40;if(l.current<-S?(l.current=-S,c.current*=-.35):l.current>d+S&&(l.current=d+S,c.current*=-.35),l.current<0?c.current+=(0-l.current)*A*f:l.current>d&&(c.current-=(l.current-d)*A*f),!p.isDragging&&Math.abs(c.current)<.15&&n.length>0){const j=Math.max(0,Math.min(n.length-1,Math.round(l.current/u)))*u;l.current=Qn.lerp(l.current,j,1-Math.exp(-10*f))}o.current&&(o.current.position.x=l.current)}),i.jsxs("group",{children:[i.jsxs("mesh",{position:[0,-1.05,-.25],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[30,6]}),i.jsx("meshStandardMaterial",{color:"#f5f5f5",roughness:1,metalness:0})]}),i.jsxs("mesh",{position:[0,.4,-.6],receiveShadow:!0,children:[i.jsx("planeGeometry",{args:[30,8]}),i.jsx("meshStandardMaterial",{color:"#fafafa",roughness:1,metalness:0})]}),i.jsx("group",{ref:o,children:n.map((g,f)=>{const p=h[f],m=[p.x,p.y,p.z];return i.jsx(zc,{album:g,position:m,onClick:()=>{r(g.id),l.current=f*u,c.current=0,e(g.id)},isSelected:a===g.id},g.id)})}),i.jsx("ambientLight",{intensity:.55}),i.jsx("directionalLight",{position:[4,6,6],intensity:.65,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),i.jsx("directionalLight",{position:[-3,3,4],intensity:.22})]})},Hc=({albums:n,onBookClick:e,constellationEnabled:t})=>{const s=w.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0});return i.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:a=>{a.preventDefault();const r=Math.abs(a.deltaX)>Math.abs(a.deltaY)?a.deltaX:a.deltaY;s.current.wheelPx+=r},onPointerDown:a=>{a.currentTarget.setPointerCapture(a.pointerId),s.current.isDragging=!0,s.current.lastPointerX=a.clientX},onPointerMove:a=>{if(!s.current.isDragging)return;const r=a.clientX-s.current.lastPointerX;s.current.lastPointerX=a.clientX,s.current.dragPx+=r},onPointerUp:a=>{try{a.currentTarget.releasePointerCapture(a.pointerId)}catch{}s.current.isDragging=!1},onPointerCancel:()=>{s.current.isDragging=!1},children:i.jsx(gs,{shadows:!0,camera:{position:[0,1.1,6.5],fov:32},gl:{alpha:!0,antialias:!0},children:i.jsx(w.Suspense,{fallback:null,children:i.jsx(Yc,{albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})})})})},$t=({title:n,mood:e,imageUrl:t,meta:s,badges:a=[],variant:r="default",className:o})=>i.jsxs("div",{className:`album-card album-card-${r} ${o||""}`.trim(),children:[i.jsx("div",{className:"album-card-image",children:i.jsx("img",{src:t,alt:n,loading:"lazy"})}),i.jsxs("div",{className:"album-card-body",children:[i.jsx("div",{className:"album-card-title",children:n}),e&&i.jsx("div",{className:"album-card-mood",children:e}),s&&i.jsx("div",{className:"album-card-meta",children:s}),a.length>0&&i.jsx("div",{className:"album-card-badges",children:a.map(l=>i.jsx("span",{className:`album-badge tone-${l.tone||"default"}`,children:l.label},l.label))})]})]}),Xc=({title:n,description:e,actionLabel:t,onAction:s,icon:a})=>i.jsxs("div",{className:"empty-state",children:[a&&i.jsx("div",{className:"empty-icon",children:a}),i.jsx("h2",{className:"empty-title",children:n}),i.jsx("p",{className:"empty-description",children:e}),t&&s&&i.jsx("button",{onClick:s,className:"empty-cta-button",children:t})]}),nn=({trigger:n,children:e,placement:t="bottom",triggerClassName:s,triggerAriaLabel:a,triggerAriaHaspopup:r,onOpenChange:o})=>{const[l,c]=w.useState(!1),u=w.useRef(null),d=w.useRef(null),h=w.useId(),g=()=>{c(!1),o?.(!1),d.current?.focus()},f=()=>{c(p=>{const m=!p;return o?.(m),m})};return w.useEffect(()=>{if(!l)return;const p=_=>{u.current?.contains(_.target)||g()},m=_=>{_.key==="Escape"&&(_.preventDefault(),g())};return document.addEventListener("mousedown",p),document.addEventListener("keydown",m),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",m)}},[l]),i.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[i.jsx("button",{ref:d,type:"button",className:`popover-trigger ${s||""}`.trim(),onClick:f,"aria-expanded":l,"aria-controls":l?h:void 0,"aria-label":a,"aria-haspopup":r,children:n}),l&&i.jsx("div",{className:"popover-panel",id:h,children:typeof e=="function"?e({close:g}):e})]})},an=({items:n,autoFocus:e=!0})=>{const[t,s]=F.useState(0),a=F.useRef([]);F.useEffect(()=>{if(!e||n.length===0)return;const l=a.current[0];l&&l.focus()},[e,n.length]);const r=l=>{const c=Math.max(0,Math.min(n.length-1,l));s(c),a.current[c]?.focus()},o=l=>{if(n.length!==0){if(l.key==="ArrowDown"){l.preventDefault(),r(t+1);return}if(l.key==="ArrowUp"){l.preventDefault(),r(t-1);return}if(l.key==="Home"){l.preventDefault(),r(0);return}if(l.key==="End"){l.preventDefault(),r(n.length-1);return}}};return i.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:o,children:n.map((l,c)=>i.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:c===t?0:-1,ref:u=>{a.current[c]=u},onFocus:()=>s(c),onClick:()=>{s(c),l.onSelect()},type:"button",children:l.label},l.id))})},tr=({items:n,value:e,onChange:t,ariaLabel:s="タブ"})=>{const a=w.useId();return i.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[i.jsx("div",{className:"tabs-list",role:"tablist","aria-label":s,children:n.map(r=>i.jsx("button",{id:`${a}-${r.id}-tab`,role:"tab","aria-selected":e===r.id,"aria-controls":`${a}-${r.id}-panel`,className:`tab-button ${e===r.id?"is-active":""}`,onClick:()=>t(r.id),type:"button",children:r.label},r.id))}),n.map(r=>i.jsx("div",{id:`${a}-${r.id}-panel`,role:"tabpanel","aria-labelledby":`${a}-${r.id}-tab`,hidden:e!==r.id,className:"tab-panel",children:r.content},r.id))]})},ni=({options:n,value:e,onChange:t,ariaLabel:s="選択"})=>i.jsx("div",{className:"segmented-control",role:"group","aria-label":s,"data-no-swipe":"true",children:n.map(a=>i.jsx("button",{type:"button",className:`segmented-item ${e===a.id?"is-active":""}`,"aria-pressed":e===a.id,onClick:()=>t(a.id),children:a.label},a.id))}),Jc=()=>{const{albums:n,selectAlbum:e,updateAlbum:t}=xt(),{getSelectedAlbum:s}=xt(),a=s(),{requestPlayAlbum:r}=Ot(),{navigateToRoom:o}=pt(),[l,c]=F.useState("shelf"),[u,d]=F.useState("all"),[h,g]=F.useState("new"),[f,p]=F.useState("public"),m=v=>{e(v)},_=F.useMemo(()=>n.filter(v=>v.musicData),[n]),y=!!a,x=!!a?.musicData,S=F.useMemo(()=>{const v=n.filter(E=>u==="public"?E.isPublic:u==="private"?!E.isPublic:u==="favorite"?E.isFavorite:!0),N=E=>{const O=Number(E.duration||0);return(E.musicData?1e3:0)+O};return v.slice().sort((E,O)=>h==="duration"?(O.duration||0)-(E.duration||0):h==="popular"?N(O)-N(E):String(O.createdAt).localeCompare(String(E.createdAt)))},[n,u,h]),A=h==="popular"?"人気順":h==="duration"?"長さ順":"新しい順",b=i.jsxs("div",{className:"bookshelf-container",children:[i.jsxs("div",{className:`gallery-shelf-stage ${S.length===0?"empty":""}`,children:[i.jsx(Hc,{albums:S,onBookClick:m,constellationEnabled:!1}),i.jsx("div",{className:"bookshelf-overlay-grid","aria-hidden":"true",children:S.map(v=>!v.gallery||!(v.isPublic||v.isFavorite)?null:i.jsx("div",{className:`bookshelf-badge ${a?.id===v.id?"is-selected":""}`,style:{gridColumn:v.gallery.positionIndex+1,gridRow:v.gallery.shelfIndex+1},children:v.isPublic||v.isFavorite?f==="favorite"&&v.isFavorite?i.jsxs("span",{className:"badge-chip badge-favorite badge-compact is-priority",children:[i.jsx("span",{className:"badge-dot"}),"お気に入り"]}):v.isPublic?i.jsxs("span",{className:`badge-chip badge-public badge-compact ${f==="public"?"is-priority":""}`.trim(),children:[i.jsx("span",{className:"badge-dot"}),"公開"]}):i.jsxs("span",{className:"badge-chip badge-favorite badge-compact",children:[i.jsx("span",{className:"badge-dot"}),"お気に入り"]}):null},v.id))}),S.length===0&&i.jsx("div",{className:"empty-shelf-overlay",children:i.jsx(Xc,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>o("main"),icon:i.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),i.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[i.jsxs("div",{className:"gallery-selection",children:[i.jsx("div",{className:"gallery-selection-label",children:"選択中"}),i.jsx("div",{className:"gallery-selection-value",children:a?a.title||a.mood:"未選択"})]}),i.jsxs("div",{className:"gallery-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!y,onClick:()=>o("album"),children:"開く"}),i.jsx("button",{className:"btn btn-primary",disabled:!x||!a,onClick:()=>{a&&r(a,_)},children:"再生"}),i.jsx("button",{className:"btn",disabled:!y,onClick:()=>o("social"),children:"公開"}),i.jsx(nn,{triggerClassName:"btn",trigger:i.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:v})=>i.jsx(an,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{o("album"),v()}},{id:"publish",label:"SNSに公開",onSelect:()=>{o("social"),v()}},{id:"play",label:"再生",onSelect:()=>{a&&(r(a,_),v())}},{id:"favorite",label:a?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{a&&(t(a.id,{isFavorite:!a.isFavorite}),v())}},{id:"public",label:a?.isPublic?"非公開にする":"公開にする",onSelect:()=>{a&&(t(a.id,{isPublic:!a.isPublic}),v())}}]})})]})]})]}),T=i.jsx("div",{className:"gallery-focus",children:a?i.jsxs("div",{className:"gallery-focus-card room-card",children:[i.jsx($t,{title:a.title||a.mood,mood:a.mood,imageUrl:a.imageDataURL,meta:`作成日: ${new Date(a.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:a.musicData?"再生可能":"音声なし",tone:a.musicData?"success":"default"},...a.isPublic?[{label:"公開中",tone:"info"}]:[],...a.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),i.jsxs("div",{className:"gallery-focus-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:()=>o("album"),children:"詳細へ"}),i.jsx("button",{className:"btn btn-primary",disabled:!a.musicData,onClick:()=>r(a,_),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>o("social"),children:"公開"})]})]}):i.jsxs("div",{className:"gallery-focus-empty room-card",children:[i.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),i.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),j=[{id:"shelf",label:"Shelf",content:b},{id:"focus",label:"Focus",content:T}];return i.jsxs("div",{className:"room-content gallery-room",children:[i.jsx(Ka,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),i.jsx("h1",{className:"room-title",children:"GALLERY"}),i.jsx("p",{className:"room-subtitle",children:"スクロールで時間を辿り、クリックで選ぶ"}),i.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"gallery-toolbar-left",children:[i.jsx(ni,{value:u,onChange:v=>d(v),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),i.jsxs("div",{className:"gallery-filter-tags",children:[i.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),i.jsx("span",{className:"filter-tag",children:A}),i.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",f==="public"?"公開":"お気に入り"]})]})]}),i.jsxs("div",{className:"gallery-toolbar-right",children:[i.jsx(ni,{value:f,onChange:v=>p(v),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),i.jsx(nn,{triggerClassName:"btn",trigger:i.jsxs("span",{children:["並び替え: ",A]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:v})=>i.jsx(an,{items:[{id:"new",label:"新しい順",onSelect:()=>{g("new"),v()}},{id:"popular",label:"人気順",onSelect:()=>{g("popular"),v()}},{id:"duration",label:"長さ順",onSelect:()=>{g("duration"),v()}}]})})]})]}),i.jsx(tr,{items:j,value:l,onChange:c,ariaLabel:"ギャラリー表示"})]})},Zc=2147483647,Kc=({log:n})=>{if(!n)return i.jsxs("div",{className:"explainability-panel",children:[i.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),i.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const s=Math.round(t/1e3);if(s<60)return`${s}秒`;const a=Math.floor(s/60),r=s%60;return`${a}分${r}秒`};return i.jsxs("div",{className:"explainability-panel",children:[i.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),n.analysis&&i.jsxs("div",{className:"explainability-section timeline-section",children:[i.jsx("h4",{className:"section-title",children:"生成フロー"}),i.jsxs("div",{className:"timeline",children:[i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"入力"}),i.jsx("span",{className:"timeline-value",children:new Date(n.input.timestamp).toLocaleTimeString("ja-JP")})]}),n.analysis&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"解析"}),i.jsxs("span",{className:"timeline-value",children:[e(n.analysis.duration)," (",n.analysis.provider,")"]})]}),n.imageGeneration&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"画像生成"}),i.jsxs("span",{className:"timeline-value",children:[e(n.imageGeneration.duration)," (",n.imageGeneration.provider,")"]})]}),n.musicGeneration&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"音楽生成"}),i.jsxs("span",{className:"timeline-value",children:[e(n.musicGeneration.duration)," (",n.musicGeneration.provider,")"]})]}),n.album&&i.jsxs("div",{className:"timeline-item",children:[i.jsx("span",{className:"timeline-label",children:"完成"}),i.jsxs("span",{className:"timeline-value",children:["合計: ",e(n.totalDuration)]})]})]})]}),n.analysis&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"感情分析"}),i.jsxs("div",{className:"analysis-explanation",children:[i.jsxs("div",{className:"ir-values",children:[i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Valence:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${(n.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:n.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.valence.toFixed(2)})]}),i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Arousal:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),i.jsxs("div",{className:"ir-value",children:[i.jsx("span",{className:"ir-label",children:"Focus:"}),i.jsx("div",{className:"ir-gauge",children:i.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),i.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),i.jsxs("div",{className:"motif-tags",children:[i.jsx("strong",{children:"モチーフタグ:"})," ",n.analysis.intermediateRepresentation.motif_tags.join("、")]}),i.jsxs("div",{className:"reasoning-text",children:[i.jsx("strong",{children:"理由:"})," ",n.analysis.reasoning]})]})]}),n.imageGeneration&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),i.jsxs("div",{className:"image-explanation",children:[i.jsx("p",{className:"reasoning-text",children:n.imageGeneration.reasoning}),i.jsxs("div",{className:"image-details",children:[i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"スタイル:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.stylePreset})]}),n.imageGeneration.seed&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"Seed:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.seed})]}),i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"モデル:"}),i.jsx("span",{className:"detail-value",children:n.imageGeneration.model})]})]})]})]}),n.musicGeneration&&i.jsxs("div",{className:"explainability-section",children:[i.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),i.jsxs("div",{className:"music-explanation",children:[i.jsx("p",{className:"reasoning-text",children:n.musicGeneration.reasoning}),i.jsx("div",{className:"music-details",children:n.musicGeneration.structure&&typeof n.musicGeneration.structure=="object"&&i.jsxs(i.Fragment,{children:[n.musicGeneration.structure.key&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"調:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.key})]}),n.musicGeneration.structure.tempo&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"テンポ:"}),i.jsxs("span",{className:"detail-value",children:[n.musicGeneration.structure.tempo," BPM"]})]}),n.musicGeneration.structure.timeSignature&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"拍子:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.timeSignature})]}),n.musicGeneration.structure.form&&i.jsxs("div",{className:"detail-item",children:[i.jsx("span",{className:"detail-label",children:"形式:"}),i.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.form})]})]})})]})]}),n.errors&&n.errors.length>0&&i.jsxs("div",{className:"explainability-section error-section",children:[i.jsx("h4",{className:"section-title",children:"エラー"}),i.jsx("div",{className:"errors-list",children:n.errors.map((t,s)=>i.jsxs("div",{className:"error-item",children:[i.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),i.jsx("span",{className:"error-message",children:t.error})]},s))})]})]})},Qc=({dominantColors:n=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:s=0,highlightedLayer:a=-1})=>{const r=w.useRef(null),o=w.useRef(),l=w.useRef([]);return w.useEffect(()=>{const c=r.current;if(!c)return;const u=c.getContext("2d");if(!u)return;const d=()=>{const p=c.parentElement;p&&(c.width=p.clientWidth,c.height=p.clientHeight)};d(),window.addEventListener("resize",d);const h=Math.min(5,n.length+2);l.current=Array.from({length:h},(p,m)=>({radius:50+m*30,maxRadius:200+m*50,color:n[m%n.length]||"#D4AF37",phase:m*Math.PI*2/h,phaseSpeed:5e-4+m*2e-4}));let g=0;const f=p=>{const m=p-g;g=p,u.clearRect(0,0,c.width,c.height);const _=c.width/2,y=c.height/2;l.current.forEach((x,S)=>{x.phase+=x.phaseSpeed*m;const A=Math.sin(x.phase),b=20+(e?t*30:0),T=x.radius+A*b,j=.1,v=.3,N=s*.2,E=a===S?.3:0,O=e?t*.15:0,M=Math.min(v,j+N+E+O),D=u.createRadialGradient(_,y,T-20,_,y,T+20);D.addColorStop(0,`${x.color}00`),D.addColorStop(.5,`${x.color}${Math.floor(M*255).toString(16).padStart(2,"0")}`),D.addColorStop(1,`${x.color}00`),u.fillStyle=D,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(_,y,T,0,Math.PI*2),u.fill()}),o.current=requestAnimationFrame(f)};return o.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",d),o.current&&cancelAnimationFrame(o.current),u.clearRect(0,0,c.width,c.height)}},[n,e,t,s,a]),i.jsx("canvas",{ref:r,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},el=()=>{const[n,e]=w.useState({x:0,y:0});return w.useEffect(()=>{const t=s=>{e({x:s.clientX,y:s.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),n},tl=(n,e=200)=>{const[t,s]=w.useState(0),a=el();return w.useEffect(()=>{if(!n.current)return;const r=n.current.getBoundingClientRect(),o=r.left+r.width/2,l=r.top+r.height/2,c=Math.sqrt(Math.pow(a.x-o,2)+Math.pow(a.y-l,2)),u=Math.max(0,1-c/e);s(u)},[a,n,e]),t},sl=()=>{const{getSelectedAlbum:n,selectAlbum:e,addAlbum:t,updateAlbum:s}=xt(),{getLog:a}=za(),{state:r,requestPlayAlbum:o}=Ot(),{navigateToRoom:l}=pt(),c=n(),[u,d]=w.useState("");w.useEffect(()=>{d(c?.memo||"")},[c?.id]);const h=c?.causalLogId?a(c.causalLogId):void 0,[g,f]=w.useState(!1),[p,m]=w.useState(null),[_,y]=w.useState(!1),x=w.useRef(null),S=tl(x,300),[A,b]=w.useState(-1),T=M=>{const D=x.current;if(!D)return;const k=D.getBoundingClientRect(),L=(M.clientX-k.left)/Math.max(1,k.width),V=(M.clientY-k.top)/Math.max(1,k.height),R=Math.max(0,Math.min(1,L)),B=Math.max(0,Math.min(1,V)),Y=(R-.5)*10,H=(.5-B)*7;D.style.setProperty("--tilt-x",`${H.toFixed(2)}deg`),D.style.setProperty("--tilt-y",`${Y.toFixed(2)}deg`),D.style.setProperty("--shine-x",`${(R*100).toFixed(1)}%`),D.style.setProperty("--shine-y",`${(B*100).toFixed(1)}%`)},j=()=>{const M=x.current;M&&(M.style.setProperty("--tilt-x","0deg"),M.style.setProperty("--tilt-y","0deg"),M.style.setProperty("--shine-x","50%"),M.style.setProperty("--shine-y","45%"))},v=c?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],N=r.playbackState===ut.PLAYING&&r.currentAlbum?.id===c?.id,E=()=>{e(null),l("gallery")},O=async()=>{if(!c||!c.metadata){m("メタデータが見つかりません");return}try{f(!0),m(null),y(!1);const M=Math.floor(Math.random()*Zc),D=await si({mood:c.mood,duration:c.duration,motifTags:c.metadata.motif_tags||[],stylePreset:c.metadata.stylePreset,seed:M,valence:c.metadata.valence,arousal:c.metadata.arousal,focus:c.metadata.focus,confidence:c.metadata.confidence}),k=await Qs(D.jobId,L=>{console.log("Regenerate status:",L)});if(k.status==="succeeded"&&k.resultUrl)t({mood:c.mood,duration:c.duration,imageDataURL:k.resultUrl,sessionData:c.sessionData,metadata:{...c.metadata,seed:M}}),y(!0),setTimeout(()=>y(!1),3e3);else throw new Error(k.errorMessage||"再生成に失敗しました")}catch(M){m(M instanceof Error?M.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",M)}finally{f(!1)}};return c?i.jsxs("div",{className:"room-content album-room",children:[i.jsxs("div",{className:"album-header room-header",children:[i.jsxs("div",{className:"album-header-left",children:[i.jsx("h1",{className:"album-title",children:c.title||c.mood}),i.jsxs("p",{className:"album-subtitle",children:["ムード: ",c.mood," ・ 選択したアルバムの詳細"]})]}),i.jsxs("div",{className:"album-header-actions room-header-actions",children:[i.jsx("button",{className:"btn back-to-gallery-btn",onClick:E,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),i.jsx("button",{className:"btn btn-primary",disabled:!c.musicData,onClick:()=>o(c),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>l("social"),children:"公開"}),i.jsx(nn,{triggerClassName:"btn",trigger:i.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:M})=>i.jsx(an,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{l("gallery"),M()}},{id:"publish",label:"SNSに公開",onSelect:()=>{l("social"),M()}},{id:"play",label:"再生",onSelect:()=>{o(c),M()}},{id:"favorite",label:c.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{s(c.id,{isFavorite:!c.isFavorite}),M()}},{id:"public",label:c.isPublic?"非公開にする":"公開にする",onSelect:()=>{s(c.id,{isPublic:!c.isPublic}),M()}}]})})]})]}),i.jsxs("div",{className:"album-details",children:[i.jsxs("div",{className:`album-image-container ${N?"is-playing":""}`,ref:x,onMouseMove:T,onMouseLeave:j,children:[i.jsx(Qc,{dominantColors:v,isPlaying:N,beatAmplitude:0,mouseProximity:S,highlightedLayer:A}),i.jsx("img",{src:c.imageDataURL,alt:`${c.mood}のセッション画像`,className:"album-image"})]}),i.jsxs("div",{className:"album-metadata",children:[i.jsx("div",{className:"album-summary-card",children:i.jsx($t,{variant:"compact",title:c.title||c.mood,mood:c.mood,imageUrl:c.imageDataURL,meta:`作成日: ${new Date(c.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:c.musicData?"再生可能":"音声なし",tone:c.musicData?"success":"default"},...c.isPublic?[{label:"公開中",tone:"info"}]:[],...c.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),i.jsxs("section",{className:"metadata-section","aria-label":"アルバムメモ",children:[i.jsx("h2",{className:"metadata-section-title",children:"メモ（ひとこと）"}),i.jsx("textarea",{className:"album-memo-input",value:u,onChange:M=>d(M.target.value),onBlur:()=>{const M=u.trim();(c.memo||"")!==M&&s(c.id,{memo:M||void 0})},placeholder:"この作品にひとこと。気づき、風景、だれにも見せないメモでも。",rows:3}),i.jsx("div",{className:"album-memo-hint",children:"フォーカスが外れると自動で保存します。"})]}),i.jsxs("div",{className:"metadata-section room-card",children:[i.jsx("h3",{className:"metadata-section-title",children:"基本情報"}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"ムード"}),i.jsx("span",{className:"metadata-value",children:c.mood})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"セッション時間"}),i.jsxs("span",{className:"metadata-value",children:[c.duration,"秒"]})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"作成日"}),i.jsx("span",{className:"metadata-value",children:new Date(c.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),c.metadata&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"metadata-section room-card",children:[i.jsx("h3",{className:"metadata-section-title",children:"感情分析 (IR)"}),c.metadata.valence!==void 0&&i.jsxs("div",{className:"metadata-item",onMouseEnter:()=>b(0),onMouseLeave:()=>b(-1),children:[i.jsx("span",{className:"metadata-label",children:"Valence"}),i.jsxs("span",{className:"metadata-value",children:[c.metadata.valence.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.valence>0?"明るい":"暗い",")"]})]})]}),c.metadata.arousal!==void 0&&i.jsxs("div",{className:"metadata-item",onMouseEnter:()=>b(1),onMouseLeave:()=>b(-1),children:[i.jsx("span",{className:"metadata-label",children:"Arousal"}),i.jsxs("span",{className:"metadata-value",children:[c.metadata.arousal.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.arousal>.6?"動的":"静的",")"]})]})]}),c.metadata.focus!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"Focus"}),i.jsxs("span",{className:"metadata-value",children:[c.metadata.focus.toFixed(2),i.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),c.metadata.confidence!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"信頼度"}),i.jsxs("span",{className:"metadata-value",children:[Math.round(c.metadata.confidence*100),"%"]})]}),c.metadata.motif_tags&&c.metadata.motif_tags.length>0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"モチーフ"}),i.jsx("span",{className:"metadata-value metadata-tags",children:c.metadata.motif_tags.join(", ")})]})]}),i.jsxs("div",{className:"metadata-section room-card",children:[i.jsx("h3",{className:"metadata-section-title",children:"生成パラメータ"}),c.metadata.stylePreset&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"スタイル"}),i.jsx("span",{className:"metadata-value",children:c.metadata.stylePreset})]}),c.metadata.seed!==void 0&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"シード"}),i.jsx("span",{className:"metadata-value metadata-id",children:c.metadata.seed})]}),c.metadata.provider&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"生成方法"}),i.jsx("span",{className:"metadata-value",children:c.metadata.provider==="replicate"?"Replicate (SDXL)":c.metadata.provider==="local"?"ローカル生成":c.metadata.provider})]})]}),c.musicMetadata&&i.jsxs("div",{className:"metadata-section",children:[i.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"調"}),i.jsx("span",{className:"metadata-value",children:c.musicMetadata.key})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"テンポ"}),i.jsxs("span",{className:"metadata-value",children:[c.musicMetadata.tempo," BPM"]})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"拍子"}),i.jsx("span",{className:"metadata-value",children:c.musicMetadata.timeSignature})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"形式"}),i.jsx("span",{className:"metadata-value",children:c.musicMetadata.form})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"性格"}),i.jsx("span",{className:"metadata-value",children:c.musicMetadata.character})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"生成方法"}),i.jsx("span",{className:"metadata-value",children:c.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":c.musicMetadata.provider==="rule-based"?"ルールベース":c.musicMetadata.provider})]}),c.musicData&&i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"フォーマット"}),i.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(c.musicData.length/1024)," KB)"]})]})]}),c.metadata.provider==="replicate"&&i.jsxs("div",{className:"album-actions",children:[i.jsx("button",{className:"regenerate-btn",onClick:O,disabled:g,children:g?"再生成中...":"再生成 (新しいシード)"}),_&&i.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),p&&i.jsx("div",{className:"regenerate-error",children:p})]})]}),i.jsxs("div",{className:"metadata-item",children:[i.jsx("span",{className:"metadata-label",children:"アルバムID"}),i.jsx("span",{className:"metadata-value metadata-id",children:c.id})]})]}),i.jsx(Kc,{log:h})]})]}):i.jsxs("div",{className:"room-content album-room",children:[i.jsx("h1",{className:"room-title",children:"ALBUM"}),i.jsx("p",{className:"room-subtitle",children:"アルバム詳細"}),i.jsxs("div",{className:"album-empty",children:[i.jsx("p",{children:"アルバムが選択されていません"}),i.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})]})},nl=()=>{const{albums:n,getSelectedAlbum:e,selectAlbum:t}=xt(),s=e(),{navigateToRoom:a}=pt(),{requestPlayAlbum:r}=Ot(),[o,l]=F.useState("now"),c=n.filter(h=>h.musicData),u=s&&s.musicData?i.jsxs("div",{className:"music-panel",children:[i.jsx($t,{title:s.title||s.mood,mood:s.mood,imageUrl:s.imageDataURL,meta:`作成日: ${new Date(s.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...s.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...s.isPublic?[{label:"公開",tone:"info"}]:[]]}),s.musicMetadata&&i.jsxs("div",{className:"music-meta-grid room-card",children:[i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"調"}),i.jsx("span",{children:s.musicMetadata.key})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"テンポ"}),i.jsxs("span",{children:[s.musicMetadata.tempo," BPM"]})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"拍子"}),i.jsx("span",{children:s.musicMetadata.timeSignature})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"形式"}),i.jsx("span",{children:s.musicMetadata.form})]}),i.jsxs("div",{className:"music-meta-row",children:[i.jsx("span",{className:"music-meta-label",children:"性格"}),i.jsx("span",{children:s.musicMetadata.character})]})]}),i.jsxs("div",{className:"music-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:()=>r(s,c),children:"再生"}),i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"})]})]}):i.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),d=i.jsxs("div",{className:"music-panel",children:[i.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",c.length,"件"]}),c.length>0?i.jsx("div",{className:"music-library-grid",children:c.map(h=>i.jsx("button",{className:"album-card-button",onClick:()=>{t(h.id),r(h,c)},children:i.jsx($t,{title:h.title||h.mood,mood:h.mood,imageUrl:h.imageDataURL,meta:h.musicMetadata?`${h.musicMetadata.key} | ${h.musicMetadata.tempo} BPM | ${h.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...h.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...h.isPublic?[{label:"公開",tone:"info"}]:[]]})},h.id))}):i.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return i.jsxs("div",{className:"room-content music-room",children:[i.jsxs("div",{className:"room-header music-header",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"MUSIC"}),i.jsx("p",{className:"room-subtitle",children:"選択したアルバムを再生する"})]}),i.jsx("div",{className:"room-header-actions",children:i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"})})]}),i.jsx(tr,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:d}],value:o,onChange:l,ariaLabel:"音楽タブ"})]})},Pt="https://airia-beyond.onrender.com";async function il(n=50,e="all"){const t=await Ke(`${Pt}/api/social/posts?limit=${encodeURIComponent(String(n))}&mode=${encodeURIComponent(String(e))}`);if(!t.ok)throw new Error(`Failed to load posts: ${t.status}`);return t.json()}async function al(n=50){const e=await Ke(`${Pt}/api/social/me/posts?limit=${encodeURIComponent(String(n))}`),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to load my posts: ${e.status}`);return t}async function rl(n){const e=await Ke(`${Pt}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function ol(n){const e=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function cl(n,e){const t=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to comment: ${t.status}`);return s}async function ll(n){const e=await Ke(`${Pt}/api/social/users/${encodeURIComponent(n)}/follow`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to follow: ${e.status}`);return t}async function sr(n,e){const t=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:e})}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to update post: ${t.status}`);return s}async function nr(n){const e=await Ke(`${Pt}/api/social/posts/${encodeURIComponent(n)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to delete post: ${e.status}`);return t}const ul={comment:i.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:i.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:i.jsxs(i.Fragment,{children:[i.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),i.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:i.jsx("path",{d:"M6 9l6 6 6-6"}),more:i.jsxs(i.Fragment,{children:[i.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),i.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),i.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},Hs=({name:n,size:e=16,className:t})=>i.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:ul[n]}),dl=()=>{const{albums:n,getSelectedAlbum:e,updateAlbum:t}=xt(),s=e(),{navigateToRoom:a}=pt(),[r,o]=F.useState([]),[l,c]=F.useState(!1),[u,d]=F.useState(null),{user:h,logout:g,updateFollowingIds:f}=Os(),[p,m]=F.useState(""),[_,y]=F.useState(s?.id||(n[0]?.id??"")),[x,S]=F.useState(!1),[A,b]=F.useState({}),[T,j]=F.useState(null),[v,N]=F.useState("all"),[E,O]=F.useState({}),[M,D]=F.useState(null),k=F.useCallback(()=>{try{const P=String(window.location.hash||"").match(/^#social\/(.+)$/);if(P&&P[1])return decodeURIComponent(P[1])}catch{}try{const I="airia_social_focus_post_v1",P=localStorage.getItem(I);if(P)return localStorage.removeItem(I),String(P)}catch{}return null},[]),L=async I=>{const P=`${window.location.origin}/#social/${I}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(P);else{const C=document.createElement("input");C.value=P,document.body.appendChild(C),C.select(),document.execCommand("copy"),document.body.removeChild(C)}d("リンクをコピーしました"),setTimeout(()=>d(null),1500)}catch(C){d(C instanceof Error?C.message:String(C))}},V=F.useCallback(async()=>{c(!0),d(null);try{const I=await il(50,v);o(I.posts||[]);const P=M||k();P&&(D(P),O(C=>({...C,[P]:!0})),window.setTimeout(()=>{const C=document.querySelector(`[data-post-id="${CSS.escape(P)}"]`);C&&"scrollIntoView"in C&&C.scrollIntoView({block:"start",behavior:"smooth"})},60))}catch(I){d(I instanceof Error?I.message:String(I))}finally{c(!1)}},[k,v,M]);F.useEffect(()=>{V()},[V]),F.useEffect(()=>{s?.id&&y(s.id)},[s?.id]);const R=F.useMemo(()=>n.find(I=>I.id===_)||null,[n,_]),B=!!h&&!!R?.imageDataURL&&!x,Y=async()=>{if(!h){d("投稿にはログインが必要です");return}if(R){S(!0),d(null);try{const I=await rl({caption:p,album:{title:R.title||R.mood,mood:R.mood,imageUrl:R.thumbnailUrl||R.imageDataURL,createdAt:R.createdAt}});o(P=>[I,...P]),R.isPublic||t(R.id,{isPublic:!0}),m("")}catch(I){d(I instanceof Error?I.message:String(I))}finally{S(!1)}}},H=async I=>{if(!h){d("いいねにはログインが必要です");return}try{const P=await ol(I);o(C=>C.map(W=>W.id===I?P:W))}catch(P){d(P instanceof Error?P.message:String(P))}},X=async I=>{if(!h){d("コメントにはログインが必要です");return}const P=(A[I]||"").trim();if(P){j(I),d(null);try{const C=await cl(I,{text:P});o(W=>W.map(oe=>oe.id===I?{...oe,comments:Array.isArray(oe.comments)?[...oe.comments,C]:[C]}:oe)),b(W=>({...W,[I]:""}))}catch(C){d(C instanceof Error?C.message:String(C))}finally{j(null)}}},ee=async I=>{if(!h){d("フォローにはログインが必要です");return}try{const P=await ll(I);f(P.followingIds)}catch(P){d(P instanceof Error?P.message:String(P))}},$=I=>{O(P=>({...P,[I]:!P[I]}))},Q=async I=>{if(!h){d("操作にはログインが必要です");return}const C=(String(I.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";d(null);try{const W=await sr(I.id,C);o(oe=>oe.map(Me=>Me.id===I.id?W:Me))}catch(W){d(W instanceof Error?W.message:String(W))}},U=async I=>{if(!h){d("操作にはログインが必要です");return}const P=I.album?.title||I.album?.mood||"投稿";if(window.confirm(`削除しますか？

${P}
この操作は取り消せません。`)){d(null);try{await nr(I.id),o(C=>C.filter(W=>W.id!==I.id))}catch(C){d(C instanceof Error?C.message:String(C))}}};return i.jsxs("div",{className:"room-content social-room",children:[i.jsxs("div",{className:"social-header",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"SOCIAL"}),i.jsx("p",{className:"room-subtitle",children:"作品を公開して、反応を集める"})]}),i.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[i.jsx("button",{className:"btn",onClick:()=>a("gallery"),children:"ギャラリーへ"}),i.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"更新"})]})]}),i.jsx("div",{className:"social-filter","data-no-swipe":"true",children:i.jsx(ni,{value:v,onChange:I=>N(I),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),i.jsx("div",{className:"social-auth","data-no-swipe":"true","aria-label":"ログイン",children:i.jsxs("div",{className:"social-auth-row",children:[i.jsxs("div",{className:"social-auth-me",children:[i.jsx("div",{className:"social-auth-title",children:"ログイン中"}),i.jsxs("div",{className:"social-auth-handle",children:["@",h?.handle||"..."]}),i.jsx("div",{className:"social-auth-sub",children:h?.displayName||""})]}),i.jsxs("div",{className:"social-auth-actions",children:[i.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"再読み込み"}),i.jsx("button",{className:"btn",onClick:()=>void g(),disabled:!h,children:"ログアウト"})]})]})}),i.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[i.jsxs("div",{className:"social-compose-grid",children:[i.jsxs("label",{className:"social-field",children:[i.jsx("span",{className:"social-label",children:"公開するアルバム"}),i.jsxs("select",{className:"social-select",value:_,onChange:I=>y(I.target.value),children:[n.length===0&&i.jsx("option",{value:"",children:"（アルバムがありません）"}),n.map(I=>i.jsx("option",{value:I.id,children:I.title||I.mood},I.id))]})]}),i.jsxs("label",{className:"social-field social-field-wide",children:[i.jsx("span",{className:"social-label",children:"キャプション"}),i.jsx("textarea",{className:"social-textarea",value:p,onChange:I=>m(I.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),i.jsxs("div",{className:"social-compose-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!B,onClick:Y,children:x?"公開中…":"公開する"}),R&&i.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:i.jsx($t,{variant:"compact",title:R.title||R.mood,mood:R.mood,imageUrl:R.thumbnailUrl||R.imageDataURL,badges:[{label:R.musicData?"再生可能":"音声なし",tone:R.musicData?"success":"default"}]})})]}),u&&i.jsx("div",{className:"social-error",children:u})]}),i.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[l&&r.length===0&&i.jsx("div",{className:"social-muted",children:"読み込み中…"}),!l&&r.length===0&&i.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),r.map(I=>i.jsxs("article",{className:"social-post","data-no-swipe":"true","data-post-id":I.id,children:[i.jsxs("header",{className:"social-post-header",children:[i.jsxs("div",{className:"social-post-author",children:[I.author?.handle?`@${I.author.handle}`:I.authorName||"anonymous",I.author?.displayName&&i.jsx("span",{className:"social-post-author-sub",children:I.author.displayName})]}),i.jsx("div",{className:"social-post-date",children:new Date(I.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),I.author?.id&&h?.id!==I.author.id&&i.jsx("div",{className:"social-post-follow","data-no-swipe":"true",children:i.jsx("button",{className:`btn ${h?.followingIds?.includes(I.author.id)?"btn-primary":""}`,onClick:()=>void ee(I.author.id),disabled:!h,children:h?.followingIds?.includes(I.author.id)?"フォロー中":"フォロー"})}),i.jsx("div",{className:"social-post-album",children:i.jsx($t,{title:I.album?.title||"album",mood:I.album?.mood,imageUrl:I.album?.imageUrl,meta:I.album?.createdAt?`作成日: ${new Date(I.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:String(I.visibility||"public").toLowerCase()==="private"?"非公開":"公開作品",tone:String(I.visibility||"public").toLowerCase()==="private"?"default":"info"}]})}),I.caption&&i.jsx("div",{className:"social-post-caption",children:I.caption}),i.jsxs("div",{className:"social-post-actions",children:[i.jsxs("button",{className:`btn social-action ${E[I.id]?"is-active":""}`,onClick:()=>$(I.id),"aria-expanded":!!E[I.id],"aria-controls":`post-comments-${I.id}`,"aria-label":E[I.id]?"コメントを閉じる":"コメントを開く",children:[i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:E[I.id]?"chevronDown":"comment",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:E[I.id]?"閉じる":"コメント"})]}),i.jsx("span",{className:"social-count-chip",children:Array.isArray(I.comments)?I.comments.length:0})]}),i.jsxs("button",{className:`btn social-action ${I.viewerHasLiked?"is-active":""}`,onClick:()=>void H(I.id),disabled:!h,children:[i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:"heart",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:"いいね"})]}),i.jsx("span",{className:"social-count-chip",children:I.likes||0})]}),i.jsx("button",{className:"btn social-action",onClick:()=>void L(I.id),children:i.jsxs("span",{className:"social-action-main",children:[i.jsx(Hs,{name:"link",className:"social-action-icon"}),i.jsx("span",{className:"social-action-label",children:"共有"})]})}),i.jsx(nn,{triggerClassName:"btn social-action social-action-iconOnly",trigger:i.jsx(Hs,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:P})=>i.jsx(an,{items:(()=>{const C=!!h?.id&&!!I.author?.id&&h.id===I.author.id,W=[{id:"copy",label:"リンクをコピー",onSelect:()=>{L(I.id),P()}}];if(C){const oe=String(I.visibility||"public").toLowerCase()==="private";W.push({id:"vis",label:oe?"公開にする":"非公開にする",onSelect:()=>{Q(I),P()}}),W.push({id:"delete",label:"削除",onSelect:()=>{U(I),P()}})}else W.push({id:"report",label:"通報する",onSelect:()=>{d("通報を受け付けました"),P()}});return W})()})})]}),E[I.id]&&i.jsxs("div",{className:"social-post-comments",id:`post-comments-${I.id}`,children:[(I.comments||[]).slice(-6).map(P=>i.jsxs("div",{className:"social-comment",children:[i.jsx("span",{className:"social-comment-author",children:P.authorName||"anonymous"}),i.jsx("span",{className:"social-comment-text",children:P.text})]},P.id)),i.jsxs("div",{className:"social-comment-compose",children:[i.jsx("input",{className:"social-input",value:A[I.id]||"",onChange:P=>b(C=>({...C,[I.id]:P.target.value})),placeholder:h?"コメントを書く":"ログインしてコメント",maxLength:240,disabled:!h}),i.jsx("button",{className:"btn btn-primary",disabled:!h||T===I.id,onClick:()=>void X(I.id),children:T===I.id?"送信中…":"送信"})]})]})]},I.id))]})]})};function hl(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}const ml=()=>{const{user:n}=Os(),{navigateToRoom:e}=pt(),t=m=>{try{localStorage.setItem("airia_social_focus_post_v1",String(m))}catch{}e("social")},[s,a]=F.useState(!1),[r,o]=F.useState(null),[l,c]=F.useState([]),[u,d]=F.useState(null),h=F.useCallback(async()=>{if(n){a(!0),o(null);try{const m=await al(120);c(m.posts||[])}catch(m){o(m instanceof Error?m.message:String(m))}finally{a(!1)}}},[n]);F.useEffect(()=>{h()},[h]);const g=F.useMemo(()=>l.reduce((m,_)=>m+(Number(_.likes)||0),0),[l]),f=async m=>{const y=(String(m.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";d(m.id),o(null);try{const x=await sr(m.id,y);c(S=>S.map(A=>A.id===m.id?x:A))}catch(x){o(x instanceof Error?x.message:String(x))}finally{d(null)}},p=async m=>{const _=m.album?.title||m.album?.mood||"投稿";if(window.confirm(`削除しますか？

${_}
この操作は取り消せません。`)){d(m.id),o(null);try{await nr(m.id),c(y=>y.filter(x=>x.id!==m.id))}catch(y){o(y instanceof Error?y.message:String(y))}finally{d(null)}}};return i.jsxs("div",{className:"room-content mypage-room",children:[i.jsxs("div",{className:"mypage-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"MY"}),i.jsx("p",{className:"room-subtitle",children:"あなたのプロフィールと投稿"})]}),i.jsxs("div",{className:"mypage-header-actions",children:[i.jsx("button",{className:"btn",onClick:()=>e("settings"),children:"設定へ"}),i.jsx("button",{className:"btn",onClick:()=>void h(),disabled:s||!n,children:"更新"})]})]}),i.jsxs("div",{className:"mypage-card",children:[i.jsxs("section",{className:"mypage-section",children:[i.jsx("h2",{className:"mypage-title",children:"プロフィール"}),i.jsxs("div",{className:"mypage-profile",children:[i.jsx("div",{className:"mypage-avatar","aria-hidden":"true",children:(n?.displayName||n?.handle||"A").slice(0,1).toUpperCase()}),i.jsxs("div",{className:"mypage-profile-meta",children:[i.jsxs("div",{className:"mypage-handle",children:["@",n?.handle||"..."]}),i.jsx("div",{className:"mypage-name",children:n?.displayName||""}),n?.bio?i.jsx("div",{className:"mypage-bio",children:n.bio}):i.jsx("div",{className:"mypage-bio muted",children:"自己紹介は未設定です"})]})]})]}),i.jsxs("section",{className:"mypage-section",children:[i.jsx("h2",{className:"mypage-title",children:"サマリー"}),i.jsxs("div",{className:"mypage-stats",children:[i.jsxs("div",{className:"mypage-stat",children:[i.jsx("div",{className:"mypage-stat-k",children:"投稿"}),i.jsx("div",{className:"mypage-stat-v",children:l.length})]}),i.jsxs("div",{className:"mypage-stat",children:[i.jsx("div",{className:"mypage-stat-k",children:"合計いいね"}),i.jsx("div",{className:"mypage-stat-v",children:g})]}),i.jsxs("div",{className:"mypage-stat",children:[i.jsx("div",{className:"mypage-stat-k",children:"フォロー中"}),i.jsx("div",{className:"mypage-stat-v",children:n?.followingIds?.length||0})]})]})]}),i.jsxs("section",{className:"mypage-section","data-no-swipe":"true",children:[i.jsxs("div",{className:"mypage-row",children:[i.jsx("h2",{className:"mypage-title",children:"あなたの投稿"}),i.jsx("button",{className:"btn",onClick:()=>e("social"),children:"Socialへ"})]}),r&&i.jsx("div",{className:"mypage-error",children:r}),s&&i.jsx("div",{className:"mypage-muted",children:"読み込み中…"}),!s&&l.length===0&&i.jsx("div",{className:"mypage-muted",children:"まだ投稿がありません"}),i.jsx("div",{className:"mypage-posts",children:l.map(m=>i.jsxs("article",{className:"mypage-post",children:[i.jsxs("div",{className:"mypage-post-top",children:[i.jsxs("div",{className:"mypage-post-title",children:[m.album?.title||m.album?.mood||"作品",String(m.visibility||"public").toLowerCase()==="private"?i.jsx("span",{className:"mypage-visibility mypage-visibility-private",children:"非公開"}):i.jsx("span",{className:"mypage-visibility",children:"公開"})]}),i.jsx("div",{className:"mypage-post-time",children:hl(m.createdAt)})]}),m.caption?i.jsx("div",{className:"mypage-post-caption",children:m.caption}):null,i.jsxs("div",{className:"mypage-post-meta",children:[i.jsxs("span",{children:["♥ ",m.likes]}),i.jsxs("span",{children:["💬 ",m.comments?.length||0]}),i.jsxs("div",{className:"mypage-post-actions",children:[i.jsx("button",{className:"btn",onClick:()=>t(m.id),disabled:u===m.id,children:"開く"}),i.jsx("button",{className:"btn",onClick:()=>void f(m),disabled:u===m.id,children:String(m.visibility||"public").toLowerCase()==="private"?"公開にする":"非公開にする"}),i.jsx("button",{className:"btn",onClick:()=>void p(m),disabled:u===m.id,children:"削除"})]})]})]},m.id))})]})]})]})},yi="https://airia-beyond.onrender.com",ii="airia_admin_token_v1";function As(){try{return String(localStorage.getItem(ii)||"")}catch{return""}}function ir(n){try{n?localStorage.setItem(ii,n):localStorage.removeItem(ii)}catch{}}async function ar(n){return n.json().catch(()=>null)}async function pl(n,e){const t=new URL(`${yi}/api/admin/audit`);t.searchParams.set("limit",String(n.limit)),n.sinceId!==void 0&&t.searchParams.set("sinceId",String(n.sinceId)),n.type&&t.searchParams.set("type",String(n.type)),n.actorId&&t.searchParams.set("actorId",String(n.actorId));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),a=await ar(s);if(!s.ok)throw new Error(a?.message||a?.error||`Failed to load audit: ${s.status}`);return a}function fl(n){const e=new URL(`${yi}/api/admin/audit/stream`);return e.searchParams.set("token",n),e.toString()}async function ya(n,e){const t=new URL(`${yi}/api/admin/metrics`);t.searchParams.set("days",String(n||30));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),a=await ar(s);if(!s.ok)throw new Error(a?.message||a?.error||`Failed to load metrics: ${s.status}`);return a}function gl(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})}const vl=()=>{const{user:n,logout:e,updateProfile:t,loading:s}=Os(),{navigateToRoom:a}=pt(),{addToast:r}=vs(),[o,l]=F.useState(n?.displayName||""),[c,u]=F.useState(n?.bio||""),[d,h]=F.useState(!1),[g,f]=F.useState(As());F.useEffect(()=>{l(n?.displayName||""),u(n?.bio||"")},[n?.displayName,n?.bio]),F.useEffect(()=>{f(As())},[]);const p=!!n&&!d&&(o.trim()!==(n?.displayName||"")||c.trim()!==(n?.bio||"")),m=async()=>{if(n){h(!0);try{await t({displayName:o.trim()||void 0,bio:c.trim()||""}),r("success","プロフィールを保存しました")}catch(x){r("error",x instanceof Error?x.message:"保存に失敗しました")}finally{h(!1)}}},_=async()=>{try{await e()}catch{}},y=()=>{const x=g.trim();ir(x||null),r("success",x?"Admin token を保存しました":"Admin token をクリアしました")};return i.jsxs("div",{className:"room-content settings-room",children:[i.jsxs("div",{className:"settings-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"SETTINGS"}),i.jsx("p",{className:"room-subtitle",children:"アカウントとプロフィール"})]}),i.jsx("div",{className:"settings-header-actions",children:i.jsx("button",{className:"btn",onClick:()=>void _(),disabled:!n||s,children:"ログアウト"})})]}),i.jsxs("div",{className:"settings-card",children:[i.jsxs("section",{className:"settings-section",children:[i.jsx("h2",{className:"settings-title",children:"アカウント"}),i.jsxs("div",{className:"settings-kv",children:[i.jsxs("div",{className:"settings-kv-row",children:[i.jsx("div",{className:"settings-k",children:"ハンドル"}),i.jsxs("div",{className:"settings-v",children:["@",n?.handle||"..."]})]}),i.jsxs("div",{className:"settings-kv-row",children:[i.jsx("div",{className:"settings-k",children:"作成日"}),i.jsx("div",{className:"settings-v",children:n?.createdAt?gl(n.createdAt):""})]})]})]}),i.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"settings-title",children:"プロフィール"}),i.jsxs("div",{className:"settings-grid",children:[i.jsxs("label",{className:"settings-field",children:[i.jsx("span",{className:"settings-label",children:"表示名"}),i.jsx("input",{className:"settings-input",value:o,onChange:x=>l(x.target.value),maxLength:32,placeholder:"あなたの名前"})]}),i.jsxs("label",{className:"settings-field settings-field-wide",children:[i.jsx("span",{className:"settings-label",children:"自己紹介"}),i.jsx("textarea",{className:"settings-textarea",value:c,onChange:x=>u(x.target.value),maxLength:160,rows:4,placeholder:"一言（任意）"})]})]}),i.jsxs("div",{className:"settings-actions",children:[i.jsx("button",{className:"btn btn-primary",disabled:!p,onClick:()=>void m(),children:d?"保存中…":"保存する"}),i.jsx("div",{className:"settings-muted",children:"プレリリースでは基本項目のみ編集できます。"})]})]}),i.jsxs("section",{className:"settings-section",children:[i.jsx("h2",{className:"settings-title",children:"通知"}),i.jsx("p",{className:"settings-muted",children:"メール通知は次フェーズで追加予定です。"})]}),i.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"settings-title",children:"Admin"}),i.jsx("div",{className:"settings-grid",children:i.jsxs("label",{className:"settings-field settings-field-wide",children:[i.jsx("span",{className:"settings-label",children:"ADMIN_TOKEN"}),i.jsx("input",{className:"settings-input",value:g,onChange:x=>f(x.target.value),placeholder:"サーバの ADMIN_TOKEN",type:"password",autoComplete:"off"})]})}),i.jsxs("div",{className:"settings-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:y,children:"保存"}),i.jsx("button",{className:"btn",onClick:()=>{y(),g.trim()&&a("admin")},disabled:!g.trim(),children:"Adminログへ"}),i.jsx("div",{className:"settings-muted",children:"Adminログは ADMIN_TOKEN を知っている人のみ利用できます。"})]})]})]})]})};function yl(n){const e=new Date(n);return Number.isNaN(e.getTime())?n:e.toLocaleString("ja-JP",{hour12:!1})}function _l(n){const e=n.actor;if(!e)return"anonymous";const t=e.handle?`@${e.handle}`:e.id,s=e.displayName?String(e.displayName):"";return s?`${s} (${t})`:t}const bl=()=>{const{addToast:n}=vs(),[e,t]=F.useState(As()),[s,a]=F.useState(As()),[r,o]=F.useState([]),[l,c]=F.useState(!1),[u,d]=F.useState(null),[h,g]=F.useState(null),[f,p]=F.useState(30),[m,_]=F.useState(""),[y,x]=F.useState(""),[S,A]=F.useState(!1),[b,T]=F.useState(!0),j=F.useRef(null),v=F.useCallback(()=>{if(j.current)try{j.current.close()}catch{}j.current=null,A(!1)},[]),N=F.useCallback(k=>{if(v(),!!k)try{const L=new EventSource(fl(k));j.current=L,L.addEventListener("hello",()=>{A(!0),d(null)}),L.addEventListener("audit",V=>{try{const R=JSON.parse(String(V.data||"null"));if(!R||typeof R!="object")return;o(B=>[R,...B].slice(0,2e3))}catch{}}),L.onerror=()=>{A(!1)}}catch(L){d(L instanceof Error?L.message:String(L)),A(!1)}},[v]),E=F.useCallback(async()=>{const k=(s||"").trim();if(!k){d("ADMIN_TOKEN を入力してください");return}c(!0),d(null);try{const L=await pl({limit:200,type:m.trim(),actorId:y.trim()},k);o(L.events||[]);const V=await ya(f,k);g(V)}catch(L){d(L instanceof Error?L.message:String(L))}finally{c(!1)}},[s,m,y,f]);F.useEffect(()=>{const k=(s||"").trim();if(!k)return;let L=!1;const V=async()=>{try{const B=await ya(f,k);L||g(B)}catch{}};V();const R=window.setInterval(V,6e4);return()=>{L=!0,window.clearInterval(R)}},[s,f]),F.useEffect(()=>{if(b&&s)return N(s),()=>v()},[b,s,N,v]);const O=()=>{const k=e.trim();ir(k||null),a(k),n("success",k?"Admin token を保存しました":"Admin token をクリアしました"),k&&b&&N(k),k||v()},M=()=>o([]),D=F.useMemo(()=>{const k=m.trim().toLowerCase(),L=y.trim();return r.filter(V=>{if(k&&!String(V.type||"").toLowerCase().includes(k))return!1;if(L){const R=String(V.actor?.id||""),B=String(V.actor?.handle||"");if(L!==R&&L!==B)return!1}return!0})},[r,m,y]);return i.jsxs("div",{className:"room-content admin-room",children:[i.jsxs("div",{className:"admin-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"ADMIN"}),i.jsx("p",{className:"room-subtitle",children:"ユーザーアクション監視ログ（リアルタイム）"})]}),i.jsxs("div",{className:"admin-header-actions",children:[i.jsx("span",{className:`admin-pill ${S?"ok":"ng"}`,children:S?"LIVE":"OFFLINE"}),i.jsx("button",{className:"btn",onClick:()=>void E(),disabled:l||!s,children:l?"読込中…":"最新を取得"}),i.jsx("button",{className:"btn btn-secondary",onClick:M,disabled:r.length===0,children:"表示クリア"})]})]}),i.jsxs("div",{className:"admin-metrics","data-no-swipe":"true",children:[i.jsxs("div",{className:"admin-metrics-top",children:[i.jsxs("div",{className:"admin-metrics-cards",children:[i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"総ユーザー数"}),i.jsx("div",{className:"admin-metric-v",children:h?.totals?.users??"—"})]}),i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"総アクション数"}),i.jsx("div",{className:"admin-metric-v",children:h?.totals?.actions??"—"})]}),i.jsxs("div",{className:"admin-metric",children:[i.jsx("div",{className:"admin-metric-k",children:"期間"}),i.jsxs("div",{className:"admin-metric-v",children:["直近 ",f," 日"]})]})]}),i.jsxs("div",{className:"admin-metrics-days",children:[i.jsx("button",{className:`btn ${f===7?"btn-primary":""}`,onClick:()=>p(7),children:"7日"}),i.jsx("button",{className:`btn ${f===14?"btn-primary":""}`,onClick:()=>p(14),children:"14日"}),i.jsx("button",{className:`btn ${f===30?"btn-primary":""}`,onClick:()=>p(30),children:"30日"})]})]}),i.jsxs("div",{className:"admin-charts",children:[i.jsx(_a,{title:"ユーザー増加（新規/日）",points:h?.series?.newUsersPerDay||[]}),i.jsx(_a,{title:"アクション数（/日）",points:h?.series?.actionsPerDay||[]})]})]}),i.jsxs("div",{className:"admin-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"admin-grid",children:[i.jsxs("label",{className:"admin-field admin-field-wide",children:[i.jsx("span",{className:"admin-label",children:"ADMIN_TOKEN"}),i.jsx("input",{className:"admin-input",value:e,onChange:k=>t(k.target.value),placeholder:"Bearer token（サーバの ADMIN_TOKEN）",type:"password",autoComplete:"off"})]}),i.jsxs("div",{className:"admin-actions",children:[i.jsx("button",{className:"btn btn-primary",onClick:O,children:"保存"}),i.jsx("button",{className:"btn",onClick:()=>S?v():N(s),disabled:!s,children:S?"切断":"接続"}),i.jsxs("label",{className:"admin-toggle",children:[i.jsx("input",{type:"checkbox",checked:b,onChange:k=>T(k.target.checked)}),"自動接続"]})]}),i.jsxs("label",{className:"admin-field",children:[i.jsx("span",{className:"admin-label",children:"type filter"}),i.jsx("input",{className:"admin-input",value:m,onChange:k=>_(k.target.value),placeholder:"social.post"})]}),i.jsxs("label",{className:"admin-field",children:[i.jsx("span",{className:"admin-label",children:"actor filter"}),i.jsx("input",{className:"admin-input",value:y,onChange:k=>x(k.target.value),placeholder:"user id or handle"})]})]}),u&&i.jsx("div",{className:"admin-error",children:u}),!s&&i.jsx("div",{className:"admin-hint",children:"まず ADMIN_TOKEN を入力して「保存」してください。"})]}),i.jsx("div",{className:"admin-list","data-no-swipe":"true",children:D.length===0?i.jsx("div",{className:"admin-empty",children:"ログがありません。操作してイベントを発生させてください。"}):D.map(k=>i.jsx(xl,{evt:k,onCopy:()=>{const L=JSON.stringify(k,null,2);navigator.clipboard.writeText(L).then(()=>n("success","コピーしました")).catch(()=>n("error","コピーできませんでした"))}},k.id))})]})},_a=({title:n,points:e})=>{const t=Math.max(1,...e.map(r=>Number(r.value||0))),s=e[e.length-1],a=e.reduce((r,o)=>r+(Number(o.value)||0),0);return i.jsxs("div",{className:"admin-chart",children:[i.jsxs("div",{className:"admin-chart-top",children:[i.jsx("div",{className:"admin-chart-title",children:n}),i.jsxs("div",{className:"admin-chart-meta",children:["合計 ",a," / 最新 ",s?.value??0]})]}),i.jsx("div",{className:"admin-chart-bars","aria-label":n,children:e.map(r=>i.jsx("div",{className:"admin-chart-bar",title:`${r.day}: ${r.value}`,children:i.jsx("div",{className:"admin-chart-barFill",style:{height:`${Math.round(Number(r.value||0)/t*100)}%`}})},r.day))}),i.jsxs("div",{className:"admin-chart-axis",children:[i.jsx("span",{children:e[0]?.day||""}),i.jsx("span",{children:e[e.length-1]?.day||""})]})]})},xl=({evt:n,onCopy:e})=>{const[t,s]=F.useState(!1);return i.jsxs("div",{className:"admin-row",children:[i.jsxs("button",{className:"admin-row-main",onClick:()=>s(a=>!a),"aria-expanded":t,children:[i.jsxs("div",{className:"admin-row-top",children:[i.jsx("div",{className:"admin-row-type",children:n.type}),i.jsx("div",{className:"admin-row-ts",children:yl(n.ts)})]}),i.jsxs("div",{className:"admin-row-mid",children:[i.jsx("div",{className:"admin-row-actor",children:_l(n)}),i.jsx("div",{className:"admin-row-summary",children:n.summary||""})]}),n.request?.path?i.jsxs("div",{className:"admin-row-path",children:[n.request.method," ",n.request.path]}):null]}),i.jsx("div",{className:"admin-row-actions","data-no-swipe":"true",children:i.jsx("button",{className:"btn btn-secondary",onClick:e,children:"JSONコピー"})}),t?i.jsx("pre",{className:"admin-row-json",children:JSON.stringify(n,null,2)}):null]})},wl=({label:n,children:e,placement:t="top"})=>{const s=w.useId(),[a,r]=w.useState(!1),o=[e.props["aria-describedby"],s].filter(Boolean).join(" ");return i.jsxs("span",{className:`tooltip-wrapper tooltip-${t}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),onFocusCapture:()=>r(!0),onBlurCapture:()=>r(!1),"data-no-swipe":"true",children:[F.cloneElement(e,{"aria-describedby":o}),i.jsx("span",{id:s,role:"tooltip",className:`tooltip-bubble ${a?"is-open":""}`,children:n})]})},ba="airia_theme";function Nl(n){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n==="system"?e?"dark":"light":n;document.documentElement.setAttribute("data-theme",t)}const Sl=()=>{const{addToast:n}=vs(),{navigateToRoom:e}=pt(),[t,s]=F.useState(()=>{try{return localStorage.getItem(ba)||"system"}catch{return"system"}}),a=l=>{s(l);try{localStorage.setItem(ba,l)}catch{}Nl(l)},[r,o]=F.useState(!1);return i.jsxs("div",{className:"room-content info-room",children:[i.jsx("h1",{className:"room-title",children:"INFO"}),i.jsx("p",{className:"room-subtitle",children:"このアプリについて"}),i.jsxs("div",{className:"info-card",children:[i.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[i.jsx("h2",{className:"info-title",children:"フィードバック"}),i.jsx("p",{className:"info-text",children:"不便・バグ・改善案はもちろん、良かった点も歓迎です。短くても大丈夫。"}),i.jsx("div",{className:"info-actions",children:i.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>e("feedback"),children:"フィードバックを書く"})})]}),i.jsxs("section",{className:"info-section",children:[i.jsx("h2",{className:"info-title",children:"目的"}),i.jsx("p",{className:"info-text",children:"この体験の目的は、「より貴方らしい芸術」を日常の中で生み出せること。"}),i.jsx("p",{className:"info-text",children:"そして、気持ちの変化に合わせて「ずっと寄り添える」相棒になることです。"})]}),i.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[i.jsxs("div",{className:"info-actions",children:[i.jsx("h2",{className:"info-title",children:"テーマ"}),i.jsx(wl,{label:"見やすさに合わせて切り替えできます",children:i.jsx("span",{className:"info-badge","aria-hidden":"true",children:"?"})})]}),i.jsx("div",{className:"info-actions",children:i.jsx("div",{className:"theme-toggle",role:"group","aria-label":"テーマ切り替え",children:[{id:"system",label:"システム"},{id:"light",label:"ライト"},{id:"dark",label:"ダーク"},{id:"high-contrast",label:"高コントラスト"}].map(l=>i.jsx("button",{type:"button",className:"theme-button","aria-pressed":t===l.id,onClick:()=>a(l.id),children:l.label},l.id))})}),i.jsx("p",{className:"info-text",children:"見やすさに合わせて切り替えられます。"})]}),i.jsxs("section",{className:"info-section",children:[i.jsxs("div",{className:"info-actions",children:[i.jsx("h2",{className:"info-title",children:"リンク"}),i.jsx("button",{type:"button",className:"info-reset",onClick:()=>o(!0),children:"アプリ情報"})]}),i.jsx("ul",{className:"info-list",children:i.jsx("li",{children:i.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})})})]}),null]}),i.jsxs(Za,{open:r,onOpenChange:o,title:"AIRIA BEYOND",description:"あなたの一日を、作品へ。",footer:i.jsx("button",{className:"btn btn-primary",onClick:()=>o(!1),children:"閉じる"}),children:[i.jsx("p",{className:"info-text",children:"会話と気分の手がかりから、あなたに合うレコメンドや創作を少しずつ育てていきます。"}),i.jsx("p",{className:"info-text",children:"まだプレリリース段階です。気づいたことがあれば、ぜひフィードバックを送ってください。"})]})]})},jl=()=>{const{navigateToRoom:n}=pt(),{addToast:e}=vs(),[t,s]=F.useState(!1),[a,r]=F.useState(null),[o,l]=F.useState(!1),[c,u]=F.useState(""),[d,h]=F.useState(""),[g,f]=F.useState(""),[p,m]=F.useState(""),[_,y]=F.useState(""),[x,S]=F.useState(""),[A,b]=F.useState(""),[T,j]=F.useState(""),[v,N]=F.useState(""),[E,O]=F.useState(""),[M,D]=F.useState(""),[k,L]=F.useState(!0),[V,R]=F.useState(!1),[B,Y]=F.useState(null),[H,X]=F.useState(""),[ee,$]=F.useState(!1),Q=F.useMemo(()=>(g.trim().length>0||p.trim().length>0||_.trim().length>0||x.trim().length>0||A.trim().length>0)&&!t,[A,x,t,p,_,g]),U=async()=>{Y(null),R(!0);try{const C=await fetch("/api/diagnostics/image",{method:"GET"}),W=await C.json().catch(()=>({}));if(!C.ok)throw new Error(W?.message||"診断情報の取得に失敗しました");const oe=JSON.stringify(W,null,2);X(oe),e("success","診断情報を取得しました。必要ならコピーして送れます。")}catch(C){const W=C instanceof Error?C.message:"診断情報の取得に失敗しました";Y(W),e("error",W)}finally{R(!1)}},I=async()=>{const C=H.trim();if(!C){e("info","先に「診断情報を取得」を押してください。");return}try{await navigator.clipboard.writeText(C),e("success","診断情報をコピーしました。")}catch{try{const W=document.createElement("textarea");W.value=C,W.style.position="fixed",W.style.left="-9999px",document.body.appendChild(W),W.select(),document.execCommand("copy"),document.body.removeChild(W),e("success","診断情報をコピーしました。")}catch{e("error","コピーに失敗しました。手動で選択してコピーしてください。")}}},P=async()=>{if(Q){r(null),l(!1),s(!0);try{const C=await fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:c||void 0,rating:d||void 0,title:g||void 0,message:p||void 0,steps:_||void 0,expected:x||void 0,actual:A||void 0,device:T||void 0,browser:v||void 0,name:E||void 0,contact:M||void 0,allowFollowUp:k,diagnostics:ee&&H.trim().length>0?H:void 0})}),W=await C.json().catch(()=>({}));if(!C.ok)throw new Error(W?.message||"送信に失敗しました");l(!0),e("success","フィードバックを送信しました。ありがとうございます。"),u(""),h(""),f(""),m(""),y(""),S(""),b(""),j(""),N("")}catch(C){const W=C instanceof Error?C.message:"送信に失敗しました";r(W),e("error",W)}finally{s(!1)}}};return i.jsxs("div",{className:"room-content feedback-room",children:[i.jsxs("div",{className:"feedback-header","data-no-swipe":"true",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"room-title",children:"FEEDBACK"}),i.jsx("p",{className:"room-subtitle",children:"改善のために、気づいたことを教えてください"})]}),i.jsx("div",{className:"feedback-header-actions",children:i.jsx("button",{className:"btn btn-secondary",onClick:()=>n("info"),children:"Infoへ"})})]}),i.jsxs("div",{className:"feedback-hero","data-no-swipe":"true",children:[i.jsxs("div",{className:"feedback-hero-top",children:[i.jsx("h2",{className:"feedback-hero-title",children:"フィードバックを送ってください"}),i.jsxs("p",{className:"feedback-hero-sub",children:["不便・バグ・改善案はもちろん、良かった点も歓迎です。",i.jsx("br",{}),"一部だけの回答でも送信できます。"]})]}),i.jsxs("div",{className:"feedback-grid",children:[i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"カテゴリ"}),i.jsxs("select",{className:"feedback-input",value:c,onChange:C=>u(C.target.value),children:[i.jsx("option",{value:"",children:"未選択"}),i.jsx("option",{value:"bug",children:"バグ"}),i.jsx("option",{value:"ux",children:"使いにくい"}),i.jsx("option",{value:"feature",children:"要望"}),i.jsx("option",{value:"praise",children:"良かった"}),i.jsx("option",{value:"other",children:"その他"})]})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"気持ち（任意）"}),i.jsxs("select",{className:"feedback-input",value:d,onChange:C=>h(C.target.value),children:[i.jsx("option",{value:"",children:"未選択"}),i.jsx("option",{value:"great",children:"最高だった"}),i.jsx("option",{value:"good",children:"良かった"}),i.jsx("option",{value:"ok",children:"ふつう"}),i.jsx("option",{value:"frustrating",children:"困った"}),i.jsx("option",{value:"broken",children:"壊れてる"})]})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"タイトル（任意）"}),i.jsx("input",{className:"feedback-input",value:g,onChange:C=>f(C.target.value),placeholder:"例：再開ボタンが効かない / 背景が綺麗で好き"})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"本文（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:p,onChange:C=>m(C.target.value),placeholder:"気づいたことを自由に。短くてもOK。",rows:5})]}),i.jsxs("div",{className:"feedback-field feedback-span-2",children:[i.jsx("label",{className:"feedback-label",children:"再現手順（任意・バグ向け）"}),i.jsx("textarea",{className:"feedback-textarea",value:_,onChange:C=>y(C.target.value),placeholder:`例：
1) Chatで「今すぐ1曲」
2) キャンセル
3) 再開
→ エラー`,rows:4})]}),i.jsxs("div",{className:"feedback-field feedback-span-2 feedback-split",children:[i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"期待したこと（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:x,onChange:C=>S(C.target.value),rows:3})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"実際に起きたこと（任意）"}),i.jsx("textarea",{className:"feedback-textarea",value:A,onChange:C=>b(C.target.value),rows:3})]})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"端末（任意）"}),i.jsx("input",{className:"feedback-input",value:T,onChange:C=>j(C.target.value),placeholder:"例：iPhone / Windows"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"ブラウザ（任意）"}),i.jsx("input",{className:"feedback-input",value:v,onChange:C=>N(C.target.value),placeholder:"例：Safari / Chrome"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"お名前（任意）"}),i.jsx("input",{className:"feedback-input",value:E,onChange:C=>O(C.target.value),placeholder:"匿名でもOK"})]}),i.jsxs("div",{className:"feedback-field",children:[i.jsx("label",{className:"feedback-label",children:"連絡先（任意）"}),i.jsx("input",{className:"feedback-input",value:M,onChange:C=>D(C.target.value),placeholder:"返信が必要な場合だけ"})]}),i.jsxs("label",{className:"feedback-check feedback-span-2",children:[i.jsx("input",{type:"checkbox",checked:k,onChange:C=>L(C.target.checked)}),"必要があれば追加で質問してもよい（任意）"]}),i.jsxs("div",{className:"feedback-actions feedback-span-2",children:[i.jsx("button",{type:"button",className:"btn btn-primary feedback-submit",disabled:!Q,onClick:()=>void P(),children:t?"送信中…":"送信する"}),i.jsx("div",{className:"feedback-hint",children:o?"送信完了。ありがとうございます。":"※ タイトル/本文/再現手順など、どれか1つでも書けば送信できます。"}),a?i.jsx("div",{className:"feedback-error",children:a}):null]})]})]}),i.jsxs("div",{className:"diagnostics-card","data-no-swipe":"true",children:[i.jsxs("div",{className:"diagnostics-top",children:[i.jsx("h2",{className:"diagnostics-title",children:"困ったとき（診断情報）"}),i.jsx("p",{className:"diagnostics-sub",children:"画像生成がうまくいかない時は、診断情報をコピーしてフィードバックに貼り付けると原因特定が早くなります。"})]}),i.jsxs("div",{className:"diagnostics-actions",children:[i.jsx("button",{type:"button",className:"btn btn-secondary",disabled:V,onClick:()=>void U(),children:V?"取得中…":"診断情報を取得"}),i.jsx("button",{type:"button",className:"btn btn-secondary",disabled:!H.trim(),onClick:()=>void I(),children:"コピー"}),i.jsxs("label",{className:"diagnostics-attach",children:[i.jsx("input",{type:"checkbox",checked:ee,onChange:C=>$(C.target.checked)}),"フィードバック送信に添付する（任意）"]})]}),i.jsx("p",{className:"diagnostics-note",children:"※ 個人情報は含めませんが、接続先URL・エラー概要・最近のジョブ情報が含まれることがあります。"}),i.jsx("textarea",{className:"diagnostics-textarea",value:H,onChange:C=>X(C.target.value),placeholder:"ここに診断情報が表示されます（取得ボタンを押してください）",rows:7}),B?i.jsx("div",{className:"diagnostics-error",children:B}):null]})]})},Tl=({onDismiss:n})=>{const[e,t]=w.useState("enter");w.useEffect(()=>{const a=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>n(),2900)];return()=>{a.forEach(r=>clearTimeout(r))}},[n]);const s=()=>{t("exit"),window.setTimeout(n,260)};return i.jsxs("div",{className:`splash-screen splash-${e}`,onClick:s,role:"button",tabIndex:0,onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&s()},"aria-label":"クリックして開始",children:[i.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[i.jsx("div",{className:"splash-orbit"}),i.jsx("div",{className:"splash-grain"})]}),i.jsxs("div",{className:"splash-content",children:[i.jsx("div",{className:"splash-mark","aria-hidden":"true",children:i.jsx("div",{className:"splash-monogram",children:"A"})}),i.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),i.jsx("div",{className:"splash-rule","aria-hidden":"true"}),i.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),i.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},rr="15.1.22",xa=(n,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:n}),wa=(n,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:n}),ai=(n,e)=>({startTime:e,type:"setValue",value:n}),or=(n,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:n}),cr=(n,e,{startTime:t,target:s,timeConstant:a})=>s+(e-s)*Math.exp((t-n)/a),is=n=>n.type==="exponentialRampToValue",rn=n=>n.type==="linearRampToValue",Ct=n=>is(n)||rn(n),_i=n=>n.type==="setValue",_t=n=>n.type==="setValueCurve",on=(n,e,t,s)=>{const a=n[e];return a===void 0?s:Ct(a)||_i(a)?a.value:_t(a)?a.values[a.values.length-1]:cr(t,on(n,e-1,a.startTime,s),a)},Na=(n,e,t,s,a)=>t===void 0?[s.insertTime,a]:Ct(t)?[t.endTime,t.value]:_i(t)?[t.startTime,t.value]:_t(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,on(n,e-1,t.startTime,a)],ri=n=>n.type==="cancelAndHold",oi=n=>n.type==="cancelScheduledValues",Tt=n=>ri(n)||oi(n)?n.cancelTime:is(n)||rn(n)?n.endTime:n.startTime,Sa=(n,e,t,{endTime:s,value:a})=>t===a?a:0<t&&0<a||t<0&&a<0?t*(a/t)**((n-e)/(s-e)):0,ja=(n,e,t,{endTime:s,value:a})=>t+(n-e)/(s-e)*(a-t),kl=(n,e)=>{const t=Math.floor(e),s=Math.ceil(e);return t===s?n[t]:(1-(e-t))*n[t]+(1-(s-e))*n[s]},Cl=(n,{duration:e,startTime:t,values:s})=>{const a=(n-t)/e*(s.length-1);return kl(s,a)},Xs=n=>n.type==="setTarget";class Al{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=Tt(e);if(ri(e)||oi(e)){const s=this._automationEvents.findIndex(r=>oi(e)&&_t(r)?r.startTime+r.duration>=t:Tt(r)>=t),a=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),ri(e)){const r=this._automationEvents[this._automationEvents.length-1];if(a!==void 0&&Ct(a)){if(r!==void 0&&Xs(r))throw new Error("The internal list is malformed.");const o=r===void 0?a.insertTime:_t(r)?r.startTime+r.duration:Tt(r),l=r===void 0?this._defaultValue:_t(r)?r.values[r.values.length-1]:r.value,c=is(a)?Sa(t,o,l,a):ja(t,o,l,a),u=is(a)?xa(c,t,this._currenTime):wa(c,t,this._currenTime);this._automationEvents.push(u)}if(r!==void 0&&Xs(r)&&this._automationEvents.push(ai(this.getValue(t),t)),r!==void 0&&_t(r)&&r.startTime+r.duration>t){const o=t-r.startTime,l=(r.values.length-1)/r.duration,c=Math.max(2,1+Math.ceil(o*l)),u=o/(c-1)*l,d=r.values.slice(0,c);if(u<1)for(let h=1;h<c;h+=1){const g=u*h%1;d[h]=r.values[h-1]*(1-g)+r.values[h]*g}this._automationEvents[this._automationEvents.length-1]=or(d,r.startTime,o)}}}else{const s=this._automationEvents.findIndex(o=>Tt(o)>t),a=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(a!==void 0&&_t(a)&&Tt(a)+a.duration>t)return!1;const r=is(e)?xa(e.value,e.endTime,this._currenTime):rn(e)?wa(e.value,t,this._currenTime):e;if(s===-1)this._automationEvents.push(r);else{if(_t(e)&&t+e.duration>Tt(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,r)}}return!0}flush(e){const t=this._automationEvents.findIndex(s=>Tt(s)>e);if(t>1){const s=this._automationEvents.slice(t-1),a=s[0];Xs(a)&&s.unshift(ai(on(this._automationEvents,t-2,a.startTime,this._defaultValue),a.startTime)),this._automationEvents=s}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(o=>Tt(o)>e),s=this._automationEvents[t],a=(t===-1?this._automationEvents.length:t)-1,r=this._automationEvents[a];if(r!==void 0&&Xs(r)&&(s===void 0||!Ct(s)||s.insertTime>e))return cr(e,on(this._automationEvents,a-1,r.startTime,this._defaultValue),r);if(r!==void 0&&_i(r)&&(s===void 0||!Ct(s)))return r.value;if(r!==void 0&&_t(r)&&(s===void 0||!Ct(s)||r.startTime+r.duration>e))return e<r.startTime+r.duration?Cl(e,r):r.values[r.values.length-1];if(r!==void 0&&Ct(r)&&(s===void 0||!Ct(s)))return r.value;if(s!==void 0&&is(s)){const[o,l]=Na(this._automationEvents,a,r,s,this._defaultValue);return Sa(e,o,l,s)}if(s!==void 0&&rn(s)){const[o,l]=Na(this._automationEvents,a,r,s,this._defaultValue);return ja(e,o,l,s)}return this._defaultValue}}const El=n=>({cancelTime:n,type:"cancelAndHold"}),Ml=n=>({cancelTime:n,type:"cancelScheduledValues"}),Il=(n,e)=>({endTime:e,type:"exponentialRampToValue",value:n}),Dl=(n,e)=>({endTime:e,type:"linearRampToValue",value:n}),Ol=(n,e,t)=>({startTime:e,target:n,timeConstant:t,type:"setTarget"}),Rl=()=>new DOMException("","AbortError"),Pl=n=>(e,t,[s,a,r],o)=>{n(e[a],[t,s,r],l=>l[0]===t&&l[1]===s,o)},Fl=n=>(e,t,s)=>{const a=[];for(let r=0;r<s.numberOfInputs;r+=1)a.push(new Set);n.set(e,{activeInputs:a,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},Ll=n=>(e,t)=>{n.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},ls=new WeakSet,lr=new WeakMap,bi=new WeakMap,ur=new WeakMap,xi=new WeakMap,bn=new WeakMap,dr=new WeakMap,ci=new WeakMap,li=new WeakMap,ui=new WeakMap,hr={construct(){return hr}},Vl=n=>{try{const e=new Proxy(n,hr);new e}catch{return!1}return!0},Ta=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,ka=(n,e)=>{const t=[];let s=n.replace(/^[\s]+/,""),a=s.match(Ta);for(;a!==null;){const r=a[1].slice(1,-1),o=a[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,e).toString());t.push(o),s=s.slice(a[0].length).replace(/^[\s]+/,""),a=s.match(Ta)}return[t.join(";"),s]},Ca=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Aa=n=>{if(!Vl(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},ql=(n,e,t,s,a,r,o,l,c,u,d,h,g)=>{let f=0;return(p,m,_={credentials:"omit"})=>{const y=d.get(p);if(y!==void 0&&y.has(m))return Promise.resolve();const x=u.get(p);if(x!==void 0){const b=x.get(m);if(b!==void 0)return b}const S=r(p),A=S.audioWorklet===void 0?a(m).then(([b,T])=>{const[j,v]=ka(b,T),N=`${j};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${v}
})})(window,'_AWGS')`;return t(N)}).then(()=>{const b=g._AWGS.pop();if(b===void 0)throw new SyntaxError;s(S.currentTime,S.sampleRate,()=>b(class{},void 0,(T,j)=>{if(T.trim()==="")throw e();const v=li.get(S);if(v!==void 0){if(v.has(T))throw e();Aa(j),Ca(j.parameterDescriptors),v.set(T,j)}else Aa(j),Ca(j.parameterDescriptors),li.set(S,new Map([[T,j]]))},S.sampleRate,void 0,void 0))}):Promise.all([a(m),Promise.resolve(n(h,h))]).then(([[b,T],j])=>{const v=f+1;f=v;const[N,E]=ka(b,T),k=`${N};((AudioWorkletProcessor,registerProcessor)=>{${E}
})(${j?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${j?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${j?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${v}',class extends AudioWorkletProcessor{process(){return !1}})`,L=new Blob([k],{type:"application/javascript; charset=utf-8"}),V=URL.createObjectURL(L);return S.audioWorklet.addModule(V,_).then(()=>{if(l(S))return S;const R=o(S);return R.audioWorklet.addModule(V,_).then(()=>R)}).then(R=>{if(c===null)throw new SyntaxError;try{new c(R,`__sac${v}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(V))});return x===void 0?u.set(p,new Map([[m,A]])):x.set(m,A),A.then(()=>{const b=d.get(p);b===void 0?d.set(p,new Set([m])):b.add(m)}).finally(()=>{const b=u.get(p);b!==void 0&&b.delete(m)}),A}},it=(n,e)=>{const t=n.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},xn=(n,e)=>{const t=Array.from(n).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[s]=t;return n.delete(s),s},mr=(n,e,t,s)=>{const a=it(n,e),r=xn(a,o=>o[0]===t&&o[1]===s);return a.size===0&&n.delete(e),r},Rs=n=>it(dr,n),us=n=>{if(ls.has(n))throw new Error("The AudioNode is already stored.");ls.add(n),Rs(n).forEach(e=>e(!0))},pr=n=>"port"in n,Ps=n=>{if(!ls.has(n))throw new Error("The AudioNode is not stored.");ls.delete(n),Rs(n).forEach(e=>e(!1))},di=(n,e)=>{!pr(n)&&e.every(t=>t.size===0)&&Ps(n)},Wl=(n,e,t,s,a,r,o,l,c,u,d,h,g)=>{const f=new WeakMap;return(p,m,_,y,x)=>{const{activeInputs:S,passiveInputs:A}=r(m),{outputs:b}=r(p),T=l(p),j=v=>{const N=c(m),E=c(p);if(v){const O=mr(A,p,_,y);n(S,p,O,!1),!x&&!h(p)&&t(E,N,_,y),g(m)&&us(m)}else{const O=s(S,p,_,y);e(A,y,O,!1),!x&&!h(p)&&a(E,N,_,y);const M=o(m);if(M===0)d(m)&&di(m,S);else{const D=f.get(m);D!==void 0&&clearTimeout(D),f.set(m,setTimeout(()=>{d(m)&&di(m,S)},M*1e3))}}};return u(b,[m,_,y],v=>v[0]===m&&v[1]===_&&v[2]===y,!0)?(T.add(j),d(p)?n(S,p,[_,y,j],!0):e(A,y,[p,_,j],!0),!0):!1}},Bl=n=>(e,t,[s,a,r],o)=>{const l=e.get(s);l===void 0?e.set(s,new Set([[a,t,r]])):n(l,[a,t,r],c=>c[0]===a&&c[1]===t,o)},Ul=n=>(e,t)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(s).connect(e.destination);const a=()=>{t.removeEventListener("ended",a),t.disconnect(s),s.disconnect()};t.addEventListener("ended",a)},$l=n=>(e,t)=>{n(e).add(t)},Gl={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},zl=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=a(l),d={...Gl,...c},h=s(u,d),g=r(u)?e():null;super(l,!1,h,g),this._nativeAnalyserNode=h}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(l){this._nativeAnalyserNode.fftSize=l}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(l){const c=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=l,!(l>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=c,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(l){const c=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=l,!(this._nativeAnalyserNode.maxDecibels>l))throw this._nativeAnalyserNode.minDecibels=c,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(l){this._nativeAnalyserNode.smoothingTimeConstant=l}getByteFrequencyData(l){this._nativeAnalyserNode.getByteFrequencyData(l)}getByteTimeDomainData(l){this._nativeAnalyserNode.getByteTimeDomainData(l)}getFloatFrequencyData(l){this._nativeAnalyserNode.getFloatFrequencyData(l)}getFloatTimeDomainData(l){this._nativeAnalyserNode.getFloatTimeDomainData(l)}},Le=(n,e)=>n.context===e,Yl=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,fftSize:l.fftSize,maxDecibels:l.maxDecibels,minDecibels:l.minDecibels,smoothingTimeConstant:l.smoothingTimeConstant};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):a(r,o)}}},cn=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},ft=()=>new DOMException("","IndexSizeError"),wi=n=>{n.getChannelData=(e=>t=>{try{return e.call(n,t)}catch(s){throw s.code===12?ft():s}})(n.getChannelData)},Hl={numberOfChannels:1},Xl=(n,e,t,s,a,r,o,l)=>{let c=null;return class fr{constructor(d){if(a===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:h,numberOfChannels:g,sampleRate:f}={...Hl,...d};c===null&&(c=new a(1,1,44100));const p=s!==null&&e(r,r)?new s({length:h,numberOfChannels:g,sampleRate:f}):c.createBuffer(g,h,f);if(p.numberOfChannels===0)throw t();return typeof p.copyFromChannel!="function"?(o(p),wi(p)):e(cn,()=>cn(p))||l(p),n.add(p),p}static[Symbol.hasInstance](d){return d!==null&&typeof d=="object"&&Object.getPrototypeOf(d)===fr.prototype||n.has(d)}}},Ue=-34028234663852886e22,qe=-Ue,bt=n=>ls.has(n),Jl={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Zl=(n,e,t,s,a,r,o,l)=>class extends n{constructor(u,d){const h=r(u),g={...Jl,...d},f=a(h,g),p=o(h),m=p?e():null;super(u,!1,f,m),this._audioBufferSourceNodeRenderer=m,this._isBufferNullified=!1,this._isBufferSet=g.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,p,f.playbackRate,qe,Ue)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const d=typeof u=="function"?l(this,u):null;this._nativeAudioBufferSourceNode.onended=d;const h=this._nativeAudioBufferSourceNode.onended;this._onended=h!==null&&h===d?u:h}get playbackRate(){return this._playbackRate}start(u=0,d=0,h){if(this._nativeAudioBufferSourceNode.start(u,d,h),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=h===void 0?[u,d]:[u,d,h]),this.context.state!=="closed"){us(this);const g=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",g),bt(this)&&Ps(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",g)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},Kl=(n,e,t,s,a)=>()=>{const r=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const g=Le(h,d);if(!g){const f={buffer:h.buffer,channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,loop:h.loop,loopEnd:h.loopEnd,loopStart:h.loopStart,playbackRate:h.playbackRate.value};h=e(d,f),o!==null&&h.start(...o),l!==null&&h.stop(l)}return r.set(d,h),g?await n(d,u.playbackRate,h.playbackRate):await s(d,u.playbackRate,h.playbackRate),await a(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=r.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},Ql=n=>"playbackRate"in n,eu=n=>"frequency"in n&&"gain"in n,tu=n=>"offset"in n,su=n=>!("frequency"in n)&&"gain"in n,nu=n=>"detune"in n&&"frequency"in n&&!("gain"in n),iu=n=>"pan"in n,We=n=>it(lr,n),Fs=n=>it(ur,n),hi=(n,e)=>{const{activeInputs:t}=We(n);t.forEach(a=>a.forEach(([r])=>{e.includes(n)||hi(r,[...e,n])}));const s=Ql(n)?[n.playbackRate]:pr(n)?Array.from(n.parameters.values()):eu(n)?[n.Q,n.detune,n.frequency,n.gain]:tu(n)?[n.offset]:su(n)?[n.gain]:nu(n)?[n.detune,n.frequency]:iu(n)?[n.pan]:[];for(const a of s){const r=Fs(a);r!==void 0&&r.activeInputs.forEach(([o])=>hi(o,e))}bt(n)&&Ps(n)},gr=n=>{hi(n.destination,[])},au=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),ru=(n,e,t,s,a,r,o,l,c)=>class extends n{constructor(d={}){if(c===null)throw new Error("Missing the native AudioContext constructor.");let h;try{h=new c(d)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?t():p}if(h===null)throw s();if(!au(d.latencyHint))throw new TypeError(`The provided value '${d.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(d.sampleRate!==void 0&&h.sampleRate!==d.sampleRate)throw t();super(h,2);const{latencyHint:g}=d,{sampleRate:f}=h;if(this._baseLatency=typeof h.baseLatency=="number"?h.baseLatency:g==="balanced"?512/f:g==="interactive"||g===void 0?256/f:g==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(g*f/128)))*128/f,this._nativeAudioContext=h,c.name==="webkitAudioContext"?(this._nativeGainNode=h.createGain(),this._nativeOscillatorNode=h.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(h.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,h.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),h.removeEventListener("statechange",p)};h.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),gr(this)}))}createMediaElementSource(d){return new a(this,{mediaElement:d})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(d){return new o(this,{mediaStream:d})}createMediaStreamTrackSource(d){return new l(this,{mediaStreamTrack:d})}resume(){return this._state==="suspended"?new Promise((d,h)=>{const g=()=>{this._nativeAudioContext.removeEventListener("statechange",g),this._nativeAudioContext.state==="running"?d():this.resume().then(d,h)};this._nativeAudioContext.addEventListener("statechange",g)}):this._nativeAudioContext.resume().catch(d=>{throw d===void 0||d.code===15?e():d})}suspend(){return this._nativeAudioContext.suspend().catch(d=>{throw d===void 0?e():d})}},ou=(n,e,t,s,a,r,o,l)=>class extends n{constructor(u,d){const h=r(u),g=o(h),f=a(h,d,g),p=g?e(l):null;super(u,!1,f,p),this._isNodeOfNativeOfflineAudioContext=g,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},cu=n=>{const e=new WeakMap,t=async(s,a)=>{const r=a.destination;return e.set(a,r),await n(s,a,r),r};return{render(s,a){const r=e.get(a);return r!==void 0?Promise.resolve(r):t(s,a)}}},lu=(n,e,t,s,a,r,o,l)=>(c,u)=>{const d=u.listener,h=()=>{const b=new Float32Array(1),T=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),j=o(u);let v=!1,N=[0,0,-1,0,1,0],E=[0,0,0];const O=()=>{if(v)return;v=!0;const L=s(u,256,9,0);L.onaudioprocess=({inputBuffer:V})=>{const R=[r(V,b,0),r(V,b,1),r(V,b,2),r(V,b,3),r(V,b,4),r(V,b,5)];R.some((Y,H)=>Y!==N[H])&&(d.setOrientation(...R),N=R);const B=[r(V,b,6),r(V,b,7),r(V,b,8)];B.some((Y,H)=>Y!==E[H])&&(d.setPosition(...B),E=B)},T.connect(L)},M=L=>V=>{V!==N[L]&&(N[L]=V,d.setOrientation(...N))},D=L=>V=>{V!==E[L]&&(E[L]=V,d.setPosition(...E))},k=(L,V,R)=>{const B=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:V});B.connect(T,0,L),B.start(),Object.defineProperty(B.offset,"defaultValue",{get(){return V}});const Y=n({context:c},j,B.offset,qe,Ue);return l(Y,"value",H=>()=>H.call(Y),H=>X=>{try{H.call(Y,X)}catch(ee){if(ee.code!==9)throw ee}O(),j&&R(X)}),Y.cancelAndHoldAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.cancelAndHoldAtTime),Y.cancelScheduledValues=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.cancelScheduledValues),Y.exponentialRampToValueAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.exponentialRampToValueAtTime),Y.linearRampToValueAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.linearRampToValueAtTime),Y.setTargetAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.setTargetAtTime),Y.setValueAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.setValueAtTime),Y.setValueCurveAtTime=(H=>j?()=>{throw a()}:(...X)=>{const ee=H.apply(Y,X);return O(),ee})(Y.setValueCurveAtTime),Y};return{forwardX:k(0,0,M(0)),forwardY:k(1,0,M(1)),forwardZ:k(2,-1,M(2)),positionX:k(6,0,D(0)),positionY:k(7,0,D(1)),positionZ:k(8,0,D(2)),upX:k(3,0,M(3)),upY:k(4,1,M(4)),upZ:k(5,0,M(5))}},{forwardX:g,forwardY:f,forwardZ:p,positionX:m,positionY:_,positionZ:y,upX:x,upY:S,upZ:A}=d.forwardX===void 0?h():d;return{get forwardX(){return g},get forwardY(){return f},get forwardZ(){return p},get positionX(){return m},get positionY(){return _},get positionZ(){return y},get upX(){return x},get upY(){return S},get upZ(){return A}}},ln=n=>"context"in n,Ls=n=>ln(n[0]),Zt=(n,e,t,s)=>{for(const a of n)if(t(a)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(e),!0},Ea=(n,e,[t,s],a)=>{Zt(n,[e,t,s],r=>r[0]===e&&r[1]===t,a)},Ma=(n,[e,t,s],a)=>{const r=n.get(e);r===void 0?n.set(e,new Set([[t,s]])):Zt(r,[t,s],o=>o[0]===t,a)},ys=n=>"inputs"in n,un=(n,e,t,s)=>{if(ys(e)){const a=e.inputs[s];return n.connect(a,t,0),[a,t,0]}return n.connect(e,t,s),[e,t,s]},vr=(n,e,t)=>{for(const s of n)if(s[0]===e&&s[1]===t)return n.delete(s),s;return null},uu=(n,e,t)=>xn(n,s=>s[0]===e&&s[1]===t),yr=(n,e)=>{if(!Rs(n).delete(e))throw new Error("Missing the expected event listener.")},_r=(n,e,t)=>{const s=it(n,e),a=xn(s,r=>r[0]===t);return s.size===0&&n.delete(e),a},dn=(n,e,t,s)=>{ys(e)?n.disconnect(e.inputs[s],t,0):n.disconnect(e,t,s)},he=n=>it(bi,n),Es=n=>it(xi,n),Gt=n=>ci.has(n),en=n=>!ls.has(n),Ia=(n,e)=>new Promise(t=>{if(e!==null)t(!0);else{const s=n.createScriptProcessor(256,1,1),a=n.createGain(),r=n.createBuffer(1,2,44100),o=r.getChannelData(0);o[0]=1,o[1]=1;const l=n.createBufferSource();l.buffer=r,l.loop=!0,l.connect(s).connect(n.destination),l.connect(a),l.disconnect(a),s.onaudioprocess=c=>{const u=c.inputBuffer.getChannelData(0);Array.prototype.some.call(u,d=>d===1)?t(!0):t(!1),l.stop(),s.onaudioprocess=null,l.disconnect(s),s.disconnect(n.destination)},l.start()}}),Zn=(n,e)=>{const t=new Map;for(const s of n)for(const a of s){const r=t.get(a);t.set(a,r===void 0?1:r+1)}t.forEach((s,a)=>e(a,s))},hn=n=>"context"in n,du=n=>{const e=new Map;n.connect=(t=>(s,a=0,r=0)=>{const o=hn(s)?t(s,a,r):t(s,a),l=e.get(s);return l===void 0?e.set(s,[{input:r,output:a}]):l.every(c=>c.input!==r||c.output!==a)&&l.push({input:r,output:a}),o})(n.connect.bind(n)),n.disconnect=(t=>(s,a,r)=>{if(t.apply(n),s===void 0)e.clear();else if(typeof s=="number")for(const[o,l]of e){const c=l.filter(u=>u.output!==s);c.length===0?e.delete(o):e.set(o,c)}else if(e.has(s))if(a===void 0)e.delete(s);else{const o=e.get(s);if(o!==void 0){const l=o.filter(c=>c.output!==a&&(c.input!==r||r===void 0));l.length===0?e.delete(s):e.set(s,l)}}for(const[o,l]of e)l.forEach(c=>{hn(o)?n.connect(o,c.output,c.input):n.connect(o,c.output)})})(n.disconnect)},hu=(n,e,t,s)=>{const{activeInputs:a,passiveInputs:r}=Fs(e),{outputs:o}=We(n),l=Rs(n),c=u=>{const d=he(n),h=Es(e);if(u){const g=_r(r,n,t);Ea(a,n,g,!1),!s&&!Gt(n)&&d.connect(h,t)}else{const g=uu(a,n,t);Ma(r,g,!1),!s&&!Gt(n)&&d.disconnect(h,t)}};return Zt(o,[e,t],u=>u[0]===e&&u[1]===t,!0)?(l.add(c),bt(n)?Ea(a,n,[t,c],!0):Ma(r,[n,t,c],!0),!0):!1},mu=(n,e,t,s)=>{const{activeInputs:a,passiveInputs:r}=We(e),o=vr(a[s],n,t);return o===null?[mr(r,n,t,s)[2],!1]:[o[2],!0]},pu=(n,e,t)=>{const{activeInputs:s,passiveInputs:a}=Fs(e),r=vr(s,n,t);return r===null?[_r(a,n,t)[1],!1]:[r[2],!0]},Ni=(n,e,t,s,a)=>{const[r,o]=mu(n,t,s,a);if(r!==null&&(yr(n,r),o&&!e&&!Gt(n)&&dn(he(n),he(t),s,a)),bt(t)){const{activeInputs:l}=We(t);di(t,l)}},Si=(n,e,t,s)=>{const[a,r]=pu(n,t,s);a!==null&&(yr(n,a),r&&!e&&!Gt(n)&&he(n).disconnect(Es(t),s))},fu=(n,e)=>{const t=We(n),s=[];for(const a of t.outputs)Ls(a)?Ni(n,e,...a):Si(n,e,...a),s.push(a[0]);return t.outputs.clear(),s},gu=(n,e,t)=>{const s=We(n),a=[];for(const r of s.outputs)r[1]===t&&(Ls(r)?Ni(n,e,...r):Si(n,e,...r),a.push(r[0]),s.outputs.delete(r));return a},vu=(n,e,t,s,a)=>{const r=We(n);return Array.from(r.outputs).filter(o=>o[0]===t&&(s===void 0||o[1]===s)&&(a===void 0||o[2]===a)).map(o=>(Ls(o)?Ni(n,e,...o):Si(n,e,...o),r.outputs.delete(o),o[0]))},yu=(n,e,t,s,a,r,o,l,c,u,d,h,g,f,p,m)=>class extends u{constructor(y,x,S,A){super(S),this._context=y,this._nativeAudioNode=S;const b=d(y);h(b)&&t(Ia,()=>Ia(b,m))!==!0&&du(S),bi.set(this,S),dr.set(this,new Set),y.state!=="closed"&&x&&us(this),n(this,A,S)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(y){this._nativeAudioNode.channelCount=y}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(y){this._nativeAudioNode.channelCountMode=y}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(y){this._nativeAudioNode.channelInterpretation=y}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(y,x=0,S=0){if(x<0||x>=this._nativeAudioNode.numberOfOutputs)throw a();const A=d(this._context),b=p(A);if(g(y)||f(y))throw r();if(ln(y)){const v=he(y);try{const E=un(this._nativeAudioNode,v,x,S),O=en(this);(b||O)&&this._nativeAudioNode.disconnect(...E),this.context.state!=="closed"&&!O&&en(y)&&us(y)}catch(E){throw E.code===12?r():E}if(e(this,y,x,S,b)){const E=c([this],y);Zn(E,s(b))}return y}const T=Es(y);if(T.name==="playbackRate"&&T.maxValue===1024)throw o();try{this._nativeAudioNode.connect(T,x),(b||en(this))&&this._nativeAudioNode.disconnect(T,x)}catch(v){throw v.code===12?r():v}if(hu(this,y,x,b)){const v=c([this],y);Zn(v,s(b))}}disconnect(y,x,S){let A;const b=d(this._context),T=p(b);if(y===void 0)A=fu(this,T);else if(typeof y=="number"){if(y<0||y>=this.numberOfOutputs)throw a();A=gu(this,T,y)}else{if(x!==void 0&&(x<0||x>=this.numberOfOutputs)||ln(y)&&S!==void 0&&(S<0||S>=y.numberOfInputs))throw a();if(A=vu(this,T,y,x,S),A.length===0)throw r()}for(const j of A){const v=c([this],j);Zn(v,l)}}},_u=(n,e,t,s,a,r,o,l,c,u,d,h,g)=>(f,p,m,_=null,y=null)=>{const x=m.value,S=new Al(x),A=p?s(S):null,b={get defaultValue(){return x},get maxValue(){return _===null?m.maxValue:_},get minValue(){return y===null?m.minValue:y},get value(){return m.value},set value(T){m.value=T,b.setValueAtTime(T,f.context.currentTime)},cancelAndHoldAtTime(T){if(typeof m.cancelAndHoldAtTime=="function")A===null&&S.flush(f.context.currentTime),S.add(a(T)),m.cancelAndHoldAtTime(T);else{const j=Array.from(S).pop();A===null&&S.flush(f.context.currentTime),S.add(a(T));const v=Array.from(S).pop();m.cancelScheduledValues(T),j!==v&&v!==void 0&&(v.type==="exponentialRampToValue"?m.exponentialRampToValueAtTime(v.value,v.endTime):v.type==="linearRampToValue"?m.linearRampToValueAtTime(v.value,v.endTime):v.type==="setValue"?m.setValueAtTime(v.value,v.startTime):v.type==="setValueCurve"&&m.setValueCurveAtTime(v.values,v.startTime,v.duration))}return b},cancelScheduledValues(T){return A===null&&S.flush(f.context.currentTime),S.add(r(T)),m.cancelScheduledValues(T),b},exponentialRampToValueAtTime(T,j){if(T===0)throw new RangeError;if(!Number.isFinite(j)||j<0)throw new RangeError;const v=f.context.currentTime;return A===null&&S.flush(v),Array.from(S).length===0&&(S.add(u(x,v)),m.setValueAtTime(x,v)),S.add(o(T,j)),m.exponentialRampToValueAtTime(T,j),b},linearRampToValueAtTime(T,j){const v=f.context.currentTime;return A===null&&S.flush(v),Array.from(S).length===0&&(S.add(u(x,v)),m.setValueAtTime(x,v)),S.add(l(T,j)),m.linearRampToValueAtTime(T,j),b},setTargetAtTime(T,j,v){return A===null&&S.flush(f.context.currentTime),S.add(c(T,j,v)),m.setTargetAtTime(T,j,v),b},setValueAtTime(T,j){return A===null&&S.flush(f.context.currentTime),S.add(u(T,j)),m.setValueAtTime(T,j),b},setValueCurveAtTime(T,j,v){const N=T instanceof Float32Array?T:new Float32Array(T);if(h!==null&&h.name==="webkitAudioContext"){const E=j+v,O=f.context.sampleRate,M=Math.ceil(j*O),D=Math.floor(E*O),k=D-M,L=new Float32Array(k);for(let R=0;R<k;R+=1){const B=(N.length-1)/v*((M+R)/O-j),Y=Math.floor(B),H=Math.ceil(B);L[R]=Y===H?N[Y]:(1-(B-Y))*N[Y]+(1-(H-B))*N[H]}A===null&&S.flush(f.context.currentTime),S.add(d(L,j,v)),m.setValueCurveAtTime(L,j,v);const V=D/O;V<E&&g(b,L[L.length-1],V),g(b,N[N.length-1],E)}else A===null&&S.flush(f.context.currentTime),S.add(d(N,j,v)),m.setValueCurveAtTime(N,j,v);return b}};return t.set(b,m),e.set(b,f),n(b,A),b},bu=n=>({replay(e){for(const t of n)if(t.type==="exponentialRampToValue"){const{endTime:s,value:a}=t;e.exponentialRampToValueAtTime(a,s)}else if(t.type==="linearRampToValue"){const{endTime:s,value:a}=t;e.linearRampToValueAtTime(a,s)}else if(t.type==="setTarget"){const{startTime:s,target:a,timeConstant:r}=t;e.setTargetAtTime(a,s,r)}else if(t.type==="setValue"){const{startTime:s,value:a}=t;e.setValueAtTime(a,s)}else if(t.type==="setValueCurve"){const{duration:s,startTime:a,values:r}=t;e.setValueCurveAtTime(r,a,s)}else throw new Error("Can't apply an unknown automation.")}});class br{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((s,a)=>e.call(t,s,a,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const xu={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},wu=(n,e,t,s,a,r,o,l,c,u,d,h,g,f)=>class extends e{constructor(m,_,y){var x;const S=l(m),A=c(S),b=d({...xu,...y});g(b);const T=li.get(S),j=T?.get(_),v=A||S.state!=="closed"?S:(x=o(S))!==null&&x!==void 0?x:S,N=a(v,A?null:m.baseLatency,u,_,j,b),E=A?s(_,b,j):null;super(m,!0,N,E);const O=[];N.parameters.forEach((D,k)=>{const L=t(this,A,D);O.push([k,L])}),this._nativeAudioWorkletNode=N,this._onprocessorerror=null,this._parameters=new br(O),A&&n(S,this);const{activeInputs:M}=r(this);h(N,M)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(m){const _=typeof m=="function"?f(this,m):null;this._nativeAudioWorkletNode.onprocessorerror=_;const y=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=y!==null&&y===_?m:y}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function mn(n,e,t,s,a){if(typeof n.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),n.copyFromChannel(e[t],s,a);else{const r=n.getChannelData(s);if(e[t].byteLength===0)e[t]=r.slice(a,a+128);else{const o=new Float32Array(r.buffer,a*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(o)}}}const xr=(n,e,t,s,a)=>{typeof n.copyToChannel=="function"?e[t].byteLength!==0&&n.copyToChannel(e[t],s,a):e[t].byteLength!==0&&n.getChannelData(s).set(e[t],a)},pn=(n,e)=>{const t=[];for(let s=0;s<n;s+=1){const a=[],r=typeof e=="number"?e:e[s];for(let o=0;o<r;o+=1)a.push(new Float32Array(128));t.push(a)}return t},Nu=(n,e)=>{const t=it(ui,n),s=he(e);return it(t,s)},Su=async(n,e,t,s,a,r,o)=>{const l=e===null?Math.ceil(n.context.length/128)*128:e.length,c=s.channelCount*s.numberOfInputs,u=a.reduce((_,y)=>_+y,0),d=u===0?null:t.createBuffer(u,l,t.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const h=We(n),g=await Nu(t,n),f=pn(s.numberOfInputs,s.channelCount),p=pn(s.numberOfOutputs,a),m=Array.from(n.parameters.keys()).reduce((_,y)=>({..._,[y]:new Float32Array(128)}),{});for(let _=0;_<l;_+=128){if(s.numberOfInputs>0&&e!==null)for(let y=0;y<s.numberOfInputs;y+=1)for(let x=0;x<s.channelCount;x+=1)mn(e,f[y],x,x,_);r.parameterDescriptors!==void 0&&e!==null&&r.parameterDescriptors.forEach(({name:y},x)=>{mn(e,m,y,c+x,_)});for(let y=0;y<s.numberOfInputs;y+=1)for(let x=0;x<a[y];x+=1)p[y][x].byteLength===0&&(p[y][x]=new Float32Array(128));try{const y=f.map((S,A)=>h.activeInputs[A].size===0?[]:S),x=o(_/t.sampleRate,t.sampleRate,()=>g.process(y,p,m));if(d!==null)for(let S=0,A=0;S<s.numberOfOutputs;S+=1){for(let b=0;b<a[S];b+=1)xr(d,p[S],b,A+b,_);A+=a[S]}if(!x)break}catch(y){n.dispatchEvent(new ErrorEvent("processorerror",{colno:y.colno,filename:y.filename,lineno:y.lineno,message:y.message}));break}}return d},ju=(n,e,t,s,a,r,o,l,c,u,d,h,g,f,p,m)=>(_,y,x)=>{const S=new WeakMap;let A=null;const b=async(T,j)=>{let v=d(T),N=null;const E=Le(v,j),O=Array.isArray(y.outputChannelCount)?y.outputChannelCount:Array.from(y.outputChannelCount);if(h===null){const M=O.reduce((V,R)=>V+R,0),D=a(j,{channelCount:Math.max(1,M),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,M)}),k=[];for(let V=0;V<T.numberOfOutputs;V+=1)k.push(s(j,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:O[V]}));const L=o(j,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1});L.connect=e.bind(null,k),L.disconnect=c.bind(null,k),N=[D,k,L]}else E||(v=new h(j,_));if(S.set(j,N===null?v:N[2]),N!==null){if(A===null){if(x===void 0)throw new Error("Missing the processor constructor.");if(g===null)throw new Error("Missing the native OfflineAudioContext constructor.");const R=T.channelCount*T.numberOfInputs,B=x.parameterDescriptors===void 0?0:x.parameterDescriptors.length,Y=R+B;A=Su(T,Y===0?null:await(async()=>{const X=new g(Y,Math.ceil(T.context.length/128)*128,j.sampleRate),ee=[],$=[];for(let I=0;I<y.numberOfInputs;I+=1)ee.push(o(X,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1})),$.push(a(X,{channelCount:y.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:y.channelCount}));const Q=await Promise.all(Array.from(T.parameters.values()).map(async I=>{const P=r(X,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:I.value});return await f(X,I,P.offset),P})),U=s(X,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,R+B)});for(let I=0;I<y.numberOfInputs;I+=1){ee[I].connect($[I]);for(let P=0;P<y.channelCount;P+=1)$[I].connect(U,P,I*y.channelCount+P)}for(const[I,P]of Q.entries())P.connect(U,0,R+I),P.start(0);return U.connect(X.destination),await Promise.all(ee.map(I=>p(T,X,I))),m(X)})(),j,y,O,x,u)}const M=await A,D=t(j,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[k,L,V]=N;M!==null&&(D.buffer=M,D.start(0)),D.connect(k);for(let R=0,B=0;R<T.numberOfOutputs;R+=1){const Y=L[R];for(let H=0;H<O[R];H+=1)k.connect(Y,B+H,H);B+=O[R]}return V}if(E)for(const[M,D]of T.parameters.entries())await n(j,D,v.parameters.get(M));else for(const[M,D]of T.parameters.entries())await f(j,D,v.parameters.get(M));return await p(T,j,v),v};return{render(T,j){l(j,T);const v=S.get(j);return v!==void 0?Promise.resolve(v):b(T,j)}}},Tu=(n,e,t,s,a,r,o,l,c,u,d,h,g,f,p,m,_,y,x,S)=>class extends p{constructor(b,T){super(b,T),this._nativeContext=b,this._audioWorklet=n===void 0?void 0:{addModule:(j,v)=>n(this,j,v)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new a(this)}createBuffer(b,T,j){return new t({length:T,numberOfChannels:b,sampleRate:j})}createBufferSource(){return new s(this)}createChannelMerger(b=6){return new r(this,{numberOfInputs:b})}createChannelSplitter(b=6){return new o(this,{numberOfOutputs:b})}createConstantSource(){return new l(this)}createConvolver(){return new c(this)}createDelay(b=1){return new d(this,{maxDelayTime:b})}createDynamicsCompressor(){return new h(this)}createGain(){return new g(this)}createIIRFilter(b,T){return new f(this,{feedback:T,feedforward:b})}createOscillator(){return new m(this)}createPanner(){return new _(this)}createPeriodicWave(b,T,j={disableNormalization:!1}){return new y(this,{...j,imag:T,real:b})}createStereoPanner(){return new x(this)}createWaveShaper(){return new S(this)}decodeAudioData(b,T,j){return u(this._nativeContext,b).then(v=>(typeof T=="function"&&T(v),v),v=>{throw typeof j=="function"&&j(v),v})}},ku={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Cu=(n,e,t,s,a,r,o,l)=>class extends n{constructor(u,d){const h=r(u),g={...ku,...d},f=a(h,g),p=o(h),m=p?t():null;super(u,!1,f,m),this._Q=e(this,p,f.Q,qe,Ue),this._detune=e(this,p,f.detune,1200*Math.log2(qe),-1200*Math.log2(qe)),this._frequency=e(this,p,f.frequency,u.sampleRate/2,0),this._gain=e(this,p,f.gain,40*Math.log10(qe),Ue),this._nativeBiquadFilterNode=f,l(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,d,h){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,d,h)}catch(g){throw g.code===11?s():g}if(u.length!==d.length||d.length!==h.length)throw s()}},Au=(n,e,t,s,a)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Le(u,c);if(!d){const h={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(c,h)}return r.set(c,u),d?(await n(c,l.Q,u.Q),await n(c,l.detune,u.detune),await n(c,l.frequency,u.frequency),await n(c,l.gain,u.gain)):(await s(c,l.Q,u.Q),await s(c,l.detune,u.detune),await s(c,l.frequency,u.frequency),await s(c,l.gain,u.gain)),await a(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Eu=(n,e)=>(t,s)=>{const a=e.get(t);if(a!==void 0)return a;const r=n.get(t);if(r!==void 0)return r;try{const o=s();return o instanceof Promise?(n.set(t,o),o.catch(()=>!1).then(l=>(n.delete(t),e.set(t,l),l))):(e.set(t,o),o)}catch{return e.set(t,!1),!1}},Mu={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Iu=(n,e,t,s,a)=>class extends n{constructor(o,l){const c=s(o),u={...Mu,...l},d=t(c,u),h=a(c)?e():null;super(o,!1,d,h)}},Du=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfInputs:l.numberOfInputs};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):a(r,o)}}},Ou={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Ru=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=s(l),d=r({...Ou,...c}),h=t(u,d),g=a(u)?e():null;super(l,!1,h,g)}},Pu=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfOutputs:l.numberOfOutputs};l=n(o,u)}return s.set(o,l),await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):a(r,o)}}},Fu=n=>(e,t,s)=>n(t,e,s),Lu=n=>(e,t,s=0,a=0)=>{const r=e[s];if(r===void 0)throw n();return hn(t)?r.connect(t,0,a):r.connect(t,0)},Vu=n=>(e,t)=>{const s=n(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),a=e.createBuffer(1,2,44100);return s.buffer=a,s.loop=!0,s.connect(t),s.start(),()=>{s.stop(),s.disconnect(t)}},qu={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Wu=(n,e,t,s,a,r,o)=>class extends n{constructor(c,u){const d=a(c),h={...qu,...u},g=s(d,h),f=r(d),p=f?t():null;super(c,!1,g,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=g,this._offset=e(this,f,g.offset,qe,Ue),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeConstantSourceNode.onended=u;const d=this._nativeConstantSourceNode.onended;this._onended=d!==null&&d===u?c:d}start(c=0){if(this._nativeConstantSourceNode.start(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=c),this.context.state!=="closed"){us(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),bt(this)&&Ps(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(c=0){this._nativeConstantSourceNode.stop(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=c)}},Bu=(n,e,t,s,a)=>()=>{const r=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const g=Le(h,d);if(!g){const f={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,offset:h.offset.value};h=e(d,f),o!==null&&h.start(o),l!==null&&h.stop(l)}return r.set(d,h),g?await n(d,u.offset,h.offset):await s(d,u.offset,h.offset),await a(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=r.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},Uu=n=>e=>(n[0]=e,n[0]),$u={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Gu=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=s(l),d={...$u,...c},h=t(u,d),f=a(u)?e():null;super(l,!1,h,f),this._isBufferNullified=!1,this._nativeConvolverNode=h,d.buffer!==null&&r(this,d.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(l){if(this._nativeConvolverNode.buffer=l,l===null&&this._nativeConvolverNode.buffer!==null){const c=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=c.createBuffer(1,1,c.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(l){this._nativeConvolverNode.normalize=l}},zu=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={buffer:l.buffer,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,disableNormalization:!l.normalize};l=n(o,u)}return s.set(o,l),ys(l)?await t(r,o,l.inputs[0]):await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):a(r,o)}}},Yu=(n,e)=>(t,s,a)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,s,a)}catch(r){throw r.name==="SyntaxError"?n():r}},Hu=()=>new DOMException("","DataCloneError"),Da=n=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(s=>{const a=()=>{t.onmessage=null,e.close(),t.close(),s()};t.onmessage=()=>a();try{e.postMessage(n,[n])}catch{}finally{a()}})},Xu=(n,e,t,s,a,r,o,l,c,u,d)=>(h,g)=>{const f=o(h)?h:r(h);if(a.has(g)){const p=t();return Promise.reject(p)}try{a.add(g)}catch{}return e(c,()=>c(f))?f.decodeAudioData(g).then(p=>(Da(g).catch(()=>{}),e(l,()=>l(p))||d(p),n.add(p),p)):new Promise((p,m)=>{const _=async()=>{try{await Da(g)}catch{}},y=x=>{m(x),_()};try{f.decodeAudioData(g,x=>{typeof x.copyFromChannel!="function"&&(u(x),wi(x)),n.add(x),_().then(()=>p(x))},x=>{y(x===null?s():x)})}catch(x){y(x)}})},Ju=(n,e,t,s,a,r,o,l)=>(c,u)=>{const d=e.get(c);if(d===void 0)throw new Error("Missing the expected cycle count.");const h=r(c.context),g=l(h);if(d===u){if(e.delete(c),!g&&o(c)){const f=s(c),{outputs:p}=t(c);for(const m of p)if(Ls(m)){const _=s(m[0]);n(f,_,m[1],m[2])}else{const _=a(m[0]);f.connect(_,m[1])}}}else e.set(c,d-u)},Zu={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Ku=(n,e,t,s,a,r,o)=>class extends n{constructor(c,u){const d=a(c),h={...Zu,...u},g=s(d,h),f=r(d),p=f?t(h.maxDelayTime):null;super(c,!1,g,p),this._delayTime=e(this,f,g.delayTime),o(this,h.maxDelayTime)}get delayTime(){return this._delayTime}},Qu=(n,e,t,s,a)=>r=>{const o=new WeakMap,l=async(c,u)=>{let d=t(c);const h=Le(d,u);if(!h){const g={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,delayTime:d.delayTime.value,maxDelayTime:r};d=e(u,g)}return o.set(u,d),h?await n(u,c.delayTime,d.delayTime):await s(u,c.delayTime,d.delayTime),await a(c,u,d),d};return{render(c,u){const d=o.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},ed=n=>(e,t,s,a)=>n(e[a],r=>r[0]===t&&r[1]===s),td=n=>(e,t)=>{n(e).delete(t)},sd=n=>"delayTime"in n,nd=(n,e,t)=>function s(a,r){const o=ln(r)?r:t(n,r);if(sd(o))return[];if(a[0]===o)return[a];if(a.includes(o))return[];const{outputs:l}=e(o);return Array.from(l).map(c=>s([...a,o],c[0])).reduce((c,u)=>c.concat(u),[])},Js=(n,e,t)=>{const s=e[t];if(s===void 0)throw n();return s},id=n=>(e,t=void 0,s=void 0,a=0)=>t===void 0?e.forEach(r=>r.disconnect()):typeof t=="number"?Js(n,e,t).disconnect():hn(t)?s===void 0?e.forEach(r=>r.disconnect(t)):a===void 0?Js(n,e,s).disconnect(t,0):Js(n,e,s).disconnect(t,0,a):s===void 0?e.forEach(r=>r.disconnect(t)):Js(n,e,s).disconnect(t,0),ad={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},rd=(n,e,t,s,a,r,o,l)=>class extends n{constructor(u,d){const h=r(u),g={...ad,...d},f=s(h,g),p=o(h),m=p?t():null;super(u,!1,f,m),this._attack=e(this,p,f.attack),this._knee=e(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,p,f.ratio),this._release=e(this,p,f.release),this._threshold=e(this,p,f.threshold),l(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const d=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=d,a()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const d=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=d,a()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},od=(n,e,t,s,a)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Le(u,c);if(!d){const h={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(c,h)}return r.set(c,u),d?(await n(c,l.attack,u.attack),await n(c,l.knee,u.knee),await n(c,l.ratio,u.ratio),await n(c,l.release,u.release),await n(c,l.threshold,u.threshold)):(await s(c,l.attack,u.attack),await s(c,l.knee,u.knee),await s(c,l.ratio,u.ratio),await s(c,l.release,u.release),await s(c,l.threshold,u.threshold)),await a(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},cd=()=>new DOMException("","EncodingError"),ld=n=>e=>new Promise((t,s)=>{if(n===null){s(new SyntaxError);return}const a=n.document.head;if(a===null)s(new SyntaxError);else{const r=n.document.createElement("script"),o=new Blob([e],{type:"application/javascript"}),l=URL.createObjectURL(o),c=n.onerror,u=()=>{n.onerror=c,URL.revokeObjectURL(l)};n.onerror=(d,h,g,f,p)=>{if(h===l||h===n.location.href&&g===1&&f===1)return u(),s(p),!1;if(c!==null)return c(d,h,g,f,p)},r.onerror=()=>{u(),s(new SyntaxError)},r.onload=()=>{u(),t()},r.src=l,r.type="module",a.appendChild(r)}}),ud=n=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,s,a){if(s!==null){let r=this._listeners.get(s);r===void 0&&(r=n(this,s),typeof s=="function"&&this._listeners.set(s,r)),this._nativeEventTarget.addEventListener(t,r,a)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,s,a){const r=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(t,r===void 0?null:r,a)}},dd=n=>(e,t,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},hd=n=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw n()},md={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},pd=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=a(l),d={...md,...c},h=s(u,d),g=r(u),f=g?t():null;super(l,!1,h,f),this._gain=e(this,g,h.gain,qe,Ue)}get gain(){return this._gain}},fd=(n,e,t,s,a)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Le(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(c,h)}return r.set(c,u),d?await n(c,l.gain,u.gain):await s(c,l.gain,u.gain),await a(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},gd=(n,e)=>t=>e(n,t),vd=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},yd=n=>e=>{var t;return(t=n.get(e))!==null&&t!==void 0?t:0},_d=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},bd=n=>e=>n.get(e),De=()=>new DOMException("","InvalidStateError"),xd=n=>e=>{const t=n.get(e);if(t===void 0)throw De();return t},wd=(n,e)=>t=>{let s=n.get(t);if(s!==void 0)return s;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new e(1,1,44100),n.set(t,s),s},Nd=n=>e=>{const t=n.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},wn=()=>new DOMException("","InvalidAccessError"),Sd=n=>{n.getFrequencyResponse=(e=>(t,s,a)=>{if(t.length!==s.length||s.length!==a.length)throw wn();return e.call(n,t,s,a)})(n.getFrequencyResponse)},jd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Td=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=s(l),d=a(u),h={...jd,...c},g=e(u,d?null:l.baseLatency,h),f=d?t(h.feedback,h.feedforward):null;super(l,!1,g,f),Sd(g),this._nativeIIRFilterNode=g,r(this,1)}getFrequencyResponse(l,c,u){return this._nativeIIRFilterNode.getFrequencyResponse(l,c,u)}},wr=(n,e,t,s,a,r,o,l,c,u,d)=>{const h=u.length;let g=l;for(let f=0;f<h;f+=1){let p=t[0]*u[f];for(let m=1;m<a;m+=1){const _=g-m&c-1;p+=t[m]*r[_],p-=n[m]*o[_]}for(let m=a;m<s;m+=1)p+=t[m]*r[g-m&c-1];for(let m=a;m<e;m+=1)p-=n[m]*o[g-m&c-1];r[g]=u[f],o[g]=p,g=g+1&c-1,d[f]=p}return g},kd=(n,e,t,s)=>{const a=t instanceof Float64Array?t:new Float64Array(t),r=s instanceof Float64Array?s:new Float64Array(s),o=a.length,l=r.length,c=Math.min(o,l);if(a[0]!==1){for(let p=0;p<o;p+=1)r[p]/=a[0];for(let p=1;p<l;p+=1)a[p]/=a[0]}const u=32,d=new Float32Array(u),h=new Float32Array(u),g=e.createBuffer(n.numberOfChannels,n.length,n.sampleRate),f=n.numberOfChannels;for(let p=0;p<f;p+=1){const m=n.getChannelData(p),_=g.getChannelData(p);d.fill(0),h.fill(0),wr(a,o,r,l,c,d,h,0,u,m,_)}return g},Cd=(n,e,t,s,a)=>(r,o)=>{const l=new WeakMap;let c=null;const u=async(d,h)=>{let g=null,f=e(d);const p=Le(f,h);if(h.createIIRFilter===void 0?g=n(h,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=h.createIIRFilter(o,r)),l.set(h,g===null?f:g),g!==null){if(c===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const _=new t(d.context.destination.channelCount,d.context.length,h.sampleRate);c=(async()=>{await s(d,_,_.destination);const y=await a(_);return kd(y,h,r,o)})()}const m=await c;return g.buffer=m,g.start(0),g}return await s(d,h,f),f};return{render(d,h){const g=l.get(h);return g!==void 0?Promise.resolve(g):u(d,h)}}},Ad=(n,e,t,s,a,r)=>o=>(l,c)=>{const u=n.get(l);if(u===void 0){if(!o&&r(l)){const d=s(l),{outputs:h}=t(l);for(const g of h)if(Ls(g)){const f=s(g[0]);e(d,f,g[1],g[2])}else{const f=a(g[0]);d.disconnect(f,g[1])}}n.set(l,c)}else n.set(l,u+c)},Ed=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Md=(n,e)=>t=>n.has(t)||e(t),Id=(n,e)=>t=>n.has(t)||e(t),Dd=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Od=n=>e=>n!==null&&e instanceof n,Rd=n=>e=>n!==null&&typeof n.AudioNode=="function"&&e instanceof n.AudioNode,Pd=n=>e=>n!==null&&typeof n.AudioParam=="function"&&e instanceof n.AudioParam,Fd=(n,e)=>t=>n(t)||e(t),Ld=n=>e=>n!==null&&e instanceof n,Vd=n=>n!==null&&n.isSecureContext,qd=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r),c=e(l,o);if(s(l))throw TypeError();super(r,!0,c,null),this._nativeMediaElementAudioSourceNode=c}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},Wd={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Bd=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r);if(s(l))throw new TypeError;const c={...Wd,...o},u=e(l,c);super(r,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},Ud=(n,e,t,s)=>class extends n{constructor(r,o){const l=t(r),c=e(l,o);if(s(l))throw new TypeError;super(r,!0,c,null),this._nativeMediaStreamAudioSourceNode=c}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},$d=(n,e,t)=>class extends n{constructor(a,r){const o=t(a),l=e(o,r);super(a,!0,l,null)}},Gd=(n,e,t,s,a,r)=>class extends t{constructor(l,c){super(l),this._nativeContext=l,bn.set(this,l),s(l)&&a.set(l,new Set),this._destination=new n(this,c),this._listener=e(this,l),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(l){const c=typeof l=="function"?r(this,l):null;this._nativeContext.onstatechange=c;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===c?l:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},Ms=n=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=n.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},zd=(n,e)=>(t,s,a)=>{const r=new Set;return t.connect=(o=>(l,c=0,u=0)=>{const d=r.size===0;if(e(l))return o.call(t,l,c,u),n(r,[l,c,u],h=>h[0]===l&&h[1]===c&&h[2]===u,!0),d&&s(),l;o.call(t,l,c),n(r,[l,c],h=>h[0]===l&&h[1]===c,!0),d&&s()})(t.connect),t.disconnect=(o=>(l,c,u)=>{const d=r.size>0;if(l===void 0)o.apply(t),r.clear();else if(typeof l=="number"){o.call(t,l);for(const g of r)g[1]===l&&r.delete(g)}else{e(l)?o.call(t,l,c,u):o.call(t,l,c);for(const g of r)g[0]===l&&(c===void 0||g[1]===c)&&(u===void 0||g[2]===u)&&r.delete(g)}const h=r.size===0;d&&h&&a()})(t.disconnect),t},ge=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t]&&(n[t]=s)},Ee=(n,e)=>{ge(n,e,"channelCount"),ge(n,e,"channelCountMode"),ge(n,e,"channelInterpretation")},Oa=n=>typeof n.getFloatTimeDomainData=="function",Yd=n=>{n.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);n.getByteTimeDomainData(t);const s=Math.max(t.length,n.fftSize);for(let a=0;a<s;a+=1)e[a]=(t[a]-128)*.0078125;return e}},Hd=(n,e)=>(t,s)=>{const a=t.createAnalyser();if(Ee(a,s),!(s.maxDecibels>s.minDecibels))throw e();return ge(a,s,"fftSize"),ge(a,s,"maxDecibels"),ge(a,s,"minDecibels"),ge(a,s,"smoothingTimeConstant"),n(Oa,()=>Oa(a))||Yd(a),a},Xd=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,xe=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t].value&&(n[t].value=s)},Jd=n=>{n.start=(e=>{let t=!1;return(s=0,a=0,r)=>{if(t)throw De();e.call(n,s,a,r),t=!0}})(n.start)},ji=n=>{n.start=(e=>(t=0,s=0,a)=>{if(typeof a=="number"&&a<0||s<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(n,t,s,a)})(n.start)},Ti=n=>{n.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(n,t)})(n.stop)},Zd=(n,e,t,s,a,r,o,l,c,u,d)=>(h,g)=>{const f=h.createBufferSource();return Ee(f,g),xe(f,g,"playbackRate"),ge(f,g,"buffer"),ge(f,g,"loop"),ge(f,g,"loopEnd"),ge(f,g,"loopStart"),e(t,()=>t(h))||Jd(f),e(s,()=>s(h))||c(f),e(a,()=>a(h))||u(f,h),e(r,()=>r(h))||ji(f),e(o,()=>o(h))||d(f,h),e(l,()=>l(h))||Ti(f),n(h,f),f},Kd=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,Qd=(n,e)=>(t,s,a)=>{const r=t.destination;if(r.channelCount!==s)try{r.channelCount=s}catch{}a&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:s});const o=n(t,{channelCount:s,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return e(o,"channelCount",l=>()=>l.call(o),l=>c=>{l.call(o,c);try{r.channelCount=c}catch(u){if(c>r.maxChannelCount)throw u}}),e(o,"channelCountMode",l=>()=>l.call(o),l=>c=>{l.call(o,c),r.channelCountMode=c}),e(o,"channelInterpretation",l=>()=>l.call(o),l=>c=>{l.call(o,c),r.channelInterpretation=c}),Object.defineProperty(o,"maxChannelCount",{get:()=>r.maxChannelCount}),o.connect(r),o},eh=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,th=n=>{const{port1:e}=new MessageChannel;try{e.postMessage(n)}finally{e.close()}},sh=(n,e,t,s,a)=>(r,o,l,c,u,d)=>{if(l!==null)try{const h=new l(r,c,d),g=new Map;let f=null;if(Object.defineProperties(h,{channelCount:{get:()=>d.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&h.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&h.addEventListener("processorerror",f)}}}),h.addEventListener=(p=>(...m)=>{if(m[0]==="processorerror"){const _=typeof m[1]=="function"?m[1]:typeof m[1]=="object"&&m[1]!==null&&typeof m[1].handleEvent=="function"?m[1].handleEvent:null;if(_!==null){const y=g.get(m[1]);y!==void 0?m[1]=y:(m[1]=x=>{x.type==="error"?(Object.defineProperties(x,{type:{value:"processorerror"}}),_(x)):_(new ErrorEvent(m[0],{...x}))},g.set(_,m[1]))}}return p.call(h,"error",m[1],m[2]),p.call(h,...m)})(h.addEventListener),h.removeEventListener=(p=>(...m)=>{if(m[0]==="processorerror"){const _=g.get(m[1]);_!==void 0&&(g.delete(m[1]),m[1]=_)}return p.call(h,"error",m[1],m[2]),p.call(h,m[0],m[1],m[2])})(h.removeEventListener),d.numberOfOutputs!==0){const p=t(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return h.connect(p).connect(r.destination),a(h,()=>p.disconnect(),()=>p.connect(r.destination))}return h}catch(h){throw h.code===11?s():h}if(u===void 0)throw s();return th(d),e(r,o,u,d)},Nr=(n,e)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*e))))),nh=n=>new Promise((e,t)=>{const{port1:s,port2:a}=new MessageChannel;s.onmessage=({data:r})=>{s.close(),a.close(),e(r)},s.onmessageerror=({data:r})=>{s.close(),a.close(),t(r)},a.postMessage(n)}),ih=async(n,e)=>{const t=await nh(e);return new n(t)},ah=(n,e,t,s)=>{let a=ui.get(n);a===void 0&&(a=new WeakMap,ui.set(n,a));const r=ih(t,s);return a.set(e,r),r},rh=(n,e,t,s,a,r,o,l,c,u,d,h,g)=>(f,p,m,_)=>{if(_.numberOfInputs===0&&_.numberOfOutputs===0)throw c();const y=Array.isArray(_.outputChannelCount)?_.outputChannelCount:Array.from(_.outputChannelCount);if(y.some(G=>G<1))throw c();if(y.length!==_.numberOfOutputs)throw e();if(_.channelCountMode!=="explicit")throw c();const x=_.channelCount*_.numberOfInputs,S=y.reduce((G,J)=>G+J,0),A=m.parameterDescriptors===void 0?0:m.parameterDescriptors.length;if(x+A>6||S>6)throw c();const b=new MessageChannel,T=[],j=[];for(let G=0;G<_.numberOfInputs;G+=1)T.push(o(f,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1})),j.push(a(f,{channelCount:_.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:_.channelCount}));const v=[];if(m.parameterDescriptors!==void 0)for(const{defaultValue:G,maxValue:J,minValue:ve,name:de}of m.parameterDescriptors){const ie=r(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:_.parameterData[de]!==void 0?_.parameterData[de]:G===void 0?0:G});Object.defineProperties(ie.offset,{defaultValue:{get:()=>G===void 0?0:G},maxValue:{get:()=>J===void 0?qe:J},minValue:{get:()=>ve===void 0?Ue:ve}}),v.push(ie)}const N=s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,x+A)}),E=Nr(p,f.sampleRate),O=l(f,E,x+A,Math.max(1,S)),M=a(f,{channelCount:Math.max(1,S),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,S)}),D=[];for(let G=0;G<_.numberOfOutputs;G+=1)D.push(s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:y[G]}));for(let G=0;G<_.numberOfInputs;G+=1){T[G].connect(j[G]);for(let J=0;J<_.channelCount;J+=1)j[G].connect(N,J,G*_.channelCount+J)}const k=new br(m.parameterDescriptors===void 0?[]:m.parameterDescriptors.map(({name:G},J)=>{const ve=v[J];return ve.connect(N,0,x+J),ve.start(0),[G,ve.offset]}));N.connect(O);let L=_.channelInterpretation,V=null;const R=_.numberOfOutputs===0?[O]:D,B={get bufferSize(){return E},get channelCount(){return _.channelCount},set channelCount(G){throw t()},get channelCountMode(){return _.channelCountMode},set channelCountMode(G){throw t()},get channelInterpretation(){return L},set channelInterpretation(G){for(const J of T)J.channelInterpretation=G;L=G},get context(){return O.context},get inputs(){return T},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},get onprocessorerror(){return V},set onprocessorerror(G){typeof V=="function"&&B.removeEventListener("processorerror",V),V=typeof G=="function"?G:null,typeof V=="function"&&B.addEventListener("processorerror",V)},get parameters(){return k},get port(){return b.port2},addEventListener(...G){return O.addEventListener(G[0],G[1],G[2])},connect:n.bind(null,R),disconnect:u.bind(null,R),dispatchEvent(...G){return O.dispatchEvent(G[0])},removeEventListener(...G){return O.removeEventListener(G[0],G[1],G[2])}},Y=new Map;b.port1.addEventListener=(G=>(...J)=>{if(J[0]==="message"){const ve=typeof J[1]=="function"?J[1]:typeof J[1]=="object"&&J[1]!==null&&typeof J[1].handleEvent=="function"?J[1].handleEvent:null;if(ve!==null){const de=Y.get(J[1]);de!==void 0?J[1]=de:(J[1]=ie=>{d(f.currentTime,f.sampleRate,()=>ve(ie))},Y.set(ve,J[1]))}}return G.call(b.port1,J[0],J[1],J[2])})(b.port1.addEventListener),b.port1.removeEventListener=(G=>(...J)=>{if(J[0]==="message"){const ve=Y.get(J[1]);ve!==void 0&&(Y.delete(J[1]),J[1]=ve)}return G.call(b.port1,J[0],J[1],J[2])})(b.port1.removeEventListener);let H=null;Object.defineProperty(b.port1,"onmessage",{get:()=>H,set:G=>{typeof H=="function"&&b.port1.removeEventListener("message",H),H=typeof G=="function"?G:null,typeof H=="function"&&(b.port1.addEventListener("message",H),b.port1.start())}}),m.prototype.port=b.port1;let X=null;ah(f,B,m,_).then(G=>X=G);const $=pn(_.numberOfInputs,_.channelCount),Q=pn(_.numberOfOutputs,y),U=m.parameterDescriptors===void 0?[]:m.parameterDescriptors.reduce((G,{name:J})=>({...G,[J]:new Float32Array(128)}),{});let I=!0;const P=()=>{_.numberOfOutputs>0&&O.disconnect(M);for(let G=0,J=0;G<_.numberOfOutputs;G+=1){const ve=D[G];for(let de=0;de<y[G];de+=1)M.disconnect(ve,J+de,de);J+=y[G]}},C=new Map;O.onaudioprocess=({inputBuffer:G,outputBuffer:J})=>{if(X!==null){const ve=h(B);for(let de=0;de<E;de+=128){for(let ie=0;ie<_.numberOfInputs;ie+=1)for(let me=0;me<_.channelCount;me+=1)mn(G,$[ie],me,me,de);m.parameterDescriptors!==void 0&&m.parameterDescriptors.forEach(({name:ie},me)=>{mn(G,U,ie,x+me,de)});for(let ie=0;ie<_.numberOfInputs;ie+=1)for(let me=0;me<y[ie];me+=1)Q[ie][me].byteLength===0&&(Q[ie][me]=new Float32Array(128));try{const ie=$.map((Ve,ct)=>{if(ve[ct].size>0)return C.set(ct,E/128),Ve;const Ts=C.get(ct);return Ts===void 0?[]:(Ve.every(tt=>tt.every(Wn=>Wn===0))&&(Ts===1?C.delete(ct):C.set(ct,Ts-1)),Ve)});I=d(f.currentTime+de/f.sampleRate,f.sampleRate,()=>X.process(ie,Q,U));for(let Ve=0,ct=0;Ve<_.numberOfOutputs;Ve+=1){for(let qt=0;qt<y[Ve];qt+=1)xr(J,Q[Ve],qt,ct+qt,de);ct+=y[Ve]}}catch(ie){I=!1,B.dispatchEvent(new ErrorEvent("processorerror",{colno:ie.colno,filename:ie.filename,lineno:ie.lineno,message:ie.message}))}if(!I){for(let ie=0;ie<_.numberOfInputs;ie+=1){T[ie].disconnect(j[ie]);for(let me=0;me<_.channelCount;me+=1)j[de].disconnect(N,me,ie*_.channelCount+me)}if(m.parameterDescriptors!==void 0){const ie=m.parameterDescriptors.length;for(let me=0;me<ie;me+=1){const Ve=v[me];Ve.disconnect(N,0,x+me),Ve.stop()}}N.disconnect(O),O.onaudioprocess=null,W?P():et();break}}}};let W=!1;const oe=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Me=()=>O.connect(oe).connect(f.destination),et=()=>{O.disconnect(oe),oe.disconnect()},qn=()=>{if(I){et(),_.numberOfOutputs>0&&O.connect(M);for(let G=0,J=0;G<_.numberOfOutputs;G+=1){const ve=D[G];for(let de=0;de<y[G];de+=1)M.connect(ve,J+de,de);J+=y[G]}}W=!0},js=()=>{I&&(Me(),P()),W=!1};return Me(),g(B,qn,js)},Sr=(n,e)=>{const t=n.createBiquadFilter();return Ee(t,e),xe(t,e,"Q"),xe(t,e,"detune"),xe(t,e,"frequency"),xe(t,e,"gain"),ge(t,e,"type"),t},oh=(n,e)=>(t,s)=>{const a=t.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&e(t,a),Ee(a,s),a},ch=n=>{const e=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw De()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw De()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw De()}})},Vs=(n,e)=>{const t=n.createChannelSplitter(e.numberOfOutputs);return Ee(t,e),ch(t),t},lh=(n,e,t,s,a)=>(r,o)=>{if(r.createConstantSource===void 0)return t(r,o);const l=r.createConstantSource();return Ee(l,o),xe(l,o,"offset"),e(s,()=>s(r))||ji(l),e(a,()=>a(r))||Ti(l),n(r,l),l},_s=(n,e)=>(n.connect=e.connect.bind(e),n.disconnect=e.disconnect.bind(e),n),uh=(n,e,t,s)=>(a,{offset:r,...o})=>{const l=a.createBuffer(1,2,44100),c=e(a,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(a,{...o,gain:r}),d=l.getChannelData(0);d[0]=1,d[1]=1,c.buffer=l,c.loop=!0;const h={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(p){u.channelCount=p},get channelCountMode(){return u.channelCountMode},set channelCountMode(p){u.channelCountMode=p},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(p){u.channelInterpretation=p},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return c.onended},set onended(p){c.onended=p},addEventListener(...p){return c.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return c.dispatchEvent(p[0])},removeEventListener(...p){return c.removeEventListener(p[0],p[1],p[2])},start(p=0){c.start.call(c,p)},stop(p=0){c.stop.call(c,p)}},g=()=>c.connect(u),f=()=>c.disconnect(u);return n(a,c),s(_s(h,u),g,f)},dh=(n,e)=>(t,s)=>{const a=t.createConvolver();if(Ee(a,s),s.disableNormalization===a.normalize&&(a.normalize=!s.disableNormalization),ge(a,s,"buffer"),s.channelCount>2||(e(a,"channelCount",r=>()=>r.call(a),r=>o=>{if(o>2)throw n();return r.call(a,o)}),s.channelCountMode==="max"))throw n();return e(a,"channelCountMode",r=>()=>r.call(a),r=>o=>{if(o==="max")throw n();return r.call(a,o)}),a},jr=(n,e)=>{const t=n.createDelay(e.maxDelayTime);return Ee(t,e),xe(t,e,"delayTime"),t},hh=n=>(e,t)=>{const s=e.createDynamicsCompressor();if(Ee(s,t),t.channelCount>2||t.channelCountMode==="max")throw n();return xe(s,t,"attack"),xe(s,t,"knee"),xe(s,t,"ratio"),xe(s,t,"release"),xe(s,t,"threshold"),s},Ge=(n,e)=>{const t=n.createGain();return Ee(t,e),xe(t,e,"gain"),t},mh=n=>(e,t,s)=>{if(e.createIIRFilter===void 0)return n(e,t,s);const a=e.createIIRFilter(s.feedforward,s.feedback);return Ee(a,s),a};function ph(n,e){const t=e[0]*e[0]+e[1]*e[1];return[(n[0]*e[0]+n[1]*e[1])/t,(n[1]*e[0]-n[0]*e[1])/t]}function fh(n,e){return[n[0]*e[0]-n[1]*e[1],n[0]*e[1]+n[1]*e[0]]}function Ra(n,e){let t=[0,0];for(let s=n.length-1;s>=0;s-=1)t=fh(t,e),t[0]+=n[s];return t}const gh=(n,e,t,s)=>(a,r,{channelCount:o,channelCountMode:l,channelInterpretation:c,feedback:u,feedforward:d})=>{const h=Nr(r,a.sampleRate),g=u instanceof Float64Array?u:new Float64Array(u),f=d instanceof Float64Array?d:new Float64Array(d),p=g.length,m=f.length,_=Math.min(p,m);if(p===0||p>20)throw s();if(g[0]===0)throw e();if(m===0||m>20)throw s();if(f[0]===0)throw e();if(g[0]!==1){for(let v=0;v<m;v+=1)f[v]/=g[0];for(let v=1;v<p;v+=1)g[v]/=g[0]}const y=t(a,h,o,o);y.channelCount=o,y.channelCountMode=l,y.channelInterpretation=c;const x=32,S=[],A=[],b=[];for(let v=0;v<o;v+=1){S.push(0);const N=new Float32Array(x),E=new Float32Array(x);N.fill(0),E.fill(0),A.push(N),b.push(E)}y.onaudioprocess=v=>{const N=v.inputBuffer,E=v.outputBuffer,O=N.numberOfChannels;for(let M=0;M<O;M+=1){const D=N.getChannelData(M),k=E.getChannelData(M);S[M]=wr(g,p,f,m,_,A[M],b[M],S[M],x,D,k)}};const T=a.sampleRate/2;return _s({get bufferSize(){return h},get channelCount(){return y.channelCount},set channelCount(v){y.channelCount=v},get channelCountMode(){return y.channelCountMode},set channelCountMode(v){y.channelCountMode=v},get channelInterpretation(){return y.channelInterpretation},set channelInterpretation(v){y.channelInterpretation=v},get context(){return y.context},get inputs(){return[y]},get numberOfInputs(){return y.numberOfInputs},get numberOfOutputs(){return y.numberOfOutputs},addEventListener(...v){return y.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return y.dispatchEvent(v[0])},getFrequencyResponse(v,N,E){if(v.length!==N.length||N.length!==E.length)throw n();const O=v.length;for(let M=0;M<O;M+=1){const D=-Math.PI*(v[M]/T),k=[Math.cos(D),Math.sin(D)],L=Ra(f,k),V=Ra(g,k),R=ph(L,V);N[M]=Math.sqrt(R[0]*R[0]+R[1]*R[1]),E[M]=Math.atan2(R[1],R[0])}},removeEventListener(...v){return y.removeEventListener(v[0],v[1],v[2])}},y)},vh=(n,e)=>n.createMediaElementSource(e.mediaElement),yh=(n,e)=>{const t=n.createMediaStreamDestination();return Ee(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},_h=(n,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((r,o)=>r.id<o.id?-1:r.id>o.id?1:0);const s=t.slice(0,1),a=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(a,"mediaStream",{value:e}),a},bh=(n,e)=>(t,{mediaStreamTrack:s})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(s);const a=new MediaStream([s]),r=t.createMediaStreamSource(a);if(s.kind!=="audio")throw n();if(e(t))throw new TypeError;return r},xh=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,wh=(n,e,t,s,a,r)=>(o,l)=>{const c=o.createOscillator();return Ee(c,l),xe(c,l,"detune"),xe(c,l,"frequency"),l.periodicWave!==void 0?c.setPeriodicWave(l.periodicWave):ge(c,l,"type"),e(t,()=>t(o))||ji(c),e(s,()=>s(o))||r(c,o),e(a,()=>a(o))||Ti(c),n(o,c),c},Nh=n=>(e,t)=>{const s=e.createPanner();return s.orientationX===void 0?n(e,t):(Ee(s,t),xe(s,t,"orientationX"),xe(s,t,"orientationY"),xe(s,t,"orientationZ"),xe(s,t,"positionX"),xe(s,t,"positionY"),xe(s,t,"positionZ"),ge(s,t,"coneInnerAngle"),ge(s,t,"coneOuterAngle"),ge(s,t,"coneOuterGain"),ge(s,t,"distanceModel"),ge(s,t,"maxDistance"),ge(s,t,"panningModel"),ge(s,t,"refDistance"),ge(s,t,"rolloffFactor"),s)},Sh=(n,e,t,s,a,r,o,l,c,u)=>(d,{coneInnerAngle:h,coneOuterAngle:g,coneOuterGain:f,distanceModel:p,maxDistance:m,orientationX:_,orientationY:y,orientationZ:x,panningModel:S,positionX:A,positionY:b,positionZ:T,refDistance:j,rolloffFactor:v,...N})=>{const E=d.createPanner();if(N.channelCount>2||N.channelCountMode==="max")throw o();Ee(E,N);const O={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M=t(d,{...O,channelInterpretation:"speakers",numberOfInputs:6}),D=s(d,{...N,gain:1}),k=s(d,{...O,gain:1}),L=s(d,{...O,gain:0}),V=s(d,{...O,gain:0}),R=s(d,{...O,gain:0}),B=s(d,{...O,gain:0}),Y=s(d,{...O,gain:0}),H=a(d,256,6,1),X=r(d,{...O,curve:new Float32Array([1,1]),oversample:"none"});let ee=[_,y,x],$=[A,b,T];const Q=new Float32Array(1);H.onaudioprocess=({inputBuffer:C})=>{const W=[c(C,Q,0),c(C,Q,1),c(C,Q,2)];W.some((Me,et)=>Me!==ee[et])&&(E.setOrientation(...W),ee=W);const oe=[c(C,Q,3),c(C,Q,4),c(C,Q,5)];oe.some((Me,et)=>Me!==$[et])&&(E.setPosition(...oe),$=oe)},Object.defineProperty(L.gain,"defaultValue",{get:()=>0}),Object.defineProperty(V.gain,"defaultValue",{get:()=>0}),Object.defineProperty(R.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Y.gain,"defaultValue",{get:()=>0});const U={get bufferSize(){},get channelCount(){return E.channelCount},set channelCount(C){if(C>2)throw o();D.channelCount=C,E.channelCount=C},get channelCountMode(){return E.channelCountMode},set channelCountMode(C){if(C==="max")throw o();D.channelCountMode=C,E.channelCountMode=C},get channelInterpretation(){return E.channelInterpretation},set channelInterpretation(C){D.channelInterpretation=C,E.channelInterpretation=C},get coneInnerAngle(){return E.coneInnerAngle},set coneInnerAngle(C){E.coneInnerAngle=C},get coneOuterAngle(){return E.coneOuterAngle},set coneOuterAngle(C){E.coneOuterAngle=C},get coneOuterGain(){return E.coneOuterGain},set coneOuterGain(C){if(C<0||C>1)throw e();E.coneOuterGain=C},get context(){return E.context},get distanceModel(){return E.distanceModel},set distanceModel(C){E.distanceModel=C},get inputs(){return[D]},get maxDistance(){return E.maxDistance},set maxDistance(C){if(C<0)throw new RangeError;E.maxDistance=C},get numberOfInputs(){return E.numberOfInputs},get numberOfOutputs(){return E.numberOfOutputs},get orientationX(){return k.gain},get orientationY(){return L.gain},get orientationZ(){return V.gain},get panningModel(){return E.panningModel},set panningModel(C){E.panningModel=C},get positionX(){return R.gain},get positionY(){return B.gain},get positionZ(){return Y.gain},get refDistance(){return E.refDistance},set refDistance(C){if(C<0)throw new RangeError;E.refDistance=C},get rolloffFactor(){return E.rolloffFactor},set rolloffFactor(C){if(C<0)throw new RangeError;E.rolloffFactor=C},addEventListener(...C){return D.addEventListener(C[0],C[1],C[2])},dispatchEvent(...C){return D.dispatchEvent(C[0])},removeEventListener(...C){return D.removeEventListener(C[0],C[1],C[2])}};h!==U.coneInnerAngle&&(U.coneInnerAngle=h),g!==U.coneOuterAngle&&(U.coneOuterAngle=g),f!==U.coneOuterGain&&(U.coneOuterGain=f),p!==U.distanceModel&&(U.distanceModel=p),m!==U.maxDistance&&(U.maxDistance=m),_!==U.orientationX.value&&(U.orientationX.value=_),y!==U.orientationY.value&&(U.orientationY.value=y),x!==U.orientationZ.value&&(U.orientationZ.value=x),S!==U.panningModel&&(U.panningModel=S),A!==U.positionX.value&&(U.positionX.value=A),b!==U.positionY.value&&(U.positionY.value=b),T!==U.positionZ.value&&(U.positionZ.value=T),j!==U.refDistance&&(U.refDistance=j),v!==U.rolloffFactor&&(U.rolloffFactor=v),(ee[0]!==1||ee[1]!==0||ee[2]!==0)&&E.setOrientation(...ee),($[0]!==0||$[1]!==0||$[2]!==0)&&E.setPosition(...$);const I=()=>{D.connect(E),n(D,X,0,0),X.connect(k).connect(M,0,0),X.connect(L).connect(M,0,1),X.connect(V).connect(M,0,2),X.connect(R).connect(M,0,3),X.connect(B).connect(M,0,4),X.connect(Y).connect(M,0,5),M.connect(H).connect(d.destination)},P=()=>{D.disconnect(E),l(D,X,0,0),X.disconnect(k),k.disconnect(M),X.disconnect(L),L.disconnect(M),X.disconnect(V),V.disconnect(M),X.disconnect(R),R.disconnect(M),X.disconnect(B),B.disconnect(M),X.disconnect(Y),Y.disconnect(M),M.disconnect(H),H.disconnect(d.destination)};return u(_s(U,E),I,P)},jh=n=>(e,{disableNormalization:t,imag:s,real:a})=>{const r=s instanceof Float32Array?s:new Float32Array(s),o=a instanceof Float32Array?a:new Float32Array(a),l=e.createPeriodicWave(o,r,{disableNormalization:t});if(Array.from(s).length<2)throw n();return l},qs=(n,e,t,s)=>n.createScriptProcessor(e,t,s),Th=(n,e)=>(t,s)=>{const a=s.channelCountMode;if(a==="clamped-max")throw e();if(t.createStereoPanner===void 0)return n(t,s);const r=t.createStereoPanner();return Ee(r,s),xe(r,s,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>a,set:o=>{if(o!==a)throw e()}}),r},kh=(n,e,t,s,a,r)=>{const l=new Float32Array([1,1]),c=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},d={...u,oversample:"none"},h=(p,m,_,y)=>{const x=new Float32Array(16385),S=new Float32Array(16385);for(let N=0;N<16385;N+=1){const E=N/16384*c;x[N]=Math.cos(E),S[N]=Math.sin(E)}const A=t(p,{...u,gain:0}),b=s(p,{...d,curve:x}),T=s(p,{...d,curve:l}),j=t(p,{...u,gain:0}),v=s(p,{...d,curve:S});return{connectGraph(){m.connect(A),m.connect(T.inputs===void 0?T:T.inputs[0]),m.connect(j),T.connect(_),_.connect(b.inputs===void 0?b:b.inputs[0]),_.connect(v.inputs===void 0?v:v.inputs[0]),b.connect(A.gain),v.connect(j.gain),A.connect(y,0,0),j.connect(y,0,1)},disconnectGraph(){m.disconnect(A),m.disconnect(T.inputs===void 0?T:T.inputs[0]),m.disconnect(j),T.disconnect(_),_.disconnect(b.inputs===void 0?b:b.inputs[0]),_.disconnect(v.inputs===void 0?v:v.inputs[0]),b.disconnect(A.gain),v.disconnect(j.gain),A.disconnect(y,0,0),j.disconnect(y,0,1)}}},g=(p,m,_,y)=>{const x=new Float32Array(16385),S=new Float32Array(16385),A=new Float32Array(16385),b=new Float32Array(16385),T=Math.floor(16385/2);for(let R=0;R<16385;R+=1)if(R>T){const B=(R-T)/(16384-T)*c;x[R]=Math.cos(B),S[R]=Math.sin(B),A[R]=0,b[R]=1}else{const B=R/(16384-T)*c;x[R]=1,S[R]=0,A[R]=Math.cos(B),b[R]=Math.sin(B)}const j=e(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),v=t(p,{...u,gain:0}),N=s(p,{...d,curve:x}),E=t(p,{...u,gain:0}),O=s(p,{...d,curve:S}),M=s(p,{...d,curve:l}),D=t(p,{...u,gain:0}),k=s(p,{...d,curve:A}),L=t(p,{...u,gain:0}),V=s(p,{...d,curve:b});return{connectGraph(){m.connect(j),m.connect(M.inputs===void 0?M:M.inputs[0]),j.connect(v,0),j.connect(E,0),j.connect(D,1),j.connect(L,1),M.connect(_),_.connect(N.inputs===void 0?N:N.inputs[0]),_.connect(O.inputs===void 0?O:O.inputs[0]),_.connect(k.inputs===void 0?k:k.inputs[0]),_.connect(V.inputs===void 0?V:V.inputs[0]),N.connect(v.gain),O.connect(E.gain),k.connect(D.gain),V.connect(L.gain),v.connect(y,0,0),D.connect(y,0,0),E.connect(y,0,1),L.connect(y,0,1)},disconnectGraph(){m.disconnect(j),m.disconnect(M.inputs===void 0?M:M.inputs[0]),j.disconnect(v,0),j.disconnect(E,0),j.disconnect(D,1),j.disconnect(L,1),M.disconnect(_),_.disconnect(N.inputs===void 0?N:N.inputs[0]),_.disconnect(O.inputs===void 0?O:O.inputs[0]),_.disconnect(k.inputs===void 0?k:k.inputs[0]),_.disconnect(V.inputs===void 0?V:V.inputs[0]),N.disconnect(v.gain),O.disconnect(E.gain),k.disconnect(D.gain),V.disconnect(L.gain),v.disconnect(y,0,0),D.disconnect(y,0,0),E.disconnect(y,0,1),L.disconnect(y,0,1)}}},f=(p,m,_,y,x)=>{if(m===1)return h(p,_,y,x);if(m===2)return g(p,_,y,x);throw a()};return(p,{channelCount:m,channelCountMode:_,pan:y,...x})=>{if(_==="max")throw a();const S=n(p,{...x,channelCount:1,channelCountMode:_,numberOfInputs:2}),A=t(p,{...x,channelCount:m,channelCountMode:_,gain:1}),b=t(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:y});let{connectGraph:T,disconnectGraph:j}=f(p,m,A,b,S);Object.defineProperty(b.gain,"defaultValue",{get:()=>0}),Object.defineProperty(b.gain,"maxValue",{get:()=>1}),Object.defineProperty(b.gain,"minValue",{get:()=>-1});const v={get bufferSize(){},get channelCount(){return A.channelCount},set channelCount(M){A.channelCount!==M&&(N&&j(),{connectGraph:T,disconnectGraph:j}=f(p,M,A,b,S),N&&T()),A.channelCount=M},get channelCountMode(){return A.channelCountMode},set channelCountMode(M){if(M==="clamped-max"||M==="max")throw a();A.channelCountMode=M},get channelInterpretation(){return A.channelInterpretation},set channelInterpretation(M){A.channelInterpretation=M},get context(){return A.context},get inputs(){return[A]},get numberOfInputs(){return A.numberOfInputs},get numberOfOutputs(){return A.numberOfOutputs},get pan(){return b.gain},addEventListener(...M){return A.addEventListener(M[0],M[1],M[2])},dispatchEvent(...M){return A.dispatchEvent(M[0])},removeEventListener(...M){return A.removeEventListener(M[0],M[1],M[2])}};let N=!1;const E=()=>{T(),N=!0},O=()=>{j(),N=!1};return r(_s(v,S),E,O)}},Ch=(n,e,t,s,a,r,o)=>(l,c)=>{const u=l.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&l.createGain().gain.automationRate===void 0)return t(l,c);Ee(u,c);const d=c.curve===null||c.curve instanceof Float32Array?c.curve:new Float32Array(c.curve);if(d!==null&&d.length<2)throw e();ge(u,{curve:d},"curve"),ge(u,c,"oversample");let h=null,g=!1;return o(u,"curve",m=>()=>m.call(u),m=>_=>(m.call(u,_),g&&(s(_)&&h===null?h=n(l,u):!s(_)&&h!==null&&(h(),h=null)),_)),a(u,()=>{g=!0,s(u.curve)&&(h=n(l,u))},()=>{g=!1,h!==null&&(h(),h=null)})},Ah=(n,e,t,s,a)=>(r,{curve:o,oversample:l,...c})=>{const u=r.createWaveShaper(),d=r.createWaveShaper();Ee(u,c),Ee(d,c);const h=t(r,{...c,gain:1}),g=t(r,{...c,gain:-1}),f=t(r,{...c,gain:1}),p=t(r,{...c,gain:-1});let m=null,_=!1,y=null;const x={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(b){h.channelCount=b,g.channelCount=b,u.channelCount=b,f.channelCount=b,d.channelCount=b,p.channelCount=b},get channelCountMode(){return u.channelCountMode},set channelCountMode(b){h.channelCountMode=b,g.channelCountMode=b,u.channelCountMode=b,f.channelCountMode=b,d.channelCountMode=b,p.channelCountMode=b},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(b){h.channelInterpretation=b,g.channelInterpretation=b,u.channelInterpretation=b,f.channelInterpretation=b,d.channelInterpretation=b,p.channelInterpretation=b},get context(){return u.context},get curve(){return y},set curve(b){if(b!==null&&b.length<2)throw e();if(b===null)u.curve=b,d.curve=b;else{const T=b.length,j=new Float32Array(T+2-T%2),v=new Float32Array(T+2-T%2);j[0]=b[0],v[0]=-b[T-1];const N=Math.ceil((T+1)/2),E=(T+1)/2-1;for(let O=1;O<N;O+=1){const M=O/N*E,D=Math.floor(M),k=Math.ceil(M);j[O]=D===k?b[D]:(1-(M-D))*b[D]+(1-(k-M))*b[k],v[O]=D===k?-b[T-1-D]:-((1-(M-D))*b[T-1-D])-(1-(k-M))*b[T-1-k]}j[N]=T%2===1?b[N-1]:(b[N-2]+b[N-1])/2,u.curve=j,d.curve=v}y=b,_&&(s(y)&&m===null?m=n(r,h):m!==null&&(m(),m=null))},get inputs(){return[h]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(b){u.oversample=b,d.oversample=b},addEventListener(...b){return h.addEventListener(b[0],b[1],b[2])},dispatchEvent(...b){return h.dispatchEvent(b[0])},removeEventListener(...b){return h.removeEventListener(b[0],b[1],b[2])}};o!==null&&(x.curve=o instanceof Float32Array?o:new Float32Array(o)),l!==x.oversample&&(x.oversample=l);const S=()=>{h.connect(u).connect(f),h.connect(g).connect(d).connect(p).connect(f),_=!0,s(y)&&(m=n(r,h))},A=()=>{h.disconnect(u),u.disconnect(f),h.disconnect(g),g.disconnect(d),d.disconnect(p),p.disconnect(f),_=!1,m!==null&&(m(),m=null)};return a(_s(x,f),S,A)},Be=()=>new DOMException("","NotSupportedError"),Eh={numberOfChannels:1},Mh=(n,e,t,s,a)=>class extends n{constructor(o,l,c){let u;if(typeof o=="number"&&l!==void 0&&c!==void 0)u={length:l,numberOfChannels:o,sampleRate:c};else if(typeof o=="object")u=o;else throw new Error("The given parameters are not valid.");const{length:d,numberOfChannels:h,sampleRate:g}={...Eh,...u},f=s(h,d,g);e(Ms,()=>Ms(f))||f.addEventListener("statechange",(()=>{let p=0;const m=_=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",m),_.stopImmediatePropagation(),this._waitForThePromiseToSettle(_)):p+=1)};return m})()),super(f,h),this._length=d,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",a(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,gr(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},Ih={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Dh=(n,e,t,s,a,r,o)=>class extends n{constructor(c,u){const d=a(c),h={...Ih,...u},g=t(d,h),f=r(d),p=f?s():null,m=c.sampleRate/2;super(c,!1,g,p),this._detune=e(this,f,g.detune,153600,-153600),this._frequency=e(this,f,g.frequency,m,-m),this._nativeOscillatorNode=g,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&h.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=h.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeOscillatorNode.onended=u;const d=this._nativeOscillatorNode.onended;this._onended=d!==null&&d===u?c:d}get type(){return this._nativeOscillatorNode.type}set type(c){this._nativeOscillatorNode.type=c,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(c){this._nativeOscillatorNode.setPeriodicWave(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=c)}start(c=0){if(this._nativeOscillatorNode.start(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=c),this.context.state!=="closed"){us(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),bt(this)&&Ps(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(c=0){this._nativeOscillatorNode.stop(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=c)}},Oh=(n,e,t,s,a)=>()=>{const r=new WeakMap;let o=null,l=null,c=null;const u=async(d,h)=>{let g=t(d);const f=Le(g,h);if(!f){const p={channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,detune:g.detune.value,frequency:g.frequency.value,periodicWave:o===null?void 0:o,type:g.type};g=e(h,p),l!==null&&g.start(l),c!==null&&g.stop(c)}return r.set(h,g),f?(await n(h,d.detune,g.detune),await n(h,d.frequency,g.frequency)):(await s(h,d.detune,g.detune),await s(h,d.frequency,g.frequency)),await a(d,h,g),g};return{set periodicWave(d){o=d},set start(d){l=d},set stop(d){c=d},render(d,h){const g=r.get(h);return g!==void 0?Promise.resolve(g):u(d,h)}}},Rh={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Ph=(n,e,t,s,a,r,o)=>class extends n{constructor(c,u){const d=a(c),h={...Rh,...u},g=t(d,h),f=r(d),p=f?s():null;super(c,!1,g,p),this._nativePannerNode=g,this._orientationX=e(this,f,g.orientationX,qe,Ue),this._orientationY=e(this,f,g.orientationY,qe,Ue),this._orientationZ=e(this,f,g.orientationZ,qe,Ue),this._positionX=e(this,f,g.positionX,qe,Ue),this._positionY=e(this,f,g.positionY,qe,Ue),this._positionZ=e(this,f,g.positionZ,qe,Ue),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(c){this._nativePannerNode.coneInnerAngle=c}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(c){this._nativePannerNode.coneOuterAngle=c}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(c){this._nativePannerNode.coneOuterGain=c}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(c){this._nativePannerNode.distanceModel=c}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(c){this._nativePannerNode.maxDistance=c}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(c){this._nativePannerNode.panningModel=c}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(c){this._nativePannerNode.refDistance=c}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(c){this._nativePannerNode.rolloffFactor=c}},Fh=(n,e,t,s,a,r,o,l,c,u)=>()=>{const d=new WeakMap;let h=null;const g=async(f,p)=>{let m=null,_=r(f);const y={channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation},x={...y,coneInnerAngle:_.coneInnerAngle,coneOuterAngle:_.coneOuterAngle,coneOuterGain:_.coneOuterGain,distanceModel:_.distanceModel,maxDistance:_.maxDistance,panningModel:_.panningModel,refDistance:_.refDistance,rolloffFactor:_.rolloffFactor},S=Le(_,p);if("bufferSize"in _)m=s(p,{...y,gain:1});else if(!S){const A={...x,orientationX:_.orientationX.value,orientationY:_.orientationY.value,orientationZ:_.orientationZ.value,positionX:_.positionX.value,positionY:_.positionY.value,positionZ:_.positionZ.value};_=a(p,A)}if(d.set(p,m===null?_:m),m!==null){if(h===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const O=new o(6,f.context.length,p.sampleRate),M=e(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});M.connect(O.destination),h=(async()=>{const D=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(k,L)=>{const V=t(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L===0?1:0});return await l(O,k,V.offset),V}));for(let k=0;k<6;k+=1)D[k].connect(M,0,k),D[k].start(0);return u(O)})()}const A=await h,b=s(p,{...y,gain:1});await c(f,p,b);const T=[];for(let O=0;O<A.numberOfChannels;O+=1)T.push(A.getChannelData(O));let j=[T[0][0],T[1][0],T[2][0]],v=[T[3][0],T[4][0],T[5][0]],N=s(p,{...y,gain:1}),E=a(p,{...x,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]});b.connect(N).connect(E.inputs[0]),E.connect(m);for(let O=128;O<A.length;O+=128){const M=[T[0][O],T[1][O],T[2][O]],D=[T[3][O],T[4][O],T[5][O]];if(M.some((k,L)=>k!==j[L])||D.some((k,L)=>k!==v[L])){j=M,v=D;const k=O/p.sampleRate;N.gain.setValueAtTime(0,k),N=s(p,{...y,gain:0}),E=a(p,{...x,orientationX:j[0],orientationY:j[1],orientationZ:j[2],positionX:v[0],positionY:v[1],positionZ:v[2]}),N.gain.setValueAtTime(1,k),b.connect(N).connect(E.inputs[0]),E.connect(m)}}return m}return S?(await n(p,f.orientationX,_.orientationX),await n(p,f.orientationY,_.orientationY),await n(p,f.orientationZ,_.orientationZ),await n(p,f.positionX,_.positionX),await n(p,f.positionY,_.positionY),await n(p,f.positionZ,_.positionZ)):(await l(p,f.orientationX,_.orientationX),await l(p,f.orientationY,_.orientationY),await l(p,f.orientationZ,_.orientationZ),await l(p,f.positionX,_.positionX),await l(p,f.positionY,_.positionY),await l(p,f.positionZ,_.positionZ)),ys(_)?await c(f,p,_.inputs[0]):await c(f,p,_),_};return{render(f,p){const m=d.get(p);return m!==void 0?Promise.resolve(m):g(f,p)}}},Lh={disableNormalization:!1},Vh=(n,e,t,s)=>class Tr{constructor(r,o){const l=e(r),c=s({...Lh,...o}),u=n(l,c);return t.add(u),u}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===Tr.prototype||t.has(r)}},qh=(n,e)=>(t,s,a)=>(n(s).replay(a),e(s,t,a)),Wh=(n,e,t)=>async(s,a,r)=>{const o=n(s);await Promise.all(o.activeInputs.map((l,c)=>Array.from(l).map(async([u,d])=>{const g=await e(u).render(u,a),f=s.context.destination;!t(u)&&(s!==f||!t(s))&&g.connect(r,d,c)})).reduce((l,c)=>[...l,...c],[]))},Bh=(n,e,t)=>async(s,a,r)=>{const o=e(s);await Promise.all(Array.from(o.activeInputs).map(async([l,c])=>{const d=await n(l).render(l,a);t(l)||d.connect(r,c)}))},Uh=(n,e,t,s)=>a=>n(Ms,()=>Ms(a))?Promise.resolve(n(s,s)).then(r=>{if(!r){const o=t(a,512,0,1);a.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>a.currentTime,o.connect(a.destination)}return a.startRendering()}):new Promise(r=>{const o=e(a,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});a.oncomplete=l=>{o.disconnect(),r(l.renderedBuffer)},o.connect(a.destination),a.startRendering()}),$h=n=>(e,t)=>{n.set(e,t)},Gh=n=>(e,t)=>n.set(e,t),zh=(n,e,t,s,a,r,o,l)=>(c,u)=>t(c).render(c,u).then(()=>Promise.all(Array.from(s(u)).map(d=>t(d).render(d,u)))).then(()=>a(u)).then(d=>(typeof d.copyFromChannel!="function"?(o(d),wi(d)):e(r,()=>r(d))||l(d),n.add(d),d)),Yh={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Hh=(n,e,t,s,a,r)=>class extends n{constructor(l,c){const u=a(l),d={...Yh,...c},h=t(u,d),g=r(u),f=g?s():null;super(l,!1,h,f),this._pan=e(this,g,h.pan)}get pan(){return this._pan}},Xh=(n,e,t,s,a)=>()=>{const r=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Le(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(c,h)}return r.set(c,u),d?await n(c,l.pan,u.pan):await s(c,l.pan,u.pan),ys(u)?await a(l,c,u.inputs[0]):await a(l,c,u),u};return{render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Jh=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},Zh=(n,e)=>async()=>{if(n===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new e(1,128,44100),a=URL.createObjectURL(t);let r=!1,o=!1;try{await s.audioWorklet.addModule(a);const l=new n(s,"a",{numberOfOutputs:0}),c=s.createOscillator();l.port.onmessage=()=>r=!0,l.onprocessorerror=()=>o=!0,c.connect(l),c.start(0),await s.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(a)}return r&&!o},Kh=(n,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(a=>{t.oncomplete=()=>{s.disconnect(),a(t.currentTime!==0)},t.startRendering()})},Qh=()=>new DOMException("","UnknownError"),em={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},tm=(n,e,t,s,a,r,o)=>class extends n{constructor(c,u){const d=a(c),h={...em,...u},g=t(d,h),p=r(d)?s():null;super(c,!0,g,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=g,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(c){if(c===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(c.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=c}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(c){this._nativeWaveShaperNode.oversample=c}},sm=(n,e,t)=>()=>{const s=new WeakMap,a=async(r,o)=>{let l=e(r);if(!Le(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,curve:l.curve,oversample:l.oversample};l=n(o,u)}return s.set(o,l),ys(l)?await t(r,o,l.inputs[0]):await t(r,o,l),l};return{render(r,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):a(r,o)}}},nm=()=>typeof window>"u"?null:window,im=(n,e)=>t=>{t.copyFromChannel=(s,a,r=0)=>{const o=n(r),l=n(a);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=s.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)s[h]=u[h+o]},t.copyToChannel=(s,a,r=0)=>{const o=n(r),l=n(a);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=s.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)u[h+o]=s[h]}},am=n=>e=>{e.copyFromChannel=(t=>(s,a,r=0)=>{const o=n(r),l=n(a);if(o<e.length)return t.call(e,s,l,o)})(e.copyFromChannel),e.copyToChannel=(t=>(s,a,r=0)=>{const o=n(r),l=n(a);if(o<e.length)return t.call(e,s,l,o)})(e.copyToChannel)},rm=n=>(e,t)=>{const s=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=s),n(e,"buffer",a=>()=>{const r=a.call(e);return r===s?null:r},a=>r=>a.call(e,r===null?s:r))},om=(n,e)=>(t,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const a=t.createBufferSource();e(s,()=>{const l=s.numberOfInputs;for(let c=0;c<l;c+=1)a.connect(s,0,c)},()=>a.disconnect(s))},kr=(n,e,t)=>n.copyFromChannel===void 0?n.getChannelData(t)[0]:(n.copyFromChannel(e,t),e[0]),Cr=n=>{if(n===null)return!1;const e=n.length;return e%2!==0?n[Math.floor(e/2)]!==0:n[e/2-1]+n[e/2]!==0},Ws=(n,e,t,s)=>{let a=n;for(;!a.hasOwnProperty(e);)a=Object.getPrototypeOf(a);const{get:r,set:o}=Object.getOwnPropertyDescriptor(a,e);Object.defineProperty(n,e,{get:t(r),set:s(o)})},cm=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),lm=n=>({...n,channelCount:n.numberOfOutputs}),um=n=>{const{imag:e,real:t}=n;return e===void 0?t===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(t,()=>0),real:t}:t===void 0?{...n,imag:e,real:Array.from(e,()=>0)}:{...n,imag:e,real:t}},Ar=(n,e,t)=>{try{n.setValueAtTime(e,t)}catch(s){if(s.code!==9)throw s;Ar(n,e,t+1e-7)}},dm=n=>{const e=n.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},hm=n=>{const e=n.createBufferSource(),t=n.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},mm=n=>{const e=n.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},ki=n=>{const e=n.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},Er=n=>{const e=n.createBuffer(1,1,44100),t=n.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Ci=n=>{const e=n.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},pm=n=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(n)}finally{e.close(),t.close()}},fm=n=>{n.start=(e=>(t=0,s=0,a)=>{const r=n.buffer,o=r===null?s:Math.min(r.duration,s);r!==null&&o>r.duration-.5/n.context.sampleRate?e.call(n,t,0,0):e.call(n,t,o,a)})(n.start)},Mr=(n,e)=>{const t=e.createGain();n.connect(t);const s=(a=>()=>{a.call(n,t),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),_s(n,t),n.stop=(a=>{let r=!1;return(o=0)=>{if(r)try{a.call(n,o)}catch{t.gain.setValueAtTime(0,o)}else a.call(n,o),r=!0}})(n.stop)},bs=(n,e)=>t=>{const s={value:n};return Object.defineProperties(t,{currentTarget:s,target:s}),typeof e=="function"?e.call(n,t):e.handleEvent.call(n,t)},gm=Pl(Zt),vm=Bl(Zt),ym=ed(xn),Ir=new WeakMap,_m=yd(Ir),at=Eu(new Map,new WeakMap),ht=nm(),Dr=Hd(at,ft),Ai=vd(We),Re=Wh(We,Ai,Gt),bm=Yl(Dr,he,Re),ue=xd(bn),Nt=xh(ht),ce=Ld(Nt),Or=new WeakMap,Rr=ud(bs),Bs=Kd(ht),Ei=Od(Bs),Mi=Rd(ht),Pr=Pd(ht),Is=eh(ht),Se=yu(Fl(lr),Wl(gm,vm,un,ym,dn,We,_m,Rs,he,Zt,bt,Gt,en),at,Ad(ci,dn,We,he,Es,bt),ft,wn,Be,Ju(un,ci,We,he,Es,ue,bt,ce),nd(Or,We,it),Rr,ue,Ei,Mi,Pr,ce,Is),xm=zl(Se,bm,ft,Dr,ue,ce),Ii=new WeakSet,Pa=Xd(ht),Fr=Uu(new Uint32Array(1)),Di=im(Fr,ft),Oi=am(Fr),Lr=Xl(Ii,at,Be,Pa,Nt,Jh(Pa),Di,Oi),Nn=Ul(Ge),Vr=Bh(Ai,Fs,Gt),gt=Fu(Vr),xs=Zd(Nn,at,dm,hm,mm,ki,Er,Ci,fm,rm(Ws),Mr),vt=qh(_d(Fs),Vr),wm=Kl(gt,xs,he,vt,Re),rt=_u(Ll(ur),Or,xi,bu,El,Ml,Il,Dl,Ol,ai,or,Bs,Ar),Nm=Zl(Se,wm,rt,De,xs,ue,ce,bs),Sm=ou(Se,cu,ft,De,Qd(Ge,Ws),ue,ce,Re),jm=Au(gt,Sr,he,vt,Re),Kt=Gh(Ir),Tm=Cu(Se,rt,jm,wn,Sr,ue,ce,Kt),Ft=zd(Zt,Mi),km=om(De,Ft),Lt=oh(Bs,km),Cm=Du(Lt,he,Re),Am=Iu(Se,Cm,Lt,ue,ce),Em=Pu(Vs,he,Re),Mm=Ru(Se,Em,Vs,ue,ce,lm),Im=uh(Nn,xs,Ge,Ft),ws=lh(Nn,at,Im,ki,Ci),Dm=Bu(gt,ws,he,vt,Re),Om=Wu(Se,rt,Dm,ws,ue,ce,bs),qr=dh(Be,Ws),Rm=zu(qr,he,Re),Pm=Gu(Se,Rm,qr,ue,ce,Kt),Fm=Qu(gt,jr,he,vt,Re),Lm=Ku(Se,rt,Fm,jr,ue,ce,Kt),Wr=hh(Be),Vm=od(gt,Wr,he,vt,Re),qm=rd(Se,rt,Vm,Wr,Be,ue,ce,Kt),Wm=fd(gt,Ge,he,vt,Re),Bm=pd(Se,rt,Wm,Ge,ue,ce),Um=gh(wn,De,qs,Be),Sn=Uh(at,Ge,qs,Kh(Ge,Nt)),$m=Cd(xs,he,Nt,Re,Sn),Gm=mh(Um),zm=Td(Se,Gm,$m,ue,ce,Kt),Ym=lu(rt,Lt,ws,qs,Be,kr,ce,Ws),Br=new WeakMap,Hm=Gd(Sm,Ym,Rr,ce,Br,bs),Ur=wh(Nn,at,ki,Er,Ci,Mr),Xm=Oh(gt,Ur,he,vt,Re),Jm=Dh(Se,rt,Ur,Xm,ue,ce,bs),$r=Vu(xs),Zm=Ah($r,De,Ge,Cr,Ft),jn=Ch($r,De,Zm,Cr,Ft,Bs,Ws),Km=Sh(un,De,Lt,Ge,qs,jn,Be,dn,kr,Ft),Gr=Nh(Km),Qm=Fh(gt,Lt,ws,Ge,Gr,he,Nt,vt,Re,Sn),ep=Ph(Se,rt,Gr,Qm,ue,ce,Kt),tp=jh(ft),sp=Vh(tp,ue,new WeakSet,um),np=kh(Lt,Vs,Ge,jn,Be,Ft),zr=Th(np,Be),ip=Xh(gt,zr,he,vt,Re),ap=Hh(Se,rt,zr,ip,ue,ce),rp=sm(jn,he,Re),op=tm(Se,De,jn,rp,ue,ce,Kt),Yr=Vd(ht),Ri=dd(ht),Hr=new WeakMap,cp=wd(Hr,Nt),lp=Yr?ql(at,Be,ld(ht),Ri,hd(Rl),ue,cp,ce,Is,new WeakMap,new WeakMap,Zh(Is,Nt),ht):void 0,up=Fd(Ei,ce),dp=Xu(Ii,at,Hu,cd,new WeakSet,ue,up,cn,Ms,Di,Oi),Xr=Tu(lp,xm,Lr,Nm,Tm,Am,Mm,Om,Pm,dp,Lm,qm,Bm,zm,Hm,Jm,ep,sp,ap,op),hp=qd(Se,vh,ue,ce),mp=Bd(Se,yh,ue,ce),pp=Ud(Se,_h,ue,ce),fp=bh(De,ce),gp=$d(Se,fp,ue),vp=ru(Xr,De,Be,Qh,hp,mp,pp,gp,Bs),Pi=Nd(Br),yp=$l(Pi),Jr=Lu(ft),_p=td(Pi),Zr=id(ft),Kr=new WeakMap,bp=gd(Kr,it),xp=rh(Jr,ft,De,Lt,Vs,ws,Ge,qs,Be,Zr,Ri,bp,Ft),wp=sh(De,xp,Ge,Be,Ft),Np=ju(gt,Jr,xs,Lt,Vs,ws,Ge,_p,Zr,Ri,he,Is,Nt,vt,Re,Sn),Sp=bd(Hr),jp=$h(Kr),Fa=Yr?wu(yp,Se,rt,Np,wp,We,Sp,ue,ce,Is,cm,jp,pm,bs):void 0,Tp=Yu(Be,Nt),kp=zh(Ii,at,Ai,Pi,Sn,cn,Di,Oi),Cp=Mh(Xr,at,De,Tp,kp),Ap=Ed(bn,Ei),Ep=Md(bi,Mi),Mp=Id(xi,Pr),Ip=Dd(bn,ce);function Je(n){return n===void 0}function se(n){return n!==void 0}function Dp(n){return typeof n=="function"}function mt(n){return typeof n=="number"}function At(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function Qr(n){return typeof n=="boolean"}function $e(n){return Array.isArray(n)}function wt(n){return typeof n=="string"}function Zs(n){return wt(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function K(n,e){if(!n)throw new Error(e)}function Mt(n,e,t=1/0){if(!(e<=n&&n<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${n}`)}function eo(n){!n.isOffline&&n.state!=="running"&&Tn('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let to=!1,La=!1;function Va(n){to=n}function Op(n){Je(n)&&to&&!La&&(La=!0,Tn("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let so=console;function Rp(...n){so.log(...n)}function Tn(...n){so.warn(...n)}function Pp(n){return new vp(n)}function Fp(n,e,t){return new Cp(n,e,t)}const Ye=typeof self=="object"?self:null,Lp=Ye&&(Ye.hasOwnProperty("AudioContext")||Ye.hasOwnProperty("webkitAudioContext"));function Vp(n,e,t){return K(se(Fa),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof Ye?.BaseAudioContext?Ye?.AudioWorkletNode:Fa)(n,e,t)}function ot(n,e,t,s){var a=arguments.length,r=a<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,e,t,s);else for(var l=n.length-1;l>=0;l--)(o=n[l])&&(r=(a<3?o(r):a>3?o(e,t,r):o(e,t))||r);return a>3&&r&&Object.defineProperty(e,t,r),r}function ke(n,e,t,s){function a(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function l(d){try{u(s.next(d))}catch(h){o(h)}}function c(d){try{u(s.throw(d))}catch(h){o(h)}}function u(d){d.done?r(d.value):a(d.value).then(l,c)}u((s=s.apply(n,e||[])).next())})}class qp{constructor(e,t,s,a){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(a||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),s=new Worker(t);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function zt(n){return Mp(n)}function Et(n){return Ep(n)}function tn(n){return Ip(n)}function ns(n){return Ap(n)}function Wp(n){return n instanceof Lr}function Bp(n,e){return n==="value"||zt(e)||Et(e)||Wp(e)}function Ut(n,...e){if(!e.length)return n;const t=e.shift();if(At(n)&&At(t))for(const s in t)Bp(s,t[s])?n[s]=t[s]:At(t[s])?(n[s]||Object.assign(n,{[s]:{}}),Ut(n[s],t[s])):Object.assign(n,{[s]:t[s]});return Ut(n,...e)}function Up(n,e){return n.length===e.length&&n.every((t,s)=>e[s]===t)}function te(n,e,t=[],s){const a={},r=Array.from(e);if(At(r[0])&&s&&!Reflect.has(r[0],s)&&(Object.keys(r[0]).some(l=>Reflect.has(n,l))||(Ut(a,{[s]:r[0]}),t.splice(t.indexOf(s),1),r.shift())),r.length===1&&At(r[0]))Ut(a,r[0]);else for(let o=0;o<t.length;o++)se(r[o])&&(a[t[o]]=r[o]);return Ut(n,a)}function $p(n){return n.constructor.getDefaults()}function dt(n,e){return Je(n)?e:n}function mi(n,e){return e.forEach(t=>{Reflect.has(n,t)&&delete n[t]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class St{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||Ye&&this.toString()===Ye.TONE_DEBUG_CLASS)&&Rp(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}St.version=rr;const Fi=1e-6;function ds(n,e){return n>e+Fi}function pi(n,e){return ds(n,e)||st(n,e)}function fn(n,e){return n+Fi<e}function st(n,e){return Math.abs(n-e)<Fi}function Gp(n,e,t){return Math.max(Math.min(n,t),e)}class Qe extends St{constructor(){super(),this.name="Timeline",this._timeline=[];const e=te(Qe.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(K(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];K(pi(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const s=this._search(e,t);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const s=this._search(e,t);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const s=this._search(e);return s-1>=0?this._timeline[s-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(st(this._timeline[t].time,e)){for(let s=t;s>=0&&st(this._timeline[s].time,e);s--)t=s;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&pi(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let s=0;const a=this._timeline.length;let r=a;if(a>0&&this._timeline[a-1][t]<=e)return a-1;for(;s<r;){let o=Math.floor(s+(r-s)/2);const l=this._timeline[o],c=this._timeline[o+1];if(st(l[t],e)){for(let u=o;u<this._timeline.length;u++){const d=this._timeline[u];if(st(d[t],e))o=u;else break}return o}else{if(fn(l[t],e)&&ds(c[t],e))return o;ds(l[t],e)?r=o:s=o+1}}return-1}_iterate(e,t=0,s=this._timeline.length-1){this._timeline.slice(t,s+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const s=this._search(e);return s!==-1&&this._iterate(t,0,s),this}forEachAfter(e,t){const s=this._search(e);return this._iterate(t,s+1),this}forEachBetween(e,t,s){let a=this._search(e),r=this._search(t);return a!==-1&&r!==-1?(this._timeline[a].time!==e&&(a+=1),this._timeline[r].time===t&&(r-=1),this._iterate(s,a,r)):a===-1&&this._iterate(s,0,r),this}forEachFrom(e,t){let s=this._search(e);for(;s>=0&&this._timeline[s].time>=e;)s--;return this._iterate(t,s+1),this}forEachAtTime(e,t){const s=this._search(e);if(s!==-1&&st(this._timeline[s].time,e)){let a=s;for(let r=s;r>=0&&st(this._timeline[r].time,e);r--)a=r;this._iterate(r=>{t(r)},a,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const no=[];function kn(n){no.push(n)}function zp(n){no.forEach(e=>e(n))}const io=[];function Cn(n){io.push(n)}function Yp(n){io.forEach(e=>e(n))}class Us extends St{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(a=>{Je(this._events)&&(this._events={}),this._events.hasOwnProperty(a)||(this._events[a]=[]),this._events[a].push(t)}),this}once(e,t){const s=(...a)=>{t(...a),this.off(e,s)};return this.on(e,s),this}off(e,t){return e.split(/\W+/).forEach(a=>{if(Je(this._events)&&(this._events={}),this._events.hasOwnProperty(a))if(Je(t))this._events[a]=[];else{const r=this._events[a];for(let o=r.length-1;o>=0;o--)r[o]===t&&r.splice(o,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const s=this._events[e].slice(0);for(let a=0,r=s.length;a<r;a++)s[a].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const s=Object.getOwnPropertyDescriptor(Us.prototype,t);Object.defineProperty(e.prototype,t,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class ao extends Us{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class $s extends ao{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new Qe,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=te($s.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=Pp({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new qp(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(zp(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,s){return this._context.createBuffer(e,t,s)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,s){return this._context.createPeriodicWave(e,t,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return K(ns(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return K(ns(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return K(ns(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){K(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){K(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){K(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){K(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Vp(this.rawContext,e,t)}addAudioWorkletModule(e){return ke(this,void 0,void 0,function*(){K(se(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return ke(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return ns(this._context)?this._context.resume():Promise.resolve()}close(){return ke(this,void 0,void 0,function*(){ns(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&Yp(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),s=t.getChannelData(0);for(let r=0;r<s.length;r++)s[r]=e;const a=this._context.createBufferSource();return a.channelCount=1,a.channelCountMode="explicit",a.buffer=t,a.loop=!0,a.start(0),this._constants.set(e,a),a}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:s+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const s=++this._timeoutIds,a=()=>{const r=this.now();this._timeouts.add({callback:()=>{e(),a()},id:s,time:r+t})};return a(),s}}class Hp extends ao{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,s){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return ke(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function we(n,e){$e(e)?e.forEach(t=>we(n,t)):Object.defineProperty(n,e,{enumerable:!0,writable:!1})}function ro(n,e){$e(e)?e.forEach(t=>ro(n,t)):Object.defineProperty(n,e,{writable:!0})}const re=()=>{};class fe extends St{constructor(){super(),this.name="ToneAudioBuffer",this.onload=re;const e=te(fe.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,wt(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:re,onload:re,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:He().sampleRate}set(e){return e instanceof fe?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return ke(this,void 0,void 0,function*(){const t=fe.load(e).then(s=>{this.set(s),this.onload(this)});fe.downloads.push(t);try{yield t}finally{const s=fe.downloads.indexOf(t);fe.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=$e(e)&&e[0].length>0,s=t?e.length:1,a=t?e[0].length:e.length,r=He(),o=r.createBuffer(s,a,r.sampleRate),l=!t&&s===1?[e]:e;for(let c=0;c<s;c++)o.copyToChannel(l[c],c);return this._buffer=o,this}toMono(e){if(mt(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const s=this.numberOfChannels;for(let a=0;a<s;a++){const r=this.toArray(a);for(let o=0;o<r.length;o++)t[o]+=r[o]}t=t.map(a=>a/s),this.fromArray(t)}return this}toArray(e){if(mt(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let s=0;s<this.numberOfChannels;s++)t[s]=this.getChannelData(s);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){K(this.loaded,"Buffer is not loaded");const s=Math.floor(e*this.sampleRate),a=Math.floor(t*this.sampleRate);K(s<a,"The start time must be less than the end time");const r=a-s,o=He().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let l=0;l<this.numberOfChannels;l++)o.copyToChannel(this.getChannelData(l).subarray(s,a),l);return new fe(o)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new fe().fromArray(e)}static fromUrl(e){return ke(this,void 0,void 0,function*(){return yield new fe().load(e)})}static load(e){return ke(this,void 0,void 0,function*(){const t=fe.baseUrl===""||fe.baseUrl.endsWith("/")?fe.baseUrl:fe.baseUrl+"/",s=yield fetch(t+e);if(!s.ok)throw new Error(`could not load url: ${e}`);const a=yield s.arrayBuffer();return yield He().decodeAudioData(a)})}static supportsType(e){const t=e.split("."),s=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return ke(this,void 0,void 0,function*(){for(yield Promise.resolve();fe.downloads.length;)yield fe.downloads[0]})}}fe.baseUrl="";fe.downloads=[];class Li extends $s{constructor(){super({clockSource:"offline",context:tn(arguments[0])?arguments[0]:Fp(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:tn(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=tn(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return ke(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const s=Math.floor(this.sampleRate/128);e&&t%s===0&&(yield new Promise(a=>setTimeout(a,1)))}})}render(){return ke(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new fe(t)})}close(){return Promise.resolve()}}const oo=new Hp;let Wt=oo;function He(){return Wt===oo&&Lp&&Xp(new $s),Wt}function Xp(n,e=!1){e&&Wt.dispose(),ns(n)?Wt=new $s(n):tn(n)?Wt=new Li(n):Wt=n}function co(){return Wt.resume()}if(Ye&&!Ye.TONE_SILENCE_LOGGING){const e=` * Tone.js v${rr} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function Jp(n){return Math.pow(10,n/20)}function Zp(n){return 20*(Math.log(n)/Math.LN10)}function lo(n){return Math.pow(2,n/12)}let An=440;function Kp(){return An}function Qp(n){An=n}function Bt(n){return Math.round(uo(n))}function uo(n){return 69+12*Math.log2(n/An)}function ho(n){return An*Math.pow(2,(n-69)/12)}class Vi extends St{constructor(e,t,s){super(),this.defaultUnits="s",this._val=t,this._units=s,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const s=parseInt(e,10),a=t==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*a:this._beatsToUnits(4/s)*a},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,s)=>{let a=0;return e&&e!=="0"&&(a+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(a+=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(a+=this._beatsToUnits(parseFloat(s)/4)),a},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Vi&&this.fromType(this._val),Je(this._val))return this._noArg();if(wt(this._val)&&Je(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(At(this._val)){let e=0;for(const t in this._val)if(se(this._val[t])){const s=this._val[t],a=new this.constructor(this.context,t).valueOf()*s;e+=a}return e}if(se(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return wt(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class nt extends Vi{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new nt(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const s=new this.constructor(this.context,e).valueOf(),a=this.valueOf(),l=Math.round(a/s)*s-a;return a+l*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let r=1;r<9;r++){const o=Math.pow(2,r);t.push(o+"n."),t.push(o+"n"),t.push(o+"t")}t.push("0");let s=t[0],a=new nt(this.context,t[0]).toSeconds();return t.forEach(r=>{const o=new nt(this.context,r).toSeconds();Math.abs(o-e)<Math.abs(a-e)&&(s=r,a=o)}),s}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const s=Math.floor(t/this._getTimeSignature());let a=t%1*4;t=Math.floor(t)%this._getTimeSignature();const r=a.toString();return r.length>3&&(a=parseFloat(parseFloat(r).toFixed(3))),[s,t,a].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Bt(this.toFrequency())}_now(){return this.context.now()}}class Xe extends nt{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Kp()}static set A4(e){Qp(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:Xe.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const a=ef[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?a:Xe.mtof(a)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,s){let a=1;return e&&e!=="0"&&(a*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(a*=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(a*=this._beatsToUnits(parseFloat(s)/4)),a}}})}transpose(e){return new Xe(this.context,this.valueOf()*lo(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return Bt(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/Xe.A4);let s=Math.round(12*t)+57;const a=Math.floor(s/12);return a<0&&(s+=-12*a),tf[s%12]+a.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return ho(e)}static ftom(e){return Bt(e)}}const ef={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},tf=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class cs extends nt{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Pe extends St{constructor(){super();const e=te(Pe.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:He()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return Op(e),new nt(this.context,e).toSeconds()}toFrequency(e){return new Xe(this.context,e).toFrequency()}toTicks(e){return new cs(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(s=>{Je(e[s])&&delete t[s]}),t}get(){const e=$p(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const s=this[t];se(s)&&se(s.value)&&se(s.setValueAtTime)?e[t]=s.value:s instanceof Pe?e[t]=s._getPartialProperties(e[t]):$e(s)||mt(s)||wt(s)||Qr(s)?e[t]=s:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&se(this[t])&&(this[t]&&se(this[t].value)&&se(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Pe?this[t].set(e[t]):this[t]=e[t])}),this}}class Gs extends Qe{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,s){return Mt(t,0),this.add(Object.assign({},s,{state:e,time:t})),this}getLastState(e,t){const s=this._search(t);for(let a=s;a>=0;a--){const r=this._timeline[a];if(r.state===e)return r}}getNextState(e,t){const s=this._search(t);if(s!==-1)for(let a=s;a<this._timeline.length;a++){const r=this._timeline[a];if(r.state===e)return r}}}class ye extends Pe{constructor(){const e=te(ye.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,K(se(e.param)&&(zt(e.param)||e.param instanceof ye),"param must be an AudioParam");!zt(e.param);)e.param=e.param._param;this._swappable=se(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new Qe(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,se(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Pe.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return se(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return se(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return se(this.maxValue)&&se(this.minValue)&&Mt(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?Jp(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?Zp(e):e}setValueAtTime(e,t){const s=this.toSeconds(t),a=this._fromType(e);return K(isFinite(a)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(a),this.log(this.units,"setValueAtTime",e,s),this._events.add({time:s,type:"setValueAtTime",value:a}),this._param.setValueAtTime(a,s),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),s=this._events.getAfter(t),a=this._events.get(t);let r=this._initialValue;if(a===null)r=this._initialValue;else if(a.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const o=this._events.getBefore(a.time);let l;o===null?l=this._initialValue:l=o.value,a.type==="setTargetAtTime"&&(r=this._exponentialApproach(a.time,l,a.value,a.constant,t))}else if(s===null)r=a.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let o=a.value;if(a.type==="setTargetAtTime"){const l=this._events.getBefore(a.time);l===null?o=this._initialValue:o=l.value}s.type==="linearRampToValueAtTime"?r=this._linearInterpolate(a.time,o,s.time,s.value,t):r=this._exponentialInterpolate(a.time,o,s.time,s.value,t)}else r=a.value;return this._toType(r)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const s=this._fromType(e),a=this.toSeconds(t);return K(isFinite(s)&&isFinite(a),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this._events.add({time:a,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",e,a),this._param.linearRampToValueAtTime(s,a),this}exponentialRampToValueAtTime(e,t){let s=this._fromType(e);s=st(s,0)?this._minOutput:s,this._assertRange(s);const a=this.toSeconds(t);return K(isFinite(s)&&isFinite(a),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:a,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",e,a),this._param.exponentialRampToValueAtTime(s,a),this}exponentialRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(e,s+this.toSeconds(t)),this}linearRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(e,s+this.toSeconds(t)),this}targetRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(e,s,t),this}exponentialApproachValueAtTime(e,t,s){t=this.toSeconds(t),s=this.toSeconds(s);const a=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(e,t,a),this.cancelAndHoldAtTime(t+s*.9),this.linearRampToValueAtTime(e,t+s),this}setTargetAtTime(e,t,s){const a=this._fromType(e);K(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(t);return this._assertRange(a),K(isFinite(a)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:s,time:r,type:"setTargetAtTime",value:a}),this.log(this.units,"setTargetAtTime",e,r,s),this._param.setTargetAtTime(a,r,s),this}setValueCurveAtTime(e,t,s,a=1){s=this.toSeconds(s),t=this.toSeconds(t);const r=this._fromType(e[0])*a;this.setValueAtTime(this._toType(r),t);const o=s/(e.length-1);for(let l=1;l<e.length;l++){const c=this._fromType(e[l])*a;this.linearRampToValueAtTime(this._toType(c),t+l*o)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return K(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),s=this._fromType(this.getValueAtTime(t));K(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+s);const a=this._events.get(t),r=this._events.getAfter(t);return a&&st(a.time,t)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),t):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),t)),this._events.add({time:t,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,t),this}rampTo(e,t=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,s):this.linearRampTo(e,t,s),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const s=this._events.get(t);if(s&&s.type==="setTargetAtTime"){const a=this._events.getAfter(s.time),r=a?a.time:t+2,o=(r-t)/10;for(let l=t;l<r;l+=o)e.linearRampToValueAtTime(this.getValueAtTime(l),l)}return this._events.forEachAfter(this.context.currentTime,a=>{a.type==="cancelScheduledValues"?e.cancelScheduledValues(a.time):a.type==="setTargetAtTime"?e.setTargetAtTime(a.value,a.time,a.constant):e[a.type](a.value,a.time)}),this}setParam(e){K(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,s,a,r){return s+(t-s)*Math.exp(-(r-e)/a)}_linearInterpolate(e,t,s,a,r){return t+(a-t)*((r-e)/(s-e))}_exponentialInterpolate(e,t,s,a,r){return t*Math.pow(a/t,(r-e)/(s-e))}}class ne extends Pe{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return se(this.input)?zt(this.input)||this.input instanceof ye?1:this.input.numberOfInputs:0}get numberOfOutputs(){return se(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return se(e)&&(e instanceof ne||Et(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(s=>{s.channelCount=e.channelCount,s.channelCountMode=e.channelCountMode,s.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();K(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,s=0){return Ns(this,e,t,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Tn("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,s=0){return sf(this,e,t,s),this}chain(...e){return fi(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),se(this.input)&&(this.input instanceof ne?this.input.dispose():Et(this.input)&&this.input.disconnect()),se(this.output)&&(this.output instanceof ne?this.output.dispose():Et(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function fi(...n){const e=n.shift();n.reduce((t,s)=>(t instanceof ne?t.connect(s):Et(t)&&Ns(t,s),s),e)}function Ns(n,e,t=0,s=0){for(K(se(n),"Cannot connect from undefined node"),K(se(e),"Cannot connect to undefined node"),(e instanceof ne||Et(e))&&K(e.numberOfInputs>0,"Cannot connect to node with no inputs"),K(n.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof ne||e instanceof ye;)se(e.input)&&(e=e.input);for(;n instanceof ne;)se(n.output)&&(n=n.output);zt(e)?n.connect(e,t):n.connect(e,t,s)}function sf(n,e,t=0,s=0){if(se(e))for(;e instanceof ne;)e=e.input;for(;!Et(n);)se(n.output)&&(n=n.output);zt(e)?n.disconnect(e,t):Et(e)?n.disconnect(e,t,s):n.disconnect()}class Fe extends ne{constructor(){const e=te(Fe.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new ye({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),we(this,"gain")}static getDefaults(){return Object.assign(ne.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class hs extends ne{constructor(e){super(e),this.onended=re,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Fe({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const s=this.toSeconds(t);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(ne.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:re})}_startGain(e,t=1){K(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=e+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+s):this._gainNode.gain.exponentialApproachValueAtTime(t,e,s)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){K(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==re&&(this.onended(this),this.onended=re,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),K(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=re,this}}class qi extends hs{constructor(){const e=te(qi.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Ns(this._source,this._gainNode),this.offset=new ye({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(hs.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Oe extends ne{constructor(){const e=te(Oe.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new qi({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ne.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,s=0){return Wi(this,e,t,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,s){return this._param.exponentialRampTo(e,t,s),this}linearRampTo(e,t,s){return this._param.linearRampTo(e,t,s),this}targetRampTo(e,t,s){return this._param.targetRampTo(e,t,s),this}exponentialApproachValueAtTime(e,t,s){return this._param.exponentialApproachValueAtTime(e,t,s),this}setTargetAtTime(e,t,s){return this._param.setTargetAtTime(e,t,s),this}setValueCurveAtTime(e,t,s,a){return this._param.setValueCurveAtTime(e,t,s,a),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,s){return this._param.rampTo(e,t,s),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Wi(n,e,t,s){(e instanceof ye||zt(e)||e instanceof Oe&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof Oe&&(e.overridden=!0)),Ns(n,e,t,s)}class Bi extends ye{constructor(){const e=te(Bi.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new Qe(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(ye.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,s){t=this.toSeconds(t),this.setRampPoint(t);const a=this._fromType(e),r=this._events.get(t),o=Math.round(Math.max(1/s,1));for(let l=0;l<=o;l++){const c=s*l+t,u=this._exponentialApproach(r.time,r.value,a,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}setValueAtTime(e,t){const s=this.toSeconds(t);super.setValueAtTime(e,t);const a=this._events.get(s),r=this._events.previousEvent(a),o=this._getTicksUntilEvent(r,s);return a.ticks=Math.max(o,0),this}linearRampToValueAtTime(e,t){const s=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const a=this._events.get(s),r=this._events.previousEvent(a),o=this._getTicksUntilEvent(r,s);return a.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const s=this._fromType(e),a=this._events.get(t),r=Math.round(Math.max((t-a.time)*10,1)),o=(t-a.time)/r;for(let l=0;l<=r;l++){const c=o*l+a.time,u=this._exponentialInterpolate(a.time,a.value,t,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Je(e.ticks)){const o=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(o,e.time)}const s=this._fromType(this.getValueAtTime(e.time));let a=this._fromType(this.getValueAtTime(t));const r=this._events.get(t);return r&&r.time===t&&r.type==="setValueAtTime"&&(a=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(s+a)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),s=this._events.get(t);return Math.max(this._getTicksUntilEvent(s,t),0)}getDurationOfTicks(e,t){const s=this.toSeconds(t),a=this.getTicksAtTime(t);return this.getTimeOfTick(a+e)-s}getTimeOfTick(e){const t=this._events.get(e,"ticks"),s=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&s&&s.type==="linearRampToValueAtTime"&&t.value!==s.value){const a=this._fromType(this.getValueAtTime(t.time)),o=(this._fromType(this.getValueAtTime(s.time))-a)/(s.time-t.time),l=Math.sqrt(Math.pow(a,2)-2*o*(t.ticks-e)),c=(-a+l)/o,u=(-a-l)/o;return(c>0?c:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const s=this.toSeconds(t),a=this.toSeconds(e),r=this.getTicksAtTime(s);return this.getTicksAtTime(s+a)-r}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class Ui extends Oe{constructor(){const e=te(Ui.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Bi({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(Oe.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class $i extends Pe{constructor(){const e=te($i.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new Gs,this._tickOffset=new Qe,this._ticksAtTime=new Qe,this._secondsAtTime=new Qe,this.frequency=new Ui({context:this.context,units:e.units,value:e.frequency}),we(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Pe.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const s=this.toSeconds(e);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),se(t)&&this.setTicksAtTime(t,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const s=this._state.get(t);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),s=this._state.getLastState("stopped",t),a=this._ticksAtTime.get(t),r={state:"paused",time:t};this._state.add(r);let o=a||s,l=a?a.ticks:0,c=null;return this._state.forEachBetween(o.time,t+this.sampleTime,u=>{let d=o.time;const h=this._tickOffset.get(u.time);h&&h.time>=o.time&&(l=h.ticks,d=h.time),o.state==="started"&&u.state!=="started"&&(l+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(d),u.time!==r.time&&(c={state:u.state,time:u.time,ticks:l})),o=u}),this._state.remove(r),c&&this._ticksAtTime.add(c),l}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),s=this.frequency.timeToTicks(e,t);this.setTicksAtTime(s,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),s={state:"paused",time:e};this._state.add(s);const a=this._secondsAtTime.get(e);let r=a||t,o=a?a.seconds:0,l=null;return this._state.forEachBetween(r.time,e+this.sampleTime,c=>{let u=r.time;const d=this._tickOffset.get(c.time);d&&d.time>=r.time&&(o=d.seconds,u=d.time),r.state==="started"&&c.state!=="started"&&(o+=c.time-u,c.time!==s.time&&(l={state:c.state,time:c.time,seconds:o})),r=c}),this._state.remove(s),l&&this._secondsAtTime.add(l),o}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const s=this._tickOffset.get(t),a=this._state.get(t),r=Math.max(s.time,a.time),o=this.frequency.getTicksAtTime(r)+e-s.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(e,t,s){let a=this._state.get(e);this._state.forEachBetween(e,t,o=>{a&&a.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(a.time,e),o.time-this.sampleTime,s),a=o});let r=null;if(a&&a.state==="started"){const o=Math.max(a.time,e),l=this.frequency.getTicksAtTime(o),c=this.frequency.getTicksAtTime(a.time),u=l-c;let d=Math.ceil(u)-u;d=st(d,1)?0:d;let h=this.frequency.getTimeOfTick(l+d);for(;h<t;){try{s(h,Math.round(this.getTicksAtTime(h)))}catch(g){r=g;break}h+=this.frequency.getDurationOfTicks(1,h)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class En extends Pe{constructor(){const e=te(En.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=re,this._lastUpdate=0,this._state=new Gs("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new $i({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,we(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Pe.getDefaults(),{callback:re,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){eo(this.context);const s=this.toSeconds(e);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,t),s<this._lastUpdate&&this.emit("start",s,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const s=this.toSeconds(t),a=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(a+e,s)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,s=>{switch(s.state){case"started":const a=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,a);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(e,t,(s,a)=>{this.callback(s,a)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Us.mixin(En);class Ss extends ne{constructor(){const e=te(Ss.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new Fe({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,we(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Gi extends ne{constructor(){const e=te(Gi.getDefaults(),arguments);super(e),this.name="Destination",this.input=new Ss({context:this.context}),this.output=new Fe({context:this.context}),this.volume=this.input.volume,fi(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),fi(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}kn(n=>{n.destination=new Gi({context:n})});Cn(n=>{n.destination.dispose()});class nf extends ne{constructor(){super(...arguments),this.name="Listener",this.positionX=new ye({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new ye({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new ye({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new ye({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new ye({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new ye({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new ye({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new ye({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new ye({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ne.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}kn(n=>{n.listener=new nf({context:n})});Cn(n=>{n.listener.dispose()});class zi extends St{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=te(zi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const s=e.urls[t];this.add(t,s,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:re,onload:re,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return K(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,s=re,a=re){return wt(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new fe(this.baseUrl+t,s,a))):this._buffers.set(e.toString(),new fe(t,s,a)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class gn extends Xe{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return Bt(super._frequencyToUnits(e))}_ticksToUnits(e){return Bt(super._ticksToUnits(e))}_beatsToUnits(e){return Bt(super._beatsToUnits(e))}_secondsToUnits(e){return Bt(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return ho(this.toMidi())}transpose(e){return new gn(this.context,this.toMidi()+e)}}class Ae extends cs{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class af extends Pe{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new Qe,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}kn(n=>{n.draw=new af({context:n})});Cn(n=>{n.draw.dispose()});class rf extends St{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){K(se(e.time),"Events must have a time property"),K(se(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new of(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const s of t)if(s.event===e){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let s,a=null;if(t>0)if(e.left.right===null)s=e.left,s.right=e.right,a=s;else{for(s=e.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,a=s.parent,s.left=e.left,s.right=e.right)}else if(e.right.left===null)s=e.right,s.left=e.left,a=s;else{for(s=e.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,a=s.parent,s.left=e.left,s.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=s:e.parent.right=s:this._setRoot(s),a&&this._rebalance(a)}e.dispose()}_rotateLeft(e){const t=e.parent,s=e.isLeftChild(),a=e.right;a&&(e.right=a.left,a.left=e),t!==null?s?t.left=a:t.right=a:this._setRoot(a)}_rotateRight(e){const t=e.parent,s=e.isLeftChild(),a=e.left;a&&(e.left=a.right,a.right=e),t!==null?s?t.left=a:t.right=a:this._setRoot(a)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let s=t[0];for(let a=1;a<t.length;a++)t[a].low>s.low&&(s=t[a]);return s.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(s=>t.push(s)),t.forEach(s=>{s.event&&e(s.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const s=[];this._root.search(e,s),s.forEach(a=>{a.event&&t(a.event)})}return this}forEachFrom(e,t){if(this._root!==null){const s=[];this._root.searchAfter(e,s),s.forEach(a=>{a.event&&t(a.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class of{constructor(e,t,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class cf extends St{constructor(e){super(),this.name="TimelineValue",this._timeline=new Qe({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class ms extends ne{constructor(){super(te(ms.getDefaults(),arguments,["context"]))}connect(e,t=0,s=0){return Wi(this,e,t,s),this}}class zs extends ms{constructor(){const e=te(zs.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,$e(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):Dp(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(Oe.getDefaults(),{length:1024})}setMap(e,t=1024){const s=new Float32Array(t);for(let a=0,r=t;a<r;a++){const o=a/(r-1)*2-1;s[a]=e(o,a)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(s=>s.includes(e));K(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Yi extends ms{constructor(){const e=te(Yi.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new zs({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(ms.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class It{constructor(e,t){this.id=It._eventId++,this._remainderTime=0;const s=Object.assign(It.getDefaults(),t);this.transport=e,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:re,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}It._eventId=0;class Hi extends It{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(Hi.getDefaults(),t);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},It.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return fn(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ae(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){fn(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ae(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);ds(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Mn extends Pe{constructor(){const e=te(Mn.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new cf(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new Qe,this._repeatedEvents=new rf,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new En({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),we(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Pe.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const s=t%(this._swingTicks*2)/(this._swingTicks*2),a=Math.sin(s*Math.PI)*this._swingAmount;e+=new Ae(this.context,this._swingTicks*2/3).toSeconds()*a}Va(!0),this._timeline.forEachAtTime(t,s=>s.invoke(e)),Va(!1)}schedule(e,t){const s=new It(this,{callback:e,time:new cs(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(e,t,s,a=1/0){const r=new Hi(this,{callback:e,duration:new nt(this.context,a).toTicks(),interval:new nt(this.context,t).toTicks(),time:new cs(this.context,s).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(e,t){const s=new It(this,{callback:e,once:!0,time:new cs(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(t,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new Ae(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let s;return se(t)&&(s=this.toTicks(t)),this._clock.start(e,s),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){$e(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new nt(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new nt(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new Ae(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new Ae(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),s=this._clock.frequency.timeToTicks(e,t);this.ticks=s}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(t),a=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,t),r=t+a;this.emit("stop",r),this._clock.setTicksAtTime(e,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),s=this.getTicksAtTime(t),a=e-s%e;return this._clock.nextTickTime(a,t)}}syncSignal(e,t){const s=this.now();let a=this.bpm,r=1/(60/a.getValueAtTime(s)/this.PPQ),o=[];if(e.units==="time"){const c=.015625/r,u=new Fe(c),d=new Yi(-1),h=new Fe(c);a.chain(u,d,h),a=h,r=1/r,o=[u,d,h]}t||(e.getValueAtTime(s)!==0?t=e.getValueAtTime(s)/r:t=0);const l=new Fe(t);return a.connect(l),l.connect(e._param),o.push(l),this._syncedSignals.push({initial:e.value,nodes:o,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const s=this._syncedSignals[t];s.signal===e&&(s.nodes.forEach(a=>a.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),ro(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Us.mixin(Mn);kn(n=>{n.transport=new Mn({context:n})});Cn(n=>{n.transport.dispose()});class Ze extends ne{constructor(e){super(e),this.input=void 0,this._state=new Gs("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=re,this._syncedStop=re,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Ss({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,we(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,onstop:re,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,s){let a=Je(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(a=this._clampToCurrentTime(a),!this._synced&&this._state.getValueAtTime(a)==="started")K(ds(a,this._state.get(a).time),"Start time must be strictly greater than previous start time"),this._state.cancel(a),this._state.setStateAtTime("started",a),this.log("restart",a),this.restart(a,t,s);else if(this.log("start",a),this._state.setStateAtTime("started",a),this._synced){const r=this._state.get(a);r&&(r.offset=this.toSeconds(dt(t,0)),r.duration=s?this.toSeconds(s):void 0);const o=this.context.transport.schedule(l=>{this._start(l,t,s)},a);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>a&&this._syncedStart(this.now(),this.context.transport.seconds)}else eo(this.context),this._start(a,t,s);return this}stop(e){let t=Je(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||se(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const s=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(s)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,s){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(ds(t,0)){const s=this._state.get(t);if(s&&s.state==="started"&&s.time!==t){const a=t-this.toSeconds(s.time);let r;s.duration&&(r=this.toSeconds(s.duration)-a),this._start(e,this.toSeconds(s.offset)+a,r)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=re,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class In extends hs{constructor(){const e=te(In.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Ns(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new ye({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new fe(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(hs.getDefaults(),{url:new fe,loop:!1,loopEnd:0,loopStart:0,onload:re,onerror:re,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,s,a=1){K(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(e);this._startGain(r,a),this.loop?t=dt(t,this.loopStart):t=dt(t,0);let o=Math.max(this.toSeconds(t),0);if(this.loop){const l=this.toSeconds(this.loopEnd)||this.buffer.duration,c=this.toSeconds(this.loopStart),u=l-c;pi(o,l)&&(o=(o-c)%u+c),st(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,fn(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,o)),se(s)){let l=this.toSeconds(s);l=Math.max(l,0),this.stop(r+l)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function Qt(n,e){return ke(this,void 0,void 0,function*(){const t=e/n.context.sampleRate,s=new Li(1,t,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/t,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class Xi extends hs{constructor(){const e=te(Xi.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Ns(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new ye({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new ye({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),we(this,["frequency","detune"])}static getDefaults(){return Object.assign(hs.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Te extends Ze{constructor(){const e=te(Te.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),we(this,"frequency"),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),we(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),s=new Xi({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Te._periodicWaveCache.find(t=>t.phase===this._phase&&Up(t.partials,this._partials));{const e=Te._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const s=this._getCachedPeriodicWave();if(se(s)){const{partials:a,wave:r}=s;this._wave=r,this._partials=a,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[a,r]=this._getRealImaginary(e,this._phase),o=this.context.createPeriodicWave(a,r);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Te._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:a,type:this._type,wave:this._wave}),Te._periodicWaveCache.length>100&&Te._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Mt(e,0);let t=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(t=s[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const a=new Float32Array(e);this._partials.forEach((r,o)=>a[o]=r),this._partials=Array.from(a),this.type=this._type}}_getRealImaginary(e,t){let a=2048;const r=new Float32Array(a),o=new Float32Array(a);let l=1;if(e==="custom"){if(l=this._partials.length+1,this._partialCount=this._partials.length,a=l,this._partials.length===0)return[r,o]}else{const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);c?(l=parseInt(c[2],10)+1,this._partialCount=parseInt(c[2],10),e=c[1],l=Math.max(l,2),a=l):this._partialCount=0,this._partials=[]}for(let c=1;c<a;++c){const u=2/(c*Math.PI);let d;switch(e){case"sine":d=c<=l?1:0,this._partials[c-1]=d;break;case"square":d=c&1?2*u:0,this._partials[c-1]=d;break;case"sawtooth":d=u*(c&1?1:-1),this._partials[c-1]=d;break;case"triangle":c&1?d=2*(u*u)*(c-1>>1&1?-1:1):d=0,this._partials[c-1]=d;break;case"custom":d=this._partials[c-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}d!==0?(r[c]=-d*Math.sin(t*c),o[c]=d*Math.cos(t*c)):(r[c]=0,o[c]=0)}return[r,o]}_inverseFFT(e,t,s){let a=0;const r=e.length;for(let o=0;o<r;o++)a+=e[o]*Math.cos(o*s)+t[o]*Math.sin(o*s);return a}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let s=0;const a=Math.PI*2,r=32;for(let o=0;o<r;o++)s=Math.max(this._inverseFFT(e,t,o/r*a),s);return Gp(-this._inverseFFT(e,t,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Te._periodicWaveCache=[];class lf extends ms{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new zs({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class ps extends Oe{constructor(){const e=te(ps.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Fe({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Oe.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Dn extends Ze{constructor(){const e=te(Dn.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new lf({context:this.context}),this._modulationNode=new Fe({context:this.context}),this._carrier=new Te({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Te({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new ps({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),we(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Te.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class On extends Ze{constructor(){const e=te(On.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new Fe({context:this.context,gain:0}),this._carrier=new Te({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new Te({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new ps({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new ps({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),we(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Te.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Ys extends Ze{constructor(){const e=te(Ys.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new Fe({context:this.context,gain:0}),this._thresh=new zs({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new Oe({context:this.context,units:"audioRange",value:e.width}),this._triangle=new Te({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),we(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Rn extends Ze{constructor(){const e=te(Rn.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,we(this,["frequency","detune"])}static getDefaults(){return Object.assign(Te.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,s=e/(this._oscillators.length-1);this._forEach((a,r)=>a.detune.value=t+s*r)}}get count(){return this._oscillators.length}set count(e){if(Mt(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const s=new Te({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):re});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[t]=s}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,s)=>t.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class Pn extends Ze{constructor(){const e=te(Pn.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new ps({context:this.context,value:2}),this._pulse=new Ys({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Te({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),we(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Ze.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const qa={am:Dn,fat:Rn,fm:On,oscillator:Te,pulse:Ys,pwm:Pn};class vn extends Ze{constructor(){const e=te(vn.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new Oe({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Oe({context:this.context,units:"cents",value:e.detune}),we(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(Te.getDefaults(),On.getDefaults(),Dn.getDefaults(),Rn.getDefaults(),Ys.getDefaults(),Pn.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=qa[e],s=this.now();if(this._oscillator){const a=this._oscillator;a.stop(s),this.context.setTimeout(()=>a.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof qa[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&mt(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&mt(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&wt(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return ke(this,arguments,void 0,function*(e=1024){return Qt(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function mo(n,e=1/0){const t=new WeakMap;return function(s,a){Reflect.defineProperty(s,a,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Mt(r,n,e),t.set(this,r)}})}}function jt(n,e=1/0){const t=new WeakMap;return function(s,a){Reflect.defineProperty(s,a,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Mt(this.toSeconds(r),n,e),t.set(this,r)}})}}class Fn extends Ze{constructor(){const e=te(Fn.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new fe({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(Ze.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:re,onerror:re,playbackRate:1,reverse:!1})}load(e){return ke(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=re){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,s){return super.start(e,t,s),this}_start(e,t,s){this._loop?t=dt(t,this._loopStart):t=dt(t,0);const a=this.toSeconds(t),r=s;s=dt(s,Math.max(this._buffer.duration-a,0));let o=this.toSeconds(s);o=o/this._playbackRate,e=this.toSeconds(e);const l=new In({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+o),this._state.setStateAtTime("stopped",e+o,{implicitEnd:!0})),this._activeSources.add(l),this._loop&&Je(r)?l.start(e,a):l.start(e,a,o-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(s=>s.stop(t))}restart(e,t,s){return super.restart(e,t,s),this}_restart(e,t,s){var a;(a=[...this._activeSources].pop())===null||a===void 0||a.stop(e),this._start(e,t,s)}seek(e,t){const s=this.toSeconds(t);if(this._state.getValueAtTime(s)==="started"){const a=this.toSeconds(e);this._stop(s),this._start(s,a)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Mt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Mt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),s=this._state.getNextState("stopped",t);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(a=>a.cancelStop())),this._activeSources.forEach(a=>{a.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}ot([jt(0)],Fn.prototype,"fadeIn",void 0);ot([jt(0)],Fn.prototype,"fadeOut",void 0);class Vt extends ne{constructor(){const e=te(Vt.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new Oe({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(ne.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(wt(e))return e;{let s;for(s in Ks)if(Ks[s][t]===e)return s;return e}}_setCurve(e,t,s){if(wt(s)&&Reflect.has(Ks,s)){const a=Ks[s];At(a)?e!=="_decayCurve"&&(this[e]=a[t]):this[e]=a}else if($e(s)&&e!=="_decayCurve")this[e]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let a=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),o=this.getValueAtTime(e);if(o>0){const l=1/a;a=(1-o)/l}if(a<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,a,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,a,e);else{this._sig.cancelAndHoldAtTime(e);let l=this._attackCurve;for(let c=1;c<l.length;c++)if(l[c-1]<=o&&o<=l[c]){l=this._attackCurve.slice(c),l[0]=o;break}this._sig.setValueCurveAtTime(l,e,a,t)}if(r&&this.sustain<1){const l=t*this.sustain,c=e+a;this.log("decay",c),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(l,r+c):this._sig.exponentialApproachValueAtTime(l,c,r)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,e):(K($e(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,s,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,s=1){return t=this.toSeconds(t),this.triggerAttack(t,s),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,s=0){return Wi(this,e,t,s),this}asArray(){return ke(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,s=new Li(1,t,this.context.sampleRate),a=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=a+this.toSeconds(this.release),o=r*.1,l=r+o,c=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/l,decay:t*this.toSeconds(this.decay)/l,release:t*this.toSeconds(this.release)/l,context:s}));return c._sig.toDestination(),c.triggerAttackRelease(t*(a+o)/l,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}ot([jt(0)],Vt.prototype,"attack",void 0);ot([jt(0)],Vt.prototype,"decay",void 0);ot([mo(0,1)],Vt.prototype,"sustain",void 0);ot([jt(0)],Vt.prototype,"release",void 0);const Ks=(()=>{let e,t;const s=[];for(e=0;e<128;e++)s[e]=Math.sin(e/127*(Math.PI/2));const a=[],r=6.4;for(e=0;e<127;e++){t=e/127;const g=Math.sin(t*(Math.PI*2)*r-Math.PI/2)+1;a[e]=g/10+t*.83}a[127]=1;const o=[],l=5;for(e=0;e<128;e++)o[e]=Math.ceil(e/127*l)/l;const c=[];for(e=0;e<128;e++)t=e/127,c[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const g=Math.pow(t,3)*4+.2,f=Math.cos(g*Math.PI*2*t);u[e]=Math.abs(f*(1-t))}function d(g){const f=new Array(g.length);for(let p=0;p<g.length;p++)f[p]=1-g[p];return f}function h(g){return g.slice(0).reverse()}return{bounce:{In:d(u),Out:u},cosine:{In:s,Out:h(s)},exponential:"exponential",linear:"linear",ripple:{In:a,Out:d(a)},sine:{In:c,Out:d(c)},step:{In:o,Out:d(o)}}})();class Dt extends ne{constructor(){const e=te(Dt.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new Ss({context:this.context,volume:e.volume}),this.volume=this._volume.volume,we(this,"volume")}static getDefaults(){return Object.assign(ne.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const s=this["_original_"+e]=this[e];this[e]=(...a)=>{const r=a[t],o=this.context.transport.schedule(l=>{a[t]=l,s.apply(this,a)},r);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,s,a){const r=this.toSeconds(s),o=this.toSeconds(t);return this.triggerAttack(e,r,a),this.triggerRelease(r+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class Yt extends Dt{constructor(){const e=te(Yt.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(Dt.getDefaults(),{detune:0,onsilence:re,portamento:0})}triggerAttack(e,t,s=1){this.log("triggerAttack",e,t,s);const a=this.toSeconds(t);return this._triggerEnvelopeAttack(a,s),this.setNote(e,a),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const s=this.toSeconds(t),a=e instanceof Xe?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(a,r,s)}else this.frequency.setValueAtTime(a,s);return this}}ot([jt(0)],Yt.prototype,"portamento",void 0);class Ji extends Vt{constructor(){super(te(Ji.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Fe({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class fs extends Yt{constructor(){const e=te(fs.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new vn(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Ji(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),we(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(Yt.getDefaults(),{envelope:Object.assign(mi(Vt.getDefaults(),Object.keys(ne.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(mi(vn.getDefaults(),[...Object.keys(Ze.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),a=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+s+a)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Ln extends fs{constructor(){const e=te(Ln.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,we(this,["oscillator","envelope"])}static getDefaults(){return Ut(Yt.getDefaults(),fs.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const s=this.toSeconds(t),a=this.toFrequency(e instanceof Xe?e.toFrequency():e),r=a*this.octaves;return this.oscillator.frequency.setValueAtTime(r,s),this.oscillator.frequency.exponentialRampToValueAtTime(a,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}ot([mo(0)],Ln.prototype,"octaves",void 0);ot([jt(0)],Ln.prototype,"pitchDecay",void 0);const po=new Set;function Zi(n){po.add(n)}function fo(n,e){const t=`registerProcessor("${n}", ${e})`;po.add(t)}const uf=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Zi(uf);const df=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Zi(df);const hf=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Zi(hf);const mf="feedback-comb-filter",pf=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;fo(mf,pf);class Ki extends Dt{constructor(){const e=te(Ki.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=a=>this.releaseAll(a),K(!mt(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Dt.getDefaults(),{maxPolyphony:32,options:{},voice:fs})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(s=>s.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return K(e instanceof Yt,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else Tn("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,s){e.forEach(a=>{const r=new gn(this.context,a).toMidi(),o=this._getNextAvailableVoice();o&&(o.triggerAttack(a,t,s),this._activeVoices.push({midi:r,voice:o,released:!1}),this.log("triggerAttack",a,t))})}_triggerRelease(e,t){e.forEach(s=>{const a=new gn(this.context,s).toMidi(),r=this._activeVoices.find(({midi:o,released:l})=>o===a&&!l);r&&(r.voice.triggerRelease(t),r.released=!0,this.log("triggerRelease",s,t))})}_scheduleEvent(e,t,s,a){K(!this.disposed,"Synth was already disposed"),s<=this.now()?e==="attack"?this._triggerAttack(t,s,a):this._triggerRelease(t,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,s,a)},s-this.now())}triggerAttack(e,t,s){Array.isArray(e)||(e=[e]);const a=this.toSeconds(t);return this._scheduleEvent("attack",e,a,s),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const s=this.toSeconds(t);return this._scheduleEvent("release",e,s),this}triggerAttackRelease(e,t,s,a){const r=this.toSeconds(s);if(this.triggerAttack(e,r,a),$e(t)){K($e(e),"If the duration is an array, the notes must also be an array"),e=e;for(let o=0;o<e.length;o++){const l=t[Math.min(o,t.length-1)],c=this.toSeconds(l);K(c>0,"The duration must be greater than 0"),this.triggerRelease(e[o],r+c)}}else{const o=this.toSeconds(t);K(o>0,"The duration must be greater than 0"),this.triggerRelease(e,r+o)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=mi(e,["onsilence","context"]);return this.options=Ut(this.options,t),this._voices.forEach(s=>s.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Vn extends Dt{constructor(){const e=te(Vn.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(s=>{const a=parseInt(s,10);if(K(Zs(s)||mt(a)&&isFinite(a),`url key is neither a note or midi pitch: ${s}`),Zs(s)){const r=new Xe(this.context,s).toMidi();t[r]=e.urls[s]}else mt(a)&&isFinite(a)&&(t[a]=e.urls[a])}),this._buffers=new zi({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(Dt.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:re,onerror:re,release:.1,urls:{}})}_findClosest(e){let s=0;for(;s<96;){if(this._buffers.has(e+s))return-s;if(this._buffers.has(e-s))return s;s++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,s=1){return this.log("triggerAttack",e,t,s),Array.isArray(e)||(e=[e]),e.forEach(a=>{const r=uo(new Xe(this.context,a).toFrequency()),o=Math.round(r),l=r-o,c=this._findClosest(o),u=o-c,d=this._buffers.get(u),h=lo(c+l),g=new In({url:d,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:h}).connect(this.output);g.start(t,0,d.duration/h,s),$e(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(g),g.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),p=f.indexOf(g);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(s=>{const a=new Xe(this.context,s).toMidi();if(this._activeSources.has(a)&&this._activeSources.get(a).length){const r=this._activeSources.get(a);t=this.toSeconds(t),r.forEach(o=>{o.stop(t)}),this._activeSources.set(a,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,s,a=1){const r=this.toSeconds(s);return this.triggerAttack(e,r,a),$e(t)?(K($e(e),"notes must be an array when duration is array"),e.forEach((o,l)=>{const c=t[Math.min(l,t.length-1)];this.triggerRelease(o,r+this.toSeconds(c))})):this.triggerRelease(e,r+this.toSeconds(t)),this}add(e,t,s){if(K(Zs(e)||isFinite(e),`note must be a pitch or midi: ${e}`),Zs(e)){const a=new Xe(this.context,e).toMidi();this._buffers.add(a,t,s)}else this._buffers.add(e,t,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}ot([jt(0)],Vn.prototype,"attack",void 0);ot([jt(0)],Vn.prototype,"release",void 0);class as extends Pe{constructor(){const e=te(as.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new Gs("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Pe.getDefaults(),{callback:re,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let s;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const a=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||mt(this._loop)&&this._loop>1){s=1/0,mt(this._loop)&&(s=this._loop*this._getLoopDuration());const r=this._state.getAfter(a);r!==null&&(s=Math.min(s,r.time-a)),s!==1/0&&(s=new Ae(this.context,s));const o=new Ae(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),o,new Ae(this.context,a),s)}else t.id=this.context.transport.schedule(this._tick.bind(this),new Ae(this.context,a))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const s=this._state.getBefore(t);let a=t;s!==null&&(a=s.time),this._rescheduleEvents(a)}return this}cancel(e){e=dt(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,s=>{this.context.transport.clear(s.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;Qr(this.humanize)||(s=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*s}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new Ae(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new Ae(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const s=this._getLoopDuration();return(e-t.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class yn extends as{constructor(){const e=te(yn.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new Gs("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{$e(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(as.getDefaults(),{events:[]})}start(e,t){const s=this.toTicks(e);if(this._state.getValueAtTime(s)!=="started"){t=dt(t,this._loop?this._loopStart:0),this._loop?t=dt(t,this._loopStart):t=dt(t,0);const a=this.toTicks(t);this._state.add({id:-1,offset:a,state:"started",time:s}),this._forEach(r=>{this._startNote(r,s,a)})}return this}_startNote(e,t,s){t-=s,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<s&&(t+=this._getLoopDuration()),e.start(new Ae(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=s&&(e.loop=!1,e.start(new Ae(this.context,t))):e.startOffset>=s&&e.start(new Ae(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(s=>{s.stop(e)}),this}at(e,t){const s=new cs(this.context,e).toTicks(),a=new Ae(this.context,1).toSeconds(),r=this._events.values();let o=r.next();for(;!o.done;){const l=o.value;if(Math.abs(s-l.startOffset)<a)return se(t)&&(l.value=t),l;o=r.next()}return se(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const s=this.toTicks(e);let a;return t instanceof as?(a=t,a.callback=this._tick.bind(this)):a=new as({callback:this._tick.bind(this),context:this.context,value:t}),a.startOffset=s,a.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(a),this._restartEvent(a),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new Ae(this.context,t.time))})}remove(e,t){return At(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(s=>{s.startOffset===e&&(Je(t)||se(t)&&s.value===t)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof yn?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(s=>{s[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new Ae(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new Ae(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class Qi extends ne{constructor(){const e=te(Qi.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new ye({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",we(this,"pan")}static getDefaults(){return Object.assign(ne.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const ff="bit-crusher",gf=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;fo(ff,gf);class je extends ne{constructor(){const e=te(je.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new Fe({context:this.context}),je._allSolos.has(this.context)||je._allSolos.set(this.context,new Set),je._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(ne.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),je._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){je._soloed.has(this.context)||je._soloed.set(this.context,new Set),je._soloed.get(this.context).add(this)}_removeSolo(){je._soloed.has(this.context)&&je._soloed.get(this.context).delete(this)}_isSoloed(){return je._soloed.has(this.context)&&je._soloed.get(this.context).has(this)}_noSolos(){return!je._soloed.has(this.context)||je._soloed.has(this.context)&&je._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),je._allSolos.get(this.context).delete(this),this._removeSolo(),this}}je._allSolos=new Map;je._soloed=new Map;class ea extends ne{constructor(){const e=te(ea.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new Qi({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Ss({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,we(this,["pan","volume"])}static getDefaults(){return Object.assign(ne.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class rs extends ne{constructor(){const e=te(rs.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new je({solo:e.solo,context:this.context}),this._panVol=this.output=new ea({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),we(this,["pan","volume"])}static getDefaults(){return Object.assign(ne.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return rs.buses.has(e)||rs.buses.set(e,new Fe({context:this.context})),rs.buses.get(e)}send(e,t=0){const s=this._getBus(e),a=new Fe({context:this.context,units:"decibels",gain:t});return this.connect(a),a.connect(s),a}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}rs.buses=new Map;He().transport;function yt(){return He().transport}He().destination;He().destination;function vf(){return He().destination}He().listener;He().draw;const yf=He();class _f{constructor(e={}){lt(this,"synth",null);lt(this,"part",null);lt(this,"isPlaying",!1);lt(this,"isPaused",!1);lt(this,"duration",0);lt(this,"options");lt(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);const a=this.parseMIDIToNotes(s);this.synth||(this.synth=new Ki(fs,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new yn((r,o)=>{this.synth?.triggerAttackRelease(o.name,o.duration,r,o.velocity)},a),this.duration=this.calculateDuration(a),this.part.loop=!1}catch(t){const s=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(s),s}}parseMIDIToNotes(e){const t=[],s=["C4","D4","E4","F4","G4","A4","B4","C5"];let a=0;for(let r=0;r<16;r++)t.push({time:`${a}`,name:s[r%s.length],duration:"4n",velocity:.7}),a+=.5;return t}calculateDuration(e){if(e.length===0)return 0;const t=e[e.length-1],s=parseFloat(t.time),r={"1n":2,"2n":1,"4n":.5,"8n":.25,"16n":.125}[t.duration]||.5;return s+r}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await co(),this.isPaused?(yt().start(),this.isPaused=!1):(this.part.start(0),yt().start()),this.isPlaying=!0,this.startProgressTracking(),yt().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(yt().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){yt().stop(),yt().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));yt().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:yt().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=yt().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let Kn=null;function bf(){return Kn||(Kn=new _f),Kn}const xf=({album:n,isPlaying:e,currentTime:t,duration:s,onPlayPause:a,onExpand:r})=>{if(!n)return null;const o=s>0?Math.max(0,Math.min(1,t/s)):0,l=c=>{c.stopPropagation()};return i.jsxs("div",{className:"spotify-square-dock",role:"button",tabIndex:0,"aria-label":"プレイヤーを開く",onClick:r,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),r())},"data-no-swipe":!0,children:[i.jsx("img",{className:"spotify-square-dock-art",src:n.imageDataURL,alt:n.title||n.mood,draggable:!1}),i.jsx("div",{className:"spotify-square-dock-overlay","aria-hidden":"true"}),i.jsx("button",{className:"spotify-square-dock-play",onClick:c=>{l(c),a()},onMouseDown:l,onTouchStart:l,"aria-label":e?"一時停止":"再生",title:e?"一時停止":"再生",children:e?"⏸":"▶"}),i.jsx("div",{className:"spotify-square-dock-progress","aria-hidden":"true",children:i.jsx("div",{className:"spotify-square-dock-progressFill",style:{width:`${Math.round(o*100)}%`}})}),i.jsx("div",{className:"spotify-square-dock-hint","aria-hidden":"true",children:i.jsx("div",{className:"spotify-square-dock-title",children:n.title||n.mood})})]})},wf=({isPlaying:n,canPrevious:e,canNext:t,shuffle:s,repeat:a,onPlayPause:r,onPrevious:o,onNext:l,onShuffle:c,onRepeat:u,expanded:d=!1})=>{const h=()=>i.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:i.jsx("polygon",{points:"8,6 8,18 18,12"})}),g=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),i.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),f=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),i.jsx("polygon",{points:"18,6 10,12 18,18"})]}),p=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("polygon",{points:"6,6 14,12 6,18"}),i.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),m=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),i.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),_=()=>i.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[i.jsx("path",{d:"M7 7h10v4"}),i.jsx("path",{d:"M17 17H7v-4"}),i.jsx("path",{d:"M17 7l3 3-3 3"}),i.jsx("path",{d:"M7 17l-3-3 3-3"})]});return i.jsxs("div",{className:`playback-controls ${d?"expanded":""}`,children:[d&&i.jsx("button",{className:`control-button secondary ${s?"active":""}`,onClick:c,"aria-label":"Shuffle",title:"Shuffle",children:i.jsx(m,{})}),i.jsx("button",{className:"control-button",onClick:o,disabled:!e,"aria-label":"Previous",title:"Previous track",children:i.jsx(f,{})}),i.jsx("button",{className:"control-button primary",onClick:r,"aria-label":n?"Pause":"Play",title:n?"Pause":"Play",children:n?i.jsx(g,{}):i.jsx(h,{})}),i.jsx("button",{className:"control-button",onClick:l,disabled:!t,"aria-label":"Next",title:"Next track",children:i.jsx(p,{})}),d&&i.jsxs("button",{className:`control-button secondary ${a!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${a}`,title:`Repeat: ${a}`,children:[i.jsx(_,{}),a==="one"&&i.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},Nf=({currentTime:n,duration:e,onSeek:t,color:s="#D4AF37"})=>{const[a,r]=w.useState(!1),o=w.useRef(null),l=f=>{if(!isFinite(f)||f<0)return"0:00";const p=Math.floor(f/60),m=Math.floor(f%60);return`${p}:${m.toString().padStart(2,"0")}`},c=f=>{if(!o.current||e===0)return;const p=o.current.getBoundingClientRect(),m=f-p.left,y=Math.max(0,Math.min(1,m/p.width))*e;t(y)},u=f=>{r(!0),c(f.clientX)},d=f=>{a&&c(f.clientX)},h=()=>{r(!1)};F.useEffect(()=>{if(a)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",h),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",h)}},[a]);const g=e>0?n/e*100:0;return i.jsxs("div",{className:"seek-bar-container",children:[i.jsx("span",{className:"seek-time current",children:l(n)}),i.jsx("div",{ref:o,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":n,children:i.jsx("div",{className:"seek-progress",style:{width:`${g}%`,background:`linear-gradient(90deg, ${s}cc, ${s})`},children:i.jsx("div",{className:"seek-thumb"})})}),i.jsx("span",{className:"seek-time total",children:l(e)})]})},Sf=({volume:n,isMuted:e,onVolumeChange:t,onMuteToggle:s,expanded:a=!1})=>{const[r,o]=w.useState(!1),l=w.useRef(null),c=e||n===0?"muted":n<.5?"low":"high",u=p=>{if(!l.current)return;const m=l.current.getBoundingClientRect(),_=p-m.left,y=Math.max(0,Math.min(1,_/m.width));t(y)},d=p=>{o(!0),u(p.clientX)},h=p=>{r&&u(p.clientX)},g=()=>{o(!1)};F.useEffect(()=>{if(r)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",g),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",g)}},[r]);const f=e?0:n;return i.jsxs("div",{className:`volume-control ${a?"expanded":""}`,children:[i.jsxs("button",{className:`volume-icon ${c}`,onClick:s,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[i.jsx("span",{className:"volume-core"}),i.jsx("span",{className:"volume-wave wave-1"}),i.jsx("span",{className:"volume-wave wave-2"})]}),i.jsx("div",{ref:l,className:"volume-slider",onMouseDown:d,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(f*100),children:i.jsx("div",{className:"volume-fill",style:{width:`${f*100}%`},children:i.jsx("div",{className:"volume-thumb"})})})]})},jf=({queue:n,currentIndex:e,onSkipTo:t})=>{const s=n.slice(e+1,e+4);if(s.length===0)return null;const a=r=>{const o=Math.floor(r/60),l=Math.floor(r%60);return`${o}:${l.toString().padStart(2,"0")}`};return i.jsxs("div",{className:"queue-preview",children:[i.jsx("div",{className:"queue-label",children:"Up Next"}),i.jsx("div",{className:"queue-items",children:s.map((r,o)=>i.jsx("div",{className:"queue-item",onClick:()=>t(e+o+1),role:"button",tabIndex:0,onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t(e+o+1))},children:i.jsx($t,{variant:"compact",className:"queue-album-card",title:r.title||r.mood,mood:r.mood,imageUrl:r.imageDataURL,meta:a(r.musicMetadata?.duration||r.duration),badges:[...r.musicData?[{label:"再生",tone:"success"}]:[],...r.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...r.isPublic?[{label:"公開",tone:"info"}]:[]]})},r.id))})]})};class Tf{static draw(e,t,s,a,r,o){const l=this.smoothData(t);this.drawGrid(e,s,a),e.lineWidth=3,e.strokeStyle=this.getGradient(e,r,s),e.shadowBlur=o?8:4,e.shadowColor=r,e.beginPath();const c=s/l.length;let u=0;for(let d=0;d<l.length;d++){const g=l[d]/128*a/2;if(d===0)e.moveTo(u,g);else{const f=(u+c*d)/2,p=(g+l[d-1]/128*a/2)/2;e.quadraticCurveTo(u,l[d-1]/128*a/2,f,p)}u=c*d}e.lineTo(s,a/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-a),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let a=0;a<e.length;a++){let r=0,o=0;for(let l=-3;l<=3;l++){const c=a+l;c>=0&&c<e.length&&(r+=e[c],o++)}t.push(r/o)}return t}static drawGrid(e,t,s){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const a=5;for(let r=0;r<a;r++){const o=s/(a-1)*r;e.beginPath(),e.moveTo(0,o),e.lineTo(t,o),e.stroke()}}static getGradient(e,t,s){const a=e.createLinearGradient(0,0,s,0);return a.addColorStop(0,t),a.addColorStop(.5,this.lightenColor(t,20)),a.addColorStop(1,t),a}static lightenColor(e,t){const s=parseInt(e.replace("#",""),16),a=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+a),o=Math.min(255,(s>>8&255)+a),l=Math.min(255,(s&255)+a);return`#${(r<<16|o<<8|l).toString(16).padStart(6,"0")}`}}class go{static draw(e,t,s,a,r,o){const h=(s-640)/2,g=Math.floor(t.length/64),f=[];for(let _=0;_<64;_++){let y=0;for(let S=0;S<g;S++){const A=_*g+S;A<t.length&&(y+=t[A])}const x=y/g;f.push(x)}const p=this.smoothTransitions(f),m=this.createBarGradient(e,r,64,10,h);for(let _=0;_<64;_++){const y=h+_*10,x=p[_]/255*(a*.4);e.fillStyle=m,this.drawRoundedBar(e,y,a/2-x,8,x,4),o&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,y,a/2+2,8,x*.5,4),e.restore()),e.shadowBlur=o?4:0,e.shadowColor=r}e.shadowBlur=0,o&&this.drawParticles(e,p,h,10,a,r)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],s=.7;for(let a=0;a<e.length;a++){const r=this.previousHeights[a]||0,o=e[a],l=r*s+o*(1-s);t.push(l)}return this.previousHeights=t,t}static drawRoundedBar(e,t,s,a,r,o){e.beginPath(),e.moveTo(t,s+r),e.lineTo(t,s+o),e.arcTo(t,s,t+a,s,o),e.lineTo(t+a,s+o),e.arcTo(t+a,s,t+a,s+r,o),e.lineTo(t+a,s+r),e.closePath(),e.fill()}static createBarGradient(e,t,s,a,r){const o=e.createLinearGradient(r,0,r+s*a,0);return o.addColorStop(0,t),o.addColorStop(.5,this.adjustHue(t,30)),o.addColorStop(1,this.adjustHue(t,60)),o}static drawParticles(e,t,s,a,r,o){for(let c=0;c<t.length;c++)if(t[c]>200){const u=s+c*a+a/2,d=t[c]/255*(r*.4),h=r/2-d-10;e.fillStyle=o,e.globalAlpha=.5,e.beginPath(),e.arc(u,h,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const s=parseInt(e.replace("#",""),16),a=s>>16&255,r=s>>8&255,o=s&255,l=1+t/360,c=Math.min(255,a*l),u=Math.min(255,r*l),d=Math.min(255,o*l);return`#${(Math.floor(c)<<16|Math.floor(u)<<8|Math.floor(d)).toString(16).padStart(6,"0")}`}}lt(go,"previousHeights",[]);class vo{static draw(e,t,s,a,r,o){const l=s/2,c=a/2,u=Math.min(s,a)*.15,d=Math.min(s,a)*.45;o&&(this.rotation+=360/(60*60));const h=Math.min(t.length,180),g=Math.PI*2/h;for(let f=0;f<h;f++){const p=t[Math.floor(f*(t.length/h))],m=p/255*(d-u),_=f*g+this.rotation*(Math.PI/180),y=l+Math.cos(_)*u,x=c+Math.sin(_)*u,S=l+Math.cos(_)*(u+m),A=c+Math.sin(_)*(u+m),b=f/h*360;if(e.strokeStyle=`hsla(${b}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(y,x),e.lineTo(S,A),e.stroke(),o&&p>200){const T=l+Math.cos(_)*(u+m+5),j=c+Math.sin(_)*(u+m+5);e.fillStyle=`hsla(${b}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(T,j,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.arc(l,c,u,0,Math.PI*2),e.stroke(),o){const f=this.getAverageAmplitude(t),p=d+f/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=r,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=r,e.beginPath(),e.arc(l,c,p,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let s=0;s<e.length;s++)t+=e[s];return t/e.length}}lt(vo,"rotation",0);const kf=({mode:n,frequencyData:e,timeDomainData:t,isPlaying:s,dominantColor:a="#D4AF37",width:r=800,height:o=200,mini:l=!1})=>{const c=w.useRef(null),u=w.useRef(null),d=w.useRef(0);return w.useEffect(()=>{const h=c.current;if(!h)return;const g=h.getContext("2d");if(!g)return;const f=l?1:Math.min(window.devicePixelRatio||1,2);h.width=r*f,h.height=o*f,h.style.width=`${r}px`,h.style.height=`${o}px`,g.scale(f,f);const m=1e3/(l?30:60),_=y=>{if(y-d.current<m){u.current=requestAnimationFrame(_);return}d.current=y,g.clearRect(0,0,r,o),n==="waveform"&&t?Tf.draw(g,t,r,o,a,s):n==="spectrum"&&e?go.draw(g,e,r,o,a,s):n==="radial"&&e&&vo.draw(g,e,r,o,a,s),u.current=requestAnimationFrame(_)};return u.current=requestAnimationFrame(_),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[n,e,t,s,a,r,o,l]),i.jsx("canvas",{ref:c,style:{display:"block",margin:"0 auto",borderRadius:l?"4px":"8px"}})},Cf=({tags:n,centerX:e,centerY:t,isPlaying:s})=>{const[a,r]=w.useState([]),o=w.useRef(null),l=w.useRef(Date.now());w.useEffect(()=>{const u=[220,260,300,340,380],d=[12,10,8,6,4],h=n.map((f,p)=>360/n.length*p),g=n.slice(0,5).map((f,p)=>({text:f,radius:u[p]||300,speed:d[p]||8,angle:h[p]||0,scale:1,opacity:.6}));r(g)},[n]),w.useEffect(()=>{if(!s){o.current!==null&&(cancelAnimationFrame(o.current),o.current=null);return}const u=()=>{const d=Date.now(),h=(d-l.current)/1e3;l.current=d,r(g=>g.map((f,p)=>{let m=f.angle+f.speed*h;m=m%360;const _=p*.5,x=1+Math.sin((d/3e3+_)*Math.PI*2)*.05,S=.55+Math.sin((d/3e3+_)*Math.PI*2)*.15;return{...f,angle:m,scale:x,opacity:S}})),o.current=requestAnimationFrame(u)};return o.current=requestAnimationFrame(u),()=>{o.current!==null&&cancelAnimationFrame(o.current)}},[s]);const c=u=>u*Math.PI/180;return i.jsx("div",{className:"motif-orbit",children:a.map((u,d)=>{const h=e+u.radius*Math.cos(c(u.angle)),g=t+u.radius*Math.sin(c(u.angle));return i.jsx("div",{className:"motif-tag",style:{left:`${h}px`,top:`${g}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${d}`)})})},Af=({album:n,isPlaying:e,currentTime:t,duration:s,volume:a,isMuted:r,shuffle:o,repeat:l,canPrevious:c,canNext:u,visualizationMode:d,queue:h,queueIndex:g,frequencyData:f,timeDomainData:p,onPlayPause:m,onPrevious:_,onNext:y,onSeek:x,onVolumeChange:S,onMuteToggle:A,onShuffle:b,onRepeat:T,onVisualizationModeChange:j,onSkipToIndex:v,onClose:N})=>{const{updateAlbum:E}=xt(),O=n?.id||null,[M,D]=w.useState("");w.useEffect(()=>{D(n?.memo||"")},[O]),w.useEffect(()=>{const R=B=>{B.key==="Escape"?N():B.key===" "&&B.target===document.body?(B.preventDefault(),m()):B.key==="ArrowLeft"?x(Math.max(0,t-5)):B.key==="ArrowRight"?x(Math.min(s,t+5)):B.key==="ArrowUp"?S(Math.min(1,a+.1)):B.key==="ArrowDown"?S(Math.max(0,a-.1)):B.key==="m"||B.key==="M"?A():B.key==="n"||B.key==="N"?y():(B.key==="p"||B.key==="P")&&_()};return document.addEventListener("keydown",R),()=>document.removeEventListener("keydown",R)},[t,s,a,N,m,x,S,A,y,_]);const k="#D4AF37",L=n?.metadata?.motif_tags||[],V=w.useMemo(()=>"メモ（ひとこと）。聴きながら思い出したこと、今の気分、景色…",[]);return i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"expanded-player-backdrop",onClick:N}),i.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[i.jsx("button",{className:"expanded-player-close",onClick:N,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),i.jsx("button",{className:"expanded-player-minimize",onClick:N,"aria-label":"Minimize player",title:"Minimize",children:"-"}),i.jsxs("div",{className:"expanded-player-content",children:[i.jsxs("div",{className:"expanded-player-album-section",children:[i.jsx("div",{className:"expanded-player-album-container",children:n&&i.jsxs(i.Fragment,{children:[i.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"expanded-player-album-image"}),L.length>0&&i.jsx(Cf,{tags:L,centerX:200,centerY:200,isPlaying:e})]})}),n&&i.jsxs("div",{className:"expanded-player-album-meta",children:[i.jsx("h2",{className:"expanded-player-album-title",children:n.title||n.mood}),n.musicMetadata&&i.jsxs("p",{className:"expanded-player-album-details",children:[n.musicMetadata.key," • ",n.musicMetadata.tempo," BPM • ",n.musicMetadata.timeSignature]}),n.musicMetadata?.character&&i.jsx("p",{className:"expanded-player-album-character",children:n.musicMetadata.character}),i.jsxs("div",{className:"expanded-player-memo",children:[i.jsx("div",{className:"expanded-player-memo-label",children:"メモ"}),i.jsx("textarea",{className:"expanded-player-memo-input",value:M,onChange:R=>D(R.target.value),onBlur:()=>{if(!n)return;const R=M.trim();(n.memo||"")!==R&&E(n.id,{memo:R||void 0})},placeholder:V,rows:2})]})]})]}),i.jsxs("div",{className:"expanded-player-visualization-section",children:[i.jsx(kf,{mode:d,frequencyData:f,timeDomainData:p,isPlaying:e,dominantColor:k,width:800,height:200}),i.jsxs("div",{className:"visualization-mode-toggle",children:[i.jsx("button",{className:d==="waveform"?"active":"",onClick:()=>j("waveform"),title:"Waveform",children:"波形"}),i.jsx("button",{className:d==="spectrum"?"active":"",onClick:()=>j("spectrum"),title:"Spectrum Bars",children:"バー"}),i.jsx("button",{className:d==="radial"?"active":"",onClick:()=>j("radial"),title:"Radial Spectrum",children:"円形"})]})]}),i.jsxs("div",{className:"expanded-player-controls-section",children:[i.jsx(wf,{isPlaying:e,canPrevious:c,canNext:u,shuffle:o,repeat:l,onPlayPause:m,onPrevious:_,onNext:y,onShuffle:b,onRepeat:T,expanded:!0}),i.jsx(Nf,{currentTime:t,duration:s,onSeek:x,color:k}),i.jsx(Sf,{volume:a,isMuted:r,onVolumeChange:S,onMuteToggle:A,expanded:!0})]}),i.jsx(jf,{queue:h,currentIndex:g,onSkipTo:v})]})]})]})},Ef=({album:n,queue:e=[]})=>{const{state:t,setPlaybackState:s,setCurrentTime:a,setDuration:r,setVolume:o,toggleMute:l,toggleShuffle:c,cycleRepeat:u,toggleExpanded:d,setVisualizationMode:h,play:g,pause:f,next:p,previous:m,skipToIndex:_,setQueue:y,setCurrentAlbumFull:x}=Ot(),S=w.useRef(bf()),A=w.useRef(null),b=w.useRef(null),T=w.useRef(null),j=w.useRef(null),v=w.useRef(0),N=w.useRef(0),[E,O]=w.useState(null),[M,D]=w.useState(null);w.useEffect(()=>((async()=>{try{await co();const C=yf.createAnalyser();C.fftSize=2048,C.smoothingTimeConstant=.8,vf().connect(C),A.current=C,b.current=new Uint8Array(C.frequencyBinCount),T.current=new Uint8Array(C.frequencyBinCount)}catch(C){console.error("Failed to initialize analyser:",C)}})(),()=>{if(A.current)try{A.current.disconnect()}catch{}}),[]),w.useEffect(()=>{if(e.length>0){const P=n?e.findIndex(C=>C.id===n.id):0;y(e,Math.max(0,P))}else n&&y([n],0)},[n,e,y]),w.useEffect(()=>{const P=t.currentAlbum||n;P?.musicData&&(k(P),x(P))},[t.currentAlbum?.id,n?.id]),w.useEffect(()=>{t.playRequestId>0&&(v.current=t.playRequestId)},[t.playRequestId]),w.useEffect(()=>{const P=t.currentAlbum||n,C=v.current;if(!P?.musicData||C===0||C===N.current)return;let W=!1;return(async()=>{try{if(await k(P),W)return;await L(),N.current=C}catch(oe){console.error("[EnhancedMiniPlayer] Autoplay failed:",oe)}})(),()=>{W=!0}},[t.currentAlbum?.id,n?.id,t.playRequestId]),w.useEffect(()=>{if(t.playbackState===ut.PLAYING&&A.current){let P;const C=()=>{!A.current||!b.current||!T.current||(A.current.getByteFrequencyData(b.current),A.current.getByteTimeDomainData(T.current),O(new Uint8Array(b.current)),D(new Uint8Array(T.current)),P=requestAnimationFrame(C))};return P=requestAnimationFrame(C),()=>{P&&cancelAnimationFrame(P)}}},[t.playbackState]);const k=async P=>{try{const C=S.current;await C.loadMIDI(P.musicData);const W=C.getState();r(W.duration)}catch(C){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",C)}},L=async()=>{try{s(ut.LOADING);const P=S.current;await P.play(),g();const C=window.setInterval(()=>{const W=P.getState();a(W.currentTime),r(W.duration),!W.isPlaying&&!W.isPaused&&(clearInterval(C),R())},100);j.current=C}catch(P){console.error("Failed to start playback:",P),s(ut.STOPPED)}},V=()=>{S.current.pause(),f(),j.current&&(clearInterval(j.current),j.current=null)},R=()=>{t.repeat==="one"?(X(0),L()):Y()},B=()=>{t.playbackState===ut.PLAYING?V():L()},Y=()=>{p(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{L()})})},H=()=>{m(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{L()})})},X=P=>{S.current.seek(P),a(P)},ee=P=>{o(P)},$=P=>{_(P),requestAnimationFrame(()=>{requestAnimationFrame(()=>{L()})})},Q=t.queueIndex>0||t.repeat==="all",U=t.queueIndex<t.queue.length-1||t.repeat==="all",I=t.playbackState===ut.PLAYING;return w.useEffect(()=>()=>{j.current&&clearInterval(j.current)},[]),i.jsxs(i.Fragment,{children:[!t.isExpanded&&i.jsx(xf,{album:t.currentAlbum,isPlaying:I,currentTime:t.currentTime,duration:t.duration,onPlayPause:B,onExpand:d}),t.isExpanded&&i.jsx(Af,{album:t.currentAlbum,isPlaying:I,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:Q,canNext:U,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:E,timeDomainData:M,onPlayPause:B,onPrevious:H,onNext:Y,onSeek:X,onVolumeChange:ee,onMuteToggle:l,onShuffle:c,onRepeat:u,onVisualizationModeChange:h,onSkipToIndex:$,onClose:d})]})};function Mf(){const{state:n}=Ot(),e=!!n.currentAlbumImage&&(n.playbackState===ut.PLAYING||n.playbackState===ut.PAUSED),t=w.useMemo(()=>`${n.currentAlbum?.id||"none"}:${n.playbackState}`,[n.currentAlbum?.id,n.playbackState]),[s,a]=w.useState(!1);return w.useEffect(()=>{const r=window.setTimeout(()=>a(e),e?40:0);return()=>window.clearTimeout(r)},[e]),n.currentAlbumImage?i.jsx("div",{className:`playback-backdrop ${s?"is-active":""} ${n.playbackState===ut.PLAYING?"is-playing":""}`,style:{backgroundImage:`url(${n.currentAlbumImage})`},"aria-hidden":"true"},t):null}function If(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function Df(){try{new Function('return import("web-vitals")')().then(e=>{const t=s=>{console.log("[Web Vitals]",s)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}function Of(){const n=document.createElement("script");n.type="module",n.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const e=document.createElement("script");e.type="module",e.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(n),document.head.appendChild(e)}If(),Df(),Of();const Rf="airia_onboarding_data",Pf="airia_theme",Wa="airia_post_onboarding_room",kt="airia_preauth_view_v1";function Ba(){try{const n=String(window.location.hash||"").trim().toLowerCase();return n==="#terms"?"terms":n==="#privacy"?"privacy":n==="#login"||n==="#signup"?"auth":null}catch{return null}}function Ff(){try{const n=localStorage.getItem(Pf),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n||"system",s=t==="system"?e?"dark":"light":t;document.documentElement.setAttribute("data-theme",s)}catch{document.documentElement.setAttribute("data-theme","light")}}function Ua(){try{if(Cs())return!1;const n=localStorage.getItem(Rf);return n?!!JSON.parse(n)?.completedAt:!1}catch{return!1}}function Lf(){try{const n=localStorage.getItem(Wa);if(!n)return null;localStorage.removeItem(Wa);const e=String(n);return["main","gallery","album","music","social","me","settings","admin","info","feedback"].includes(e)?e:null}catch{return null}}const Vf=()=>{const[n,e]=w.useState(!0),[t,s]=w.useState(()=>{try{const A=Ba();if(A)return A;const b=sessionStorage.getItem(kt);return b==="auth"||b==="terms"||b==="privacy"?b:"landing"}catch{return"landing"}}),[a,r]=w.useState(()=>{try{return Ua()}catch{return!1}}),{getSelectedAlbum:o,albums:l}=xt(),{state:c}=Ot(),{user:u,loading:d}=Os(),h=o();w.useEffect(()=>{const A=()=>{const b=Ba();if(b){s(b);try{sessionStorage.setItem(kt,b)}catch{}return}try{const j=sessionStorage.getItem(kt)==="auth"?"auth":"landing";s(j),sessionStorage.setItem(kt,j)}catch{s("landing")}};return window.addEventListener("hashchange",A),()=>window.removeEventListener("hashchange",A)},[]);const g=F.useCallback(()=>{s("auth");try{sessionStorage.setItem(kt,"auth"),window.location.hash="#login"}catch{}},[]),f=F.useCallback(()=>{s("landing");try{sessionStorage.setItem(kt,"landing"),window.location.hash=""}catch{}},[]),p=F.useCallback(()=>{s("terms");try{sessionStorage.setItem(kt,"terms"),window.location.hash="#terms"}catch{}},[]),m=F.useCallback(()=>{s("privacy");try{sessionStorage.setItem(kt,"privacy"),window.location.hash="#privacy"}catch{}},[]);w.useEffect(()=>{Ff()},[]);const _=l.filter(A=>A.musicData),y=!!(As()||"".toLowerCase()==="true"),x=a?[{id:"main",name:"Main",component:i.jsx(Gc,{})},{id:"gallery",name:"Gallery",component:i.jsx(Jc,{})},{id:"album",name:"Album",component:i.jsx(sl,{})},{id:"music",name:"Music",component:i.jsx(nl,{})},{id:"social",name:"Social",component:i.jsx(dl,{})},{id:"me",name:"My",component:i.jsx(ml,{})},{id:"settings",name:"Settings",component:i.jsx(vl,{})},...y?[{id:"admin",name:"Admin",component:i.jsx(bl,{})}]:[],{id:"info",name:"Info",component:i.jsx(Sl,{})},{id:"feedback",name:"Feedback",component:i.jsx(jl,{})}]:[{id:"onboarding",name:"はじめに",component:i.jsx(Rc,{onExit:()=>{r(Ua())}})}],S=a?Lf()??"main":"onboarding";return i.jsxs(i.Fragment,{children:[n&&i.jsx(Tl,{onDismiss:()=>e(!1)}),!n&&i.jsxs(i.Fragment,{children:[i.jsx(Mf,{}),i.jsx("div",{className:"app-ui-layer",children:d?i.jsx("div",{style:{padding:24,opacity:.8},children:"Loading..."}):u?i.jsxs(i.Fragment,{children:[i.jsx(tc,{rooms:x,initialRoom:S},a?"onboarded":"needs-onboarding"),i.jsx(Ef,{album:h||void 0,queue:_})]}):i.jsx("div",{className:"preauth-shell",children:t==="auth"?i.jsx(Fc,{onBack:f}):t==="terms"?i.jsx(va,{kind:"terms",onBack:f,onStart:g}):t==="privacy"?i.jsx(va,{kind:"privacy",onBack:f,onStart:g}):i.jsx(Lc,{onStart:g,onOpenTerms:p,onOpenPrivacy:m})})})]})]})},qf=()=>i.jsx(F.StrictMode,{children:i.jsx(Yo,{children:i.jsx(Ro,{children:i.jsx(Bo,{children:i.jsx(Mo,{children:i.jsx($o,{children:i.jsx(Go,{children:i.jsx(Vf,{})})})})})})})});Eo.createRoot(document.getElementById("root")).render(i.jsx(qf,{}));
//# sourceMappingURL=index-CATYnk3e.js.map
