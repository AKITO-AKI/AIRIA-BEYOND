var Mc=Object.defineProperty;var Ec=(n,e,t)=>e in n?Mc(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var It=(n,e,t)=>Ec(n,typeof e!="symbol"?e+"":e,t);import{r as _,j as r,R,a as Pc,C as Kn,u as Sn,V as Zt,B as ps,L as Oc,b as Pn,c as sa,M as Dc,D as Ha,d as Xa,N as Hs,e as ra,f as Rc,T as Fc,S as Lc,H as ia,g as Ws,h as Vc,P as Uc,i as Bc,k as Dn,l as qc}from"./vendor-three-CT2GzliT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const Ur=n=>{if(!n)return 30;const e=20,t=60,s=30,i=180,a=Math.max(s,Math.min(i,n));return e+(a-s)/(i-s)*(t-e)},aa=n=>{const t=Math.floor(n/10),s=n%10;return{shelfIndex:Math.min(t,4),positionIndex:s}},Br=n=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let s=0;s<n.length;s++)t=(t<<5)-t+n.charCodeAt(s),t=t&t;return e[Math.abs(t)%e.length]},Ja=_.createContext(void 0),oa="airia-albums",Wc=({children:n})=>{const[e,t]=_.useState([]),[s,i]=_.useState(null);_.useEffect(()=>{try{const u=localStorage.getItem(oa);if(u){const d=JSON.parse(u);t(d)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),_.useEffect(()=>{try{localStorage.setItem(oa,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const a=u=>{const d={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()},h=aa(0),m=Ur(d.musicMetadata?.duration),f=Br(d.imageDataURL),p={...d,gallery:{shelfIndex:h.shelfIndex,positionIndex:h.positionIndex,thickness:m,spineColor:f}};return t(g=>[p,...g].map((y,w)=>{const N=aa(w),j=Ur(y.musicMetadata?.duration),x=y.gallery?.spineColor||Br(y.imageDataURL);return{...y,gallery:{shelfIndex:N.shelfIndex,positionIndex:N.positionIndex,thickness:j,spineColor:x}}})),p},o=(u,d)=>{t(h=>h.map(m=>{if(m.id!==u)return m;const f={...m,...d};if(d.imageDataURL){const p=f.gallery?.spineColor||Br(f.imageDataURL);return{...f,gallery:{...f.gallery||{shelfIndex:0,positionIndex:0,thickness:Ur(f.musicMetadata?.duration),spineColor:p},spineColor:p}}}return f}))},l=u=>{i(u)},c=()=>s&&e.find(u=>u.id===s)||null;return r.jsx(Ja.Provider,{value:{albums:e,selectedAlbumId:s,addAlbum:a,updateAlbum:o,selectAlbum:l,getSelectedAlbum:c},children:n})},qt=()=>{const n=_.useContext(Ja);if(n===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return n},Ka=_.createContext(void 0),qr="airia-causal-logs",$c=30;function Gc(n){return n&&{mood:n.mood,duration:n.duration,timestamp:n.timestamp,customInput:n.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:n.onboardingAnswers?"[onboarding data - summary only]":void 0}}function zc(n){const e=new Date;return e.setDate(e.getDate()-$c),n.filter(t=>new Date(t.createdAt)>=e)}const Yc=({children:n})=>{const[e,t]=_.useState([]);_.useEffect(()=>{try{const h=localStorage.getItem(qr);if(h){const f=JSON.parse(h).map(g=>({...g,createdAt:new Date(g.createdAt),input:{...g.input,timestamp:new Date(g.input.timestamp)},analysis:g.analysis?{...g.analysis,timestamp:new Date(g.analysis.timestamp)}:void 0,imageGeneration:g.imageGeneration?{...g.imageGeneration,timestamp:new Date(g.imageGeneration.timestamp)}:void 0,musicGeneration:g.musicGeneration?{...g.musicGeneration,timestamp:new Date(g.musicGeneration.timestamp)}:void 0,album:g.album?{...g.album,timestamp:new Date(g.album.timestamp)}:void 0,errors:g.errors?.map(v=>({...v,timestamp:new Date(v.timestamp)}))})),p=zc(f);t(p)}}catch(h){console.error("[CausalLog] Failed to load logs from localStorage:",h)}},[]),_.useEffect(()=>{try{localStorage.setItem(qr,JSON.stringify(e))}catch(h){console.error("[CausalLog] Failed to save logs to localStorage:",h)}},[e]);const s=(h,m)=>{const f=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,p={id:f,sessionId:h,createdAt:new Date,input:Gc(m),totalDuration:0,success:!1};return t(g=>[...g,p]),console.log("[CausalLog] Created log:",f,"for session:",h),f},i=h=>e.find(m=>m.id===h),a=h=>e.find(m=>m.sessionId===h),o=(h,m)=>{t(f=>f.map(p=>{if(p.id===h){const g={...p,...m};if(g.analysis||g.imageGeneration||g.musicGeneration){const v=[g.analysis?.duration||0,g.imageGeneration?.duration||0,g.musicGeneration?.duration||0];g.totalDuration=v.reduce((y,w)=>y+w,0)}return g}return p})),console.log("[CausalLog] Updated log:",h)},l=h=>{t(m=>m.filter(f=>f.id!==h)),console.log("[CausalLog] Deleted log:",h)},c=()=>{t([]),localStorage.removeItem(qr),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(h=>({id:h.id,sessionId:h.sessionId,createdAt:h.createdAt,success:h.success,totalDuration:h.totalDuration,albumId:h.album?.albumId})),d=h=>{const m=i(h);if(!m)throw new Error(`Log ${h} not found`);return JSON.stringify(m,null,2)};return r.jsx(Ka.Provider,{value:{logs:e,createLog:s,getLog:i,getLogBySessionId:a,updateLog:o,deleteLog:l,clearAllLogs:c,getLogSummaries:u,exportLog:d},children:n})},Za=()=>{const n=_.useContext(Ka);if(n===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return n},wt="https://airia-beyond.onrender.com",Zr="airia_auth_token_v1";function $s(){try{return String(localStorage.getItem(Zr)||"")}catch{return""}}function In(n){try{n?localStorage.setItem(Zr,n):localStorage.removeItem(Zr)}catch{}}async function yt(n,e={}){const t=$s(),s=new Headers(e.headers||{});return t&&s.set("Authorization",`Bearer ${t}`),fetch(n,{...e,headers:s})}async function rn(n){return n.json().catch(()=>null)}function fs(n){const e=n instanceof Error?n.message:String(n);return/failed to fetch/i.test(e)||/networkerror/i.test(e)||/load failed/i.test(e)||/timeout/i.test(e)}function gs(n){const e=wt,t=(()=>{try{return window.location.origin}catch{return"(unknown)"}})();return[`${n} に失敗しました（通信エラー）`,`API: ${e}`,`Origin: ${t}`,"原因候補: VITE_API_BASE_URL 未設定/誤り、APIサーバ停止、CORS未許可（Render側 APP_PUBLIC_URL / APP_ALLOWED_ORIGINS）"].join(`
`)}function vs(n){try{if(window.location.protocol==="https:"&&/^http:\/\//i.test(wt))throw new Error(`${n} に失敗しました（Mixed Content）。
HTTPS のページから HTTP の API（${wt}）へは接続できません。API を https:// にするか、VITE_API_BASE_URL をHTTPSのURLにしてください。`)}catch{}}async function ys(n,e,t){const s=String(n.headers.get("content-type")||"").toLowerCase();if(e==null){if(n.ok&&s.includes("text/html"))throw new Error(`${t} に失敗しました（API応答がHTMLでした）。VITE_API_BASE_URL がフロントに向いている可能性があります。`);if(n.ok&&!s.includes("application/json"))throw new Error(`${t} に失敗しました（API応答がJSONではありません）。API設定を確認してください。`)}}async function Hc(n){try{vs("新規登録");const e=await fetch(`${wt}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await rn(e);if(await ys(e,t,"新規登録"),!e.ok)throw new Error(t?.message||`Failed to register: ${e.status}`);if(!t?.user)throw new Error("新規登録に失敗しました（API応答が不正です）");return t}catch(e){throw fs(e)?new Error(gs("新規登録")):e}}async function Xc(n){try{vs("ログイン");const e=await fetch(`${wt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await rn(e);if(await ys(e,t,"ログイン"),!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);if(!t?.token||!t?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return t}catch(e){throw fs(e)?new Error(gs("ログイン")):e}}async function Jc(n){try{vs("ログイン");const e=await fetch(`${wt}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await rn(e);if(await ys(e,t,"ログイン"),!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);if(!t?.token||!t?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return t}catch(e){throw fs(e)?new Error(gs("ログイン")):e}}async function ca(n,e){try{vs("ログイン");const t=await fetch(`${wt}/api/auth/oauth/${encodeURIComponent(n)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await rn(t);if(await ys(t,s,"OAuthログイン"),!t.ok)throw new Error(s?.message||`Failed to login: ${t.status}`);if(!s?.token||!s?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return s}catch(t){throw fs(t)?new Error(gs("ログイン")):t}}async function Kc(){const n=await yt(`${wt}/api/auth/me`),e=await rn(n);if(!n.ok)throw new Error(e?.message||`Failed to load me: ${n.status}`);return e}async function Zc(){const n=await yt(`${wt}/api/auth/logout`,{method:"POST"}),e=await rn(n);if(!n.ok)throw new Error(e?.message||`Failed to logout: ${n.status}`);return e}async function Qc(n){const e=await yt(`${wt}/api/auth/me`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await rn(e);if(!e.ok)throw new Error(t?.message||`Failed to update profile: ${e.status}`);return t}async function el(){try{vs("認証設定の取得");const n=await fetch(`${wt}/api/auth/config`),e=await rn(n);if(await ys(n,e,"認証設定の取得"),!n.ok)throw new Error(e?.message||`Failed to load auth config: ${n.status}`);return e}catch(n){throw fs(n)?new Error(gs("認証設定の取得")):n}}const Qa=R.createContext(null);function hr(){const n=R.useContext(Qa);if(!n)throw new Error("useAuth must be used within AuthProvider");return n}const tl=({children:n})=>{const[e,t]=R.useState(null),[s,i]=R.useState(!0),[a,o]=R.useState(!1),[l,c]=R.useState(()=>$s()),u=R.useRef(0),d=R.useRef(!1),h=R.useCallback(()=>(u.current+=1,u.current),[]),m=R.useCallback(k=>u.current===k,[]),f=R.useCallback(async()=>{const k=h(),S=$s();if(c(S),!S){m(k)&&(t(null),i(!1));return}try{const b=S,T=await Kc();if(!m(k)||$s()!==b)return;t(T.user),T.user||(In(null),c(""))}catch(b){if(!m(k))return;const T=b instanceof Error?b.message:String(b);/failed to fetch/i.test(T)||/networkerror/i.test(T)||/load failed/i.test(T)||/timeout/i.test(T)||t(null)}finally{m(k)&&i(!1)}},[h,m]);R.useEffect(()=>{d.current||(d.current=!0,f())},[f]);const p=R.useCallback(async k=>{const S=h();o(!0);try{const b=await ca("google",{idToken:k});if(!m(S))return;In(b.token),c(b.token),t(b.user)}finally{m(S)&&o(!1)}},[h,m]),g=R.useCallback(async(k,S)=>{const b=h();o(!0);try{const T=await ca("apple",{idToken:k,user:S||void 0});if(!m(b))return;In(T.token),c(T.token),t(T.user)}finally{m(b)&&o(!1)}},[h,m]),v=R.useCallback(async k=>{const S=h();o(!0);try{const b=String(k?.identifier||"").trim(),T=String(k?.password||""),A=b.includes("@")?await Jc({email:b,password:T}):await Xc({handle:b,password:T});if(!m(S))return;In(A.token),c(A.token),t(A.user)}finally{m(S)&&o(!1)}},[h,m]),y=R.useCallback(async k=>{const S=h();o(!0);try{const b=String(k?.email||"").trim(),T=String(k?.password||""),A=k?.displayName,P=k?.handle;if(await Hc({email:b,password:T,displayName:A,handle:P}),!m(S))return;In(null),c(""),t(null)}finally{m(S)&&o(!1)}},[h,m]),w=R.useCallback(async()=>{const k=h();o(!0);try{await Zc().catch(()=>null)}finally{m(k)&&(In(null),c(""),t(null),o(!1))}},[h,m]),N=R.useCallback(async k=>{const S=h();o(!0);try{const b=await Qc(k);if(!m(S))return;t(b.user)}finally{m(S)&&o(!1)}},[h,m]),j=R.useCallback(k=>{t(S=>S&&{...S,followingIds:Array.isArray(k)?k:[]})},[]),x={user:e,bootLoading:s,busy:a,token:l,refresh:f,loginWithGoogle:p,loginWithApple:g,loginWithPassword:v,registerWithPassword:y,logout:w,updateProfile:N,updateFollowingIds:j};return r.jsx(Qa.Provider,{value:x,children:n})};var bt=(n=>(n.STOPPED="STOPPED",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.LOADING="LOADING",n))(bt||{});const eo=_.createContext(void 0),nl=.7,sl=({children:n})=>{const[e,t]=_.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:nl,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),s=_.useCallback(b=>{t(T=>({...T,playbackState:b?"PLAYING":"PAUSED"}))},[]),i=_.useCallback((b,T)=>{t(A=>({...A,currentAlbumImage:b,currentTrackTitle:T}))},[]),a=_.useCallback(b=>{t(T=>({...T,playbackState:b}))},[]),o=_.useCallback(b=>{t(T=>({...T,currentAlbum:b,currentAlbumImage:b?.imageDataURL,currentTrackTitle:b?b.title||b.mood:void 0}))},[]),l=_.useCallback((b,T=0)=>{t(A=>({...A,queue:b,queueIndex:T,currentAlbum:b[T]||null,currentAlbumImage:b[T]?.imageDataURL,currentTrackTitle:b[T]?b[T].title||b[T].mood:void 0}))},[]),c=_.useCallback(b=>{t(T=>({...T,currentTime:b}))},[]),u=_.useCallback(b=>{t(T=>({...T,duration:b}))},[]),d=_.useCallback(b=>{const T=Math.max(0,Math.min(1,b));t(A=>({...A,volume:T}))},[]),h=_.useCallback(()=>{t(b=>({...b,isMuted:!b.isMuted}))},[]),m=_.useCallback(()=>{t(b=>({...b,shuffle:!b.shuffle}))},[]),f=_.useCallback(()=>{t(b=>{const T=["off","all","one"],P=(T.indexOf(b.repeat)+1)%T.length;return{...b,repeat:T[P]}})},[]),p=_.useCallback(()=>{t(b=>({...b,isExpanded:!b.isExpanded}))},[]),g=_.useCallback(b=>{t(T=>({...T,isExpanded:b}))},[]),v=_.useCallback(b=>{t(T=>({...T,visualizationMode:b}))},[]),y=_.useCallback((b,T)=>{t(A=>{const P=T&&T.length>0?T:A.queue,O=P.length>0?P:[b],U=Math.max(0,O.findIndex(I=>I.id===b.id)),E=O[U]||b;return{...A,queue:O,queueIndex:U,currentAlbum:E,currentAlbumImage:E.imageDataURL,currentTrackTitle:E.title||E.mood,currentTime:0,playRequestId:A.playRequestId+1,isExpanded:!0}})},[]),w=_.useCallback(()=>{t(b=>({...b,playbackState:"PLAYING"}))},[]),N=_.useCallback(()=>{t(b=>({...b,playbackState:"PAUSED"}))},[]),j=_.useCallback(()=>{t(b=>({...b,playbackState:"STOPPED",currentTime:0}))},[]),x=_.useCallback(()=>{t(b=>{if(b.queue.length===0)return b;let T=b.queueIndex+1;if(T>=b.queue.length)if(b.repeat==="all")T=0;else return{...b,playbackState:"STOPPED"};const A=b.queue[T];return{...b,queueIndex:T,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]),k=_.useCallback(()=>{t(b=>{if(b.queue.length===0)return b;if(b.currentTime>3)return{...b,currentTime:0};let T=b.queueIndex-1;if(T<0)if(b.repeat==="all")T=b.queue.length-1;else return b;const A=b.queue[T];return{...b,queueIndex:T,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]),S=_.useCallback(b=>{t(T=>{if(b<0||b>=T.queue.length)return T;const A=T.queue[b];return{...T,queueIndex:b,currentAlbum:A,currentAlbumImage:A.imageDataURL,currentTrackTitle:A.mood,currentTime:0}})},[]);return r.jsx(eo.Provider,{value:{state:e,setPlaying:s,setCurrentAlbum:i,setPlaybackState:a,setCurrentAlbumFull:o,setQueue:l,setCurrentTime:c,setDuration:u,setVolume:d,toggleMute:h,toggleShuffle:m,cycleRepeat:f,toggleExpanded:p,setExpanded:g,setVisualizationMode:v,requestPlayAlbum:y,play:w,pause:N,stop:j,next:x,previous:k,skipToIndex:S},children:n})},an=()=>{const n=_.useContext(eo);if(!n)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return n},to=_.createContext(void 0),bs=()=>{const n=_.useContext(to);if(!n)throw new Error("useToast must be used within ToastProvider");return n},rl=({children:n})=>{const[e,t]=_.useState([]),s=_.useCallback((a,o,l=4e3)=>{const c=`toast-${Date.now()}-${Math.random()}`,u={id:c,type:a,message:o,duration:l};t(h=>[...h,u]);const d=setTimeout(()=>{i(c)},l);return()=>clearTimeout(d)},[]),i=_.useCallback(a=>{t(o=>o.filter(l=>l.id!==a))},[]);return r.jsxs(to.Provider,{value:{toasts:e,addToast:s,removeToast:i},children:[n,r.jsx(il,{toasts:e})]})},il=({toasts:n})=>r.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:n.map(e=>r.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[r.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),r.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class al extends _.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(i=>{i.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?r.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[r.jsx("h1",{children:"エラーが発生しました"}),r.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),r.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const no=_.createContext(void 0),ol=({value:n,children:e})=>r.jsx(no.Provider,{value:n,children:e}),$t=()=>{const n=_.useContext(no);if(!n)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return n},so=({open:n,onOpenChange:e,title:t,description:s,children:i,footer:a,size:o="md"})=>{const l=_.useId(),c=_.useId();return _.useEffect(()=>{if(!n)return;const u=d=>{d.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[n,e]),n?Pc.createPortal(r.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[r.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),r.jsxs("div",{className:`dialog-surface dialog-${o}`,role:"dialog","aria-modal":"true","aria-labelledby":l,"aria-describedby":s?c:void 0,children:[r.jsxs("header",{className:"dialog-header",children:[r.jsxs("div",{children:[r.jsx("h2",{id:l,className:"dialog-title",children:t}),s&&r.jsx("p",{id:c,className:"dialog-description",children:s})]}),r.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),r.jsx("div",{className:"dialog-body",children:i}),a?r.jsx("footer",{className:"dialog-footer",children:a}):null]})]}),document.body):null},la="airia_feedback_nudge_open_count_v1",ua="airia_feedback_nudge_last_shown_at_v1";function cl(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function ll(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function ul(n){try{const e=localStorage.getItem(n),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function dl(n,e){try{localStorage.setItem(n,String(Math.trunc(e)))}catch{}}function hl(n){return n?(Date.now()-n)/(24*60*60*1e3):Number.POSITIVE_INFINITY}const ml=()=>{const{currentRoomId:n,navigateToRoom:e}=$t(),[t,s]=R.useState(!1),i=R.useRef(null);R.useEffect(()=>{if(n==="onboarding"||n==="feedback")return;const o=cl(la)+1;ll(la,o);const l=ul(ua);if(hl(l)<10||o<4)return;const u=o<10?.05:.08;if(!(Math.random()>u))return i.current=window.setTimeout(()=>{document.visibilityState==="visible"&&(dl(ua,Date.now()),s(!0))},7e3),()=>{i.current&&window.clearTimeout(i.current),i.current=null}},[n]);const a=()=>{s(!1),e("feedback")};return r.jsx(so,{open:t,onOpenChange:s,title:"フィードバックしませんか？",description:"短くてOK。気づいたことを教えてください。",size:"sm",footer:r.jsxs(r.Fragment,{children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>s(!1),children:"今はしない"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:a,children:"書く"})]}),children:r.jsx("p",{style:{margin:0,lineHeight:1.7},children:"バグ報告・改善案・良かった点、どれでも歓迎です。 送信時に診断情報も添付できるので、原因調査が早くなります。"})})},pl="/img/airia-logo.png",fl={main:"会話を育てて、創作の種をつくる。",gallery:"作品の棚。選んで、開いて、再生して、公開する。",album:"選択した作品の詳細・再生・公開設定。",music:"音楽付きアルバムを再生・ライブラリ管理。",social:"作品を公開して、反応を集める。",me:"あなたのプロフィールと投稿。",settings:"プロフィールと各種設定。",admin:"ユーザーアクション監視ログ（リアルタイム）。",info:"このアプリについて。",feedback:"改善のために、気づいたことを送る。"};function gl({roomId:n}){const e={width:18,height:18,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0};switch(n){case"main":return r.jsx("svg",{...e,children:r.jsx("path",{d:"M4 11.5L12 5l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-8.5z",stroke:"currentColor",strokeWidth:"1.8"})});case"gallery":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M5 6.5A2.5 2.5 0 0 1 7.5 4h9A2.5 2.5 0 0 1 19 6.5v11A2.5 2.5 0 0 1 16.5 20h-9A2.5 2.5 0 0 1 5 17.5v-11z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M8 14l2.2-2.2a1 1 0 0 1 1.4 0L15 15l1.2-1.2a1 1 0 0 1 1.4 0L19 15.2",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"}),r.jsx("path",{d:"M9 9.5h.01",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round"})]});case"album":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M7 4h10a2 2 0 0 1 2 2v14H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M9 8h8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M9 12h8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"music":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M10 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M18 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M12 16V6l8-2v10",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})]});case"social":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M8.5 13.5a3 3 0 1 1 0-6 3 3 0 0 1 0 6z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M16.5 12.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M4.5 20c.6-2.9 2.7-4.8 6-4.8s5.4 1.9 6 4.8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M14 20c.3-1.8 1.4-3.1 3.4-3.1 1.8 0 2.7.6 3.1 1.7",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"me":case"settings":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 12.4a3.4 3.4 0 1 0 0-6.8 3.4 3.4 0 0 0 0 6.8z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M5 20c.9-3.6 3.6-5.6 7-5.6s6.1 2 7 5.6",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"admin":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 2l8 4v6c0 5-3.4 9.6-8 10-4.6-.4-8-5-8-10V6l8-4z",stroke:"currentColor",strokeWidth:"1.8",strokeLinejoin:"round"}),r.jsx("path",{d:"M9.2 12.3l1.8 1.9 3.9-4.3",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})]});case"info":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M12 10.6V16",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M12 8.2h.01",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round"})]});case"feedback":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M5 6.5A2.5 2.5 0 0 1 7.5 4h9A2.5 2.5 0 0 1 19 6.5v7A2.5 2.5 0 0 1 16.5 16H11l-4.2 3.2c-.6.5-1.8.1-1.8-.8V6.5z",stroke:"currentColor",strokeWidth:"1.8",strokeLinejoin:"round"}),r.jsx("path",{d:"M8.2 8.8h7.6",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M8.2 12h5.2",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});default:return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M6 12h12",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M12 6v12",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]})}}const vl=({rooms:n,initialRoom:e="main"})=>{const t=n.findIndex($=>$.id===e),[s,i]=_.useState(t>=0?t:0),[a,o]=_.useState(!1),[l,c]=_.useState(!0),[u,d]=_.useState(!1),[h,m]=_.useState(0),[f,p]=_.useState(0),[g,v]=_.useState(0),[y,w]=_.useState(null),N=_.useRef(null);_.useEffect(()=>{const $=window.matchMedia("(max-width: 860px)"),ee=()=>{o($.matches)};return ee(),typeof $.addEventListener=="function"?($.addEventListener("change",ee),()=>$.removeEventListener("change",ee)):($.addListener(ee),()=>$.removeListener(ee))},[]),_.useEffect(()=>{c(!a)},[a]);const j=$=>{if(!($ instanceof Element))return null;const ee=$.closest(".room");return!(ee instanceof HTMLElement)||ee.scrollWidth<=ee.clientWidth+1&&ee.scrollHeight<=ee.clientHeight+1?null:ee},x=$=>$ instanceof Element?!!$.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,k=$=>{x($.target)||(d(!0),m($.touches[0].clientX),p($.touches[0].clientY),w(null))},S=$=>{if(!u)return;const ee=$.touches[0].clientX,V=$.touches[0].clientY,C=ee-h,L=V-f;if(!y){const M=Math.abs(C),J=Math.abs(L);if(M<6&&J<6)return;if(J>M*1.2){w("vertical"),d(!1),v(0);return}const X=j($.target);if(X&&X.scrollWidth>X.clientWidth+1){const se=X.scrollWidth-X.clientWidth,ve=X.scrollLeft>0,ke=X.scrollLeft<se-1;if(C>0&&ve||C<0&&ke){d(!1),v(0),w(null);return}}w("horizontal")}y==="horizontal"&&($.preventDefault(),v(C))},b=()=>{if(!u)return;d(!1),Math.abs(g)>100&&(g>0&&s>0?i(s-1):g<0&&s<n.length-1&&i(s+1)),v(0),w(null)},T=$=>{x($.target)||(d(!0),m($.clientX),p($.clientY),w(null))},A=$=>{if(!u)return;$.preventDefault();const ee=$.clientX-h,V=$.clientY-f;if(!y){const C=Math.abs(ee),L=Math.abs(V);if(C<6&&L<6)return;if(L>C*1.2){w("vertical"),d(!1),v(0);return}w("horizontal")}y==="horizontal"&&v(ee)},P=()=>{if(!u)return;d(!1),Math.abs(g)>100&&(g>0&&s>0?i(s-1):g<0&&s<n.length-1&&i(s+1)),v(0),w(null)},O=()=>{u&&(Math.abs(g)>100&&(g>0&&s>0?i(s-1):g<0&&s<n.length-1&&i(s+1)),d(!1),v(0),w(null))},U=$=>{i($),v(0)},E=N.current?.clientWidth||window.innerWidth||1,I=-s*E+g,F=n[s]?.id,D=F!=="onboarding",Y=n[s]?.name||"",z=F&&fl[F]||"",te=_.useMemo(()=>D?n:[],[n,D]),Q=$=>{const ee=$==="settings"?"me":$,V=n.findIndex(C=>C.id===ee);V>=0&&U(V)},H=$=>{U($),a&&c(!1)};return _.useEffect(()=>{const $=ee=>{ee.key==="Escape"&&c(!1)};return window.addEventListener("keydown",$),()=>window.removeEventListener("keydown",$)},[]),r.jsxs(ol,{value:{currentRoomId:F,navigateToRoom:Q},children:[r.jsx(ml,{}),r.jsxs("div",{className:`room-navigator ${D?"":"indicators-hidden"}`,children:[D&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:`room-sidebar-backdrop ${l&&a?"open":""}`,onClick:()=>c(!1),"aria-hidden":"true"}),r.jsxs("aside",{className:`room-sidebar ${l?"open":"closed"} ${a?"narrow":"wide"}`,"aria-label":"ナビゲーション",children:[r.jsxs("div",{className:"room-sidebar-top",children:[r.jsxs("button",{type:"button",className:"room-sidebar-toggle",onClick:()=>c($=>!$),"aria-label":l?"サイドバーを閉じる":"サイドバーを開く","aria-expanded":l,children:[r.jsx("span",{className:"room-sidebar-toggle-bar"}),r.jsx("span",{className:"room-sidebar-toggle-bar"}),r.jsx("span",{className:"room-sidebar-toggle-bar"})]}),r.jsxs("div",{className:"room-sidebar-brand","aria-label":"AIRIA BEYOND",children:[r.jsx("img",{className:"room-sidebar-logo",src:pl,alt:"","aria-hidden":"true"}),r.jsx("span",{className:"room-sidebar-brand-text",children:"AIRIA"})]})]}),r.jsx("nav",{className:"room-sidebar-nav","aria-label":"ルーム一覧",children:te.map(($,ee)=>r.jsxs("button",{type:"button",className:`room-sidebar-item ${ee===s?"active":""}`,onClick:()=>H(ee),"aria-current":ee===s?"page":void 0,"aria-label":`${$.name}へ移動`,title:$.name,children:[r.jsx("span",{className:"room-sidebar-icon","aria-hidden":"true",children:r.jsx(gl,{roomId:$.id})}),r.jsx("span",{className:"room-sidebar-item-label",children:$.name})]},$.id))}),r.jsxs("section",{className:"room-sidebar-description","aria-label":"現在のルーム説明",children:[r.jsx("div",{className:"room-sidebar-description-title",children:Y}),r.jsx("p",{className:"room-sidebar-description-text",children:z})]})]}),a&&!l?r.jsxs("button",{type:"button",className:"room-sidebar-fab",onClick:()=>c(!0),"aria-label":"ナビゲーションを開く",children:[r.jsx("span",{className:"room-sidebar-fab-bar"}),r.jsx("span",{className:"room-sidebar-fab-bar"}),r.jsx("span",{className:"room-sidebar-fab-bar"})]}):null]}),r.jsx("main",{className:`room-stage ${D?"with-sidebar":""} ${l?"sidebar-open":"sidebar-closed"}`,children:r.jsx("div",{ref:N,className:"rooms-container",onTouchStart:k,onTouchMove:S,onTouchEnd:b,onMouseDown:T,onMouseMove:A,onMouseUp:P,onMouseLeave:O,style:{transform:`translateX(${I}px)`,transition:u?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:n.map($=>r.jsx("div",{className:"room",children:$.component},$.id))})})]})]})},da="airia_onboarding_data",yl=[{value:"talk",title:"会話から",desc:"やさしく整えてから、次へ"},{value:"create",title:"創作から",desc:"早く作品に進みたい"}],bl=[{value:"今日",title:"今日",desc:"いちばん最近の出来事"},{value:"今週",title:"今週",desc:"数日の範囲"},{value:"今月",title:"今月",desc:"少し長め"},{value:"少し前",title:"少し前",desc:"はっきりしない/覚えてない"}],xl=[{value:"朝",title:"朝",desc:"スタートを整えたい"},{value:"昼",title:"昼",desc:"途中で乱れやすい"},{value:"夕方",title:"夕方",desc:"疲れが出やすい"},{value:"夜",title:"夜",desc:"余韻が残る/考えが巡る"}],ha=[{value:"穏やか",title:"穏やか",desc:"静か/落ち着く"},{value:"嬉しい",title:"嬉しい",desc:"軽い高揚/前向き"},{value:"不安",title:"不安",desc:"ざわつく/心配"},{value:"疲れ",title:"疲れ",desc:"消耗/休みたい"}],_l=[{value:"達成/うまくいった",title:"達成",desc:"うまくいった/進んだ"},{value:"不確実/心配",title:"心配",desc:"先が読めない/不確実"},{value:"人間関係",title:"人",desc:"誰かとのやり取り"},{value:"体力/睡眠",title:"体",desc:"寝不足/疲労/体調"}],wl=[{value:"仕事/学業",title:"仕事",desc:"締切/評価/責任"},{value:"人間関係",title:"人間関係",desc:"距離感/言葉/空気"},{value:"体調/睡眠",title:"体調",desc:"疲れ/睡眠/コンディション"},{value:"SNS/情報",title:"情報",desc:"比較/ニュース/刺激"}],Nl=[{value:"評価や期待が気になる",title:"評価",desc:"期待に応えたい/怖い"},{value:"比較してしまう",title:"比較",desc:"周りと比べて落ちる"},{value:"疲れると増幅する",title:"疲労",desc:"体力が落ちると不安が増える"},{value:"言語化できず溜まる",title:"未消化",desc:"うまく言えず残る"}],Sl=[{value:"落ち着いて集中したい",title:"集中",desc:"静かに深く入りたい"},{value:"安心して眠りたい",title:"眠り",desc:"夜にほどけたい"},{value:"不安を小さくしたい",title:"安心",desc:"ざわつきを鎮めたい"},{value:"気分を切り替えたい",title:"切替",desc:"短時間で整えたい"}],kl=[{value:"1週間以内",title:"1週間",desc:"短期で変えたい"},{value:"1ヶ月以内",title:"1ヶ月",desc:"少しずつ整える"},{value:"3ヶ月以内",title:"3ヶ月",desc:"習慣化したい"},{value:"長期的",title:"長期",desc:"ゆっくり育てる"}],Tl=({onComplete:n,onProgressChange:e})=>{const[t,s]=_.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),i={key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"choices",options:yl},a={key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"choices",options:bl},o={key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"choices",options:ha},l={key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"一番近い理由を選んでください。",kind:"choices",options:_l},c={key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"choices",options:xl},u={key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"choices",options:ha},d={key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"一番近いものを選んでください。",kind:"choices",options:wl},h={key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"一番近いものを選んでください。",kind:"choices",options:Nl},m={key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"choices",options:Sl},f={key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"choices",options:kl},p=R.useMemo(()=>t.startMode==="create"?[i,o,m,f]:[i,a,o,l,c,u,d,h,m,f],[t.startMode]),[g,v]=_.useState(0),y=p.length;_.useEffect(()=>{g>p.length-1&&v(Math.max(0,p.length-1))},[g,p.length]),_.useEffect(()=>{const b=y>0?g/y:0;e?.(Math.min(b,.999))},[g,y,e]),_.useEffect(()=>{const b=localStorage.getItem(da);if(b)try{const T=JSON.parse(b);s(T)}catch(T){console.error("Failed to parse saved onboarding data:",T)}},[]);const w=b=>{localStorage.setItem(da,JSON.stringify(b))},N=(b,T)=>{const A={...t,[b]:T};s(A),w(A),g<y-1&&v(g+1)},j=()=>{g<y-1&&(w(t),v(g+1))},x=()=>{g>0&&(w(t),v(g-1))},k=()=>{const T={...t,recentMomentWhen:t.recentMomentWhen||"最近",dailyPatternWhen:t.dailyPatternWhen||(t.startMode==="create"?"夜":""),recentMomentEmotion:t.recentMomentEmotion||t.dailyPatternEmotion,dailyPatternEmotion:t.dailyPatternEmotion||t.recentMomentEmotion,recentMomentWhy:t.recentMomentWhy||"未指定",emotionalTrigger:t.emotionalTrigger||"未指定",emotionalTriggerWhy:t.emotionalTriggerWhy||"未指定",emotionalGoal:t.emotionalGoal||"落ち着いて集中したい",emotionalGoalTimeframe:t.emotionalGoalTimeframe||"1ヶ月以内",completedAt:new Date().toISOString()};s(T),w(T),n&&n(T)},S=()=>{const b=p[g];return String(t[b.key]??"").trim().length>0};return r.jsxs("div",{className:"onboarding-form",children:[r.jsxs("div",{className:"onboarding-header",children:[r.jsx("h2",{className:"blend-text",children:"はじめに"}),r.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),r.jsx("div",{className:"progress-bar",children:r.jsx("div",{className:"progress-fill",style:{width:`${(g+1)/y*100}%`}})}),r.jsxs("p",{className:"step-indicator",children:["ステップ ",g+1," / ",y]})]}),r.jsx("div",{className:"question-container",children:(()=>{const b=p[g];return r.jsxs("div",{className:"question-step",children:[r.jsx("h3",{className:"question-title",children:b.title}),b.description?r.jsx("p",{className:"question-description",children:b.description}):null,r.jsx("div",{className:"form-group",children:r.jsx("div",{className:"choice-grid",role:"group","aria-label":b.title,children:b.options.map(T=>{const P=String(t[b.key]??"")===T.value;return r.jsxs("button",{type:"button",className:`choice-btn ${P?"is-selected":""}`,onClick:()=>N(b.key,T.value),"aria-pressed":P,children:[r.jsx("div",{className:"choice-title",children:T.title}),T.desc?r.jsx("div",{className:"choice-desc",children:T.desc}):null]},T.value)})})})]})})()}),r.jsx("div",{className:"onboarding-actions","data-no-swipe":"true","aria-label":"オンボーディング操作",children:r.jsxs("div",{className:"button-group",children:[g>0&&r.jsx("button",{className:"btn btn-secondary",onClick:x,type:"button",children:"← 戻る"}),g<y-1?r.jsx("button",{className:"btn btn-primary",onClick:j,disabled:!S(),type:"button",children:"次へ →"}):r.jsx("button",{className:"btn btn-success",onClick:k,disabled:!S(),type:"button",children:"完了"})]})})]})},jl=({isActive:n})=>{const e=_.useRef(null),t=_.useRef(null);Sn(c=>{if(!e.current)return;e.current.rotation.z+=n?.002:.001;const u=Math.sin(c.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=n?.6:.3)});const s=[],i=5,a=50,o=i*a;for(let c=0;c<o;c++){const u=c/a,d=u*Math.PI*2,h=u*.5;s.push(new Zt(Math.cos(d)*h,Math.sin(d)*h,u*.1))}const l=new ps().setFromPoints(s);return r.jsx("line",{ref:e,geometry:l,children:r.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},Cl=({isActive:n=!1})=>r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Kn,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(jl,{isActive:n})]})}),Il=({isActive:n})=>{const e=_.useRef(null),t=_.useRef(null);Sn(u=>{if(!e.current)return;e.current.rotation.z+=n?.001:5e-4;const d=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(d),t.current&&(t.current.opacity=n?.5:.25)});const s=[],i=200,a=3,o=2,l=Math.PI/2;for(let u=0;u<=i;u++){const d=u/i*Math.PI*2,h=Math.sin(a*d+l)*1.5,m=Math.sin(o*d)*1.5,f=0;s.push(new Zt(h,m,f))}const c=new ps().setFromPoints(s);return r.jsx("line",{ref:e,geometry:c,children:r.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},Al=({isActive:n=!1})=>r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Kn,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(Il,{isActive:n})]})}),Ml=({isActive:n,ripples:e})=>{const t=_.useRef(null);Sn(i=>{if(!t.current)return;const a=i.clock.elapsedTime;t.current.children.forEach((o,l)=>{if(e[l]){const c=a-e[l].startTime,u=3;if(c<u){const d=1+c*.5;o.scale.setScalar(d);const h=1-c/u;o instanceof Oc&&(o.material.opacity=h*(n?.6:.3))}else o.visible=!1}})});const s=()=>{const i=[];for(let l=0;l<=64;l++){const c=l/64*Math.PI*2;i.push(new Zt(Math.cos(c)*1,Math.sin(c)*1,0))}return new ps().setFromPoints(i)};return r.jsx("group",{ref:t,children:e.slice(-5).map(i=>r.jsx("line",{geometry:s(),children:r.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},i.id))})},El=({isActive:n=!1,triggerRipple:e})=>{const[t,s]=_.useState([]),i=_.useRef(0);return _.useEffect(()=>{if(e){const a={id:i.current++,startTime:Date.now()/1e3};s(o=>[...o,a].slice(-5))}},[e]),_.useEffect(()=>{if(!n)return;const a=setInterval(()=>{const o={id:i.current++,startTime:Date.now()/1e3};s(l=>[...l,o].slice(-5))},2e3);return()=>clearInterval(a)},[n]),r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Kn,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(Ml,{isActive:n,ripples:t})]})})},Pl=({isActive:n,progress:e,dominantColor:t,onComplete:s,mousePos:i})=>{const a=_.useRef(null),o=_.useRef(null),[l,c]=_.useState(!1),[u,d]=_.useState(0),h=_.useMemo(()=>new Pn(t),[t]),m=_.useMemo(()=>{const f=new ps,p=new Float32Array(100*3),g=new Float32Array(100*3);for(let v=0;v<100;v++){const y=Math.random()*Math.PI*2,w=Math.acos(2*Math.random()-1),N=1;p[v*3]=N*Math.sin(w)*Math.cos(y),p[v*3+1]=N*Math.sin(w)*Math.sin(y),p[v*3+2]=N*Math.cos(w),g[v*3]=p[v*3]*.02,g[v*3+1]=p[v*3+1]*.02,g[v*3+2]=p[v*3+2]*.02}return f.setAttribute("position",new sa(p,3)),f.setAttribute("velocity",new sa(g,3)),f},[]);return Sn(f=>{if(!a.current)return;const p=n?2*Math.PI/(30*60):2*Math.PI/(60*60);if(a.current.rotation.y+=p,a.current.rotation.x+=p*.5,n&&i.x!==0&&i.y!==0){const y=(i.x/window.innerWidth-.5)*.5,w=(i.y/window.innerHeight-.5)*.5;a.current.rotation.y+=(y-a.current.rotation.y)*.1,a.current.rotation.x+=(w-a.current.rotation.x)*.1}const g=20,v=Math.floor(e*g);if(v!==u&&v<g&&d(v),e>=1&&!l&&(c(!0),setTimeout(()=>{s?.()},1500)),l&&o.current){const y=m.getAttribute("position"),w=m.getAttribute("velocity");for(let N=0;N<100;N++)y.setXYZ(N,y.getX(N)+w.getX(N),y.getY(N)+w.getY(N),y.getZ(N)+w.getZ(N));y.needsUpdate=!0,a.current.material instanceof Dc&&(a.current.material.opacity=Math.max(0,a.current.material.opacity-.02))}}),r.jsxs("group",{children:[!l&&r.jsxs("mesh",{ref:a,children:[r.jsx("icosahedronGeometry",{args:[1,0]}),r.jsx("meshStandardMaterial",{color:h,transparent:!0,opacity:.8,wireframe:!1,emissive:h,emissiveIntensity:u/20})]}),l&&r.jsx("points",{ref:o,geometry:m,children:r.jsx("pointsMaterial",{color:h,size:.05,transparent:!0,opacity:.8})})]})},Ol=({isActive:n=!1,progress:e=0,onComplete:t,dominantColor:s="#D4AF37",layer:i="foreground",placement:a="center",sizePx:o=400,opacity:l})=>{const[c,u]=_.useState({x:0,y:0});_.useEffect(()=>{const f=p=>{u({x:p.clientX,y:p.clientY})};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]);const d=(()=>{switch(a){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),h=i==="background",m=typeof l=="number"?l:h?.14:1;return r.jsx("div",{style:{width:"100%",height:`${o}px`,position:"absolute",...d,transform:"translate(-50%, -50%)",pointerEvents:h?"none":n?"auto":"none",zIndex:h?-1:0,opacity:m},children:r.jsxs(Kn,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx("pointLight",{position:[10,10,10],intensity:1}),r.jsx(Pl,{isActive:n,progress:e,dominantColor:s,onComplete:t,mousePos:c})]})})},Dl=({index:n,frequency:e,amplitude:t,color:s,mousePos:i,plucked:a})=>{const o=_.useRef(null),[l,c]=_.useState(0),[u,d]=_.useState(0),h=_.useMemo(()=>{const f=[];for(let v=0;v<100;v++){const y=v/100*4-2;f.push(new Zt(y,0,0))}return f},[]);Sn(f=>{if(!o.current)return;const p=o.current.geometry.attributes.position,g=4,v=100;c(w=>w+e*.01),a&&d(w=>w+.2);const y=a?Math.exp(-u)*.5:0;for(let w=0;w<v;w++){const N=w/v*g-g/2,j=(i.x/window.innerWidth-.5)*8,x=(i.y/window.innerHeight-.5)*6,k=(n-2)*.4,S=Math.sqrt(Math.pow(j-N,2)+Math.pow(x-k,2)),b=Math.max(0,1-S/2)*.3,T=(t+b+y)*Math.sin(e*N+l),A=T,P=T*.2;p.setXYZ(w,N,A,P)}p.needsUpdate=!0,o.current.position.y=(n-2)*.4});const m=_.useMemo(()=>new ps().setFromPoints(h),[h]);return r.jsx("line",{ref:o,geometry:m,children:r.jsx("lineBasicMaterial",{color:s,linewidth:2,transparent:!0,opacity:.8})})},Rl=({isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:a})=>{const o=_.useMemo(()=>{const l=t<0?1:2,c=s*.2;return[{frequency:l,amplitude:e?.bass?e.bass/255*.3:c,color:"#FF4444"},{frequency:l*1.5,amplitude:e?.midLow?e.midLow/255*.3:c*.8,color:"#FF8844"},{frequency:l*2,amplitude:e?.mid?e.mid/255*.3:c*.6,color:"#FFDD44"},{frequency:l*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:c*.4,color:"#44DDFF"},{frequency:l*3,amplitude:e?.treble?e.treble/255*.3:c*.2,color:"#8844FF"}]},[e,t,s]);return r.jsx("group",{children:o.map((l,c)=>r.jsx(Dl,{index:c,frequency:l.frequency,amplitude:l.amplitude,color:l.color,mousePos:i,plucked:a===c},c))})},Fl=({isActive:n=!1,audioData:e=null,valence:t=0,arousal:s=.5})=>{const[i,a]=_.useState({x:0,y:0}),[o,l]=_.useState(-1);_.useEffect(()=>{const u=d=>{a({x:d.clientX,y:d.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const c=u=>{const d=u.currentTarget.getBoundingClientRect(),h=u.clientY-d.top,m=Math.floor(h/d.height*5);l(m),setTimeout(()=>l(-1),1e3)};return r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:n?"auto":"none",zIndex:0},onClick:c,children:r.jsxs(Kn,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(Rl,{isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:o})]})})},ro=({pattern:n,isActive:e=!1,triggerRipple:t,progress:s=0,dominantColor:i="#D4AF37",layer:a="foreground",placement:o="center",sizePx:l,opacity:c,audioData:u=null,valence:d=0,arousal:h=.5,onComplete:m})=>{const[f,p]=_.useState(!1),[g,v]=_.useState(!1);return _.useEffect(()=>{const y=()=>{p(window.innerWidth<768)},w=window.matchMedia("(prefers-reduced-motion: reduce)");v(w.matches),y(),window.addEventListener("resize",y);const N=j=>{v(j.matches)};return w.addEventListener("change",N),()=>{window.removeEventListener("resize",y),w.removeEventListener("change",N)}},[]),f||g||n==="none"?null:r.jsxs(r.Fragment,{children:[n==="spiral"&&r.jsx(Cl,{isActive:e}),n==="lissajous"&&r.jsx(Al,{isActive:e}),n==="ripples"&&r.jsx(El,{isActive:e,triggerRipple:t}),n==="polyhedron"&&r.jsx(Ol,{isActive:e,progress:s,dominantColor:i,onComplete:m,layer:a,placement:o,sizePx:l,opacity:c}),n==="stringVibration"&&r.jsx(Fl,{isActive:e,audioData:u,valence:d,arousal:h})]})},Nt="https://airia-beyond.onrender.com";async function on(n){return n.json().catch(()=>null)}function cn(n){const e=n instanceof Error?n.message:String(n);return/failed to fetch/i.test(e)||/networkerror/i.test(e)||/load failed/i.test(e)||/timeout/i.test(e)}function ln(n){const e=Nt,t=(()=>{try{return window.location.origin}catch{return"(unknown)"}})();return[`${n} に失敗しました（通信エラー）`,`API: ${e}`,`Origin: ${t}`,"原因候補: VITE_API_BASE_URL 未設定/誤り、APIサーバ停止、CORS未許可"].join(`
`)}function un(n){try{if(window.location.protocol==="https:"&&/^http:\/\//i.test(Nt))throw new Error(`${n} に失敗しました（Mixed Content）。
HTTPS のページから HTTP の API（${Nt}）へは接続できません。API を https:// にするか、VITE_API_BASE_URL をHTTPSのURLにしてください。`)}catch{}}async function dn(n,e,t){const s=String(n.headers.get("content-type")||"").toLowerCase();if(e==null){if(n.ok&&s.includes("text/html"))throw new Error(`${t} に失敗しました（API応答がHTMLでした）。VITE_API_BASE_URL がフロントに向いている可能性があります。`);if(n.ok&&!s.includes("application/json"))throw new Error(`${t} に失敗しました（API応答がJSONではありません）。API設定を確認してください。`)}}function hn(n,e,t){const s=String(t?.message||t?.error||"").trim();return e.status===401||e.status===403?s||`${n} に失敗しました（ログインが必要です）`:e.status===429?s||`${n} に失敗しました（混み合っています）。少し待ってから再試行してください。`:s||`${n} に失敗しました（HTTP ${e.status}）`}async function Qr(n){try{un("画像生成");const e=await fetch(`${Nt}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"画像生成"),!e.ok)throw new Error(hn("画像生成",e,t));return t}catch(e){throw cn(e)?new Error(ln("画像生成")):e}}async function Ll(n,e){try{un("生成状況の取得");const t=await fetch(`${Nt}/api/job/${n}`,{signal:e}),s=await on(t);if(await dn(t,s,"生成状況の取得"),!t.ok)throw new Error(hn("生成状況の取得",t,s));return s}catch(t){throw e?.aborted?new DOMException("Aborted","AbortError"):cn(t)?new Error(ln("生成状況の取得")):t}}async function Gs(n,e,t=60,s=2e3,i){let a=null;for(let o=0;o<t;o++){if(i?.aborted)throw new DOMException("Aborted","AbortError");let l;try{l=await Ll(n,i)}catch(c){if(i?.aborted)throw new DOMException("Aborted","AbortError");a=c,await new Promise(u=>setTimeout(u,Math.min(s*2,5e3)));continue}if(e&&e(l),l.status==="succeeded"||l.status==="failed")return l;await new Promise(c=>setTimeout(c,s))}throw a instanceof Error?a:new Error("生成状況の確認がタイムアウトしました。通信環境を確認して、あとで再開してください。")}async function Vl(n){try{un("会話");const e=await fetch(`${Nt}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"会話"),!e.ok)throw new Error(hn("会話",e,t));return t}catch(e){throw cn(e)?new Error(ln("会話")):e}}async function Ul(n){try{un("イベントの整形");const e=await fetch(`${Nt}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"イベントの整形"),!e.ok)throw new Error(hn("イベントの整形",e,t));return t}catch(e){throw cn(e)?new Error(ln("イベントの整形")):e}}async function Bl(n){try{un("タイトル提案");const e=await fetch(`${Nt}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"タイトル提案"),!e.ok)throw new Error(hn("タイトル提案",e,t));return t}catch(e){throw cn(e)?new Error(ln("タイトル提案")):e}}async function ql(n){try{un("プレビュー取得");const e=await fetch(`${Nt}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"プレビュー取得"),!e.ok)throw new Error(hn("プレビュー取得",e,t));return t}catch(e){throw cn(e)?new Error(ln("プレビュー取得")):e}}async function Xs(n){try{un("音楽生成");const e=await yt(`${Nt}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await on(e);if(await dn(e,t,"音楽生成"),!e.ok)throw new Error(hn("音楽生成",e,t));return t}catch(e){throw cn(e)?new Error(ln("音楽生成")):e}}async function Wl(n,e){try{un("音楽生成状況の取得");const t=await yt(`${Nt}/api/music/${n}`,{signal:e}),s=await on(t);if(await dn(t,s,"音楽生成状況の取得"),!t.ok)throw new Error(hn("音楽生成状況の取得",t,s));return s}catch(t){throw e?.aborted?new DOMException("Aborted","AbortError"):cn(t)?new Error(ln("音楽生成状況の取得")):t}}async function Vn(n,e,t=60,s=2e3,i){let a=null;for(let o=0;o<t;o++){if(i?.aborted)throw new DOMException("Aborted","AbortError");let l;try{l=await Wl(n,i)}catch(c){if(i?.aborted)throw new DOMException("Aborted","AbortError");a=c,await new Promise(u=>setTimeout(u,Math.min(s*2,5e3)));continue}if(e&&e(l),l.status==="succeeded"||l.status==="failed")return l;await new Promise(c=>setTimeout(c,s))}throw a instanceof Error?a:new Error("音楽生成状況の確認がタイムアウトしました。通信環境を確認して、あとで再開してください。")}const $l="airia_onboarding_data";function Gl(){try{const n=localStorage.getItem($l);if(!n)return null;const e=JSON.parse(n);return!e||typeof e!="object"?null:e}catch{return null}}function ma(n){return Math.max(0,Math.min(1,n))}function zl(n){return Math.max(-1,Math.min(1,n))}function pa(n){switch(String(n??"").trim()){case"穏やか":return{valence:.15,arousal:.25};case"嬉しい":return{valence:.65,arousal:.65};case"不安":return{valence:-.55,arousal:.65};case"疲れ":return{valence:-.2,arousal:.25};case"怒り":return{valence:-.65,arousal:.85};case"悲しい":return{valence:-.7,arousal:.35};case"興奮":return{valence:.5,arousal:.9};case"退屈":return{valence:-.1,arousal:.15};default:return{valence:0,arousal:.45}}}function Yl(n){const e=new Set,t=n.recentMomentEmotion||n.dailyPatternEmotion,s=String(t??"").trim();e.add("余韻"),e.add("光"),s==="不安"?(e.add("霧"),e.add("揺れ")):s==="穏やか"?(e.add("水面"),e.add("静寂")):s==="疲れ"?(e.add("夜"),e.add("静寂")):s==="嬉しい"?(e.add("風"),e.add("朝")):s==="悲しい"?(e.add("影"),e.add("雨")):s==="怒り"?(e.add("火"),e.add("鋭さ")):s==="興奮"?(e.add("閃光"),e.add("躍動")):s==="退屈"&&(e.add("無音"),e.add("空"));const i=String(n.emotionalGoal??"").trim();return i.includes("集中")&&e.add("集中"),(i.includes("安心")||i.includes("安"))&&e.add("安心"),i.includes("眠")&&e.add("眠り"),i.includes("整")&&e.add("整う"),[...e].slice(0,5)}function Hl(n){const e=n.recentMomentEmotion||n.dailyPatternEmotion||"未指定",t=String(n.emotionalGoal??"").trim(),s=String(n.emotionalTrigger??"").trim();return{emotionalProfile:[`startMode:${n.startMode||"未指定"}`,`mood:${e}`,t?`goal:${t.slice(0,80)}`:null,s?`trigger:${s.slice(0,60)}`:null].filter(Boolean).join(" / "),preferences:{...n,startMode:n.startMode}}}function Xl(n){const e=pa(n.recentMomentEmotion),t=pa(n.dailyPatternEmotion),s=zl((e.valence+t.valence)/2),i=ma((e.arousal+t.arousal)/2),a=ma(n.startMode==="create"?.78:.68),o=Yl(n),l=.65,c=n.startMode==="create"?210:180;return{valence:s,arousal:i,focus:a,motif_tags:o,confidence:l,duration:c}}function Jl(n){const e=String(n.title).trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),i=Math.abs(s.split("").reduce((o,l)=>o*33+l.charCodeAt(0),7))%360,a=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${i} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(i+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(i+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${fa(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${fa(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">Generated from onboarding</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(a)}`}function fa(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}const fi="airia_pending_chat_generation_v1",gi="airia_pending_onboarding_generation_v1";function Wr(){try{const n=localStorage.getItem(fi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="chat"||!e.musicJobId?null:e}catch{return null}}function ga(n){try{localStorage.setItem(fi,JSON.stringify(n))}catch{}}function va(){try{localStorage.removeItem(fi)}catch{}}function os(){try{const n=localStorage.getItem(gi);if(!n)return null;const e=JSON.parse(n);return!e||e.v!==1||e.kind!=="onboarding"||!e.musicJobId||!e.request||!e.coverDataUrl?null:e}catch{return null}}function ya(n){try{localStorage.setItem(gi,JSON.stringify(n))}catch{}}function is(){try{localStorage.removeItem(gi)}catch{}}function io({open:n,title:e,description:t,cancelLabel:s="キャンセル",confirmLabel:i="実行",confirmTone:a="primary",onCancel:o,onConfirm:l}){return _.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&o(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&l()};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,o,l]),n?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"confirm-dialog-backdrop",onClick:o}),r.jsxs("div",{className:"confirm-dialog",role:"dialog","aria-modal":"true","aria-label":e,children:[r.jsxs("div",{className:"confirm-dialog-header",children:[r.jsxs("div",{children:[r.jsx("div",{className:"confirm-dialog-eyebrow",children:"確認"}),r.jsx("h2",{className:"confirm-dialog-title",children:e})]}),r.jsx("button",{className:"confirm-dialog-close",onClick:o,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),t?r.jsx("div",{className:"confirm-dialog-body",children:t}):null,r.jsxs("div",{className:"confirm-dialog-actions",children:[r.jsx("button",{className:"btn btn-secondary",onClick:o,children:s}),r.jsx("button",{className:a==="danger"?"btn btn-primary confirm-dialog-danger":"btn btn-primary",onClick:l,children:i})]}),r.jsx("div",{className:"confirm-dialog-shortcut",children:"確定: クリック / (Ctrl+Enter)"})]})]}):null}const ao={active:!1,scopeLabel:null,statusText:null,elapsedSec:0,onCancel:null,updatedAt:0},oo=R.createContext(void 0);function Kl(n){const e=Object.values(n).filter(t=>t.active);return e.length===0?ao:(e.sort((t,s)=>s.updatedAt-t.updatedAt),e[0])}function Zl({children:n}){const[e,t]=R.useState({entries:{}}),s=R.useCallback((l,c)=>{const u=String(l||"default");t(d=>{const h=d.entries[u]??ao,m={active:!!c.active,scopeLabel:c.scopeLabel??h.scopeLabel??null,statusText:c.statusText??h.statusText??null,elapsedSec:Number.isFinite(c.elapsedSec)?c.elapsedSec:h.elapsedSec??0,onCancel:c.onCancel??null,updatedAt:c.updatedAt??Date.now()};return{entries:{...d.entries,[u]:m}}})},[]),i=R.useCallback(l=>{const c=String(l||"default");t(u=>{if(!u.entries[c])return u;const d={...u.entries};return delete d[c],{entries:d}})},[]),a=R.useMemo(()=>Kl(e.entries),[e.entries]),o=R.useMemo(()=>({setOverlay:s,clearOverlay:i,current:a}),[s,i,a]);return r.jsx(oo.Provider,{value:o,children:n})}function vi(){const n=R.useContext(oo);if(!n)throw new Error("useGenerationOverlay must be used within GenerationOverlayProvider");return n}function Ql(n){const e=String(n||"").trim();return e?`（${e}）`:""}function Ut(n,e){switch(n){case"queued":return"順番待ち…";case"running":return`生成中…${Ql(e)}`;case"succeeded":return"仕上げ中…";case"failed":return"失敗しました";default:return"進行中…"}}const eu=({onExit:n})=>{const{albums:e,addAlbum:t,selectAlbum:s}=qt(),{requestPlayAlbum:i}=an(),{addToast:a}=bs(),{setOverlay:o,clearOverlay:l}=vi(),[c,u]=_.useState(!1),[d,h]=_.useState(null),[m,f]=_.useState(0),[p,g]=_.useState(!1),[v,y]=_.useState(null),[w,N]=_.useState(null),[j,x]=_.useState(null),[k,S]=_.useState(0),[b,T]=_.useState(!1),A=_.useRef(!1),P=_.useRef(null),O=_.useRef(!1),[U,E]=_.useState(!1),I=_.useMemo(()=>e.filter(V=>V.musicData),[e]);_.useEffect(()=>{const V=os();T(!!V),V&&!O.current&&(O.current=!0,a("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]);const F=V=>{h(V),u(!0)},D=()=>{u(!1),h(null),f(0),g(!1),y(null),N(null),x(null),S(0),P.current?.abort(),P.current=null,is(),T(!1),A.current=!1};_.useEffect(()=>{if(!p||!j)return;S(Math.max(0,Math.floor((Date.now()-j)/1e3)));const V=window.setInterval(()=>{S(Math.max(0,Math.floor((Date.now()-j)/1e3)))},1e3);return()=>window.clearInterval(V)},[p,j]);const Y=V=>V.recentMomentEmotion||V.dailyPatternEmotion||"穏やか",z=async()=>{if(p)return;const V=os();if(!V)return;y(null),N("再開中…"),g(!0),x(V.startedAt||Date.now()),S(0),a("info","生成を再開しています…"),P.current?.abort();const C=new AbortController;P.current=C;try{const L=await Vn(V.musicJobId,J=>{N(Ut(J.status,J.effectiveProvider||J.provider))},90,2e3,C.signal);if(L.status!=="succeeded"||!L.midiData||!L.result)throw new Error(L.errorMessage||L.error||"曲生成に失敗しました");N("保存しています…");const M=t({title:V.title,mood:V.mood,duration:V.request.duration,imageDataURL:V.coverDataUrl,thumbnailUrl:V.coverDataUrl,metadata:{valence:V.request.valence,arousal:V.request.arousal,focus:V.request.focus,motif_tags:V.request.motif_tags,confidence:V.request.confidence,provider:"rule-based"},musicData:L.midiData,musicFormat:"midi",musicMetadata:{key:L.result.key,tempo:L.result.tempo,timeSignature:L.result.timeSignature,form:L.result.form,character:L.result.character,duration:V.request.duration,createdAt:new Date().toISOString(),provider:L.provider},sessionData:{onboarding:d??null}});s(M.id),i(M,[M,...I]),is(),T(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(L){if(L instanceof DOMException&&L.name==="AbortError"){N("キャンセルしました"),a("info","生成をキャンセルしました。あとで再開できます。");return}y(L instanceof Error?L.message:"曲生成に失敗しました"),N(null),a("error",L instanceof Error?L.message:"曲生成に失敗しました")}finally{g(!1),P.current=null}},te=async()=>{if(p)return;const V=os();if(!V)return;y(null),N("再生成を開始しています…"),g(!0),x(Date.now()),S(0),a("info","同じ条件で再生成を開始しました。"),P.current?.abort();const C=new AbortController;P.current=C;try{const L=await Xs(V.request);ya({...V,startedAt:Date.now(),musicJobId:L.jobId}),T(!0);const M=await Vn(L.jobId,X=>{N(Ut(X.status,X.effectiveProvider||X.provider))},90,2e3,C.signal);if(M.status!=="succeeded"||!M.midiData||!M.result)throw new Error(M.errorMessage||M.error||"曲生成に失敗しました");N("保存しています…");const J=t({title:V.title,mood:V.mood,duration:V.request.duration,imageDataURL:V.coverDataUrl,thumbnailUrl:V.coverDataUrl,metadata:{valence:V.request.valence,arousal:V.request.arousal,focus:V.request.focus,motif_tags:V.request.motif_tags,confidence:V.request.confidence,provider:"rule-based"},musicData:M.midiData,musicFormat:"midi",musicMetadata:{key:M.result.key,tempo:M.result.tempo,timeSignature:M.result.timeSignature,form:M.result.form,character:M.result.character,duration:V.request.duration,createdAt:new Date().toISOString(),provider:M.provider},sessionData:{onboarding:d}});s(J.id),i(J,[J,...I]),is(),T(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(L){if(L instanceof DOMException&&L.name==="AbortError"){N("キャンセルしました"),a("info","生成をキャンセルしました。あとで再開できます。");return}const M=L instanceof Error?L.message:"曲生成に失敗しました";y(M),N(null),a("error",M)}finally{g(!1),P.current=null}},Q=async()=>{if(!d||p)return;y(null),N("準備中…"),g(!0),x(Date.now()),S(0),P.current?.abort();const V=new AbortController;P.current=V;try{const C=Y(d),L=`${Date.now()}`,M=Jl({title:"はじめの一曲",mood:C,seed:L}),J=Xl(d);N("作曲を開始しています…");const X=await Xs({...J,seed:Number(L.slice(-9))});ya({v:1,kind:"onboarding",startedAt:Date.now(),musicJobId:X.jobId,request:{...J,seed:Number(L.slice(-9))},mood:C,title:"はじめの一曲",coverDataUrl:M}),T(!0),a("info","生成を開始しました。完了まで待つか、あとで再開できます。"),N("生成中…（1〜2分かかることがあります）");const se=await Vn(X.jobId,ke=>{N(Ut(ke.status,ke.effectiveProvider||ke.provider))},90,2e3,V.signal);if(se.status!=="succeeded"||!se.midiData||!se.result)throw new Error(se.errorMessage||se.error||"曲生成に失敗しました");N("保存しています…");const ve=t({title:"はじめの一曲",mood:C,duration:J.duration,imageDataURL:M,thumbnailUrl:M,metadata:{valence:J.valence,arousal:J.arousal,focus:J.focus,motif_tags:J.motif_tags,confidence:J.confidence,provider:"rule-based"},musicData:se.midiData,musicFormat:"midi",musicMetadata:{key:se.result.key,tempo:se.result.tempo,timeSignature:se.result.timeSignature,form:se.result.form,character:se.result.character,duration:J.duration,createdAt:new Date().toISOString(),provider:se.provider},sessionData:{onboarding:d}});s(ve.id),i(ve,[ve,...I]),is(),T(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}n?.()}catch(C){if(C instanceof DOMException&&C.name==="AbortError"){N("キャンセルしました"),x(null),S(0),a("info","生成をキャンセルしました。あとで再開できます。");return}y(C instanceof Error?C.message:"曲生成に失敗しました"),N(null),x(null),S(0),a("error",C instanceof Error?C.message:"曲生成に失敗しました")}finally{g(!1),P.current=null}},H=()=>{p&&(P.current?.abort(),g(!1),N("キャンセルしました"),x(null),S(0),a("info","生成を中断しました。あとで再開できます。"))},$=()=>{is(),T(!1),N(null),y(null),a("info","保留中の生成を破棄しました。")},ee=()=>{p&&(P.current?.abort(),P.current=null,g(!1),N("キャンセルしました"),x(null),S(0),a("info","生成をキャンセルしました。あとで再開できます。"))};return _.useEffect(()=>{if(!p){l("onboarding");return}o("onboarding",{active:!0,scopeLabel:"はじめに",statusText:w,elapsedSec:k,onCancel:ee})},[p,w,k,o,l]),_.useEffect(()=>{!c||!d||A.current||d.startMode==="create"&&(A.current=!0,os()?z():Q())},[c,d]),r.jsxs("div",{className:"room-content onboarding-room","data-no-swipe":"true",children:[r.jsx(io,{open:U,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>E(!1),onConfirm:()=>{E(!1),$()}}),!c&&r.jsx(ro,{pattern:"polyhedron",isActive:!0,progress:m,layer:"background",placement:"center",sizePx:420,opacity:.16}),c?r.jsxs("div",{className:"onboarding-complete",children:[r.jsx("h2",{className:"blend-text",children:"完了しました！"}),r.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",r.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),v?r.jsx("div",{className:"form-error",children:v}):null,w?r.jsxs("div",{className:"onboarding-generate-status",children:[w,j?r.jsxs("span",{className:"onboarding-generate-elapsed",children:["（",k,"s）"]}):null]}):null,r.jsxs("div",{className:"button-group",children:[r.jsx("button",{className:"btn btn-secondary",onClick:D,children:"回答を編集"}),r.jsx("button",{className:"btn btn-primary",onClick:()=>void Q(),disabled:p,"data-no-swipe":!0,title:"オンボーディング回答から1曲生成して、そのまま再生します",children:p?"1曲生成中…":"1曲作ってはじめる"}),!p&&b?r.jsx("button",{className:"btn btn-secondary",onClick:()=>void z(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!p&&b&&v?r.jsx("button",{className:"btn btn-secondary",onClick:()=>void te(),"data-no-swipe":!0,type:"button",title:"失敗・停止した場合に、同じ条件で作り直します",children:"再生成"}):null,!p&&b?r.jsx("button",{className:"btn btn-secondary",onClick:()=>E(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null,p?r.jsx("button",{className:"btn btn-secondary",onClick:H,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,r.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!d)return;const V=JSON.stringify(d,null,2),C=new Blob([V],{type:"application/json"}),L=URL.createObjectURL(C),M=document.createElement("a");M.href=L,M.download="getting_started_profile.json",M.click(),URL.revokeObjectURL(L)},children:"プロフィールをダウンロード"}),r.jsx("button",{className:"btn btn-success",onClick:()=>{n?.()},children:"はじめる"})]})]}):r.jsx(Tl,{onComplete:F,onProgressChange:f})]})},An="".trim().toLowerCase()==="true",tu=void 0,ba=void 0,At="https://airia-beyond.onrender.com",nu=({onBack:n})=>{const{loginWithGoogle:e,loginWithApple:t,loginWithPassword:s,registerWithPassword:i,busy:a}=hr(),o=R.useRef(null),[l,c]=R.useState(null),[u,d]=R.useState(null),[h,m]=R.useState(!0),[f,p]=R.useState(null),[g,v]=R.useState(null),[y,w]=R.useState(null),[N,j]=R.useState(null),[x,k]=R.useState(null),[S,b]=R.useState(0),[T,A]=R.useState(""),[P,O]=R.useState(!1),[U,E]=R.useState(null),I=R.useMemo(()=>{try{const W=String(window.location.host||"").toLowerCase();return W.endsWith("netlify.app")?"Netlify（Site settings → Environment variables）":W.includes("github.io")?"GitHub（Actions/Pages の Secrets）":"ホスティングサービスのビルド環境（環境変数）"}catch{return"ホスティングサービスのビルド環境（環境変数）"}},[]),[F,D]=R.useState(()=>{try{return String(window.location.hash||"").toLowerCase()==="#signup"?"signup":"login"}catch{return"login"}});R.useEffect(()=>{try{const W=String(window.location.hash||"").toLowerCase();W==="#signup"&&D("signup"),W==="#login"&&D("login")}catch{}},[]),R.useEffect(()=>{let W=!0;return(async()=>{try{k(new Date().toISOString());const ie=await fetch(`${At}/api/health`).catch(()=>null);if(!W)return;if(!ie)p(!1),v(null);else{const ge=await ie.json().catch(()=>null);p(!!ie.ok),v({ok:!!ie.ok,status:ie.status,body:ge})}const pe=await el();if(!W)return;w(pe),m(!!pe?.passwordEnabled);const ce=await fetch(`${At}/api/diagnostics/version`).catch(()=>null);if(!W)return;if(!ce)j(null);else{const ge=await ce.json().catch(()=>null);j({ok:!!ce.ok,status:ce.status,body:ge})}}catch{W&&(p(!1),v(null),w(null),j(null))}})(),()=>{W=!1}},[S]),R.useEffect(()=>{c(null),d(null)},[e]);const Y=async()=>{if(c(null),d(null),!An){c("このプレリリースでは OAuth ログインは無効です");return}{c("Apple Client ID が未設定です");return}},z=An&&!!tu,te=An&&!!ba,Q=[...z?[]:["Google"],...te?[]:["Apple"]],[H,$]=R.useState(""),[ee,V]=R.useState(""),[C,L]=R.useState(""),[M,J]=R.useState(""),[X,se]=R.useState(""),ve=!!(H.trim()&&ee),ke=!!(M.trim()&&X),Ve=async W=>{W.preventDefault(),c(null),d(null);try{await i({email:H,password:ee,displayName:C||void 0});const ie=H.trim();d("新規登録が完了しました。メールとパスワードでログインしてください。"),D("login"),J(ie),se(""),V("");try{window.location.hash="#login"}catch{}}catch(ie){c(ie instanceof Error?ie.message:String(ie))}},K=async W=>{W.preventDefault(),c(null),d(null);try{await s({identifier:M,password:X})}catch(ie){c(ie instanceof Error?ie.message:String(ie))}};return r.jsx("div",{className:"room-content auth-room",children:r.jsxs("div",{className:"auth-card","data-no-swipe":"true",children:[n?r.jsx("div",{style:{marginBottom:8},children:r.jsx("button",{className:"btn",onClick:n,disabled:a,children:"← 戻る"})}):null,r.jsxs("div",{className:"auth-tabs",role:"tablist","aria-label":"認証モード",children:[r.jsx("button",{type:"button",role:"tab","aria-selected":F==="signup",className:`auth-tab ${F==="signup"?"active":""}`,onClick:()=>{D("signup");try{window.location.hash="#signup"}catch{}},disabled:a,children:"新規登録"}),r.jsx("button",{type:"button",role:"tab","aria-selected":F==="login",className:`auth-tab ${F==="login"?"active":""}`,onClick:()=>{D("login");try{window.location.hash="#login"}catch{}},disabled:a,children:"ログイン"})]}),r.jsx("h1",{className:"auth-title",children:"AIRIA"}),r.jsx("p",{className:"auth-subtitle",children:F==="signup"?"メールで新規登録（登録後にログイン）":"おかえりなさい。ログインして続ける"}),f===!1?r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"API に接続できません"}),r.jsxs("div",{className:"auth-loading-sub",children:["新規登録/ログインが「Failed to fetch」になる場合、ほとんどが API 設定または CORS が原因です。",r.jsx("br",{}),"現在の API: ",At,r.jsx("br",{}),"対応: ",I," に `VITE_API_BASE_URL`（例: https://airia-beyond.onrender.com）を設定して再デプロイ。",r.jsx("br",{}),"併せてバックエンド側で `APP_PUBLIC_URL` / `APP_ALLOWED_ORIGINS` にフロントのURLを追加してください。"]})]}):null,r.jsxs("details",{className:"auth-loading",style:{marginTop:10},children:[r.jsx("summary",{style:{cursor:"pointer",fontWeight:650},children:"接続/認証チェック（診断）"}),r.jsxs("div",{className:"auth-loading-sub",style:{marginTop:8},children:[r.jsxs("div",{children:["API: ",At]}),r.jsxs("div",{children:["Origin: ",(()=>{try{return window.location.origin}catch{return"(unknown)"}})()]}),r.jsxs("div",{children:["/api/health: ",g?g.ok?`OK (${g.status})`:`NG (${g.status})`:f===!1?"NG (no response)":"未取得"]}),r.jsxs("div",{children:["/api/auth/config: ",y?`passwordEnabled=${String(!!y.passwordEnabled)}`:"未取得"]}),r.jsxs("div",{children:["/api/diagnostics/version:"," ",N?N.ok?`OK (${N.status})`:`NG (${N.status})`:"未取得"]}),N?.body?r.jsxs("div",{style:{opacity:.9},children:["authStorePath: ",String(N.body?.authStorePath??"(unknown)"),N.body?.commit?` / commit: ${String(N.body.commit)}`:""]}):null,x?r.jsxs("div",{children:["checkedAt: ",x]}):null,r.jsxs("div",{style:{marginTop:10,display:"flex",gap:10,flexWrap:"wrap"},children:[r.jsx("button",{className:"btn",type:"button",onClick:()=>b(W=>W+1),disabled:a,children:"再チェック"}),r.jsx("a",{className:"btn",href:`${At}/api/health`,target:"_blank",rel:"noreferrer",children:"health を開く"}),r.jsx("a",{className:"btn",href:`${At}/api/auth/config`,target:"_blank",rel:"noreferrer",children:"auth config を開く"}),r.jsx("a",{className:"btn",href:`${At}/api/diagnostics/version`,target:"_blank",rel:"noreferrer",children:"version を開く"})]}),y&&y.passwordEnabled===!1?r.jsx("div",{style:{marginTop:10},children:"ブロッカー: バックエンド側でメール/パスワード認証が無効です。Render の環境変数に `AUTH_ALLOW_PASSWORD=true` を追加して再デプロイしてください。"}):null,r.jsxs("div",{style:{marginTop:14,paddingTop:12,borderTop:"1px solid rgba(255,255,255,0.12)"},children:[r.jsx("div",{style:{fontWeight:650},children:"管理（ADMIN_TOKEN 必須）"}),r.jsx("div",{style:{marginTop:6,opacity:.9},children:"注意: トークンは共有しないでください。入力値はこの画面のメモリにのみ保持されます。"}),r.jsxs("div",{style:{marginTop:8,display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:[r.jsx("input",{className:"auth-input",style:{maxWidth:360},type:"password",value:T,onChange:W=>A(W.target.value),placeholder:"ADMIN_TOKEN",autoComplete:"off",disabled:a}),r.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:13,opacity:.9},children:[r.jsx("input",{type:"checkbox",checked:P,onChange:W=>O(W.target.checked),disabled:a}),"email も表示"]}),r.jsx("button",{className:"btn",type:"button",disabled:a||!At||!T.trim(),onClick:async()=>{try{E(null);const W=`${At}/api/admin/users?token=${encodeURIComponent(T.trim())}&limit=50&includeEmail=${P?"1":"0"}`,ie=await fetch(W).catch(()=>null);if(!ie){E({ok:!1,status:0,body:{error:"No response"}});return}const pe=await ie.json().catch(()=>null);E({ok:!!ie.ok,status:ie.status,body:pe})}catch(W){E({ok:!1,status:0,body:{error:W instanceof Error?W.message:String(W)}})}},children:"ユーザー一覧取得"})]}),U?r.jsxs("div",{style:{marginTop:8},children:[r.jsxs("div",{children:["/api/admin/users: ",U.ok?`OK (${U.status})`:`NG (${U.status})`]}),r.jsx("pre",{style:{marginTop:6,padding:10,borderRadius:10,background:"rgba(0,0,0,0.35)",maxHeight:240,overflow:"auto",fontSize:12,lineHeight:1.35},children:JSON.stringify(U.body,null,2)})]}):null]})]})]}),An&&Q.length?r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"OAuth が未設定です"}),r.jsxs("div",{className:"auth-loading-sub",children:[Q.join(" / ")," の Client ID がフロントエンド側で未投入です。 このアプリは Vite のため、環境変数は「実行時」ではなく「ビルド時」に埋め込まれます。",I," に以下を設定して再デプロイしてください。",r.jsx("br",{}),"必須: `VITE_GOOGLE_CLIENT_ID` / `VITE_APPLE_CLIENT_ID` / `VITE_API_BASE_URL`",r.jsx("br",{}),"推奨: `VITE_APPLE_REDIRECT_URI`（例: ",window.location.origin,"/）"]})]}):null,h?null:r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"メール/パスワードは無効です"}),r.jsx("div",{className:"auth-loading-sub",children:"この環境ではメール/パスワードログインが無効化されています。管理者設定（`AUTH_ALLOW_PASSWORD=true`）を確認してください。"})]}),a?r.jsx("div",{className:"auth-loading","aria-live":"polite","aria-busy":"true",children:r.jsxs("div",{className:"auth-loading-row",children:[r.jsx("div",{className:"auth-spinner","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("div",{className:"auth-loading-title",children:"処理中…"}),r.jsx("div",{className:"auth-loading-sub",children:"通信環境によっては時間がかかる場合があります。安全にログイン処理を行っています。"})]})]})}):null,r.jsx("div",{className:"auth-note",children:F==="signup"?r.jsx(r.Fragment,{children:r.jsx("p",{children:"プレリリースはメールアドレスでの新規登録/ログインに限定しています。"})}):r.jsxs(r.Fragment,{children:[r.jsx("p",{children:"メールアドレス（またはハンドル）とパスワードでログインしてください。"}),r.jsxs("p",{children:["初めての方は"," ",r.jsx("button",{type:"button",className:"auth-inline-link",onClick:()=>{D("signup");try{window.location.hash="#signup"}catch{}},disabled:a,children:"新規登録"}),"。"]})]})}),h&&F==="signup"?r.jsxs("form",{className:"auth-form",onSubmit:W=>void Ve(W),children:[r.jsxs("label",{className:"auth-label",children:["メールアドレス",r.jsx("input",{className:"auth-input",type:"email",value:H,onChange:W=>$(W.target.value),placeholder:"you@example.com",autoComplete:"email",disabled:a,required:!0})]}),r.jsxs("label",{className:"auth-label",children:["パスワード（6文字以上）",r.jsx("input",{className:"auth-input",type:"password",value:ee,onChange:W=>V(W.target.value),placeholder:"••••••",autoComplete:"new-password",disabled:a,required:!0,minLength:6})]}),r.jsxs("label",{className:"auth-label",children:["表示名（任意）",r.jsx("input",{className:"auth-input",type:"text",value:C,onChange:W=>L(W.target.value),placeholder:"AIRIAユーザー",autoComplete:"nickname",disabled:a})]}),r.jsx("button",{className:"btn auth-submit",type:"submit",disabled:a||!ve,children:a?"作成中…":"メールで新規登録"})]}):h&&F==="login"?r.jsxs("form",{className:"auth-form",onSubmit:W=>void K(W),children:[r.jsxs("label",{className:"auth-label",children:["メールアドレス / ハンドル",r.jsx("input",{className:"auth-input",type:"text",value:M,onChange:W=>J(W.target.value),placeholder:"you@example.com または your_handle",autoComplete:"username",disabled:a,required:!0})]}),r.jsxs("label",{className:"auth-label",children:["パスワード",r.jsx("input",{className:"auth-input",type:"password",value:X,onChange:W=>se(W.target.value),placeholder:"••••••",autoComplete:"current-password",disabled:a,required:!0})]}),r.jsx("button",{className:"btn auth-submit",type:"submit",disabled:a||!ke,children:a?"ログイン中…":"メールでログイン"})]}):null,An?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"auth-sep","aria-hidden":"true",children:[r.jsx("span",{}),r.jsx("div",{children:"または"}),r.jsx("span",{})]}),r.jsxs("div",{className:"auth-actions",children:[r.jsx("div",{className:`auth-google ${z?"":"disabled"}`,children:z?r.jsx("div",{ref:o}):r.jsx("button",{className:"btn",disabled:!0,children:"Googleでログイン（未設定）"})}),r.jsxs("button",{className:"btn btn-apple",onClick:()=>void Y(),disabled:a||!ba,children:["Appleでログイン","（未設定）"]})]})]}):null,l&&r.jsx("div",{className:"auth-error",children:l}),u&&r.jsx("div",{className:"auth-success",children:u})]})})},su=({onStart:n,onOpenTerms:e,onOpenPrivacy:t})=>{const s=i=>{const a=document.getElementById(i);a&&"scrollIntoView"in a&&a.scrollIntoView({behavior:"smooth",block:"start"})};return r.jsxs("div",{className:"room-content landing-room",children:[r.jsx("div",{className:"landing-hero","data-no-swipe":"true",children:r.jsxs("div",{className:"landing-hero-inner",children:[r.jsxs("div",{className:"landing-hero-copy",children:[r.jsxs("div",{className:"landing-hero-toprow",children:[r.jsx("div",{className:"landing-eyebrow",children:"MOOD → IMAGE → MUSIC"}),(t||e)&&r.jsxs("div",{className:"landing-legal","aria-label":"Legal",children:[t?r.jsx("button",{type:"button",className:"landing-legal-link",onClick:t,children:"Privacy"}):null,t&&e?r.jsx("span",{className:"landing-legal-sep","aria-hidden":"true",children:"·"}):null,e?r.jsx("button",{type:"button",className:"landing-legal-link",onClick:e,children:"Terms"}):null]})]}),r.jsxs("h1",{className:"landing-title",children:["AIRIA BEYOND",r.jsx("span",{className:"landing-title-sub",children:"感情を、作品に変える。"})]}),r.jsxs("p",{className:"landing-lead",children:["その日の気分を記録して、抽象画とクラシック風の音楽へ。",r.jsx("br",{}),"“言葉にならない”を、見える・聴ける形にして保存します。"]}),r.jsxs("div",{className:"landing-cta",children:[r.jsx("button",{className:"btn btn-primary landing-cta-primary",onClick:()=>{try{window.location.hash="#signup"}catch{}n()},children:"無料で新規登録"}),r.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>{try{window.location.hash="#login"}catch{}n()},children:"ログイン"}),r.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>s("landing-how"),"aria-label":"AIRIAの使い方へスクロール",children:"どうやって動く？"})]}),r.jsxs("div",{className:"landing-meta",children:[r.jsx("span",{className:"landing-chip",children:"プレリリース"}),r.jsx("span",{className:"landing-chip",children:"Email / Password"}),r.jsx("span",{className:"landing-chip",children:"生成失敗でも止めない設計"}),r.jsx("span",{className:"landing-chip",children:"最短ルート：ログイン → 「創作から」"})]}),r.jsx("div",{className:"landing-signup-note",children:"初めての方は「無料で新規登録」からメール/パスワードを作成 → その後ログインしてください。"})]}),r.jsxs("div",{className:"landing-hero-cover","aria-label":"サンプルプレビュー",children:[r.jsxs("div",{className:"landing-cover-card",children:[r.jsxs("div",{className:"landing-cover-top",children:[r.jsx("div",{className:"landing-cover-kicker",children:"Today’s Session"}),r.jsx("div",{className:"landing-cover-date",children:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),r.jsx("div",{className:"landing-cover-title",children:"静けさと余白"}),r.jsx("div",{className:"landing-cover-sub",children:"穏やか / 3:00 / Focus 0.62"}),r.jsx("div",{className:"landing-cover-image",role:"img","aria-label":"生成イメージのモック"}),r.jsxs("div",{className:"landing-cover-bottom",children:[r.jsxs("div",{className:"landing-cover-pills",children:[r.jsx("span",{className:"landing-pill",children:"Valence"}),r.jsx("span",{className:"landing-pill",children:"Arousal"}),r.jsx("span",{className:"landing-pill",children:"Motif"})]}),r.jsxs("div",{className:"landing-cover-wave","aria-hidden":"true",children:[r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"})]})]})]}),r.jsx("div",{className:"landing-cover-note",children:"これは体験イメージです。実際の生成はあなたの入力に合わせて変化します。"})]})]})}),r.jsxs("section",{className:"landing-section",id:"landing-how",children:[r.jsxs("div",{className:"landing-section-head",children:[r.jsx("h2",{className:"landing-h2",children:"体験は“記事”のように読み進められる"}),r.jsx("p",{className:"landing-sub",children:"AIRIAは、ただの生成ツールではなく「自分の状態を読み解くための記録」です。 迷いにくい導線と、気持ちよく続くUIを優先しました。"})]}),r.jsxs("div",{className:"landing-steps","data-no-swipe":"true",children:[r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"01"}),r.jsx("h3",{className:"landing-h3",children:"気分を入力"}),r.jsx("p",{className:"landing-p",children:"短い質問に答えるだけ。言語化が苦手でもOK。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"02"}),r.jsx("h3",{className:"landing-h3",children:"抽象画を生成"}),r.jsx("p",{className:"landing-p",children:"色・構図・質感で、その日の“温度”を可視化します。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"03"}),r.jsx("h3",{className:"landing-h3",children:"音楽を生成"}),r.jsx("p",{className:"landing-p",children:"クラシック風の短編。再生バーからすぐ聴けます。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"04"}),r.jsx("h3",{className:"landing-h3",children:"保存・共有"}),r.jsx("p",{className:"landing-p",children:"Socialに公開、反応を受け取る。非公開・削除も可能です。"})]})]}),r.jsx("div",{className:"landing-divider"}),r.jsxs("div",{className:"landing-grid","data-no-swipe":"true",children:[r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"止まらない体験"}),r.jsx("p",{className:"landing-p",children:"生成が失敗しても、placeholderや緊急MIDIで進行します。待ち時間のストレスを最小化。"})]}),r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"説明可能性"}),r.jsx("p",{className:"landing-p",children:"“なぜこの作品になったか”を見える形で提示。ブラックボックス感を減らします。"})]}),r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"運用前提の設計"}),r.jsx("p",{className:"landing-p",children:"OAuth-only、レート制限、通知（任意）など、プレリリースでも破綻しにくい土台を用意。"})]})]})]}),r.jsxs("section",{className:"landing-section landing-section-narrow",children:[r.jsxs("div",{className:"landing-section-head",children:[r.jsx("h2",{className:"landing-h2",children:"コンセプト"}),r.jsx("p",{className:"landing-sub",children:"“感情を作品に変える”は、自己理解の入り口になる。"})]}),r.jsxs("article",{className:"landing-article","data-no-swipe":"true",children:[r.jsx("p",{className:"landing-article-p",children:"気分は、言葉で説明しきれないことが多い。AIRIAは、入力を起点に「視覚」と「音楽」でその輪郭をつくります。 生成物は正解ではなく、あなたが自分を読み解くための“鏡”。"}),r.jsx("p",{className:"landing-article-p",children:"だからUIは、派手さよりも継続性を優先。余白、静けさ、そして必要なときだけ現れる強い導線。 アプリ全体がひとつの短い文章のように流れる設計です。"}),r.jsxs("div",{className:"landing-quote",children:[r.jsx("div",{className:"landing-quote-mark","aria-hidden":"true",children:"“"}),r.jsxs("div",{children:[r.jsx("div",{className:"landing-quote-text",children:"今日を作品として保存できると、気分は“消費”ではなく“蓄積”になる。"}),r.jsx("div",{className:"landing-quote-sub",children:"AIRIA BEYOND / Design note"})]})]})]})]}),r.jsxs("section",{className:"landing-section landing-bottom","data-no-swipe":"true",children:[r.jsxs("div",{className:"landing-bottom-inner",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"landing-h2",children:"準備はできましたか？"}),r.jsx("p",{className:"landing-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),r.jsxs("div",{className:"landing-bottom-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:n,children:"ログインしてはじめる"}),r.jsx("button",{className:"btn",onClick:()=>s("landing-how"),children:"もう一度読む"})]})]}),r.jsxs("footer",{className:"landing-footer",children:[r.jsxs("div",{className:"landing-footer-row",children:[r.jsx("div",{className:"landing-footer-brand",children:"AIRIA BEYOND"}),r.jsx("div",{className:"landing-footer-note",children:"Pre-release / OAuth-only"})]}),(t||e)&&r.jsxs("div",{className:"landing-footer-links","aria-label":"Legal",children:[t?r.jsx("button",{type:"button",className:"landing-footer-link",onClick:t,children:"プライバシー"}):null,e?r.jsx("button",{type:"button",className:"landing-footer-link",onClick:e,children:"利用規約"}):null]})]})]})]})},ru=()=>r.jsxs("div",{className:"legal-page",children:[r.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[r.jsx("h2",{children:"1. サービスの概要 / Service Overview"}),r.jsx("p",{children:"AIRIA BEYONDは、AI搭載の感情分析・クラシック音楽・絵画生成アプリケーションです。 ユーザーの感情状態を分析し、それに基づいてクラシック音楽や絵画を生成します。"}),r.jsx("p",{children:"AIRIA BEYOND is an AI-powered application for emotion analysis, classical music, and painting generation. It analyzes users' emotional states and generates classical music and paintings based on the analysis."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"2. データの取り扱い / Data Handling"}),r.jsx("p",{children:"個人を特定できる情報は送信されません。セッションデータ、生成された画像・音楽は ブラウザのローカルストレージに保存されます。"}),r.jsx("p",{children:"No personally identifiable information is transmitted. Session data, generated images and music are stored in browser's local storage."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"3. 使用制限 / Usage Restrictions"}),r.jsx("p",{children:"本サービスは個人的な使用のみを目的としています。商用利用には事前の許可が必要です。"}),r.jsx("p",{children:"This service is intended for personal use only. Commercial use requires prior permission."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"4. 免責事項 / Disclaimer"}),r.jsx("p",{children:"本サービスは「現状のまま」提供されます。生成されたコンテンツの正確性や適切性について 保証しません。"}),r.jsx("p",{children:'This service is provided "as is". We do not guarantee the accuracy or appropriateness of generated content.'})]}),r.jsx("div",{className:"legal-note",children:"プレリリース期間中は仕様が更新される場合があります。重要な変更はアプリ内のお知らせで通知します。"})]}),iu=()=>r.jsxs("div",{className:"legal-page",children:[r.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[r.jsx("h2",{children:"1. 収集する情報 / Information We Collect"}),r.jsxs("ul",{children:[r.jsx("li",{children:"セッションデータ（気分、時間） / Session data (mood, duration)"}),r.jsx("li",{children:"生成された画像・音楽 / Generated images and music"}),r.jsx("li",{children:"アクセスログ / Access logs"}),r.jsx("li",{children:"パフォーマンス指標 / Performance metrics"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"2. データの使用目的 / Purpose of Data Use"}),r.jsx("p",{children:"収集したデータは以下の目的で使用されます："}),r.jsxs("ul",{children:[r.jsx("li",{children:"サービスの提供と改善 / Service provision and improvement"}),r.jsx("li",{children:"パフォーマンスの監視 / Performance monitoring"}),r.jsx("li",{children:"エラーのトラッキングと修正 / Error tracking and fixing"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"3. データの保存 / Data Storage"}),r.jsx("p",{children:"ユーザーデータは主にブラウザのローカルストレージに保存されます。 サーバー側では一時的な処理のみが行われます。"}),r.jsx("p",{children:"User data is primarily stored in browser's local storage. Server-side processing is temporary only."}),r.jsx("div",{className:"legal-note",children:"ログインによりサーバー側にユーザー情報が保存されます（例: ハンドル、表示名、フォロー関係）。 メール通知を有効化した場合は、通知先としてメールアドレスを保存します。"})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"4. 第三者サービス / Third-Party Services"}),r.jsx("p",{children:"本サービスは以下の第三者サービスを使用します："}),r.jsxs("ul",{children:[r.jsx("li",{children:"ComfyUI (画像生成 / Image generation)"}),r.jsx("li",{children:"OpenAI (感情分析 / Emotion analysis)"}),r.jsx("li",{children:"Render (APIホスティング / API hosting)"}),r.jsx("li",{children:"GitHub Pages (フロントエンド配信 / Frontend hosting)"}),r.jsx("li",{children:"Sentry (エラートラッキング / Error tracking) - オプション"}),r.jsx("li",{children:"Resend / SMTP (メール通知 / Email notifications) - オプション"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"5. お問い合わせ / Contact"}),r.jsx("p",{children:"プライバシーに関するご質問は、GitHubリポジトリのIssueにてお問い合わせください。"}),r.jsx("p",{children:"For privacy-related questions, please contact us via GitHub repository Issues."})]})]}),xa=({kind:n,onBack:e,onStart:t})=>{const s=n==="terms"?"利用規約":"プライバシーポリシー",i=n==="terms"?"Terms of Service":"Privacy Policy";return r.jsxs("div",{className:"room-content legal-room","data-no-swipe":"true",children:[r.jsxs("div",{className:"legal-topbar",children:[r.jsx("button",{className:"btn",onClick:e,children:"← 戻る"}),r.jsx("div",{className:"legal-topbar-spacer"}),r.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインへ"})]}),r.jsxs("header",{className:"legal-hero",children:[r.jsx("div",{className:"legal-hero-kicker",children:"AIRIA BEYOND / Legal"}),r.jsxs("h1",{className:"legal-hero-title",children:[s,r.jsx("span",{className:"legal-hero-sub",children:i})]}),r.jsx("p",{className:"legal-hero-lead",children:"ここに書かれていることは“堅い文章”ですが、AIRIAが守ろうとしているのは体験の安心感です。 わからない点があれば、GitHubのIssueから相談できます。"})]}),r.jsx("main",{className:"legal-body",children:n==="terms"?r.jsx(ru,{}):r.jsx(iu,{})}),r.jsx("div",{className:"legal-bottom","data-no-swipe":"true",children:r.jsxs("div",{className:"legal-bottom-inner",children:[r.jsxs("div",{children:[r.jsx("div",{className:"legal-bottom-title",children:"続きはアプリで"}),r.jsx("div",{className:"legal-bottom-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),r.jsxs("div",{className:"legal-bottom-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインしてはじめる"}),r.jsx("button",{className:"btn",onClick:e,children:"戻る"})]})]})})]})};function au(n,e,t){try{n(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(s){console.error("[CausalLog] Failed to log album creation stage:",s)}}function Mn(n,e,t,s,i){try{const o=e(t)?.errors||[];n(t,{errors:[...o,{stage:s,error:i,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",s)}catch(a){console.error("[CausalLog] Failed to log error:",a)}}function $r(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function ou(n){const e=String(n.title??"").trim()||"AIRIA",t=String(n.mood??"").trim()||"mood",s=String(n.seed??"0"),i=String(n.note).trim()||"Placeholder cover",a=Math.abs(s.split("").reduce((l,c)=>l*33+c.charCodeAt(0),7))%360,o=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${a} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(a+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(a+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${$r(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${$r(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">${$r(i).slice(0,64)}</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(o)}`}function cu({open:n,mood:e,defaultTitle:t,onCancel:s,onSubmit:i}){const[a,o]=_.useState(t??"");_.useEffect(()=>{n&&o(t??"")},[n,t]);const l=_.useMemo(()=>a.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[a]);return _.useEffect(()=>{if(!n)return;const c=u=>{u.key==="Escape"&&s(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&i(a)};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[n,s,i,a]),n?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"album-title-backdrop",onClick:s}),r.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[r.jsxs("div",{className:"album-title-header",children:[r.jsxs("div",{children:[r.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),r.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),r.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),r.jsx("button",{className:"album-title-close",onClick:s,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),r.jsxs("div",{className:"album-title-body",children:[r.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),r.jsx("input",{id:"album-title-input",className:"album-title-input",value:a,placeholder:"例：雨上がりの余白",onChange:c=>o(c.target.value),autoFocus:!0}),r.jsx("div",{className:"album-title-hint",children:l}),r.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),r.jsxs("div",{className:"album-title-actions",children:[r.jsx("button",{className:"btn btn-secondary",onClick:s,children:"キャンセル"}),r.jsx("button",{className:"btn btn-primary",onClick:()=>i(a),children:"保存"})]})]})]}):null}function Gr(){return new Date().toISOString()}function zr(n,e){return ou({title:n?.brief?.theme?.title,mood:n?.image?.mood,seed:n?.image?.seed,note:e})}function Yr(n){return n?.effectiveProvider||n?.provider||(n?.status==="succeeded"?"image":"placeholder")}function lu(){const{albums:n,addAlbum:e,selectAlbum:t}=qt(),{createLog:s,updateLog:i,getLog:a}=Za(),{requestPlayAlbum:o}=an(),{navigateToRoom:l}=$t(),{addToast:c}=bs(),{setOverlay:u,clearOverlay:d}=vi(),[h,m]=_.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[f,p]=_.useState(""),[g,v]=_.useState(!1),[y,w]=_.useState(null),[N,j]=_.useState([]),[x,k]=_.useState(null),[S,b]=_.useState(!1),[T,A]=_.useState(null),[P,O]=_.useState(null),[U,E]=_.useState(0),I=_.useRef(null),[F,D]=_.useState(!1),[Y,z]=_.useState(!1),te=_.useRef(!1),[Q,H]=_.useState(!1),[$,ee]=_.useState(!1),[V,C]=_.useState(null),[L,M]=_.useState(null),[J,X]=_.useState(!1),se=_.useRef(null),[ve,ke]=_.useState(null),[Ve,K]=_.useState({}),[W,ie]=_.useState({}),[pe,ce]=_.useState({}),[ge,Xe]=_.useState(!1),[tt,B]=_.useState(!0),G=_.useMemo(()=>h.filter(q=>q.role==="user"),[h]),ne=_.useMemo(()=>{const q=Gl();return q?Hl(q):null},[]),le=_.useMemo(()=>n.filter(q=>q.musicData),[n]);_.useEffect(()=>{const q=window.matchMedia("(max-width: 900px)"),de=()=>Xe(q.matches);return de(),typeof q.addEventListener=="function"?(q.addEventListener("change",de),()=>q.removeEventListener("change",de)):(q.addListener(de),()=>q.removeListener(de))},[]),_.useEffect(()=>{B(!ge)},[ge]),_.useEffect(()=>{const q=Wr();D(!!q),q&&!te.current&&(te.current=!0,c("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]),_.useEffect(()=>()=>{I.current?.abort(),I.current=null,se.current&&(se.current.pause(),se.current.src="",se.current=null)},[]),_.useEffect(()=>{if(!S||!P)return;E(Math.max(0,Math.floor((Date.now()-P)/1e3)));const q=window.setInterval(()=>{E(Math.max(0,Math.floor((Date.now()-P)/1e3)))},1e3);return()=>window.clearInterval(q)},[S,P]),_.useEffect(()=>{if(!S){d("chat");return}u("chat",{active:!0,scopeLabel:"対話",statusText:T,elapsedSec:U,onCancel:fe})},[S,T,U,u,d]);function fe(){S&&(I.current?.abort(),I.current=null,b(!1),A("キャンセルしました"),O(null),E(0),z(!1),c("info","生成を中断しました。あとで再開できます。"))}function ue(){va(),D(!1),A(null),w(null),z(!1),c("info","保留中の生成を破棄しました。")}async function ye(){const q=Wr();if(!q||S)return;w(null),z(!1),b(!0),A("再生成を開始しています…"),O(Date.now()),E(0),c("info","同じ条件で再生成を開始しました。"),I.current?.abort();const de=new AbortController;I.current=de;try{const Z=q.refined,re=zr(Z,"Image unavailable");let Ne=null;try{A("画像生成を開始しています…"),Ne=(await Qr(Z.image)).jobId}catch(Ke){Ne=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const De=Ke instanceof Error?Ke.message:"image job start failed";q.causalLogId&&Mn(i,a,q.causalLogId,"image-generation-start",De)}A("作曲を開始しています…");const Ie={...Z.music,confidence:Z?.analysisLike?.confidence??.7},Pe=await Xs(Ie);ga({...q,startedAt:Date.now(),imageJobId:Ne,musicJobId:Pe.jobId,coverDataUrl:q.coverDataUrl||re}),D(!0);const Ft=Ne?Gs(Ne,Ke=>{A(Ut(Ke.status,Ke.effectiveProvider||Ke.provider))},90,2e3,de.signal).catch(Ke=>{const De=Ke instanceof Error?Ke.message:"image polling failed";return q.causalLogId&&Mn(i,a,q.causalLogId,"image-generation-poll",De),null}):Promise.resolve(null),[Ct,_e]=await Promise.all([Ft,Vn(Pe.jobId,Ke=>{A(Ut(Ke.status,Ke.effectiveProvider||Ke.provider))},90,2e3,de.signal)]),nt=Ct?.status==="succeeded"&&Ct?.resultUrl?Ct.resultUrl:re;if(Ct?.status==="succeeded"&&Ct?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),_e.status!=="succeeded"||!_e.midiData||!_e.result)throw new Error("曲生成に失敗しました");const Ps=Z?.brief?.theme?.title||"";C({title:Ps,mood:Z?.image?.mood,duration:Z?.image?.duration,imageDataURL:nt,thumbnailUrl:nt,metadata:{valence:Z?.analysisLike?.valence,arousal:Z?.analysisLike?.arousal,focus:Z?.analysisLike?.focus,motif_tags:Z?.analysisLike?.motif_tags,confidence:Z?.analysisLike?.confidence,stylePreset:Z?.image?.stylePreset,provider:Yr(Ct)},musicData:_e.midiData,musicFormat:"midi",musicMetadata:{key:_e.result.key,tempo:_e.result.tempo,timeSignature:_e.result.timeSignature,form:_e.result.form,character:_e.result.character,duration:Z?.music?.duration,createdAt:Gr(),provider:_e.provider},sessionData:{brief:Z?.brief,recommendations:q.sessionRecommendations??N,messages:q.sessionMessages??h},causalLogId:q.causalLogId??void 0}),M(q.causalLogId??null),ee(!0),A(null),z(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(Z){if(Z instanceof DOMException&&Z.name==="AbortError"){A("キャンセルしました"),z(!1);return}const re=Z instanceof Error?Z.message:"再生成に失敗しました";w(re),z(!0),c("error",re)}finally{b(!1),I.current=null}}async function Ue(){const q=Wr();if(!q||S)return;w(null),z(!1),b(!0),A("再開中…"),O(q.startedAt||Date.now()),E(0),c("info","生成を再開しています…"),I.current?.abort();const de=new AbortController;I.current=de;try{const Z=q.refined,re=q.coverDataUrl||zr(Z,"Image unavailable"),Ne=q.imageJobId?Gs(q.imageJobId,_e=>{A(Ut(_e.status,_e.effectiveProvider||_e.provider))},90,2e3,de.signal).catch(_e=>{const nt=_e instanceof Error?_e.message:"image polling failed";return q.causalLogId&&Mn(i,a,q.causalLogId,"image-generation-poll",nt),null}):Promise.resolve(null),[Ie,Pe]=await Promise.all([Ne,Vn(q.musicJobId,_e=>{A(Ut(_e.status,_e.effectiveProvider||_e.provider))},90,2e3,de.signal)]),Ft=Ie?.status==="succeeded"&&Ie?.resultUrl?Ie.resultUrl:re;if(Ie?.status==="succeeded"&&Ie?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Pe.status!=="succeeded"||!Pe.midiData||!Pe.result)throw new Error("曲生成に失敗しました");const Ct=Z?.brief?.theme?.title||"";C({title:Ct,mood:Z?.image?.mood,duration:Z?.image?.duration,imageDataURL:Ft,thumbnailUrl:Ft,metadata:{valence:Z?.analysisLike?.valence,arousal:Z?.analysisLike?.arousal,focus:Z?.analysisLike?.focus,motif_tags:Z?.analysisLike?.motif_tags,confidence:Z?.analysisLike?.confidence,stylePreset:Z?.image?.stylePreset,provider:Yr(Ie)},musicData:Pe.midiData,musicFormat:"midi",musicMetadata:{key:Pe.result.key,tempo:Pe.result.tempo,timeSignature:Pe.result.timeSignature,form:Pe.result.form,character:Pe.result.character,duration:Z?.music?.duration,createdAt:Gr(),provider:Pe.provider},sessionData:{brief:Z?.brief,recommendations:q.sessionRecommendations??N,messages:q.sessionMessages??h},causalLogId:q.causalLogId??void 0}),M(q.causalLogId??null),ee(!0),A(null),D(!0),z(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(Z){if(Z instanceof DOMException&&Z.name==="AbortError"){A("キャンセルしました"),z(!1);return}const re=Z instanceof Error?Z.message:"再開に失敗しました";w(re),z(!0),c("error",re)}finally{b(!1),I.current=null}}const xe=q=>`${q.composer}::${q.title}`;async function Be(q){const de=xe(q);if(Ve[de])return Ve[de];if(W[de])return null;ie(Z=>({...Z,[de]:!0})),ce(Z=>({...Z,[de]:null}));try{const Z=await ql({composer:q.composer,title:q.title});return K(re=>({...re,[de]:Z})),Z}catch(Z){const re=Z instanceof Error?Z.message:"プレビュー取得に失敗しました";return ce(Ne=>({...Ne,[de]:re})),null}finally{ie(Z=>({...Z,[de]:!1}))}}async function ot(q){const de=xe(q);if(ve===de){se.current?.pause(),ke(null);return}const re=await Be(q),Ne=re?.previewUrl,Ie=re?.trackUrl;if(!Ne){Ie&&window.open(Ie,"_blank","noopener,noreferrer");return}try{se.current||(se.current=new Audio),se.current.pause(),se.current.src=Ne,se.current.currentTime=0,await se.current.play(),ke(de),se.current.onended=()=>{ke(Pe=>Pe===de?null:Pe)}}catch(Pe){ce(Ft=>({...Ft,[de]:Pe instanceof Error?Pe.message:"再生に失敗しました"}))}}async function dt(){const q=f.trim();if(!q)return;w(null),v(!0);const de=[...h,{role:"user",content:q}];m(de),p("");try{const Z=await Vl({messages:de,onboardingData:ne??void 0});m(re=>[...re,{role:"assistant",content:Z.assistant_message}]),j(Z.recommendations??[]),k(Z.event_suggestion??null)}catch(Z){const re=Z instanceof Error?Z.message:"送信に失敗しました";w(re),m(Ne=>[...Ne,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{v(!1)}}async function Ge(){w(null),z(!1),b(!0),A("準備中…"),O(Date.now()),E(0),I.current?.abort();const q=new AbortController;I.current=q;const de=`chat_${Date.now()}`,Z=s(de,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{A("イベントを整えています…");const re=await Ul({messages:h,onboardingData:ne??void 0}),Ne=zr(re,"Image unavailable");let Ie=null;try{A("画像生成を開始しています…"),Ie=(await Qr(re.image)).jobId}catch(De){Ie=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Vr=De instanceof Error?De.message:"image job start failed";Mn(i,a,Z,"image-generation-start",Vr)}A("作曲を開始しています…");const Pe={...re.music,confidence:re?.analysisLike?.confidence??.7},Ft=await Xs(Pe);ga({v:1,kind:"chat",startedAt:Date.now(),imageJobId:Ie,musicJobId:Ft.jobId,coverDataUrl:Ne,refined:re,sessionMessages:h,sessionRecommendations:N,causalLogId:Z}),D(!0),c("info","生成を開始しました。完了まで待つか、あとで再開できます。");const Ct=Ie?Gs(Ie,De=>{A(Ut(De.status,De.effectiveProvider||De.provider))},90,2e3,q.signal).catch(De=>{const Vr=De instanceof Error?De.message:"image polling failed";return Mn(i,a,Z,"image-generation-poll",Vr),null}):Promise.resolve(null),[_e,nt]=await Promise.all([Ct,Vn(Ft.jobId,De=>{A(Ut(De.status,De.effectiveProvider||De.provider))},90,2e3,q.signal)]);if(q.signal.aborted){A("キャンセルしました");return}const Ps=_e?.status==="succeeded"&&_e?.resultUrl?_e.resultUrl:Ne;if(_e?.status==="succeeded"&&_e?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),nt.status!=="succeeded"||!nt.midiData||!nt.result)throw new Error("曲生成に失敗しました");A("保存の準備をしています…");const Ke=re?.brief?.theme?.title||"";C({title:Ke,mood:re.image.mood,duration:re.image.duration,imageDataURL:Ps,thumbnailUrl:Ps,metadata:{valence:re.analysisLike.valence,arousal:re.analysisLike.arousal,focus:re.analysisLike.focus,motif_tags:re.analysisLike.motif_tags,confidence:re.analysisLike.confidence,stylePreset:re.image.stylePreset,provider:Yr(_e)},musicData:nt.midiData,musicFormat:"midi",musicMetadata:{key:nt.result.key,tempo:nt.result.tempo,timeSignature:nt.result.timeSignature,form:nt.result.form,character:nt.result.character,duration:re.music.duration,createdAt:Gr(),provider:nt.provider},sessionData:{brief:re.brief,recommendations:N,messages:h},causalLogId:Z}),M(Z),ee(!0),c("success","生成が完了しました。タイトルを決めて保存できます。"),z(!1),A(null),O(null),E(0),k(null),m(De=>[...De,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(re){if(re instanceof DOMException&&re.name==="AbortError"){A("キャンセルしました"),O(null),E(0),m(Ie=>[...Ie,{role:"assistant",content:"生成をキャンセルしたよ。必要ならまた「今すぐ1曲つくる」で再開できる。"}]),c("info","生成をキャンセルしました。あとで再開できます。"),z(!1);return}const Ne=re instanceof Error?re.message:"生成イベントに失敗しました";A(null),O(null),E(0),w(Ne),c("error",Ne),z(!0),Mn(i,a,Z,"generation-event",Ne),m(Ie=>[...Ie,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{b(!1),I.current=null}}async function Je(q){if(!V){ee(!1);return}const de=q.trim();try{X(!0);let Z=de;if(!Z)try{Z=(await Bl({mood:V.mood,motifTags:V?.metadata?.motif_tags,character:V?.musicMetadata?.character,brief:V?.sessionData?.brief,messages:V?.sessionData?.messages})).title}catch{Z=""}const re=e({...V,title:Z||void 0});t(re.id),o(re,[re,...le]),l("music"),c("success","保存して再生を開始しました。"),va(),D(!1),L&&au(i,L,{albumId:"local",title:Z||V.mood}),k(null),m(Ne=>[...Ne,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{X(!1),ee(!1),C(null),M(null)}}return r.jsxs("div",{className:"chatSession",children:[r.jsx(io,{open:Q,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>H(!1),onConfirm:()=>{H(!1),ue()}}),r.jsx(cu,{open:$,mood:V?.mood||"穏やか",defaultTitle:V?.title,onCancel:()=>{J||(ee(!1),C(null),M(null))},onSubmit:q=>{J||Je(q)}}),r.jsxs("div",{className:"chatLayout",children:[r.jsxs("div",{className:"chatMain",children:[r.jsx("div",{className:"chatBody",children:h.map((q,de)=>r.jsx("div",{className:`chatMsg ${q.role==="user"?"user":"assistant"}`,children:r.jsx("div",{className:"chatBubble",children:q.content})},de))}),r.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[r.jsxs("div",{className:"chatDockTop","aria-label":"生成コントロール",children:[r.jsx("div",{className:"chatDockMeta",children:T?r.jsxs("div",{className:"chatMetaPill","aria-live":"polite",children:[T,P?r.jsxs("span",{className:"chatMetaElapsed",children:["（",U,"s）"]}):null]}):x&&!x.shouldTrigger?r.jsx("div",{className:"chatMetaHint",title:x.reason,children:x.reason}):r.jsx("div",{className:"chatMetaHint","aria-hidden":"true"})}),r.jsxs("div",{className:"chatDockActions","data-no-swipe":!0,children:[r.jsx("button",{className:"chatCancel",onClick:()=>B(q=>!q),type:"button",title:"レコメンドパネルを表示/非表示",children:tt?"レコメンド非表示":"レコメンド表示"}),r.jsx("button",{className:"chatPrimary",onClick:Ge,disabled:S,title:x?.reason||"会話の内容をもとに1曲生成します",type:"button",children:S?"生成中…":x?.shouldTrigger?"生成イベントを開始":"今すぐ1曲つくる"}),!S&&F?r.jsx("button",{className:"chatCancel",onClick:()=>void Ue(),type:"button",children:"再開"}):null,!S&&F&&Y?r.jsx("button",{className:"chatCancel",onClick:()=>void ye(),type:"button",title:"同じ条件で生成をやり直します（失敗・停止時向け）",children:"再生成"}):null,S?r.jsx("button",{className:"chatCancel",onClick:fe,type:"button",children:"キャンセル"}):null,!S&&F?r.jsx("button",{className:"chatCancel",onClick:()=>H(!0),type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null]})]}),y?r.jsx("div",{className:"chatError",children:y}):null,r.jsxs("div",{className:"chatComposer",children:[r.jsx("textarea",{className:"chatInput",placeholder:G.length===0?"今日のことを一言で":"続けて話して",value:f,onChange:q=>p(q.target.value),onKeyDown:q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),g||dt())},rows:2}),r.jsx("button",{className:"chatSend",onClick:dt,disabled:g||!f.trim(),children:g?"送信中…":"送信"})]})]})]}),r.jsxs("aside",{className:`chatSide ${tt?"open":"closed"}`,"aria-label":"レコメンド","aria-hidden":!tt,children:[r.jsxs("div",{className:"chatSideHeader",children:[r.jsx("div",{className:"chatSideTitle",children:"いまのレコメンド"}),r.jsx("div",{className:"chatSideHint",children:"30秒プレビュー（可能な場合）"})]}),N.length>0?r.jsx("ul",{className:"chatRecsList",children:N.slice(0,4).map((q,de)=>r.jsxs("li",{className:"chatRecItem",children:[r.jsxs("div",{className:"chatRecMain",children:[r.jsx("span",{className:"chatRecComposer",children:q.composer}),r.jsx("span",{className:"chatRecSep",children:"—"}),r.jsx("span",{className:"chatRecTitle",children:q.title}),q.era?r.jsxs("span",{className:"chatRecEra",children:["(",q.era,")"]}):null]}),r.jsx("div",{className:"chatRecWhy",children:q.why}),r.jsxs("div",{className:"chatRecActions",children:[r.jsx("button",{className:"chatRecPlay",onClick:()=>void ot(q),disabled:!!W[xe(q)],"data-no-swipe":!0,children:ve===xe(q)?"停止":W[xe(q)]?"取得中…":"再生"}),Ve[xe(q)]?.trackUrl?r.jsx("a",{className:"chatRecOpen",href:Ve[xe(q)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),pe[xe(q)]?r.jsx("div",{className:"chatRecErr",children:pe[xe(q)]}):null]},de))}):r.jsx("div",{className:"chatRecsEmpty",children:"会話をすると、ここにおすすめが出ます。"})]})]})]})}const uu=()=>r.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative",height:"100%",minHeight:0},children:r.jsx(lu,{})});function co(n=4){const e=Math.max(2,Math.min(8,Math.round(n))),t=new Uint8Array(e);for(let i=0;i<e;i+=1)t[i]=Math.round(i/(e-1)*255);const s=new Ha(t,e,1,Xa);return s.minFilter=Hs,s.magFilter=Hs,s.generateMipmaps=!1,s.needsUpdate=!0,s}function lo(n=64){const e=Math.max(8,Math.min(256,Math.round(n))),t=new Uint8Array(e*e);for(let i=0;i<t.length;i+=1)t[i]=Math.floor(Math.random()*256);const s=new Ha(t,e,e,Xa);return s.wrapS=ra,s.wrapT=ra,s.minFilter=Hs,s.magFilter=Hs,s.generateMipmaps=!1,s.needsUpdate=!0,s}function Un(n,e,t={}){if(!n)return;const s=Math.max(0,Math.min(.35,Number(t.strength??.08))),i=Math.max(1,Math.min(64,Number(t.scale??10))),a=Math.max(0,Math.min(2,Number(t.speed??.35)));n.onBeforeCompile=o=>{o.uniforms.uNoiseTex={value:e},o.uniforms.uTime={value:0},o.uniforms.uGrainStrength={value:s},o.uniforms.uGrainScale={value:i},o.uniforms.uGrainSpeed={value:a},o.fragmentShader=o.fragmentShader.replace("#include <common>",`#include <common>

uniform sampler2D uNoiseTex;
uniform float uTime;
uniform float uGrainStrength;
uniform float uGrainScale;
uniform float uGrainSpeed;
`).replace("#include <dithering_fragment>",`#include <dithering_fragment>

// Subtle paper-grain (illustration vibe)
// Guard UV usage: vUv only exists when USE_UV is enabled.
vec2 grainBaseUv = vec2(0.0);
#ifdef USE_UV
  grainBaseUv = vUv;
#else
  // Stable fallback on materials without UVs.
  grainBaseUv = gl_FragCoord.xy * 0.001;
#endif

vec2 grainUv = grainBaseUv * uGrainScale + vec2(uTime * uGrainSpeed * 0.13, uTime * uGrainSpeed * 0.07);
float g = texture2D(uNoiseTex, fract(grainUv)).r;
float grain = (g - 0.5) * 0.28;
vec3 grained = gl_FragColor.rgb * (1.0 + grain);
gl_FragColor.rgb = mix(gl_FragColor.rgb, grained, uGrainStrength);
`),n.userData.__grainShader=o},n.userData.__grain={strength:s,scale:i,speed:a},n.needsUpdate=!0}function Bn(n,e){if(!n)return;const t=n.userData?.__grainShader;t?.uniforms?.uTime&&(t.uniforms.uTime.value=Number(e)||0)}const du=({album:n,basePosition:e,isFocused:t,dimmed:s,focusedPosition:i,faceOut:a,yaw:o,dragging:l,onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:h,onToggleFaceOut:m,onRotateLeft:f,onRotateRight:p,onClick:g,onDoubleClick:v})=>{const y=_.useRef(null),w=_.useRef(null),N=_.useRef(null),j=_.useRef(0),[x,k]=R.useState(!1),S=_.useMemo(()=>co(4),[]),b=_.useMemo(()=>lo(64),[]),T=_.useRef(null),A=_.useRef(null),P=_.useRef(null);_.useEffect(()=>(Un(T.current,b,{strength:.1,scale:18,speed:.28}),Un(A.current,b,{strength:.06,scale:14,speed:.22}),Un(P.current,b,{strength:.06,scale:12,speed:.2}),()=>{S.dispose(),b.dispose()}),[b,S]);const O=.22,U=1.45,E=.55,I=n.gallery?.spineColor||"#111111",{spineBaseColor:F,accentColor:D}=_.useMemo(()=>{const H=new Pn("#f7f5f0"),$=new Pn(I);return $.lerp(new Pn("#ffffff"),.55),s&&(H.lerp(new Pn("#d7d7d7"),.35),$.lerp(new Pn("#d7d7d7"),.55)),{spineBaseColor:`#${H.getHexString()}`,accentColor:`#${$.getHexString()}`}},[I,s]),Y=s?"#b5b5b5":"#ffffff",z=n.title||n.mood,te=_.useMemo(()=>new Date(n.createdAt).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}),[n.createdAt]),Q=Rc(Fc,n.imageDataURL);return _.useEffect(()=>{Q.colorSpace=Lc,Q.anisotropy=4,Q.needsUpdate=!0},[Q]),Sn((H,$)=>{if(y.current){const C=t&&i?i:e;if(l)y.current.position.set(C[0],C[1],C[2]);else{const M=1-Math.exp(-(t?10:12)*$);y.current.position.lerp(new Zt(C[0],C[1],C[2]),M)}}if(y.current){const C=typeof o=="number"?o:0;if(l)y.current.rotation.y=C;else{const L=1-Math.exp(-12*$);y.current.rotation.y=Ws.lerp(y.current.rotation.y,C,L)}}const ee=l||t?1:a?.35:0;if(j.current=Ws.lerp(j.current,ee,1-Math.exp(-8*$)),N.current){const C=j.current;N.current.position.z=E/2+.04+C*.85,N.current.position.y=.05+C*.06,N.current.scale.setScalar(.92+C*.08),N.current.visible=C>.01}if(w.current){const C=j.current;w.current.scale.y=1+C*.02}if(y.current&&!l){const C=t?1.06:s?.985:1,L=1-Math.exp(-10*$),M=y.current.scale.x,J=Ws.lerp(M,C,L);y.current.scale.setScalar(J)}const V=H.clock.elapsedTime;Bn(T.current,V),Bn(A.current,V),Bn(P.current,V)}),r.jsxs("group",{ref:y,children:[r.jsxs("mesh",{ref:w,onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:H=>{H.stopPropagation();try{H.nativeEvent?.preventDefault?.()}catch{}h?.()},onClick:H=>{H.stopPropagation(),g?.()},onDoubleClick:H=>{H.stopPropagation(),v?.()},onPointerOver:H=>{H.stopPropagation(),k(!0)},onPointerOut:H=>{H.stopPropagation(),k(!1)},castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[O,U,E]}),r.jsx("meshToonMaterial",{ref:T,color:F,gradientMap:S})]}),r.jsxs("mesh",{position:[0,.18,E/2+.002],castShadow:!1,children:[r.jsx("planeGeometry",{args:[O*.92,U*.22]}),r.jsx("meshToonMaterial",{ref:A,color:D,gradientMap:S,transparent:!!s,opacity:s?.35:.95})]}),r.jsxs("group",{position:[O/2-.05,U/2-.12,E/2+.03],children:[n.isPublic&&r.jsxs("mesh",{position:[0,0,0],children:[r.jsx("boxGeometry",{args:[.06,.06,.02]}),r.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1,transparent:!!s,opacity:s?.25:1})]}),n.isFavorite&&r.jsxs("mesh",{position:[0,-.08,0],children:[r.jsx("boxGeometry",{args:[.06,.06,.02]}),r.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1,transparent:!!s,opacity:s?.25:1})]})]}),x&&!l&&!s?r.jsx(ia,{position:[0,U/2+.22,E/2+.06],center:!0,style:{pointerEvents:"none"},transform:!0,distanceFactor:8,children:r.jsxs("div",{className:"book-tooltip",children:[r.jsx("div",{className:"book-tooltip-title",children:z}),r.jsx("div",{className:"book-tooltip-sub",children:te})]})}):null,t&&!l?r.jsx(ia,{position:[0,-U/2-.22,E/2+.08],center:!0,transform:!0,distanceFactor:10,style:{pointerEvents:"auto"},children:r.jsxs("div",{className:"book-focus-controls",children:[r.jsx("button",{type:"button",className:"book-focus-btn",onPointerDown:H=>{H.stopPropagation()},onClick:H=>{H.stopPropagation(),m?.()},children:a?"背表紙に戻す":"表紙を向ける"}),r.jsx("button",{type:"button",className:"book-focus-btn book-focus-icon","aria-label":"左に回転",onPointerDown:H=>{H.stopPropagation()},onClick:H=>{H.stopPropagation(),f?.()},children:"↺"}),r.jsx("button",{type:"button",className:"book-focus-btn book-focus-icon","aria-label":"右に回転",onPointerDown:H=>{H.stopPropagation()},onClick:H=>{H.stopPropagation(),p?.()},children:"↻"})]})}):null,r.jsxs("group",{ref:N,position:[0,.05,E/2+.04],visible:!1,children:[r.jsxs("mesh",{onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:H=>{H.stopPropagation();try{H.nativeEvent?.preventDefault?.()}catch{}h?.()},onClick:H=>{H.stopPropagation(),g?.()},onDoubleClick:H=>{H.stopPropagation(),v?.()},castShadow:!0,children:[r.jsx("planeGeometry",{args:[1.1,1.55]}),r.jsx("meshToonMaterial",{ref:P,map:Q,color:Y,gradientMap:S})]}),r.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[1.14,1.6]}),r.jsx("meshToonMaterial",{color:"#ffffff",opacity:s?.14:.45,transparent:!0,gradientMap:S})]})]})]})},uo="airia-bookshelf-layout-v1",ho="airia-bookshelf-layout-v2",yi="airia-bookshelf-layout-v3";function ei(n){try{const e=localStorage.getItem(n);return e?JSON.parse(e):null}catch{return null}}function hu(n){try{localStorage.setItem(yi,JSON.stringify(n))}catch{}}function mu(n,e,t){const s=typeof n=="number"?n:Number(n);if(!Number.isFinite(s))return null;const i=Math.trunc(s);return i<e?e:i>t?t:i}function cs(n,e){const t=new Set(e),s={};let i=!1;const a=new Set,o=[];if(n&&typeof n=="object")for(const[l,c]of Object.entries(n)){if(!t.has(l)){i=!0;continue}const u=mu(c,0,1e4);if(u===null){i=!0;continue}if(a.has(u)){o.push(l),i=!0;continue}a.add(u),s[l]=u}for(const l of e){if(s[l]!==void 0)continue;let c=0;for(;a.has(c);)c+=1;a.add(c),s[l]=c,i=!0}for(const l of o){if(!t.has(l))continue;let c=0;for(;a.has(c);)c+=1;a.add(c),s[l]=c}return{slotById:s,changed:i}}function pu(n){const e=ei(ho);if(e&&typeof e=="object"){const u=e.slotById&&typeof e.slotById=="object"?e.slotById:null,d=e.faceOutIds&&typeof e.faceOutIds=="object"?e.faceOutIds:void 0;return{slotById:cs(u,n).slotById,faceOutIds:d}}const t=ei(uo);if(!t||typeof t!="object")return null;const s={},i=Array.isArray(t.orderIds)?t.orderIds:[],a=new Set(n);let o=0;for(const u of i)a.has(u)&&(s[u]=o,o+=1);for(const u of n)s[u]===void 0&&(s[u]=o,o+=1);const l=t.faceOutIds&&typeof t.faceOutIds=="object"?t.faceOutIds:void 0;return{slotById:cs(s,n).slotById,faceOutIds:l}}function Os(n){const e=ei(yi);if(e&&typeof e=="object"){const s=e.slotById&&typeof e.slotById=="object"?e.slotById:null,i=e.faceOutIds&&typeof e.faceOutIds=="object"?e.faceOutIds:void 0,a=e.poseById&&typeof e.poseById=="object"?e.poseById:void 0,o=e.yawById&&typeof e.yawById=="object"?e.yawById:void 0;return{slotById:cs(s,n).slotById,faceOutIds:i,poseById:a,yawById:o}}const t=pu(n);return t?{slotById:t.slotById,faceOutIds:t.faceOutIds}:null}const fu=({albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s,inputRef:i,layoutEditEnabled:a,layoutSnapEnabled:o,layoutResetToken:l})=>{const{viewport:c}=Vc(),u=_.useRef(null),d=_.useRef(null),h=_.useRef(null),m=_.useMemo(()=>co(4),[]),f=_.useMemo(()=>lo(64),[]),p=_.useRef(null),g=_.useRef(null),v=_.useRef(null);_.useEffect(()=>(Un(p.current,f,{strength:.07,scale:14,speed:.25}),Un(g.current,f,{strength:.05,scale:10,speed:.18}),Un(v.current,f,{strength:.08,scale:16,speed:.22}),()=>{m.dispose(),f.dispose()}),[f,m]);const y=_.useMemo(()=>n.map(B=>B.id),[n]),[w,N]=_.useState(()=>{const B=Os(y);return cs(B?.slotById??null,y).slotById}),[j,x]=_.useState(()=>{const G=Os(y)?.faceOutIds;return G&&typeof G=="object"?G:{}}),[k,S]=_.useState(()=>{const G=Os(y)?.poseById;return G&&typeof G=="object"?G:{}}),[b,T]=_.useState(()=>{const B=Os(y),G=B?.yawById;if(G&&typeof G=="object")return G;const ne=B?.poseById,le={};if(ne&&typeof ne=="object")for(const[fe,ue]of Object.entries(ne)){const ye=ue?.yaw;typeof ye=="number"&&Number.isFinite(ye)&&(le[fe]=ye)}return le}),[A,P]=_.useState(null),O=A!==null,U=_.useRef(0),E=_.useRef(0),I=_.useRef({activeId:null,pointerId:null,startSlot:-1,hoverSlot:-1,moved:!1,startClientX:0,startClientY:0,dragPos:null,mode:"move",startYaw:0,tempYaw:null});_.useEffect(()=>{const B=cs(w,y);B.changed&&N(B.slotById)},[y,w]),_.useEffect(()=>{const B=new Set(y);x(G=>{let ne=!1;const le={};for(const[fe,ue]of Object.entries(G)){if(!B.has(fe)){ne=!0;continue}ue&&(le[fe]=!0)}return ne?le:G})},[y]),_.useEffect(()=>{const B=new Set(y);T(G=>{let ne=!1;const le={};for(const[fe,ue]of Object.entries(G)){if(!B.has(fe)){ne=!0;continue}const ye=typeof ue=="number"?ue:Number(ue);if(!Number.isFinite(ye)){ne=!0;continue}le[fe]=ye}return ne?le:G})},[y]),_.useEffect(()=>{const B=new Set(y);S(G=>{let ne=!1;const le={};for(const[fe,ue]of Object.entries(G)){if(!B.has(fe)){ne=!0;continue}if(!ue||typeof ue!="object"){ne=!0;continue}const ye=typeof ue.x=="number"?ue.x:Number(ue.x),Ue=typeof ue.y=="number"?ue.y:Number(ue.y);if(!Number.isFinite(ye)||!Number.isFinite(Ue)){ne=!0;continue}const xe=ue.yaw,Be=typeof xe=="number"&&Number.isFinite(xe)?xe:void 0;le[fe]={x:ye,y:Ue,yaw:Be}}return ne?le:G})},[y]),_.useEffect(()=>{hu({slotById:w,faceOutIds:j,poseById:k,yawById:b})},[w,j,k,b]),_.useEffect(()=>{if(!l)return;try{localStorage.removeItem(yi),localStorage.removeItem(ho),localStorage.removeItem(uo)}catch{}const B={};for(let G=0;G<y.length;G+=1)B[y[G]]=G;N(B),x({}),S({}),T({}),P(null)},[l,y]),_.useEffect(()=>{A?i.current.blockPan=!0:I.current.activeId||(i.current.blockPan=!1)},[A,i]);const F=_.useMemo(()=>{const B=new Map;for(const G of n)B.set(G.id,G);return B},[n]),D=14,Y=_.useMemo(()=>{let B=-1;for(const G of y){const ne=w[G];typeof ne=="number"&&Number.isFinite(ne)&&(B=Math.max(B,Math.trunc(ne)))}return B},[y,w]),z=Math.max(3,Math.ceil(Math.max(1,y.length,Y+1)/D)),te=.3,Q=.22,H=.6,$=D,ee=($-1)*te+Q,V=ee+H*2,C=_.useMemo(()=>Array.from({length:z},(ne,le)=>1.35-le*1.3),[z]),L=_.useMemo(()=>{const B=C[0]+.6,G=C[C.length-1]-.72,ne=Math.max(3.8,B-G),le=(B+G)/2;return{topFrameY:B,bottomFrameY:G,height:ne,centerY:le}},[C]),M=_.useMemo(()=>Math.max(0,V/2-c.width/2+.4),[V,c.width]),J=(B,G,ne)=>Math.max(G,Math.min(ne,B)),X=B=>{const G=Math.max(0,B),ne=Math.min(z-1,Math.floor(G/$)),le=G%$,fe=-ee/2+le*te,ue=C[ne]??C[0];return{x:fe,y:ue,z:0,shelfIndex:ne,col:le}},se=[0,.55,1.55],ve=()=>{P(null),I.current.activeId||(i.current.blockPan=!1)},ke=B=>{x(G=>{const ne={...G,[B]:!G[B]};return ne[B]||delete ne[B],ne})},Ve=(B,G)=>{const ne=Math.PI/12*G;T(le=>({...le,[B]:(le[B]??0)+ne}))},K=B=>{J(Math.round((C[0]-B.y)/(C[0]-C[C.length-1])*(z-1)),0,z-1);let G=0,ne=1/0;for(let ue=0;ue<C.length;ue+=1){const ye=Math.abs(B.y-C[ue]);ye<ne&&(ne=ye,G=ue)}const le=J(B.x,-ee/2,ee/2),fe=J(Math.round((le+ee/2)/te),0,$-1);return G*$+fe};Sn((B,G)=>{const ne=i.current;if(!!I.current.activeId){ne.wheelPx=0,ne.dragPx=0,ne.isDragging=!1;return}const fe=.0022,ue=ne.wheelPx*fe,ye=ne.dragPx*fe;ue!==0&&(E.current+=ue*26,ne.wheelPx=0),ye!==0&&(U.current+=ye,E.current=Ws.lerp(E.current,ye*60,.35),ne.dragPx=0);const Ue=ne.isDragging?.88:.92;E.current*=Math.pow(Ue,G*60),U.current+=E.current*G;const xe=32;U.current<-M?(U.current=-M,E.current*=-.35):U.current>M&&(U.current=M,E.current*=-.35),U.current<-M?E.current+=(-M-U.current)*xe*G:U.current>M&&(E.current-=(U.current-M)*xe*G),u.current&&(u.current.position.x=J(U.current,-M,M));const Be=B.clock.elapsedTime,ot=Math.floor(Be*12)/12;d.current&&(d.current.intensity=.78+Math.sin(ot*1.2)*.04),h.current&&(h.current.intensity=.24+Math.cos(ot*1.05)*.02),Bn(p.current,Be),Bn(g.current,Be),Bn(v.current,Be)});const[W,ie]=_.useState(-1),pe=(B,G,ne)=>{i.current.blockPan=!0,I.current.activeId=B,I.current.pointerId=Number(G?.pointerId??-1),I.current.startSlot=ne,I.current.hoverSlot=ne,I.current.moved=!1,I.current.mode=G?.shiftKey?"rotate":"move",I.current.startYaw=b[B]??0,I.current.tempYaw=null,I.current.startClientX=Number(G?.clientX??G?.nativeEvent?.clientX??0),I.current.startClientY=Number(G?.clientY??G?.nativeEvent?.clientY??0);const le=k[B],fe=X(ne);I.current.dragPos={x:le?.x??fe.x,y:le?.y??fe.y,z:.85},ie(ne);try{G.stopPropagation?.(),G?.nativeEvent?.target?.setPointerCapture?.(G.pointerId)}catch{}},ce=B=>{if(!I.current.activeId)return;const ne=I.current.pointerId;if(ne!==null&&Number(B?.pointerId??-1)!==ne||!u.current)return;const le=Number(B?.clientX??B?.nativeEvent?.clientX??0),fe=Number(B?.clientY??B?.nativeEvent?.clientY??0),ue=le-I.current.startClientX,ye=fe-I.current.startClientY;if(!I.current.moved&&ue*ue+ye*ye>36&&(I.current.moved=!0),I.current.mode==="rotate"){const Je=I.current.startYaw+ue*.012;I.current.tempYaw=Je;const q=I.current.dragPos;q&&(I.current.dragPos={...q});return}const Ue=B?.ray;if(!Ue)return;const xe=new Uc(new Zt(0,0,1),-.25),Be=new Zt;if(!Ue.intersectPlane(xe,Be))return;const dt=u.current.worldToLocal(Be.clone()),Ge=K(dt);I.current.hoverSlot=Ge,I.current.dragPos={x:J(dt.x,-ee/2,ee/2),y:dt.y,z:.85},ie(Ge)},ge=(B,G)=>{if(I.current.activeId!==B)return;const ne=I.current.startSlot,le=I.current.hoverSlot,fe=I.current.moved,ue=I.current.mode,ye=I.current.tempYaw;I.current.activeId=null,I.current.pointerId=null,I.current.startSlot=-1,I.current.hoverSlot=-1,I.current.moved=!1,I.current.dragPos=null,I.current.mode="move",I.current.startYaw=0,I.current.tempYaw=null,ie(-1),i.current.blockPan=!1;try{G?.nativeEvent?.target?.releasePointerCapture?.(G.pointerId)}catch{}if(!fe){A===B?(t||e)(B):e(B);return}if(ue==="rotate"){typeof ye=="number"&&Number.isFinite(ye)&&T(Ue=>({...Ue,[B]:ye}));return}if(a){const Ue=I.current.dragPos,xe=Ue?.x??0,Be=Ue?.y??0,ot=J(xe,-ee/2,ee/2),dt=J(Be,C[C.length-1],C[0]);if(o){const Ge=K(new Zt(ot,dt,0));ne>=0&&Ge>=0&&ne!==Ge&&N(Je=>{const q=Math.max(0,ne),de=Math.max(0,Ge);let Z=null;for(const[Ne,Ie]of Object.entries(Je))if(Ne!==B&&Math.trunc(Ie)===de){Z=Ne;break}const re={...Je,[B]:de};return Z&&(re[Z]=q),re}),S(Je=>{if(!Je[B])return Je;const q={...Je};return delete q[B],q})}else S(Ge=>{const Je=Ge[B]?.yaw;return{...Ge,[B]:{x:ot,y:dt,yaw:Je}}});return}ne>=0&&le>=0&&ne!==le&&N(Ue=>{const xe=Math.max(0,ne),Be=Math.max(0,le);let ot=null;for(const[Ge,Je]of Object.entries(Ue))if(Ge!==B&&Math.trunc(Je)===Be){ot=Ge;break}const dt={...Ue,[B]:Be};return ot&&(dt[ot]=xe),dt})},Xe=B=>{P(G=>G===B?null:B),e(B)},tt=B=>{const G=I.current.activeId;G&&ge(G,B)};return r.jsxs("group",{children:[r.jsx("fog",{attach:"fog",args:["#f5f1ea",6.5,15.5]}),r.jsxs("mesh",{position:[0,-2.15,0],receiveShadow:!0,rotation:[-Math.PI/2,0,0],children:[r.jsx("planeGeometry",{args:[40,20]}),r.jsx("meshToonMaterial",{ref:p,color:"#f6f0e8",gradientMap:m})]}),r.jsxs("mesh",{position:[0,.1,-1.05],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[40,10]}),r.jsx("meshToonMaterial",{ref:g,color:"#fff9f0",gradientMap:m})]}),r.jsxs("group",{ref:u,children:[r.jsxs("mesh",{position:[0,.05,.26],onPointerDown:B=>{A&&(I.current.activeId||(B.stopPropagation(),ve()))},onPointerMove:B=>ce(B),onPointerUp:B=>tt(B),onPointerCancel:B=>tt(B),children:[r.jsx("planeGeometry",{args:[Math.max(14,V+4),Math.max(7,C[0]-C[C.length-1]+5.2)]}),r.jsx("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1})]}),O?r.jsxs("mesh",{position:[0,.05,-.15],raycast:null,children:[r.jsx("planeGeometry",{args:[Math.max(18,V+10),9]}),r.jsx("meshBasicMaterial",{color:"#0b0b0b",opacity:.12,transparent:!0,depthWrite:!1})]}):null,r.jsxs("group",{position:[0,.05,-.25],children:[r.jsxs("mesh",{position:[-V/2+.08,L.centerY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[.16,L.height,.9]}),r.jsx("meshToonMaterial",{ref:v,color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[V/2-.08,L.centerY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[.16,L.height,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[0,L.topFrameY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[V,.18,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[0,L.bottomFrameY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[V,.18,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),C.map((B,G)=>r.jsxs("mesh",{position:[0,B-.78,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[V-.22,.14,.88]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]},G))]}),W>=0&&(!a||o)?r.jsxs("mesh",{position:[X(W).x,X(W).y-.78+.09,.32],rotation:[-Math.PI/2,0,0],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[.34,.72]}),r.jsx("meshStandardMaterial",{color:"#d9d9d9",opacity:.45,transparent:!0,roughness:1,metalness:0})]}):null,y.slice().sort((B,G)=>{const ne=w[B]??999999,le=w[G]??999999;if(ne!==le)return ne-le;const fe=F.get(B),ue=F.get(G);return String(ue?.createdAt??"").localeCompare(String(fe?.createdAt??""))}).map(B=>{const G=F.get(B);if(!G)return null;const ne=w[B]??0,le=X(ne),fe=I.current.activeId===B,ue=fe?I.current.dragPos:null,ye=A===B,Ue=O&&!ye,xe=k[B],Be=xe&&typeof xe.x=="number"&&typeof xe.y=="number",ot=ue?[ue.x,ue.y,ue.z]:[Be?xe.x:le.x,Be?xe.y:le.y,O&&!ye?.12:.25],Ge=fe&&I.current.activeId===B&&I.current.mode==="rotate"?I.current.tempYaw:null,Je=typeof Ge=="number"&&Number.isFinite(Ge)?Ge:b[B]??0;return r.jsx(du,{album:G,basePosition:ot,isFocused:ye,dimmed:Ue,focusedPosition:se,faceOut:!!j[G.id],yaw:Je,dragging:fe,onPointerDown:q=>pe(G.id,q,ne),onPointerMove:q=>ce(q),onPointerUp:q=>ge(G.id,q),onContextMenu:()=>ke(G.id),onToggleFaceOut:()=>ke(G.id),onRotateLeft:()=>Ve(G.id,-1),onRotateRight:()=>Ve(G.id,1),onClick:()=>{A===B?(t||e)(B):e(B)},onDoubleClick:()=>Xe(B)},G.id)})]}),O?r.jsx("pointLight",{position:[0,.8,3.6],intensity:.45,distance:12,decay:2}):null,r.jsx("ambientLight",{intensity:.42}),r.jsx("hemisphereLight",{args:["#fff6e6","#e9e2d6",.22]}),r.jsx("directionalLight",{ref:d,position:[4,6,6],intensity:.78,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),r.jsx("directionalLight",{ref:h,position:[-3,3,4],intensity:.24,color:"#ffe9d6"})]})},gu=({albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s,layoutEditEnabled:i,layoutSnapEnabled:a,layoutResetToken:o})=>{const l=_.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0,blockPan:!1});return r.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:c=>{if(c.preventDefault(),l.current.blockPan)return;const u=Math.abs(c.deltaX)>Math.abs(c.deltaY)?c.deltaX:c.deltaY;l.current.wheelPx+=u},onPointerDown:c=>{l.current.blockPan||i&&!c.altKey||(c.currentTarget.setPointerCapture(c.pointerId),l.current.isDragging=!0,l.current.lastPointerX=c.clientX)},onPointerMove:c=>{if(l.current.blockPan||!l.current.isDragging||i&&!c.altKey)return;const u=c.clientX-l.current.lastPointerX;l.current.lastPointerX=c.clientX,l.current.dragPx+=u},onPointerUp:c=>{try{c.currentTarget.releasePointerCapture(c.pointerId)}catch{}l.current.isDragging=!1,l.current.blockPan=!1},onPointerCancel:()=>{l.current.isDragging=!1,l.current.blockPan=!1},children:r.jsx(Kn,{shadows:!0,camera:{position:[0,.55,7.2],fov:34},gl:{alpha:!0,antialias:!0},children:r.jsx(_.Suspense,{fallback:null,children:r.jsx(fu,{albums:n,onBookClick:e,onBookOpen:t,constellationEnabled:s,inputRef:l,layoutEditEnabled:!!i,layoutSnapEnabled:a??!0,layoutResetToken:o??0})})})})},bn=({title:n,mood:e,imageUrl:t,meta:s,badges:i=[],variant:a="default",className:o})=>r.jsxs("div",{className:`album-card album-card-${a} ${o||""}`.trim(),children:[r.jsx("div",{className:"album-card-image",children:r.jsx("img",{src:t,alt:n,loading:"lazy"})}),r.jsxs("div",{className:"album-card-body",children:[r.jsx("div",{className:"album-card-title",children:n}),e&&r.jsx("div",{className:"album-card-mood",children:e}),s&&r.jsx("div",{className:"album-card-meta",children:s}),i.length>0&&r.jsx("div",{className:"album-card-badges",children:i.map(l=>r.jsx("span",{className:`album-badge tone-${l.tone||"default"}`,children:l.label},l.label))})]})]}),vu=({title:n,description:e,actionLabel:t,onAction:s,icon:i})=>r.jsxs("div",{className:"empty-state",children:[i&&r.jsx("div",{className:"empty-icon",children:i}),r.jsx("h2",{className:"empty-title",children:n}),r.jsx("p",{className:"empty-description",children:e}),t&&s&&r.jsx("button",{onClick:s,className:"empty-cta-button",children:t})]}),Js=({trigger:n,children:e,placement:t="bottom",triggerClassName:s,triggerAriaLabel:i,triggerAriaHaspopup:a,onOpenChange:o})=>{const[l,c]=_.useState(!1),u=_.useRef(null),d=_.useRef(null),h=_.useId(),m=()=>{c(!1),o?.(!1),d.current?.focus()},f=()=>{c(p=>{const g=!p;return o?.(g),g})};return _.useEffect(()=>{if(!l)return;const p=v=>{u.current?.contains(v.target)||m()},g=v=>{v.key==="Escape"&&(v.preventDefault(),m())};return document.addEventListener("mousedown",p),document.addEventListener("keydown",g),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",g)}},[l]),r.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[r.jsx("button",{ref:d,type:"button",className:`popover-trigger ${s||""}`.trim(),onClick:f,"aria-expanded":l,"aria-controls":l?h:void 0,"aria-label":i,"aria-haspopup":a,children:n}),l&&r.jsx("div",{className:"popover-panel",id:h,children:typeof e=="function"?e({close:m}):e})]})},Ks=({items:n,autoFocus:e=!0})=>{const[t,s]=R.useState(0),i=R.useRef([]);R.useEffect(()=>{if(!e||n.length===0)return;const l=i.current[0];l&&l.focus()},[e,n.length]);const a=l=>{const c=Math.max(0,Math.min(n.length-1,l));s(c),i.current[c]?.focus()},o=l=>{if(n.length!==0){if(l.key==="ArrowDown"){l.preventDefault(),a(t+1);return}if(l.key==="ArrowUp"){l.preventDefault(),a(t-1);return}if(l.key==="Home"){l.preventDefault(),a(0);return}if(l.key==="End"){l.preventDefault(),a(n.length-1);return}}};return r.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:o,children:n.map((l,c)=>r.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:c===t?0:-1,ref:u=>{i.current[c]=u},onFocus:()=>s(c),onClick:()=>{s(c),l.onSelect()},type:"button",children:l.label},l.id))})},mo=({items:n,value:e,onChange:t,ariaLabel:s="タブ"})=>{const i=_.useId();return r.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[r.jsx("div",{className:"tabs-list",role:"tablist","aria-label":s,children:n.map(a=>r.jsx("button",{id:`${i}-${a.id}-tab`,role:"tab","aria-selected":e===a.id,"aria-controls":`${i}-${a.id}-panel`,className:`tab-button ${e===a.id?"is-active":""}`,onClick:()=>t(a.id),type:"button",children:a.label},a.id))}),n.map(a=>r.jsx("div",{id:`${i}-${a.id}-panel`,role:"tabpanel","aria-labelledby":`${i}-${a.id}-tab`,hidden:e!==a.id,className:"tab-panel",children:a.content},a.id))]})},ti=({options:n,value:e,onChange:t,ariaLabel:s="選択"})=>r.jsx("div",{className:"segmented-control",role:"group","aria-label":s,"data-no-swipe":"true",children:n.map(i=>r.jsx("button",{type:"button",className:`segmented-item ${e===i.id?"is-active":""}`,"aria-pressed":e===i.id,onClick:()=>t(i.id),children:i.label},i.id))}),yu=()=>{const{albums:n,selectAlbum:e,updateAlbum:t}=qt(),{getSelectedAlbum:s}=qt(),i=s(),{requestPlayAlbum:a}=an(),{navigateToRoom:o}=$t(),[l,c]=R.useState("shelf"),[u,d]=R.useState("all"),[h,m]=R.useState("new"),[f,p]=R.useState("public"),[g,v]=R.useState(!1),[y,w]=R.useState(!0),[N,j]=R.useState(0),x=I=>{e(I)},k=I=>{e(I),o("album")},S=R.useMemo(()=>n.filter(I=>I.musicData),[n]),b=!!i,T=!!i?.musicData,A=R.useMemo(()=>{const I=n.filter(D=>u==="public"?D.isPublic:u==="private"?!D.isPublic:u==="favorite"?D.isFavorite:!0),F=D=>{const Y=Number(D.duration||0);return(D.musicData?1e3:0)+Y};return I.slice().sort((D,Y)=>h==="duration"?(Y.duration||0)-(D.duration||0):h==="popular"?F(Y)-F(D):String(Y.createdAt).localeCompare(String(D.createdAt)))},[n,u,h]),P=h==="popular"?"人気順":h==="duration"?"長さ順":"新しい順",O=r.jsxs("div",{className:"bookshelf-container",children:[r.jsxs("div",{className:`gallery-shelf-stage ${A.length===0?"empty":""}`,children:[r.jsxs("div",{className:"gallery-shelf-hint","aria-hidden":"true",children:[r.jsx("span",{className:"gallery-shelf-hint-pill",children:"HINT"}),r.jsx("span",{className:"gallery-shelf-hint-text",children:"右クリックで表紙 / 背表紙を切り替え（保存されます）"})]}),r.jsx(gu,{albums:A,onBookClick:x,onBookOpen:k,constellationEnabled:!1,layoutEditEnabled:g,layoutSnapEnabled:y,layoutResetToken:N}),A.length===0&&r.jsx("div",{className:"empty-shelf-overlay",children:r.jsx(vu,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>o("main"),icon:r.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),r.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[r.jsxs("div",{className:"gallery-selection",children:[r.jsx("div",{className:"gallery-selection-label",children:"選択中"}),r.jsx("div",{className:"gallery-selection-value",children:i?i.title||i.mood:"未選択"})]}),r.jsxs("div",{className:"gallery-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!b,onClick:()=>o("album"),children:"開く"}),r.jsx("button",{className:"btn btn-primary",disabled:!T||!i,onClick:()=>{i&&a(i,S)},children:"再生"}),r.jsx("button",{className:"btn",disabled:!b,onClick:()=>o("social"),children:"公開"}),r.jsx(Js,{triggerClassName:"btn",trigger:r.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:I})=>r.jsx(Ks,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{o("album"),I()}},{id:"publish",label:"SNSに公開",onSelect:()=>{o("social"),I()}},{id:"play",label:"再生",onSelect:()=>{i&&(a(i,S),I())}},{id:"favorite",label:i?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{i&&(t(i.id,{isFavorite:!i.isFavorite}),I())}},{id:"public",label:i?.isPublic?"非公開にする":"公開にする",onSelect:()=>{i&&(t(i.id,{isPublic:!i.isPublic}),I())}}]})})]})]})]}),U=r.jsx("div",{className:"gallery-focus",children:i?r.jsxs("div",{className:"gallery-focus-card room-card",children:[r.jsx(bn,{title:i.title||i.mood,mood:i.mood,imageUrl:i.imageDataURL,meta:`作成日: ${new Date(i.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:i.musicData?"再生可能":"音声なし",tone:i.musicData?"success":"default"},...i.isPublic?[{label:"公開中",tone:"info"}]:[],...i.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),r.jsxs("div",{className:"gallery-focus-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:()=>o("album"),children:"詳細へ"}),r.jsx("button",{className:"btn btn-primary",disabled:!i.musicData,onClick:()=>a(i,S),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>o("social"),children:"公開"})]})]}):r.jsxs("div",{className:"gallery-focus-empty room-card",children:[r.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),r.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),E=[{id:"shelf",label:"Shelf",content:O},{id:"focus",label:"Focus",content:U}];return r.jsxs("div",{className:"room-content gallery-room",children:[r.jsx(ro,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),r.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"gallery-toolbar-left",children:[r.jsx(ti,{value:u,onChange:I=>d(I),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),r.jsxs("div",{className:"gallery-filter-tags",children:[r.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),r.jsx("span",{className:"filter-tag",children:P}),r.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",f==="public"?"公開":"お気に入り"]})]})]}),r.jsxs("div",{className:"gallery-toolbar-right",children:[r.jsx("button",{type:"button",className:`btn ${g?"btn-primary":""}`,onClick:()=>v(I=>!I),"aria-pressed":g,children:g?"レイアウト編集: ON":"レイアウト編集: OFF"}),g?r.jsxs(r.Fragment,{children:[r.jsx("button",{type:"button",className:"btn",onClick:()=>w(I=>!I),"aria-pressed":y,children:y?"スナップ: ON":"スナップ: OFF"}),r.jsx("button",{type:"button",className:"btn",onClick:()=>j(I=>I+1),children:"配置リセット"})]}):null,r.jsx(ti,{value:f,onChange:I=>p(I),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),r.jsx(Js,{triggerClassName:"btn",trigger:r.jsxs("span",{children:["並び替え: ",P]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:I})=>r.jsx(Ks,{items:[{id:"new",label:"新しい順",onSelect:()=>{m("new"),I()}},{id:"popular",label:"人気順",onSelect:()=>{m("popular"),I()}},{id:"duration",label:"長さ順",onSelect:()=>{m("duration"),I()}}]})})]})]}),r.jsx(mo,{items:E,value:l,onChange:c,ariaLabel:"ギャラリー表示"})]})},bu=2147483647,xu=({log:n})=>{if(!n)return r.jsxs("div",{className:"explainability-panel",children:[r.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),r.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const s=Math.round(t/1e3);if(s<60)return`${s}秒`;const i=Math.floor(s/60),a=s%60;return`${i}分${a}秒`};return r.jsxs("div",{className:"explainability-panel",children:[r.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),n.analysis&&r.jsxs("div",{className:"explainability-section timeline-section",children:[r.jsx("h4",{className:"section-title",children:"生成フロー"}),r.jsxs("div",{className:"timeline",children:[r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"入力"}),r.jsx("span",{className:"timeline-value",children:new Date(n.input.timestamp).toLocaleTimeString("ja-JP")})]}),n.analysis&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"解析"}),r.jsxs("span",{className:"timeline-value",children:[e(n.analysis.duration)," (",n.analysis.provider,")"]})]}),n.imageGeneration&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"画像生成"}),r.jsxs("span",{className:"timeline-value",children:[e(n.imageGeneration.duration)," (",n.imageGeneration.provider,")"]})]}),n.musicGeneration&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"音楽生成"}),r.jsxs("span",{className:"timeline-value",children:[e(n.musicGeneration.duration)," (",n.musicGeneration.provider,")"]})]}),n.album&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"完成"}),r.jsxs("span",{className:"timeline-value",children:["合計: ",e(n.totalDuration)]})]})]})]}),n.analysis&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"感情分析"}),r.jsxs("div",{className:"analysis-explanation",children:[r.jsxs("div",{className:"ir-values",children:[r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Valence:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${(n.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:n.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),r.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.valence.toFixed(2)})]}),r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Arousal:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),r.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Focus:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),r.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),r.jsxs("div",{className:"motif-tags",children:[r.jsx("strong",{children:"モチーフタグ:"})," ",n.analysis.intermediateRepresentation.motif_tags.join("、")]}),r.jsxs("div",{className:"reasoning-text",children:[r.jsx("strong",{children:"理由:"})," ",n.analysis.reasoning]})]})]}),n.imageGeneration&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),r.jsxs("div",{className:"image-explanation",children:[r.jsx("p",{className:"reasoning-text",children:n.imageGeneration.reasoning}),r.jsxs("div",{className:"image-details",children:[r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"スタイル:"}),r.jsx("span",{className:"detail-value",children:n.imageGeneration.stylePreset})]}),n.imageGeneration.seed&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"Seed:"}),r.jsx("span",{className:"detail-value",children:n.imageGeneration.seed})]}),r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"モデル:"}),r.jsx("span",{className:"detail-value",children:n.imageGeneration.model})]})]})]})]}),n.musicGeneration&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),r.jsxs("div",{className:"music-explanation",children:[r.jsx("p",{className:"reasoning-text",children:n.musicGeneration.reasoning}),r.jsx("div",{className:"music-details",children:n.musicGeneration.structure&&typeof n.musicGeneration.structure=="object"&&r.jsxs(r.Fragment,{children:[n.musicGeneration.structure.key&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"調:"}),r.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.key})]}),n.musicGeneration.structure.tempo&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"テンポ:"}),r.jsxs("span",{className:"detail-value",children:[n.musicGeneration.structure.tempo," BPM"]})]}),n.musicGeneration.structure.timeSignature&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"拍子:"}),r.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.timeSignature})]}),n.musicGeneration.structure.form&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"形式:"}),r.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.form})]})]})})]})]}),n.errors&&n.errors.length>0&&r.jsxs("div",{className:"explainability-section error-section",children:[r.jsx("h4",{className:"section-title",children:"エラー"}),r.jsx("div",{className:"errors-list",children:n.errors.map((t,s)=>r.jsxs("div",{className:"error-item",children:[r.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),r.jsx("span",{className:"error-message",children:t.error})]},s))})]})]})},_u=({dominantColors:n=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:s=0,highlightedLayer:i=-1})=>{const a=_.useRef(null),o=_.useRef(),l=_.useRef([]);return _.useEffect(()=>{const c=a.current;if(!c)return;const u=c.getContext("2d");if(!u)return;const d=()=>{const p=c.parentElement;p&&(c.width=p.clientWidth,c.height=p.clientHeight)};d(),window.addEventListener("resize",d);const h=Math.min(5,n.length+2);l.current=Array.from({length:h},(p,g)=>({radius:50+g*30,maxRadius:200+g*50,color:n[g%n.length]||"#D4AF37",phase:g*Math.PI*2/h,phaseSpeed:5e-4+g*2e-4}));let m=0;const f=p=>{const g=p-m;m=p,u.clearRect(0,0,c.width,c.height);const v=c.width/2,y=c.height/2;l.current.forEach((w,N)=>{w.phase+=w.phaseSpeed*g;const j=Math.sin(w.phase),x=20+(e?t*30:0),k=w.radius+j*x,S=.1,b=.3,T=s*.2,A=i===N?.3:0,P=e?t*.15:0,O=Math.min(b,S+T+A+P),U=u.createRadialGradient(v,y,k-20,v,y,k+20);U.addColorStop(0,`${w.color}00`),U.addColorStop(.5,`${w.color}${Math.floor(O*255).toString(16).padStart(2,"0")}`),U.addColorStop(1,`${w.color}00`),u.fillStyle=U,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(v,y,k,0,Math.PI*2),u.fill()}),o.current=requestAnimationFrame(f)};return o.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",d),o.current&&cancelAnimationFrame(o.current),u.clearRect(0,0,c.width,c.height)}},[n,e,t,s,i]),r.jsx("canvas",{ref:a,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},wu=()=>{const[n,e]=_.useState({x:0,y:0});return _.useEffect(()=>{const t=s=>{e({x:s.clientX,y:s.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),n},Nu=(n,e=200)=>{const[t,s]=_.useState(0),i=wu();return _.useEffect(()=>{if(!n.current)return;const a=n.current.getBoundingClientRect(),o=a.left+a.width/2,l=a.top+a.height/2,c=Math.sqrt(Math.pow(i.x-o,2)+Math.pow(i.y-l,2)),u=Math.max(0,1-c/e);s(u)},[i,n,e]),t},Su=()=>{const{getSelectedAlbum:n,selectAlbum:e,addAlbum:t,updateAlbum:s}=qt(),{getLog:i}=Za(),{state:a,requestPlayAlbum:o}=an(),{navigateToRoom:l}=$t(),c=n(),u=E=>{const I=new Date(E);return Number.isNaN(I.getTime())?"":I.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},[d,h]=_.useState("");_.useEffect(()=>{h(c?.memo||"")},[c?.id]);const m=c?.causalLogId?i(c.causalLogId):void 0,f=(E,I=2400)=>{try{const F=JSON.stringify(E,null,2)??"";return F.length<=I?F:`${F.slice(0,I)}
…(truncated)`}catch{return""}},[p,g]=_.useState(!1),[v,y]=_.useState(null),[w,N]=_.useState(!1),j=_.useRef(null),x=Nu(j,300),[k,S]=_.useState(-1),b=E=>{const I=j.current;if(!I)return;const F=I.getBoundingClientRect(),D=(E.clientX-F.left)/Math.max(1,F.width),Y=(E.clientY-F.top)/Math.max(1,F.height),z=Math.max(0,Math.min(1,D)),te=Math.max(0,Math.min(1,Y)),Q=(z-.5)*10,H=(.5-te)*7;I.style.setProperty("--tilt-x",`${H.toFixed(2)}deg`),I.style.setProperty("--tilt-y",`${Q.toFixed(2)}deg`),I.style.setProperty("--shine-x",`${(z*100).toFixed(1)}%`),I.style.setProperty("--shine-y",`${(te*100).toFixed(1)}%`)},T=()=>{const E=j.current;E&&(E.style.setProperty("--tilt-x","0deg"),E.style.setProperty("--tilt-y","0deg"),E.style.setProperty("--shine-x","50%"),E.style.setProperty("--shine-y","45%"))},A=c?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],P=a.playbackState===bt.PLAYING&&a.currentAlbum?.id===c?.id,O=()=>{e(null),l("gallery")},U=async()=>{if(!c||!c.metadata){y("メタデータが見つかりません");return}try{g(!0),y(null),N(!1);const E=Math.floor(Math.random()*bu),I=await Qr({mood:c.mood,duration:c.duration,motifTags:c.metadata.motif_tags||[],stylePreset:c.metadata.stylePreset,seed:E,valence:c.metadata.valence,arousal:c.metadata.arousal,focus:c.metadata.focus,confidence:c.metadata.confidence}),F=await Gs(I.jobId,D=>{console.log("Regenerate status:",D)});if(F.status==="succeeded"&&F.resultUrl)t({mood:c.mood,duration:c.duration,imageDataURL:F.resultUrl,sessionData:c.sessionData,metadata:{...c.metadata,seed:E}}),N(!0),setTimeout(()=>N(!1),3e3);else throw new Error(F.errorMessage||"再生成に失敗しました")}catch(E){y(E instanceof Error?E.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",E)}finally{g(!1)}};return c?r.jsxs("div",{className:"room-content album-room",children:[r.jsxs("div",{className:"album-header room-header",children:[r.jsxs("div",{className:"album-header-left",children:[r.jsx("h1",{className:"album-title",children:c.title||c.mood}),r.jsxs("p",{className:"album-subtitle",children:["ムード: ",c.mood," ・ 選択したアルバムの詳細"]})]}),r.jsxs("div",{className:"album-header-actions room-header-actions",children:[r.jsx("button",{className:"btn back-to-gallery-btn",onClick:O,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),r.jsx("button",{className:"btn btn-primary",disabled:!c.musicData,onClick:()=>o(c),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>l("social"),children:"公開"}),r.jsx(Js,{triggerClassName:"btn",trigger:r.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:E})=>r.jsx(Ks,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{l("gallery"),E()}},{id:"publish",label:"SNSに公開",onSelect:()=>{l("social"),E()}},{id:"play",label:"再生",onSelect:()=>{o(c),E()}},{id:"favorite",label:c.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{s(c.id,{isFavorite:!c.isFavorite}),E()}},{id:"public",label:c.isPublic?"非公開にする":"公開にする",onSelect:()=>{s(c.id,{isPublic:!c.isPublic}),E()}}]})})]})]}),r.jsxs("div",{className:"album-details",children:[r.jsx("div",{className:"album-media",children:r.jsxs("div",{className:`album-image-container ${P?"is-playing":""}`,ref:j,onMouseMove:b,onMouseLeave:T,children:[r.jsx(_u,{dominantColors:A,isPlaying:P,beatAmplitude:0,mouseProximity:x,highlightedLayer:k}),r.jsx("img",{src:c.imageDataURL,alt:`${c.mood}のセッション画像`,className:"album-image"})]})}),r.jsxs("div",{className:"album-metadata",children:[r.jsxs("div",{className:"album-meta-card","data-no-swipe":"true",children:[r.jsx("div",{className:"album-meta-title",children:"作品情報"}),r.jsxs("div",{className:"album-meta-grid",children:[r.jsx("div",{className:"album-meta-k",children:"タイトル"}),r.jsx("div",{className:"album-meta-v",children:c.title||c.mood}),r.jsx("div",{className:"album-meta-k",children:"作成"}),r.jsx("div",{className:"album-meta-v",children:c.createdAt?u(c.createdAt):""}),r.jsx("div",{className:"album-meta-k",children:"公開"}),r.jsx("div",{className:"album-meta-v",children:c.isPublic?"公開":"非公開"}),r.jsx("div",{className:"album-meta-k",children:"お気に入り"}),r.jsx("div",{className:"album-meta-v",children:c.isFavorite?"Yes":"No"}),r.jsx("div",{className:"album-meta-k",children:"長さ"}),r.jsx("div",{className:"album-meta-v",children:c.duration?`${c.duration} sec`:""}),r.jsx("div",{className:"album-meta-k",children:"ムード"}),r.jsx("div",{className:"album-meta-v",children:c.mood}),r.jsx("div",{className:"album-meta-k",children:"ID"}),r.jsx("div",{className:"album-meta-v album-meta-id",children:c.id})]})]}),r.jsx("div",{className:"album-summary-card",children:r.jsx(bn,{variant:"compact",title:c.title||c.mood,mood:c.mood,imageUrl:c.imageDataURL,meta:`作成日: ${new Date(c.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:c.musicData?"再生可能":"音声なし",tone:c.musicData?"success":"default"},...c.isPublic?[{label:"公開中",tone:"info"}]:[],...c.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),r.jsxs("section",{className:"metadata-section","aria-label":"アルバムメモ",children:[r.jsx("h2",{className:"metadata-section-title",children:"メモ（ひとこと）"}),r.jsx("textarea",{className:"album-memo-input",value:d,onChange:E=>h(E.target.value),onBlur:()=>{const E=d.trim();(c.memo||"")!==E&&s(c.id,{memo:E||void 0})},placeholder:"この作品にひとこと。気づき、風景、だれにも見せないメモでも。",rows:3}),r.jsx("div",{className:"album-memo-hint",children:"フォーカスが外れると自動で保存します。"})]}),c.metadata&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"分析結果 (IR)"}),c.metadata.valence!==void 0&&r.jsxs("div",{className:"metadata-item",onMouseEnter:()=>S(0),onMouseLeave:()=>S(-1),children:[r.jsx("span",{className:"metadata-label",children:"Valence"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.valence.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.valence>0?"明るい":"暗い",")"]})]})]}),c.metadata.arousal!==void 0&&r.jsxs("div",{className:"metadata-item",onMouseEnter:()=>S(1),onMouseLeave:()=>S(-1),children:[r.jsx("span",{className:"metadata-label",children:"Arousal"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.arousal.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.arousal>.6?"動的":"静的",")"]})]})]}),c.metadata.focus!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"Focus"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.focus.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),c.metadata.confidence!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"信頼度"}),r.jsxs("span",{className:"metadata-value",children:[Math.round(c.metadata.confidence*100),"%"]})]}),c.metadata.motif_tags&&c.metadata.motif_tags.length>0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"モチーフ"}),r.jsx("span",{className:"metadata-value metadata-tags",children:c.metadata.motif_tags.join(", ")})]})]}),r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"生成情報"}),c.metadata.stylePreset&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"スタイル"}),r.jsx("span",{className:"metadata-value",children:c.metadata.stylePreset})]}),c.metadata.seed!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"シード"}),r.jsx("span",{className:"metadata-value metadata-id",children:c.metadata.seed})]}),c.metadata.provider&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"生成方法"}),r.jsx("span",{className:"metadata-value",children:c.metadata.provider==="comfyui"?"ComfyUI":c.metadata.provider==="local"?"ローカル生成":c.metadata.provider==="replicate"?"ComfyUI（旧: Replicate）":c.metadata.provider})]})]}),(c.metadata.prompt||c.metadata.negativePrompt)&&r.jsxs("details",{className:"metadata-section album-details-toggle",children:[r.jsx("summary",{className:"metadata-section-title",children:"プロンプト"}),c.metadata.prompt?r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Prompt"}),r.jsx("pre",{className:"album-text-pre",children:c.metadata.prompt})]}):null,c.metadata.negativePrompt?r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Negative"}),r.jsx("pre",{className:"album-text-pre",children:c.metadata.negativePrompt})]}):null]}),c.musicMetadata&&r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"調"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.key})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"テンポ"}),r.jsxs("span",{className:"metadata-value",children:[c.musicMetadata.tempo," BPM"]})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"拍子"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.timeSignature})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"形式"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.form})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"性格"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.character})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"生成方法"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":c.musicMetadata.provider==="rule-based"?"ルールベース":c.musicMetadata.provider})]}),c.musicData&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"フォーマット"}),r.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(c.musicData.length/1024)," KB)"]})]})]}),c.metadata.provider!=="local"&&r.jsxs("div",{className:"album-actions",children:[r.jsx("button",{className:"regenerate-btn",onClick:U,disabled:p,children:p?"再生成中...":"再生成 (新しいシード)"}),w&&r.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),v&&r.jsx("div",{className:"regenerate-error",children:v})]})]}),c.sessionData?r.jsxs("details",{className:"metadata-section album-details-toggle",children:[r.jsx("summary",{className:"metadata-section-title",children:"セッションデータ（概要）"}),r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Keys"}),r.jsx("div",{className:"album-text-inline",children:typeof c.sessionData=="object"&&c.sessionData!==null?Object.keys(c.sessionData).slice(0,24).join(", "):typeof c.sessionData})]}),r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Preview"}),r.jsx("pre",{className:"album-text-pre",children:f(c.sessionData)})]})]}):null,c.causalLogId||m?r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"因果ログ"}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"Log ID"}),r.jsx("span",{className:"metadata-value metadata-id",children:c.causalLogId||""})]}),m?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"成功"}),r.jsx("span",{className:"metadata-value",children:m.success?"Yes":"No"})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"総所要時間"}),r.jsxs("span",{className:"metadata-value",children:[Math.round((m.totalDuration||0)*10)/10," sec"]})]}),m.errors&&m.errors.length>0?r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"エラー"}),r.jsxs("span",{className:"metadata-value",children:[m.errors.length," 件"]})]}):null]}):null]}):null]}),r.jsx(xu,{log:m})]})]}):r.jsx("div",{className:"room-content album-room",children:r.jsxs("div",{className:"album-empty",children:[r.jsx("p",{children:"アルバムが選択されていません"}),r.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})})},ku=()=>{const{albums:n,getSelectedAlbum:e,selectAlbum:t}=qt(),s=e(),{navigateToRoom:i}=$t(),{requestPlayAlbum:a}=an(),[o,l]=R.useState("now"),c=n.filter(h=>h.musicData),u=s&&s.musicData?r.jsxs("div",{className:"music-panel",children:[r.jsx(bn,{title:s.title||s.mood,mood:s.mood,imageUrl:s.imageDataURL,meta:`作成日: ${new Date(s.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...s.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...s.isPublic?[{label:"公開",tone:"info"}]:[]]}),s.musicMetadata&&r.jsxs("div",{className:"music-meta-grid room-card",children:[r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"調"}),r.jsx("span",{children:s.musicMetadata.key})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"テンポ"}),r.jsxs("span",{children:[s.musicMetadata.tempo," BPM"]})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"拍子"}),r.jsx("span",{children:s.musicMetadata.timeSignature})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"形式"}),r.jsx("span",{children:s.musicMetadata.form})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"性格"}),r.jsx("span",{children:s.musicMetadata.character})]})]}),r.jsxs("div",{className:"music-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:()=>a(s,c),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})]})]}):r.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),d=r.jsxs("div",{className:"music-panel",children:[r.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",c.length,"件"]}),c.length>0?r.jsx("div",{className:"music-library-grid",children:c.map(h=>r.jsx("button",{className:"album-card-button",onClick:()=>{t(h.id),a(h,c)},children:r.jsx(bn,{title:h.title||h.mood,mood:h.mood,imageUrl:h.imageDataURL,meta:h.musicMetadata?`${h.musicMetadata.key} | ${h.musicMetadata.tempo} BPM | ${h.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...h.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...h.isPublic?[{label:"公開",tone:"info"}]:[]]})},h.id))}):r.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return r.jsxs("div",{className:"room-content music-room",children:[r.jsx("div",{className:"room-header music-header",children:r.jsx("div",{className:"room-header-actions",children:r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})})}),r.jsx(mo,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:d}],value:o,onChange:l,ariaLabel:"音楽タブ"})]})},kn="https://airia-beyond.onrender.com";async function Tu(n=50,e="all"){const t=await yt(`${kn}/api/social/posts?limit=${encodeURIComponent(String(n))}&mode=${encodeURIComponent(String(e))}`);if(!t.ok)throw new Error(`Failed to load posts: ${t.status}`);return t.json()}async function ju(n){const e=await yt(`${kn}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function Cu(n){const e=await yt(`${kn}/api/social/posts/${encodeURIComponent(n)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function Iu(n,e){const t=await yt(`${kn}/api/social/posts/${encodeURIComponent(n)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to comment: ${t.status}`);return s}async function Au(n){const e=await yt(`${kn}/api/social/users/${encodeURIComponent(n)}/follow`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to follow: ${e.status}`);return t}async function Mu(n,e){const t=await yt(`${kn}/api/social/posts/${encodeURIComponent(n)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:e})}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to update post: ${t.status}`);return s}async function Eu(n){const e=await yt(`${kn}/api/social/posts/${encodeURIComponent(n)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to delete post: ${e.status}`);return t}const Pu={comment:r.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:r.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:r.jsxs(r.Fragment,{children:[r.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),r.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:r.jsx("path",{d:"M6 9l6 6 6-6"}),more:r.jsxs(r.Fragment,{children:[r.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),r.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),r.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},Ds=({name:n,size:e=16,className:t})=>r.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:Pu[n]}),Ou=()=>{const{albums:n,getSelectedAlbum:e,updateAlbum:t}=qt(),s=e(),{navigateToRoom:i}=$t(),[a,o]=R.useState([]),[l,c]=R.useState(!1),[u,d]=R.useState(null),{user:h,logout:m,updateFollowingIds:f}=hr(),[p,g]=R.useState(""),[v,y]=R.useState(s?.id||(n[0]?.id??"")),[w,N]=R.useState(!1),[j,x]=R.useState({}),[k,S]=R.useState(null),[b,T]=R.useState("all"),[A,P]=R.useState({}),[O,U]=R.useState(null),E=R.useCallback(()=>{try{const L=String(window.location.hash||"").match(/^#social\/(.+)$/);if(L&&L[1])return decodeURIComponent(L[1])}catch{}try{const C="airia_social_focus_post_v1",L=localStorage.getItem(C);if(L)return localStorage.removeItem(C),String(L)}catch{}return null},[]),I=async C=>{const L=`${window.location.origin}/#social/${C}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(L);else{const M=document.createElement("input");M.value=L,document.body.appendChild(M),M.select(),document.execCommand("copy"),document.body.removeChild(M)}d("リンクをコピーしました"),setTimeout(()=>d(null),1500)}catch(M){d(M instanceof Error?M.message:String(M))}},F=R.useCallback(async()=>{c(!0),d(null);try{const C=await Tu(50,b);o(C.posts||[]);const L=O||E();L&&(U(L),P(M=>({...M,[L]:!0})),window.setTimeout(()=>{const M=document.querySelector(`[data-post-id="${CSS.escape(L)}"]`);M&&"scrollIntoView"in M&&M.scrollIntoView({block:"start",behavior:"smooth"})},60))}catch(C){d(C instanceof Error?C.message:String(C))}finally{c(!1)}},[E,b,O]);R.useEffect(()=>{F()},[F]),R.useEffect(()=>{s?.id&&y(s.id)},[s?.id]);const D=R.useMemo(()=>n.find(C=>C.id===v)||null,[n,v]),Y=!!h&&!!D?.imageDataURL&&!w,z=async()=>{if(!h){d("投稿にはログインが必要です");return}if(D){N(!0),d(null);try{const C=await ju({caption:p,album:{title:D.title||D.mood,mood:D.mood,imageUrl:D.thumbnailUrl||D.imageDataURL,createdAt:D.createdAt}});o(L=>[C,...L]),D.isPublic||t(D.id,{isPublic:!0}),g("")}catch(C){d(C instanceof Error?C.message:String(C))}finally{N(!1)}}},te=async C=>{if(!h){d("いいねにはログインが必要です");return}try{const L=await Cu(C);o(M=>M.map(J=>J.id===C?L:J))}catch(L){d(L instanceof Error?L.message:String(L))}},Q=async C=>{if(!h){d("コメントにはログインが必要です");return}const L=(j[C]||"").trim();if(L){S(C),d(null);try{const M=await Iu(C,{text:L});o(J=>J.map(X=>X.id===C?{...X,comments:Array.isArray(X.comments)?[...X.comments,M]:[M]}:X)),x(J=>({...J,[C]:""}))}catch(M){d(M instanceof Error?M.message:String(M))}finally{S(null)}}},H=async C=>{if(!h){d("フォローにはログインが必要です");return}try{const L=await Au(C);f(L.followingIds)}catch(L){d(L instanceof Error?L.message:String(L))}},$=C=>{P(L=>({...L,[C]:!L[C]}))},ee=async C=>{if(!h){d("操作にはログインが必要です");return}const M=(String(C.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";d(null);try{const J=await Mu(C.id,M);o(X=>X.map(se=>se.id===C.id?J:se))}catch(J){d(J instanceof Error?J.message:String(J))}},V=async C=>{if(!h){d("操作にはログインが必要です");return}const L=C.album?.title||C.album?.mood||"投稿";if(window.confirm(`削除しますか？

${L}
この操作は取り消せません。`)){d(null);try{await Eu(C.id),o(M=>M.filter(J=>J.id!==C.id))}catch(M){d(M instanceof Error?M.message:String(M))}}};return r.jsxs("div",{className:"room-content social-room",children:[r.jsx("div",{className:"social-header",children:r.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"}),r.jsx("button",{className:"btn",onClick:()=>void F(),disabled:l,children:"更新"})]})}),r.jsx("div",{className:"social-filter","data-no-swipe":"true",children:r.jsx(ti,{value:b,onChange:C=>T(C),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),r.jsx("div",{className:"social-auth","data-no-swipe":"true","aria-label":"ログイン",children:r.jsxs("div",{className:"social-auth-row",children:[r.jsxs("div",{className:"social-auth-me",children:[r.jsx("div",{className:"social-auth-title",children:"ログイン中"}),r.jsxs("div",{className:"social-auth-handle",children:["@",h?.handle||"..."]}),r.jsx("div",{className:"social-auth-sub",children:h?.displayName||""})]}),r.jsxs("div",{className:"social-auth-actions",children:[r.jsx("button",{className:"btn",onClick:()=>void F(),disabled:l,children:"再読み込み"}),r.jsx("button",{className:"btn",onClick:()=>void m(),disabled:!h,children:"ログアウト"})]})]})}),r.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[r.jsxs("div",{className:"social-compose-grid",children:[r.jsxs("label",{className:"social-field",children:[r.jsx("span",{className:"social-label",children:"公開するアルバム"}),r.jsxs("select",{className:"social-select",value:v,onChange:C=>y(C.target.value),children:[n.length===0&&r.jsx("option",{value:"",children:"（アルバムがありません）"}),n.map(C=>r.jsx("option",{value:C.id,children:C.title||C.mood},C.id))]})]}),r.jsxs("label",{className:"social-field social-field-wide",children:[r.jsx("span",{className:"social-label",children:"キャプション"}),r.jsx("textarea",{className:"social-textarea",value:p,onChange:C=>g(C.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),r.jsxs("div",{className:"social-compose-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!Y,onClick:z,children:w?"公開中…":"公開する"}),D&&r.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:r.jsx(bn,{variant:"compact",title:D.title||D.mood,mood:D.mood,imageUrl:D.thumbnailUrl||D.imageDataURL,badges:[{label:D.musicData?"再生可能":"音声なし",tone:D.musicData?"success":"default"}]})})]}),u&&r.jsx("div",{className:"social-error",children:u})]}),r.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[l&&a.length===0&&r.jsx("div",{className:"social-muted",children:"読み込み中…"}),!l&&a.length===0&&r.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),a.map(C=>r.jsxs("article",{className:"social-post","data-no-swipe":"true","data-post-id":C.id,children:[r.jsxs("header",{className:"social-post-header",children:[r.jsxs("div",{className:"social-post-author",children:[C.author?.handle?`@${C.author.handle}`:C.authorName||"anonymous",C.author?.displayName&&r.jsx("span",{className:"social-post-author-sub",children:C.author.displayName})]}),r.jsx("div",{className:"social-post-date",children:new Date(C.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),C.author?.id&&h?.id!==C.author.id&&r.jsx("div",{className:"social-post-follow","data-no-swipe":"true",children:r.jsx("button",{className:`btn ${h?.followingIds?.includes(C.author.id)?"btn-primary":""}`,onClick:()=>void H(C.author.id),disabled:!h,children:h?.followingIds?.includes(C.author.id)?"フォロー中":"フォロー"})}),r.jsx("div",{className:"social-post-album",children:r.jsx(bn,{title:C.album?.title||"album",mood:C.album?.mood,imageUrl:C.album?.imageUrl,meta:C.album?.createdAt?`作成日: ${new Date(C.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:String(C.visibility||"public").toLowerCase()==="private"?"非公開":"公開作品",tone:String(C.visibility||"public").toLowerCase()==="private"?"default":"info"}]})}),C.caption&&r.jsx("div",{className:"social-post-caption",children:C.caption}),r.jsxs("div",{className:"social-post-actions",children:[r.jsxs("button",{className:`btn social-action ${A[C.id]?"is-active":""}`,onClick:()=>$(C.id),"aria-expanded":!!A[C.id],"aria-controls":`post-comments-${C.id}`,"aria-label":A[C.id]?"コメントを閉じる":"コメントを開く",children:[r.jsxs("span",{className:"social-action-main",children:[r.jsx(Ds,{name:A[C.id]?"chevronDown":"comment",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:A[C.id]?"閉じる":"コメント"})]}),r.jsx("span",{className:"social-count-chip",children:Array.isArray(C.comments)?C.comments.length:0})]}),r.jsxs("button",{className:`btn social-action ${C.viewerHasLiked?"is-active":""}`,onClick:()=>void te(C.id),disabled:!h,children:[r.jsxs("span",{className:"social-action-main",children:[r.jsx(Ds,{name:"heart",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:"いいね"})]}),r.jsx("span",{className:"social-count-chip",children:C.likes||0})]}),r.jsx("button",{className:"btn social-action",onClick:()=>void I(C.id),children:r.jsxs("span",{className:"social-action-main",children:[r.jsx(Ds,{name:"link",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:"共有"})]})}),r.jsx(Js,{triggerClassName:"btn social-action social-action-iconOnly",trigger:r.jsx(Ds,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:L})=>r.jsx(Ks,{items:(()=>{const M=!!h?.id&&!!C.author?.id&&h.id===C.author.id,J=[{id:"copy",label:"リンクをコピー",onSelect:()=>{I(C.id),L()}}];if(M){const X=String(C.visibility||"public").toLowerCase()==="private";J.push({id:"vis",label:X?"公開にする":"非公開にする",onSelect:()=>{ee(C),L()}}),J.push({id:"delete",label:"削除",onSelect:()=>{V(C),L()}})}else J.push({id:"report",label:"通報する",onSelect:()=>{d("通報を受け付けました"),L()}});return J})()})})]}),A[C.id]&&r.jsxs("div",{className:"social-post-comments",id:`post-comments-${C.id}`,children:[(C.comments||[]).slice(-6).map(L=>r.jsxs("div",{className:"social-comment",children:[r.jsx("span",{className:"social-comment-author",children:L.authorName||"anonymous"}),r.jsx("span",{className:"social-comment-text",children:L.text})]},L.id)),r.jsxs("div",{className:"social-comment-compose",children:[r.jsx("input",{className:"social-input",value:j[C.id]||"",onChange:L=>x(M=>({...M,[C.id]:L.target.value})),placeholder:h?"コメントを書く":"ログインしてコメント",maxLength:240,disabled:!h}),r.jsx("button",{className:"btn btn-primary",disabled:!h||k===C.id,onClick:()=>void Q(C.id),children:k===C.id?"送信中…":"送信"})]})]})]},C.id))]})]})},bi="https://airia-beyond.onrender.com",ni="airia_admin_token_v1";function ls(){try{return String(localStorage.getItem(ni)||"")}catch{return""}}function po(n){try{n?localStorage.setItem(ni,n):localStorage.removeItem(ni)}catch{}}async function fo(n){return n.json().catch(()=>null)}async function Du(n,e){const t=new URL(`${bi}/api/admin/audit`);t.searchParams.set("limit",String(n.limit)),n.sinceId!==void 0&&t.searchParams.set("sinceId",String(n.sinceId)),n.type&&t.searchParams.set("type",String(n.type)),n.actorId&&t.searchParams.set("actorId",String(n.actorId));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),i=await fo(s);if(!s.ok)throw new Error(i?.message||i?.error||`Failed to load audit: ${s.status}`);return i}function Ru(n){const e=new URL(`${bi}/api/admin/audit/stream`);return e.searchParams.set("token",n),e.toString()}async function _a(n,e){const t=new URL(`${bi}/api/admin/metrics`);t.searchParams.set("days",String(n||30));const s=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),i=await fo(s);if(!s.ok)throw new Error(i?.message||i?.error||`Failed to load metrics: ${s.status}`);return i}function Fu(n){const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})}const Lu=()=>{const{user:n,logout:e,updateProfile:t,busy:s}=hr(),{navigateToRoom:i}=$t(),{addToast:a}=bs(),[o,l]=R.useState(n?.displayName||""),[c,u]=R.useState(n?.bio||""),[d,h]=R.useState(!1),[m,f]=R.useState(ls());R.useEffect(()=>{l(n?.displayName||""),u(n?.bio||"")},[n?.displayName,n?.bio]),R.useEffect(()=>{f(ls())},[]);const p=!!n&&!d&&(o.trim()!==(n?.displayName||"")||c.trim()!==(n?.bio||"")),g=async()=>{if(n){h(!0);try{await t({displayName:o.trim()||void 0,bio:c.trim()||""}),a("success","プロフィールを保存しました")}catch(w){a("error",w instanceof Error?w.message:"保存に失敗しました")}finally{h(!1)}}},v=async()=>{try{await e()}catch{}},y=()=>{const w=m.trim();po(w||null),a("success",w?"Admin token を保存しました":"Admin token をクリアしました")};return r.jsxs("div",{className:"room-content settings-room",children:[r.jsx("div",{className:"settings-header","data-no-swipe":"true",children:r.jsx("div",{className:"settings-header-actions",children:r.jsx("button",{className:"btn",onClick:()=>void v(),disabled:!n||s,children:"ログアウト"})})}),r.jsxs("div",{className:"settings-card",children:[r.jsxs("section",{className:"settings-section",children:[r.jsx("h2",{className:"settings-title",children:"アカウント"}),r.jsxs("div",{className:"settings-kv",children:[r.jsxs("div",{className:"settings-kv-row",children:[r.jsx("div",{className:"settings-k",children:"ハンドル"}),r.jsxs("div",{className:"settings-v",children:["@",n?.handle||"..."]})]}),r.jsxs("div",{className:"settings-kv-row",children:[r.jsx("div",{className:"settings-k",children:"作成日"}),r.jsx("div",{className:"settings-v",children:n?.createdAt?Fu(n.createdAt):""})]})]})]}),r.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"settings-title",children:"プロフィール"}),r.jsxs("div",{className:"settings-grid",children:[r.jsxs("label",{className:"settings-field",children:[r.jsx("span",{className:"settings-label",children:"表示名"}),r.jsx("input",{className:"settings-input",value:o,onChange:w=>l(w.target.value),maxLength:32,placeholder:"あなたの名前"})]}),r.jsxs("label",{className:"settings-field settings-field-wide",children:[r.jsx("span",{className:"settings-label",children:"自己紹介"}),r.jsx("textarea",{className:"settings-textarea",value:c,onChange:w=>u(w.target.value),maxLength:160,rows:4,placeholder:"一言（任意）"})]})]}),r.jsxs("div",{className:"settings-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!p,onClick:()=>void g(),children:d?"保存中…":"保存する"}),r.jsx("div",{className:"settings-muted",children:"プレリリースでは基本項目のみ編集できます。"})]})]}),r.jsxs("section",{className:"settings-section",children:[r.jsx("h2",{className:"settings-title",children:"通知"}),r.jsx("p",{className:"settings-muted",children:"メール通知は次フェーズで追加予定です。"})]}),r.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"settings-title",children:"Admin"}),r.jsx("div",{className:"settings-grid",children:r.jsxs("label",{className:"settings-field settings-field-wide",children:[r.jsx("span",{className:"settings-label",children:"ADMIN_TOKEN"}),r.jsx("input",{className:"settings-input",value:m,onChange:w=>f(w.target.value),placeholder:"サーバの ADMIN_TOKEN",type:"password",autoComplete:"off"})]})}),r.jsxs("div",{className:"settings-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:y,children:"保存"}),r.jsx("button",{className:"btn",onClick:()=>{y(),m.trim()&&i("admin")},disabled:!m.trim(),children:"Adminログへ"}),r.jsx("div",{className:"settings-muted",children:"Adminログは ADMIN_TOKEN を知っている人のみ利用できます。"})]})]})]})]})};function Vu(n){const e=new Date(n);return Number.isNaN(e.getTime())?n:e.toLocaleString("ja-JP",{hour12:!1})}function Uu(n){const e=n.actor;if(!e)return"anonymous";const t=e.handle?`@${e.handle}`:e.id,s=e.displayName?String(e.displayName):"";return s?`${s} (${t})`:t}const Bu=()=>{const{addToast:n}=bs(),[e,t]=R.useState(ls()),[s,i]=R.useState(ls()),[a,o]=R.useState([]),[l,c]=R.useState(!1),[u,d]=R.useState(null),[h,m]=R.useState(null),[f,p]=R.useState(30),[g,v]=R.useState(""),[y,w]=R.useState(""),[N,j]=R.useState(!1),[x,k]=R.useState(!0),S=R.useRef(null),b=R.useCallback(()=>{if(S.current)try{S.current.close()}catch{}S.current=null,j(!1)},[]),T=R.useCallback(E=>{if(b(),!!E)try{const I=new EventSource(Ru(E));S.current=I,I.addEventListener("hello",()=>{j(!0),d(null)}),I.addEventListener("audit",F=>{try{const D=JSON.parse(String(F.data||"null"));if(!D||typeof D!="object")return;o(Y=>[D,...Y].slice(0,2e3))}catch{}}),I.onerror=()=>{j(!1)}}catch(I){d(I instanceof Error?I.message:String(I)),j(!1)}},[b]),A=R.useCallback(async()=>{const E=(s||"").trim();if(!E){d("ADMIN_TOKEN を入力してください");return}c(!0),d(null);try{const I=await Du({limit:200,type:g.trim(),actorId:y.trim()},E);o(I.events||[]);const F=await _a(f,E);m(F)}catch(I){d(I instanceof Error?I.message:String(I))}finally{c(!1)}},[s,g,y,f]);R.useEffect(()=>{const E=(s||"").trim();if(!E)return;let I=!1;const F=async()=>{try{const Y=await _a(f,E);I||m(Y)}catch{}};F();const D=window.setInterval(F,6e4);return()=>{I=!0,window.clearInterval(D)}},[s,f]),R.useEffect(()=>{if(x&&s)return T(s),()=>b()},[x,s,T,b]);const P=()=>{const E=e.trim();po(E||null),i(E),n("success",E?"Admin token を保存しました":"Admin token をクリアしました"),E&&x&&T(E),E||b()},O=()=>o([]),U=R.useMemo(()=>{const E=g.trim().toLowerCase(),I=y.trim();return a.filter(F=>{if(E&&!String(F.type||"").toLowerCase().includes(E))return!1;if(I){const D=String(F.actor?.id||""),Y=String(F.actor?.handle||"");if(I!==D&&I!==Y)return!1}return!0})},[a,g,y]);return r.jsxs("div",{className:"room-content admin-room",children:[r.jsx("div",{className:"admin-header","data-no-swipe":"true",children:r.jsxs("div",{className:"admin-header-actions",children:[r.jsx("span",{className:`admin-pill ${N?"ok":"ng"}`,children:N?"LIVE":"OFFLINE"}),r.jsx("button",{className:"btn",onClick:()=>void A(),disabled:l||!s,children:l?"読込中…":"最新を取得"}),r.jsx("button",{className:"btn btn-secondary",onClick:O,disabled:a.length===0,children:"表示クリア"})]})}),r.jsxs("div",{className:"admin-metrics","data-no-swipe":"true",children:[r.jsxs("div",{className:"admin-metrics-top",children:[r.jsxs("div",{className:"admin-metrics-cards",children:[r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"総ユーザー数"}),r.jsx("div",{className:"admin-metric-v",children:h?.totals?.users??"—"})]}),r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"総アクション数"}),r.jsx("div",{className:"admin-metric-v",children:h?.totals?.actions??"—"})]}),r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"期間"}),r.jsxs("div",{className:"admin-metric-v",children:["直近 ",f," 日"]})]})]}),r.jsxs("div",{className:"admin-metrics-days",children:[r.jsx("button",{className:`btn ${f===7?"btn-primary":""}`,onClick:()=>p(7),children:"7日"}),r.jsx("button",{className:`btn ${f===14?"btn-primary":""}`,onClick:()=>p(14),children:"14日"}),r.jsx("button",{className:`btn ${f===30?"btn-primary":""}`,onClick:()=>p(30),children:"30日"})]})]}),r.jsxs("div",{className:"admin-charts",children:[r.jsx(wa,{title:"ユーザー増加（新規/日）",points:h?.series?.newUsersPerDay||[]}),r.jsx(wa,{title:"アクション数（/日）",points:h?.series?.actionsPerDay||[]})]})]}),r.jsxs("div",{className:"admin-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"admin-grid",children:[r.jsxs("label",{className:"admin-field admin-field-wide",children:[r.jsx("span",{className:"admin-label",children:"ADMIN_TOKEN"}),r.jsx("input",{className:"admin-input",value:e,onChange:E=>t(E.target.value),placeholder:"Bearer token（サーバの ADMIN_TOKEN）",type:"password",autoComplete:"off"})]}),r.jsxs("div",{className:"admin-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:P,children:"保存"}),r.jsx("button",{className:"btn",onClick:()=>N?b():T(s),disabled:!s,children:N?"切断":"接続"}),r.jsxs("label",{className:"admin-toggle",children:[r.jsx("input",{type:"checkbox",checked:x,onChange:E=>k(E.target.checked)}),"自動接続"]})]}),r.jsxs("label",{className:"admin-field",children:[r.jsx("span",{className:"admin-label",children:"type filter"}),r.jsx("input",{className:"admin-input",value:g,onChange:E=>v(E.target.value),placeholder:"social.post"})]}),r.jsxs("label",{className:"admin-field",children:[r.jsx("span",{className:"admin-label",children:"actor filter"}),r.jsx("input",{className:"admin-input",value:y,onChange:E=>w(E.target.value),placeholder:"user id or handle"})]})]}),u&&r.jsx("div",{className:"admin-error",children:u}),!s&&r.jsx("div",{className:"admin-hint",children:"まず ADMIN_TOKEN を入力して「保存」してください。"})]}),r.jsx("div",{className:"admin-list","data-no-swipe":"true",children:U.length===0?r.jsx("div",{className:"admin-empty",children:"ログがありません。操作してイベントを発生させてください。"}):U.map(E=>r.jsx(qu,{evt:E,onCopy:()=>{const I=JSON.stringify(E,null,2);navigator.clipboard.writeText(I).then(()=>n("success","コピーしました")).catch(()=>n("error","コピーできませんでした"))}},E.id))})]})},wa=({title:n,points:e})=>{const t=Math.max(1,...e.map(a=>Number(a.value||0))),s=e[e.length-1],i=e.reduce((a,o)=>a+(Number(o.value)||0),0);return r.jsxs("div",{className:"admin-chart",children:[r.jsxs("div",{className:"admin-chart-top",children:[r.jsx("div",{className:"admin-chart-title",children:n}),r.jsxs("div",{className:"admin-chart-meta",children:["合計 ",i," / 最新 ",s?.value??0]})]}),r.jsx("div",{className:"admin-chart-bars","aria-label":n,children:e.map(a=>r.jsx("div",{className:"admin-chart-bar",title:`${a.day}: ${a.value}`,children:r.jsx("div",{className:"admin-chart-barFill",style:{height:`${Math.round(Number(a.value||0)/t*100)}%`}})},a.day))}),r.jsxs("div",{className:"admin-chart-axis",children:[r.jsx("span",{children:e[0]?.day||""}),r.jsx("span",{children:e[e.length-1]?.day||""})]})]})},qu=({evt:n,onCopy:e})=>{const[t,s]=R.useState(!1);return r.jsxs("div",{className:"admin-row",children:[r.jsxs("button",{className:"admin-row-main",onClick:()=>s(i=>!i),"aria-expanded":t,children:[r.jsxs("div",{className:"admin-row-top",children:[r.jsx("div",{className:"admin-row-type",children:n.type}),r.jsx("div",{className:"admin-row-ts",children:Vu(n.ts)})]}),r.jsxs("div",{className:"admin-row-mid",children:[r.jsx("div",{className:"admin-row-actor",children:Uu(n)}),r.jsx("div",{className:"admin-row-summary",children:n.summary||""})]}),n.request?.path?r.jsxs("div",{className:"admin-row-path",children:[n.request.method," ",n.request.path]}):null]}),r.jsx("div",{className:"admin-row-actions","data-no-swipe":"true",children:r.jsx("button",{className:"btn btn-secondary",onClick:e,children:"JSONコピー"})}),t?r.jsx("pre",{className:"admin-row-json",children:JSON.stringify(n,null,2)}):null]})},Wu=()=>{const{navigateToRoom:n}=$t(),[e,t]=R.useState(!1);return r.jsxs("div",{className:"room-content info-room",children:[r.jsxs("div",{className:"info-card",children:[r.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"info-title",children:"フィードバック"}),r.jsx("p",{className:"info-text",children:"不便・バグ・改善案はもちろん、良かった点も歓迎です。短くても大丈夫。"}),r.jsx("div",{className:"info-actions",children:r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>n("feedback"),children:"フィードバックを書く"})})]}),r.jsxs("section",{className:"info-section",children:[r.jsx("h2",{className:"info-title",children:"目的"}),r.jsx("p",{className:"info-text",children:"この体験の目的は、「より貴方らしい芸術」を日常の中で生み出せること。"}),r.jsx("p",{className:"info-text",children:"そして、気持ちの変化に合わせて「ずっと寄り添える」相棒になることです。"})]}),r.jsxs("section",{className:"info-section",children:[r.jsxs("div",{className:"info-actions",children:[r.jsx("h2",{className:"info-title",children:"リンク"}),r.jsx("button",{type:"button",className:"info-reset",onClick:()=>t(!0),children:"アプリ情報"})]}),r.jsx("ul",{className:"info-list",children:r.jsx("li",{children:r.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})})})]}),null]}),r.jsxs(so,{open:e,onOpenChange:t,title:"AIRIA BEYOND",description:"あなたの一日を、作品へ。",footer:r.jsx("button",{className:"btn btn-primary",onClick:()=>t(!1),children:"閉じる"}),children:[r.jsx("p",{className:"info-text",children:"会話と気分の手がかりから、あなたに合うレコメンドや創作を少しずつ育てていきます。"}),r.jsx("p",{className:"info-text",children:"まだプレリリース段階です。気づいたことがあれば、ぜひフィードバックを送ってください。"})]})]})},$u=()=>{const{navigateToRoom:n}=$t(),{addToast:e}=bs(),[t,s]=R.useState(!1),[i,a]=R.useState(null),[o,l]=R.useState(!1),[c,u]=R.useState(""),[d,h]=R.useState(""),[m,f]=R.useState(""),[p,g]=R.useState(""),[v,y]=R.useState(""),[w,N]=R.useState(""),[j,x]=R.useState(""),[k,S]=R.useState(""),[b,T]=R.useState(""),[A,P]=R.useState(""),[O,U]=R.useState(""),[E,I]=R.useState(!0),[F,D]=R.useState(!1),[Y,z]=R.useState(null),[te,Q]=R.useState(""),[H,$]=R.useState(!1),ee=R.useMemo(()=>(m.trim().length>0||p.trim().length>0||v.trim().length>0||w.trim().length>0||j.trim().length>0)&&!t,[j,w,t,p,v,m]),V=async()=>{z(null),D(!0);try{const M=await fetch("/api/diagnostics/image",{method:"GET"}),J=await M.json().catch(()=>({}));if(!M.ok)throw new Error(J?.message||"診断情報の取得に失敗しました");const X=JSON.stringify(J,null,2);Q(X),e("success","診断情報を取得しました。必要ならコピーして送れます。")}catch(M){const J=M instanceof Error?M.message:"診断情報の取得に失敗しました";z(J),e("error",J)}finally{D(!1)}},C=async()=>{const M=te.trim();if(!M){e("info","先に「診断情報を取得」を押してください。");return}try{await navigator.clipboard.writeText(M),e("success","診断情報をコピーしました。")}catch{try{const J=document.createElement("textarea");J.value=M,J.style.position="fixed",J.style.left="-9999px",document.body.appendChild(J),J.select(),document.execCommand("copy"),document.body.removeChild(J),e("success","診断情報をコピーしました。")}catch{e("error","コピーに失敗しました。手動で選択してコピーしてください。")}}},L=async()=>{if(ee){a(null),l(!1),s(!0);try{const M=await fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:c||void 0,rating:d||void 0,title:m||void 0,message:p||void 0,steps:v||void 0,expected:w||void 0,actual:j||void 0,device:k||void 0,browser:b||void 0,name:A||void 0,contact:O||void 0,allowFollowUp:E,diagnostics:H&&te.trim().length>0?te:void 0})}),J=await M.json().catch(()=>({}));if(!M.ok)throw new Error(J?.message||"送信に失敗しました");l(!0),e("success","フィードバックを送信しました。ありがとうございます。"),u(""),h(""),f(""),g(""),y(""),N(""),x(""),S(""),T("")}catch(M){const J=M instanceof Error?M.message:"送信に失敗しました";a(J),e("error",J)}finally{s(!1)}}};return r.jsxs("div",{className:"room-content feedback-room",children:[r.jsx("div",{className:"feedback-header","data-no-swipe":"true",children:r.jsx("div",{className:"feedback-header-actions",children:r.jsx("button",{className:"btn btn-secondary",onClick:()=>n("info"),children:"Infoへ"})})}),r.jsxs("div",{className:"feedback-hero","data-no-swipe":"true",children:[r.jsxs("div",{className:"feedback-hero-top",children:[r.jsx("h2",{className:"feedback-hero-title",children:"フィードバックを送ってください"}),r.jsxs("p",{className:"feedback-hero-sub",children:["不便・バグ・改善案はもちろん、良かった点も歓迎です。",r.jsx("br",{}),"一部だけの回答でも送信できます。"]})]}),r.jsxs("div",{className:"feedback-grid",children:[r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"カテゴリ"}),r.jsxs("select",{className:"feedback-input",value:c,onChange:M=>u(M.target.value),children:[r.jsx("option",{value:"",children:"未選択"}),r.jsx("option",{value:"bug",children:"バグ"}),r.jsx("option",{value:"ux",children:"使いにくい"}),r.jsx("option",{value:"feature",children:"要望"}),r.jsx("option",{value:"praise",children:"良かった"}),r.jsx("option",{value:"other",children:"その他"})]})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"気持ち（任意）"}),r.jsxs("select",{className:"feedback-input",value:d,onChange:M=>h(M.target.value),children:[r.jsx("option",{value:"",children:"未選択"}),r.jsx("option",{value:"great",children:"最高だった"}),r.jsx("option",{value:"good",children:"良かった"}),r.jsx("option",{value:"ok",children:"ふつう"}),r.jsx("option",{value:"frustrating",children:"困った"}),r.jsx("option",{value:"broken",children:"壊れてる"})]})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"タイトル（任意）"}),r.jsx("input",{className:"feedback-input",value:m,onChange:M=>f(M.target.value),placeholder:"例：再開ボタンが効かない / 背景が綺麗で好き"})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"本文（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:p,onChange:M=>g(M.target.value),placeholder:"気づいたことを自由に。短くてもOK。",rows:5})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"再現手順（任意・バグ向け）"}),r.jsx("textarea",{className:"feedback-textarea",value:v,onChange:M=>y(M.target.value),placeholder:`例：
1) Chatで「今すぐ1曲」
2) キャンセル
3) 再開
→ エラー`,rows:4})]}),r.jsxs("div",{className:"feedback-field feedback-span-2 feedback-split",children:[r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"期待したこと（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:w,onChange:M=>N(M.target.value),rows:3})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"実際に起きたこと（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:j,onChange:M=>x(M.target.value),rows:3})]})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"端末（任意）"}),r.jsx("input",{className:"feedback-input",value:k,onChange:M=>S(M.target.value),placeholder:"例：iPhone / Windows"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"ブラウザ（任意）"}),r.jsx("input",{className:"feedback-input",value:b,onChange:M=>T(M.target.value),placeholder:"例：Safari / Chrome"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"お名前（任意）"}),r.jsx("input",{className:"feedback-input",value:A,onChange:M=>P(M.target.value),placeholder:"匿名でもOK"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"連絡先（任意）"}),r.jsx("input",{className:"feedback-input",value:O,onChange:M=>U(M.target.value),placeholder:"返信が必要な場合だけ"})]}),r.jsxs("label",{className:"feedback-check feedback-span-2",children:[r.jsx("input",{type:"checkbox",checked:E,onChange:M=>I(M.target.checked)}),"必要があれば追加で質問してもよい（任意）"]}),r.jsxs("div",{className:"feedback-actions feedback-span-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary feedback-submit",disabled:!ee,onClick:()=>void L(),children:t?"送信中…":"送信する"}),r.jsx("div",{className:"feedback-hint",children:o?"送信完了。ありがとうございます。":"※ タイトル/本文/再現手順など、どれか1つでも書けば送信できます。"}),i?r.jsx("div",{className:"feedback-error",children:i}):null]})]})]}),r.jsxs("div",{className:"diagnostics-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"diagnostics-top",children:[r.jsx("h2",{className:"diagnostics-title",children:"困ったとき（診断情報）"}),r.jsx("p",{className:"diagnostics-sub",children:"画像生成がうまくいかない時は、診断情報をコピーしてフィードバックに貼り付けると原因特定が早くなります。"})]}),r.jsxs("div",{className:"diagnostics-actions",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",disabled:F,onClick:()=>void V(),children:F?"取得中…":"診断情報を取得"}),r.jsx("button",{type:"button",className:"btn btn-secondary",disabled:!te.trim(),onClick:()=>void C(),children:"コピー"}),r.jsxs("label",{className:"diagnostics-attach",children:[r.jsx("input",{type:"checkbox",checked:H,onChange:M=>$(M.target.checked)}),"フィードバック送信に添付する（任意）"]})]}),r.jsx("p",{className:"diagnostics-note",children:"※ 個人情報は含めませんが、接続先URL・エラー概要・最近のジョブ情報が含まれることがあります。"}),r.jsx("textarea",{className:"diagnostics-textarea",value:te,onChange:M=>Q(M.target.value),placeholder:"ここに診断情報が表示されます（取得ボタンを押してください）",rows:7}),Y?r.jsx("div",{className:"diagnostics-error",children:Y}):null]})]})},Gu="/img/airia-logo.png",zu=({onDismiss:n})=>{const[e,t]=_.useState("enter");_.useEffect(()=>{const i=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>n(),2900)];return()=>{i.forEach(a=>clearTimeout(a))}},[n]);const s=()=>{t("exit"),window.setTimeout(n,260)};return r.jsxs("div",{className:`splash-screen splash-${e}`,onClick:s,role:"button",tabIndex:0,onKeyDown:i=>{(i.key==="Enter"||i.key===" ")&&s()},"aria-label":"クリックして開始",children:[r.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[r.jsx("div",{className:"splash-orbit"}),r.jsx("div",{className:"splash-grain"})]}),r.jsxs("div",{className:"splash-content",children:[r.jsx("div",{className:"splash-mark","aria-hidden":"true",children:r.jsx("img",{className:"splash-logo",src:Gu,alt:"","aria-hidden":"true"})}),r.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),r.jsx("div",{className:"splash-rule","aria-hidden":"true"}),r.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),r.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},go="15.1.22",Na=(n,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:n}),Sa=(n,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:n}),si=(n,e)=>({startTime:e,type:"setValue",value:n}),vo=(n,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:n}),yo=(n,e,{startTime:t,target:s,timeConstant:i})=>s+(e-s)*Math.exp((t-n)/i),Rn=n=>n.type==="exponentialRampToValue",Zs=n=>n.type==="linearRampToValue",Kt=n=>Rn(n)||Zs(n),xi=n=>n.type==="setValue",Vt=n=>n.type==="setValueCurve",Qs=(n,e,t,s)=>{const i=n[e];return i===void 0?s:Kt(i)||xi(i)?i.value:Vt(i)?i.values[i.values.length-1]:yo(t,Qs(n,e-1,i.startTime,s),i)},ka=(n,e,t,s,i)=>t===void 0?[s.insertTime,i]:Kt(t)?[t.endTime,t.value]:xi(t)?[t.startTime,t.value]:Vt(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,Qs(n,e-1,t.startTime,i)],ri=n=>n.type==="cancelAndHold",ii=n=>n.type==="cancelScheduledValues",Ht=n=>ri(n)||ii(n)?n.cancelTime:Rn(n)||Zs(n)?n.endTime:n.startTime,Ta=(n,e,t,{endTime:s,value:i})=>t===i?i:0<t&&0<i||t<0&&i<0?t*(i/t)**((n-e)/(s-e)):0,ja=(n,e,t,{endTime:s,value:i})=>t+(n-e)/(s-e)*(i-t),Yu=(n,e)=>{const t=Math.floor(e),s=Math.ceil(e);return t===s?n[t]:(1-(e-t))*n[t]+(1-(s-e))*n[s]},Hu=(n,{duration:e,startTime:t,values:s})=>{const i=(n-t)/e*(s.length-1);return Yu(s,i)},Rs=n=>n.type==="setTarget";class Xu{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=Ht(e);if(ri(e)||ii(e)){const s=this._automationEvents.findIndex(a=>ii(e)&&Vt(a)?a.startTime+a.duration>=t:Ht(a)>=t),i=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),ri(e)){const a=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&Kt(i)){if(a!==void 0&&Rs(a))throw new Error("The internal list is malformed.");const o=a===void 0?i.insertTime:Vt(a)?a.startTime+a.duration:Ht(a),l=a===void 0?this._defaultValue:Vt(a)?a.values[a.values.length-1]:a.value,c=Rn(i)?Ta(t,o,l,i):ja(t,o,l,i),u=Rn(i)?Na(c,t,this._currenTime):Sa(c,t,this._currenTime);this._automationEvents.push(u)}if(a!==void 0&&Rs(a)&&this._automationEvents.push(si(this.getValue(t),t)),a!==void 0&&Vt(a)&&a.startTime+a.duration>t){const o=t-a.startTime,l=(a.values.length-1)/a.duration,c=Math.max(2,1+Math.ceil(o*l)),u=o/(c-1)*l,d=a.values.slice(0,c);if(u<1)for(let h=1;h<c;h+=1){const m=u*h%1;d[h]=a.values[h-1]*(1-m)+a.values[h]*m}this._automationEvents[this._automationEvents.length-1]=vo(d,a.startTime,o)}}}else{const s=this._automationEvents.findIndex(o=>Ht(o)>t),i=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(i!==void 0&&Vt(i)&&Ht(i)+i.duration>t)return!1;const a=Rn(e)?Na(e.value,e.endTime,this._currenTime):Zs(e)?Sa(e.value,t,this._currenTime):e;if(s===-1)this._automationEvents.push(a);else{if(Vt(e)&&t+e.duration>Ht(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,a)}}return!0}flush(e){const t=this._automationEvents.findIndex(s=>Ht(s)>e);if(t>1){const s=this._automationEvents.slice(t-1),i=s[0];Rs(i)&&s.unshift(si(Qs(this._automationEvents,t-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=s}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(o=>Ht(o)>e),s=this._automationEvents[t],i=(t===-1?this._automationEvents.length:t)-1,a=this._automationEvents[i];if(a!==void 0&&Rs(a)&&(s===void 0||!Kt(s)||s.insertTime>e))return yo(e,Qs(this._automationEvents,i-1,a.startTime,this._defaultValue),a);if(a!==void 0&&xi(a)&&(s===void 0||!Kt(s)))return a.value;if(a!==void 0&&Vt(a)&&(s===void 0||!Kt(s)||a.startTime+a.duration>e))return e<a.startTime+a.duration?Hu(e,a):a.values[a.values.length-1];if(a!==void 0&&Kt(a)&&(s===void 0||!Kt(s)))return a.value;if(s!==void 0&&Rn(s)){const[o,l]=ka(this._automationEvents,i,a,s,this._defaultValue);return Ta(e,o,l,s)}if(s!==void 0&&Zs(s)){const[o,l]=ka(this._automationEvents,i,a,s,this._defaultValue);return ja(e,o,l,s)}return this._defaultValue}}const Ju=n=>({cancelTime:n,type:"cancelAndHold"}),Ku=n=>({cancelTime:n,type:"cancelScheduledValues"}),Zu=(n,e)=>({endTime:e,type:"exponentialRampToValue",value:n}),Qu=(n,e)=>({endTime:e,type:"linearRampToValue",value:n}),ed=(n,e,t)=>({startTime:e,target:n,timeConstant:t,type:"setTarget"}),td=()=>new DOMException("","AbortError"),nd=n=>(e,t,[s,i,a],o)=>{n(e[i],[t,s,a],l=>l[0]===t&&l[1]===s,o)},sd=n=>(e,t,s)=>{const i=[];for(let a=0;a<s.numberOfInputs;a+=1)i.push(new Set);n.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},rd=n=>(e,t)=>{n.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},Wn=new WeakSet,bo=new WeakMap,_i=new WeakMap,xo=new WeakMap,wi=new WeakMap,mr=new WeakMap,_o=new WeakMap,ai=new WeakMap,oi=new WeakMap,ci=new WeakMap,wo={construct(){return wo}},id=n=>{try{const e=new Proxy(n,wo);new e}catch{return!1}return!0},Ca=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Ia=(n,e)=>{const t=[];let s=n.replace(/^[\s]+/,""),i=s.match(Ca);for(;i!==null;){const a=i[1].slice(1,-1),o=i[0].replace(/([\s]+)?;?$/,"").replace(a,new URL(a,e).toString());t.push(o),s=s.slice(i[0].length).replace(/^[\s]+/,""),i=s.match(Ca)}return[t.join(";"),s]},Aa=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Ma=n=>{if(!id(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},ad=(n,e,t,s,i,a,o,l,c,u,d,h,m)=>{let f=0;return(p,g,v={credentials:"omit"})=>{const y=d.get(p);if(y!==void 0&&y.has(g))return Promise.resolve();const w=u.get(p);if(w!==void 0){const x=w.get(g);if(x!==void 0)return x}const N=a(p),j=N.audioWorklet===void 0?i(g).then(([x,k])=>{const[S,b]=Ia(x,k),T=`${S};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${b}
})})(window,'_AWGS')`;return t(T)}).then(()=>{const x=m._AWGS.pop();if(x===void 0)throw new SyntaxError;s(N.currentTime,N.sampleRate,()=>x(class{},void 0,(k,S)=>{if(k.trim()==="")throw e();const b=oi.get(N);if(b!==void 0){if(b.has(k))throw e();Ma(S),Aa(S.parameterDescriptors),b.set(k,S)}else Ma(S),Aa(S.parameterDescriptors),oi.set(N,new Map([[k,S]]))},N.sampleRate,void 0,void 0))}):Promise.all([i(g),Promise.resolve(n(h,h))]).then(([[x,k],S])=>{const b=f+1;f=b;const[T,A]=Ia(x,k),E=`${T};((AudioWorkletProcessor,registerProcessor)=>{${A}
})(${S?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${S?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${S?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${b}',class extends AudioWorkletProcessor{process(){return !1}})`,I=new Blob([E],{type:"application/javascript; charset=utf-8"}),F=URL.createObjectURL(I);return N.audioWorklet.addModule(F,v).then(()=>{if(l(N))return N;const D=o(N);return D.audioWorklet.addModule(F,v).then(()=>D)}).then(D=>{if(c===null)throw new SyntaxError;try{new c(D,`__sac${b}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(F))});return w===void 0?u.set(p,new Map([[g,j]])):w.set(g,j),j.then(()=>{const x=d.get(p);x===void 0?d.set(p,new Set([g])):x.add(g)}).finally(()=>{const x=u.get(p);x!==void 0&&x.delete(g)}),j}},St=(n,e)=>{const t=n.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},pr=(n,e)=>{const t=Array.from(n).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[s]=t;return n.delete(s),s},No=(n,e,t,s)=>{const i=St(n,e),a=pr(i,o=>o[0]===t&&o[1]===s);return i.size===0&&n.delete(e),a},xs=n=>St(_o,n),$n=n=>{if(Wn.has(n))throw new Error("The AudioNode is already stored.");Wn.add(n),xs(n).forEach(e=>e(!0))},So=n=>"port"in n,_s=n=>{if(!Wn.has(n))throw new Error("The AudioNode is not stored.");Wn.delete(n),xs(n).forEach(e=>e(!1))},li=(n,e)=>{!So(n)&&e.every(t=>t.size===0)&&_s(n)},od=(n,e,t,s,i,a,o,l,c,u,d,h,m)=>{const f=new WeakMap;return(p,g,v,y,w)=>{const{activeInputs:N,passiveInputs:j}=a(g),{outputs:x}=a(p),k=l(p),S=b=>{const T=c(g),A=c(p);if(b){const P=No(j,p,v,y);n(N,p,P,!1),!w&&!h(p)&&t(A,T,v,y),m(g)&&$n(g)}else{const P=s(N,p,v,y);e(j,y,P,!1),!w&&!h(p)&&i(A,T,v,y);const O=o(g);if(O===0)d(g)&&li(g,N);else{const U=f.get(g);U!==void 0&&clearTimeout(U),f.set(g,setTimeout(()=>{d(g)&&li(g,N)},O*1e3))}}};return u(x,[g,v,y],b=>b[0]===g&&b[1]===v&&b[2]===y,!0)?(k.add(S),d(p)?n(N,p,[v,y,S],!0):e(j,y,[p,v,S],!0),!0):!1}},cd=n=>(e,t,[s,i,a],o)=>{const l=e.get(s);l===void 0?e.set(s,new Set([[i,t,a]])):n(l,[i,t,a],c=>c[0]===i&&c[1]===t,o)},ld=n=>(e,t)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(s).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(s),s.disconnect()};t.addEventListener("ended",i)},ud=n=>(e,t)=>{n(e).add(t)},dd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},hd=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=i(l),d={...dd,...c},h=s(u,d),m=a(u)?e():null;super(l,!1,h,m),this._nativeAnalyserNode=h}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(l){this._nativeAnalyserNode.fftSize=l}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(l){const c=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=l,!(l>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=c,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(l){const c=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=l,!(this._nativeAnalyserNode.maxDecibels>l))throw this._nativeAnalyserNode.minDecibels=c,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(l){this._nativeAnalyserNode.smoothingTimeConstant=l}getByteFrequencyData(l){this._nativeAnalyserNode.getByteFrequencyData(l)}getByteTimeDomainData(l){this._nativeAnalyserNode.getByteTimeDomainData(l)}getFloatFrequencyData(l){this._nativeAnalyserNode.getFloatFrequencyData(l)}getFloatTimeDomainData(l){this._nativeAnalyserNode.getFloatTimeDomainData(l)}},et=(n,e)=>n.context===e,md=(n,e,t)=>()=>{const s=new WeakMap,i=async(a,o)=>{let l=e(a);if(!et(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,fftSize:l.fftSize,maxDecibels:l.maxDecibels,minDecibels:l.minDecibels,smoothingTimeConstant:l.smoothingTimeConstant};l=n(o,u)}return s.set(o,l),await t(a,o,l),l};return{render(a,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},er=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Ot=()=>new DOMException("","IndexSizeError"),Ni=n=>{n.getChannelData=(e=>t=>{try{return e.call(n,t)}catch(s){throw s.code===12?Ot():s}})(n.getChannelData)},pd={numberOfChannels:1},fd=(n,e,t,s,i,a,o,l)=>{let c=null;return class ko{constructor(d){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:h,numberOfChannels:m,sampleRate:f}={...pd,...d};c===null&&(c=new i(1,1,44100));const p=s!==null&&e(a,a)?new s({length:h,numberOfChannels:m,sampleRate:f}):c.createBuffer(m,h,f);if(p.numberOfChannels===0)throw t();return typeof p.copyFromChannel!="function"?(o(p),Ni(p)):e(er,()=>er(p))||l(p),n.add(p),p}static[Symbol.hasInstance](d){return d!==null&&typeof d=="object"&&Object.getPrototypeOf(d)===ko.prototype||n.has(d)}}},ct=-34028234663852886e22,st=-ct,Bt=n=>Wn.has(n),gd={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},vd=(n,e,t,s,i,a,o,l)=>class extends n{constructor(u,d){const h=a(u),m={...gd,...d},f=i(h,m),p=o(h),g=p?e():null;super(u,!1,f,g),this._audioBufferSourceNodeRenderer=g,this._isBufferNullified=!1,this._isBufferSet=m.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,p,f.playbackRate,st,ct)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const d=typeof u=="function"?l(this,u):null;this._nativeAudioBufferSourceNode.onended=d;const h=this._nativeAudioBufferSourceNode.onended;this._onended=h!==null&&h===d?u:h}get playbackRate(){return this._playbackRate}start(u=0,d=0,h){if(this._nativeAudioBufferSourceNode.start(u,d,h),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=h===void 0?[u,d]:[u,d,h]),this.context.state!=="closed"){$n(this);const m=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",m),Bt(this)&&_s(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",m)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},yd=(n,e,t,s,i)=>()=>{const a=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const m=et(h,d);if(!m){const f={buffer:h.buffer,channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,loop:h.loop,loopEnd:h.loopEnd,loopStart:h.loopStart,playbackRate:h.playbackRate.value};h=e(d,f),o!==null&&h.start(...o),l!==null&&h.stop(l)}return a.set(d,h),m?await n(d,u.playbackRate,h.playbackRate):await s(d,u.playbackRate,h.playbackRate),await i(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=a.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},bd=n=>"playbackRate"in n,xd=n=>"frequency"in n&&"gain"in n,_d=n=>"offset"in n,wd=n=>!("frequency"in n)&&"gain"in n,Nd=n=>"detune"in n&&"frequency"in n&&!("gain"in n),Sd=n=>"pan"in n,rt=n=>St(bo,n),ws=n=>St(xo,n),ui=(n,e)=>{const{activeInputs:t}=rt(n);t.forEach(i=>i.forEach(([a])=>{e.includes(n)||ui(a,[...e,n])}));const s=bd(n)?[n.playbackRate]:So(n)?Array.from(n.parameters.values()):xd(n)?[n.Q,n.detune,n.frequency,n.gain]:_d(n)?[n.offset]:wd(n)?[n.gain]:Nd(n)?[n.detune,n.frequency]:Sd(n)?[n.pan]:[];for(const i of s){const a=ws(i);a!==void 0&&a.activeInputs.forEach(([o])=>ui(o,e))}Bt(n)&&_s(n)},To=n=>{ui(n.destination,[])},kd=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),Td=(n,e,t,s,i,a,o,l,c)=>class extends n{constructor(d={}){if(c===null)throw new Error("Missing the native AudioContext constructor.");let h;try{h=new c(d)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?t():p}if(h===null)throw s();if(!kd(d.latencyHint))throw new TypeError(`The provided value '${d.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(d.sampleRate!==void 0&&h.sampleRate!==d.sampleRate)throw t();super(h,2);const{latencyHint:m}=d,{sampleRate:f}=h;if(this._baseLatency=typeof h.baseLatency=="number"?h.baseLatency:m==="balanced"?512/f:m==="interactive"||m===void 0?256/f:m==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(m*f/128)))*128/f,this._nativeAudioContext=h,c.name==="webkitAudioContext"?(this._nativeGainNode=h.createGain(),this._nativeOscillatorNode=h.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(h.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,h.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),h.removeEventListener("statechange",p)};h.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),To(this)}))}createMediaElementSource(d){return new i(this,{mediaElement:d})}createMediaStreamDestination(){return new a(this)}createMediaStreamSource(d){return new o(this,{mediaStream:d})}createMediaStreamTrackSource(d){return new l(this,{mediaStreamTrack:d})}resume(){return this._state==="suspended"?new Promise((d,h)=>{const m=()=>{this._nativeAudioContext.removeEventListener("statechange",m),this._nativeAudioContext.state==="running"?d():this.resume().then(d,h)};this._nativeAudioContext.addEventListener("statechange",m)}):this._nativeAudioContext.resume().catch(d=>{throw d===void 0||d.code===15?e():d})}suspend(){return this._nativeAudioContext.suspend().catch(d=>{throw d===void 0?e():d})}},jd=(n,e,t,s,i,a,o,l)=>class extends n{constructor(u,d){const h=a(u),m=o(h),f=i(h,d,m),p=m?e(l):null;super(u,!1,f,p),this._isNodeOfNativeOfflineAudioContext=m,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},Cd=n=>{const e=new WeakMap,t=async(s,i)=>{const a=i.destination;return e.set(i,a),await n(s,i,a),a};return{render(s,i){const a=e.get(i);return a!==void 0?Promise.resolve(a):t(s,i)}}},Id=(n,e,t,s,i,a,o,l)=>(c,u)=>{const d=u.listener,h=()=>{const x=new Float32Array(1),k=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),S=o(u);let b=!1,T=[0,0,-1,0,1,0],A=[0,0,0];const P=()=>{if(b)return;b=!0;const I=s(u,256,9,0);I.onaudioprocess=({inputBuffer:F})=>{const D=[a(F,x,0),a(F,x,1),a(F,x,2),a(F,x,3),a(F,x,4),a(F,x,5)];D.some((z,te)=>z!==T[te])&&(d.setOrientation(...D),T=D);const Y=[a(F,x,6),a(F,x,7),a(F,x,8)];Y.some((z,te)=>z!==A[te])&&(d.setPosition(...Y),A=Y)},k.connect(I)},O=I=>F=>{F!==T[I]&&(T[I]=F,d.setOrientation(...T))},U=I=>F=>{F!==A[I]&&(A[I]=F,d.setPosition(...A))},E=(I,F,D)=>{const Y=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:F});Y.connect(k,0,I),Y.start(),Object.defineProperty(Y.offset,"defaultValue",{get(){return F}});const z=n({context:c},S,Y.offset,st,ct);return l(z,"value",te=>()=>te.call(z),te=>Q=>{try{te.call(z,Q)}catch(H){if(H.code!==9)throw H}P(),S&&D(Q)}),z.cancelAndHoldAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.cancelAndHoldAtTime),z.cancelScheduledValues=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.cancelScheduledValues),z.exponentialRampToValueAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.exponentialRampToValueAtTime),z.linearRampToValueAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.linearRampToValueAtTime),z.setTargetAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.setTargetAtTime),z.setValueAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.setValueAtTime),z.setValueCurveAtTime=(te=>S?()=>{throw i()}:(...Q)=>{const H=te.apply(z,Q);return P(),H})(z.setValueCurveAtTime),z};return{forwardX:E(0,0,O(0)),forwardY:E(1,0,O(1)),forwardZ:E(2,-1,O(2)),positionX:E(6,0,U(0)),positionY:E(7,0,U(1)),positionZ:E(8,0,U(2)),upX:E(3,0,O(3)),upY:E(4,1,O(4)),upZ:E(5,0,O(5))}},{forwardX:m,forwardY:f,forwardZ:p,positionX:g,positionY:v,positionZ:y,upX:w,upY:N,upZ:j}=d.forwardX===void 0?h():d;return{get forwardX(){return m},get forwardY(){return f},get forwardZ(){return p},get positionX(){return g},get positionY(){return v},get positionZ(){return y},get upX(){return w},get upY(){return N},get upZ(){return j}}},tr=n=>"context"in n,Ns=n=>tr(n[0]),Tn=(n,e,t,s)=>{for(const i of n)if(t(i)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(e),!0},Ea=(n,e,[t,s],i)=>{Tn(n,[e,t,s],a=>a[0]===e&&a[1]===t,i)},Pa=(n,[e,t,s],i)=>{const a=n.get(e);a===void 0?n.set(e,new Set([[t,s]])):Tn(a,[t,s],o=>o[0]===t,i)},Zn=n=>"inputs"in n,nr=(n,e,t,s)=>{if(Zn(e)){const i=e.inputs[s];return n.connect(i,t,0),[i,t,0]}return n.connect(e,t,s),[e,t,s]},jo=(n,e,t)=>{for(const s of n)if(s[0]===e&&s[1]===t)return n.delete(s),s;return null},Ad=(n,e,t)=>pr(n,s=>s[0]===e&&s[1]===t),Co=(n,e)=>{if(!xs(n).delete(e))throw new Error("Missing the expected event listener.")},Io=(n,e,t)=>{const s=St(n,e),i=pr(s,a=>a[0]===t);return s.size===0&&n.delete(e),i},sr=(n,e,t,s)=>{Zn(e)?n.disconnect(e.inputs[s],t,0):n.disconnect(e,t,s)},Te=n=>St(_i,n),us=n=>St(wi,n),xn=n=>ai.has(n),zs=n=>!Wn.has(n),Oa=(n,e)=>new Promise(t=>{if(e!==null)t(!0);else{const s=n.createScriptProcessor(256,1,1),i=n.createGain(),a=n.createBuffer(1,2,44100),o=a.getChannelData(0);o[0]=1,o[1]=1;const l=n.createBufferSource();l.buffer=a,l.loop=!0,l.connect(s).connect(n.destination),l.connect(i),l.disconnect(i),s.onaudioprocess=c=>{const u=c.inputBuffer.getChannelData(0);Array.prototype.some.call(u,d=>d===1)?t(!0):t(!1),l.stop(),s.onaudioprocess=null,l.disconnect(s),s.disconnect(n.destination)},l.start()}}),Hr=(n,e)=>{const t=new Map;for(const s of n)for(const i of s){const a=t.get(i);t.set(i,a===void 0?1:a+1)}t.forEach((s,i)=>e(i,s))},rr=n=>"context"in n,Md=n=>{const e=new Map;n.connect=(t=>(s,i=0,a=0)=>{const o=rr(s)?t(s,i,a):t(s,i),l=e.get(s);return l===void 0?e.set(s,[{input:a,output:i}]):l.every(c=>c.input!==a||c.output!==i)&&l.push({input:a,output:i}),o})(n.connect.bind(n)),n.disconnect=(t=>(s,i,a)=>{if(t.apply(n),s===void 0)e.clear();else if(typeof s=="number")for(const[o,l]of e){const c=l.filter(u=>u.output!==s);c.length===0?e.delete(o):e.set(o,c)}else if(e.has(s))if(i===void 0)e.delete(s);else{const o=e.get(s);if(o!==void 0){const l=o.filter(c=>c.output!==i&&(c.input!==a||a===void 0));l.length===0?e.delete(s):e.set(s,l)}}for(const[o,l]of e)l.forEach(c=>{rr(o)?n.connect(o,c.output,c.input):n.connect(o,c.output)})})(n.disconnect)},Ed=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:a}=ws(e),{outputs:o}=rt(n),l=xs(n),c=u=>{const d=Te(n),h=us(e);if(u){const m=Io(a,n,t);Ea(i,n,m,!1),!s&&!xn(n)&&d.connect(h,t)}else{const m=Ad(i,n,t);Pa(a,m,!1),!s&&!xn(n)&&d.disconnect(h,t)}};return Tn(o,[e,t],u=>u[0]===e&&u[1]===t,!0)?(l.add(c),Bt(n)?Ea(i,n,[t,c],!0):Pa(a,[n,t,c],!0),!0):!1},Pd=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:a}=rt(e),o=jo(i[s],n,t);return o===null?[No(a,n,t,s)[2],!1]:[o[2],!0]},Od=(n,e,t)=>{const{activeInputs:s,passiveInputs:i}=ws(e),a=jo(s,n,t);return a===null?[Io(i,n,t)[1],!1]:[a[2],!0]},Si=(n,e,t,s,i)=>{const[a,o]=Pd(n,t,s,i);if(a!==null&&(Co(n,a),o&&!e&&!xn(n)&&sr(Te(n),Te(t),s,i)),Bt(t)){const{activeInputs:l}=rt(t);li(t,l)}},ki=(n,e,t,s)=>{const[i,a]=Od(n,t,s);i!==null&&(Co(n,i),a&&!e&&!xn(n)&&Te(n).disconnect(us(t),s))},Dd=(n,e)=>{const t=rt(n),s=[];for(const i of t.outputs)Ns(i)?Si(n,e,...i):ki(n,e,...i),s.push(i[0]);return t.outputs.clear(),s},Rd=(n,e,t)=>{const s=rt(n),i=[];for(const a of s.outputs)a[1]===t&&(Ns(a)?Si(n,e,...a):ki(n,e,...a),i.push(a[0]),s.outputs.delete(a));return i},Fd=(n,e,t,s,i)=>{const a=rt(n);return Array.from(a.outputs).filter(o=>o[0]===t&&(s===void 0||o[1]===s)&&(i===void 0||o[2]===i)).map(o=>(Ns(o)?Si(n,e,...o):ki(n,e,...o),a.outputs.delete(o),o[0]))},Ld=(n,e,t,s,i,a,o,l,c,u,d,h,m,f,p,g)=>class extends u{constructor(y,w,N,j){super(N),this._context=y,this._nativeAudioNode=N;const x=d(y);h(x)&&t(Oa,()=>Oa(x,g))!==!0&&Md(N),_i.set(this,N),_o.set(this,new Set),y.state!=="closed"&&w&&$n(this),n(this,j,N)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(y){this._nativeAudioNode.channelCount=y}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(y){this._nativeAudioNode.channelCountMode=y}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(y){this._nativeAudioNode.channelInterpretation=y}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(y,w=0,N=0){if(w<0||w>=this._nativeAudioNode.numberOfOutputs)throw i();const j=d(this._context),x=p(j);if(m(y)||f(y))throw a();if(tr(y)){const b=Te(y);try{const A=nr(this._nativeAudioNode,b,w,N),P=zs(this);(x||P)&&this._nativeAudioNode.disconnect(...A),this.context.state!=="closed"&&!P&&zs(y)&&$n(y)}catch(A){throw A.code===12?a():A}if(e(this,y,w,N,x)){const A=c([this],y);Hr(A,s(x))}return y}const k=us(y);if(k.name==="playbackRate"&&k.maxValue===1024)throw o();try{this._nativeAudioNode.connect(k,w),(x||zs(this))&&this._nativeAudioNode.disconnect(k,w)}catch(b){throw b.code===12?a():b}if(Ed(this,y,w,x)){const b=c([this],y);Hr(b,s(x))}}disconnect(y,w,N){let j;const x=d(this._context),k=p(x);if(y===void 0)j=Dd(this,k);else if(typeof y=="number"){if(y<0||y>=this.numberOfOutputs)throw i();j=Rd(this,k,y)}else{if(w!==void 0&&(w<0||w>=this.numberOfOutputs)||tr(y)&&N!==void 0&&(N<0||N>=y.numberOfInputs))throw i();if(j=Fd(this,k,y,w,N),j.length===0)throw a()}for(const S of j){const b=c([this],S);Hr(b,l)}}},Vd=(n,e,t,s,i,a,o,l,c,u,d,h,m)=>(f,p,g,v=null,y=null)=>{const w=g.value,N=new Xu(w),j=p?s(N):null,x={get defaultValue(){return w},get maxValue(){return v===null?g.maxValue:v},get minValue(){return y===null?g.minValue:y},get value(){return g.value},set value(k){g.value=k,x.setValueAtTime(k,f.context.currentTime)},cancelAndHoldAtTime(k){if(typeof g.cancelAndHoldAtTime=="function")j===null&&N.flush(f.context.currentTime),N.add(i(k)),g.cancelAndHoldAtTime(k);else{const S=Array.from(N).pop();j===null&&N.flush(f.context.currentTime),N.add(i(k));const b=Array.from(N).pop();g.cancelScheduledValues(k),S!==b&&b!==void 0&&(b.type==="exponentialRampToValue"?g.exponentialRampToValueAtTime(b.value,b.endTime):b.type==="linearRampToValue"?g.linearRampToValueAtTime(b.value,b.endTime):b.type==="setValue"?g.setValueAtTime(b.value,b.startTime):b.type==="setValueCurve"&&g.setValueCurveAtTime(b.values,b.startTime,b.duration))}return x},cancelScheduledValues(k){return j===null&&N.flush(f.context.currentTime),N.add(a(k)),g.cancelScheduledValues(k),x},exponentialRampToValueAtTime(k,S){if(k===0)throw new RangeError;if(!Number.isFinite(S)||S<0)throw new RangeError;const b=f.context.currentTime;return j===null&&N.flush(b),Array.from(N).length===0&&(N.add(u(w,b)),g.setValueAtTime(w,b)),N.add(o(k,S)),g.exponentialRampToValueAtTime(k,S),x},linearRampToValueAtTime(k,S){const b=f.context.currentTime;return j===null&&N.flush(b),Array.from(N).length===0&&(N.add(u(w,b)),g.setValueAtTime(w,b)),N.add(l(k,S)),g.linearRampToValueAtTime(k,S),x},setTargetAtTime(k,S,b){return j===null&&N.flush(f.context.currentTime),N.add(c(k,S,b)),g.setTargetAtTime(k,S,b),x},setValueAtTime(k,S){return j===null&&N.flush(f.context.currentTime),N.add(u(k,S)),g.setValueAtTime(k,S),x},setValueCurveAtTime(k,S,b){const T=k instanceof Float32Array?k:new Float32Array(k);if(h!==null&&h.name==="webkitAudioContext"){const A=S+b,P=f.context.sampleRate,O=Math.ceil(S*P),U=Math.floor(A*P),E=U-O,I=new Float32Array(E);for(let D=0;D<E;D+=1){const Y=(T.length-1)/b*((O+D)/P-S),z=Math.floor(Y),te=Math.ceil(Y);I[D]=z===te?T[z]:(1-(Y-z))*T[z]+(1-(te-Y))*T[te]}j===null&&N.flush(f.context.currentTime),N.add(d(I,S,b)),g.setValueCurveAtTime(I,S,b);const F=U/P;F<A&&m(x,I[I.length-1],F),m(x,T[T.length-1],A)}else j===null&&N.flush(f.context.currentTime),N.add(d(T,S,b)),g.setValueCurveAtTime(T,S,b);return x}};return t.set(x,g),e.set(x,f),n(x,j),x},Ud=n=>({replay(e){for(const t of n)if(t.type==="exponentialRampToValue"){const{endTime:s,value:i}=t;e.exponentialRampToValueAtTime(i,s)}else if(t.type==="linearRampToValue"){const{endTime:s,value:i}=t;e.linearRampToValueAtTime(i,s)}else if(t.type==="setTarget"){const{startTime:s,target:i,timeConstant:a}=t;e.setTargetAtTime(i,s,a)}else if(t.type==="setValue"){const{startTime:s,value:i}=t;e.setValueAtTime(i,s)}else if(t.type==="setValueCurve"){const{duration:s,startTime:i,values:a}=t;e.setValueCurveAtTime(a,i,s)}else throw new Error("Can't apply an unknown automation.")}});class Ao{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((s,i)=>e.call(t,s,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const Bd={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},qd=(n,e,t,s,i,a,o,l,c,u,d,h,m,f)=>class extends e{constructor(g,v,y){var w;const N=l(g),j=c(N),x=d({...Bd,...y});m(x);const k=oi.get(N),S=k?.get(v),b=j||N.state!=="closed"?N:(w=o(N))!==null&&w!==void 0?w:N,T=i(b,j?null:g.baseLatency,u,v,S,x),A=j?s(v,x,S):null;super(g,!0,T,A);const P=[];T.parameters.forEach((U,E)=>{const I=t(this,j,U);P.push([E,I])}),this._nativeAudioWorkletNode=T,this._onprocessorerror=null,this._parameters=new Ao(P),j&&n(N,this);const{activeInputs:O}=a(this);h(T,O)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(g){const v=typeof g=="function"?f(this,g):null;this._nativeAudioWorkletNode.onprocessorerror=v;const y=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=y!==null&&y===v?g:y}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function ir(n,e,t,s,i){if(typeof n.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),n.copyFromChannel(e[t],s,i);else{const a=n.getChannelData(s);if(e[t].byteLength===0)e[t]=a.slice(i,i+128);else{const o=new Float32Array(a.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(o)}}}const Mo=(n,e,t,s,i)=>{typeof n.copyToChannel=="function"?e[t].byteLength!==0&&n.copyToChannel(e[t],s,i):e[t].byteLength!==0&&n.getChannelData(s).set(e[t],i)},ar=(n,e)=>{const t=[];for(let s=0;s<n;s+=1){const i=[],a=typeof e=="number"?e:e[s];for(let o=0;o<a;o+=1)i.push(new Float32Array(128));t.push(i)}return t},Wd=(n,e)=>{const t=St(ci,n),s=Te(e);return St(t,s)},$d=async(n,e,t,s,i,a,o)=>{const l=e===null?Math.ceil(n.context.length/128)*128:e.length,c=s.channelCount*s.numberOfInputs,u=i.reduce((v,y)=>v+y,0),d=u===0?null:t.createBuffer(u,l,t.sampleRate);if(a===void 0)throw new Error("Missing the processor constructor.");const h=rt(n),m=await Wd(t,n),f=ar(s.numberOfInputs,s.channelCount),p=ar(s.numberOfOutputs,i),g=Array.from(n.parameters.keys()).reduce((v,y)=>({...v,[y]:new Float32Array(128)}),{});for(let v=0;v<l;v+=128){if(s.numberOfInputs>0&&e!==null)for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<s.channelCount;w+=1)ir(e,f[y],w,w,v);a.parameterDescriptors!==void 0&&e!==null&&a.parameterDescriptors.forEach(({name:y},w)=>{ir(e,g,y,c+w,v)});for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<i[y];w+=1)p[y][w].byteLength===0&&(p[y][w]=new Float32Array(128));try{const y=f.map((N,j)=>h.activeInputs[j].size===0?[]:N),w=o(v/t.sampleRate,t.sampleRate,()=>m.process(y,p,g));if(d!==null)for(let N=0,j=0;N<s.numberOfOutputs;N+=1){for(let x=0;x<i[N];x+=1)Mo(d,p[N],x,j+x,v);j+=i[N]}if(!w)break}catch(y){n.dispatchEvent(new ErrorEvent("processorerror",{colno:y.colno,filename:y.filename,lineno:y.lineno,message:y.message}));break}}return d},Gd=(n,e,t,s,i,a,o,l,c,u,d,h,m,f,p,g)=>(v,y,w)=>{const N=new WeakMap;let j=null;const x=async(k,S)=>{let b=d(k),T=null;const A=et(b,S),P=Array.isArray(y.outputChannelCount)?y.outputChannelCount:Array.from(y.outputChannelCount);if(h===null){const O=P.reduce((F,D)=>F+D,0),U=i(S,{channelCount:Math.max(1,O),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,O)}),E=[];for(let F=0;F<k.numberOfOutputs;F+=1)E.push(s(S,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:P[F]}));const I=o(S,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1});I.connect=e.bind(null,E),I.disconnect=c.bind(null,E),T=[U,E,I]}else A||(b=new h(S,v));if(N.set(S,T===null?b:T[2]),T!==null){if(j===null){if(w===void 0)throw new Error("Missing the processor constructor.");if(m===null)throw new Error("Missing the native OfflineAudioContext constructor.");const D=k.channelCount*k.numberOfInputs,Y=w.parameterDescriptors===void 0?0:w.parameterDescriptors.length,z=D+Y;j=$d(k,z===0?null:await(async()=>{const Q=new m(z,Math.ceil(k.context.length/128)*128,S.sampleRate),H=[],$=[];for(let C=0;C<y.numberOfInputs;C+=1)H.push(o(Q,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1})),$.push(i(Q,{channelCount:y.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:y.channelCount}));const ee=await Promise.all(Array.from(k.parameters.values()).map(async C=>{const L=a(Q,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:C.value});return await f(Q,C,L.offset),L})),V=s(Q,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,D+Y)});for(let C=0;C<y.numberOfInputs;C+=1){H[C].connect($[C]);for(let L=0;L<y.channelCount;L+=1)$[C].connect(V,L,C*y.channelCount+L)}for(const[C,L]of ee.entries())L.connect(V,0,D+C),L.start(0);return V.connect(Q.destination),await Promise.all(H.map(C=>p(k,Q,C))),g(Q)})(),S,y,P,w,u)}const O=await j,U=t(S,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[E,I,F]=T;O!==null&&(U.buffer=O,U.start(0)),U.connect(E);for(let D=0,Y=0;D<k.numberOfOutputs;D+=1){const z=I[D];for(let te=0;te<P[D];te+=1)E.connect(z,Y+te,te);Y+=P[D]}return F}if(A)for(const[O,U]of k.parameters.entries())await n(S,U,b.parameters.get(O));else for(const[O,U]of k.parameters.entries())await f(S,U,b.parameters.get(O));return await p(k,S,b),b};return{render(k,S){l(S,k);const b=N.get(S);return b!==void 0?Promise.resolve(b):x(k,S)}}},zd=(n,e,t,s,i,a,o,l,c,u,d,h,m,f,p,g,v,y,w,N)=>class extends p{constructor(x,k){super(x,k),this._nativeContext=x,this._audioWorklet=n===void 0?void 0:{addModule:(S,b)=>n(this,S,b)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new i(this)}createBuffer(x,k,S){return new t({length:k,numberOfChannels:x,sampleRate:S})}createBufferSource(){return new s(this)}createChannelMerger(x=6){return new a(this,{numberOfInputs:x})}createChannelSplitter(x=6){return new o(this,{numberOfOutputs:x})}createConstantSource(){return new l(this)}createConvolver(){return new c(this)}createDelay(x=1){return new d(this,{maxDelayTime:x})}createDynamicsCompressor(){return new h(this)}createGain(){return new m(this)}createIIRFilter(x,k){return new f(this,{feedback:k,feedforward:x})}createOscillator(){return new g(this)}createPanner(){return new v(this)}createPeriodicWave(x,k,S={disableNormalization:!1}){return new y(this,{...S,imag:k,real:x})}createStereoPanner(){return new w(this)}createWaveShaper(){return new N(this)}decodeAudioData(x,k,S){return u(this._nativeContext,x).then(b=>(typeof k=="function"&&k(b),b),b=>{throw typeof S=="function"&&S(b),b})}},Yd={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Hd=(n,e,t,s,i,a,o,l)=>class extends n{constructor(u,d){const h=a(u),m={...Yd,...d},f=i(h,m),p=o(h),g=p?t():null;super(u,!1,f,g),this._Q=e(this,p,f.Q,st,ct),this._detune=e(this,p,f.detune,1200*Math.log2(st),-1200*Math.log2(st)),this._frequency=e(this,p,f.frequency,u.sampleRate/2,0),this._gain=e(this,p,f.gain,40*Math.log10(st),ct),this._nativeBiquadFilterNode=f,l(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,d,h){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,d,h)}catch(m){throw m.code===11?s():m}if(u.length!==d.length||d.length!==h.length)throw s()}},Xd=(n,e,t,s,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=et(u,c);if(!d){const h={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(c,h)}return a.set(c,u),d?(await n(c,l.Q,u.Q),await n(c,l.detune,u.detune),await n(c,l.frequency,u.frequency),await n(c,l.gain,u.gain)):(await s(c,l.Q,u.Q),await s(c,l.detune,u.detune),await s(c,l.frequency,u.frequency),await s(c,l.gain,u.gain)),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Jd=(n,e)=>(t,s)=>{const i=e.get(t);if(i!==void 0)return i;const a=n.get(t);if(a!==void 0)return a;try{const o=s();return o instanceof Promise?(n.set(t,o),o.catch(()=>!1).then(l=>(n.delete(t),e.set(t,l),l))):(e.set(t,o),o)}catch{return e.set(t,!1),!1}},Kd={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Zd=(n,e,t,s,i)=>class extends n{constructor(o,l){const c=s(o),u={...Kd,...l},d=t(c,u),h=i(c)?e():null;super(o,!1,d,h)}},Qd=(n,e,t)=>()=>{const s=new WeakMap,i=async(a,o)=>{let l=e(a);if(!et(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfInputs:l.numberOfInputs};l=n(o,u)}return s.set(o,l),await t(a,o,l),l};return{render(a,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},eh={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},th=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=s(l),d=a({...eh,...c}),h=t(u,d),m=i(u)?e():null;super(l,!1,h,m)}},nh=(n,e,t)=>()=>{const s=new WeakMap,i=async(a,o)=>{let l=e(a);if(!et(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfOutputs:l.numberOfOutputs};l=n(o,u)}return s.set(o,l),await t(a,o,l),l};return{render(a,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},sh=n=>(e,t,s)=>n(t,e,s),rh=n=>(e,t,s=0,i=0)=>{const a=e[s];if(a===void 0)throw n();return rr(t)?a.connect(t,0,i):a.connect(t,0)},ih=n=>(e,t)=>{const s=n(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return s.buffer=i,s.loop=!0,s.connect(t),s.start(),()=>{s.stop(),s.disconnect(t)}},ah={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},oh=(n,e,t,s,i,a,o)=>class extends n{constructor(c,u){const d=i(c),h={...ah,...u},m=s(d,h),f=a(d),p=f?t():null;super(c,!1,m,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=m,this._offset=e(this,f,m.offset,st,ct),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeConstantSourceNode.onended=u;const d=this._nativeConstantSourceNode.onended;this._onended=d!==null&&d===u?c:d}start(c=0){if(this._nativeConstantSourceNode.start(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=c),this.context.state!=="closed"){$n(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),Bt(this)&&_s(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(c=0){this._nativeConstantSourceNode.stop(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=c)}},ch=(n,e,t,s,i)=>()=>{const a=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const m=et(h,d);if(!m){const f={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,offset:h.offset.value};h=e(d,f),o!==null&&h.start(o),l!==null&&h.stop(l)}return a.set(d,h),m?await n(d,u.offset,h.offset):await s(d,u.offset,h.offset),await i(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=a.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},lh=n=>e=>(n[0]=e,n[0]),uh={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},dh=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=s(l),d={...uh,...c},h=t(u,d),f=i(u)?e():null;super(l,!1,h,f),this._isBufferNullified=!1,this._nativeConvolverNode=h,d.buffer!==null&&a(this,d.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(l){if(this._nativeConvolverNode.buffer=l,l===null&&this._nativeConvolverNode.buffer!==null){const c=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=c.createBuffer(1,1,c.sampleRate),this._isBufferNullified=!0,a(this,0)}else this._isBufferNullified=!1,a(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(l){this._nativeConvolverNode.normalize=l}},hh=(n,e,t)=>()=>{const s=new WeakMap,i=async(a,o)=>{let l=e(a);if(!et(l,o)){const u={buffer:l.buffer,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,disableNormalization:!l.normalize};l=n(o,u)}return s.set(o,l),Zn(l)?await t(a,o,l.inputs[0]):await t(a,o,l),l};return{render(a,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},mh=(n,e)=>(t,s,i)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,s,i)}catch(a){throw a.name==="SyntaxError"?n():a}},ph=()=>new DOMException("","DataCloneError"),Da=n=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(s=>{const i=()=>{t.onmessage=null,e.close(),t.close(),s()};t.onmessage=()=>i();try{e.postMessage(n,[n])}catch{}finally{i()}})},fh=(n,e,t,s,i,a,o,l,c,u,d)=>(h,m)=>{const f=o(h)?h:a(h);if(i.has(m)){const p=t();return Promise.reject(p)}try{i.add(m)}catch{}return e(c,()=>c(f))?f.decodeAudioData(m).then(p=>(Da(m).catch(()=>{}),e(l,()=>l(p))||d(p),n.add(p),p)):new Promise((p,g)=>{const v=async()=>{try{await Da(m)}catch{}},y=w=>{g(w),v()};try{f.decodeAudioData(m,w=>{typeof w.copyFromChannel!="function"&&(u(w),Ni(w)),n.add(w),v().then(()=>p(w))},w=>{y(w===null?s():w)})}catch(w){y(w)}})},gh=(n,e,t,s,i,a,o,l)=>(c,u)=>{const d=e.get(c);if(d===void 0)throw new Error("Missing the expected cycle count.");const h=a(c.context),m=l(h);if(d===u){if(e.delete(c),!m&&o(c)){const f=s(c),{outputs:p}=t(c);for(const g of p)if(Ns(g)){const v=s(g[0]);n(f,v,g[1],g[2])}else{const v=i(g[0]);f.connect(v,g[1])}}}else e.set(c,d-u)},vh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},yh=(n,e,t,s,i,a,o)=>class extends n{constructor(c,u){const d=i(c),h={...vh,...u},m=s(d,h),f=a(d),p=f?t(h.maxDelayTime):null;super(c,!1,m,p),this._delayTime=e(this,f,m.delayTime),o(this,h.maxDelayTime)}get delayTime(){return this._delayTime}},bh=(n,e,t,s,i)=>a=>{const o=new WeakMap,l=async(c,u)=>{let d=t(c);const h=et(d,u);if(!h){const m={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,delayTime:d.delayTime.value,maxDelayTime:a};d=e(u,m)}return o.set(u,d),h?await n(u,c.delayTime,d.delayTime):await s(u,c.delayTime,d.delayTime),await i(c,u,d),d};return{render(c,u){const d=o.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},xh=n=>(e,t,s,i)=>n(e[i],a=>a[0]===t&&a[1]===s),_h=n=>(e,t)=>{n(e).delete(t)},wh=n=>"delayTime"in n,Nh=(n,e,t)=>function s(i,a){const o=tr(a)?a:t(n,a);if(wh(o))return[];if(i[0]===o)return[i];if(i.includes(o))return[];const{outputs:l}=e(o);return Array.from(l).map(c=>s([...i,o],c[0])).reduce((c,u)=>c.concat(u),[])},Fs=(n,e,t)=>{const s=e[t];if(s===void 0)throw n();return s},Sh=n=>(e,t=void 0,s=void 0,i=0)=>t===void 0?e.forEach(a=>a.disconnect()):typeof t=="number"?Fs(n,e,t).disconnect():rr(t)?s===void 0?e.forEach(a=>a.disconnect(t)):i===void 0?Fs(n,e,s).disconnect(t,0):Fs(n,e,s).disconnect(t,0,i):s===void 0?e.forEach(a=>a.disconnect(t)):Fs(n,e,s).disconnect(t,0),kh={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Th=(n,e,t,s,i,a,o,l)=>class extends n{constructor(u,d){const h=a(u),m={...kh,...d},f=s(h,m),p=o(h),g=p?t():null;super(u,!1,f,g),this._attack=e(this,p,f.attack),this._knee=e(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,p,f.ratio),this._release=e(this,p,f.release),this._threshold=e(this,p,f.threshold),l(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const d=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=d,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const d=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=d,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},jh=(n,e,t,s,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=et(u,c);if(!d){const h={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(c,h)}return a.set(c,u),d?(await n(c,l.attack,u.attack),await n(c,l.knee,u.knee),await n(c,l.ratio,u.ratio),await n(c,l.release,u.release),await n(c,l.threshold,u.threshold)):(await s(c,l.attack,u.attack),await s(c,l.knee,u.knee),await s(c,l.ratio,u.ratio),await s(c,l.release,u.release),await s(c,l.threshold,u.threshold)),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Ch=()=>new DOMException("","EncodingError"),Ih=n=>e=>new Promise((t,s)=>{if(n===null){s(new SyntaxError);return}const i=n.document.head;if(i===null)s(new SyntaxError);else{const a=n.document.createElement("script"),o=new Blob([e],{type:"application/javascript"}),l=URL.createObjectURL(o),c=n.onerror,u=()=>{n.onerror=c,URL.revokeObjectURL(l)};n.onerror=(d,h,m,f,p)=>{if(h===l||h===n.location.href&&m===1&&f===1)return u(),s(p),!1;if(c!==null)return c(d,h,m,f,p)},a.onerror=()=>{u(),s(new SyntaxError)},a.onload=()=>{u(),t()},a.src=l,a.type="module",i.appendChild(a)}}),Ah=n=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,s,i){if(s!==null){let a=this._listeners.get(s);a===void 0&&(a=n(this,s),typeof s=="function"&&this._listeners.set(s,a)),this._nativeEventTarget.addEventListener(t,a,i)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,s,i){const a=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(t,a===void 0?null:a,i)}},Mh=n=>(e,t,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},Eh=n=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw n()},Ph={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Oh=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=i(l),d={...Ph,...c},h=s(u,d),m=a(u),f=m?t():null;super(l,!1,h,f),this._gain=e(this,m,h.gain,st,ct)}get gain(){return this._gain}},Dh=(n,e,t,s,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=et(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(c,h)}return a.set(c,u),d?await n(c,l.gain,u.gain):await s(c,l.gain,u.gain),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Rh=(n,e)=>t=>e(n,t),Fh=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},Lh=n=>e=>{var t;return(t=n.get(e))!==null&&t!==void 0?t:0},Vh=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},Uh=n=>e=>n.get(e),ze=()=>new DOMException("","InvalidStateError"),Bh=n=>e=>{const t=n.get(e);if(t===void 0)throw ze();return t},qh=(n,e)=>t=>{let s=n.get(t);if(s!==void 0)return s;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new e(1,1,44100),n.set(t,s),s},Wh=n=>e=>{const t=n.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},fr=()=>new DOMException("","InvalidAccessError"),$h=n=>{n.getFrequencyResponse=(e=>(t,s,i)=>{if(t.length!==s.length||s.length!==i.length)throw fr();return e.call(n,t,s,i)})(n.getFrequencyResponse)},Gh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},zh=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=s(l),d=i(u),h={...Gh,...c},m=e(u,d?null:l.baseLatency,h),f=d?t(h.feedback,h.feedforward):null;super(l,!1,m,f),$h(m),this._nativeIIRFilterNode=m,a(this,1)}getFrequencyResponse(l,c,u){return this._nativeIIRFilterNode.getFrequencyResponse(l,c,u)}},Eo=(n,e,t,s,i,a,o,l,c,u,d)=>{const h=u.length;let m=l;for(let f=0;f<h;f+=1){let p=t[0]*u[f];for(let g=1;g<i;g+=1){const v=m-g&c-1;p+=t[g]*a[v],p-=n[g]*o[v]}for(let g=i;g<s;g+=1)p+=t[g]*a[m-g&c-1];for(let g=i;g<e;g+=1)p-=n[g]*o[m-g&c-1];a[m]=u[f],o[m]=p,m=m+1&c-1,d[f]=p}return m},Yh=(n,e,t,s)=>{const i=t instanceof Float64Array?t:new Float64Array(t),a=s instanceof Float64Array?s:new Float64Array(s),o=i.length,l=a.length,c=Math.min(o,l);if(i[0]!==1){for(let p=0;p<o;p+=1)a[p]/=i[0];for(let p=1;p<l;p+=1)i[p]/=i[0]}const u=32,d=new Float32Array(u),h=new Float32Array(u),m=e.createBuffer(n.numberOfChannels,n.length,n.sampleRate),f=n.numberOfChannels;for(let p=0;p<f;p+=1){const g=n.getChannelData(p),v=m.getChannelData(p);d.fill(0),h.fill(0),Eo(i,o,a,l,c,d,h,0,u,g,v)}return m},Hh=(n,e,t,s,i)=>(a,o)=>{const l=new WeakMap;let c=null;const u=async(d,h)=>{let m=null,f=e(d);const p=et(f,h);if(h.createIIRFilter===void 0?m=n(h,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=h.createIIRFilter(o,a)),l.set(h,m===null?f:m),m!==null){if(c===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const v=new t(d.context.destination.channelCount,d.context.length,h.sampleRate);c=(async()=>{await s(d,v,v.destination);const y=await i(v);return Yh(y,h,a,o)})()}const g=await c;return m.buffer=g,m.start(0),m}return await s(d,h,f),f};return{render(d,h){const m=l.get(h);return m!==void 0?Promise.resolve(m):u(d,h)}}},Xh=(n,e,t,s,i,a)=>o=>(l,c)=>{const u=n.get(l);if(u===void 0){if(!o&&a(l)){const d=s(l),{outputs:h}=t(l);for(const m of h)if(Ns(m)){const f=s(m[0]);e(d,f,m[1],m[2])}else{const f=i(m[0]);d.disconnect(f,m[1])}}n.set(l,c)}else n.set(l,u+c)},Jh=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Kh=(n,e)=>t=>n.has(t)||e(t),Zh=(n,e)=>t=>n.has(t)||e(t),Qh=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},em=n=>e=>n!==null&&e instanceof n,tm=n=>e=>n!==null&&typeof n.AudioNode=="function"&&e instanceof n.AudioNode,nm=n=>e=>n!==null&&typeof n.AudioParam=="function"&&e instanceof n.AudioParam,sm=(n,e)=>t=>n(t)||e(t),rm=n=>e=>n!==null&&e instanceof n,im=n=>n!==null&&n.isSecureContext,am=(n,e,t,s)=>class extends n{constructor(a,o){const l=t(a),c=e(l,o);if(s(l))throw TypeError();super(a,!0,c,null),this._nativeMediaElementAudioSourceNode=c}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},om={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},cm=(n,e,t,s)=>class extends n{constructor(a,o){const l=t(a);if(s(l))throw new TypeError;const c={...om,...o},u=e(l,c);super(a,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},lm=(n,e,t,s)=>class extends n{constructor(a,o){const l=t(a),c=e(l,o);if(s(l))throw new TypeError;super(a,!0,c,null),this._nativeMediaStreamAudioSourceNode=c}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},um=(n,e,t)=>class extends n{constructor(i,a){const o=t(i),l=e(o,a);super(i,!0,l,null)}},dm=(n,e,t,s,i,a)=>class extends t{constructor(l,c){super(l),this._nativeContext=l,mr.set(this,l),s(l)&&i.set(l,new Set),this._destination=new n(this,c),this._listener=e(this,l),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(l){const c=typeof l=="function"?a(this,l):null;this._nativeContext.onstatechange=c;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===c?l:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},ds=n=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=n.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},hm=(n,e)=>(t,s,i)=>{const a=new Set;return t.connect=(o=>(l,c=0,u=0)=>{const d=a.size===0;if(e(l))return o.call(t,l,c,u),n(a,[l,c,u],h=>h[0]===l&&h[1]===c&&h[2]===u,!0),d&&s(),l;o.call(t,l,c),n(a,[l,c],h=>h[0]===l&&h[1]===c,!0),d&&s()})(t.connect),t.disconnect=(o=>(l,c,u)=>{const d=a.size>0;if(l===void 0)o.apply(t),a.clear();else if(typeof l=="number"){o.call(t,l);for(const m of a)m[1]===l&&a.delete(m)}else{e(l)?o.call(t,l,c,u):o.call(t,l,c);for(const m of a)m[0]===l&&(c===void 0||m[1]===c)&&(u===void 0||m[2]===u)&&a.delete(m)}const h=a.size===0;d&&h&&i()})(t.disconnect),t},Ce=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t]&&(n[t]=s)},We=(n,e)=>{Ce(n,e,"channelCount"),Ce(n,e,"channelCountMode"),Ce(n,e,"channelInterpretation")},Ra=n=>typeof n.getFloatTimeDomainData=="function",mm=n=>{n.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);n.getByteTimeDomainData(t);const s=Math.max(t.length,n.fftSize);for(let i=0;i<s;i+=1)e[i]=(t[i]-128)*.0078125;return e}},pm=(n,e)=>(t,s)=>{const i=t.createAnalyser();if(We(i,s),!(s.maxDecibels>s.minDecibels))throw e();return Ce(i,s,"fftSize"),Ce(i,s,"maxDecibels"),Ce(i,s,"minDecibels"),Ce(i,s,"smoothingTimeConstant"),n(Ra,()=>Ra(i))||mm(i),i},fm=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,Me=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t].value&&(n[t].value=s)},gm=n=>{n.start=(e=>{let t=!1;return(s=0,i=0,a)=>{if(t)throw ze();e.call(n,s,i,a),t=!0}})(n.start)},Ti=n=>{n.start=(e=>(t=0,s=0,i)=>{if(typeof i=="number"&&i<0||s<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(n,t,s,i)})(n.start)},ji=n=>{n.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(n,t)})(n.stop)},vm=(n,e,t,s,i,a,o,l,c,u,d)=>(h,m)=>{const f=h.createBufferSource();return We(f,m),Me(f,m,"playbackRate"),Ce(f,m,"buffer"),Ce(f,m,"loop"),Ce(f,m,"loopEnd"),Ce(f,m,"loopStart"),e(t,()=>t(h))||gm(f),e(s,()=>s(h))||c(f),e(i,()=>i(h))||u(f,h),e(a,()=>a(h))||Ti(f),e(o,()=>o(h))||d(f,h),e(l,()=>l(h))||ji(f),n(h,f),f},ym=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,bm=(n,e)=>(t,s,i)=>{const a=t.destination;if(a.channelCount!==s)try{a.channelCount=s}catch{}i&&a.channelCountMode!=="explicit"&&(a.channelCountMode="explicit"),a.maxChannelCount===0&&Object.defineProperty(a,"maxChannelCount",{value:s});const o=n(t,{channelCount:s,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,gain:1});return e(o,"channelCount",l=>()=>l.call(o),l=>c=>{l.call(o,c);try{a.channelCount=c}catch(u){if(c>a.maxChannelCount)throw u}}),e(o,"channelCountMode",l=>()=>l.call(o),l=>c=>{l.call(o,c),a.channelCountMode=c}),e(o,"channelInterpretation",l=>()=>l.call(o),l=>c=>{l.call(o,c),a.channelInterpretation=c}),Object.defineProperty(o,"maxChannelCount",{get:()=>a.maxChannelCount}),o.connect(a),o},xm=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,_m=n=>{const{port1:e}=new MessageChannel;try{e.postMessage(n)}finally{e.close()}},wm=(n,e,t,s,i)=>(a,o,l,c,u,d)=>{if(l!==null)try{const h=new l(a,c,d),m=new Map;let f=null;if(Object.defineProperties(h,{channelCount:{get:()=>d.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&h.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&h.addEventListener("processorerror",f)}}}),h.addEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const v=typeof g[1]=="function"?g[1]:typeof g[1]=="object"&&g[1]!==null&&typeof g[1].handleEvent=="function"?g[1].handleEvent:null;if(v!==null){const y=m.get(g[1]);y!==void 0?g[1]=y:(g[1]=w=>{w.type==="error"?(Object.defineProperties(w,{type:{value:"processorerror"}}),v(w)):v(new ErrorEvent(g[0],{...w}))},m.set(v,g[1]))}}return p.call(h,"error",g[1],g[2]),p.call(h,...g)})(h.addEventListener),h.removeEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const v=m.get(g[1]);v!==void 0&&(m.delete(g[1]),g[1]=v)}return p.call(h,"error",g[1],g[2]),p.call(h,g[0],g[1],g[2])})(h.removeEventListener),d.numberOfOutputs!==0){const p=t(a,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return h.connect(p).connect(a.destination),i(h,()=>p.disconnect(),()=>p.connect(a.destination))}return h}catch(h){throw h.code===11?s():h}if(u===void 0)throw s();return _m(d),e(a,o,u,d)},Po=(n,e)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*e))))),Nm=n=>new Promise((e,t)=>{const{port1:s,port2:i}=new MessageChannel;s.onmessage=({data:a})=>{s.close(),i.close(),e(a)},s.onmessageerror=({data:a})=>{s.close(),i.close(),t(a)},i.postMessage(n)}),Sm=async(n,e)=>{const t=await Nm(e);return new n(t)},km=(n,e,t,s)=>{let i=ci.get(n);i===void 0&&(i=new WeakMap,ci.set(n,i));const a=Sm(t,s);return i.set(e,a),a},Tm=(n,e,t,s,i,a,o,l,c,u,d,h,m)=>(f,p,g,v)=>{if(v.numberOfInputs===0&&v.numberOfOutputs===0)throw c();const y=Array.isArray(v.outputChannelCount)?v.outputChannelCount:Array.from(v.outputChannelCount);if(y.some(K=>K<1))throw c();if(y.length!==v.numberOfOutputs)throw e();if(v.channelCountMode!=="explicit")throw c();const w=v.channelCount*v.numberOfInputs,N=y.reduce((K,W)=>K+W,0),j=g.parameterDescriptors===void 0?0:g.parameterDescriptors.length;if(w+j>6||N>6)throw c();const x=new MessageChannel,k=[],S=[];for(let K=0;K<v.numberOfInputs;K+=1)k.push(o(f,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1})),S.push(i(f,{channelCount:v.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:v.channelCount}));const b=[];if(g.parameterDescriptors!==void 0)for(const{defaultValue:K,maxValue:W,minValue:ie,name:pe}of g.parameterDescriptors){const ce=a(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:v.parameterData[pe]!==void 0?v.parameterData[pe]:K===void 0?0:K});Object.defineProperties(ce.offset,{defaultValue:{get:()=>K===void 0?0:K},maxValue:{get:()=>W===void 0?st:W},minValue:{get:()=>ie===void 0?ct:ie}}),b.push(ce)}const T=s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,w+j)}),A=Po(p,f.sampleRate),P=l(f,A,w+j,Math.max(1,N)),O=i(f,{channelCount:Math.max(1,N),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,N)}),U=[];for(let K=0;K<v.numberOfOutputs;K+=1)U.push(s(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:y[K]}));for(let K=0;K<v.numberOfInputs;K+=1){k[K].connect(S[K]);for(let W=0;W<v.channelCount;W+=1)S[K].connect(T,W,K*v.channelCount+W)}const E=new Ao(g.parameterDescriptors===void 0?[]:g.parameterDescriptors.map(({name:K},W)=>{const ie=b[W];return ie.connect(T,0,w+W),ie.start(0),[K,ie.offset]}));T.connect(P);let I=v.channelInterpretation,F=null;const D=v.numberOfOutputs===0?[P]:U,Y={get bufferSize(){return A},get channelCount(){return v.channelCount},set channelCount(K){throw t()},get channelCountMode(){return v.channelCountMode},set channelCountMode(K){throw t()},get channelInterpretation(){return I},set channelInterpretation(K){for(const W of k)W.channelInterpretation=K;I=K},get context(){return P.context},get inputs(){return k},get numberOfInputs(){return v.numberOfInputs},get numberOfOutputs(){return v.numberOfOutputs},get onprocessorerror(){return F},set onprocessorerror(K){typeof F=="function"&&Y.removeEventListener("processorerror",F),F=typeof K=="function"?K:null,typeof F=="function"&&Y.addEventListener("processorerror",F)},get parameters(){return E},get port(){return x.port2},addEventListener(...K){return P.addEventListener(K[0],K[1],K[2])},connect:n.bind(null,D),disconnect:u.bind(null,D),dispatchEvent(...K){return P.dispatchEvent(K[0])},removeEventListener(...K){return P.removeEventListener(K[0],K[1],K[2])}},z=new Map;x.port1.addEventListener=(K=>(...W)=>{if(W[0]==="message"){const ie=typeof W[1]=="function"?W[1]:typeof W[1]=="object"&&W[1]!==null&&typeof W[1].handleEvent=="function"?W[1].handleEvent:null;if(ie!==null){const pe=z.get(W[1]);pe!==void 0?W[1]=pe:(W[1]=ce=>{d(f.currentTime,f.sampleRate,()=>ie(ce))},z.set(ie,W[1]))}}return K.call(x.port1,W[0],W[1],W[2])})(x.port1.addEventListener),x.port1.removeEventListener=(K=>(...W)=>{if(W[0]==="message"){const ie=z.get(W[1]);ie!==void 0&&(z.delete(W[1]),W[1]=ie)}return K.call(x.port1,W[0],W[1],W[2])})(x.port1.removeEventListener);let te=null;Object.defineProperty(x.port1,"onmessage",{get:()=>te,set:K=>{typeof te=="function"&&x.port1.removeEventListener("message",te),te=typeof K=="function"?K:null,typeof te=="function"&&(x.port1.addEventListener("message",te),x.port1.start())}}),g.prototype.port=x.port1;let Q=null;km(f,Y,g,v).then(K=>Q=K);const $=ar(v.numberOfInputs,v.channelCount),ee=ar(v.numberOfOutputs,y),V=g.parameterDescriptors===void 0?[]:g.parameterDescriptors.reduce((K,{name:W})=>({...K,[W]:new Float32Array(128)}),{});let C=!0;const L=()=>{v.numberOfOutputs>0&&P.disconnect(O);for(let K=0,W=0;K<v.numberOfOutputs;K+=1){const ie=U[K];for(let pe=0;pe<y[K];pe+=1)O.disconnect(ie,W+pe,pe);W+=y[K]}},M=new Map;P.onaudioprocess=({inputBuffer:K,outputBuffer:W})=>{if(Q!==null){const ie=h(Y);for(let pe=0;pe<A;pe+=128){for(let ce=0;ce<v.numberOfInputs;ce+=1)for(let ge=0;ge<v.channelCount;ge+=1)ir(K,$[ce],ge,ge,pe);g.parameterDescriptors!==void 0&&g.parameterDescriptors.forEach(({name:ce},ge)=>{ir(K,V,ce,w+ge,pe)});for(let ce=0;ce<v.numberOfInputs;ce+=1)for(let ge=0;ge<y[ce];ge+=1)ee[ce][ge].byteLength===0&&(ee[ce][ge]=new Float32Array(128));try{const ce=$.map((Xe,tt)=>{if(ie[tt].size>0)return M.set(tt,A/128),Xe;const G=M.get(tt);return G===void 0?[]:(Xe.every(ne=>ne.every(le=>le===0))&&(G===1?M.delete(tt):M.set(tt,G-1)),Xe)});C=d(f.currentTime+pe/f.sampleRate,f.sampleRate,()=>Q.process(ce,ee,V));for(let Xe=0,tt=0;Xe<v.numberOfOutputs;Xe+=1){for(let B=0;B<y[Xe];B+=1)Mo(W,ee[Xe],B,tt+B,pe);tt+=y[Xe]}}catch(ce){C=!1,Y.dispatchEvent(new ErrorEvent("processorerror",{colno:ce.colno,filename:ce.filename,lineno:ce.lineno,message:ce.message}))}if(!C){for(let ce=0;ce<v.numberOfInputs;ce+=1){k[ce].disconnect(S[ce]);for(let ge=0;ge<v.channelCount;ge+=1)S[pe].disconnect(T,ge,ce*v.channelCount+ge)}if(g.parameterDescriptors!==void 0){const ce=g.parameterDescriptors.length;for(let ge=0;ge<ce;ge+=1){const Xe=b[ge];Xe.disconnect(T,0,w+ge),Xe.stop()}}T.disconnect(P),P.onaudioprocess=null,J?L():ve();break}}}};let J=!1;const X=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),se=()=>P.connect(X).connect(f.destination),ve=()=>{P.disconnect(X),X.disconnect()},ke=()=>{if(C){ve(),v.numberOfOutputs>0&&P.connect(O);for(let K=0,W=0;K<v.numberOfOutputs;K+=1){const ie=U[K];for(let pe=0;pe<y[K];pe+=1)O.connect(ie,W+pe,pe);W+=y[K]}}J=!0},Ve=()=>{C&&(se(),L()),J=!1};return se(),m(Y,ke,Ve)},Oo=(n,e)=>{const t=n.createBiquadFilter();return We(t,e),Me(t,e,"Q"),Me(t,e,"detune"),Me(t,e,"frequency"),Me(t,e,"gain"),Ce(t,e,"type"),t},jm=(n,e)=>(t,s)=>{const i=t.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&e(t,i),We(i,s),i},Cm=n=>{const e=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw ze()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw ze()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw ze()}})},Ss=(n,e)=>{const t=n.createChannelSplitter(e.numberOfOutputs);return We(t,e),Cm(t),t},Im=(n,e,t,s,i)=>(a,o)=>{if(a.createConstantSource===void 0)return t(a,o);const l=a.createConstantSource();return We(l,o),Me(l,o,"offset"),e(s,()=>s(a))||Ti(l),e(i,()=>i(a))||ji(l),n(a,l),l},Qn=(n,e)=>(n.connect=e.connect.bind(e),n.disconnect=e.disconnect.bind(e),n),Am=(n,e,t,s)=>(i,{offset:a,...o})=>{const l=i.createBuffer(1,2,44100),c=e(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(i,{...o,gain:a}),d=l.getChannelData(0);d[0]=1,d[1]=1,c.buffer=l,c.loop=!0;const h={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(p){u.channelCount=p},get channelCountMode(){return u.channelCountMode},set channelCountMode(p){u.channelCountMode=p},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(p){u.channelInterpretation=p},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return c.onended},set onended(p){c.onended=p},addEventListener(...p){return c.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return c.dispatchEvent(p[0])},removeEventListener(...p){return c.removeEventListener(p[0],p[1],p[2])},start(p=0){c.start.call(c,p)},stop(p=0){c.stop.call(c,p)}},m=()=>c.connect(u),f=()=>c.disconnect(u);return n(i,c),s(Qn(h,u),m,f)},Mm=(n,e)=>(t,s)=>{const i=t.createConvolver();if(We(i,s),s.disableNormalization===i.normalize&&(i.normalize=!s.disableNormalization),Ce(i,s,"buffer"),s.channelCount>2||(e(i,"channelCount",a=>()=>a.call(i),a=>o=>{if(o>2)throw n();return a.call(i,o)}),s.channelCountMode==="max"))throw n();return e(i,"channelCountMode",a=>()=>a.call(i),a=>o=>{if(o==="max")throw n();return a.call(i,o)}),i},Do=(n,e)=>{const t=n.createDelay(e.maxDelayTime);return We(t,e),Me(t,e,"delayTime"),t},Em=n=>(e,t)=>{const s=e.createDynamicsCompressor();if(We(s,t),t.channelCount>2||t.channelCountMode==="max")throw n();return Me(s,t,"attack"),Me(s,t,"knee"),Me(s,t,"ratio"),Me(s,t,"release"),Me(s,t,"threshold"),s},ut=(n,e)=>{const t=n.createGain();return We(t,e),Me(t,e,"gain"),t},Pm=n=>(e,t,s)=>{if(e.createIIRFilter===void 0)return n(e,t,s);const i=e.createIIRFilter(s.feedforward,s.feedback);return We(i,s),i};function Om(n,e){const t=e[0]*e[0]+e[1]*e[1];return[(n[0]*e[0]+n[1]*e[1])/t,(n[1]*e[0]-n[0]*e[1])/t]}function Dm(n,e){return[n[0]*e[0]-n[1]*e[1],n[0]*e[1]+n[1]*e[0]]}function Fa(n,e){let t=[0,0];for(let s=n.length-1;s>=0;s-=1)t=Dm(t,e),t[0]+=n[s];return t}const Rm=(n,e,t,s)=>(i,a,{channelCount:o,channelCountMode:l,channelInterpretation:c,feedback:u,feedforward:d})=>{const h=Po(a,i.sampleRate),m=u instanceof Float64Array?u:new Float64Array(u),f=d instanceof Float64Array?d:new Float64Array(d),p=m.length,g=f.length,v=Math.min(p,g);if(p===0||p>20)throw s();if(m[0]===0)throw e();if(g===0||g>20)throw s();if(f[0]===0)throw e();if(m[0]!==1){for(let b=0;b<g;b+=1)f[b]/=m[0];for(let b=1;b<p;b+=1)m[b]/=m[0]}const y=t(i,h,o,o);y.channelCount=o,y.channelCountMode=l,y.channelInterpretation=c;const w=32,N=[],j=[],x=[];for(let b=0;b<o;b+=1){N.push(0);const T=new Float32Array(w),A=new Float32Array(w);T.fill(0),A.fill(0),j.push(T),x.push(A)}y.onaudioprocess=b=>{const T=b.inputBuffer,A=b.outputBuffer,P=T.numberOfChannels;for(let O=0;O<P;O+=1){const U=T.getChannelData(O),E=A.getChannelData(O);N[O]=Eo(m,p,f,g,v,j[O],x[O],N[O],w,U,E)}};const k=i.sampleRate/2;return Qn({get bufferSize(){return h},get channelCount(){return y.channelCount},set channelCount(b){y.channelCount=b},get channelCountMode(){return y.channelCountMode},set channelCountMode(b){y.channelCountMode=b},get channelInterpretation(){return y.channelInterpretation},set channelInterpretation(b){y.channelInterpretation=b},get context(){return y.context},get inputs(){return[y]},get numberOfInputs(){return y.numberOfInputs},get numberOfOutputs(){return y.numberOfOutputs},addEventListener(...b){return y.addEventListener(b[0],b[1],b[2])},dispatchEvent(...b){return y.dispatchEvent(b[0])},getFrequencyResponse(b,T,A){if(b.length!==T.length||T.length!==A.length)throw n();const P=b.length;for(let O=0;O<P;O+=1){const U=-Math.PI*(b[O]/k),E=[Math.cos(U),Math.sin(U)],I=Fa(f,E),F=Fa(m,E),D=Om(I,F);T[O]=Math.sqrt(D[0]*D[0]+D[1]*D[1]),A[O]=Math.atan2(D[1],D[0])}},removeEventListener(...b){return y.removeEventListener(b[0],b[1],b[2])}},y)},Fm=(n,e)=>n.createMediaElementSource(e.mediaElement),Lm=(n,e)=>{const t=n.createMediaStreamDestination();return We(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},Vm=(n,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((a,o)=>a.id<o.id?-1:a.id>o.id?1:0);const s=t.slice(0,1),i=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(i,"mediaStream",{value:e}),i},Um=(n,e)=>(t,{mediaStreamTrack:s})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(s);const i=new MediaStream([s]),a=t.createMediaStreamSource(i);if(s.kind!=="audio")throw n();if(e(t))throw new TypeError;return a},Bm=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,qm=(n,e,t,s,i,a)=>(o,l)=>{const c=o.createOscillator();return We(c,l),Me(c,l,"detune"),Me(c,l,"frequency"),l.periodicWave!==void 0?c.setPeriodicWave(l.periodicWave):Ce(c,l,"type"),e(t,()=>t(o))||Ti(c),e(s,()=>s(o))||a(c,o),e(i,()=>i(o))||ji(c),n(o,c),c},Wm=n=>(e,t)=>{const s=e.createPanner();return s.orientationX===void 0?n(e,t):(We(s,t),Me(s,t,"orientationX"),Me(s,t,"orientationY"),Me(s,t,"orientationZ"),Me(s,t,"positionX"),Me(s,t,"positionY"),Me(s,t,"positionZ"),Ce(s,t,"coneInnerAngle"),Ce(s,t,"coneOuterAngle"),Ce(s,t,"coneOuterGain"),Ce(s,t,"distanceModel"),Ce(s,t,"maxDistance"),Ce(s,t,"panningModel"),Ce(s,t,"refDistance"),Ce(s,t,"rolloffFactor"),s)},$m=(n,e,t,s,i,a,o,l,c,u)=>(d,{coneInnerAngle:h,coneOuterAngle:m,coneOuterGain:f,distanceModel:p,maxDistance:g,orientationX:v,orientationY:y,orientationZ:w,panningModel:N,positionX:j,positionY:x,positionZ:k,refDistance:S,rolloffFactor:b,...T})=>{const A=d.createPanner();if(T.channelCount>2||T.channelCountMode==="max")throw o();We(A,T);const P={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},O=t(d,{...P,channelInterpretation:"speakers",numberOfInputs:6}),U=s(d,{...T,gain:1}),E=s(d,{...P,gain:1}),I=s(d,{...P,gain:0}),F=s(d,{...P,gain:0}),D=s(d,{...P,gain:0}),Y=s(d,{...P,gain:0}),z=s(d,{...P,gain:0}),te=i(d,256,6,1),Q=a(d,{...P,curve:new Float32Array([1,1]),oversample:"none"});let H=[v,y,w],$=[j,x,k];const ee=new Float32Array(1);te.onaudioprocess=({inputBuffer:M})=>{const J=[c(M,ee,0),c(M,ee,1),c(M,ee,2)];J.some((se,ve)=>se!==H[ve])&&(A.setOrientation(...J),H=J);const X=[c(M,ee,3),c(M,ee,4),c(M,ee,5)];X.some((se,ve)=>se!==$[ve])&&(A.setPosition(...X),$=X)},Object.defineProperty(I.gain,"defaultValue",{get:()=>0}),Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(D.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Y.gain,"defaultValue",{get:()=>0}),Object.defineProperty(z.gain,"defaultValue",{get:()=>0});const V={get bufferSize(){},get channelCount(){return A.channelCount},set channelCount(M){if(M>2)throw o();U.channelCount=M,A.channelCount=M},get channelCountMode(){return A.channelCountMode},set channelCountMode(M){if(M==="max")throw o();U.channelCountMode=M,A.channelCountMode=M},get channelInterpretation(){return A.channelInterpretation},set channelInterpretation(M){U.channelInterpretation=M,A.channelInterpretation=M},get coneInnerAngle(){return A.coneInnerAngle},set coneInnerAngle(M){A.coneInnerAngle=M},get coneOuterAngle(){return A.coneOuterAngle},set coneOuterAngle(M){A.coneOuterAngle=M},get coneOuterGain(){return A.coneOuterGain},set coneOuterGain(M){if(M<0||M>1)throw e();A.coneOuterGain=M},get context(){return A.context},get distanceModel(){return A.distanceModel},set distanceModel(M){A.distanceModel=M},get inputs(){return[U]},get maxDistance(){return A.maxDistance},set maxDistance(M){if(M<0)throw new RangeError;A.maxDistance=M},get numberOfInputs(){return A.numberOfInputs},get numberOfOutputs(){return A.numberOfOutputs},get orientationX(){return E.gain},get orientationY(){return I.gain},get orientationZ(){return F.gain},get panningModel(){return A.panningModel},set panningModel(M){A.panningModel=M},get positionX(){return D.gain},get positionY(){return Y.gain},get positionZ(){return z.gain},get refDistance(){return A.refDistance},set refDistance(M){if(M<0)throw new RangeError;A.refDistance=M},get rolloffFactor(){return A.rolloffFactor},set rolloffFactor(M){if(M<0)throw new RangeError;A.rolloffFactor=M},addEventListener(...M){return U.addEventListener(M[0],M[1],M[2])},dispatchEvent(...M){return U.dispatchEvent(M[0])},removeEventListener(...M){return U.removeEventListener(M[0],M[1],M[2])}};h!==V.coneInnerAngle&&(V.coneInnerAngle=h),m!==V.coneOuterAngle&&(V.coneOuterAngle=m),f!==V.coneOuterGain&&(V.coneOuterGain=f),p!==V.distanceModel&&(V.distanceModel=p),g!==V.maxDistance&&(V.maxDistance=g),v!==V.orientationX.value&&(V.orientationX.value=v),y!==V.orientationY.value&&(V.orientationY.value=y),w!==V.orientationZ.value&&(V.orientationZ.value=w),N!==V.panningModel&&(V.panningModel=N),j!==V.positionX.value&&(V.positionX.value=j),x!==V.positionY.value&&(V.positionY.value=x),k!==V.positionZ.value&&(V.positionZ.value=k),S!==V.refDistance&&(V.refDistance=S),b!==V.rolloffFactor&&(V.rolloffFactor=b),(H[0]!==1||H[1]!==0||H[2]!==0)&&A.setOrientation(...H),($[0]!==0||$[1]!==0||$[2]!==0)&&A.setPosition(...$);const C=()=>{U.connect(A),n(U,Q,0,0),Q.connect(E).connect(O,0,0),Q.connect(I).connect(O,0,1),Q.connect(F).connect(O,0,2),Q.connect(D).connect(O,0,3),Q.connect(Y).connect(O,0,4),Q.connect(z).connect(O,0,5),O.connect(te).connect(d.destination)},L=()=>{U.disconnect(A),l(U,Q,0,0),Q.disconnect(E),E.disconnect(O),Q.disconnect(I),I.disconnect(O),Q.disconnect(F),F.disconnect(O),Q.disconnect(D),D.disconnect(O),Q.disconnect(Y),Y.disconnect(O),Q.disconnect(z),z.disconnect(O),O.disconnect(te),te.disconnect(d.destination)};return u(Qn(V,A),C,L)},Gm=n=>(e,{disableNormalization:t,imag:s,real:i})=>{const a=s instanceof Float32Array?s:new Float32Array(s),o=i instanceof Float32Array?i:new Float32Array(i),l=e.createPeriodicWave(o,a,{disableNormalization:t});if(Array.from(s).length<2)throw n();return l},ks=(n,e,t,s)=>n.createScriptProcessor(e,t,s),zm=(n,e)=>(t,s)=>{const i=s.channelCountMode;if(i==="clamped-max")throw e();if(t.createStereoPanner===void 0)return n(t,s);const a=t.createStereoPanner();return We(a,s),Me(a,s,"pan"),Object.defineProperty(a,"channelCountMode",{get:()=>i,set:o=>{if(o!==i)throw e()}}),a},Ym=(n,e,t,s,i,a)=>{const l=new Float32Array([1,1]),c=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},d={...u,oversample:"none"},h=(p,g,v,y)=>{const w=new Float32Array(16385),N=new Float32Array(16385);for(let T=0;T<16385;T+=1){const A=T/16384*c;w[T]=Math.cos(A),N[T]=Math.sin(A)}const j=t(p,{...u,gain:0}),x=s(p,{...d,curve:w}),k=s(p,{...d,curve:l}),S=t(p,{...u,gain:0}),b=s(p,{...d,curve:N});return{connectGraph(){g.connect(j),g.connect(k.inputs===void 0?k:k.inputs[0]),g.connect(S),k.connect(v),v.connect(x.inputs===void 0?x:x.inputs[0]),v.connect(b.inputs===void 0?b:b.inputs[0]),x.connect(j.gain),b.connect(S.gain),j.connect(y,0,0),S.connect(y,0,1)},disconnectGraph(){g.disconnect(j),g.disconnect(k.inputs===void 0?k:k.inputs[0]),g.disconnect(S),k.disconnect(v),v.disconnect(x.inputs===void 0?x:x.inputs[0]),v.disconnect(b.inputs===void 0?b:b.inputs[0]),x.disconnect(j.gain),b.disconnect(S.gain),j.disconnect(y,0,0),S.disconnect(y,0,1)}}},m=(p,g,v,y)=>{const w=new Float32Array(16385),N=new Float32Array(16385),j=new Float32Array(16385),x=new Float32Array(16385),k=Math.floor(16385/2);for(let D=0;D<16385;D+=1)if(D>k){const Y=(D-k)/(16384-k)*c;w[D]=Math.cos(Y),N[D]=Math.sin(Y),j[D]=0,x[D]=1}else{const Y=D/(16384-k)*c;w[D]=1,N[D]=0,j[D]=Math.cos(Y),x[D]=Math.sin(Y)}const S=e(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),b=t(p,{...u,gain:0}),T=s(p,{...d,curve:w}),A=t(p,{...u,gain:0}),P=s(p,{...d,curve:N}),O=s(p,{...d,curve:l}),U=t(p,{...u,gain:0}),E=s(p,{...d,curve:j}),I=t(p,{...u,gain:0}),F=s(p,{...d,curve:x});return{connectGraph(){g.connect(S),g.connect(O.inputs===void 0?O:O.inputs[0]),S.connect(b,0),S.connect(A,0),S.connect(U,1),S.connect(I,1),O.connect(v),v.connect(T.inputs===void 0?T:T.inputs[0]),v.connect(P.inputs===void 0?P:P.inputs[0]),v.connect(E.inputs===void 0?E:E.inputs[0]),v.connect(F.inputs===void 0?F:F.inputs[0]),T.connect(b.gain),P.connect(A.gain),E.connect(U.gain),F.connect(I.gain),b.connect(y,0,0),U.connect(y,0,0),A.connect(y,0,1),I.connect(y,0,1)},disconnectGraph(){g.disconnect(S),g.disconnect(O.inputs===void 0?O:O.inputs[0]),S.disconnect(b,0),S.disconnect(A,0),S.disconnect(U,1),S.disconnect(I,1),O.disconnect(v),v.disconnect(T.inputs===void 0?T:T.inputs[0]),v.disconnect(P.inputs===void 0?P:P.inputs[0]),v.disconnect(E.inputs===void 0?E:E.inputs[0]),v.disconnect(F.inputs===void 0?F:F.inputs[0]),T.disconnect(b.gain),P.disconnect(A.gain),E.disconnect(U.gain),F.disconnect(I.gain),b.disconnect(y,0,0),U.disconnect(y,0,0),A.disconnect(y,0,1),I.disconnect(y,0,1)}}},f=(p,g,v,y,w)=>{if(g===1)return h(p,v,y,w);if(g===2)return m(p,v,y,w);throw i()};return(p,{channelCount:g,channelCountMode:v,pan:y,...w})=>{if(v==="max")throw i();const N=n(p,{...w,channelCount:1,channelCountMode:v,numberOfInputs:2}),j=t(p,{...w,channelCount:g,channelCountMode:v,gain:1}),x=t(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:y});let{connectGraph:k,disconnectGraph:S}=f(p,g,j,x,N);Object.defineProperty(x.gain,"defaultValue",{get:()=>0}),Object.defineProperty(x.gain,"maxValue",{get:()=>1}),Object.defineProperty(x.gain,"minValue",{get:()=>-1});const b={get bufferSize(){},get channelCount(){return j.channelCount},set channelCount(O){j.channelCount!==O&&(T&&S(),{connectGraph:k,disconnectGraph:S}=f(p,O,j,x,N),T&&k()),j.channelCount=O},get channelCountMode(){return j.channelCountMode},set channelCountMode(O){if(O==="clamped-max"||O==="max")throw i();j.channelCountMode=O},get channelInterpretation(){return j.channelInterpretation},set channelInterpretation(O){j.channelInterpretation=O},get context(){return j.context},get inputs(){return[j]},get numberOfInputs(){return j.numberOfInputs},get numberOfOutputs(){return j.numberOfOutputs},get pan(){return x.gain},addEventListener(...O){return j.addEventListener(O[0],O[1],O[2])},dispatchEvent(...O){return j.dispatchEvent(O[0])},removeEventListener(...O){return j.removeEventListener(O[0],O[1],O[2])}};let T=!1;const A=()=>{k(),T=!0},P=()=>{S(),T=!1};return a(Qn(b,N),A,P)}},Hm=(n,e,t,s,i,a,o)=>(l,c)=>{const u=l.createWaveShaper();if(a!==null&&a.name==="webkitAudioContext"&&l.createGain().gain.automationRate===void 0)return t(l,c);We(u,c);const d=c.curve===null||c.curve instanceof Float32Array?c.curve:new Float32Array(c.curve);if(d!==null&&d.length<2)throw e();Ce(u,{curve:d},"curve"),Ce(u,c,"oversample");let h=null,m=!1;return o(u,"curve",g=>()=>g.call(u),g=>v=>(g.call(u,v),m&&(s(v)&&h===null?h=n(l,u):!s(v)&&h!==null&&(h(),h=null)),v)),i(u,()=>{m=!0,s(u.curve)&&(h=n(l,u))},()=>{m=!1,h!==null&&(h(),h=null)})},Xm=(n,e,t,s,i)=>(a,{curve:o,oversample:l,...c})=>{const u=a.createWaveShaper(),d=a.createWaveShaper();We(u,c),We(d,c);const h=t(a,{...c,gain:1}),m=t(a,{...c,gain:-1}),f=t(a,{...c,gain:1}),p=t(a,{...c,gain:-1});let g=null,v=!1,y=null;const w={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(x){h.channelCount=x,m.channelCount=x,u.channelCount=x,f.channelCount=x,d.channelCount=x,p.channelCount=x},get channelCountMode(){return u.channelCountMode},set channelCountMode(x){h.channelCountMode=x,m.channelCountMode=x,u.channelCountMode=x,f.channelCountMode=x,d.channelCountMode=x,p.channelCountMode=x},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(x){h.channelInterpretation=x,m.channelInterpretation=x,u.channelInterpretation=x,f.channelInterpretation=x,d.channelInterpretation=x,p.channelInterpretation=x},get context(){return u.context},get curve(){return y},set curve(x){if(x!==null&&x.length<2)throw e();if(x===null)u.curve=x,d.curve=x;else{const k=x.length,S=new Float32Array(k+2-k%2),b=new Float32Array(k+2-k%2);S[0]=x[0],b[0]=-x[k-1];const T=Math.ceil((k+1)/2),A=(k+1)/2-1;for(let P=1;P<T;P+=1){const O=P/T*A,U=Math.floor(O),E=Math.ceil(O);S[P]=U===E?x[U]:(1-(O-U))*x[U]+(1-(E-O))*x[E],b[P]=U===E?-x[k-1-U]:-((1-(O-U))*x[k-1-U])-(1-(E-O))*x[k-1-E]}S[T]=k%2===1?x[T-1]:(x[T-2]+x[T-1])/2,u.curve=S,d.curve=b}y=x,v&&(s(y)&&g===null?g=n(a,h):g!==null&&(g(),g=null))},get inputs(){return[h]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(x){u.oversample=x,d.oversample=x},addEventListener(...x){return h.addEventListener(x[0],x[1],x[2])},dispatchEvent(...x){return h.dispatchEvent(x[0])},removeEventListener(...x){return h.removeEventListener(x[0],x[1],x[2])}};o!==null&&(w.curve=o instanceof Float32Array?o:new Float32Array(o)),l!==w.oversample&&(w.oversample=l);const N=()=>{h.connect(u).connect(f),h.connect(m).connect(d).connect(p).connect(f),v=!0,s(y)&&(g=n(a,h))},j=()=>{h.disconnect(u),u.disconnect(f),h.disconnect(m),m.disconnect(d),d.disconnect(p),p.disconnect(f),v=!1,g!==null&&(g(),g=null)};return i(Qn(w,f),N,j)},it=()=>new DOMException("","NotSupportedError"),Jm={numberOfChannels:1},Km=(n,e,t,s,i)=>class extends n{constructor(o,l,c){let u;if(typeof o=="number"&&l!==void 0&&c!==void 0)u={length:l,numberOfChannels:o,sampleRate:c};else if(typeof o=="object")u=o;else throw new Error("The given parameters are not valid.");const{length:d,numberOfChannels:h,sampleRate:m}={...Jm,...u},f=s(h,d,m);e(ds,()=>ds(f))||f.addEventListener("statechange",(()=>{let p=0;const g=v=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",g),v.stopImmediatePropagation(),this._waitForThePromiseToSettle(v)):p+=1)};return g})()),super(f,h),this._length=d,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,To(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},Zm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Qm=(n,e,t,s,i,a,o)=>class extends n{constructor(c,u){const d=i(c),h={...Zm,...u},m=t(d,h),f=a(d),p=f?s():null,g=c.sampleRate/2;super(c,!1,m,p),this._detune=e(this,f,m.detune,153600,-153600),this._frequency=e(this,f,m.frequency,g,-g),this._nativeOscillatorNode=m,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&h.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=h.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeOscillatorNode.onended=u;const d=this._nativeOscillatorNode.onended;this._onended=d!==null&&d===u?c:d}get type(){return this._nativeOscillatorNode.type}set type(c){this._nativeOscillatorNode.type=c,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(c){this._nativeOscillatorNode.setPeriodicWave(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=c)}start(c=0){if(this._nativeOscillatorNode.start(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=c),this.context.state!=="closed"){$n(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),Bt(this)&&_s(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(c=0){this._nativeOscillatorNode.stop(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=c)}},ep=(n,e,t,s,i)=>()=>{const a=new WeakMap;let o=null,l=null,c=null;const u=async(d,h)=>{let m=t(d);const f=et(m,h);if(!f){const p={channelCount:m.channelCount,channelCountMode:m.channelCountMode,channelInterpretation:m.channelInterpretation,detune:m.detune.value,frequency:m.frequency.value,periodicWave:o===null?void 0:o,type:m.type};m=e(h,p),l!==null&&m.start(l),c!==null&&m.stop(c)}return a.set(h,m),f?(await n(h,d.detune,m.detune),await n(h,d.frequency,m.frequency)):(await s(h,d.detune,m.detune),await s(h,d.frequency,m.frequency)),await i(d,h,m),m};return{set periodicWave(d){o=d},set start(d){l=d},set stop(d){c=d},render(d,h){const m=a.get(h);return m!==void 0?Promise.resolve(m):u(d,h)}}},tp={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},np=(n,e,t,s,i,a,o)=>class extends n{constructor(c,u){const d=i(c),h={...tp,...u},m=t(d,h),f=a(d),p=f?s():null;super(c,!1,m,p),this._nativePannerNode=m,this._orientationX=e(this,f,m.orientationX,st,ct),this._orientationY=e(this,f,m.orientationY,st,ct),this._orientationZ=e(this,f,m.orientationZ,st,ct),this._positionX=e(this,f,m.positionX,st,ct),this._positionY=e(this,f,m.positionY,st,ct),this._positionZ=e(this,f,m.positionZ,st,ct),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(c){this._nativePannerNode.coneInnerAngle=c}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(c){this._nativePannerNode.coneOuterAngle=c}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(c){this._nativePannerNode.coneOuterGain=c}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(c){this._nativePannerNode.distanceModel=c}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(c){this._nativePannerNode.maxDistance=c}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(c){this._nativePannerNode.panningModel=c}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(c){this._nativePannerNode.refDistance=c}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(c){this._nativePannerNode.rolloffFactor=c}},sp=(n,e,t,s,i,a,o,l,c,u)=>()=>{const d=new WeakMap;let h=null;const m=async(f,p)=>{let g=null,v=a(f);const y={channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation},w={...y,coneInnerAngle:v.coneInnerAngle,coneOuterAngle:v.coneOuterAngle,coneOuterGain:v.coneOuterGain,distanceModel:v.distanceModel,maxDistance:v.maxDistance,panningModel:v.panningModel,refDistance:v.refDistance,rolloffFactor:v.rolloffFactor},N=et(v,p);if("bufferSize"in v)g=s(p,{...y,gain:1});else if(!N){const j={...w,orientationX:v.orientationX.value,orientationY:v.orientationY.value,orientationZ:v.orientationZ.value,positionX:v.positionX.value,positionY:v.positionY.value,positionZ:v.positionZ.value};v=i(p,j)}if(d.set(p,g===null?v:g),g!==null){if(h===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const P=new o(6,f.context.length,p.sampleRate),O=e(P,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});O.connect(P.destination),h=(async()=>{const U=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(E,I)=>{const F=t(P,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:I===0?1:0});return await l(P,E,F.offset),F}));for(let E=0;E<6;E+=1)U[E].connect(O,0,E),U[E].start(0);return u(P)})()}const j=await h,x=s(p,{...y,gain:1});await c(f,p,x);const k=[];for(let P=0;P<j.numberOfChannels;P+=1)k.push(j.getChannelData(P));let S=[k[0][0],k[1][0],k[2][0]],b=[k[3][0],k[4][0],k[5][0]],T=s(p,{...y,gain:1}),A=i(p,{...w,orientationX:S[0],orientationY:S[1],orientationZ:S[2],positionX:b[0],positionY:b[1],positionZ:b[2]});x.connect(T).connect(A.inputs[0]),A.connect(g);for(let P=128;P<j.length;P+=128){const O=[k[0][P],k[1][P],k[2][P]],U=[k[3][P],k[4][P],k[5][P]];if(O.some((E,I)=>E!==S[I])||U.some((E,I)=>E!==b[I])){S=O,b=U;const E=P/p.sampleRate;T.gain.setValueAtTime(0,E),T=s(p,{...y,gain:0}),A=i(p,{...w,orientationX:S[0],orientationY:S[1],orientationZ:S[2],positionX:b[0],positionY:b[1],positionZ:b[2]}),T.gain.setValueAtTime(1,E),x.connect(T).connect(A.inputs[0]),A.connect(g)}}return g}return N?(await n(p,f.orientationX,v.orientationX),await n(p,f.orientationY,v.orientationY),await n(p,f.orientationZ,v.orientationZ),await n(p,f.positionX,v.positionX),await n(p,f.positionY,v.positionY),await n(p,f.positionZ,v.positionZ)):(await l(p,f.orientationX,v.orientationX),await l(p,f.orientationY,v.orientationY),await l(p,f.orientationZ,v.orientationZ),await l(p,f.positionX,v.positionX),await l(p,f.positionY,v.positionY),await l(p,f.positionZ,v.positionZ)),Zn(v)?await c(f,p,v.inputs[0]):await c(f,p,v),v};return{render(f,p){const g=d.get(p);return g!==void 0?Promise.resolve(g):m(f,p)}}},rp={disableNormalization:!1},ip=(n,e,t,s)=>class Ro{constructor(a,o){const l=e(a),c=s({...rp,...o}),u=n(l,c);return t.add(u),u}static[Symbol.hasInstance](a){return a!==null&&typeof a=="object"&&Object.getPrototypeOf(a)===Ro.prototype||t.has(a)}},ap=(n,e)=>(t,s,i)=>(n(s).replay(i),e(s,t,i)),op=(n,e,t)=>async(s,i,a)=>{const o=n(s);await Promise.all(o.activeInputs.map((l,c)=>Array.from(l).map(async([u,d])=>{const m=await e(u).render(u,i),f=s.context.destination;!t(u)&&(s!==f||!t(s))&&m.connect(a,d,c)})).reduce((l,c)=>[...l,...c],[]))},cp=(n,e,t)=>async(s,i,a)=>{const o=e(s);await Promise.all(Array.from(o.activeInputs).map(async([l,c])=>{const d=await n(l).render(l,i);t(l)||d.connect(a,c)}))},lp=(n,e,t,s)=>i=>n(ds,()=>ds(i))?Promise.resolve(n(s,s)).then(a=>{if(!a){const o=t(i,512,0,1);i.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>i.currentTime,o.connect(i.destination)}return i.startRendering()}):new Promise(a=>{const o=e(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=l=>{o.disconnect(),a(l.renderedBuffer)},o.connect(i.destination),i.startRendering()}),up=n=>(e,t)=>{n.set(e,t)},dp=n=>(e,t)=>n.set(e,t),hp=(n,e,t,s,i,a,o,l)=>(c,u)=>t(c).render(c,u).then(()=>Promise.all(Array.from(s(u)).map(d=>t(d).render(d,u)))).then(()=>i(u)).then(d=>(typeof d.copyFromChannel!="function"?(o(d),Ni(d)):e(a,()=>a(d))||l(d),n.add(d),d)),mp={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},pp=(n,e,t,s,i,a)=>class extends n{constructor(l,c){const u=i(l),d={...mp,...c},h=t(u,d),m=a(u),f=m?s():null;super(l,!1,h,f),this._pan=e(this,m,h.pan)}get pan(){return this._pan}},fp=(n,e,t,s,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=et(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(c,h)}return a.set(c,u),d?await n(c,l.pan,u.pan):await s(c,l.pan,u.pan),Zn(u)?await i(l,c,u.inputs[0]):await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},gp=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},vp=(n,e)=>async()=>{if(n===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new e(1,128,44100),i=URL.createObjectURL(t);let a=!1,o=!1;try{await s.audioWorklet.addModule(i);const l=new n(s,"a",{numberOfOutputs:0}),c=s.createOscillator();l.port.onmessage=()=>a=!0,l.onprocessorerror=()=>o=!0,c.connect(l),c.start(0),await s.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(i)}return a&&!o},yp=(n,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{t.oncomplete=()=>{s.disconnect(),i(t.currentTime!==0)},t.startRendering()})},bp=()=>new DOMException("","UnknownError"),xp={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},_p=(n,e,t,s,i,a,o)=>class extends n{constructor(c,u){const d=i(c),h={...xp,...u},m=t(d,h),p=a(d)?s():null;super(c,!0,m,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=m,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(c){if(c===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(c.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=c}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(c){this._nativeWaveShaperNode.oversample=c}},wp=(n,e,t)=>()=>{const s=new WeakMap,i=async(a,o)=>{let l=e(a);if(!et(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,curve:l.curve,oversample:l.oversample};l=n(o,u)}return s.set(o,l),Zn(l)?await t(a,o,l.inputs[0]):await t(a,o,l),l};return{render(a,o){const l=s.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},Np=()=>typeof window>"u"?null:window,Sp=(n,e)=>t=>{t.copyFromChannel=(s,i,a=0)=>{const o=n(a),l=n(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=s.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)s[h]=u[h+o]},t.copyToChannel=(s,i,a=0)=>{const o=n(a),l=n(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=s.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)u[h+o]=s[h]}},kp=n=>e=>{e.copyFromChannel=(t=>(s,i,a=0)=>{const o=n(a),l=n(i);if(o<e.length)return t.call(e,s,l,o)})(e.copyFromChannel),e.copyToChannel=(t=>(s,i,a=0)=>{const o=n(a),l=n(i);if(o<e.length)return t.call(e,s,l,o)})(e.copyToChannel)},Tp=n=>(e,t)=>{const s=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=s),n(e,"buffer",i=>()=>{const a=i.call(e);return a===s?null:a},i=>a=>i.call(e,a===null?s:a))},jp=(n,e)=>(t,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const i=t.createBufferSource();e(s,()=>{const l=s.numberOfInputs;for(let c=0;c<l;c+=1)i.connect(s,0,c)},()=>i.disconnect(s))},Fo=(n,e,t)=>n.copyFromChannel===void 0?n.getChannelData(t)[0]:(n.copyFromChannel(e,t),e[0]),Lo=n=>{if(n===null)return!1;const e=n.length;return e%2!==0?n[Math.floor(e/2)]!==0:n[e/2-1]+n[e/2]!==0},Ts=(n,e,t,s)=>{let i=n;for(;!i.hasOwnProperty(e);)i=Object.getPrototypeOf(i);const{get:a,set:o}=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(n,e,{get:t(a),set:s(o)})},Cp=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),Ip=n=>({...n,channelCount:n.numberOfOutputs}),Ap=n=>{const{imag:e,real:t}=n;return e===void 0?t===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(t,()=>0),real:t}:t===void 0?{...n,imag:e,real:Array.from(e,()=>0)}:{...n,imag:e,real:t}},Vo=(n,e,t)=>{try{n.setValueAtTime(e,t)}catch(s){if(s.code!==9)throw s;Vo(n,e,t+1e-7)}},Mp=n=>{const e=n.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},Ep=n=>{const e=n.createBufferSource(),t=n.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},Pp=n=>{const e=n.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},Ci=n=>{const e=n.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},Uo=n=>{const e=n.createBuffer(1,1,44100),t=n.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Ii=n=>{const e=n.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},Op=n=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(n)}finally{e.close(),t.close()}},Dp=n=>{n.start=(e=>(t=0,s=0,i)=>{const a=n.buffer,o=a===null?s:Math.min(a.duration,s);a!==null&&o>a.duration-.5/n.context.sampleRate?e.call(n,t,0,0):e.call(n,t,o,i)})(n.start)},Bo=(n,e)=>{const t=e.createGain();n.connect(t);const s=(i=>()=>{i.call(n,t),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),Qn(n,t),n.stop=(i=>{let a=!1;return(o=0)=>{if(a)try{i.call(n,o)}catch{t.gain.setValueAtTime(0,o)}else i.call(n,o),a=!0}})(n.stop)},es=(n,e)=>t=>{const s={value:n};return Object.defineProperties(t,{currentTarget:s,target:s}),typeof e=="function"?e.call(n,t):e.handleEvent.call(n,t)},Rp=nd(Tn),Fp=cd(Tn),Lp=xh(pr),qo=new WeakMap,Vp=Lh(qo),kt=Jd(new Map,new WeakMap),Et=Np(),Wo=pm(kt,Ot),Ai=Fh(rt),He=op(rt,Ai,xn),Up=md(Wo,Te,He),Se=Bh(mr),Gt=Bm(Et),we=rm(Gt),$o=new WeakMap,Go=Ah(es),js=ym(Et),Mi=em(js),Ei=tm(Et),zo=nm(Et),hs=xm(Et),Oe=Ld(sd(bo),od(Rp,Fp,nr,Lp,sr,rt,Vp,xs,Te,Tn,Bt,xn,zs),kt,Xh(ai,sr,rt,Te,us,Bt),Ot,fr,it,gh(nr,ai,rt,Te,us,Se,Bt,we),Nh($o,rt,St),Go,Se,Mi,Ei,zo,we,hs),Bp=hd(Oe,Up,Ot,Wo,Se,we),Pi=new WeakSet,La=fm(Et),Yo=lh(new Uint32Array(1)),Oi=Sp(Yo,Ot),Di=kp(Yo),Ho=fd(Pi,kt,it,La,Gt,gp(La),Oi,Di),gr=ld(ut),Xo=cp(Ai,ws,xn),Dt=sh(Xo),ts=vm(gr,kt,Mp,Ep,Pp,Ci,Uo,Ii,Dp,Tp(Ts),Bo),Rt=ap(Vh(ws),Xo),qp=yd(Dt,ts,Te,Rt,He),Tt=Vd(rd(xo),$o,wi,Ud,Ju,Ku,Zu,Qu,ed,si,vo,js,Vo),Wp=vd(Oe,qp,Tt,ze,ts,Se,we,es),$p=jd(Oe,Cd,Ot,ze,bm(ut,Ts),Se,we,He),Gp=Xd(Dt,Oo,Te,Rt,He),jn=dp(qo),zp=Hd(Oe,Tt,Gp,fr,Oo,Se,we,jn),mn=hm(Tn,Ei),Yp=jp(ze,mn),pn=jm(js,Yp),Hp=Qd(pn,Te,He),Xp=Zd(Oe,Hp,pn,Se,we),Jp=nh(Ss,Te,He),Kp=th(Oe,Jp,Ss,Se,we,Ip),Zp=Am(gr,ts,ut,mn),ns=Im(gr,kt,Zp,Ci,Ii),Qp=ch(Dt,ns,Te,Rt,He),ef=oh(Oe,Tt,Qp,ns,Se,we,es),Jo=Mm(it,Ts),tf=hh(Jo,Te,He),nf=dh(Oe,tf,Jo,Se,we,jn),sf=bh(Dt,Do,Te,Rt,He),rf=yh(Oe,Tt,sf,Do,Se,we,jn),Ko=Em(it),af=jh(Dt,Ko,Te,Rt,He),of=Th(Oe,Tt,af,Ko,it,Se,we,jn),cf=Dh(Dt,ut,Te,Rt,He),lf=Oh(Oe,Tt,cf,ut,Se,we),uf=Rm(fr,ze,ks,it),vr=lp(kt,ut,ks,yp(ut,Gt)),df=Hh(ts,Te,Gt,He,vr),hf=Pm(uf),mf=zh(Oe,hf,df,Se,we,jn),pf=Id(Tt,pn,ns,ks,it,Fo,we,Ts),Zo=new WeakMap,ff=dm($p,pf,Go,we,Zo,es),Qo=qm(gr,kt,Ci,Uo,Ii,Bo),gf=ep(Dt,Qo,Te,Rt,He),vf=Qm(Oe,Tt,Qo,gf,Se,we,es),ec=ih(ts),yf=Xm(ec,ze,ut,Lo,mn),yr=Hm(ec,ze,yf,Lo,mn,js,Ts),bf=$m(nr,ze,pn,ut,ks,yr,it,sr,Fo,mn),tc=Wm(bf),xf=sp(Dt,pn,ns,ut,tc,Te,Gt,Rt,He,vr),_f=np(Oe,Tt,tc,xf,Se,we,jn),wf=Gm(Ot),Nf=ip(wf,Se,new WeakSet,Ap),Sf=Ym(pn,Ss,ut,yr,it,mn),nc=zm(Sf,it),kf=fp(Dt,nc,Te,Rt,He),Tf=pp(Oe,Tt,nc,kf,Se,we),jf=wp(yr,Te,He),Cf=_p(Oe,ze,yr,jf,Se,we,jn),sc=im(Et),Ri=Mh(Et),rc=new WeakMap,If=qh(rc,Gt),Af=sc?ad(kt,it,Ih(Et),Ri,Eh(td),Se,If,we,hs,new WeakMap,new WeakMap,vp(hs,Gt),Et):void 0,Mf=sm(Mi,we),Ef=fh(Pi,kt,ph,Ch,new WeakSet,Se,Mf,er,ds,Oi,Di),ic=zd(Af,Bp,Ho,Wp,zp,Xp,Kp,ef,nf,Ef,rf,of,lf,mf,ff,vf,_f,Nf,Tf,Cf),Pf=am(Oe,Fm,Se,we),Of=cm(Oe,Lm,Se,we),Df=lm(Oe,Vm,Se,we),Rf=Um(ze,we),Ff=um(Oe,Rf,Se),Lf=Td(ic,ze,it,bp,Pf,Of,Df,Ff,js),Fi=Wh(Zo),Vf=ud(Fi),ac=rh(Ot),Uf=_h(Fi),oc=Sh(Ot),cc=new WeakMap,Bf=Rh(cc,St),qf=Tm(ac,Ot,ze,pn,Ss,ns,ut,ks,it,oc,Ri,Bf,mn),Wf=wm(ze,qf,ut,it,mn),$f=Gd(Dt,ac,ts,pn,Ss,ns,ut,Uf,oc,Ri,Te,hs,Gt,Rt,He,vr),Gf=Uh(rc),zf=up(cc),Va=sc?qd(Vf,Oe,Tt,$f,Wf,rt,Gf,Se,we,hs,Cp,zf,Op,es):void 0,Yf=mh(it,Gt),Hf=hp(Pi,kt,Ai,Fi,vr,er,Oi,Di),Xf=Km(ic,kt,ze,Yf,Hf),Jf=Jh(mr,Mi),Kf=Kh(_i,Ei),Zf=Zh(wi,zo),Qf=Qh(mr,we);function ft(n){return n===void 0}function he(n){return n!==void 0}function eg(n){return typeof n=="function"}function Pt(n){return typeof n=="number"}function Qt(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function lc(n){return typeof n=="boolean"}function lt(n){return Array.isArray(n)}function Wt(n){return typeof n=="string"}function Ls(n){return Wt(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function ae(n,e){if(!n)throw new Error(e)}function nn(n,e,t=1/0){if(!(e<=n&&n<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${n}`)}function uc(n){!n.isOffline&&n.state!=="running"&&br('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let dc=!1,Ua=!1;function Ba(n){dc=n}function tg(n){ft(n)&&dc&&!Ua&&(Ua=!0,br("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let hc=console;function ng(...n){hc.log(...n)}function br(...n){hc.warn(...n)}function sg(n){return new Lf(n)}function rg(n,e,t){return new Xf(n,e,t)}const ht=typeof self=="object"?self:null,ig=ht&&(ht.hasOwnProperty("AudioContext")||ht.hasOwnProperty("webkitAudioContext"));function ag(n,e,t){return ae(he(Va),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof ht?.BaseAudioContext?ht?.AudioWorkletNode:Va)(n,e,t)}function jt(n,e,t,s){var i=arguments.length,a=i<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(n,e,t,s);else for(var l=n.length-1;l>=0;l--)(o=n[l])&&(a=(i<3?o(a):i>3?o(e,t,a):o(e,t))||a);return i>3&&a&&Object.defineProperty(e,t,a),a}function Le(n,e,t,s){function i(a){return a instanceof t?a:new t(function(o){o(a)})}return new(t||(t=Promise))(function(a,o){function l(d){try{u(s.next(d))}catch(h){o(h)}}function c(d){try{u(s.throw(d))}catch(h){o(h)}}function u(d){d.done?a(d.value):i(d.value).then(l,c)}u((s=s.apply(n,e||[])).next())})}class og{constructor(e,t,s,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),s=new Worker(t);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function _n(n){return Zf(n)}function en(n){return Kf(n)}function Ys(n){return Qf(n)}function On(n){return Jf(n)}function cg(n){return n instanceof Ho}function lg(n,e){return n==="value"||_n(e)||en(e)||cg(e)}function yn(n,...e){if(!e.length)return n;const t=e.shift();if(Qt(n)&&Qt(t))for(const s in t)lg(s,t[s])?n[s]=t[s]:Qt(t[s])?(n[s]||Object.assign(n,{[s]:{}}),yn(n[s],t[s])):Object.assign(n,{[s]:t[s]});return yn(n,...e)}function ug(n,e){return n.length===e.length&&n.every((t,s)=>e[s]===t)}function oe(n,e,t=[],s){const i={},a=Array.from(e);if(Qt(a[0])&&s&&!Reflect.has(a[0],s)&&(Object.keys(a[0]).some(l=>Reflect.has(n,l))||(yn(i,{[s]:a[0]}),t.splice(t.indexOf(s),1),a.shift())),a.length===1&&Qt(a[0]))yn(i,a[0]);else for(let o=0;o<t.length;o++)he(a[o])&&(i[t[o]]=a[o]);return yn(n,i)}function dg(n){return n.constructor.getDefaults()}function Mt(n,e){return ft(n)?e:n}function di(n,e){return e.forEach(t=>{Reflect.has(n,t)&&delete n[t]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class zt{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||ht&&this.toString()===ht.TONE_DEBUG_CLASS)&&ng(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}zt.version=go;const Li=1e-6;function Gn(n,e){return n>e+Li}function hi(n,e){return Gn(n,e)||xt(n,e)}function or(n,e){return n+Li<e}function xt(n,e){return Math.abs(n-e)<Li}function hg(n,e,t){return Math.max(Math.min(n,t),e)}class vt extends zt{constructor(){super(),this.name="Timeline",this._timeline=[];const e=oe(vt.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(ae(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];ae(hi(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const s=this._search(e,t);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const s=this._search(e,t);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const s=this._search(e);return s-1>=0?this._timeline[s-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(xt(this._timeline[t].time,e)){for(let s=t;s>=0&&xt(this._timeline[s].time,e);s--)t=s;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&hi(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let s=0;const i=this._timeline.length;let a=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;s<a;){let o=Math.floor(s+(a-s)/2);const l=this._timeline[o],c=this._timeline[o+1];if(xt(l[t],e)){for(let u=o;u<this._timeline.length;u++){const d=this._timeline[u];if(xt(d[t],e))o=u;else break}return o}else{if(or(l[t],e)&&Gn(c[t],e))return o;Gn(l[t],e)?a=o:s=o+1}}return-1}_iterate(e,t=0,s=this._timeline.length-1){this._timeline.slice(t,s+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const s=this._search(e);return s!==-1&&this._iterate(t,0,s),this}forEachAfter(e,t){const s=this._search(e);return this._iterate(t,s+1),this}forEachBetween(e,t,s){let i=this._search(e),a=this._search(t);return i!==-1&&a!==-1?(this._timeline[i].time!==e&&(i+=1),this._timeline[a].time===t&&(a-=1),this._iterate(s,i,a)):i===-1&&this._iterate(s,0,a),this}forEachFrom(e,t){let s=this._search(e);for(;s>=0&&this._timeline[s].time>=e;)s--;return this._iterate(t,s+1),this}forEachAtTime(e,t){const s=this._search(e);if(s!==-1&&xt(this._timeline[s].time,e)){let i=s;for(let a=s;a>=0&&xt(this._timeline[a].time,e);a--)i=a;this._iterate(a=>{t(a)},i,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const mc=[];function xr(n){mc.push(n)}function mg(n){mc.forEach(e=>e(n))}const pc=[];function _r(n){pc.push(n)}function pg(n){pc.forEach(e=>e(n))}class Cs extends zt{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(i=>{ft(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(t)}),this}once(e,t){const s=(...i)=>{t(...i),this.off(e,s)};return this.on(e,s),this}off(e,t){return e.split(/\W+/).forEach(i=>{if(ft(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(ft(t))this._events[i]=[];else{const a=this._events[i];for(let o=a.length-1;o>=0;o--)a[o]===t&&a.splice(o,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const s=this._events[e].slice(0);for(let i=0,a=s.length;i<a;i++)s[i].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const s=Object.getOwnPropertyDescriptor(Cs.prototype,t);Object.defineProperty(e.prototype,t,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class fc extends Cs{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Is extends fc{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new vt,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=oe(Is.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=sg({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new og(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(mg(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,s){return this._context.createBuffer(e,t,s)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,s){return this._context.createPeriodicWave(e,t,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return ae(On(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return ae(On(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return ae(On(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){ae(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){ae(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){ae(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){ae(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return ag(this.rawContext,e,t)}addAudioWorkletModule(e){return Le(this,void 0,void 0,function*(){ae(he(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return Le(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return On(this._context)?this._context.resume():Promise.resolve()}close(){return Le(this,void 0,void 0,function*(){On(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&pg(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),s=t.getChannelData(0);for(let a=0;a<s.length;a++)s[a]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:s+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const s=++this._timeoutIds,i=()=>{const a=this.now();this._timeouts.add({callback:()=>{e(),i()},id:s,time:a+t})};return i(),s}}class fg extends fc{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,s){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return Le(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function Ee(n,e){lt(e)?e.forEach(t=>Ee(n,t)):Object.defineProperty(n,e,{enumerable:!0,writable:!1})}function gc(n,e){lt(e)?e.forEach(t=>gc(n,t)):Object.defineProperty(n,e,{writable:!0})}const be=()=>{};class je extends zt{constructor(){super(),this.name="ToneAudioBuffer",this.onload=be;const e=oe(je.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,Wt(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:be,onload:be,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:mt().sampleRate}set(e){return e instanceof je?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return Le(this,void 0,void 0,function*(){const t=je.load(e).then(s=>{this.set(s),this.onload(this)});je.downloads.push(t);try{yield t}finally{const s=je.downloads.indexOf(t);je.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=lt(e)&&e[0].length>0,s=t?e.length:1,i=t?e[0].length:e.length,a=mt(),o=a.createBuffer(s,i,a.sampleRate),l=!t&&s===1?[e]:e;for(let c=0;c<s;c++)o.copyToChannel(l[c],c);return this._buffer=o,this}toMono(e){if(Pt(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const s=this.numberOfChannels;for(let i=0;i<s;i++){const a=this.toArray(i);for(let o=0;o<a.length;o++)t[o]+=a[o]}t=t.map(i=>i/s),this.fromArray(t)}return this}toArray(e){if(Pt(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let s=0;s<this.numberOfChannels;s++)t[s]=this.getChannelData(s);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){ae(this.loaded,"Buffer is not loaded");const s=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);ae(s<i,"The start time must be less than the end time");const a=i-s,o=mt().createBuffer(this.numberOfChannels,a,this.sampleRate);for(let l=0;l<this.numberOfChannels;l++)o.copyToChannel(this.getChannelData(l).subarray(s,i),l);return new je(o)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new je().fromArray(e)}static fromUrl(e){return Le(this,void 0,void 0,function*(){return yield new je().load(e)})}static load(e){return Le(this,void 0,void 0,function*(){const t=je.baseUrl===""||je.baseUrl.endsWith("/")?je.baseUrl:je.baseUrl+"/",s=yield fetch(t+e);if(!s.ok)throw new Error(`could not load url: ${e}`);const i=yield s.arrayBuffer();return yield mt().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),s=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return Le(this,void 0,void 0,function*(){for(yield Promise.resolve();je.downloads.length;)yield je.downloads[0]})}}je.baseUrl="";je.downloads=[];class Vi extends Is{constructor(){super({clockSource:"offline",context:Ys(arguments[0])?arguments[0]:rg(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:Ys(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Ys(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return Le(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const s=Math.floor(this.sampleRate/128);e&&t%s===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return Le(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new je(t)})}close(){return Promise.resolve()}}const vc=new fg;let gn=vc;function mt(){return gn===vc&&ig&&gg(new Is),gn}function gg(n,e=!1){e&&gn.dispose(),On(n)?gn=new Is(n):Ys(n)?gn=new Vi(n):gn=n}function mi(){return gn.resume()}if(ht&&!ht.TONE_SILENCE_LOGGING){const e=` * Tone.js v${go} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function vg(n){return Math.pow(10,n/20)}function yg(n){return 20*(Math.log(n)/Math.LN10)}function yc(n){return Math.pow(2,n/12)}let wr=440;function bg(){return wr}function xg(n){wr=n}function vn(n){return Math.round(bc(n))}function bc(n){return 69+12*Math.log2(n/wr)}function xc(n){return wr*Math.pow(2,(n-69)/12)}class Ui extends zt{constructor(e,t,s){super(),this.defaultUnits="s",this._val=t,this._units=s,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const s=parseInt(e,10),i=t==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/s)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,s)=>{let i=0;return e&&e!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i+=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i+=this._beatsToUnits(parseFloat(s)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Ui&&this.fromType(this._val),ft(this._val))return this._noArg();if(Wt(this._val)&&ft(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(Qt(this._val)){let e=0;for(const t in this._val)if(he(this._val[t])){const s=this._val[t],i=new this.constructor(this.context,t).valueOf()*s;e+=i}return e}if(he(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return Wt(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class _t extends Ui{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new _t(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const s=new this.constructor(this.context,e).valueOf(),i=this.valueOf(),l=Math.round(i/s)*s-i;return i+l*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let a=1;a<9;a++){const o=Math.pow(2,a);t.push(o+"n."),t.push(o+"n"),t.push(o+"t")}t.push("0");let s=t[0],i=new _t(this.context,t[0]).toSeconds();return t.forEach(a=>{const o=new _t(this.context,a).toSeconds();Math.abs(o-e)<Math.abs(i-e)&&(s=a,i=o)}),s}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const s=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const a=i.toString();return a.length>3&&(i=parseFloat(parseFloat(a).toFixed(3))),[s,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return vn(this.toFrequency())}_now(){return this.context.now()}}class pt extends _t{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return bg()}static set A4(e){xg(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:pt.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const i=_g[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?i:pt.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,s){let i=1;return e&&e!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i*=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i*=this._beatsToUnits(parseFloat(s)/4)),i}}})}transpose(e){return new pt(this.context,this.valueOf()*yc(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return vn(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/pt.A4);let s=Math.round(12*t)+57;const i=Math.floor(s/12);return i<0&&(s+=-12*i),wg[s%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return xc(e)}static ftom(e){return vn(e)}}const _g={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},wg=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class qn extends _t{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Ze extends zt{constructor(){super();const e=oe(Ze.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:mt()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return tg(e),new _t(this.context,e).toSeconds()}toFrequency(e){return new pt(this.context,e).toFrequency()}toTicks(e){return new qn(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(s=>{ft(e[s])&&delete t[s]}),t}get(){const e=dg(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const s=this[t];he(s)&&he(s.value)&&he(s.setValueAtTime)?e[t]=s.value:s instanceof Ze?e[t]=s._getPartialProperties(e[t]):lt(s)||Pt(s)||Wt(s)||lc(s)?e[t]=s:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&he(this[t])&&(this[t]&&he(this[t].value)&&he(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Ze?this[t].set(e[t]):this[t]=e[t])}),this}}class As extends vt{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,s){return nn(t,0),this.add(Object.assign({},s,{state:e,time:t})),this}getLastState(e,t){const s=this._search(t);for(let i=s;i>=0;i--){const a=this._timeline[i];if(a.state===e)return a}}getNextState(e,t){const s=this._search(t);if(s!==-1)for(let i=s;i<this._timeline.length;i++){const a=this._timeline[i];if(a.state===e)return a}}}class Ae extends Ze{constructor(){const e=oe(Ae.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,ae(he(e.param)&&(_n(e.param)||e.param instanceof Ae),"param must be an AudioParam");!_n(e.param);)e.param=e.param._param;this._swappable=he(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new vt(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,he(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Ze.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return he(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return he(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return he(this.maxValue)&&he(this.minValue)&&nn(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?vg(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?yg(e):e}setValueAtTime(e,t){const s=this.toSeconds(t),i=this._fromType(e);return ae(isFinite(i)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,s),this._events.add({time:s,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,s),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),s=this._events.getAfter(t),i=this._events.get(t);let a=this._initialValue;if(i===null)a=this._initialValue;else if(i.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const o=this._events.getBefore(i.time);let l;o===null?l=this._initialValue:l=o.value,i.type==="setTargetAtTime"&&(a=this._exponentialApproach(i.time,l,i.value,i.constant,t))}else if(s===null)a=i.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let o=i.value;if(i.type==="setTargetAtTime"){const l=this._events.getBefore(i.time);l===null?o=this._initialValue:o=l.value}s.type==="linearRampToValueAtTime"?a=this._linearInterpolate(i.time,o,s.time,s.value,t):a=this._exponentialInterpolate(i.time,o,s.time,s.value,t)}else a=i.value;return this._toType(a)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const s=this._fromType(e),i=this.toSeconds(t);return ae(isFinite(s)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this._events.add({time:i,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(s,i),this}exponentialRampToValueAtTime(e,t){let s=this._fromType(e);s=xt(s,0)?this._minOutput:s,this._assertRange(s);const i=this.toSeconds(t);return ae(isFinite(s)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(s,i),this}exponentialRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(e,s+this.toSeconds(t)),this}linearRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(e,s+this.toSeconds(t)),this}targetRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(e,s,t),this}exponentialApproachValueAtTime(e,t,s){t=this.toSeconds(t),s=this.toSeconds(s);const i=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+s*.9),this.linearRampToValueAtTime(e,t+s),this}setTargetAtTime(e,t,s){const i=this._fromType(e);ae(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const a=this.toSeconds(t);return this._assertRange(i),ae(isFinite(i)&&isFinite(a),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:s,time:a,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,a,s),this._param.setTargetAtTime(i,a,s),this}setValueCurveAtTime(e,t,s,i=1){s=this.toSeconds(s),t=this.toSeconds(t);const a=this._fromType(e[0])*i;this.setValueAtTime(this._toType(a),t);const o=s/(e.length-1);for(let l=1;l<e.length;l++){const c=this._fromType(e[l])*i;this.linearRampToValueAtTime(this._toType(c),t+l*o)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return ae(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),s=this._fromType(this.getValueAtTime(t));ae(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+s);const i=this._events.get(t),a=this._events.getAfter(t);return i&&xt(i.time,t)?a?(this._param.cancelScheduledValues(a.time),this._events.cancel(a.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):a&&(this._param.cancelScheduledValues(a.time),this._events.cancel(a.time),a.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),t):a.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),t)),this._events.add({time:t,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,t),this}rampTo(e,t=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,s):this.linearRampTo(e,t,s),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const s=this._events.get(t);if(s&&s.type==="setTargetAtTime"){const i=this._events.getAfter(s.time),a=i?i.time:t+2,o=(a-t)/10;for(let l=t;l<a;l+=o)e.linearRampToValueAtTime(this.getValueAtTime(l),l)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?e.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?e.setTargetAtTime(i.value,i.time,i.constant):e[i.type](i.value,i.time)}),this}setParam(e){ae(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,s,i,a){return s+(t-s)*Math.exp(-(a-e)/i)}_linearInterpolate(e,t,s,i,a){return t+(i-t)*((a-e)/(s-e))}_exponentialInterpolate(e,t,s,i,a){return t*Math.pow(i/t,(a-e)/(s-e))}}class me extends Ze{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return he(this.input)?_n(this.input)||this.input instanceof Ae?1:this.input.numberOfInputs:0}get numberOfOutputs(){return he(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return he(e)&&(e instanceof me||en(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(s=>{s.channelCount=e.channelCount,s.channelCountMode=e.channelCountMode,s.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();ae(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,s=0){return ss(this,e,t,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return br("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,s=0){return Ng(this,e,t,s),this}chain(...e){return pi(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),he(this.input)&&(this.input instanceof me?this.input.dispose():en(this.input)&&this.input.disconnect()),he(this.output)&&(this.output instanceof me?this.output.dispose():en(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function pi(...n){const e=n.shift();n.reduce((t,s)=>(t instanceof me?t.connect(s):en(t)&&ss(t,s),s),e)}function ss(n,e,t=0,s=0){for(ae(he(n),"Cannot connect from undefined node"),ae(he(e),"Cannot connect to undefined node"),(e instanceof me||en(e))&&ae(e.numberOfInputs>0,"Cannot connect to node with no inputs"),ae(n.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof me||e instanceof Ae;)he(e.input)&&(e=e.input);for(;n instanceof me;)he(n.output)&&(n=n.output);_n(e)?n.connect(e,t):n.connect(e,t,s)}function Ng(n,e,t=0,s=0){if(he(e))for(;e instanceof me;)e=e.input;for(;!en(n);)he(n.output)&&(n=n.output);_n(e)?n.disconnect(e,t):en(e)?n.disconnect(e,t,s):n.disconnect()}class Qe extends me{constructor(){const e=oe(Qe.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Ae({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),Ee(this,"gain")}static getDefaults(){return Object.assign(me.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class zn extends me{constructor(e){super(e),this.onended=be,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Qe({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const s=this.toSeconds(t);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(me.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:be})}_startGain(e,t=1){ae(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=e+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+s):this._gainNode.gain.exponentialApproachValueAtTime(t,e,s)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){ae(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==be&&(this.onended(this),this.onended=be,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),ae(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=be,this}}class Bi extends zn{constructor(){const e=oe(Bi.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),ss(this._source,this._gainNode),this.offset=new Ae({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(zn.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Ye extends me{constructor(){const e=oe(Ye.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Bi({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(me.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,s=0){return qi(this,e,t,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,s){return this._param.exponentialRampTo(e,t,s),this}linearRampTo(e,t,s){return this._param.linearRampTo(e,t,s),this}targetRampTo(e,t,s){return this._param.targetRampTo(e,t,s),this}exponentialApproachValueAtTime(e,t,s){return this._param.exponentialApproachValueAtTime(e,t,s),this}setTargetAtTime(e,t,s){return this._param.setTargetAtTime(e,t,s),this}setValueCurveAtTime(e,t,s,i){return this._param.setValueCurveAtTime(e,t,s,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,s){return this._param.rampTo(e,t,s),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function qi(n,e,t,s){(e instanceof Ae||_n(e)||e instanceof Ye&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof Ye&&(e.overridden=!0)),ss(n,e,t,s)}class Wi extends Ae{constructor(){const e=oe(Wi.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new vt(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Ae.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,s){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),a=this._events.get(t),o=Math.round(Math.max(1/s,1));for(let l=0;l<=o;l++){const c=s*l+t,u=this._exponentialApproach(a.time,a.value,i,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}setValueAtTime(e,t){const s=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(s),a=this._events.previousEvent(i),o=this._getTicksUntilEvent(a,s);return i.ticks=Math.max(o,0),this}linearRampToValueAtTime(e,t){const s=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(s),a=this._events.previousEvent(i),o=this._getTicksUntilEvent(a,s);return i.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const s=this._fromType(e),i=this._events.get(t),a=Math.round(Math.max((t-i.time)*10,1)),o=(t-i.time)/a;for(let l=0;l<=a;l++){const c=o*l+i.time,u=this._exponentialInterpolate(i.time,i.value,t,s,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(ft(e.ticks)){const o=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(o,e.time)}const s=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const a=this._events.get(t);return a&&a.time===t&&a.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(s+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),s=this._events.get(t);return Math.max(this._getTicksUntilEvent(s,t),0)}getDurationOfTicks(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-s}getTimeOfTick(e){const t=this._events.get(e,"ticks"),s=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&s&&s.type==="linearRampToValueAtTime"&&t.value!==s.value){const i=this._fromType(this.getValueAtTime(t.time)),o=(this._fromType(this.getValueAtTime(s.time))-i)/(s.time-t.time),l=Math.sqrt(Math.pow(i,2)-2*o*(t.ticks-e)),c=(-i+l)/o,u=(-i-l)/o;return(c>0?c:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const s=this.toSeconds(t),i=this.toSeconds(e),a=this.getTicksAtTime(s);return this.getTicksAtTime(s+i)-a}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class $i extends Ye{constructor(){const e=oe($i.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Wi({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(Ye.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class Gi extends Ze{constructor(){const e=oe(Gi.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new As,this._tickOffset=new vt,this._ticksAtTime=new vt,this._secondsAtTime=new vt,this.frequency=new $i({context:this.context,units:e.units,value:e.frequency}),Ee(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Ze.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const s=this.toSeconds(e);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),he(t)&&this.setTicksAtTime(t,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const s=this._state.get(t);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),s=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),a={state:"paused",time:t};this._state.add(a);let o=i||s,l=i?i.ticks:0,c=null;return this._state.forEachBetween(o.time,t+this.sampleTime,u=>{let d=o.time;const h=this._tickOffset.get(u.time);h&&h.time>=o.time&&(l=h.ticks,d=h.time),o.state==="started"&&u.state!=="started"&&(l+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(d),u.time!==a.time&&(c={state:u.state,time:u.time,ticks:l})),o=u}),this._state.remove(a),c&&this._ticksAtTime.add(c),l}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),s=this.frequency.timeToTicks(e,t);this.setTicksAtTime(s,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),s={state:"paused",time:e};this._state.add(s);const i=this._secondsAtTime.get(e);let a=i||t,o=i?i.seconds:0,l=null;return this._state.forEachBetween(a.time,e+this.sampleTime,c=>{let u=a.time;const d=this._tickOffset.get(c.time);d&&d.time>=a.time&&(o=d.seconds,u=d.time),a.state==="started"&&c.state!=="started"&&(o+=c.time-u,c.time!==s.time&&(l={state:c.state,time:c.time,seconds:o})),a=c}),this._state.remove(s),l&&this._secondsAtTime.add(l),o}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const s=this._tickOffset.get(t),i=this._state.get(t),a=Math.max(s.time,i.time),o=this.frequency.getTicksAtTime(a)+e-s.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(e,t,s){let i=this._state.get(e);this._state.forEachBetween(e,t,o=>{i&&i.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(i.time,e),o.time-this.sampleTime,s),i=o});let a=null;if(i&&i.state==="started"){const o=Math.max(i.time,e),l=this.frequency.getTicksAtTime(o),c=this.frequency.getTicksAtTime(i.time),u=l-c;let d=Math.ceil(u)-u;d=xt(d,1)?0:d;let h=this.frequency.getTimeOfTick(l+d);for(;h<t;){try{s(h,Math.round(this.getTicksAtTime(h)))}catch(m){a=m;break}h+=this.frequency.getDurationOfTicks(1,h)}}if(a)throw a;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class Nr extends Ze{constructor(){const e=oe(Nr.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=be,this._lastUpdate=0,this._state=new As("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new Gi({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Ee(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Ze.getDefaults(),{callback:be,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){uc(this.context);const s=this.toSeconds(e);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,t),s<this._lastUpdate&&this.emit("start",s,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(i+e,s)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,s=>{switch(s.state){case"started":const i=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,i);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(e,t,(s,i)=>{this.callback(s,i)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Cs.mixin(Nr);class rs extends me{constructor(){const e=oe(rs.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new Qe({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,Ee(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(me.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class zi extends me{constructor(){const e=oe(zi.getDefaults(),arguments);super(e),this.name="Destination",this.input=new rs({context:this.context}),this.output=new Qe({context:this.context}),this.volume=this.input.volume,pi(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(me.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),pi(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}xr(n=>{n.destination=new zi({context:n})});_r(n=>{n.destination.dispose()});class Sg extends me{constructor(){super(...arguments),this.name="Listener",this.positionX=new Ae({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Ae({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Ae({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Ae({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Ae({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Ae({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Ae({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Ae({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Ae({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(me.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}xr(n=>{n.listener=new Sg({context:n})});_r(n=>{n.listener.dispose()});class Yi extends zt{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=oe(Yi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const s=e.urls[t];this.add(t,s,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:be,onload:be,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return ae(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,s=be,i=be){return Wt(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new je(this.baseUrl+t,s,i))):this._buffers.set(e.toString(),new je(t,s,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class cr extends pt{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return vn(super._frequencyToUnits(e))}_ticksToUnits(e){return vn(super._ticksToUnits(e))}_beatsToUnits(e){return vn(super._beatsToUnits(e))}_secondsToUnits(e){return vn(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return xc(this.toMidi())}transpose(e){return new cr(this.context,this.toMidi()+e)}}class qe extends qn{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class kg extends Ze{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new vt,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}xr(n=>{n.draw=new kg({context:n})});_r(n=>{n.draw.dispose()});class Tg extends zt{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){ae(he(e.time),"Events must have a time property"),ae(he(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new jg(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const s of t)if(s.event===e){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let s,i=null;if(t>0)if(e.left.right===null)s=e.left,s.right=e.right,i=s;else{for(s=e.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,i=s.parent,s.left=e.left,s.right=e.right)}else if(e.right.left===null)s=e.right,s.left=e.left,i=s;else{for(s=e.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,i=s.parent,s.left=e.left,s.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=s:e.parent.right=s:this._setRoot(s),i&&this._rebalance(i)}e.dispose()}_rotateLeft(e){const t=e.parent,s=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,s=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let s=t[0];for(let i=1;i<t.length;i++)t[i].low>s.low&&(s=t[i]);return s.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(s=>t.push(s)),t.forEach(s=>{s.event&&e(s.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const s=[];this._root.search(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}forEachFrom(e,t){if(this._root!==null){const s=[];this._root.searchAfter(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class jg{constructor(e,t,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class Cg extends zt{constructor(e){super(),this.name="TimelineValue",this._timeline=new vt({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class Yn extends me{constructor(){super(oe(Yn.getDefaults(),arguments,["context"]))}connect(e,t=0,s=0){return qi(this,e,t,s),this}}class Ms extends Yn{constructor(){const e=oe(Ms.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,lt(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):eg(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(Ye.getDefaults(),{length:1024})}setMap(e,t=1024){const s=new Float32Array(t);for(let i=0,a=t;i<a;i++){const o=i/(a-1)*2-1;s[i]=e(o,i)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(s=>s.includes(e));ae(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Hi extends Yn{constructor(){const e=oe(Hi.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new Ms({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(Yn.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class sn{constructor(e,t){this.id=sn._eventId++,this._remainderTime=0;const s=Object.assign(sn.getDefaults(),t);this.transport=e,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:be,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}sn._eventId=0;class Xi extends sn{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(Xi.getDefaults(),t);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},sn.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return or(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new qe(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){or(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new qe(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);Gn(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Sr extends Ze{constructor(){const e=oe(Sr.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new Cg(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new vt,this._repeatedEvents=new Tg,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new Nr({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),Ee(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Ze.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const s=t%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(s*Math.PI)*this._swingAmount;e+=new qe(this.context,this._swingTicks*2/3).toSeconds()*i}Ba(!0),this._timeline.forEachAtTime(t,s=>s.invoke(e)),Ba(!1)}schedule(e,t){const s=new sn(this,{callback:e,time:new qn(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(e,t,s,i=1/0){const a=new Xi(this,{callback:e,duration:new _t(this.context,i).toTicks(),interval:new _t(this.context,t).toTicks(),time:new qn(this.context,s).toTicks()});return this._addEvent(a,this._repeatedEvents)}scheduleOnce(e,t){const s=new sn(this,{callback:e,once:!0,time:new qn(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(t,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new qe(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let s;return he(t)&&(s=this.toTicks(t)),this._clock.start(e,s),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){lt(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new _t(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new _t(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new qe(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new qe(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),s=this._clock.frequency.timeToTicks(e,t);this.ticks=s}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(t),i=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,t),a=t+i;this.emit("stop",a),this._clock.setTicksAtTime(e,a),this.emit("start",a,this._clock.getSecondsAtTime(a))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),s=this.getTicksAtTime(t),i=e-s%e;return this._clock.nextTickTime(i,t)}}syncSignal(e,t){const s=this.now();let i=this.bpm,a=1/(60/i.getValueAtTime(s)/this.PPQ),o=[];if(e.units==="time"){const c=.015625/a,u=new Qe(c),d=new Hi(-1),h=new Qe(c);i.chain(u,d,h),i=h,a=1/a,o=[u,d,h]}t||(e.getValueAtTime(s)!==0?t=e.getValueAtTime(s)/a:t=0);const l=new Qe(t);return i.connect(l),l.connect(e._param),o.push(l),this._syncedSignals.push({initial:e.value,nodes:o,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const s=this._syncedSignals[t];s.signal===e&&(s.nodes.forEach(i=>i.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),gc(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Cs.mixin(Sr);xr(n=>{n.transport=new Sr({context:n})});_r(n=>{n.transport.dispose()});class gt extends me{constructor(e){super(e),this.input=void 0,this._state=new As("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=be,this._syncedStop=be,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new rs({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,Ee(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(me.getDefaults(),{mute:!1,onstop:be,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,s){let i=ft(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")ae(Gn(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,s);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const a=this._state.get(i);a&&(a.offset=this.toSeconds(Mt(t,0)),a.duration=s?this.toSeconds(s):void 0);const o=this.context.transport.schedule(l=>{this._start(l,t,s)},i);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else uc(this.context),this._start(i,t,s);return this}stop(e){let t=ft(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||he(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const s=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(s)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,s){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(Gn(t,0)){const s=this._state.get(t);if(s&&s.state==="started"&&s.time!==t){const i=t-this.toSeconds(s.time);let a;s.duration&&(a=this.toSeconds(s.duration)-i),this._start(e,this.toSeconds(s.offset)+i,a)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=be,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class kr extends zn{constructor(){const e=oe(kr.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,ss(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Ae({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new je(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(zn.getDefaults(),{url:new je,loop:!1,loopEnd:0,loopStart:0,onload:be,onerror:be,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,s,i=1){ae(this.buffer.loaded,"buffer is either not set or not loaded");const a=this.toSeconds(e);this._startGain(a,i),this.loop?t=Mt(t,this.loopStart):t=Mt(t,0);let o=Math.max(this.toSeconds(t),0);if(this.loop){const l=this.toSeconds(this.loopEnd)||this.buffer.duration,c=this.toSeconds(this.loopStart),u=l-c;hi(o,l)&&(o=(o-c)%u+c),xt(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,or(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(a,o)),he(s)){let l=this.toSeconds(s);l=Math.max(l,0),this.stop(a+l)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function Cn(n,e){return Le(this,void 0,void 0,function*(){const t=e/n.context.sampleRate,s=new Vi(1,t,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/t,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class Ji extends zn{constructor(){const e=oe(Ji.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],ss(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new Ae({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new Ae({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),Ee(this,["frequency","detune"])}static getDefaults(){return Object.assign(zn.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Fe extends gt{constructor(){const e=oe(Fe.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new Ye({context:this.context,units:"frequency",value:e.frequency}),Ee(this,"frequency"),this.detune=new Ye({context:this.context,units:"cents",value:e.detune}),Ee(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),s=new Ji({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Fe._periodicWaveCache.find(t=>t.phase===this._phase&&ug(t.partials,this._partials));{const e=Fe._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const s=this._getCachedPeriodicWave();if(he(s)){const{partials:i,wave:a}=s;this._wave=a,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,a]=this._getRealImaginary(e,this._phase),o=this.context.createPeriodicWave(i,a);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Fe._periodicWaveCache.push({imag:a,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),Fe._periodicWaveCache.length>100&&Fe._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){nn(e,0);let t=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(t=s[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const i=new Float32Array(e);this._partials.forEach((a,o)=>i[o]=a),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(e,t){let i=2048;const a=new Float32Array(i),o=new Float32Array(i);let l=1;if(e==="custom"){if(l=this._partials.length+1,this._partialCount=this._partials.length,i=l,this._partials.length===0)return[a,o]}else{const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);c?(l=parseInt(c[2],10)+1,this._partialCount=parseInt(c[2],10),e=c[1],l=Math.max(l,2),i=l):this._partialCount=0,this._partials=[]}for(let c=1;c<i;++c){const u=2/(c*Math.PI);let d;switch(e){case"sine":d=c<=l?1:0,this._partials[c-1]=d;break;case"square":d=c&1?2*u:0,this._partials[c-1]=d;break;case"sawtooth":d=u*(c&1?1:-1),this._partials[c-1]=d;break;case"triangle":c&1?d=2*(u*u)*(c-1>>1&1?-1:1):d=0,this._partials[c-1]=d;break;case"custom":d=this._partials[c-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}d!==0?(a[c]=-d*Math.sin(t*c),o[c]=d*Math.cos(t*c)):(a[c]=0,o[c]=0)}return[a,o]}_inverseFFT(e,t,s){let i=0;const a=e.length;for(let o=0;o<a;o++)i+=e[o]*Math.cos(o*s)+t[o]*Math.sin(o*s);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let s=0;const i=Math.PI*2,a=32;for(let o=0;o<a;o++)s=Math.max(this._inverseFFT(e,t,o/a*i),s);return hg(-this._inverseFFT(e,t,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Fe._periodicWaveCache=[];class Ig extends Yn{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Ms({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Hn extends Ye{constructor(){const e=oe(Hn.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Qe({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Ye.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Tr extends gt{constructor(){const e=oe(Tr.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new Ig({context:this.context}),this._modulationNode=new Qe({context:this.context}),this._carrier=new Fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Fe({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Hn({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Ee(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Fe.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class jr extends gt{constructor(){const e=oe(jr.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new Qe({context:this.context,gain:0}),this._carrier=new Fe({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new Ye({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new Fe({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Hn({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new Hn({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Ee(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Fe.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Es extends gt{constructor(){const e=oe(Es.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new Qe({context:this.context,gain:0}),this._thresh=new Ms({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new Ye({context:this.context,units:"audioRange",value:e.width}),this._triangle=new Fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Ee(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Cr extends gt{constructor(){const e=oe(Cr.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new Ye({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Ye({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,Ee(this,["frequency","detune"])}static getDefaults(){return Object.assign(Fe.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,s=e/(this._oscillators.length-1);this._forEach((i,a)=>i.detune.value=t+s*a)}}get count(){return this._oscillators.length}set count(e){if(nn(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const s=new Fe({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):be});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[t]=s}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,s)=>t.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class Ir extends gt{constructor(){const e=oe(Ir.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Hn({context:this.context,value:2}),this._pulse=new Es({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Ee(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const qa={am:Tr,fat:Cr,fm:jr,oscillator:Fe,pulse:Es,pwm:Ir};class lr extends gt{constructor(){const e=oe(lr.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new Ye({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Ye({context:this.context,units:"cents",value:e.detune}),Ee(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(Fe.getDefaults(),jr.getDefaults(),Tr.getDefaults(),Cr.getDefaults(),Es.getDefaults(),Ir.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=qa[e],s=this.now();if(this._oscillator){const i=this._oscillator;i.stop(s),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof qa[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&Pt(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&Pt(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Wt(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return Le(this,arguments,void 0,function*(e=1024){return Cn(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function _c(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(a){nn(a,n,e),t.set(this,a)}})}}function Yt(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(a){nn(this.toSeconds(a),n,e),t.set(this,a)}})}}class Ar extends gt{constructor(){const e=oe(Ar.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new je({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(gt.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:be,onerror:be,playbackRate:1,reverse:!1})}load(e){return Le(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=be){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,s){return super.start(e,t,s),this}_start(e,t,s){this._loop?t=Mt(t,this._loopStart):t=Mt(t,0);const i=this.toSeconds(t),a=s;s=Mt(s,Math.max(this._buffer.duration-i,0));let o=this.toSeconds(s);o=o/this._playbackRate,e=this.toSeconds(e);const l=new kr({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+o),this._state.setStateAtTime("stopped",e+o,{implicitEnd:!0})),this._activeSources.add(l),this._loop&&ft(a)?l.start(e,i):l.start(e,i,o-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(s=>s.stop(t))}restart(e,t,s){return super.restart(e,t,s),this}_restart(e,t,s){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(e),this._start(e,t,s)}seek(e,t){const s=this.toSeconds(t);if(this._state.getValueAtTime(s)==="started"){const i=this.toSeconds(e);this._stop(s),this._start(s,i)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&nn(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&nn(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),s=this._state.getNextState("stopped",t);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}jt([Yt(0)],Ar.prototype,"fadeIn",void 0);jt([Yt(0)],Ar.prototype,"fadeOut",void 0);class fn extends me{constructor(){const e=oe(fn.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new Ye({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(me.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(Wt(e))return e;{let s;for(s in Vs)if(Vs[s][t]===e)return s;return e}}_setCurve(e,t,s){if(Wt(s)&&Reflect.has(Vs,s)){const i=Vs[s];Qt(i)?e!=="_decayCurve"&&(this[e]=i[t]):this[e]=i}else if(lt(s)&&e!=="_decayCurve")this[e]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let i=this.toSeconds(this.attack);const a=this.toSeconds(this.decay),o=this.getValueAtTime(e);if(o>0){const l=1/i;i=(1-o)/l}if(i<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,i,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,i,e);else{this._sig.cancelAndHoldAtTime(e);let l=this._attackCurve;for(let c=1;c<l.length;c++)if(l[c-1]<=o&&o<=l[c]){l=this._attackCurve.slice(c),l[0]=o;break}this._sig.setValueCurveAtTime(l,e,i,t)}if(a&&this.sustain<1){const l=t*this.sustain,c=e+i;this.log("decay",c),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(l,a+c):this._sig.exponentialApproachValueAtTime(l,c,a)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,e):(ae(lt(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,s,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,s=1){return t=this.toSeconds(t),this.triggerAttack(t,s),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,s=0){return qi(this,e,t,s),this}asArray(){return Le(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,s=new Vi(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),a=i+this.toSeconds(this.release),o=a*.1,l=a+o,c=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/l,decay:t*this.toSeconds(this.decay)/l,release:t*this.toSeconds(this.release)/l,context:s}));return c._sig.toDestination(),c.triggerAttackRelease(t*(i+o)/l,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}jt([Yt(0)],fn.prototype,"attack",void 0);jt([Yt(0)],fn.prototype,"decay",void 0);jt([_c(0,1)],fn.prototype,"sustain",void 0);jt([Yt(0)],fn.prototype,"release",void 0);const Vs=(()=>{let e,t;const s=[];for(e=0;e<128;e++)s[e]=Math.sin(e/127*(Math.PI/2));const i=[],a=6.4;for(e=0;e<127;e++){t=e/127;const m=Math.sin(t*(Math.PI*2)*a-Math.PI/2)+1;i[e]=m/10+t*.83}i[127]=1;const o=[],l=5;for(e=0;e<128;e++)o[e]=Math.ceil(e/127*l)/l;const c=[];for(e=0;e<128;e++)t=e/127,c[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const m=Math.pow(t,3)*4+.2,f=Math.cos(m*Math.PI*2*t);u[e]=Math.abs(f*(1-t))}function d(m){const f=new Array(m.length);for(let p=0;p<m.length;p++)f[p]=1-m[p];return f}function h(m){return m.slice(0).reverse()}return{bounce:{In:d(u),Out:u},cosine:{In:s,Out:h(s)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:d(i)},sine:{In:c,Out:d(c)},step:{In:o,Out:d(o)}}})();let Xn=class wc extends me{constructor(){const e=oe(wc.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new rs({context:this.context,volume:e.volume}),this.volume=this._volume.volume,Ee(this,"volume")}static getDefaults(){return Object.assign(me.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const s=this["_original_"+e]=this[e];this[e]=(...i)=>{const a=i[t],o=this.context.transport.schedule(l=>{i[t]=l,s.apply(this,i)},a);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,s,i){const a=this.toSeconds(s),o=this.toSeconds(t);return this.triggerAttack(e,a,i),this.triggerRelease(a+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}};class wn extends Xn{constructor(){const e=oe(wn.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(Xn.getDefaults(),{detune:0,onsilence:be,portamento:0})}triggerAttack(e,t,s=1){this.log("triggerAttack",e,t,s);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,s),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const s=this.toSeconds(t),i=e instanceof pt?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const a=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,a,s)}else this.frequency.setValueAtTime(i,s);return this}}jt([Yt(0)],wn.prototype,"portamento",void 0);class Ki extends fn{constructor(){super(oe(Ki.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Qe({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Jn extends wn{constructor(){const e=oe(Jn.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new lr(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Ki(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),Ee(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(wn.getDefaults(),{envelope:Object.assign(di(fn.getDefaults(),Object.keys(me.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(di(lr.getDefaults(),[...Object.keys(gt.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+s+i)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Mr extends Jn{constructor(){const e=oe(Mr.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,Ee(this,["oscillator","envelope"])}static getDefaults(){return yn(wn.getDefaults(),Jn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const s=this.toSeconds(t),i=this.toFrequency(e instanceof pt?e.toFrequency():e),a=i*this.octaves;return this.oscillator.frequency.setValueAtTime(a,s),this.oscillator.frequency.exponentialRampToValueAtTime(i,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}jt([_c(0)],Mr.prototype,"octaves",void 0);jt([Yt(0)],Mr.prototype,"pitchDecay",void 0);const Nc=new Set;function Zi(n){Nc.add(n)}function Sc(n,e){const t=`registerProcessor("${n}", ${e})`;Nc.add(t)}const Ag=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Zi(Ag);const Mg=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Zi(Mg);const Eg=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Zi(Eg);const Pg="feedback-comb-filter",Og=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;Sc(Pg,Og);class Qi extends Xn{constructor(){const e=oe(Qi.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=i=>this.releaseAll(i),ae(!Pt(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Xn.getDefaults(),{maxPolyphony:32,options:{},voice:Jn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(s=>s.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return ae(e instanceof wn,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else br("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,s){e.forEach(i=>{const a=new cr(this.context,i).toMidi(),o=this._getNextAvailableVoice();o&&(o.triggerAttack(i,t,s),this._activeVoices.push({midi:a,voice:o,released:!1}),this.log("triggerAttack",i,t))})}_triggerRelease(e,t){e.forEach(s=>{const i=new cr(this.context,s).toMidi(),a=this._activeVoices.find(({midi:o,released:l})=>o===i&&!l);a&&(a.voice.triggerRelease(t),a.released=!0,this.log("triggerRelease",s,t))})}_scheduleEvent(e,t,s,i){ae(!this.disposed,"Synth was already disposed"),s<=this.now()?e==="attack"?this._triggerAttack(t,s,i):this._triggerRelease(t,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,s,i)},s-this.now())}triggerAttack(e,t,s){Array.isArray(e)||(e=[e]);const i=this.toSeconds(t);return this._scheduleEvent("attack",e,i,s),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const s=this.toSeconds(t);return this._scheduleEvent("release",e,s),this}triggerAttackRelease(e,t,s,i){const a=this.toSeconds(s);if(this.triggerAttack(e,a,i),lt(t)){ae(lt(e),"If the duration is an array, the notes must also be an array"),e=e;for(let o=0;o<e.length;o++){const l=t[Math.min(o,t.length-1)],c=this.toSeconds(l);ae(c>0,"The duration must be greater than 0"),this.triggerRelease(e[o],a+c)}}else{const o=this.toSeconds(t);ae(o>0,"The duration must be greater than 0"),this.triggerRelease(e,a+o)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=di(e,["onsilence","context"]);return this.options=yn(this.options,t),this._voices.forEach(s=>s.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Er extends Xn{constructor(){const e=oe(Er.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(s=>{const i=parseInt(s,10);if(ae(Ls(s)||Pt(i)&&isFinite(i),`url key is neither a note or midi pitch: ${s}`),Ls(s)){const a=new pt(this.context,s).toMidi();t[a]=e.urls[s]}else Pt(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new Yi({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(Xn.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:be,onerror:be,release:.1,urls:{}})}_findClosest(e){let s=0;for(;s<96;){if(this._buffers.has(e+s))return-s;if(this._buffers.has(e-s))return s;s++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,s=1){return this.log("triggerAttack",e,t,s),Array.isArray(e)||(e=[e]),e.forEach(i=>{const a=bc(new pt(this.context,i).toFrequency()),o=Math.round(a),l=a-o,c=this._findClosest(o),u=o-c,d=this._buffers.get(u),h=yc(c+l),m=new kr({url:d,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:h}).connect(this.output);m.start(t,0,d.duration/h,s),lt(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(m),m.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),p=f.indexOf(m);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(s=>{const i=new pt(this.context,s).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const a=this._activeSources.get(i);t=this.toSeconds(t),a.forEach(o=>{o.stop(t)}),this._activeSources.set(i,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,s,i=1){const a=this.toSeconds(s);return this.triggerAttack(e,a,i),lt(t)?(ae(lt(e),"notes must be an array when duration is array"),e.forEach((o,l)=>{const c=t[Math.min(l,t.length-1)];this.triggerRelease(o,a+this.toSeconds(c))})):this.triggerRelease(e,a+this.toSeconds(t)),this}add(e,t,s){if(ae(Ls(e)||isFinite(e),`note must be a pitch or midi: ${e}`),Ls(e)){const i=new pt(this.context,e).toMidi();this._buffers.add(i,t,s)}else this._buffers.add(e,t,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}jt([Yt(0)],Er.prototype,"attack",void 0);jt([Yt(0)],Er.prototype,"release",void 0);class Fn extends Ze{constructor(){const e=oe(Fn.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new As("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Ze.getDefaults(),{callback:be,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let s;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const i=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||Pt(this._loop)&&this._loop>1){s=1/0,Pt(this._loop)&&(s=this._loop*this._getLoopDuration());const a=this._state.getAfter(i);a!==null&&(s=Math.min(s,a.time-i)),s!==1/0&&(s=new qe(this.context,s));const o=new qe(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),o,new qe(this.context,i),s)}else t.id=this.context.transport.schedule(this._tick.bind(this),new qe(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const s=this._state.getBefore(t);let i=t;s!==null&&(i=s.time),this._rescheduleEvents(i)}return this}cancel(e){e=Mt(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,s=>{this.context.transport.clear(s.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;lc(this.humanize)||(s=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*s}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new qe(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new qe(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const s=this._getLoopDuration();return(e-t.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class ur extends Fn{constructor(){const e=oe(ur.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new As("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{lt(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(Fn.getDefaults(),{events:[]})}start(e,t){const s=this.toTicks(e);if(this._state.getValueAtTime(s)!=="started"){t=Mt(t,this._loop?this._loopStart:0),this._loop?t=Mt(t,this._loopStart):t=Mt(t,0);const i=this.toTicks(t);this._state.add({id:-1,offset:i,state:"started",time:s}),this._forEach(a=>{this._startNote(a,s,i)})}return this}_startNote(e,t,s){t-=s,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<s&&(t+=this._getLoopDuration()),e.start(new qe(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=s&&(e.loop=!1,e.start(new qe(this.context,t))):e.startOffset>=s&&e.start(new qe(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(s=>{s.stop(e)}),this}at(e,t){const s=new qn(this.context,e).toTicks(),i=new qe(this.context,1).toSeconds(),a=this._events.values();let o=a.next();for(;!o.done;){const l=o.value;if(Math.abs(s-l.startOffset)<i)return he(t)&&(l.value=t),l;o=a.next()}return he(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const s=this.toTicks(e);let i;return t instanceof Fn?(i=t,i.callback=this._tick.bind(this)):i=new Fn({callback:this._tick.bind(this),context:this.context,value:t}),i.startOffset=s,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new qe(this.context,t.time))})}remove(e,t){return Qt(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(s=>{s.startOffset===e&&(ft(t)||he(t)&&s.value===t)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof ur?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(s=>{s[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new qe(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new qe(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class ea extends me{constructor(){const e=oe(ea.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Ae({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",Ee(this,"pan")}static getDefaults(){return Object.assign(me.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const Dg="bit-crusher",Rg=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;Sc(Dg,Rg);class Re extends me{constructor(){const e=oe(Re.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new Qe({context:this.context}),Re._allSolos.has(this.context)||Re._allSolos.set(this.context,new Set),Re._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(me.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),Re._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){Re._soloed.has(this.context)||Re._soloed.set(this.context,new Set),Re._soloed.get(this.context).add(this)}_removeSolo(){Re._soloed.has(this.context)&&Re._soloed.get(this.context).delete(this)}_isSoloed(){return Re._soloed.has(this.context)&&Re._soloed.get(this.context).has(this)}_noSolos(){return!Re._soloed.has(this.context)||Re._soloed.has(this.context)&&Re._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),Re._allSolos.get(this.context).delete(this),this._removeSolo(),this}}Re._allSolos=new Map;Re._soloed=new Map;class ta extends me{constructor(){const e=oe(ta.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new ea({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new rs({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,Ee(this,["pan","volume"])}static getDefaults(){return Object.assign(me.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Ln extends me{constructor(){const e=oe(Ln.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new Re({solo:e.solo,context:this.context}),this._panVol=this.output=new ta({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Ee(this,["pan","volume"])}static getDefaults(){return Object.assign(me.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return Ln.buses.has(e)||Ln.buses.set(e,new Qe({context:this.context})),Ln.buses.get(e)}send(e,t=0){const s=this._getBus(e),i=new Qe({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(s),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Ln.buses=new Map;mt().transport;function Lt(){return mt().transport}mt().destination;mt().destination;function Fg(){return mt().destination}mt().listener;mt().draw;const as=mt();var kc={},Pr={};function Lg(n){var e=new at(n),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var s=Vg(t.data),i=[],a=0;!e.eof()&&a<s.numTracks;a++){var o=e.readChunk();if(o.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+o.id+"'";var l=Ug(o.data);i.push(l)}return{header:s,tracks:i}}function Vg(n){var e=new at(n),t=e.readUInt16(),s=e.readUInt16(),i={format:t,numTracks:s},a=e.readUInt16();return a&32768?(i.framesPerSecond=256-(a>>8),i.ticksPerFrame=a&255):i.ticksPerBeat=a,i}function Ug(n){for(var e=new at(n),t=[];!e.eof();){var s=a();t.push(s)}return t;var i;function a(){var o={};o.deltaTime=e.readVarInt();var l=e.readUInt8();if((l&240)===240)if(l===255){o.meta=!0;var c=e.readUInt8(),u=e.readVarInt();switch(c){case 0:if(o.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return o.number=e.readUInt16(),o;case 1:return o.type="text",o.text=e.readString(u),o;case 2:return o.type="copyrightNotice",o.text=e.readString(u),o;case 3:return o.type="trackName",o.text=e.readString(u),o;case 4:return o.type="instrumentName",o.text=e.readString(u),o;case 5:return o.type="lyrics",o.text=e.readString(u),o;case 6:return o.type="marker",o.text=e.readString(u),o;case 7:return o.type="cuePoint",o.text=e.readString(u),o;case 32:if(o.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return o.channel=e.readUInt8(),o;case 33:if(o.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return o.port=e.readUInt8(),o;case 47:if(o.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return o;case 81:if(o.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return o.microsecondsPerBeat=e.readUInt24(),o;case 84:if(o.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var d=e.readUInt8(),h={0:24,32:25,64:29,96:30};return o.frameRate=h[d&96],o.hour=d&31,o.min=e.readUInt8(),o.sec=e.readUInt8(),o.frame=e.readUInt8(),o.subFrame=e.readUInt8(),o;case 88:if(o.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return o.numerator=e.readUInt8(),o.denominator=1<<e.readUInt8(),u===4?(o.metronome=e.readUInt8(),o.thirtyseconds=e.readUInt8()):(o.metronome=36,o.thirtyseconds=8),o;case 89:if(o.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return o.key=e.readInt8(),o.scale=e.readUInt8(),o;case 127:return o.type="sequencerSpecific",o.data=e.readBytes(u),o;default:return o.type="unknownMeta",o.data=e.readBytes(u),o.metatypeByte=c,o}}else if(l==240){o.type="sysEx";var u=e.readVarInt();return o.data=e.readBytes(u),o}else if(l==247){o.type="endSysEx";var u=e.readVarInt();return o.data=e.readBytes(u),o}else throw"Unrecognised MIDI event type byte: "+l;else{var m;if(l&128)m=e.readUInt8(),i=l;else{if(i===null)throw"Running status byte encountered before status byte";m=l,l=i,o.running=!0}var f=l>>4;switch(o.channel=l&15,f){case 8:return o.type="noteOff",o.noteNumber=m,o.velocity=e.readUInt8(),o;case 9:var p=e.readUInt8();return o.type=p===0?"noteOff":"noteOn",o.noteNumber=m,o.velocity=p,p===0&&(o.byte9=!0),o;case 10:return o.type="noteAftertouch",o.noteNumber=m,o.amount=e.readUInt8(),o;case 11:return o.type="controller",o.controllerType=m,o.value=e.readUInt8(),o;case 12:return o.type="programChange",o.programNumber=m,o;case 13:return o.type="channelAftertouch",o.amount=m,o;case 14:return o.type="pitchBend",o.value=m+(e.readUInt8()<<7)-8192,o;default:throw"Unrecognised MIDI event type: "+f}}}}function at(n){this.buffer=n,this.bufferLen=this.buffer.length,this.pos=0}at.prototype.eof=function(){return this.pos>=this.bufferLen};at.prototype.readUInt8=function(){var n=this.buffer[this.pos];return this.pos+=1,n};at.prototype.readInt8=function(){var n=this.readUInt8();return n&128?n-256:n};at.prototype.readUInt16=function(){var n=this.readUInt8(),e=this.readUInt8();return(n<<8)+e};at.prototype.readInt16=function(){var n=this.readUInt16();return n&32768?n-65536:n};at.prototype.readUInt24=function(){var n=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(n<<16)+(e<<8)+t};at.prototype.readInt24=function(){var n=this.readUInt24();return n&8388608?n-16777216:n};at.prototype.readUInt32=function(){var n=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8();return(n<<24)+(e<<16)+(t<<8)+s};at.prototype.readBytes=function(n){var e=this.buffer.slice(this.pos,this.pos+n);return this.pos+=n,e};at.prototype.readString=function(n){var e=this.readBytes(n);return String.fromCharCode.apply(null,e)};at.prototype.readVarInt=function(){for(var n=0;!this.eof();){var e=this.readUInt8();if(e&128)n+=e&127,n<<=7;else return n+e}return n};at.prototype.readChunk=function(){var n=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:n,length:e,data:t}};var Bg=Lg;function qg(n,e){if(typeof n!="object")throw"Invalid MIDI data";e=e||{};var t=n.header||{},s=n.tracks||[],i,a=s.length,o=new $e;for(Wg(o,t,a),i=0;i<a;i++)$g(o,s[i],e);return o.buffer}function Wg(n,e,t){var s=e.format==null?1:e.format,i=128;e.timeDivision?i=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?i=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(i=e.ticksPerBeat&32767);var a=new $e;a.writeUInt16(s),a.writeUInt16(t),a.writeUInt16(i),n.writeChunk("MThd",a.buffer)}function $g(n,e,t){var s=new $e,i,a=e.length,o=null;for(i=0;i<a;i++)(t.running===!1||!t.running&&!e[i].running)&&(o=null),o=Gg(s,e[i],o,t.useByte9ForNoteOff);n.writeChunk("MTrk",s.buffer)}function Gg(n,e,t,s){var i=e.type,a=e.deltaTime,o=e.text||"",l=e.data||[],c=null;switch(n.writeVarInt(a),i){case"sequenceNumber":n.writeUInt8(255),n.writeUInt8(0),n.writeVarInt(2),n.writeUInt16(e.number);break;case"text":n.writeUInt8(255),n.writeUInt8(1),n.writeVarInt(o.length),n.writeString(o);break;case"copyrightNotice":n.writeUInt8(255),n.writeUInt8(2),n.writeVarInt(o.length),n.writeString(o);break;case"trackName":n.writeUInt8(255),n.writeUInt8(3),n.writeVarInt(o.length),n.writeString(o);break;case"instrumentName":n.writeUInt8(255),n.writeUInt8(4),n.writeVarInt(o.length),n.writeString(o);break;case"lyrics":n.writeUInt8(255),n.writeUInt8(5),n.writeVarInt(o.length),n.writeString(o);break;case"marker":n.writeUInt8(255),n.writeUInt8(6),n.writeVarInt(o.length),n.writeString(o);break;case"cuePoint":n.writeUInt8(255),n.writeUInt8(7),n.writeVarInt(o.length),n.writeString(o);break;case"channelPrefix":n.writeUInt8(255),n.writeUInt8(32),n.writeVarInt(1),n.writeUInt8(e.channel);break;case"portPrefix":n.writeUInt8(255),n.writeUInt8(33),n.writeVarInt(1),n.writeUInt8(e.port);break;case"endOfTrack":n.writeUInt8(255),n.writeUInt8(47),n.writeVarInt(0);break;case"setTempo":n.writeUInt8(255),n.writeUInt8(81),n.writeVarInt(3),n.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":n.writeUInt8(255),n.writeUInt8(84),n.writeVarInt(5);var u={24:0,25:32,29:64,30:96},d=e.hour&31|u[e.frameRate];n.writeUInt8(d),n.writeUInt8(e.min),n.writeUInt8(e.sec),n.writeUInt8(e.frame),n.writeUInt8(e.subFrame);break;case"timeSignature":n.writeUInt8(255),n.writeUInt8(88),n.writeVarInt(4),n.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;n.writeUInt8(h),n.writeUInt8(e.metronome),n.writeUInt8(e.thirtyseconds||8);break;case"keySignature":n.writeUInt8(255),n.writeUInt8(89),n.writeVarInt(2),n.writeInt8(e.key),n.writeUInt8(e.scale);break;case"sequencerSpecific":n.writeUInt8(255),n.writeUInt8(127),n.writeVarInt(l.length),n.writeBytes(l);break;case"unknownMeta":e.metatypeByte!=null&&(n.writeUInt8(255),n.writeUInt8(e.metatypeByte),n.writeVarInt(l.length),n.writeBytes(l));break;case"sysEx":n.writeUInt8(240),n.writeVarInt(l.length),n.writeBytes(l);break;case"endSysEx":n.writeUInt8(247),n.writeVarInt(l.length),n.writeBytes(l);break;case"noteOff":var m=s!==!1&&e.byte9||s&&e.velocity==0?144:128;c=m|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.noteNumber),n.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.noteNumber),n.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.noteNumber),n.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.controllerType),n.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&n.writeUInt8(c),n.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&n.writeUInt8(c);var f=8192+e.value,p=f&127,g=f>>7&127;n.writeUInt8(p),n.writeUInt8(g);break;default:throw"Unrecognized event type: "+i}return c}function $e(){this.buffer=[]}$e.prototype.writeUInt8=function(n){this.buffer.push(n&255)};$e.prototype.writeInt8=$e.prototype.writeUInt8;$e.prototype.writeUInt16=function(n){var e=n>>8&255,t=n&255;this.writeUInt8(e),this.writeUInt8(t)};$e.prototype.writeInt16=$e.prototype.writeUInt16;$e.prototype.writeUInt24=function(n){var e=n>>16&255,t=n>>8&255,s=n&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s)};$e.prototype.writeInt24=$e.prototype.writeUInt24;$e.prototype.writeUInt32=function(n){var e=n>>24&255,t=n>>16&255,s=n>>8&255,i=n&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s),this.writeUInt8(i)};$e.prototype.writeInt32=$e.prototype.writeUInt32;$e.prototype.writeBytes=function(n){this.buffer=this.buffer.concat(Array.prototype.slice.call(n,0))};$e.prototype.writeString=function(n){var e,t=n.length,s=[];for(e=0;e<t;e++)s.push(n.codePointAt(e));this.writeBytes(s)};$e.prototype.writeVarInt=function(n){if(n<0)throw"Cannot write negative variable-length integer";if(n<=127)this.writeUInt8(n);else{var e=n,t=[];for(t.push(e&127),e>>=7;e;){var s=e&127|128;t.push(s),e>>=7}this.writeBytes(t.reverse())}};$e.prototype.writeChunk=function(n,e){this.writeString(n),this.writeUInt32(e.length),this.writeBytes(e)};var zg=qg;Pr.parseMidi=Bg;Pr.writeMidi=zg;var dr={},Nn={};Object.defineProperty(Nn,"__esModule",{value:!0});Nn.insert=Nn.search=void 0;function Tc(n,e,t){t===void 0&&(t="ticks");var s=0,i=n.length,a=i;if(i>0&&n[i-1][t]<=e)return i-1;for(;s<a;){var o=Math.floor(s+(a-s)/2),l=n[o],c=n[o+1];if(l[t]===e){for(var u=o;u<n.length;u++){var d=n[u];d[t]===e&&(o=u)}return o}else{if(l[t]<e&&c[t]>e)return o;l[t]>e?a=o:l[t]<e&&(s=o+1)}}return-1}Nn.search=Tc;function Yg(n,e,t){if(t===void 0&&(t="ticks"),n.length){var s=Tc(n,e[t],t);n.splice(s+1,0,e)}else n.push(e)}Nn.insert=Yg;(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.Header=n.keySignatureKeys=void 0;var e=Nn,t=new WeakMap;n.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var s=function(){function i(a){var o=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",t.set(this,480),a){t.set(this,a.header.ticksPerBeat),a.tracks.forEach(function(c){c.forEach(function(u){u.meta&&(u.type==="timeSignature"?o.timeSignatures.push({ticks:u.absoluteTime,timeSignature:[u.numerator,u.denominator]}):u.type==="setTempo"?o.tempos.push({bpm:6e7/u.microsecondsPerBeat,ticks:u.absoluteTime}):u.type==="keySignature"&&o.keySignatures.push({key:n.keySignatureKeys[u.key+7],scale:u.scale===0?"major":"minor",ticks:u.absoluteTime}))})});var l=0;a.tracks[0].forEach(function(c){l+=c.deltaTime,c.meta&&(c.type==="trackName"?o.name=c.text:(c.type==="text"||c.type==="cuePoint"||c.type==="marker"||c.type==="lyrics")&&o.meta.push({text:c.text,ticks:l,type:c.type}))}),this.update()}}return i.prototype.update=function(){var a=this,o=0,l=0;this.tempos.sort(function(c,u){return c.ticks-u.ticks}),this.tempos.forEach(function(c,u){var d=u>0?a.tempos[u-1].bpm:a.tempos[0].bpm,h=c.ticks/a.ppq-l,m=60/d*h;c.time=m+o,o=c.time,l+=h}),this.timeSignatures.sort(function(c,u){return c.ticks-u.ticks}),this.timeSignatures.forEach(function(c,u){var d=u>0?a.timeSignatures[u-1]:a.timeSignatures[0],h=(c.ticks-d.ticks)/a.ppq,m=h/d.timeSignature[0]/(d.timeSignature[1]/4);d.measures=d.measures||0,c.measures=m+d.measures})},i.prototype.ticksToSeconds=function(a){var o=(0,e.search)(this.tempos,a);if(o!==-1){var l=this.tempos[o],c=l.time,u=(a-l.ticks)/this.ppq;return c+60/l.bpm*u}else{var d=a/this.ppq;return 60/120*d}},i.prototype.ticksToMeasures=function(a){var o=(0,e.search)(this.timeSignatures,a);if(o!==-1){var l=this.timeSignatures[o],c=(a-l.ticks)/this.ppq;return l.measures+c/(l.timeSignature[0]/l.timeSignature[1])/4}else return a/this.ppq/4},Object.defineProperty(i.prototype,"ppq",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),i.prototype.secondsToTicks=function(a){var o=(0,e.search)(this.tempos,a,"time");if(o!==-1){var l=this.tempos[o],c=l.time,u=a-c,d=u/(60/l.bpm);return Math.round(l.ticks+d*this.ppq)}else{var h=a/.5;return Math.round(h*this.ppq)}},i.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(a){return{bpm:a.bpm,ticks:a.ticks}}),timeSignatures:this.timeSignatures}},i.prototype.fromJSON=function(a){this.name=a.name,this.tempos=a.tempos.map(function(o){return Object.assign({},o)}),this.timeSignatures=a.timeSignatures.map(function(o){return Object.assign({},o)}),this.keySignatures=a.keySignatures.map(function(o){return Object.assign({},o)}),this.meta=a.meta.map(function(o){return Object.assign({},o)}),t.set(this,a.ppq),this.update()},i.prototype.setTempo=function(a){this.tempos=[{bpm:a,ticks:0}],this.update()},i}();n.Header=s})(dr);var ms={},na={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.ControlChange=n.controlChangeIds=n.controlChangeNames=void 0,n.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},n.controlChangeIds=Object.keys(n.controlChangeNames).reduce(function(i,a){return i[n.controlChangeNames[a]]=a,i},{});var e=new WeakMap,t=new WeakMap,s=function(){function i(a,o){e.set(this,o),t.set(this,a.controllerType),this.ticks=a.absoluteTime,this.value=a.value}return Object.defineProperty(i.prototype,"number",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return n.controlChangeNames[this.number]?n.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"time",{get:function(){var a=e.get(this);return a.ticksToSeconds(this.ticks)},set:function(a){var o=e.get(this);this.ticks=o.secondsToTicks(a)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},i}();n.ControlChange=s})(na);var Or={};Object.defineProperty(Or,"__esModule",{value:!0});Or.createControlChanges=void 0;var Us=na;function Hg(){return new Proxy({},{get:function(n,e){if(n[e])return n[e];if(Us.controlChangeIds.hasOwnProperty(e))return n[Us.controlChangeIds[e]]},set:function(n,e,t){return Us.controlChangeIds.hasOwnProperty(e)?n[Us.controlChangeIds[e]]=t:n[e]=t,!0}})}Or.createControlChanges=Hg;var Dr={};Object.defineProperty(Dr,"__esModule",{value:!0});Dr.PitchBend=void 0;var Xr=new WeakMap,Xg=function(){function n(e,t){Xr.set(this,t),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(n.prototype,"time",{get:function(){var e=Xr.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=Xr.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},n}();Dr.PitchBend=Xg;var Rr={},tn={};Object.defineProperty(tn,"__esModule",{value:!0});tn.DrumKitByPatchID=tn.InstrumentFamilyByID=tn.instrumentByPatchID=void 0;tn.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"];tn.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"];tn.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"};Object.defineProperty(Rr,"__esModule",{value:!0});Rr.Instrument=void 0;var Bs=tn,Wa=new WeakMap,Jg=function(){function n(e,t){if(this.number=0,Wa.set(this,t),this.number=0,e){var s=e.find(function(i){return i.type==="programChange"});s&&(this.number=s.programNumber)}}return Object.defineProperty(n.prototype,"name",{get:function(){return this.percussion?Bs.DrumKitByPatchID[this.number]:Bs.instrumentByPatchID[this.number]},set:function(e){var t=Bs.instrumentByPatchID.indexOf(e);t!==-1&&(this.number=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"family",{get:function(){return this.percussion?"drums":Bs.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"percussion",{get:function(){var e=Wa.get(this);return e.channel===9},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},n.prototype.fromJSON=function(e){this.number=e.number},n}();Rr.Instrument=Jg;var Fr={};Object.defineProperty(Fr,"__esModule",{value:!0});Fr.Note=void 0;function Kg(n){var e=Math.floor(n/12)-1;return jc(n)+e.toString()}function jc(n){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=n%12;return e[t]}function Zg(n){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return e.indexOf(n)}var Qg=function(){var n=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,e={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(t){var s=n.exec(t),i=s[1],a=s[2],o=e[i.toLowerCase()];return o+(parseInt(a,10)+1)*12}}(),En=new WeakMap,ev=function(){function n(e,t,s){En.set(this,s),this.midi=e.midi,this.velocity=e.velocity,this.noteOffVelocity=t.velocity,this.ticks=e.ticks,this.durationTicks=t.ticks-e.ticks}return Object.defineProperty(n.prototype,"name",{get:function(){return Kg(this.midi)},set:function(e){this.midi=Qg(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(e){var t=e-this.octave;this.midi+=t*12},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pitch",{get:function(){return jc(this.midi)},set:function(e){this.midi=12*(this.octave+1)+Zg(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){var e=En.get(this);return e.ticksToSeconds(this.ticks+this.durationTicks)-e.ticksToSeconds(this.ticks)},set:function(e){var t=En.get(this),s=t.secondsToTicks(this.time+e);this.durationTicks=s-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"time",{get:function(){var e=En.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=En.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"bars",{get:function(){var e=En.get(this);return e.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},n}();Fr.Note=ev;Object.defineProperty(ms,"__esModule",{value:!0});ms.Track=void 0;var Jr=Nn,tv=na,nv=Or,sv=Dr,$a=Rr,rv=Fr,qs=new WeakMap,iv=function(){function n(e,t){var s=this;if(this.name="",this.notes=[],this.controlChanges=(0,nv.createControlChanges)(),this.pitchBends=[],qs.set(this,t),e){var i=e.find(function(m){return m.type==="trackName"});this.name=i?i.text:""}if(this.instrument=new $a.Instrument(e,this),this.channel=0,e){for(var a=e.filter(function(m){return m.type==="noteOn"}),o=e.filter(function(m){return m.type==="noteOff"}),l=function(){var m=a.shift();c.channel=m.channel;var f=o.findIndex(function(g){return g.noteNumber===m.noteNumber&&g.absoluteTime>=m.absoluteTime});if(f!==-1){var p=o.splice(f,1)[0];c.addNote({durationTicks:p.absoluteTime-m.absoluteTime,midi:m.noteNumber,noteOffVelocity:p.velocity/127,ticks:m.absoluteTime,velocity:m.velocity/127})}},c=this;a.length;)l();var u=e.filter(function(m){return m.type==="controller"});u.forEach(function(m){s.addCC({number:m.controllerType,ticks:m.absoluteTime,value:m.value/127})});var d=e.filter(function(m){return m.type==="pitchBend"});d.forEach(function(m){s.addPitchBend({ticks:m.absoluteTime,value:m.value/Math.pow(2,13)})});var h=e.find(function(m){return m.type==="endOfTrack"});this.endOfTrackTicks=h!==void 0?h.absoluteTime:void 0}}return n.prototype.addNote=function(e){var t=qs.get(this),s=new rv.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},t);return Object.assign(s,e),(0,Jr.insert)(this.notes,s,"ticks"),this},n.prototype.addCC=function(e){var t=qs.get(this),s=new tv.ControlChange({controllerType:e.number},t);return delete e.number,Object.assign(s,e),Array.isArray(this.controlChanges[s.number])||(this.controlChanges[s.number]=[]),(0,Jr.insert)(this.controlChanges[s.number],s,"ticks"),this},n.prototype.addPitchBend=function(e){var t=qs.get(this),s=new sv.PitchBend({},t);return Object.assign(s,e),(0,Jr.insert)(this.pitchBends,s,"ticks"),this},Object.defineProperty(n.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,t=0;t<this.notes.length-1;t++){var s=this.notes[t].time+this.notes[t].duration;e<s&&(e=s)}return e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,t=0;t<this.notes.length-1;t++){var s=this.notes[t].ticks+this.notes[t].durationTicks;e<s&&(e=s)}return e},enumerable:!1,configurable:!0}),n.prototype.fromJSON=function(e){var t=this;this.name=e.name,this.channel=e.channel,this.instrument=new $a.Instrument(void 0,this),this.instrument.fromJSON(e.instrument),e.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=e.endOfTrackTicks);for(var s in e.controlChanges)e.controlChanges[s]&&e.controlChanges[s].forEach(function(i){t.addCC({number:i.number,ticks:i.ticks,value:i.value})});e.notes.forEach(function(i){t.addNote({durationTicks:i.durationTicks,midi:i.midi,ticks:i.ticks,velocity:i.velocity})})},n.prototype.toJSON=function(){for(var e={},t=0;t<127;t++)this.controlChanges.hasOwnProperty(t)&&(e[t]=this.controlChanges[t].map(function(i){return i.toJSON()}));var s={channel:this.channel,controlChanges:e,pitchBends:this.pitchBends.map(function(i){return i.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(i){return i.toJSON()})};return this.endOfTrackTicks!==void 0&&(s.endOfTrackTicks=this.endOfTrackTicks),s},n}();ms.Track=iv;var Lr={};function av(n){var e=[];return Cc(n,e),e}function Cc(n,e){for(var t=0;t<n.length;t++){var s=n[t];Array.isArray(s)?Cc(s,e):e.push(s)}}const ov=Object.freeze(Object.defineProperty({__proto__:null,flatten:av},Symbol.toStringTag,{value:"Module"})),cv=Bc(ov);var Xt=Dn&&Dn.__spreadArray||function(n,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,a;s<i;s++)(a||!(s in e))&&(a||(a=Array.prototype.slice.call(e,0,s)),a[s]=e[s]);return n.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(Lr,"__esModule",{value:!0});Lr.encode=void 0;var lv=Pr,uv=dr,dv=cv;function hv(n,e){return[{absoluteTime:n.ticks,channel:e,deltaTime:0,noteNumber:n.midi,type:"noteOn",velocity:Math.floor(n.velocity*127)},{absoluteTime:n.ticks+n.durationTicks,channel:e,deltaTime:0,noteNumber:n.midi,type:"noteOff",velocity:Math.floor(n.noteOffVelocity*127)}]}function mv(n){return(0,dv.flatten)(n.notes.map(function(e){return hv(e,n.channel)}))}function pv(n,e){return{absoluteTime:n.ticks,channel:e,controllerType:n.number,deltaTime:0,type:"controller",value:Math.floor(n.value*127)}}function fv(n){for(var e=[],t=0;t<127;t++)n.controlChanges.hasOwnProperty(t)&&n.controlChanges[t].forEach(function(s){e.push(pv(s,n.channel))});return e}function gv(n,e){return{absoluteTime:n.ticks,channel:e,deltaTime:0,type:"pitchBend",value:n.value}}function vv(n){var e=[];return n.pitchBends.forEach(function(t){e.push(gv(t,n.channel))}),e}function yv(n){return{absoluteTime:0,channel:n.channel,deltaTime:0,programNumber:n.instrument.number,type:"programChange"}}function bv(n){return{absoluteTime:0,deltaTime:0,meta:!0,text:n,type:"trackName"}}function xv(n){return{absoluteTime:n.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/n.bpm),type:"setTempo"}}function _v(n){return{absoluteTime:n.ticks,deltaTime:0,denominator:n.timeSignature[1],meta:!0,metronome:24,numerator:n.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function wv(n){var e=uv.keySignatureKeys.indexOf(n.key);return{absoluteTime:n.ticks,deltaTime:0,key:e+7,meta:!0,scale:n.scale==="major"?0:1,type:"keySignature"}}function Nv(n){return{absoluteTime:n.ticks,deltaTime:0,meta:!0,text:n.text,type:n.type}}function Sv(n){var e={header:{format:1,numTracks:n.tracks.length+1,ticksPerBeat:n.header.ppq},tracks:Xt([Xt(Xt(Xt(Xt([{absoluteTime:0,deltaTime:0,meta:!0,text:n.header.name,type:"trackName"}],n.header.keySignatures.map(function(t){return wv(t)}),!0),n.header.meta.map(function(t){return Nv(t)}),!0),n.header.tempos.map(function(t){return xv(t)}),!0),n.header.timeSignatures.map(function(t){return _v(t)}),!0)],n.tracks.map(function(t){return Xt(Xt(Xt([bv(t.name),yv(t)],mv(t),!0),fv(t),!0),vv(t),!0)}),!0)};return e.tracks=e.tracks.map(function(t){t=t.sort(function(i,a){return i.absoluteTime-a.absoluteTime});var s=0;return t.forEach(function(i){i.deltaTime=i.absoluteTime-s,s=i.absoluteTime,delete i.absoluteTime}),t.push({deltaTime:0,meta:!0,type:"endOfTrack"}),t}),new Uint8Array((0,lv.writeMidi)(e))}Lr.encode=Sv;(function(n){var e=Dn&&Dn.__awaiter||function(h,m,f,p){function g(v){return v instanceof f?v:new f(function(y){y(v)})}return new(f||(f=Promise))(function(v,y){function w(x){try{j(p.next(x))}catch(k){y(k)}}function N(x){try{j(p.throw(x))}catch(k){y(k)}}function j(x){x.done?v(x.value):g(x.value).then(w,N)}j((p=p.apply(h,m||[])).next())})},t=Dn&&Dn.__generator||function(h,m){var f={label:0,sent:function(){if(v[0]&1)throw v[1];return v[1]},trys:[],ops:[]},p,g,v,y;return y={next:w(0),throw:w(1),return:w(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function w(j){return function(x){return N([j,x])}}function N(j){if(p)throw new TypeError("Generator is already executing.");for(;f;)try{if(p=1,g&&(v=j[0]&2?g.return:j[0]?g.throw||((v=g.return)&&v.call(g),0):g.next)&&!(v=v.call(g,j[1])).done)return v;switch(g=0,v&&(j=[j[0]&2,v.value]),j[0]){case 0:case 1:v=j;break;case 4:return f.label++,{value:j[1],done:!1};case 5:f.label++,g=j[1],j=[0];continue;case 7:j=f.ops.pop(),f.trys.pop();continue;default:if(v=f.trys,!(v=v.length>0&&v[v.length-1])&&(j[0]===6||j[0]===2)){f=0;continue}if(j[0]===3&&(!v||j[1]>v[0]&&j[1]<v[3])){f.label=j[1];break}if(j[0]===6&&f.label<v[1]){f.label=v[1],v=j;break}if(v&&f.label<v[2]){f.label=v[2],f.ops.push(j);break}v[2]&&f.ops.pop(),f.trys.pop();continue}j=m.call(h,f)}catch(x){j=[6,x],g=0}finally{p=v=0}if(j[0]&5)throw j[1];return{value:j[0]?j[1]:void 0,done:!0}}};Object.defineProperty(n,"__esModule",{value:!0}),n.Header=n.Track=n.Midi=void 0;var s=Pr,i=dr,a=ms,o=Lr,l=function(){function h(m){var f=this,p=null;if(m){var g=m instanceof ArrayBuffer?new Uint8Array(m):m;p=(0,s.parseMidi)(g),p.tracks.forEach(function(v){var y=0;v.forEach(function(w){y+=w.deltaTime,w.absoluteTime=y})}),p.tracks=d(p.tracks)}this.header=new i.Header(p),this.tracks=[],m&&(this.tracks=p.tracks.map(function(v){return new a.Track(v,f.header)}),p.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return h.fromUrl=function(m){return e(this,void 0,void 0,function(){var f,p;return t(this,function(g){switch(g.label){case 0:return[4,fetch(m)];case 1:return f=g.sent(),f.ok?[4,f.arrayBuffer()]:[3,3];case 2:return p=g.sent(),[2,new h(p)];case 3:throw new Error("Could not load '".concat(m,"'"))}})})},Object.defineProperty(h.prototype,"name",{get:function(){return this.header.name},set:function(m){this.header.name=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"duration",{get:function(){var m=this.tracks.map(function(f){return f.duration});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"durationTicks",{get:function(){var m=this.tracks.map(function(f){return f.durationTicks});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),h.prototype.addTrack=function(){var m=new a.Track(void 0,this.header);return this.tracks.push(m),m},h.prototype.toArray=function(){return(0,o.encode)(this)},h.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(m){return m.toJSON()})}},h.prototype.fromJSON=function(m){var f=this;this.header=new i.Header,this.header.fromJSON(m.header),this.tracks=m.tracks.map(function(p){var g=new a.Track(void 0,f.header);return g.fromJSON(p),g})},h.prototype.clone=function(){var m=new h;return m.fromJSON(this.toJSON()),m},h}();n.Midi=l;var c=ms;Object.defineProperty(n,"Track",{enumerable:!0,get:function(){return c.Track}});var u=dr;Object.defineProperty(n,"Header",{enumerable:!0,get:function(){return u.Header}});function d(h){for(var m=[],f=0;f<h.length;f++)for(var p=m.length,g=new Map,v=Array(16).fill(0),y=0,w=h[f];y<w.length;y++){var N=w[y],j=p,x=N.channel;if(x!==void 0){N.type==="programChange"&&(v[x]=N.programNumber);var k=v[x],S="".concat(k," ").concat(x);g.has(S)?j=g.get(S):(j=p+g.size,g.set(S,j))}m[j]||m.push([]),m[j].push(N)}return m}})(kc);class kv{constructor(e={}){It(this,"synth",null);It(this,"part",null);It(this,"isPlaying",!1);It(this,"isPaused",!1);It(this,"duration",0);It(this,"options");It(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let a=0;a<t.length;a++)s[a]=t.charCodeAt(a);const i=this.parseMIDIToNotes(s);this.synth||(this.synth=new Qi(Jn,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new ur((a,o)=>{this.synth?.triggerAttackRelease(o.name,o.duration,a,o.velocity)},i),this.duration=this.calculateDuration(i),this.part.loop=!1}catch(t){const s=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(s),s}}parseMIDIToNotes(e){try{const t=new kc.Midi(e),s=[];for(const i of t.tracks)for(const a of i.notes){const o=Number(a.time),l=Number(a.duration);!Number.isFinite(o)||!Number.isFinite(l)||s.push({time:o,name:a.name,duration:l,velocity:typeof a.velocity=="number"?a.velocity:.8})}if(s.sort((i,a)=>Number(i.time)-Number(a.time)),s.length)return s;throw new Error("No notes found in MIDI")}catch{const t=[],s=["C4","D4","E4","F4","G4","A4","B4","C5"];let i=0;for(let a=0;a<16;a++)t.push({time:i,name:s[a%s.length],duration:.4,velocity:.7}),i+=.5;return t}}calculateDuration(e){if(e.length===0)return 0;let t=0;for(const s of e)!Number.isFinite(s.time)||!Number.isFinite(s.duration)||(t=Math.max(t,s.time+s.duration));return t}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await mi(),this.isPaused?(Lt().start(),this.isPaused=!1):(this.part.start(0),Lt().start()),this.isPlaying=!0,this.startProgressTracking(),Lt().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(Lt().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){Lt().stop(),Lt().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));Lt().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:Lt().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=Lt().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let Kr=null;function Tv(){return Kr||(Kr=new kv),Kr}const jv=({album:n,isPlaying:e,currentTime:t,duration:s,onPlayPause:i,onExpand:a})=>{if(!n)return null;const o=s>0?Math.max(0,Math.min(1,t/s)):0,l=c=>{c.stopPropagation()};return r.jsxs("div",{className:"spotify-square-dock",role:"button",tabIndex:0,"aria-label":"プレイヤーを開く",onClick:a,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),a())},"data-no-swipe":!0,children:[r.jsx("img",{className:"spotify-square-dock-art",src:n.imageDataURL,alt:n.title||n.mood,draggable:!1}),r.jsx("div",{className:"spotify-square-dock-overlay","aria-hidden":"true"}),r.jsx("button",{className:"spotify-square-dock-play",onClick:c=>{l(c),i()},onMouseDown:l,onTouchStart:l,"aria-label":e?"一時停止":"再生",title:e?"一時停止":"再生",children:e?"⏸":"▶"}),r.jsx("div",{className:"spotify-square-dock-progress","aria-hidden":"true",children:r.jsx("div",{className:"spotify-square-dock-progressFill",style:{width:`${Math.round(o*100)}%`}})}),r.jsx("div",{className:"spotify-square-dock-hint","aria-hidden":"true",children:r.jsx("div",{className:"spotify-square-dock-title",children:n.title||n.mood})})]})},Cv=({isPlaying:n,canPrevious:e,canNext:t,shuffle:s,repeat:i,onPlayPause:a,onPrevious:o,onNext:l,onShuffle:c,onRepeat:u,expanded:d=!1})=>{const h=()=>r.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:r.jsx("polygon",{points:"8,6 8,18 18,12"})}),m=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),r.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),f=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),r.jsx("polygon",{points:"18,6 10,12 18,18"})]}),p=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("polygon",{points:"6,6 14,12 6,18"}),r.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),g=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),r.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),v=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("path",{d:"M7 7h10v4"}),r.jsx("path",{d:"M17 17H7v-4"}),r.jsx("path",{d:"M17 7l3 3-3 3"}),r.jsx("path",{d:"M7 17l-3-3 3-3"})]});return r.jsxs("div",{className:`playback-controls ${d?"expanded":""}`,children:[d&&r.jsx("button",{className:`control-button secondary ${s?"active":""}`,onClick:c,"aria-label":"Shuffle",title:"Shuffle",children:r.jsx(g,{})}),r.jsx("button",{className:"control-button",onClick:o,disabled:!e,"aria-label":"Previous",title:"Previous track",children:r.jsx(f,{})}),r.jsx("button",{className:"control-button primary",onClick:a,"aria-label":n?"Pause":"Play",title:n?"Pause":"Play",children:n?r.jsx(m,{}):r.jsx(h,{})}),r.jsx("button",{className:"control-button",onClick:l,disabled:!t,"aria-label":"Next",title:"Next track",children:r.jsx(p,{})}),d&&r.jsxs("button",{className:`control-button secondary ${i!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${i}`,title:`Repeat: ${i}`,children:[r.jsx(v,{}),i==="one"&&r.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},Iv=({currentTime:n,duration:e,onSeek:t,color:s="#D4AF37"})=>{const[i,a]=_.useState(!1),o=_.useRef(null),l=f=>{if(!isFinite(f)||f<0)return"0:00";const p=Math.floor(f/60),g=Math.floor(f%60);return`${p}:${g.toString().padStart(2,"0")}`},c=f=>{if(!o.current||e===0)return;const p=o.current.getBoundingClientRect(),g=f-p.left,y=Math.max(0,Math.min(1,g/p.width))*e;t(y)},u=f=>{a(!0),c(f.clientX)},d=f=>{i&&c(f.clientX)},h=()=>{a(!1)};R.useEffect(()=>{if(i)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",h),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",h)}},[i]);const m=e>0?n/e*100:0;return r.jsxs("div",{className:"seek-bar-container",children:[r.jsx("span",{className:"seek-time current",children:l(n)}),r.jsx("div",{ref:o,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":n,children:r.jsx("div",{className:"seek-progress",style:{width:`${m}%`,background:`linear-gradient(90deg, ${s}cc, ${s})`},children:r.jsx("div",{className:"seek-thumb"})})}),r.jsx("span",{className:"seek-time total",children:l(e)})]})},Av=({volume:n,isMuted:e,onVolumeChange:t,onMuteToggle:s,expanded:i=!1})=>{const[a,o]=_.useState(!1),l=_.useRef(null),c=e||n===0?"muted":n<.5?"low":"high",u=p=>{if(!l.current)return;const g=l.current.getBoundingClientRect(),v=p-g.left,y=Math.max(0,Math.min(1,v/g.width));t(y)},d=p=>{o(!0),u(p.clientX)},h=p=>{a&&u(p.clientX)},m=()=>{o(!1)};R.useEffect(()=>{if(a)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",m),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",m)}},[a]);const f=e?0:n;return r.jsxs("div",{className:`volume-control ${i?"expanded":""}`,children:[r.jsxs("button",{className:`volume-icon ${c}`,onClick:s,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[r.jsx("span",{className:"volume-core"}),r.jsx("span",{className:"volume-wave wave-1"}),r.jsx("span",{className:"volume-wave wave-2"})]}),r.jsx("div",{ref:l,className:"volume-slider",onMouseDown:d,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(f*100),children:r.jsx("div",{className:"volume-fill",style:{width:`${f*100}%`},children:r.jsx("div",{className:"volume-thumb"})})})]})},Mv=({queue:n,currentIndex:e,onSkipTo:t})=>{const s=n.slice(e+1,e+4);if(s.length===0)return null;const i=a=>{const o=Math.floor(a/60),l=Math.floor(a%60);return`${o}:${l.toString().padStart(2,"0")}`};return r.jsxs("div",{className:"queue-preview",children:[r.jsx("div",{className:"queue-label",children:"Up Next"}),r.jsx("div",{className:"queue-items",children:s.map((a,o)=>r.jsx("div",{className:"queue-item",onClick:()=>t(e+o+1),role:"button",tabIndex:0,onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t(e+o+1))},children:r.jsx(bn,{variant:"compact",className:"queue-album-card",title:a.title||a.mood,mood:a.mood,imageUrl:a.imageDataURL,meta:i(a.musicMetadata?.duration||a.duration),badges:[...a.musicData?[{label:"再生",tone:"success"}]:[],...a.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...a.isPublic?[{label:"公開",tone:"info"}]:[]]})},a.id))})]})};class Ev{static draw(e,t,s,i,a,o){const l=this.smoothData(t);this.drawGrid(e,s,i),e.lineWidth=3,e.strokeStyle=this.getGradient(e,a,s),e.shadowBlur=o?8:4,e.shadowColor=a,e.beginPath();const c=s/l.length;let u=0;for(let d=0;d<l.length;d++){const m=l[d]/128*i/2;if(d===0)e.moveTo(u,m);else{const f=(u+c*d)/2,p=(m+l[d-1]/128*i/2)/2;e.quadraticCurveTo(u,l[d-1]/128*i/2,f,p)}u=c*d}e.lineTo(s,i/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-i),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let i=0;i<e.length;i++){let a=0,o=0;for(let l=-3;l<=3;l++){const c=i+l;c>=0&&c<e.length&&(a+=e[c],o++)}t.push(a/o)}return t}static drawGrid(e,t,s){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const i=5;for(let a=0;a<i;a++){const o=s/(i-1)*a;e.beginPath(),e.moveTo(0,o),e.lineTo(t,o),e.stroke()}}static getGradient(e,t,s){const i=e.createLinearGradient(0,0,s,0);return i.addColorStop(0,t),i.addColorStop(.5,this.lightenColor(t,20)),i.addColorStop(1,t),i}static lightenColor(e,t){const s=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),a=Math.min(255,(s>>16&255)+i),o=Math.min(255,(s>>8&255)+i),l=Math.min(255,(s&255)+i);return`#${(a<<16|o<<8|l).toString(16).padStart(6,"0")}`}}class Ic{static draw(e,t,s,i,a,o){const h=(s-640)/2,m=Math.floor(t.length/64),f=[];for(let v=0;v<64;v++){let y=0;for(let N=0;N<m;N++){const j=v*m+N;j<t.length&&(y+=t[j])}const w=y/m;f.push(w)}const p=this.smoothTransitions(f),g=this.createBarGradient(e,a,64,10,h);for(let v=0;v<64;v++){const y=h+v*10,w=p[v]/255*(i*.4);e.fillStyle=g,this.drawRoundedBar(e,y,i/2-w,8,w,4),o&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,y,i/2+2,8,w*.5,4),e.restore()),e.shadowBlur=o?4:0,e.shadowColor=a}e.shadowBlur=0,o&&this.drawParticles(e,p,h,10,i,a)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],s=.7;for(let i=0;i<e.length;i++){const a=this.previousHeights[i]||0,o=e[i],l=a*s+o*(1-s);t.push(l)}return this.previousHeights=t,t}static drawRoundedBar(e,t,s,i,a,o){e.beginPath(),e.moveTo(t,s+a),e.lineTo(t,s+o),e.arcTo(t,s,t+i,s,o),e.lineTo(t+i,s+o),e.arcTo(t+i,s,t+i,s+a,o),e.lineTo(t+i,s+a),e.closePath(),e.fill()}static createBarGradient(e,t,s,i,a){const o=e.createLinearGradient(a,0,a+s*i,0);return o.addColorStop(0,t),o.addColorStop(.5,this.adjustHue(t,30)),o.addColorStop(1,this.adjustHue(t,60)),o}static drawParticles(e,t,s,i,a,o){for(let c=0;c<t.length;c++)if(t[c]>200){const u=s+c*i+i/2,d=t[c]/255*(a*.4),h=a/2-d-10;e.fillStyle=o,e.globalAlpha=.5,e.beginPath(),e.arc(u,h,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const s=parseInt(e.replace("#",""),16),i=s>>16&255,a=s>>8&255,o=s&255,l=1+t/360,c=Math.min(255,i*l),u=Math.min(255,a*l),d=Math.min(255,o*l);return`#${(Math.floor(c)<<16|Math.floor(u)<<8|Math.floor(d)).toString(16).padStart(6,"0")}`}}It(Ic,"previousHeights",[]);class Ac{static draw(e,t,s,i,a,o){const l=s/2,c=i/2,u=Math.min(s,i)*.15,d=Math.min(s,i)*.45;o&&(this.rotation+=360/(60*60));const h=Math.min(t.length,180),m=Math.PI*2/h;for(let f=0;f<h;f++){const p=t[Math.floor(f*(t.length/h))],g=p/255*(d-u),v=f*m+this.rotation*(Math.PI/180),y=l+Math.cos(v)*u,w=c+Math.sin(v)*u,N=l+Math.cos(v)*(u+g),j=c+Math.sin(v)*(u+g),x=f/h*360;if(e.strokeStyle=`hsla(${x}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(y,w),e.lineTo(N,j),e.stroke(),o&&p>200){const k=l+Math.cos(v)*(u+g+5),S=c+Math.sin(v)*(u+g+5);e.fillStyle=`hsla(${x}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(k,S,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=a,e.lineWidth=2,e.beginPath(),e.arc(l,c,u,0,Math.PI*2),e.stroke(),o){const f=this.getAverageAmplitude(t),p=d+f/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=a,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=a,e.beginPath(),e.arc(l,c,p,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let s=0;s<e.length;s++)t+=e[s];return t/e.length}}It(Ac,"rotation",0);const Pv=({mode:n,frequencyData:e,timeDomainData:t,isPlaying:s,dominantColor:i="#D4AF37",width:a=800,height:o=200,mini:l=!1})=>{const c=_.useRef(null),u=_.useRef(null),d=_.useRef(0);return _.useEffect(()=>{const h=c.current;if(!h)return;const m=h.getContext("2d");if(!m)return;const f=l?1:Math.min(window.devicePixelRatio||1,2);h.width=a*f,h.height=o*f,h.style.width=`${a}px`,h.style.height=`${o}px`,m.scale(f,f);const g=1e3/(l?30:60),v=y=>{if(y-d.current<g){u.current=requestAnimationFrame(v);return}d.current=y,m.clearRect(0,0,a,o),n==="waveform"&&t?Ev.draw(m,t,a,o,i,s):n==="spectrum"&&e?Ic.draw(m,e,a,o,i,s):n==="radial"&&e&&Ac.draw(m,e,a,o,i,s),u.current=requestAnimationFrame(v)};return u.current=requestAnimationFrame(v),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[n,e,t,s,i,a,o,l]),r.jsx("canvas",{ref:c,style:{display:"block",margin:"0 auto",borderRadius:l?"4px":"8px"}})},Ov=({tags:n,centerX:e,centerY:t,isPlaying:s})=>{const[i,a]=_.useState([]),o=_.useRef(null),l=_.useRef(Date.now());_.useEffect(()=>{const u=[220,260,300,340,380],d=[12,10,8,6,4],h=n.map((f,p)=>360/n.length*p),m=n.slice(0,5).map((f,p)=>({text:f,radius:u[p]||300,speed:d[p]||8,angle:h[p]||0,scale:1,opacity:.6}));a(m)},[n]),_.useEffect(()=>{if(!s){o.current!==null&&(cancelAnimationFrame(o.current),o.current=null);return}const u=()=>{const d=Date.now(),h=(d-l.current)/1e3;l.current=d,a(m=>m.map((f,p)=>{let g=f.angle+f.speed*h;g=g%360;const v=p*.5,w=1+Math.sin((d/3e3+v)*Math.PI*2)*.05,N=.55+Math.sin((d/3e3+v)*Math.PI*2)*.15;return{...f,angle:g,scale:w,opacity:N}})),o.current=requestAnimationFrame(u)};return o.current=requestAnimationFrame(u),()=>{o.current!==null&&cancelAnimationFrame(o.current)}},[s]);const c=u=>u*Math.PI/180;return r.jsx("div",{className:"motif-orbit",children:i.map((u,d)=>{const h=e+u.radius*Math.cos(c(u.angle)),m=t+u.radius*Math.sin(c(u.angle));return r.jsx("div",{className:"motif-tag",style:{left:`${h}px`,top:`${m}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${d}`)})})},Dv=({album:n,isPlaying:e,currentTime:t,duration:s,volume:i,isMuted:a,shuffle:o,repeat:l,canPrevious:c,canNext:u,visualizationMode:d,queue:h,queueIndex:m,frequencyData:f,timeDomainData:p,onPlayPause:g,onPrevious:v,onNext:y,onSeek:w,onVolumeChange:N,onMuteToggle:j,onShuffle:x,onRepeat:k,onVisualizationModeChange:S,onSkipToIndex:b,onClose:T})=>{const{updateAlbum:A}=qt(),P=n?.id||null,[O,U]=_.useState("");_.useEffect(()=>{U(n?.memo||"")},[P]),_.useEffect(()=>{const D=Y=>{Y.key==="Escape"?T():Y.key===" "&&Y.target===document.body?(Y.preventDefault(),g()):Y.key==="ArrowLeft"?w(Math.max(0,t-5)):Y.key==="ArrowRight"?w(Math.min(s,t+5)):Y.key==="ArrowUp"?N(Math.min(1,i+.1)):Y.key==="ArrowDown"?N(Math.max(0,i-.1)):Y.key==="m"||Y.key==="M"?j():Y.key==="n"||Y.key==="N"?y():(Y.key==="p"||Y.key==="P")&&v()};return document.addEventListener("keydown",D),()=>document.removeEventListener("keydown",D)},[t,s,i,T,g,w,N,j,y,v]);const E="#D4AF37",I=n?.metadata?.motif_tags||[],F=_.useMemo(()=>"メモ（ひとこと）。聴きながら思い出したこと、今の気分、景色…",[]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"expanded-player-backdrop",onClick:T}),r.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[r.jsx("button",{className:"expanded-player-close",onClick:T,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),r.jsx("button",{className:"expanded-player-minimize",onClick:T,"aria-label":"Minimize player",title:"Minimize",children:"-"}),r.jsxs("div",{className:"expanded-player-content",children:[r.jsxs("div",{className:"expanded-player-album-section",children:[r.jsx("div",{className:"expanded-player-album-container",children:n&&r.jsxs(r.Fragment,{children:[r.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"expanded-player-album-image"}),I.length>0&&r.jsx(Ov,{tags:I,centerX:200,centerY:200,isPlaying:e})]})}),n&&r.jsxs("div",{className:"expanded-player-album-meta",children:[r.jsx("h2",{className:"expanded-player-album-title",children:n.title||n.mood}),n.musicMetadata&&r.jsxs("p",{className:"expanded-player-album-details",children:[n.musicMetadata.key," • ",n.musicMetadata.tempo," BPM • ",n.musicMetadata.timeSignature]}),n.musicMetadata?.character&&r.jsx("p",{className:"expanded-player-album-character",children:n.musicMetadata.character}),r.jsxs("div",{className:"expanded-player-memo",children:[r.jsx("div",{className:"expanded-player-memo-label",children:"メモ"}),r.jsx("textarea",{className:"expanded-player-memo-input",value:O,onChange:D=>U(D.target.value),onBlur:()=>{if(!n)return;const D=O.trim();(n.memo||"")!==D&&A(n.id,{memo:D||void 0})},placeholder:F,rows:2})]})]})]}),r.jsxs("div",{className:"expanded-player-visualization-section",children:[r.jsx(Pv,{mode:d,frequencyData:f,timeDomainData:p,isPlaying:e,dominantColor:E,width:800,height:200}),r.jsxs("div",{className:"visualization-mode-toggle",children:[r.jsx("button",{className:d==="waveform"?"active":"",onClick:()=>S("waveform"),title:"Waveform",children:"波形"}),r.jsx("button",{className:d==="spectrum"?"active":"",onClick:()=>S("spectrum"),title:"Spectrum Bars",children:"バー"}),r.jsx("button",{className:d==="radial"?"active":"",onClick:()=>S("radial"),title:"Radial Spectrum",children:"円形"})]})]}),r.jsxs("div",{className:"expanded-player-controls-section",children:[r.jsx(Cv,{isPlaying:e,canPrevious:c,canNext:u,shuffle:o,repeat:l,onPlayPause:g,onPrevious:v,onNext:y,onShuffle:x,onRepeat:k,expanded:!0}),r.jsx(Iv,{currentTime:t,duration:s,onSeek:w,color:E}),r.jsx(Av,{volume:i,isMuted:a,onVolumeChange:N,onMuteToggle:j,expanded:!0})]}),r.jsx(Mv,{queue:h,currentIndex:m,onSkipTo:b})]})]})]})},Rv=({album:n,queue:e=[]})=>{const{state:t,setPlaybackState:s,setCurrentTime:i,setDuration:a,setVolume:o,toggleMute:l,toggleShuffle:c,cycleRepeat:u,toggleExpanded:d,setVisualizationMode:h,play:m,pause:f,next:p,previous:g,skipToIndex:v,setQueue:y,setCurrentAlbumFull:w}=an(),N=_.useRef(Tv()),j=_.useRef(null),x=_.useRef(null),k=_.useRef(null),S=_.useRef(null),b=_.useRef(0),T=_.useRef(0),[A,P]=_.useState(()=>{try{return as.state==="running"}catch{return!1}}),[O,U]=_.useState(null),[E,I]=_.useState(null),F=R.useCallback(()=>{try{if(j.current)return;const X=as.createAnalyser();X.fftSize=2048,X.smoothingTimeConstant=.8,Fg().connect(X),j.current=X,x.current=new Uint8Array(X.frequencyBinCount),k.current=new Uint8Array(X.frequencyBinCount)}catch(X){console.error("[EnhancedMiniPlayer] Failed to initialize analyser:",X)}},[]);_.useEffect(()=>{let X=!1;const se=async()=>{const Ve=t.currentAlbum||n,K=b.current;if(Ve?.musicData&&!(K===0||K===T.current))try{if(await D(Ve),X)return;await Y(),T.current=K}catch(W){console.error("[EnhancedMiniPlayer] Pending autoplay failed after unlock:",W)}},ve=async()=>{try{if(await mi(),X)return;const Ve=as.state==="running";P(Ve),Ve&&(F(),await se())}catch(Ve){console.warn("[EnhancedMiniPlayer] Audio unlock failed:",Ve)}};try{if(as.state==="running"){P(!0),F();return}}catch{}const ke=()=>{ve(),window.removeEventListener("pointerdown",ke,!0),window.removeEventListener("keydown",ke,!0)};return window.addEventListener("pointerdown",ke,!0),window.addEventListener("keydown",ke,!0),()=>{if(X=!0,window.removeEventListener("pointerdown",ke,!0),window.removeEventListener("keydown",ke,!0),j.current){try{j.current.disconnect()}catch{}j.current=null}}},[n,F,t.currentAlbum,t.playRequestId]),_.useEffect(()=>{if(e.length>0){const X=n?e.findIndex(se=>se.id===n.id):0;y(e,Math.max(0,X))}else n&&y([n],0)},[n,e,y]),_.useEffect(()=>{const X=t.currentAlbum||n;X?.musicData&&(D(X),w(X))},[t.currentAlbum?.id,n?.id]),_.useEffect(()=>{t.playRequestId>0&&(b.current=t.playRequestId)},[t.playRequestId]),_.useEffect(()=>{const X=t.currentAlbum||n,se=b.current;if(!X?.musicData||se===0||se===T.current||!A)return;let ve=!1;return(async()=>{try{if(await D(X),ve)return;await Y(),T.current=se}catch(ke){console.error("[EnhancedMiniPlayer] Autoplay failed:",ke)}})(),()=>{ve=!0}},[t.currentAlbum?.id,n?.id,t.playRequestId,A]),_.useEffect(()=>{if(t.playbackState===bt.PLAYING&&j.current){let X;const se=()=>{!j.current||!x.current||!k.current||(j.current.getByteFrequencyData(x.current),j.current.getByteTimeDomainData(k.current),U(new Uint8Array(x.current)),I(new Uint8Array(k.current)),X=requestAnimationFrame(se))};return X=requestAnimationFrame(se),()=>{X&&cancelAnimationFrame(X)}}},[t.playbackState]);const D=async X=>{try{const se=N.current;await se.loadMIDI(X.musicData);const ve=se.getState();a(ve.duration)}catch(se){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",se)}},Y=async()=>{try{if(s(bt.LOADING),await mi(),as.state!=="running")throw s(bt.PAUSED),new Error("AudioContext is not running (user gesture required)");F();const X=N.current;await X.play(),m();const se=window.setInterval(()=>{const ve=X.getState();i(ve.currentTime),a(ve.duration),!ve.isPlaying&&!ve.isPaused&&(clearInterval(se),te())},100);S.current=se}catch(X){console.error("Failed to start playback:",X),s(bt.STOPPED)}},z=()=>{N.current.pause(),f(),S.current&&(clearInterval(S.current),S.current=null)},te=()=>{t.repeat==="one"?(ee(0),Y()):H()},Q=()=>{t.playbackState===bt.PLAYING?z():Y()},H=()=>{p(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Y()})})},$=()=>{g(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Y()})})},ee=X=>{N.current.seek(X),i(X)},V=X=>{o(X)},C=X=>{v(X),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Y()})})},L=t.queueIndex>0||t.repeat==="all",M=t.queueIndex<t.queue.length-1||t.repeat==="all",J=t.playbackState===bt.PLAYING;return _.useEffect(()=>()=>{S.current&&clearInterval(S.current)},[]),r.jsxs(r.Fragment,{children:[!t.isExpanded&&r.jsx(jv,{album:t.currentAlbum,isPlaying:J,currentTime:t.currentTime,duration:t.duration,onPlayPause:Q,onExpand:d}),t.isExpanded&&r.jsx(Dv,{album:t.currentAlbum,isPlaying:J,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:L,canNext:M,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:O,timeDomainData:E,onPlayPause:Q,onPrevious:$,onNext:H,onSeek:ee,onVolumeChange:V,onMuteToggle:l,onShuffle:c,onRepeat:u,onVisualizationModeChange:h,onSkipToIndex:C,onClose:d})]})};function Fv(){const{state:n}=an(),e=!!n.currentAlbumImage&&(n.playbackState===bt.PLAYING||n.playbackState===bt.PAUSED),t=_.useMemo(()=>`${n.currentAlbum?.id||"none"}:${n.playbackState}`,[n.currentAlbum?.id,n.playbackState]),[s,i]=_.useState(!1);return _.useEffect(()=>{const a=window.setTimeout(()=>i(e),e?40:0);return()=>window.clearTimeout(a)},[e]),n.currentAlbumImage?r.jsx("div",{className:`playback-backdrop ${s?"is-active":""} ${n.playbackState===bt.PLAYING?"is-playing":""}`,style:{backgroundImage:`url(${n.currentAlbumImage})`},"aria-hidden":"true"},t):null}function Lv({active:n,scopeLabel:e,statusText:t,elapsedSec:s=0,onCancel:i}){if(!n)return null;const o=.85-.35*Math.max(0,Math.min(1,s/22));return r.jsxs("div",{className:"gen-frost",style:{"--frost":o},"aria-live":"polite","aria-busy":"true",children:[r.jsx("div",{className:"gen-frost-surface"}),r.jsxs("div",{className:"gen-frost-card",role:"status",children:[r.jsxs("div",{className:"gen-frost-title",children:[r.jsx("span",{className:"gen-frost-title-main",children:"生成中"}),e?r.jsx("span",{className:"gen-frost-scope",children:e}):null]}),r.jsxs("div",{className:"gen-frost-status",children:[t||"進行中…",r.jsxs("span",{className:"gen-frost-elapsed",children:["（",s,"s）"]})]}),i?r.jsx("button",{className:"gen-frost-cancel",onClick:i,type:"button",children:"キャンセル"}):null]})]})}function Vv(){const{current:n}=vi();return r.jsx(Lv,{active:n.active,scopeLabel:n.scopeLabel,statusText:n.statusText,elapsedSec:n.elapsedSec,onCancel:n.onCancel})}function Uv(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function Bv(){try{new Function('return import("web-vitals")')().then(e=>{const t=s=>{console.log("[Web Vitals]",s)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}const qv={};function Wv(){const n=(()=>{try{const i=String(window.location.hostname||"").toLowerCase();return i.endsWith(".vercel.app")||i.endsWith(".now.sh")}catch{return!1}})();if(!(String(qv?.VITE_ENABLE_VERCEL_ANALYTICS||"").trim()==="1"||n)){console.log("[Analytics] Vercel analytics disabled (non-Vercel host)");return}const t=document.createElement("script");t.type="module",t.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const s=document.createElement("script");s.type="module",s.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(t),document.head.appendChild(s)}Uv(),Bv(),Wv();const $v="airia_onboarding_data",Ga="airia_post_onboarding_room",Jt="airia_preauth_view_v1";function za(){try{const n=String(window.location.hash||"").trim().toLowerCase();return n==="#terms"?"terms":n==="#privacy"?"privacy":n==="#login"||n==="#signup"?"auth":null}catch{return null}}function Ya(){try{if(os())return!1;const n=localStorage.getItem($v);return n?!!JSON.parse(n)?.completedAt:!1}catch{return!1}}function Gv(){try{const n=localStorage.getItem(Ga);if(!n)return null;localStorage.removeItem(Ga);const e=String(n);return["main","gallery","album","music","social","me","settings","admin","info","feedback"].includes(e)?e:null}catch{return null}}const zv=()=>{const[n,e]=_.useState(!0),[t,s]=_.useState(()=>{try{const x=za();if(x)return x;const k=sessionStorage.getItem(Jt);return k==="auth"||k==="terms"||k==="privacy"?k:"landing"}catch{return"landing"}}),[i,a]=_.useState(()=>{try{return Ya()}catch{return!1}}),{getSelectedAlbum:o,albums:l}=qt(),{state:c}=an(),{user:u,bootLoading:d}=hr(),h=o();_.useEffect(()=>{const x=()=>{const k=za();if(k){s(k);try{sessionStorage.setItem(Jt,k)}catch{}return}try{const b=sessionStorage.getItem(Jt)==="auth"?"auth":"landing";s(b),sessionStorage.setItem(Jt,b)}catch{s("landing")}};return window.addEventListener("hashchange",x),()=>window.removeEventListener("hashchange",x)},[]);const m=R.useCallback(()=>{s("auth");try{sessionStorage.setItem(Jt,"auth"),window.location.hash="#login"}catch{}},[]),f=R.useCallback(()=>{s("landing");try{sessionStorage.setItem(Jt,"landing"),window.location.hash=""}catch{}},[]),p=R.useCallback(()=>{s("terms");try{sessionStorage.setItem(Jt,"terms"),window.location.hash="#terms"}catch{}},[]),g=R.useCallback(()=>{s("privacy");try{sessionStorage.setItem(Jt,"privacy"),window.location.hash="#privacy"}catch{}},[]),v=l.filter(x=>x.musicData),y=!!(ls()||"".toLowerCase()==="true"),w=i?[{id:"main",name:"Main",component:r.jsx(uu,{})},{id:"gallery",name:"Gallery",component:r.jsx(yu,{})},{id:"album",name:"Album",component:r.jsx(Su,{})},{id:"music",name:"Music",component:r.jsx(ku,{})},{id:"social",name:"Social",component:r.jsx(Ou,{})},{id:"me",name:"My",component:r.jsx(Lu,{})},...y?[{id:"admin",name:"Admin",component:r.jsx(Bu,{})}]:[],{id:"info",name:"Info",component:r.jsx(Wu,{})},{id:"feedback",name:"Feedback",component:r.jsx($u,{})}]:[{id:"onboarding",name:"はじめに",component:r.jsx(eu,{onExit:()=>{a(Ya())}})}],N=i?Gv()??"main":null,j=i?N==="settings"?"me":N:"onboarding";return r.jsxs(r.Fragment,{children:[n&&r.jsx(zu,{onDismiss:()=>e(!1)}),!n&&r.jsxs(r.Fragment,{children:[r.jsx(Fv,{}),r.jsxs("div",{className:"app-ui-layer",children:[r.jsx(Vv,{}),d?r.jsx("div",{className:"preauth-shell",children:r.jsx("div",{className:"loading-panel","aria-live":"polite","aria-busy":"true",children:r.jsx("div",{className:"loading-card",children:r.jsxs("div",{className:"loading-row",children:[r.jsx("img",{className:"loading-logo",src:"/img/airia-logo.png",alt:"","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("p",{className:"loading-title",children:"ログイン状態を確認しています…"}),r.jsx("p",{className:"loading-sub",children:"通信環境によっては時間がかかる場合があります。画面はこのままでお待ちください。"})]})]})})})}):u?r.jsxs(r.Fragment,{children:[r.jsx(vl,{rooms:w,initialRoom:j},i?"onboarded":"needs-onboarding"),r.jsx(Rv,{album:h||void 0,queue:v})]}):r.jsx("div",{className:"preauth-shell",children:t==="auth"?r.jsx(nu,{onBack:f}):t==="terms"?r.jsx(xa,{kind:"terms",onBack:f,onStart:m}):t==="privacy"?r.jsx(xa,{kind:"privacy",onBack:f,onStart:m}):r.jsx(su,{onStart:m,onOpenTerms:p,onOpenPrivacy:g})})]})]})]})},Yv=()=>r.jsx(R.StrictMode,{children:r.jsx(al,{children:r.jsx(Yc,{children:r.jsx(tl,{children:r.jsx(Wc,{children:r.jsx(sl,{children:r.jsx(rl,{children:r.jsx(Zl,{children:r.jsx(zv,{})})})})})})})})});qc.createRoot(document.getElementById("root")).render(r.jsx(Yv,{}));
//# sourceMappingURL=index-BcJKVsFh.js.map
