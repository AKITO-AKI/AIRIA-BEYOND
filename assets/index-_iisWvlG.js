var Nc=Object.defineProperty;var Sc=(s,e,t)=>e in s?Nc(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var jt=(s,e,t)=>Sc(s,typeof e!="symbol"?e+"":e,t);import{r as _,j as r,R,a as kc,C as Ws,u as ps,V as Ht,B as on,L as jc,b as ks,c as Yi,M as Tc,D as Va,d as Ua,N as Vn,e as Hi,f as Cc,T as Ic,S as Ac,H as Xi,g as Pn,h as Mc,P as Ec,i as Oc,k as Ts,l as Pc}from"./vendor-three-CT2GzliT.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const Mr=s=>{if(!s)return 30;const e=20,t=60,n=30,i=180,a=Math.max(n,Math.min(i,s));return e+(a-n)/(i-n)*(t-e)},Ji=s=>{const t=Math.floor(s/10),n=s%10;return{shelfIndex:Math.min(t,4),positionIndex:n}},Er=s=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let n=0;n<s.length;n++)t=(t<<5)-t+s.charCodeAt(n),t=t&t;return e[Math.abs(t)%e.length]},Ba=_.createContext(void 0),Ki="airia-albums",Dc=({children:s})=>{const[e,t]=_.useState([]),[n,i]=_.useState(null);_.useEffect(()=>{try{const u=localStorage.getItem(Ki);if(u){const d=JSON.parse(u);t(d)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),_.useEffect(()=>{try{localStorage.setItem(Ki,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const a=u=>{const d={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()},h=Ji(0),m=Mr(d.musicMetadata?.duration),f=Er(d.imageDataURL),p={...d,gallery:{shelfIndex:h.shelfIndex,positionIndex:h.positionIndex,thickness:m,spineColor:f}};return t(g=>[p,...g].map((b,w)=>{const S=Ji(w),A=Mr(b.musicMetadata?.duration),x=b.gallery?.spineColor||Er(b.imageDataURL);return{...b,gallery:{shelfIndex:S.shelfIndex,positionIndex:S.positionIndex,thickness:A,spineColor:x}}})),p},o=(u,d)=>{t(h=>h.map(m=>{if(m.id!==u)return m;const f={...m,...d};if(d.imageDataURL){const p=f.gallery?.spineColor||Er(f.imageDataURL);return{...f,gallery:{...f.gallery||{shelfIndex:0,positionIndex:0,thickness:Mr(f.musicMetadata?.duration),spineColor:p},spineColor:p}}}return f}))},l=u=>{i(u)},c=()=>n&&e.find(u=>u.id===n)||null;return r.jsx(Ba.Provider,{value:{albums:e,selectedAlbumId:n,addAlbum:a,updateAlbum:o,selectAlbum:l,getSelectedAlbum:c},children:s})},Lt=()=>{const s=_.useContext(Ba);if(s===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return s},qa=_.createContext(void 0),Or="airia-causal-logs",Rc=30;function Fc(s){return s&&{mood:s.mood,duration:s.duration,timestamp:s.timestamp,customInput:s.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:s.onboardingAnswers?"[onboarding data - summary only]":void 0}}function Lc(s){const e=new Date;return e.setDate(e.getDate()-Rc),s.filter(t=>new Date(t.createdAt)>=e)}const Vc=({children:s})=>{const[e,t]=_.useState([]);_.useEffect(()=>{try{const h=localStorage.getItem(Or);if(h){const f=JSON.parse(h).map(g=>({...g,createdAt:new Date(g.createdAt),input:{...g.input,timestamp:new Date(g.input.timestamp)},analysis:g.analysis?{...g.analysis,timestamp:new Date(g.analysis.timestamp)}:void 0,imageGeneration:g.imageGeneration?{...g.imageGeneration,timestamp:new Date(g.imageGeneration.timestamp)}:void 0,musicGeneration:g.musicGeneration?{...g.musicGeneration,timestamp:new Date(g.musicGeneration.timestamp)}:void 0,album:g.album?{...g.album,timestamp:new Date(g.album.timestamp)}:void 0,errors:g.errors?.map(v=>({...v,timestamp:new Date(v.timestamp)}))})),p=Lc(f);t(p)}}catch(h){console.error("[CausalLog] Failed to load logs from localStorage:",h)}},[]),_.useEffect(()=>{try{localStorage.setItem(Or,JSON.stringify(e))}catch(h){console.error("[CausalLog] Failed to save logs to localStorage:",h)}},[e]);const n=(h,m)=>{const f=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,p={id:f,sessionId:h,createdAt:new Date,input:Fc(m),totalDuration:0,success:!1};return t(g=>[...g,p]),console.log("[CausalLog] Created log:",f,"for session:",h),f},i=h=>e.find(m=>m.id===h),a=h=>e.find(m=>m.sessionId===h),o=(h,m)=>{t(f=>f.map(p=>{if(p.id===h){const g={...p,...m};if(g.analysis||g.imageGeneration||g.musicGeneration){const v=[g.analysis?.duration||0,g.imageGeneration?.duration||0,g.musicGeneration?.duration||0];g.totalDuration=v.reduce((b,w)=>b+w,0)}return g}return p})),console.log("[CausalLog] Updated log:",h)},l=h=>{t(m=>m.filter(f=>f.id!==h)),console.log("[CausalLog] Deleted log:",h)},c=()=>{t([]),localStorage.removeItem(Or),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(h=>({id:h.id,sessionId:h.sessionId,createdAt:h.createdAt,success:h.success,totalDuration:h.totalDuration,albumId:h.album?.albumId})),d=h=>{const m=i(h);if(!m)throw new Error(`Log ${h} not found`);return JSON.stringify(m,null,2)};return r.jsx(qa.Provider,{value:{logs:e,createLog:n,getLog:i,getLogBySessionId:a,updateLog:o,deleteLog:l,clearAllLogs:c,getLogSummaries:u,exportLog:d},children:s})},Wa=()=>{const s=_.useContext(qa);if(s===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return s},_t="https://airia-beyond.onrender.com",Wr="airia_auth_token_v1";function Dn(){try{return String(localStorage.getItem(Wr)||"")}catch{return""}}function xs(s){try{s?localStorage.setItem(Wr,s):localStorage.removeItem(Wr)}catch{}}async function yt(s,e={}){const t=Dn(),n=new Headers(e.headers||{});return t&&n.set("Authorization",`Bearer ${t}`),fetch(s,{...e,headers:n})}async function es(s){return s.json().catch(()=>null)}function cn(s){const e=s instanceof Error?s.message:String(s);return/failed to fetch/i.test(e)||/networkerror/i.test(e)||/load failed/i.test(e)||/timeout/i.test(e)}function ln(s){const e=_t,t=(()=>{try{return window.location.origin}catch{return"(unknown)"}})();return[`${s} に失敗しました（通信エラー）`,`API: ${e}`,`Origin: ${t}`,"原因候補: VITE_API_BASE_URL 未設定/誤り、APIサーバ停止、CORS未許可（Render側 APP_PUBLIC_URL / APP_ALLOWED_ORIGINS）"].join(`
`)}function un(s){try{if(window.location.protocol==="https:"&&/^http:\/\//i.test(_t))throw new Error(`${s} に失敗しました（Mixed Content）。
HTTPS のページから HTTP の API（${_t}）へは接続できません。API を https:// にするか、VITE_API_BASE_URL をHTTPSのURLにしてください。`)}catch{}}async function dn(s,e,t){const n=String(s.headers.get("content-type")||"").toLowerCase();if(e==null){if(s.ok&&n.includes("text/html"))throw new Error(`${t} に失敗しました（API応答がHTMLでした）。VITE_API_BASE_URL がフロントに向いている可能性があります。`);if(s.ok&&!n.includes("application/json"))throw new Error(`${t} に失敗しました（API応答がJSONではありません）。API設定を確認してください。`)}}async function Uc(s){try{un("新規登録");const e=await fetch(`${_t}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await es(e);if(await dn(e,t,"新規登録"),!e.ok)throw new Error(t?.message||`Failed to register: ${e.status}`);if(!t?.user)throw new Error("新規登録に失敗しました（API応答が不正です）");return t}catch(e){throw cn(e)?new Error(ln("新規登録")):e}}async function Bc(s){try{un("ログイン");const e=await fetch(`${_t}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await es(e);if(await dn(e,t,"ログイン"),!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);if(!t?.token||!t?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return t}catch(e){throw cn(e)?new Error(ln("ログイン")):e}}async function qc(s){try{un("ログイン");const e=await fetch(`${_t}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await es(e);if(await dn(e,t,"ログイン"),!e.ok)throw new Error(t?.message||`Failed to login: ${e.status}`);if(!t?.token||!t?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return t}catch(e){throw cn(e)?new Error(ln("ログイン")):e}}async function Zi(s,e){try{un("ログイン");const t=await fetch(`${_t}/api/auth/oauth/${encodeURIComponent(s)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await es(t);if(await dn(t,n,"OAuthログイン"),!t.ok)throw new Error(n?.message||`Failed to login: ${t.status}`);if(!n?.token||!n?.user)throw new Error("ログインに失敗しました（API応答が不正です）");return n}catch(t){throw cn(t)?new Error(ln("ログイン")):t}}async function Wc(){const s=await yt(`${_t}/api/auth/me`),e=await es(s);if(!s.ok)throw new Error(e?.message||`Failed to load me: ${s.status}`);return e}async function Gc(){const s=await yt(`${_t}/api/auth/logout`,{method:"POST"}),e=await es(s);if(!s.ok)throw new Error(e?.message||`Failed to logout: ${s.status}`);return e}async function $c(s){const e=await yt(`${_t}/api/auth/me`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await es(e);if(!e.ok)throw new Error(t?.message||`Failed to update profile: ${e.status}`);return t}async function zc(){try{un("認証設定の取得");const s=await fetch(`${_t}/api/auth/config`),e=await es(s);if(await dn(s,e,"認証設定の取得"),!s.ok)throw new Error(e?.message||`Failed to load auth config: ${s.status}`);return e}catch(s){throw cn(s)?new Error(ln("認証設定の取得")):s}}const Ga=R.createContext(null);function nr(){const s=R.useContext(Ga);if(!s)throw new Error("useAuth must be used within AuthProvider");return s}const Yc=({children:s})=>{const[e,t]=R.useState(null),[n,i]=R.useState(!0),[a,o]=R.useState(!1),[l,c]=R.useState(()=>Dn()),u=R.useRef(0),d=R.useRef(!1),h=R.useCallback(()=>(u.current+=1,u.current),[]),m=R.useCallback(T=>u.current===T,[]),f=R.useCallback(async()=>{const T=h(),k=Dn();if(c(k),!k){m(T)&&(t(null),i(!1));return}try{const y=k,j=await Wc();if(!m(T)||Dn()!==y)return;t(j.user),j.user||(xs(null),c(""))}catch(y){if(!m(T))return;const j=y instanceof Error?y.message:String(y);/failed to fetch/i.test(j)||/networkerror/i.test(j)||/load failed/i.test(j)||/timeout/i.test(j)||t(null)}finally{m(T)&&i(!1)}},[h,m]);R.useEffect(()=>{d.current||(d.current=!0,f())},[f]);const p=R.useCallback(async T=>{const k=h();o(!0);try{const y=await Zi("google",{idToken:T});if(!m(k))return;xs(y.token),c(y.token),t(y.user)}finally{m(k)&&o(!1)}},[h,m]),g=R.useCallback(async(T,k)=>{const y=h();o(!0);try{const j=await Zi("apple",{idToken:T,user:k||void 0});if(!m(y))return;xs(j.token),c(j.token),t(j.user)}finally{m(y)&&o(!1)}},[h,m]),v=R.useCallback(async T=>{const k=h();o(!0);try{const y=String(T?.identifier||"").trim(),j=String(T?.password||""),C=y.includes("@")?await qc({email:y,password:j}):await Bc({handle:y,password:j});if(!m(k))return;xs(C.token),c(C.token),t(C.user)}finally{m(k)&&o(!1)}},[h,m]),b=R.useCallback(async T=>{const k=h();o(!0);try{const y=String(T?.email||"").trim(),j=String(T?.password||""),C=T?.displayName,O=T?.handle;if(await Uc({email:y,password:j,displayName:C,handle:O}),!m(k))return;xs(null),c(""),t(null)}finally{m(k)&&o(!1)}},[h,m]),w=R.useCallback(async()=>{const T=h();o(!0);try{await Gc().catch(()=>null)}finally{if(!m(T))return;xs(null),c(""),t(null),o(!1)}},[h,m]),S=R.useCallback(async T=>{const k=h();o(!0);try{const y=await $c(T);if(!m(k))return;t(y.user)}finally{m(k)&&o(!1)}},[h,m]),A=R.useCallback(T=>{t(k=>k&&{...k,followingIds:Array.isArray(T)?T:[]})},[]),x={user:e,bootLoading:n,busy:a,token:l,refresh:f,loginWithGoogle:p,loginWithApple:g,loginWithPassword:v,registerWithPassword:b,logout:w,updateProfile:S,updateFollowingIds:A};return r.jsx(Ga.Provider,{value:x,children:s})};var Tt=(s=>(s.STOPPED="STOPPED",s.PLAYING="PLAYING",s.PAUSED="PAUSED",s.LOADING="LOADING",s))(Tt||{});const $a=_.createContext(void 0),Hc=.7,Xc=({children:s})=>{const[e,t]=_.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:Hc,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),n=_.useCallback(y=>{t(j=>({...j,playbackState:y?"PLAYING":"PAUSED"}))},[]),i=_.useCallback((y,j)=>{t(C=>({...C,currentAlbumImage:y,currentTrackTitle:j}))},[]),a=_.useCallback(y=>{t(j=>({...j,playbackState:y}))},[]),o=_.useCallback(y=>{t(j=>({...j,currentAlbum:y,currentAlbumImage:y?.imageDataURL,currentTrackTitle:y?y.title||y.mood:void 0}))},[]),l=_.useCallback((y,j=0)=>{t(C=>({...C,queue:y,queueIndex:j,currentAlbum:y[j]||null,currentAlbumImage:y[j]?.imageDataURL,currentTrackTitle:y[j]?y[j].title||y[j].mood:void 0}))},[]),c=_.useCallback(y=>{t(j=>({...j,currentTime:y}))},[]),u=_.useCallback(y=>{t(j=>({...j,duration:y}))},[]),d=_.useCallback(y=>{const j=Math.max(0,Math.min(1,y));t(C=>({...C,volume:j}))},[]),h=_.useCallback(()=>{t(y=>({...y,isMuted:!y.isMuted}))},[]),m=_.useCallback(()=>{t(y=>({...y,shuffle:!y.shuffle}))},[]),f=_.useCallback(()=>{t(y=>{const j=["off","all","one"],O=(j.indexOf(y.repeat)+1)%j.length;return{...y,repeat:j[O]}})},[]),p=_.useCallback(()=>{t(y=>({...y,isExpanded:!y.isExpanded}))},[]),g=_.useCallback(y=>{t(j=>({...j,isExpanded:y}))},[]),v=_.useCallback(y=>{t(j=>({...j,visualizationMode:y}))},[]),b=_.useCallback((y,j)=>{t(C=>{const O=j&&j.length>0?j:C.queue,P=O.length>0?O:[y],U=Math.max(0,P.findIndex(I=>I.id===y.id)),E=P[U]||y;return{...C,queue:P,queueIndex:U,currentAlbum:E,currentAlbumImage:E.imageDataURL,currentTrackTitle:E.title||E.mood,currentTime:0,playRequestId:C.playRequestId+1,isExpanded:!0}})},[]),w=_.useCallback(()=>{t(y=>({...y,playbackState:"PLAYING"}))},[]),S=_.useCallback(()=>{t(y=>({...y,playbackState:"PAUSED"}))},[]),A=_.useCallback(()=>{t(y=>({...y,playbackState:"STOPPED",currentTime:0}))},[]),x=_.useCallback(()=>{t(y=>{if(y.queue.length===0)return y;let j=y.queueIndex+1;if(j>=y.queue.length)if(y.repeat==="all")j=0;else return{...y,playbackState:"STOPPED"};const C=y.queue[j];return{...y,queueIndex:j,currentAlbum:C,currentAlbumImage:C.imageDataURL,currentTrackTitle:C.mood,currentTime:0}})},[]),T=_.useCallback(()=>{t(y=>{if(y.queue.length===0)return y;if(y.currentTime>3)return{...y,currentTime:0};let j=y.queueIndex-1;if(j<0)if(y.repeat==="all")j=y.queue.length-1;else return y;const C=y.queue[j];return{...y,queueIndex:j,currentAlbum:C,currentAlbumImage:C.imageDataURL,currentTrackTitle:C.mood,currentTime:0}})},[]),k=_.useCallback(y=>{t(j=>{if(y<0||y>=j.queue.length)return j;const C=j.queue[y];return{...j,queueIndex:y,currentAlbum:C,currentAlbumImage:C.imageDataURL,currentTrackTitle:C.mood,currentTime:0}})},[]);return r.jsx($a.Provider,{value:{state:e,setPlaying:n,setCurrentAlbum:i,setPlaybackState:a,setCurrentAlbumFull:o,setQueue:l,setCurrentTime:c,setDuration:u,setVolume:d,toggleMute:h,toggleShuffle:m,cycleRepeat:f,toggleExpanded:p,setExpanded:g,setVisualizationMode:v,requestPlayAlbum:b,play:w,pause:S,stop:A,next:x,previous:T,skipToIndex:k},children:s})},ts=()=>{const s=_.useContext($a);if(!s)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return s},za=_.createContext(void 0),Gs=()=>{const s=_.useContext(za);if(!s)throw new Error("useToast must be used within ToastProvider");return s},Jc=({children:s})=>{const[e,t]=_.useState([]),n=_.useCallback((a,o,l=4e3)=>{const c=`toast-${Date.now()}-${Math.random()}`,u={id:c,type:a,message:o,duration:l};t(h=>[...h,u]);const d=setTimeout(()=>{i(c)},l);return()=>clearTimeout(d)},[]),i=_.useCallback(a=>{t(o=>o.filter(l=>l.id!==a))},[]);return r.jsxs(za.Provider,{value:{toasts:e,addToast:n,removeToast:i},children:[s,r.jsx(Kc,{toasts:e})]})},Kc=({toasts:s})=>r.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:s.map(e=>r.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[r.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),r.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class Zc extends _.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(i=>{i.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?r.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[r.jsx("h1",{children:"エラーが発生しました"}),r.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),r.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const Ya=_.createContext(void 0),Qc=({value:s,children:e})=>r.jsx(Ya.Provider,{value:s,children:e}),Ut=()=>{const s=_.useContext(Ya);if(!s)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return s},Ha=({open:s,onOpenChange:e,title:t,description:n,children:i,footer:a,size:o="md"})=>{const l=_.useId(),c=_.useId();return _.useEffect(()=>{if(!s)return;const u=d=>{d.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[s,e]),s?kc.createPortal(r.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[r.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),r.jsxs("div",{className:`dialog-surface dialog-${o}`,role:"dialog","aria-modal":"true","aria-labelledby":l,"aria-describedby":n?c:void 0,children:[r.jsxs("header",{className:"dialog-header",children:[r.jsxs("div",{children:[r.jsx("h2",{id:l,className:"dialog-title",children:t}),n&&r.jsx("p",{id:c,className:"dialog-description",children:n})]}),r.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),r.jsx("div",{className:"dialog-body",children:i}),a?r.jsx("footer",{className:"dialog-footer",children:a}):null]})]}),document.body):null},Qi="airia_feedback_nudge_open_count_v1",ea="airia_feedback_nudge_last_shown_at_v1";function el(s){try{const e=localStorage.getItem(s),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function tl(s,e){try{localStorage.setItem(s,String(Math.trunc(e)))}catch{}}function sl(s){try{const e=localStorage.getItem(s),t=e?Number(e):0;return Number.isFinite(t)?Math.trunc(t):0}catch{return 0}}function nl(s,e){try{localStorage.setItem(s,String(Math.trunc(e)))}catch{}}function rl(s){return s?(Date.now()-s)/(24*60*60*1e3):Number.POSITIVE_INFINITY}const il=()=>{const{currentRoomId:s,navigateToRoom:e}=Ut(),[t,n]=R.useState(!1),i=R.useRef(null);R.useEffect(()=>{if(s==="onboarding"||s==="feedback")return;const o=el(Qi)+1;tl(Qi,o);const l=sl(ea);if(rl(l)<10||o<4)return;const u=o<10?.05:.08;if(!(Math.random()>u))return i.current=window.setTimeout(()=>{document.visibilityState==="visible"&&(nl(ea,Date.now()),n(!0))},7e3),()=>{i.current&&window.clearTimeout(i.current),i.current=null}},[s]);const a=()=>{n(!1),e("feedback")};return r.jsx(Ha,{open:t,onOpenChange:n,title:"フィードバックしませんか？",description:"短くてOK。気づいたことを教えてください。",size:"sm",footer:r.jsxs(r.Fragment,{children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>n(!1),children:"今はしない"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:a,children:"書く"})]}),children:r.jsx("p",{style:{margin:0,lineHeight:1.7},children:"バグ報告・改善案・良かった点、どれでも歓迎です。 送信時に診断情報も添付できるので、原因調査が早くなります。"})})};function al({roomId:s}){const e={width:18,height:18,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0};switch(s){case"main":return r.jsx("svg",{...e,children:r.jsx("path",{d:"M4 11.5L12 5l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-8.5z",stroke:"currentColor",strokeWidth:"1.8"})});case"gallery":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M5 6.5A2.5 2.5 0 0 1 7.5 4h9A2.5 2.5 0 0 1 19 6.5v11A2.5 2.5 0 0 1 16.5 20h-9A2.5 2.5 0 0 1 5 17.5v-11z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M8 14l2.2-2.2a1 1 0 0 1 1.4 0L15 15l1.2-1.2a1 1 0 0 1 1.4 0L19 15.2",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"}),r.jsx("path",{d:"M9 9.5h.01",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round"})]});case"album":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M7 4h10a2 2 0 0 1 2 2v14H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M9 8h8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M9 12h8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"music":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M10 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M18 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M12 16V6l8-2v10",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})]});case"social":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M8.5 13.5a3 3 0 1 1 0-6 3 3 0 0 1 0 6z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M16.5 12.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M4.5 20c.6-2.9 2.7-4.8 6-4.8s5.4 1.9 6 4.8",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M14 20c.3-1.8 1.4-3.1 3.4-3.1 1.8 0 2.7.6 3.1 1.7",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"me":case"settings":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 12.4a3.4 3.4 0 1 0 0-6.8 3.4 3.4 0 0 0 0 6.8z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M5 20c.9-3.6 3.6-5.6 7-5.6s6.1 2 7 5.6",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});case"admin":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 2l8 4v6c0 5-3.4 9.6-8 10-4.6-.4-8-5-8-10V6l8-4z",stroke:"currentColor",strokeWidth:"1.8",strokeLinejoin:"round"}),r.jsx("path",{d:"M9.2 12.3l1.8 1.9 3.9-4.3",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})]});case"info":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z",stroke:"currentColor",strokeWidth:"1.8"}),r.jsx("path",{d:"M12 10.6V16",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M12 8.2h.01",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round"})]});case"feedback":return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M5 6.5A2.5 2.5 0 0 1 7.5 4h9A2.5 2.5 0 0 1 19 6.5v7A2.5 2.5 0 0 1 16.5 16H11l-4.2 3.2c-.6.5-1.8.1-1.8-.8V6.5z",stroke:"currentColor",strokeWidth:"1.8",strokeLinejoin:"round"}),r.jsx("path",{d:"M8.2 8.8h7.6",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M8.2 12h5.2",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]});default:return r.jsxs("svg",{...e,children:[r.jsx("path",{d:"M6 12h12",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),r.jsx("path",{d:"M12 6v12",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]})}}const ol=({rooms:s,initialRoom:e="main"})=>{const t=s.findIndex(L=>L.id===e),[n,i]=_.useState(t>=0?t:0),[a,o]=_.useState(!1),[l,c]=_.useState(!0),[u,d]=_.useState(!1),[h,m]=_.useState(0),[f,p]=_.useState(0),[g,v]=_.useState(0),[b,w]=_.useState(null),S=_.useRef(null);_.useEffect(()=>{const L=window.matchMedia("(max-width: 860px)"),H=()=>{o(L.matches)};return H(),typeof L.addEventListener=="function"?(L.addEventListener("change",H),()=>L.removeEventListener("change",H)):(L.addListener(H),()=>L.removeListener(H))},[]),_.useEffect(()=>{c(!a)},[a]);const A=L=>L instanceof Element?!!L.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,x=L=>{A(L.target)||(d(!0),m(L.touches[0].clientX),p(L.touches[0].clientY),w(null))},T=L=>{if(!u)return;const H=L.touches[0].clientX,Y=L.touches[0].clientY,ee=H-h,se=Y-f;if(!b){const B=Math.abs(ee),M=Math.abs(se);if(B<6&&M<6)return;if(M>B*1.2){w("vertical"),d(!1),v(0);return}w("horizontal")}b==="horizontal"&&(L.preventDefault(),v(ee))},k=()=>{if(!u)return;d(!1),Math.abs(g)>100&&(g>0&&n>0?i(n-1):g<0&&n<s.length-1&&i(n+1)),v(0),w(null)},y=L=>{A(L.target)||(d(!0),m(L.clientX),p(L.clientY),w(null))},j=L=>{if(!u)return;L.preventDefault();const H=L.clientX-h,Y=L.clientY-f;if(!b){const ee=Math.abs(H),se=Math.abs(Y);if(ee<6&&se<6)return;if(se>ee*1.2){w("vertical"),d(!1),v(0);return}w("horizontal")}b==="horizontal"&&v(H)},C=()=>{if(!u)return;d(!1),Math.abs(g)>100&&(g>0&&n>0?i(n-1):g<0&&n<s.length-1&&i(n+1)),v(0),w(null)},O=()=>{u&&(Math.abs(g)>100&&(g>0&&n>0?i(n-1):g<0&&n<s.length-1&&i(n+1)),d(!1),v(0),w(null))},P=L=>{i(L),v(0)},U=S.current?.clientWidth||window.innerWidth||1,E=-n*100+g/U*100,I=s[n]?.id,V=I!=="onboarding",F=_.useMemo(()=>V?s:[],[s,V]),X=L=>{const H=L==="settings"?"me":L,Y=s.findIndex(ee=>ee.id===H);Y>=0&&P(Y)},z=L=>{P(L),a&&c(!1)};return _.useEffect(()=>{const L=H=>{H.key==="Escape"&&c(!1)};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[]),r.jsxs(Qc,{value:{currentRoomId:I,navigateToRoom:X},children:[r.jsx(il,{}),r.jsxs("div",{className:`room-navigator ${V?"":"indicators-hidden"}`,children:[V&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:`room-sidebar-backdrop ${l&&a?"open":""}`,onClick:()=>c(!1),"aria-hidden":"true"}),r.jsxs("aside",{className:`room-sidebar ${l?"open":"closed"} ${a?"narrow":"wide"}`,"aria-label":"ナビゲーション",children:[r.jsxs("div",{className:"room-sidebar-top",children:[r.jsxs("button",{type:"button",className:"room-sidebar-toggle",onClick:()=>c(L=>!L),"aria-label":l?"サイドバーを閉じる":"サイドバーを開く","aria-expanded":l,children:[r.jsx("span",{className:"room-sidebar-toggle-bar"}),r.jsx("span",{className:"room-sidebar-toggle-bar"}),r.jsx("span",{className:"room-sidebar-toggle-bar"})]}),r.jsx("div",{className:"room-sidebar-brand",children:"AIRIA"})]}),r.jsx("nav",{className:"room-sidebar-nav","aria-label":"ルーム一覧",children:F.map((L,H)=>r.jsxs("button",{type:"button",className:`room-sidebar-item ${H===n?"active":""}`,onClick:()=>z(H),"aria-current":H===n?"page":void 0,"aria-label":`${L.name}へ移動`,title:L.name,children:[r.jsx("span",{className:"room-sidebar-icon","aria-hidden":"true",children:r.jsx(al,{roomId:L.id})}),r.jsx("span",{className:"room-sidebar-item-label",children:L.name})]},L.id))})]}),a&&!l?r.jsxs("button",{type:"button",className:"room-sidebar-fab",onClick:()=>c(!0),"aria-label":"ナビゲーションを開く",children:[r.jsx("span",{className:"room-sidebar-fab-bar"}),r.jsx("span",{className:"room-sidebar-fab-bar"}),r.jsx("span",{className:"room-sidebar-fab-bar"})]}):null]}),r.jsx("main",{className:`room-stage ${V?"with-sidebar":""} ${l?"sidebar-open":"sidebar-closed"}`,children:r.jsx("div",{ref:S,className:"rooms-container",onTouchStart:x,onTouchMove:T,onTouchEnd:k,onMouseDown:y,onMouseMove:j,onMouseUp:C,onMouseLeave:O,style:{transform:`translateX(${E}%)`,transition:u?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:s.map(L=>r.jsx("div",{className:"room",children:L.component},L.id))})})]})]})},ta="airia_onboarding_data",cl=[{value:"talk",title:"会話から",desc:"やさしく整えてから、次へ"},{value:"create",title:"創作から",desc:"早く作品に進みたい"}],ll=[{value:"今日",title:"今日",desc:"いちばん最近の出来事"},{value:"今週",title:"今週",desc:"数日の範囲"},{value:"今月",title:"今月",desc:"少し長め"},{value:"少し前",title:"少し前",desc:"はっきりしない/覚えてない"}],ul=[{value:"朝",title:"朝",desc:"スタートを整えたい"},{value:"昼",title:"昼",desc:"途中で乱れやすい"},{value:"夕方",title:"夕方",desc:"疲れが出やすい"},{value:"夜",title:"夜",desc:"余韻が残る/考えが巡る"}],sa=[{value:"穏やか",title:"穏やか",desc:"静か/落ち着く"},{value:"嬉しい",title:"嬉しい",desc:"軽い高揚/前向き"},{value:"不安",title:"不安",desc:"ざわつく/心配"},{value:"疲れ",title:"疲れ",desc:"消耗/休みたい"}],dl=[{value:"達成/うまくいった",title:"達成",desc:"うまくいった/進んだ"},{value:"不確実/心配",title:"心配",desc:"先が読めない/不確実"},{value:"人間関係",title:"人",desc:"誰かとのやり取り"},{value:"体力/睡眠",title:"体",desc:"寝不足/疲労/体調"}],hl=[{value:"仕事/学業",title:"仕事",desc:"締切/評価/責任"},{value:"人間関係",title:"人間関係",desc:"距離感/言葉/空気"},{value:"体調/睡眠",title:"体調",desc:"疲れ/睡眠/コンディション"},{value:"SNS/情報",title:"情報",desc:"比較/ニュース/刺激"}],ml=[{value:"評価や期待が気になる",title:"評価",desc:"期待に応えたい/怖い"},{value:"比較してしまう",title:"比較",desc:"周りと比べて落ちる"},{value:"疲れると増幅する",title:"疲労",desc:"体力が落ちると不安が増える"},{value:"言語化できず溜まる",title:"未消化",desc:"うまく言えず残る"}],pl=[{value:"落ち着いて集中したい",title:"集中",desc:"静かに深く入りたい"},{value:"安心して眠りたい",title:"眠り",desc:"夜にほどけたい"},{value:"不安を小さくしたい",title:"安心",desc:"ざわつきを鎮めたい"},{value:"気分を切り替えたい",title:"切替",desc:"短時間で整えたい"}],fl=[{value:"1週間以内",title:"1週間",desc:"短期で変えたい"},{value:"1ヶ月以内",title:"1ヶ月",desc:"少しずつ整える"},{value:"3ヶ月以内",title:"3ヶ月",desc:"習慣化したい"},{value:"長期的",title:"長期",desc:"ゆっくり育てる"}],gl=({onComplete:s,onProgressChange:e})=>{const[t,n]=_.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),i={key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"choices",options:cl},a={key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"choices",options:ll},o={key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"choices",options:sa},l={key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"一番近い理由を選んでください。",kind:"choices",options:dl},c={key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"choices",options:ul},u={key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"choices",options:sa},d={key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"一番近いものを選んでください。",kind:"choices",options:hl},h={key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"一番近いものを選んでください。",kind:"choices",options:ml},m={key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"choices",options:pl},f={key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"choices",options:fl},p=R.useMemo(()=>t.startMode==="create"?[i,o,m,f]:[i,a,o,l,c,u,d,h,m,f],[t.startMode]),[g,v]=_.useState(0),b=p.length;_.useEffect(()=>{g>p.length-1&&v(Math.max(0,p.length-1))},[g,p.length]),_.useEffect(()=>{const y=b>0?g/b:0;e?.(Math.min(y,.999))},[g,b,e]),_.useEffect(()=>{const y=localStorage.getItem(ta);if(y)try{const j=JSON.parse(y);n(j)}catch(j){console.error("Failed to parse saved onboarding data:",j)}},[]);const w=y=>{localStorage.setItem(ta,JSON.stringify(y))},S=(y,j)=>{const C={...t,[y]:j};n(C),w(C),g<b-1&&v(g+1)},A=()=>{g<b-1&&(w(t),v(g+1))},x=()=>{g>0&&(w(t),v(g-1))},T=()=>{const j={...t,recentMomentWhen:t.recentMomentWhen||"最近",dailyPatternWhen:t.dailyPatternWhen||(t.startMode==="create"?"夜":""),recentMomentEmotion:t.recentMomentEmotion||t.dailyPatternEmotion,dailyPatternEmotion:t.dailyPatternEmotion||t.recentMomentEmotion,recentMomentWhy:t.recentMomentWhy||"未指定",emotionalTrigger:t.emotionalTrigger||"未指定",emotionalTriggerWhy:t.emotionalTriggerWhy||"未指定",emotionalGoal:t.emotionalGoal||"落ち着いて集中したい",emotionalGoalTimeframe:t.emotionalGoalTimeframe||"1ヶ月以内",completedAt:new Date().toISOString()};n(j),w(j),s&&s(j)},k=()=>{const y=p[g];return String(t[y.key]??"").trim().length>0};return r.jsxs("div",{className:"onboarding-form",children:[r.jsxs("div",{className:"onboarding-header",children:[r.jsx("h2",{className:"blend-text",children:"はじめに"}),r.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),r.jsx("div",{className:"progress-bar",children:r.jsx("div",{className:"progress-fill",style:{width:`${(g+1)/b*100}%`}})}),r.jsxs("p",{className:"step-indicator",children:["ステップ ",g+1," / ",b]})]}),r.jsx("div",{className:"question-container",children:(()=>{const y=p[g];return r.jsxs("div",{className:"question-step",children:[r.jsx("h3",{className:"question-title",children:y.title}),y.description?r.jsx("p",{className:"question-description",children:y.description}):null,r.jsx("div",{className:"form-group",children:r.jsx("div",{className:"choice-grid",role:"group","aria-label":y.title,children:y.options.map(j=>{const O=String(t[y.key]??"")===j.value;return r.jsxs("button",{type:"button",className:`choice-btn ${O?"is-selected":""}`,onClick:()=>S(y.key,j.value),"aria-pressed":O,children:[r.jsx("div",{className:"choice-title",children:j.title}),j.desc?r.jsx("div",{className:"choice-desc",children:j.desc}):null]},j.value)})})})]})})()}),r.jsx("div",{className:"onboarding-actions","data-no-swipe":"true","aria-label":"オンボーディング操作",children:r.jsxs("div",{className:"button-group",children:[g>0&&r.jsx("button",{className:"btn btn-secondary",onClick:x,type:"button",children:"← 戻る"}),g<b-1?r.jsx("button",{className:"btn btn-primary",onClick:A,disabled:!k(),type:"button",children:"次へ →"}):r.jsx("button",{className:"btn btn-success",onClick:T,disabled:!k(),type:"button",children:"完了"})]})})]})},vl=({isActive:s})=>{const e=_.useRef(null),t=_.useRef(null);ps(c=>{if(!e.current)return;e.current.rotation.z+=s?.002:.001;const u=Math.sin(c.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=s?.6:.3)});const n=[],i=5,a=50,o=i*a;for(let c=0;c<o;c++){const u=c/a,d=u*Math.PI*2,h=u*.5;n.push(new Ht(Math.cos(d)*h,Math.sin(d)*h,u*.1))}const l=new on().setFromPoints(n);return r.jsx("line",{ref:e,geometry:l,children:r.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},yl=({isActive:s=!1})=>r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Ws,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(vl,{isActive:s})]})}),bl=({isActive:s})=>{const e=_.useRef(null),t=_.useRef(null);ps(u=>{if(!e.current)return;e.current.rotation.z+=s?.001:5e-4;const d=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(d),t.current&&(t.current.opacity=s?.5:.25)});const n=[],i=200,a=3,o=2,l=Math.PI/2;for(let u=0;u<=i;u++){const d=u/i*Math.PI*2,h=Math.sin(a*d+l)*1.5,m=Math.sin(o*d)*1.5,f=0;n.push(new Ht(h,m,f))}const c=new on().setFromPoints(n);return r.jsx("line",{ref:e,geometry:c,children:r.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},xl=({isActive:s=!1})=>r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Ws,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(bl,{isActive:s})]})}),_l=({isActive:s,ripples:e})=>{const t=_.useRef(null);ps(i=>{if(!t.current)return;const a=i.clock.elapsedTime;t.current.children.forEach((o,l)=>{if(e[l]){const c=a-e[l].startTime,u=3;if(c<u){const d=1+c*.5;o.scale.setScalar(d);const h=1-c/u;o instanceof jc&&(o.material.opacity=h*(s?.6:.3))}else o.visible=!1}})});const n=()=>{const i=[];for(let l=0;l<=64;l++){const c=l/64*Math.PI*2;i.push(new Ht(Math.cos(c)*1,Math.sin(c)*1,0))}return new on().setFromPoints(i)};return r.jsx("group",{ref:t,children:e.slice(-5).map(i=>r.jsx("line",{geometry:n(),children:r.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},i.id))})},wl=({isActive:s=!1,triggerRipple:e})=>{const[t,n]=_.useState([]),i=_.useRef(0);return _.useEffect(()=>{if(e){const a={id:i.current++,startTime:Date.now()/1e3};n(o=>[...o,a].slice(-5))}},[e]),_.useEffect(()=>{if(!s)return;const a=setInterval(()=>{const o={id:i.current++,startTime:Date.now()/1e3};n(l=>[...l,o].slice(-5))},2e3);return()=>clearInterval(a)},[s]),r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:r.jsxs(Ws,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(_l,{isActive:s,ripples:t})]})})},Nl=({isActive:s,progress:e,dominantColor:t,onComplete:n,mousePos:i})=>{const a=_.useRef(null),o=_.useRef(null),[l,c]=_.useState(!1),[u,d]=_.useState(0),h=_.useMemo(()=>new ks(t),[t]),m=_.useMemo(()=>{const f=new on,p=new Float32Array(100*3),g=new Float32Array(100*3);for(let v=0;v<100;v++){const b=Math.random()*Math.PI*2,w=Math.acos(2*Math.random()-1),S=1;p[v*3]=S*Math.sin(w)*Math.cos(b),p[v*3+1]=S*Math.sin(w)*Math.sin(b),p[v*3+2]=S*Math.cos(w),g[v*3]=p[v*3]*.02,g[v*3+1]=p[v*3+1]*.02,g[v*3+2]=p[v*3+2]*.02}return f.setAttribute("position",new Yi(p,3)),f.setAttribute("velocity",new Yi(g,3)),f},[]);return ps(f=>{if(!a.current)return;const p=s?2*Math.PI/(30*60):2*Math.PI/(60*60);if(a.current.rotation.y+=p,a.current.rotation.x+=p*.5,s&&i.x!==0&&i.y!==0){const b=(i.x/window.innerWidth-.5)*.5,w=(i.y/window.innerHeight-.5)*.5;a.current.rotation.y+=(b-a.current.rotation.y)*.1,a.current.rotation.x+=(w-a.current.rotation.x)*.1}const g=20,v=Math.floor(e*g);if(v!==u&&v<g&&d(v),e>=1&&!l&&(c(!0),setTimeout(()=>{n?.()},1500)),l&&o.current){const b=m.getAttribute("position"),w=m.getAttribute("velocity");for(let S=0;S<100;S++)b.setXYZ(S,b.getX(S)+w.getX(S),b.getY(S)+w.getY(S),b.getZ(S)+w.getZ(S));b.needsUpdate=!0,a.current.material instanceof Tc&&(a.current.material.opacity=Math.max(0,a.current.material.opacity-.02))}}),r.jsxs("group",{children:[!l&&r.jsxs("mesh",{ref:a,children:[r.jsx("icosahedronGeometry",{args:[1,0]}),r.jsx("meshStandardMaterial",{color:h,transparent:!0,opacity:.8,wireframe:!1,emissive:h,emissiveIntensity:u/20})]}),l&&r.jsx("points",{ref:o,geometry:m,children:r.jsx("pointsMaterial",{color:h,size:.05,transparent:!0,opacity:.8})})]})},Sl=({isActive:s=!1,progress:e=0,onComplete:t,dominantColor:n="#D4AF37",layer:i="foreground",placement:a="center",sizePx:o=400,opacity:l})=>{const[c,u]=_.useState({x:0,y:0});_.useEffect(()=>{const f=p=>{u({x:p.clientX,y:p.clientY})};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]);const d=(()=>{switch(a){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),h=i==="background",m=typeof l=="number"?l:h?.14:1;return r.jsx("div",{style:{width:"100%",height:`${o}px`,position:"absolute",...d,transform:"translate(-50%, -50%)",pointerEvents:h?"none":s?"auto":"none",zIndex:h?-1:0,opacity:m},children:r.jsxs(Ws,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx("pointLight",{position:[10,10,10],intensity:1}),r.jsx(Nl,{isActive:s,progress:e,dominantColor:n,onComplete:t,mousePos:c})]})})},kl=({index:s,frequency:e,amplitude:t,color:n,mousePos:i,plucked:a})=>{const o=_.useRef(null),[l,c]=_.useState(0),[u,d]=_.useState(0),h=_.useMemo(()=>{const f=[];for(let v=0;v<100;v++){const b=v/100*4-2;f.push(new Ht(b,0,0))}return f},[]);ps(f=>{if(!o.current)return;const p=o.current.geometry.attributes.position,g=4,v=100;c(w=>w+e*.01),a&&d(w=>w+.2);const b=a?Math.exp(-u)*.5:0;for(let w=0;w<v;w++){const S=w/v*g-g/2,A=(i.x/window.innerWidth-.5)*8,x=(i.y/window.innerHeight-.5)*6,T=(s-2)*.4,k=Math.sqrt(Math.pow(A-S,2)+Math.pow(x-T,2)),y=Math.max(0,1-k/2)*.3,j=(t+y+b)*Math.sin(e*S+l),C=j,O=j*.2;p.setXYZ(w,S,C,O)}p.needsUpdate=!0,o.current.position.y=(s-2)*.4});const m=_.useMemo(()=>new on().setFromPoints(h),[h]);return r.jsx("line",{ref:o,geometry:m,children:r.jsx("lineBasicMaterial",{color:n,linewidth:2,transparent:!0,opacity:.8})})},jl=({isActive:s,audioData:e,valence:t,arousal:n,mousePos:i,pluckedIndex:a})=>{const o=_.useMemo(()=>{const l=t<0?1:2,c=n*.2;return[{frequency:l,amplitude:e?.bass?e.bass/255*.3:c,color:"#FF4444"},{frequency:l*1.5,amplitude:e?.midLow?e.midLow/255*.3:c*.8,color:"#FF8844"},{frequency:l*2,amplitude:e?.mid?e.mid/255*.3:c*.6,color:"#FFDD44"},{frequency:l*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:c*.4,color:"#44DDFF"},{frequency:l*3,amplitude:e?.treble?e.treble/255*.3:c*.2,color:"#8844FF"}]},[e,t,n]);return r.jsx("group",{children:o.map((l,c)=>r.jsx(kl,{index:c,frequency:l.frequency,amplitude:l.amplitude,color:l.color,mousePos:i,plucked:a===c},c))})},Tl=({isActive:s=!1,audioData:e=null,valence:t=0,arousal:n=.5})=>{const[i,a]=_.useState({x:0,y:0}),[o,l]=_.useState(-1);_.useEffect(()=>{const u=d=>{a({x:d.clientX,y:d.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const c=u=>{const d=u.currentTarget.getBoundingClientRect(),h=u.clientY-d.top,m=Math.floor(h/d.height*5);l(m),setTimeout(()=>l(-1),1e3)};return r.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:s?"auto":"none",zIndex:0},onClick:c,children:r.jsxs(Ws,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[r.jsx("ambientLight",{intensity:.5}),r.jsx(jl,{isActive:s,audioData:e,valence:t,arousal:n,mousePos:i,pluckedIndex:o})]})})},Xa=({pattern:s,isActive:e=!1,triggerRipple:t,progress:n=0,dominantColor:i="#D4AF37",layer:a="foreground",placement:o="center",sizePx:l,opacity:c,audioData:u=null,valence:d=0,arousal:h=.5,onComplete:m})=>{const[f,p]=_.useState(!1),[g,v]=_.useState(!1);return _.useEffect(()=>{const b=()=>{p(window.innerWidth<768)},w=window.matchMedia("(prefers-reduced-motion: reduce)");v(w.matches),b(),window.addEventListener("resize",b);const S=A=>{v(A.matches)};return w.addEventListener("change",S),()=>{window.removeEventListener("resize",b),w.removeEventListener("change",S)}},[]),f||g||s==="none"?null:r.jsxs(r.Fragment,{children:[s==="spiral"&&r.jsx(yl,{isActive:e}),s==="lissajous"&&r.jsx(xl,{isActive:e}),s==="ripples"&&r.jsx(wl,{isActive:e,triggerRipple:t}),s==="polyhedron"&&r.jsx(Sl,{isActive:e,progress:n,dominantColor:i,onComplete:m,layer:a,placement:o,sizePx:l,opacity:c}),s==="stringVibration"&&r.jsx(Tl,{isActive:e,audioData:u,valence:d,arousal:h})]})},ss="https://airia-beyond.onrender.com";async function Gr(s){const e=await fetch(`${ss}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate image")}return e.json()}async function Cl(s,e){const t=await fetch(`${ss}/api/job/${s}`,{signal:e});if(!t.ok){const n=await t.json();throw new Error(n.message||n.error||"Failed to get job status")}return t.json()}async function Rn(s,e,t=60,n=2e3,i){for(let a=0;a<t;a++){if(i?.aborted)throw new DOMException("Aborted","AbortError");const o=await Cl(s,i);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,n))}throw new Error("Job polling timeout")}async function Il(s){const e=await fetch(`${ss}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to chat")}return e.json()}async function Al(s){const e=await fetch(`${ss}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to refine event")}return e.json()}async function Ml(s){const e=await fetch(`${ss}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to name album title")}return e.json()}async function El(s){const e=await fetch(`${ss}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to resolve music preview")}return e.json()}async function Un(s){const e=await yt(`${ss}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate music")}return e.json()}async function Ol(s,e){const t=await yt(`${ss}/api/music/${s}`,{signal:e});if(!t.ok){const n=await t.json();throw new Error(n.message||n.error||"Failed to get music job status")}return t.json()}async function Ms(s,e,t=60,n=2e3,i){for(let a=0;a<t;a++){if(i?.aborted)throw new DOMException("Aborted","AbortError");const o=await Ol(s,i);if(e&&e(o),o.status==="succeeded"||o.status==="failed")return o;await new Promise(l=>setTimeout(l,n))}throw new Error("Music job polling timeout")}const Pl="airia_onboarding_data";function Dl(){try{const s=localStorage.getItem(Pl);if(!s)return null;const e=JSON.parse(s);return!e||typeof e!="object"?null:e}catch{return null}}function na(s){return Math.max(0,Math.min(1,s))}function Rl(s){return Math.max(-1,Math.min(1,s))}function ra(s){switch(String(s??"").trim()){case"穏やか":return{valence:.15,arousal:.25};case"嬉しい":return{valence:.65,arousal:.65};case"不安":return{valence:-.55,arousal:.65};case"疲れ":return{valence:-.2,arousal:.25};case"怒り":return{valence:-.65,arousal:.85};case"悲しい":return{valence:-.7,arousal:.35};case"興奮":return{valence:.5,arousal:.9};case"退屈":return{valence:-.1,arousal:.15};default:return{valence:0,arousal:.45}}}function Fl(s){const e=new Set,t=s.recentMomentEmotion||s.dailyPatternEmotion,n=String(t??"").trim();e.add("余韻"),e.add("光"),n==="不安"?(e.add("霧"),e.add("揺れ")):n==="穏やか"?(e.add("水面"),e.add("静寂")):n==="疲れ"?(e.add("夜"),e.add("静寂")):n==="嬉しい"?(e.add("風"),e.add("朝")):n==="悲しい"?(e.add("影"),e.add("雨")):n==="怒り"?(e.add("火"),e.add("鋭さ")):n==="興奮"?(e.add("閃光"),e.add("躍動")):n==="退屈"&&(e.add("無音"),e.add("空"));const i=String(s.emotionalGoal??"").trim();return i.includes("集中")&&e.add("集中"),(i.includes("安心")||i.includes("安"))&&e.add("安心"),i.includes("眠")&&e.add("眠り"),i.includes("整")&&e.add("整う"),[...e].slice(0,5)}function Ll(s){const e=s.recentMomentEmotion||s.dailyPatternEmotion||"未指定",t=String(s.emotionalGoal??"").trim(),n=String(s.emotionalTrigger??"").trim();return{emotionalProfile:[`startMode:${s.startMode||"未指定"}`,`mood:${e}`,t?`goal:${t.slice(0,80)}`:null,n?`trigger:${n.slice(0,60)}`:null].filter(Boolean).join(" / "),preferences:{...s,startMode:s.startMode}}}function Vl(s){const e=ra(s.recentMomentEmotion),t=ra(s.dailyPatternEmotion),n=Rl((e.valence+t.valence)/2),i=na((e.arousal+t.arousal)/2),a=na(s.startMode==="create"?.78:.68),o=Fl(s),l=.65,c=s.startMode==="create"?210:180;return{valence:n,arousal:i,focus:a,motif_tags:o,confidence:l,duration:c}}function Ul(s){const e=String(s.title).trim()||"AIRIA",t=String(s.mood??"").trim()||"mood",n=String(s.seed??"0"),i=Math.abs(n.split("").reduce((o,l)=>o*33+l.charCodeAt(0),7))%360,a=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${i} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(i+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(i+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${ia(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${ia(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">Generated from onboarding</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(a)}`}function ia(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}const ii="airia_pending_chat_generation_v1",ai="airia_pending_onboarding_generation_v1";function Pr(){try{const s=localStorage.getItem(ii);if(!s)return null;const e=JSON.parse(s);return!e||e.v!==1||e.kind!=="chat"||!e.musicJobId?null:e}catch{return null}}function aa(s){try{localStorage.setItem(ii,JSON.stringify(s))}catch{}}function oa(){try{localStorage.removeItem(ii)}catch{}}function Qs(){try{const s=localStorage.getItem(ai);if(!s)return null;const e=JSON.parse(s);return!e||e.v!==1||e.kind!=="onboarding"||!e.musicJobId||!e.request||!e.coverDataUrl?null:e}catch{return null}}function ca(s){try{localStorage.setItem(ai,JSON.stringify(s))}catch{}}function Zs(){try{localStorage.removeItem(ai)}catch{}}function Ja({open:s,title:e,description:t,cancelLabel:n="キャンセル",confirmLabel:i="実行",confirmTone:a="primary",onCancel:o,onConfirm:l}){return _.useEffect(()=>{if(!s)return;const c=u=>{u.key==="Escape"&&o(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&l()};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[s,o,l]),s?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"confirm-dialog-backdrop",onClick:o}),r.jsxs("div",{className:"confirm-dialog",role:"dialog","aria-modal":"true","aria-label":e,children:[r.jsxs("div",{className:"confirm-dialog-header",children:[r.jsxs("div",{children:[r.jsx("div",{className:"confirm-dialog-eyebrow",children:"確認"}),r.jsx("h2",{className:"confirm-dialog-title",children:e})]}),r.jsx("button",{className:"confirm-dialog-close",onClick:o,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),t?r.jsx("div",{className:"confirm-dialog-body",children:t}):null,r.jsxs("div",{className:"confirm-dialog-actions",children:[r.jsx("button",{className:"btn btn-secondary",onClick:o,children:n}),r.jsx("button",{className:a==="danger"?"btn btn-primary confirm-dialog-danger":"btn btn-primary",onClick:l,children:i})]}),r.jsx("div",{className:"confirm-dialog-shortcut",children:"確定: クリック / (Ctrl+Enter)"})]})]}):null}const Ka={active:!1,scopeLabel:null,statusText:null,elapsedSec:0,onCancel:null,updatedAt:0},Za=R.createContext(void 0);function Bl(s){const e=Object.values(s).filter(t=>t.active);return e.length===0?Ka:(e.sort((t,n)=>n.updatedAt-t.updatedAt),e[0])}function ql({children:s}){const[e,t]=R.useState({entries:{}}),n=R.useCallback((l,c)=>{const u=String(l||"default");t(d=>{const h=d.entries[u]??Ka,m={active:!!c.active,scopeLabel:c.scopeLabel??h.scopeLabel??null,statusText:c.statusText??h.statusText??null,elapsedSec:Number.isFinite(c.elapsedSec)?c.elapsedSec:h.elapsedSec??0,onCancel:c.onCancel??null,updatedAt:c.updatedAt??Date.now()};return{entries:{...d.entries,[u]:m}}})},[]),i=R.useCallback(l=>{const c=String(l||"default");t(u=>{if(!u.entries[c])return u;const d={...u.entries};return delete d[c],{entries:d}})},[]),a=R.useMemo(()=>Bl(e.entries),[e.entries]),o=R.useMemo(()=>({setOverlay:n,clearOverlay:i,current:a}),[n,i,a]);return r.jsx(Za.Provider,{value:o,children:s})}function oi(){const s=R.useContext(Za);if(!s)throw new Error("useGenerationOverlay must be used within GenerationOverlayProvider");return s}const Wl=({onExit:s})=>{const{albums:e,addAlbum:t,selectAlbum:n}=Lt(),{requestPlayAlbum:i}=ts(),{addToast:a}=Gs(),{setOverlay:o,clearOverlay:l}=oi(),[c,u]=_.useState(!1),[d,h]=_.useState(null),[m,f]=_.useState(0),[p,g]=_.useState(!1),[v,b]=_.useState(null),[w,S]=_.useState(null),[A,x]=_.useState(null),[T,k]=_.useState(0),[y,j]=_.useState(!1),C=_.useRef(!1),O=_.useRef(null),P=_.useRef(!1),[U,E]=_.useState(!1),I=_.useMemo(()=>e.filter(B=>B.musicData),[e]);_.useEffect(()=>{const B=Qs();j(!!B),B&&!P.current&&(P.current=!0,a("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]);const V=B=>{h(B),u(!0)},F=()=>{u(!1),h(null),f(0),g(!1),b(null),S(null),x(null),k(0),O.current?.abort(),O.current=null,Zs(),j(!1),C.current=!1};_.useEffect(()=>{if(!p||!A)return;k(Math.max(0,Math.floor((Date.now()-A)/1e3)));const B=window.setInterval(()=>{k(Math.max(0,Math.floor((Date.now()-A)/1e3)))},1e3);return()=>window.clearInterval(B)},[p,A]);const X=B=>B.recentMomentEmotion||B.dailyPatternEmotion||"穏やか",z=async()=>{if(!d||p)return;const B=Qs();if(!B)return;b(null),S("再開中…"),g(!0),x(B.startedAt||Date.now()),k(0),a("info","生成を再開しています…"),O.current?.abort();const M=new AbortController;O.current=M;try{const D=await Ms(B.musicJobId,G=>{G.status==="queued"?S("順番待ち…"):G.status==="running"?S("生成中…"):G.status==="succeeded"?S("仕上げ中…"):G.status==="failed"&&S("失敗しました")},90,2e3,M.signal);if(D.status!=="succeeded"||!D.midiData||!D.result)throw new Error(D.errorMessage||D.error||"曲生成に失敗しました");S("保存しています…");const N=t({title:B.title,mood:B.mood,duration:B.request.duration,imageDataURL:B.coverDataUrl,thumbnailUrl:B.coverDataUrl,metadata:{valence:B.request.valence,arousal:B.request.arousal,focus:B.request.focus,motif_tags:B.request.motif_tags,confidence:B.request.confidence,provider:"rule-based"},musicData:D.midiData,musicFormat:"midi",musicMetadata:{key:D.result.key,tempo:D.result.tempo,timeSignature:D.result.timeSignature,form:D.result.form,character:D.result.character,duration:B.request.duration,createdAt:new Date().toISOString(),provider:D.provider},sessionData:{onboarding:d}});n(N.id),i(N,[N,...I]),Zs(),j(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}s?.()}catch(D){if(D instanceof DOMException&&D.name==="AbortError"){S("キャンセルしました"),a("info","生成をキャンセルしました。あとで再開できます。");return}b(D instanceof Error?D.message:"曲生成に失敗しました"),S(null),a("error",D instanceof Error?D.message:"曲生成に失敗しました")}finally{g(!1),O.current=null}},L=async()=>{if(p||!d)return;const B=Qs();if(!B)return;b(null),S("再生成を開始しています…"),g(!0),x(Date.now()),k(0),a("info","同じ条件で再生成を開始しました。"),O.current?.abort();const M=new AbortController;O.current=M;try{const D=await Un(B.request);ca({...B,startedAt:Date.now(),musicJobId:D.jobId}),j(!0);const N=await Ms(D.jobId,ce=>{ce.status==="queued"?S("順番待ち…"):ce.status==="running"?S("生成中…"):ce.status==="succeeded"?S("仕上げ中…"):ce.status==="failed"&&S("失敗しました")},90,2e3,M.signal);if(N.status!=="succeeded"||!N.midiData||!N.result)throw new Error(N.errorMessage||N.error||"曲生成に失敗しました");S("保存しています…");const G=t({title:B.title,mood:B.mood,duration:B.request.duration,imageDataURL:B.coverDataUrl,thumbnailUrl:B.coverDataUrl,metadata:{valence:B.request.valence,arousal:B.request.arousal,focus:B.request.focus,motif_tags:B.request.motif_tags,confidence:B.request.confidence,provider:"rule-based"},musicData:N.midiData,musicFormat:"midi",musicMetadata:{key:N.result.key,tempo:N.result.tempo,timeSignature:N.result.timeSignature,form:N.result.form,character:N.result.character,duration:B.request.duration,createdAt:new Date().toISOString(),provider:N.provider},sessionData:{onboarding:d}});n(G.id),i(G,[G,...I]),Zs(),j(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}s?.()}catch(D){if(D instanceof DOMException&&D.name==="AbortError"){S("キャンセルしました"),a("info","生成をキャンセルしました。あとで再開できます。");return}const N=D instanceof Error?D.message:"曲生成に失敗しました";b(N),S(null),a("error",N)}finally{g(!1),O.current=null}},H=async()=>{if(!d||p)return;b(null),S("準備中…"),g(!0),x(Date.now()),k(0),O.current?.abort();const B=new AbortController;O.current=B;try{const M=X(d),D=`${Date.now()}`,N=Ul({title:"はじめの一曲",mood:M,seed:D}),G=Vl(d);S("作曲を開始しています…");const ce=await Un({...G,seed:Number(D.slice(-9))});ca({v:1,kind:"onboarding",startedAt:Date.now(),musicJobId:ce.jobId,request:{...G,seed:Number(D.slice(-9))},mood:M,title:"はじめの一曲",coverDataUrl:N}),j(!0),a("info","生成を開始しました。完了まで待つか、あとで再開できます。"),S("生成中…（1〜2分かかることがあります）");const le=await Ms(ce.jobId,lt=>{lt.status==="queued"?S("順番待ち…"):lt.status==="running"?S("生成中…"):lt.status==="succeeded"?S("仕上げ中…"):lt.status==="failed"&&S("失敗しました")},90,2e3,B.signal);if(le.status!=="succeeded"||!le.midiData||!le.result)throw new Error(le.errorMessage||le.error||"曲生成に失敗しました");S("保存しています…");const Qe=t({title:"はじめの一曲",mood:M,duration:G.duration,imageDataURL:N,thumbnailUrl:N,metadata:{valence:G.valence,arousal:G.arousal,focus:G.focus,motif_tags:G.motif_tags,confidence:G.confidence,provider:"rule-based"},musicData:le.midiData,musicFormat:"midi",musicMetadata:{key:le.result.key,tempo:le.result.tempo,timeSignature:le.result.timeSignature,form:le.result.form,character:le.result.character,duration:G.duration,createdAt:new Date().toISOString(),provider:le.provider},sessionData:{onboarding:d}});n(Qe.id),i(Qe,[Qe,...I]),Zs(),j(!1),a("success","生成が完了しました。保存して再生します。");try{localStorage.setItem("airia_post_onboarding_room","music")}catch{}s?.()}catch(M){if(M instanceof DOMException&&M.name==="AbortError"){S("キャンセルしました"),x(null),k(0),a("info","生成をキャンセルしました。あとで再開できます。");return}b(M instanceof Error?M.message:"曲生成に失敗しました"),S(null),x(null),k(0),a("error",M instanceof Error?M.message:"曲生成に失敗しました")}finally{g(!1),O.current=null}},Y=()=>{p&&(O.current?.abort(),g(!1),S("キャンセルしました"),x(null),k(0),a("info","生成を中断しました。あとで再開できます。"))},ee=()=>{Zs(),j(!1),S(null),b(null),a("info","保留中の生成を破棄しました。")},se=()=>{p&&(O.current?.abort(),O.current=null,g(!1),S("キャンセルしました"),x(null),k(0),a("info","生成をキャンセルしました。あとで再開できます。"))};return _.useEffect(()=>{if(!p){l("onboarding");return}o("onboarding",{active:!0,scopeLabel:"はじめに",statusText:w,elapsedSec:T,onCancel:se})},[p,w,T,o,l]),_.useEffect(()=>{!c||!d||C.current||d.startMode==="create"&&(C.current=!0,Qs()?z():H())},[c,d]),r.jsxs("div",{className:"room-content onboarding-room","data-no-swipe":"true",children:[r.jsx(Ja,{open:U,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>E(!1),onConfirm:()=>{E(!1),ee()}}),!c&&r.jsx(Xa,{pattern:"polyhedron",isActive:!0,progress:m,layer:"background",placement:"center",sizePx:420,opacity:.16}),r.jsx("h1",{className:"room-title",children:"はじめに"}),r.jsx("p",{className:"room-subtitle",children:"あなたに合う体験へ整えます"}),c?r.jsxs("div",{className:"onboarding-complete",children:[r.jsx("h2",{className:"blend-text",children:"完了しました！"}),r.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",r.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),v?r.jsx("div",{className:"form-error",children:v}):null,w?r.jsxs("div",{className:"onboarding-generate-status",children:[w,A?r.jsxs("span",{className:"onboarding-generate-elapsed",children:["（",T,"s）"]}):null]}):null,r.jsxs("div",{className:"button-group",children:[r.jsx("button",{className:"btn btn-secondary",onClick:F,children:"回答を編集"}),r.jsx("button",{className:"btn btn-primary",onClick:()=>void H(),disabled:p,"data-no-swipe":!0,title:"オンボーディング回答から1曲生成して、そのまま再生します",children:p?"1曲生成中…":"1曲作ってはじめる"}),!p&&y?r.jsx("button",{className:"btn btn-secondary",onClick:()=>void z(),"data-no-swipe":!0,type:"button",children:"生成を再開"}):null,!p&&y&&v?r.jsx("button",{className:"btn btn-secondary",onClick:()=>void L(),"data-no-swipe":!0,type:"button",title:"失敗・停止した場合に、同じ条件で作り直します",children:"再生成"}):null,!p&&y?r.jsx("button",{className:"btn btn-secondary",onClick:()=>E(!0),"data-no-swipe":!0,type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null,p?r.jsx("button",{className:"btn btn-secondary",onClick:Y,"data-no-swipe":!0,type:"button",children:"キャンセル"}):null,r.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!d)return;const B=JSON.stringify(d,null,2),M=new Blob([B],{type:"application/json"}),D=URL.createObjectURL(M),N=document.createElement("a");N.href=D,N.download="getting_started_profile.json",N.click(),URL.revokeObjectURL(D)},children:"プロフィールをダウンロード"}),r.jsx("button",{className:"btn btn-success",onClick:()=>{s?.()},children:"はじめる"})]})]}):r.jsx(gl,{onComplete:V,onProgressChange:f})]})},_s="".trim().toLowerCase()==="true",Gl=void 0,la=void 0,ws="https://airia-beyond.onrender.com",$l=({onBack:s})=>{const{loginWithGoogle:e,loginWithApple:t,loginWithPassword:n,registerWithPassword:i,busy:a}=nr(),o=R.useRef(null),[l,c]=R.useState(null),[u,d]=R.useState(null),[h,m]=R.useState(!0),[f,p]=R.useState(null),[g,v]=R.useState(null),[b,w]=R.useState(null),[S,A]=R.useState(null),[x,T]=R.useState(0),k=R.useMemo(()=>{try{const N=String(window.location.host||"").toLowerCase();return N.endsWith("netlify.app")?"Netlify（Site settings → Environment variables）":N.includes("github.io")?"GitHub（Actions/Pages の Secrets）":"ホスティングサービスのビルド環境（環境変数）"}catch{return"ホスティングサービスのビルド環境（環境変数）"}},[]),[y,j]=R.useState(()=>{try{return String(window.location.hash||"").toLowerCase()==="#signup"?"signup":"login"}catch{return"login"}});R.useEffect(()=>{try{const N=String(window.location.hash||"").toLowerCase();N==="#signup"&&j("signup"),N==="#login"&&j("login")}catch{}},[]),R.useEffect(()=>{let N=!0;return(async()=>{try{A(new Date().toISOString());const G=await fetch(`${ws}/api/health`).catch(()=>null);if(!N)return;if(!G)p(!1),v(null);else{const le=await G.json().catch(()=>null);p(!!G.ok),v({ok:!!G.ok,status:G.status,body:le})}const ce=await zc();if(!N)return;w(ce),m(!!ce?.passwordEnabled)}catch{N&&(p(!1),v(null),w(null))}})(),()=>{N=!1}},[x]),R.useEffect(()=>{c(null),d(null)},[e]);const C=async()=>{if(c(null),d(null),!_s){c("このプレリリースでは OAuth ログインは無効です");return}{c("Apple Client ID が未設定です");return}},O=_s&&!!Gl,P=_s&&!!la,U=[...O?[]:["Google"],...P?[]:["Apple"]],[E,I]=R.useState(""),[V,F]=R.useState(""),[X,z]=R.useState(""),[L,H]=R.useState(""),[Y,ee]=R.useState(""),se=!!(E.trim()&&V),B=!!(L.trim()&&Y),M=async N=>{N.preventDefault(),c(null),d(null);try{await i({email:E,password:V,displayName:X||void 0});const G=E.trim();d("新規登録が完了しました。メールとパスワードでログインしてください。"),j("login"),H(G),ee(""),F("");try{window.location.hash="#login"}catch{}}catch(G){c(G instanceof Error?G.message:String(G))}},D=async N=>{N.preventDefault(),c(null),d(null);try{await n({identifier:L,password:Y})}catch(G){c(G instanceof Error?G.message:String(G))}};return r.jsx("div",{className:"room-content auth-room",children:r.jsxs("div",{className:"auth-card","data-no-swipe":"true",children:[s?r.jsx("div",{style:{marginBottom:8},children:r.jsx("button",{className:"btn",onClick:s,disabled:a,children:"← 戻る"})}):null,r.jsxs("div",{className:"auth-tabs",role:"tablist","aria-label":"認証モード",children:[r.jsx("button",{type:"button",role:"tab","aria-selected":y==="signup",className:`auth-tab ${y==="signup"?"active":""}`,onClick:()=>{j("signup");try{window.location.hash="#signup"}catch{}},disabled:a,children:"新規登録"}),r.jsx("button",{type:"button",role:"tab","aria-selected":y==="login",className:`auth-tab ${y==="login"?"active":""}`,onClick:()=>{j("login");try{window.location.hash="#login"}catch{}},disabled:a,children:"ログイン"})]}),r.jsx("h1",{className:"auth-title",children:"AIRIA"}),r.jsx("p",{className:"auth-subtitle",children:y==="signup"?"メールで新規登録（登録後にログイン）":"おかえりなさい。ログインして続ける"}),f===!1?r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"API に接続できません"}),r.jsxs("div",{className:"auth-loading-sub",children:["新規登録/ログインが「Failed to fetch」になる場合、ほとんどが API 設定または CORS が原因です。",r.jsx("br",{}),"現在の API: ",ws,r.jsx("br",{}),"対応: ",k," に `VITE_API_BASE_URL`（例: https://airia-beyond.onrender.com）を設定して再デプロイ。",r.jsx("br",{}),"併せてバックエンド側で `APP_PUBLIC_URL` / `APP_ALLOWED_ORIGINS` にフロントのURLを追加してください。"]})]}):null,r.jsxs("details",{className:"auth-loading",style:{marginTop:10},children:[r.jsx("summary",{style:{cursor:"pointer",fontWeight:650},children:"接続/認証チェック（診断）"}),r.jsxs("div",{className:"auth-loading-sub",style:{marginTop:8},children:[r.jsxs("div",{children:["API: ",ws]}),r.jsxs("div",{children:["Origin: ",(()=>{try{return window.location.origin}catch{return"(unknown)"}})()]}),r.jsxs("div",{children:["/api/health: ",g?g.ok?`OK (${g.status})`:`NG (${g.status})`:f===!1?"NG (no response)":"未取得"]}),r.jsxs("div",{children:["/api/auth/config: ",b?`passwordEnabled=${String(!!b.passwordEnabled)}`:"未取得"]}),S?r.jsxs("div",{children:["checkedAt: ",S]}):null,r.jsxs("div",{style:{marginTop:10,display:"flex",gap:10,flexWrap:"wrap"},children:[r.jsx("button",{className:"btn",type:"button",onClick:()=>T(N=>N+1),disabled:a,children:"再チェック"}),r.jsx("a",{className:"btn",href:`${ws}/api/health`,target:"_blank",rel:"noreferrer",children:"health を開く"}),r.jsx("a",{className:"btn",href:`${ws}/api/auth/config`,target:"_blank",rel:"noreferrer",children:"auth config を開く"})]}),b&&b.passwordEnabled===!1?r.jsx("div",{style:{marginTop:10},children:"ブロッカー: バックエンド側でメール/パスワード認証が無効です。Render の環境変数に `AUTH_ALLOW_PASSWORD=true` を追加して再デプロイしてください。"}):null]})]}),_s&&U.length?r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"OAuth が未設定です"}),r.jsxs("div",{className:"auth-loading-sub",children:[U.join(" / ")," の Client ID がフロントエンド側で未投入です。 このアプリは Vite のため、環境変数は「実行時」ではなく「ビルド時」に埋め込まれます。",k," に以下を設定して再デプロイしてください。",r.jsx("br",{}),"必須: `VITE_GOOGLE_CLIENT_ID` / `VITE_APPLE_CLIENT_ID` / `VITE_API_BASE_URL`",r.jsx("br",{}),"推奨: `VITE_APPLE_REDIRECT_URI`（例: ",window.location.origin,"/）"]})]}):null,h?null:r.jsxs("div",{className:"auth-loading",role:"note",children:[r.jsx("div",{className:"auth-loading-title",children:"メール/パスワードは無効です"}),r.jsx("div",{className:"auth-loading-sub",children:"この環境ではメール/パスワードログインが無効化されています。管理者設定（`AUTH_ALLOW_PASSWORD=true`）を確認してください。"})]}),a?r.jsx("div",{className:"auth-loading","aria-live":"polite","aria-busy":"true",children:r.jsxs("div",{className:"auth-loading-row",children:[r.jsx("div",{className:"auth-spinner","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("div",{className:"auth-loading-title",children:"処理中…"}),r.jsx("div",{className:"auth-loading-sub",children:"通信環境によっては時間がかかる場合があります。安全にログイン処理を行っています。"})]})]})}):null,r.jsx("div",{className:"auth-note",children:y==="signup"?r.jsx(r.Fragment,{children:r.jsx("p",{children:"プレリリースはメールアドレスでの新規登録/ログインに限定しています。"})}):r.jsxs(r.Fragment,{children:[r.jsx("p",{children:"メールアドレス（またはハンドル）とパスワードでログインしてください。"}),r.jsxs("p",{children:["初めての方は"," ",r.jsx("button",{type:"button",className:"auth-inline-link",onClick:()=>{j("signup");try{window.location.hash="#signup"}catch{}},disabled:a,children:"新規登録"}),"。"]})]})}),h&&y==="signup"?r.jsxs("form",{className:"auth-form",onSubmit:N=>void M(N),children:[r.jsxs("label",{className:"auth-label",children:["メールアドレス",r.jsx("input",{className:"auth-input",type:"email",value:E,onChange:N=>I(N.target.value),placeholder:"you@example.com",autoComplete:"email",disabled:a,required:!0})]}),r.jsxs("label",{className:"auth-label",children:["パスワード（6文字以上）",r.jsx("input",{className:"auth-input",type:"password",value:V,onChange:N=>F(N.target.value),placeholder:"••••••",autoComplete:"new-password",disabled:a,required:!0,minLength:6})]}),r.jsxs("label",{className:"auth-label",children:["表示名（任意）",r.jsx("input",{className:"auth-input",type:"text",value:X,onChange:N=>z(N.target.value),placeholder:"AIRIAユーザー",autoComplete:"nickname",disabled:a})]}),r.jsx("button",{className:"btn auth-submit",type:"submit",disabled:a||!se,children:a?"作成中…":"メールで新規登録"})]}):h&&y==="login"?r.jsxs("form",{className:"auth-form",onSubmit:N=>void D(N),children:[r.jsxs("label",{className:"auth-label",children:["メールアドレス / ハンドル",r.jsx("input",{className:"auth-input",type:"text",value:L,onChange:N=>H(N.target.value),placeholder:"you@example.com または your_handle",autoComplete:"username",disabled:a,required:!0})]}),r.jsxs("label",{className:"auth-label",children:["パスワード",r.jsx("input",{className:"auth-input",type:"password",value:Y,onChange:N=>ee(N.target.value),placeholder:"••••••",autoComplete:"current-password",disabled:a,required:!0})]}),r.jsx("button",{className:"btn auth-submit",type:"submit",disabled:a||!B,children:a?"ログイン中…":"メールでログイン"})]}):null,_s?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"auth-sep","aria-hidden":"true",children:[r.jsx("span",{}),r.jsx("div",{children:"または"}),r.jsx("span",{})]}),r.jsxs("div",{className:"auth-actions",children:[r.jsx("div",{className:`auth-google ${O?"":"disabled"}`,children:O?r.jsx("div",{ref:o}):r.jsx("button",{className:"btn",disabled:!0,children:"Googleでログイン（未設定）"})}),r.jsxs("button",{className:"btn btn-apple",onClick:()=>void C(),disabled:a||!la,children:["Appleでログイン","（未設定）"]})]})]}):null,l&&r.jsx("div",{className:"auth-error",children:l}),u&&r.jsx("div",{className:"auth-success",children:u})]})})},zl=({onStart:s,onOpenTerms:e,onOpenPrivacy:t})=>{const n=i=>{const a=document.getElementById(i);a&&"scrollIntoView"in a&&a.scrollIntoView({behavior:"smooth",block:"start"})};return r.jsxs("div",{className:"room-content landing-room",children:[r.jsx("div",{className:"landing-hero","data-no-swipe":"true",children:r.jsxs("div",{className:"landing-hero-inner",children:[r.jsxs("div",{className:"landing-hero-copy",children:[r.jsxs("div",{className:"landing-hero-toprow",children:[r.jsx("div",{className:"landing-eyebrow",children:"MOOD → IMAGE → MUSIC"}),(t||e)&&r.jsxs("div",{className:"landing-legal","aria-label":"Legal",children:[t?r.jsx("button",{type:"button",className:"landing-legal-link",onClick:t,children:"Privacy"}):null,t&&e?r.jsx("span",{className:"landing-legal-sep","aria-hidden":"true",children:"·"}):null,e?r.jsx("button",{type:"button",className:"landing-legal-link",onClick:e,children:"Terms"}):null]})]}),r.jsxs("h1",{className:"landing-title",children:["AIRIA BEYOND",r.jsx("span",{className:"landing-title-sub",children:"感情を、作品に変える。"})]}),r.jsxs("p",{className:"landing-lead",children:["その日の気分を記録して、抽象画とクラシック風の音楽へ。",r.jsx("br",{}),"“言葉にならない”を、見える・聴ける形にして保存します。"]}),r.jsxs("div",{className:"landing-cta",children:[r.jsx("button",{className:"btn btn-primary landing-cta-primary",onClick:()=>{try{window.location.hash="#signup"}catch{}s()},children:"無料で新規登録"}),r.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>{try{window.location.hash="#login"}catch{}s()},children:"ログイン"}),r.jsx("button",{className:"btn landing-cta-secondary",onClick:()=>n("landing-how"),"aria-label":"AIRIAの使い方へスクロール",children:"どうやって動く？"})]}),r.jsxs("div",{className:"landing-meta",children:[r.jsx("span",{className:"landing-chip",children:"プレリリース"}),r.jsx("span",{className:"landing-chip",children:"Email / Password"}),r.jsx("span",{className:"landing-chip",children:"生成失敗でも止めない設計"}),r.jsx("span",{className:"landing-chip",children:"最短ルート：ログイン → 「創作から」"})]}),r.jsx("div",{className:"landing-signup-note",children:"初めての方は「無料で新規登録」からメール/パスワードを作成 → その後ログインしてください。"})]}),r.jsxs("div",{className:"landing-hero-cover","aria-label":"サンプルプレビュー",children:[r.jsxs("div",{className:"landing-cover-card",children:[r.jsxs("div",{className:"landing-cover-top",children:[r.jsx("div",{className:"landing-cover-kicker",children:"Today’s Session"}),r.jsx("div",{className:"landing-cover-date",children:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),r.jsx("div",{className:"landing-cover-title",children:"静けさと余白"}),r.jsx("div",{className:"landing-cover-sub",children:"穏やか / 3:00 / Focus 0.62"}),r.jsx("div",{className:"landing-cover-image",role:"img","aria-label":"生成イメージのモック"}),r.jsxs("div",{className:"landing-cover-bottom",children:[r.jsxs("div",{className:"landing-cover-pills",children:[r.jsx("span",{className:"landing-pill",children:"Valence"}),r.jsx("span",{className:"landing-pill",children:"Arousal"}),r.jsx("span",{className:"landing-pill",children:"Motif"})]}),r.jsxs("div",{className:"landing-cover-wave","aria-hidden":"true",children:[r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"}),r.jsx("div",{className:"landing-wave-bar"})]})]})]}),r.jsx("div",{className:"landing-cover-note",children:"これは体験イメージです。実際の生成はあなたの入力に合わせて変化します。"})]})]})}),r.jsxs("section",{className:"landing-section",id:"landing-how",children:[r.jsxs("div",{className:"landing-section-head",children:[r.jsx("h2",{className:"landing-h2",children:"体験は“記事”のように読み進められる"}),r.jsx("p",{className:"landing-sub",children:"AIRIAは、ただの生成ツールではなく「自分の状態を読み解くための記録」です。 迷いにくい導線と、気持ちよく続くUIを優先しました。"})]}),r.jsxs("div",{className:"landing-steps","data-no-swipe":"true",children:[r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"01"}),r.jsx("h3",{className:"landing-h3",children:"気分を入力"}),r.jsx("p",{className:"landing-p",children:"短い質問に答えるだけ。言語化が苦手でもOK。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"02"}),r.jsx("h3",{className:"landing-h3",children:"抽象画を生成"}),r.jsx("p",{className:"landing-p",children:"色・構図・質感で、その日の“温度”を可視化します。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"03"}),r.jsx("h3",{className:"landing-h3",children:"音楽を生成"}),r.jsx("p",{className:"landing-p",children:"クラシック風の短編。再生バーからすぐ聴けます。"})]}),r.jsxs("article",{className:"landing-step",children:[r.jsx("div",{className:"landing-step-no",children:"04"}),r.jsx("h3",{className:"landing-h3",children:"保存・共有"}),r.jsx("p",{className:"landing-p",children:"Socialに公開、反応を受け取る。非公開・削除も可能です。"})]})]}),r.jsx("div",{className:"landing-divider"}),r.jsxs("div",{className:"landing-grid","data-no-swipe":"true",children:[r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"止まらない体験"}),r.jsx("p",{className:"landing-p",children:"生成が失敗しても、placeholderや緊急MIDIで進行します。待ち時間のストレスを最小化。"})]}),r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"説明可能性"}),r.jsx("p",{className:"landing-p",children:"“なぜこの作品になったか”を見える形で提示。ブラックボックス感を減らします。"})]}),r.jsxs("article",{className:"landing-card",children:[r.jsx("h3",{className:"landing-h3",children:"運用前提の設計"}),r.jsx("p",{className:"landing-p",children:"OAuth-only、レート制限、通知（任意）など、プレリリースでも破綻しにくい土台を用意。"})]})]})]}),r.jsxs("section",{className:"landing-section landing-section-narrow",children:[r.jsxs("div",{className:"landing-section-head",children:[r.jsx("h2",{className:"landing-h2",children:"コンセプト"}),r.jsx("p",{className:"landing-sub",children:"“感情を作品に変える”は、自己理解の入り口になる。"})]}),r.jsxs("article",{className:"landing-article","data-no-swipe":"true",children:[r.jsx("p",{className:"landing-article-p",children:"気分は、言葉で説明しきれないことが多い。AIRIAは、入力を起点に「視覚」と「音楽」でその輪郭をつくります。 生成物は正解ではなく、あなたが自分を読み解くための“鏡”。"}),r.jsx("p",{className:"landing-article-p",children:"だからUIは、派手さよりも継続性を優先。余白、静けさ、そして必要なときだけ現れる強い導線。 アプリ全体がひとつの短い文章のように流れる設計です。"}),r.jsxs("div",{className:"landing-quote",children:[r.jsx("div",{className:"landing-quote-mark","aria-hidden":"true",children:"“"}),r.jsxs("div",{children:[r.jsx("div",{className:"landing-quote-text",children:"今日を作品として保存できると、気分は“消費”ではなく“蓄積”になる。"}),r.jsx("div",{className:"landing-quote-sub",children:"AIRIA BEYOND / Design note"})]})]})]})]}),r.jsxs("section",{className:"landing-section landing-bottom","data-no-swipe":"true",children:[r.jsxs("div",{className:"landing-bottom-inner",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"landing-h2",children:"準備はできましたか？"}),r.jsx("p",{className:"landing-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),r.jsxs("div",{className:"landing-bottom-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:s,children:"ログインしてはじめる"}),r.jsx("button",{className:"btn",onClick:()=>n("landing-how"),children:"もう一度読む"})]})]}),r.jsxs("footer",{className:"landing-footer",children:[r.jsxs("div",{className:"landing-footer-row",children:[r.jsx("div",{className:"landing-footer-brand",children:"AIRIA BEYOND"}),r.jsx("div",{className:"landing-footer-note",children:"Pre-release / OAuth-only"})]}),(t||e)&&r.jsxs("div",{className:"landing-footer-links","aria-label":"Legal",children:[t?r.jsx("button",{type:"button",className:"landing-footer-link",onClick:t,children:"プライバシー"}):null,e?r.jsx("button",{type:"button",className:"landing-footer-link",onClick:e,children:"利用規約"}):null]})]})]})]})},Yl=()=>r.jsxs("div",{className:"legal-page",children:[r.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[r.jsx("h2",{children:"1. サービスの概要 / Service Overview"}),r.jsx("p",{children:"AIRIA BEYONDは、AI搭載の感情分析・クラシック音楽・絵画生成アプリケーションです。 ユーザーの感情状態を分析し、それに基づいてクラシック音楽や絵画を生成します。"}),r.jsx("p",{children:"AIRIA BEYOND is an AI-powered application for emotion analysis, classical music, and painting generation. It analyzes users' emotional states and generates classical music and paintings based on the analysis."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"2. データの取り扱い / Data Handling"}),r.jsx("p",{children:"個人を特定できる情報は送信されません。セッションデータ、生成された画像・音楽は ブラウザのローカルストレージに保存されます。"}),r.jsx("p",{children:"No personally identifiable information is transmitted. Session data, generated images and music are stored in browser's local storage."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"3. 使用制限 / Usage Restrictions"}),r.jsx("p",{children:"本サービスは個人的な使用のみを目的としています。商用利用には事前の許可が必要です。"}),r.jsx("p",{children:"This service is intended for personal use only. Commercial use requires prior permission."})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"4. 免責事項 / Disclaimer"}),r.jsx("p",{children:"本サービスは「現状のまま」提供されます。生成されたコンテンツの正確性や適切性について 保証しません。"}),r.jsx("p",{children:'This service is provided "as is". We do not guarantee the accuracy or appropriateness of generated content.'})]}),r.jsx("div",{className:"legal-note",children:"プレリリース期間中は仕様が更新される場合があります。重要な変更はアプリ内のお知らせで通知します。"})]}),Hl=()=>r.jsxs("div",{className:"legal-page",children:[r.jsxs("section",{className:"legal-section",style:{borderTop:"none",paddingTop:0,marginTop:0},children:[r.jsx("h2",{children:"1. 収集する情報 / Information We Collect"}),r.jsxs("ul",{children:[r.jsx("li",{children:"セッションデータ（気分、時間） / Session data (mood, duration)"}),r.jsx("li",{children:"生成された画像・音楽 / Generated images and music"}),r.jsx("li",{children:"アクセスログ / Access logs"}),r.jsx("li",{children:"パフォーマンス指標 / Performance metrics"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"2. データの使用目的 / Purpose of Data Use"}),r.jsx("p",{children:"収集したデータは以下の目的で使用されます："}),r.jsxs("ul",{children:[r.jsx("li",{children:"サービスの提供と改善 / Service provision and improvement"}),r.jsx("li",{children:"パフォーマンスの監視 / Performance monitoring"}),r.jsx("li",{children:"エラーのトラッキングと修正 / Error tracking and fixing"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"3. データの保存 / Data Storage"}),r.jsx("p",{children:"ユーザーデータは主にブラウザのローカルストレージに保存されます。 サーバー側では一時的な処理のみが行われます。"}),r.jsx("p",{children:"User data is primarily stored in browser's local storage. Server-side processing is temporary only."}),r.jsx("div",{className:"legal-note",children:"ログインによりサーバー側にユーザー情報が保存されます（例: ハンドル、表示名、フォロー関係）。 メール通知を有効化した場合は、通知先としてメールアドレスを保存します。"})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"4. 第三者サービス / Third-Party Services"}),r.jsx("p",{children:"本サービスは以下の第三者サービスを使用します："}),r.jsxs("ul",{children:[r.jsx("li",{children:"Replicate (画像生成 / Image generation)"}),r.jsx("li",{children:"OpenAI (感情分析 / Emotion analysis)"}),r.jsx("li",{children:"Render (APIホスティング / API hosting)"}),r.jsx("li",{children:"GitHub Pages (フロントエンド配信 / Frontend hosting)"}),r.jsx("li",{children:"Sentry (エラートラッキング / Error tracking) - オプション"}),r.jsx("li",{children:"Resend / SMTP (メール通知 / Email notifications) - オプション"})]})]}),r.jsxs("section",{className:"legal-section",children:[r.jsx("h2",{children:"5. お問い合わせ / Contact"}),r.jsx("p",{children:"プライバシーに関するご質問は、GitHubリポジトリのIssueにてお問い合わせください。"}),r.jsx("p",{children:"For privacy-related questions, please contact us via GitHub repository Issues."})]})]}),ua=({kind:s,onBack:e,onStart:t})=>{const n=s==="terms"?"利用規約":"プライバシーポリシー",i=s==="terms"?"Terms of Service":"Privacy Policy";return r.jsxs("div",{className:"room-content legal-room","data-no-swipe":"true",children:[r.jsxs("div",{className:"legal-topbar",children:[r.jsx("button",{className:"btn",onClick:e,children:"← 戻る"}),r.jsx("div",{className:"legal-topbar-spacer"}),r.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインへ"})]}),r.jsxs("header",{className:"legal-hero",children:[r.jsx("div",{className:"legal-hero-kicker",children:"AIRIA BEYOND / Legal"}),r.jsxs("h1",{className:"legal-hero-title",children:[n,r.jsx("span",{className:"legal-hero-sub",children:i})]}),r.jsx("p",{className:"legal-hero-lead",children:"ここに書かれていることは“堅い文章”ですが、AIRIAが守ろうとしているのは体験の安心感です。 わからない点があれば、GitHubのIssueから相談できます。"})]}),r.jsx("main",{className:"legal-body",children:s==="terms"?r.jsx(Yl,{}):r.jsx(Hl,{})}),r.jsx("div",{className:"legal-bottom","data-no-swipe":"true",children:r.jsxs("div",{className:"legal-bottom-inner",children:[r.jsxs("div",{children:[r.jsx("div",{className:"legal-bottom-title",children:"続きはアプリで"}),r.jsx("div",{className:"legal-bottom-sub",children:"ログインして、最初のセッションを始めましょう。"})]}),r.jsxs("div",{className:"legal-bottom-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:t,children:"ログインしてはじめる"}),r.jsx("button",{className:"btn",onClick:e,children:"戻る"})]})]})})]})};function Xl(s,e,t){try{s(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(n){console.error("[CausalLog] Failed to log album creation stage:",n)}}function Ns(s,e,t,n,i){try{const o=e(t)?.errors||[];s(t,{errors:[...o,{stage:n,error:i,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",n)}catch(a){console.error("[CausalLog] Failed to log error:",a)}}function Dr(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function Jl(s){const e=String(s.title??"").trim()||"AIRIA",t=String(s.mood??"").trim()||"mood",n=String(s.seed??"0"),i=String(s.note).trim()||"Placeholder cover",a=Math.abs(n.split("").reduce((l,c)=>l*33+c.charCodeAt(0),7))%360,o=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="hsl(${a} 70% 52%)" stop-opacity="0.95"/>
      <stop offset="55%" stop-color="hsl(${(a+35)%360} 65% 42%)" stop-opacity="0.92"/>
      <stop offset="100%" stop-color="hsl(${(a+120)%360} 55% 28%)" stop-opacity="0.95"/>
    </linearGradient>
    <filter id="n">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.16"/>
      </feComponentTransfer>
    </filter>
  </defs>
  <rect width="1024" height="1024" fill="url(#g)"/>
  <rect width="1024" height="1024" filter="url(#n)" opacity="0.6"/>
  <circle cx="770" cy="300" r="240" fill="rgba(255,255,255,0.14)"/>
  <circle cx="820" cy="270" r="120" fill="rgba(0,0,0,0.10)"/>

  <g fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
    <text x="72" y="794" font-size="54" font-weight="720" letter-spacing="0.02em">${Dr(e).slice(0,28)}</text>
    <text x="72" y="858" font-size="28" font-weight="600" opacity="0.9">${Dr(t).slice(0,24)}</text>
    <text x="72" y="916" font-size="18" opacity="0.8">${Dr(i).slice(0,64)}</text>
  </g>
</svg>`;return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(o)}`}function Kl({open:s,mood:e,defaultTitle:t,onCancel:n,onSubmit:i}){const[a,o]=_.useState(t??"");_.useEffect(()=>{s&&o(t??"")},[s,t]);const l=_.useMemo(()=>a.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[a]);return _.useEffect(()=>{if(!s)return;const c=u=>{u.key==="Escape"&&n(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&i(a)};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[s,n,i,a]),s?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"album-title-backdrop",onClick:n}),r.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[r.jsxs("div",{className:"album-title-header",children:[r.jsxs("div",{children:[r.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),r.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),r.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),r.jsx("button",{className:"album-title-close",onClick:n,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),r.jsxs("div",{className:"album-title-body",children:[r.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),r.jsx("input",{id:"album-title-input",className:"album-title-input",value:a,placeholder:"例：雨上がりの余白",onChange:c=>o(c.target.value),autoFocus:!0}),r.jsx("div",{className:"album-title-hint",children:l}),r.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),r.jsxs("div",{className:"album-title-actions",children:[r.jsx("button",{className:"btn btn-secondary",onClick:n,children:"キャンセル"}),r.jsx("button",{className:"btn btn-primary",onClick:()=>i(a),children:"保存"})]})]})]}):null}function Rr(){return new Date().toISOString()}function Fr(s,e){return Jl({title:s?.brief?.theme?.title,mood:s?.image?.mood,seed:s?.image?.seed,note:e})}function Lr(s){return s?.effectiveProvider||s?.provider||(s?.status==="succeeded"?"image":"placeholder")}function Zl(){const{albums:s,addAlbum:e,selectAlbum:t}=Lt(),{createLog:n,updateLog:i,getLog:a}=Wa(),{requestPlayAlbum:o}=ts(),{navigateToRoom:l}=Ut(),{addToast:c}=Gs(),{setOverlay:u,clearOverlay:d}=oi(),[h,m]=_.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[f,p]=_.useState(""),[g,v]=_.useState(!1),[b,w]=_.useState(null),[S,A]=_.useState([]),[x,T]=_.useState(null),[k,y]=_.useState(!1),[j,C]=_.useState(null),[O,P]=_.useState(null),[U,E]=_.useState(0),I=_.useRef(null),[V,F]=_.useState(!1),[X,z]=_.useState(!1),L=_.useRef(!1),[H,Y]=_.useState(!1),[ee,se]=_.useState(!1),[B,M]=_.useState(null),[D,N]=_.useState(null),[G,ce]=_.useState(!1),le=_.useRef(null),[Qe,lt]=_.useState(null),[Pt,K]=_.useState({}),[Q,_e]=_.useState({}),[ge,de]=_.useState({}),[ve,He]=_.useState(!1),[et,q]=_.useState(!0),$=_.useMemo(()=>h.filter(W=>W.role==="user"),[h]),Z=_.useMemo(()=>{const W=Dl();return W?Ll(W):null},[]),ie=_.useMemo(()=>s.filter(W=>W.musicData),[s]);_.useEffect(()=>{const W=window.matchMedia("(max-width: 900px)"),oe=()=>He(W.matches);return oe(),typeof W.addEventListener=="function"?(W.addEventListener("change",oe),()=>W.removeEventListener("change",oe)):(W.addListener(oe),()=>W.removeListener(oe))},[]),_.useEffect(()=>{q(!ve)},[ve]),_.useEffect(()=>{const W=Pr();F(!!W),W&&!L.current&&(L.current=!0,c("info","保留中の生成があります。「生成を再開」で続きを進められます。"))},[]),_.useEffect(()=>()=>{I.current?.abort(),I.current=null,le.current&&(le.current.pause(),le.current.src="",le.current=null)},[]),_.useEffect(()=>{if(!k||!O)return;E(Math.max(0,Math.floor((Date.now()-O)/1e3)));const W=window.setInterval(()=>{E(Math.max(0,Math.floor((Date.now()-O)/1e3)))},1e3);return()=>window.clearInterval(W)},[k,O]),_.useEffect(()=>{if(!k){d("chat");return}u("chat",{active:!0,scopeLabel:"対話",statusText:j,elapsedSec:U,onCancel:me})},[k,j,U,u,d]);function me(){k&&(I.current?.abort(),I.current=null,y(!1),C("キャンセルしました"),P(null),E(0),z(!1),c("info","生成を中断しました。あとで再開できます。"))}function ae(){oa(),F(!1),C(null),w(null),z(!1),c("info","保留中の生成を破棄しました。")}async function pe(){const W=Pr();if(!W||k)return;w(null),z(!1),y(!0),C("再生成を開始しています…"),P(Date.now()),E(0),c("info","同じ条件で再生成を開始しました。"),I.current?.abort();const oe=new AbortController;I.current=oe;try{const J=W.refined,te=Fr(J,"Image unavailable");let xe=null;try{C("画像生成を開始しています…"),xe=(await Gr(J.image)).jobId}catch(Ge){xe=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Ie=Ge instanceof Error?Ge.message:"image job start failed";W.causalLogId&&Ns(i,a,W.causalLogId,"image-generation-start",Ie)}C("作曲を開始しています…");const ke=await Un(J.music);aa({...W,startedAt:Date.now(),imageJobId:xe,musicJobId:ke.jobId,coverDataUrl:W.coverDataUrl||te}),F(!0);const Ee=xe?Rn(xe,Ge=>{Ge.status==="queued"?C("順番待ち…"):Ge.status==="running"?C("画像を生成中…"):Ge.status==="succeeded"?C("画像ができました。仕上げ中…"):Ge.status==="failed"&&C("画像生成に失敗しました")},90,2e3,oe.signal).catch(Ge=>{const Ie=Ge instanceof Error?Ge.message:"image polling failed";return W.causalLogId&&Ns(i,a,W.causalLogId,"image-generation-poll",Ie),null}):Promise.resolve(null),[dt,Ve]=await Promise.all([Ee,Ms(ke.jobId,Ge=>{Ge.status==="queued"?C("順番待ち…"):Ge.status==="running"?C("作曲中…"):Ge.status==="succeeded"?C("作曲ができました。仕上げ中…"):Ge.status==="failed"&&C("作曲に失敗しました")},90,2e3,oe.signal)]),we=dt?.status==="succeeded"&&dt?.resultUrl?dt.resultUrl:te;if(dt?.status==="succeeded"&&dt?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ve.status!=="succeeded"||!Ve.midiData||!Ve.result)throw new Error("曲生成に失敗しました");const bs=J?.brief?.theme?.title||"";M({title:bs,mood:J?.image?.mood,duration:J?.image?.duration,imageDataURL:we,thumbnailUrl:we,metadata:{valence:J?.analysisLike?.valence,arousal:J?.analysisLike?.arousal,focus:J?.analysisLike?.focus,motif_tags:J?.analysisLike?.motif_tags,confidence:J?.analysisLike?.confidence,stylePreset:J?.image?.stylePreset,provider:Lr(dt)},musicData:Ve.midiData,musicFormat:"midi",musicMetadata:{key:Ve.result.key,tempo:Ve.result.tempo,timeSignature:Ve.result.timeSignature,form:Ve.result.form,character:Ve.result.character,duration:J?.music?.duration,createdAt:Rr(),provider:Ve.provider},sessionData:{brief:J?.brief,recommendations:W.sessionRecommendations??S,messages:W.sessionMessages??h},causalLogId:W.causalLogId??void 0}),N(W.causalLogId??null),se(!0),C(null),z(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(J){if(J instanceof DOMException&&J.name==="AbortError"){C("キャンセルしました"),z(!1);return}const te=J instanceof Error?J.message:"再生成に失敗しました";w(te),z(!0),c("error",te)}finally{y(!1),I.current=null}}async function Fe(){const W=Pr();if(!W||k)return;w(null),z(!1),y(!0),C("再開中…"),P(W.startedAt||Date.now()),E(0),c("info","生成を再開しています…"),I.current?.abort();const oe=new AbortController;I.current=oe;try{const J=W.refined,te=W.coverDataUrl||Fr(J,"Image unavailable"),xe=W.imageJobId?Rn(W.imageJobId,we=>{we.status==="queued"?C("順番待ち…"):we.status==="running"?C("画像を生成中…"):we.status==="succeeded"?C("画像ができました。仕上げ中…"):we.status==="failed"&&C("画像生成に失敗しました")},90,2e3,oe.signal).catch(we=>{const bs=we instanceof Error?we.message:"image polling failed";return W.causalLogId&&Ns(i,a,W.causalLogId,"image-generation-poll",bs),null}):Promise.resolve(null),[ke,Ee]=await Promise.all([xe,Ms(W.musicJobId,we=>{we.status==="queued"?C("順番待ち…"):we.status==="running"?C("作曲中…"):we.status==="succeeded"?C("作曲ができました。仕上げ中…"):we.status==="failed"&&C("作曲に失敗しました")},90,2e3,oe.signal)]),dt=ke?.status==="succeeded"&&ke?.resultUrl?ke.resultUrl:te;if(ke?.status==="succeeded"&&ke?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),Ee.status!=="succeeded"||!Ee.midiData||!Ee.result)throw new Error("曲生成に失敗しました");const Ve=J?.brief?.theme?.title||"";M({title:Ve,mood:J?.image?.mood,duration:J?.image?.duration,imageDataURL:dt,thumbnailUrl:dt,metadata:{valence:J?.analysisLike?.valence,arousal:J?.analysisLike?.arousal,focus:J?.analysisLike?.focus,motif_tags:J?.analysisLike?.motif_tags,confidence:J?.analysisLike?.confidence,stylePreset:J?.image?.stylePreset,provider:Lr(ke)},musicData:Ee.midiData,musicFormat:"midi",musicMetadata:{key:Ee.result.key,tempo:Ee.result.tempo,timeSignature:Ee.result.timeSignature,form:Ee.result.form,character:Ee.result.character,duration:J?.music?.duration,createdAt:Rr(),provider:Ee.provider},sessionData:{brief:J?.brief,recommendations:W.sessionRecommendations??S,messages:W.sessionMessages??h},causalLogId:W.causalLogId??void 0}),N(W.causalLogId??null),se(!0),C(null),F(!0),z(!1),c("success","生成が完了しました。タイトルを決めて保存できます。")}catch(J){if(J instanceof DOMException&&J.name==="AbortError"){C("キャンセルしました"),z(!1);return}const te=J instanceof Error?J.message:"再開に失敗しました";w(te),z(!0),c("error",te)}finally{y(!1),I.current=null}}const ye=W=>`${W.composer}::${W.title}`;async function Le(W){const oe=ye(W);if(Pt[oe])return Pt[oe];if(Q[oe])return null;_e(J=>({...J,[oe]:!0})),de(J=>({...J,[oe]:null}));try{const J=await El({composer:W.composer,title:W.title});return K(te=>({...te,[oe]:J})),J}catch(J){const te=J instanceof Error?J.message:"プレビュー取得に失敗しました";return de(xe=>({...xe,[oe]:te})),null}finally{_e(J=>({...J,[oe]:!1}))}}async function it(W){const oe=ye(W);if(Qe===oe){le.current?.pause(),lt(null);return}const te=await Le(W),xe=te?.previewUrl,ke=te?.trackUrl;if(!xe){ke&&window.open(ke,"_blank","noopener,noreferrer");return}try{le.current||(le.current=new Audio),le.current.pause(),le.current.src=xe,le.current.currentTime=0,await le.current.play(),lt(oe),le.current.onended=()=>{lt(Ee=>Ee===oe?null:Ee)}}catch(Ee){de(dt=>({...dt,[oe]:Ee instanceof Error?Ee.message:"再生に失敗しました"}))}}async function ut(){const W=f.trim();if(!W)return;w(null),v(!0);const oe=[...h,{role:"user",content:W}];m(oe),p("");try{const J=await Il({messages:oe,onboardingData:Z??void 0});m(te=>[...te,{role:"assistant",content:J.assistant_message}]),A(J.recommendations??[]),T(J.event_suggestion??null)}catch(J){const te=J instanceof Error?J.message:"送信に失敗しました";w(te),m(xe=>[...xe,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{v(!1)}}async function We(){w(null),z(!1),y(!0),C("準備中…"),P(Date.now()),E(0),I.current?.abort();const W=new AbortController;I.current=W;const oe=`chat_${Date.now()}`,J=n(oe,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{C("イベントを整えています…");const te=await Al({messages:h,onboardingData:Z??void 0}),xe=Fr(te,"Image unavailable");let ke=null;try{C("画像生成を開始しています…"),ke=(await Gr(te.image)).jobId}catch(Ie){ke=null,c("warning","画像生成が開始できなかったため、プレースホルダーで続行します。");const Ar=Ie instanceof Error?Ie.message:"image job start failed";Ns(i,a,J,"image-generation-start",Ar)}C("作曲を開始しています…");const Ee=await Un(te.music);aa({v:1,kind:"chat",startedAt:Date.now(),imageJobId:ke,musicJobId:Ee.jobId,coverDataUrl:xe,refined:te,sessionMessages:h,sessionRecommendations:S,causalLogId:J}),F(!0),c("info","生成を開始しました。完了まで待つか、あとで再開できます。");const dt=ke?Rn(ke,Ie=>{Ie.status==="queued"?C("順番待ち…"):Ie.status==="running"?C("画像を生成中…"):Ie.status==="succeeded"?C("画像ができました。仕上げ中…"):Ie.status==="failed"&&C("画像生成に失敗しました")},90,2e3,W.signal).catch(Ie=>{const Ar=Ie instanceof Error?Ie.message:"image polling failed";return Ns(i,a,J,"image-generation-poll",Ar),null}):Promise.resolve(null),[Ve,we]=await Promise.all([dt,Ms(Ee.jobId,Ie=>{Ie.status==="queued"?C("順番待ち…"):Ie.status==="running"?C("作曲中…"):Ie.status==="succeeded"?C("作曲ができました。仕上げ中…"):Ie.status==="failed"&&C("作曲に失敗しました")},90,2e3,W.signal)]);if(W.signal.aborted){C("キャンセルしました");return}const bs=Ve?.status==="succeeded"&&Ve?.resultUrl?Ve.resultUrl:xe;if(Ve?.status==="succeeded"&&Ve?.resultUrl||c("warning","画像が取得できなかったため、プレースホルダーで続行します。"),we.status!=="succeeded"||!we.midiData||!we.result)throw new Error("曲生成に失敗しました");C("保存の準備をしています…");const Ge=te?.brief?.theme?.title||"";M({title:Ge,mood:te.image.mood,duration:te.image.duration,imageDataURL:bs,thumbnailUrl:bs,metadata:{valence:te.analysisLike.valence,arousal:te.analysisLike.arousal,focus:te.analysisLike.focus,motif_tags:te.analysisLike.motif_tags,confidence:te.analysisLike.confidence,stylePreset:te.image.stylePreset,provider:Lr(Ve)},musicData:we.midiData,musicFormat:"midi",musicMetadata:{key:we.result.key,tempo:we.result.tempo,timeSignature:we.result.timeSignature,form:we.result.form,character:we.result.character,duration:te.music.duration,createdAt:Rr(),provider:we.provider},sessionData:{brief:te.brief,recommendations:S,messages:h},causalLogId:J}),N(J),se(!0),c("success","生成が完了しました。タイトルを決めて保存できます。"),z(!1),C(null),P(null),E(0),T(null),m(Ie=>[...Ie,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(te){if(te instanceof DOMException&&te.name==="AbortError"){C("キャンセルしました"),P(null),E(0),m(ke=>[...ke,{role:"assistant",content:"生成をキャンセルしたよ。必要ならまた「今すぐ1曲つくる」で再開できる。"}]),c("info","生成をキャンセルしました。あとで再開できます。"),z(!1);return}const xe=te instanceof Error?te.message:"生成イベントに失敗しました";C(null),P(null),E(0),w(xe),c("error",xe),z(!0),Ns(i,a,J,"generation-event",xe),m(ke=>[...ke,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{y(!1),I.current=null}}async function Xe(W){if(!B){se(!1);return}const oe=W.trim();try{ce(!0);let J=oe;if(!J)try{J=(await Ml({mood:B.mood,motifTags:B?.metadata?.motif_tags,character:B?.musicMetadata?.character,brief:B?.sessionData?.brief,messages:B?.sessionData?.messages})).title}catch{J=""}const te=e({...B,title:J||void 0});t(te.id),o(te,[te,...ie]),l("music"),c("success","保存して再生を開始しました。"),oa(),F(!1),D&&Xl(i,D,{albumId:"local",title:J||B.mood}),T(null),m(xe=>[...xe,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{ce(!1),se(!1),M(null),N(null)}}return r.jsxs("div",{className:"chatSession",children:[r.jsx(Ja,{open:H,title:"保留中の生成を破棄しますか？",description:`中断した生成を破棄します。
この生成は再開できなくなります。`,cancelLabel:"キャンセル",confirmLabel:"破棄する",confirmTone:"danger",onCancel:()=>Y(!1),onConfirm:()=>{Y(!1),ae()}}),r.jsx(Kl,{open:ee,mood:B?.mood||"穏やか",defaultTitle:B?.title,onCancel:()=>{G||(se(!1),M(null),N(null))},onSubmit:W=>{G||Xe(W)}}),r.jsxs("div",{className:"chatLayout",children:[r.jsxs("div",{className:"chatMain",children:[r.jsx("div",{className:"chatBody",children:h.map((W,oe)=>r.jsx("div",{className:`chatMsg ${W.role==="user"?"user":"assistant"}`,children:r.jsx("div",{className:"chatBubble",children:W.content})},oe))}),r.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[r.jsxs("div",{className:"chatDockTop","aria-label":"生成コントロール",children:[r.jsx("div",{className:"chatDockMeta",children:j?r.jsxs("div",{className:"chatMetaPill","aria-live":"polite",children:[j,O?r.jsxs("span",{className:"chatMetaElapsed",children:["（",U,"s）"]}):null]}):x&&!x.shouldTrigger?r.jsx("div",{className:"chatMetaHint",title:x.reason,children:x.reason}):r.jsx("div",{className:"chatMetaHint","aria-hidden":"true"})}),r.jsxs("div",{className:"chatDockActions","data-no-swipe":!0,children:[r.jsx("button",{className:"chatCancel",onClick:()=>q(W=>!W),type:"button",title:"レコメンドパネルを表示/非表示",children:et?"レコメンド非表示":"レコメンド表示"}),r.jsx("button",{className:"chatPrimary",onClick:We,disabled:k,title:x?.reason||"会話の内容をもとに1曲生成します",type:"button",children:k?"生成中…":x?.shouldTrigger?"生成イベントを開始":"今すぐ1曲つくる"}),!k&&V?r.jsx("button",{className:"chatCancel",onClick:()=>void Fe(),type:"button",children:"再開"}):null,!k&&V&&X?r.jsx("button",{className:"chatCancel",onClick:()=>void pe(),type:"button",title:"同じ条件で生成をやり直します（失敗・停止時向け）",children:"再生成"}):null,k?r.jsx("button",{className:"chatCancel",onClick:me,type:"button",children:"キャンセル"}):null,!k&&V?r.jsx("button",{className:"chatCancel",onClick:()=>Y(!0),type:"button",title:"保留中の生成を破棄します",children:"破棄"}):null]})]}),b?r.jsx("div",{className:"chatError",children:b}):null,r.jsxs("div",{className:"chatComposer",children:[r.jsx("textarea",{className:"chatInput",placeholder:$.length===0?"今日のことを一言で":"続けて話して",value:f,onChange:W=>p(W.target.value),onKeyDown:W=>{W.key==="Enter"&&!W.shiftKey&&(W.preventDefault(),g||ut())},rows:2}),r.jsx("button",{className:"chatSend",onClick:ut,disabled:g||!f.trim(),children:g?"送信中…":"送信"})]})]})]}),r.jsxs("aside",{className:`chatSide ${et?"open":"closed"}`,"aria-label":"レコメンド","aria-hidden":!et,children:[r.jsxs("div",{className:"chatSideHeader",children:[r.jsx("div",{className:"chatSideTitle",children:"いまのレコメンド"}),r.jsx("div",{className:"chatSideHint",children:"30秒プレビュー（可能な場合）"})]}),S.length>0?r.jsx("ul",{className:"chatRecsList",children:S.slice(0,4).map((W,oe)=>r.jsxs("li",{className:"chatRecItem",children:[r.jsxs("div",{className:"chatRecMain",children:[r.jsx("span",{className:"chatRecComposer",children:W.composer}),r.jsx("span",{className:"chatRecSep",children:"—"}),r.jsx("span",{className:"chatRecTitle",children:W.title}),W.era?r.jsxs("span",{className:"chatRecEra",children:["(",W.era,")"]}):null]}),r.jsx("div",{className:"chatRecWhy",children:W.why}),r.jsxs("div",{className:"chatRecActions",children:[r.jsx("button",{className:"chatRecPlay",onClick:()=>void it(W),disabled:!!Q[ye(W)],"data-no-swipe":!0,children:Qe===ye(W)?"停止":Q[ye(W)]?"取得中…":"再生"}),Pt[ye(W)]?.trackUrl?r.jsx("a",{className:"chatRecOpen",href:Pt[ye(W)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),ge[ye(W)]?r.jsx("div",{className:"chatRecErr",children:ge[ye(W)]}):null]},oe))}):r.jsx("div",{className:"chatRecsEmpty",children:"会話をすると、ここにおすすめが出ます。"})]})]})]})}const Ql=()=>r.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative",height:"100%",minHeight:0},children:r.jsx(Zl,{})});function Qa(s=4){const e=Math.max(2,Math.min(8,Math.round(s))),t=new Uint8Array(e);for(let i=0;i<e;i+=1)t[i]=Math.round(i/(e-1)*255);const n=new Va(t,e,1,Ua);return n.minFilter=Vn,n.magFilter=Vn,n.generateMipmaps=!1,n.needsUpdate=!0,n}function eo(s=64){const e=Math.max(8,Math.min(256,Math.round(s))),t=new Uint8Array(e*e);for(let i=0;i<t.length;i+=1)t[i]=Math.floor(Math.random()*256);const n=new Va(t,e,e,Ua);return n.wrapS=Hi,n.wrapT=Hi,n.minFilter=Vn,n.magFilter=Vn,n.generateMipmaps=!1,n.needsUpdate=!0,n}function Es(s,e,t={}){if(!s)return;const n=Math.max(0,Math.min(.35,Number(t.strength??.08))),i=Math.max(1,Math.min(64,Number(t.scale??10))),a=Math.max(0,Math.min(2,Number(t.speed??.35)));s.onBeforeCompile=o=>{o.uniforms.uNoiseTex={value:e},o.uniforms.uTime={value:0},o.uniforms.uGrainStrength={value:n},o.uniforms.uGrainScale={value:i},o.uniforms.uGrainSpeed={value:a},o.fragmentShader=o.fragmentShader.replace("#include <common>",`#include <common>

uniform sampler2D uNoiseTex;
uniform float uTime;
uniform float uGrainStrength;
uniform float uGrainScale;
uniform float uGrainSpeed;
`).replace("#include <dithering_fragment>",`#include <dithering_fragment>

// Subtle paper-grain (illustration vibe)
vec2 grainUv = vUv * uGrainScale + vec2(uTime * uGrainSpeed * 0.13, uTime * uGrainSpeed * 0.07);
float g = texture2D(uNoiseTex, fract(grainUv)).r;
float grain = (g - 0.5) * 0.28;
vec3 grained = gl_FragColor.rgb * (1.0 + grain);
gl_FragColor.rgb = mix(gl_FragColor.rgb, grained, uGrainStrength);
`),s.userData.__grainShader=o},s.userData.__grain={strength:n,scale:i,speed:a},s.needsUpdate=!0}function Os(s,e){if(!s)return;const t=s.userData?.__grainShader;t?.uniforms?.uTime&&(t.uniforms.uTime.value=Number(e)||0)}const eu=({album:s,basePosition:e,isFocused:t,dimmed:n,focusedPosition:i,faceOut:a,yaw:o,dragging:l,onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:h,onToggleFaceOut:m,onRotateLeft:f,onRotateRight:p,onClick:g,onDoubleClick:v})=>{const b=_.useRef(null),w=_.useRef(null),S=_.useRef(null),A=_.useRef(0),[x,T]=R.useState(!1),k=_.useMemo(()=>Qa(4),[]),y=_.useMemo(()=>eo(64),[]),j=_.useRef(null),C=_.useRef(null),O=_.useRef(null);_.useEffect(()=>(Es(j.current,y,{strength:.1,scale:18,speed:.28}),Es(C.current,y,{strength:.06,scale:14,speed:.22}),Es(O.current,y,{strength:.06,scale:12,speed:.2}),()=>{k.dispose(),y.dispose()}),[y,k]);const P=.22,U=1.45,E=.55,I=s.gallery?.spineColor||"#111111",{spineBaseColor:V,accentColor:F}=_.useMemo(()=>{const Y=new ks("#f7f5f0"),ee=new ks(I);return ee.lerp(new ks("#ffffff"),.55),n&&(Y.lerp(new ks("#d7d7d7"),.35),ee.lerp(new ks("#d7d7d7"),.55)),{spineBaseColor:`#${Y.getHexString()}`,accentColor:`#${ee.getHexString()}`}},[I,n]),X=n?"#b5b5b5":"#ffffff",z=s.title||s.mood,L=_.useMemo(()=>new Date(s.createdAt).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}),[s.createdAt]),H=Cc(Ic,s.imageDataURL);return _.useEffect(()=>{H.colorSpace=Ac,H.anisotropy=4,H.needsUpdate=!0},[H]),ps((Y,ee)=>{if(b.current){const M=t&&i?i:e;if(l)b.current.position.set(M[0],M[1],M[2]);else{const N=1-Math.exp(-(t?10:12)*ee);b.current.position.lerp(new Ht(M[0],M[1],M[2]),N)}}if(b.current){const M=typeof o=="number"?o:0;if(l)b.current.rotation.y=M;else{const D=1-Math.exp(-12*ee);b.current.rotation.y=Pn.lerp(b.current.rotation.y,M,D)}}const se=l||t?1:a?.35:0;if(A.current=Pn.lerp(A.current,se,1-Math.exp(-8*ee)),S.current){const M=A.current;S.current.position.z=E/2+.04+M*.85,S.current.position.y=.05+M*.06,S.current.scale.setScalar(.92+M*.08),S.current.visible=M>.01}if(w.current){const M=A.current;w.current.scale.y=1+M*.02}if(b.current&&!l){const M=t?1.06:n?.985:1,D=1-Math.exp(-10*ee),N=b.current.scale.x,G=Pn.lerp(N,M,D);b.current.scale.setScalar(G)}const B=Y.clock.elapsedTime;Os(j.current,B),Os(C.current,B),Os(O.current,B)}),r.jsxs("group",{ref:b,children:[r.jsxs("mesh",{ref:w,onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:Y=>{Y.stopPropagation();try{Y.nativeEvent?.preventDefault?.()}catch{}h?.()},onClick:Y=>{Y.stopPropagation(),g?.()},onDoubleClick:Y=>{Y.stopPropagation(),v?.()},onPointerOver:Y=>{Y.stopPropagation(),T(!0)},onPointerOut:Y=>{Y.stopPropagation(),T(!1)},castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[P,U,E]}),r.jsx("meshToonMaterial",{ref:j,color:V,gradientMap:k})]}),r.jsxs("mesh",{position:[0,.18,E/2+.002],castShadow:!1,children:[r.jsx("planeGeometry",{args:[P*.92,U*.22]}),r.jsx("meshToonMaterial",{ref:C,color:F,gradientMap:k,transparent:!!n,opacity:n?.35:.95})]}),r.jsxs("group",{position:[P/2-.05,U/2-.12,E/2+.03],children:[s.isPublic&&r.jsxs("mesh",{position:[0,0,0],children:[r.jsx("boxGeometry",{args:[.06,.06,.02]}),r.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1,transparent:!!n,opacity:n?.25:1})]}),s.isFavorite&&r.jsxs("mesh",{position:[0,-.08,0],children:[r.jsx("boxGeometry",{args:[.06,.06,.02]}),r.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1,transparent:!!n,opacity:n?.25:1})]})]}),x&&!l&&!n?r.jsx(Xi,{position:[0,U/2+.22,E/2+.06],center:!0,style:{pointerEvents:"none"},transform:!0,distanceFactor:8,children:r.jsxs("div",{className:"book-tooltip",children:[r.jsx("div",{className:"book-tooltip-title",children:z}),r.jsx("div",{className:"book-tooltip-sub",children:L})]})}):null,t&&!l?r.jsx(Xi,{position:[0,-U/2-.22,E/2+.08],center:!0,transform:!0,distanceFactor:10,style:{pointerEvents:"auto"},children:r.jsxs("div",{className:"book-focus-controls",children:[r.jsx("button",{type:"button",className:"book-focus-btn",onPointerDown:Y=>{Y.stopPropagation()},onClick:Y=>{Y.stopPropagation(),m?.()},children:a?"背表紙に戻す":"表紙を向ける"}),r.jsx("button",{type:"button",className:"book-focus-btn book-focus-icon","aria-label":"左に回転",onPointerDown:Y=>{Y.stopPropagation()},onClick:Y=>{Y.stopPropagation(),f?.()},children:"↺"}),r.jsx("button",{type:"button",className:"book-focus-btn book-focus-icon","aria-label":"右に回転",onPointerDown:Y=>{Y.stopPropagation()},onClick:Y=>{Y.stopPropagation(),p?.()},children:"↻"})]})}):null,r.jsxs("group",{ref:S,position:[0,.05,E/2+.04],visible:!1,children:[r.jsxs("mesh",{onPointerDown:c,onPointerMove:u,onPointerUp:d,onContextMenu:Y=>{Y.stopPropagation();try{Y.nativeEvent?.preventDefault?.()}catch{}h?.()},onClick:Y=>{Y.stopPropagation(),g?.()},onDoubleClick:Y=>{Y.stopPropagation(),v?.()},castShadow:!0,children:[r.jsx("planeGeometry",{args:[1.1,1.55]}),r.jsx("meshToonMaterial",{ref:O,map:H,color:X,gradientMap:k})]}),r.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[1.14,1.6]}),r.jsx("meshToonMaterial",{color:"#ffffff",opacity:n?.14:.45,transparent:!0,gradientMap:k})]})]})]})},to="airia-bookshelf-layout-v1",so="airia-bookshelf-layout-v2",ci="airia-bookshelf-layout-v3";function $r(s){try{const e=localStorage.getItem(s);return e?JSON.parse(e):null}catch{return null}}function tu(s){try{localStorage.setItem(ci,JSON.stringify(s))}catch{}}function su(s,e,t){const n=typeof s=="number"?s:Number(s);if(!Number.isFinite(n))return null;const i=Math.trunc(n);return i<e?e:i>t?t:i}function en(s,e){const t=new Set(e),n={};let i=!1;const a=new Set,o=[];if(s&&typeof s=="object")for(const[l,c]of Object.entries(s)){if(!t.has(l)){i=!0;continue}const u=su(c,0,1e4);if(u===null){i=!0;continue}if(a.has(u)){o.push(l),i=!0;continue}a.add(u),n[l]=u}for(const l of e){if(n[l]!==void 0)continue;let c=0;for(;a.has(c);)c+=1;a.add(c),n[l]=c,i=!0}for(const l of o){if(!t.has(l))continue;let c=0;for(;a.has(c);)c+=1;a.add(c),n[l]=c}return{slotById:n,changed:i}}function nu(s){const e=$r(so);if(e&&typeof e=="object"){const u=e.slotById&&typeof e.slotById=="object"?e.slotById:null,d=e.faceOutIds&&typeof e.faceOutIds=="object"?e.faceOutIds:void 0;return{slotById:en(u,s).slotById,faceOutIds:d}}const t=$r(to);if(!t||typeof t!="object")return null;const n={},i=Array.isArray(t.orderIds)?t.orderIds:[],a=new Set(s);let o=0;for(const u of i)a.has(u)&&(n[u]=o,o+=1);for(const u of s)n[u]===void 0&&(n[u]=o,o+=1);const l=t.faceOutIds&&typeof t.faceOutIds=="object"?t.faceOutIds:void 0;return{slotById:en(n,s).slotById,faceOutIds:l}}function kn(s){const e=$r(ci);if(e&&typeof e=="object"){const n=e.slotById&&typeof e.slotById=="object"?e.slotById:null,i=e.faceOutIds&&typeof e.faceOutIds=="object"?e.faceOutIds:void 0,a=e.poseById&&typeof e.poseById=="object"?e.poseById:void 0,o=e.yawById&&typeof e.yawById=="object"?e.yawById:void 0;return{slotById:en(n,s).slotById,faceOutIds:i,poseById:a,yawById:o}}const t=nu(s);return t?{slotById:t.slotById,faceOutIds:t.faceOutIds}:null}const ru=({albums:s,onBookClick:e,onBookOpen:t,constellationEnabled:n,inputRef:i,layoutEditEnabled:a,layoutSnapEnabled:o,layoutResetToken:l})=>{const{viewport:c}=Mc(),u=_.useRef(null),d=_.useRef(null),h=_.useRef(null),m=_.useMemo(()=>Qa(4),[]),f=_.useMemo(()=>eo(64),[]),p=_.useRef(null),g=_.useRef(null),v=_.useRef(null);_.useEffect(()=>(Es(p.current,f,{strength:.07,scale:14,speed:.25}),Es(g.current,f,{strength:.05,scale:10,speed:.18}),Es(v.current,f,{strength:.08,scale:16,speed:.22}),()=>{m.dispose(),f.dispose()}),[f,m]);const b=_.useMemo(()=>s.map(q=>q.id),[s]),[w,S]=_.useState(()=>{const q=kn(b);return en(q?.slotById??null,b).slotById}),[A,x]=_.useState(()=>{const $=kn(b)?.faceOutIds;return $&&typeof $=="object"?$:{}}),[T,k]=_.useState(()=>{const $=kn(b)?.poseById;return $&&typeof $=="object"?$:{}}),[y,j]=_.useState(()=>{const q=kn(b),$=q?.yawById;if($&&typeof $=="object")return $;const Z=q?.poseById,ie={};if(Z&&typeof Z=="object")for(const[me,ae]of Object.entries(Z)){const pe=ae?.yaw;typeof pe=="number"&&Number.isFinite(pe)&&(ie[me]=pe)}return ie}),[C,O]=_.useState(null),P=C!==null,U=_.useRef(0),E=_.useRef(0),I=_.useRef({activeId:null,pointerId:null,startSlot:-1,hoverSlot:-1,moved:!1,startClientX:0,startClientY:0,dragPos:null,mode:"move",startYaw:0,tempYaw:null});_.useEffect(()=>{const q=en(w,b);q.changed&&S(q.slotById)},[b,w]),_.useEffect(()=>{const q=new Set(b);x($=>{let Z=!1;const ie={};for(const[me,ae]of Object.entries($)){if(!q.has(me)){Z=!0;continue}ae&&(ie[me]=!0)}return Z?ie:$})},[b]),_.useEffect(()=>{const q=new Set(b);j($=>{let Z=!1;const ie={};for(const[me,ae]of Object.entries($)){if(!q.has(me)){Z=!0;continue}const pe=typeof ae=="number"?ae:Number(ae);if(!Number.isFinite(pe)){Z=!0;continue}ie[me]=pe}return Z?ie:$})},[b]),_.useEffect(()=>{const q=new Set(b);k($=>{let Z=!1;const ie={};for(const[me,ae]of Object.entries($)){if(!q.has(me)){Z=!0;continue}if(!ae||typeof ae!="object"){Z=!0;continue}const pe=typeof ae.x=="number"?ae.x:Number(ae.x),Fe=typeof ae.y=="number"?ae.y:Number(ae.y);if(!Number.isFinite(pe)||!Number.isFinite(Fe)){Z=!0;continue}const ye=ae.yaw,Le=typeof ye=="number"&&Number.isFinite(ye)?ye:void 0;ie[me]={x:pe,y:Fe,yaw:Le}}return Z?ie:$})},[b]),_.useEffect(()=>{tu({slotById:w,faceOutIds:A,poseById:T,yawById:y})},[w,A,T,y]),_.useEffect(()=>{if(!l)return;try{localStorage.removeItem(ci),localStorage.removeItem(so),localStorage.removeItem(to)}catch{}const q={};for(let $=0;$<b.length;$+=1)q[b[$]]=$;S(q),x({}),k({}),j({}),O(null)},[l,b]),_.useEffect(()=>{C?i.current.blockPan=!0:I.current.activeId||(i.current.blockPan=!1)},[C,i]);const V=_.useMemo(()=>{const q=new Map;for(const $ of s)q.set($.id,$);return q},[s]),F=14,X=_.useMemo(()=>{let q=-1;for(const $ of b){const Z=w[$];typeof Z=="number"&&Number.isFinite(Z)&&(q=Math.max(q,Math.trunc(Z)))}return q},[b,w]),z=Math.max(3,Math.ceil(Math.max(1,b.length,X+1)/F)),L=.3,H=.22,Y=.6,ee=F,se=(ee-1)*L+H,B=se+Y*2,M=_.useMemo(()=>Array.from({length:z},(Z,ie)=>1.35-ie*1.3),[z]),D=_.useMemo(()=>{const q=M[0]+.6,$=M[M.length-1]-.72,Z=Math.max(3.8,q-$),ie=(q+$)/2;return{topFrameY:q,bottomFrameY:$,height:Z,centerY:ie}},[M]),N=_.useMemo(()=>Math.max(0,B/2-c.width/2+.4),[B,c.width]),G=(q,$,Z)=>Math.max($,Math.min(Z,q)),ce=q=>{const $=Math.max(0,q),Z=Math.min(z-1,Math.floor($/ee)),ie=$%ee,me=-se/2+ie*L,ae=M[Z]??M[0];return{x:me,y:ae,z:0,shelfIndex:Z,col:ie}},le=[0,.55,1.55],Qe=()=>{O(null),I.current.activeId||(i.current.blockPan=!1)},lt=q=>{x($=>{const Z={...$,[q]:!$[q]};return Z[q]||delete Z[q],Z})},Pt=(q,$)=>{const Z=Math.PI/12*$;j(ie=>({...ie,[q]:(ie[q]??0)+Z}))},K=q=>{G(Math.round((M[0]-q.y)/(M[0]-M[M.length-1])*(z-1)),0,z-1);let $=0,Z=1/0;for(let ae=0;ae<M.length;ae+=1){const pe=Math.abs(q.y-M[ae]);pe<Z&&(Z=pe,$=ae)}const ie=G(q.x,-se/2,se/2),me=G(Math.round((ie+se/2)/L),0,ee-1);return $*ee+me};ps((q,$)=>{const Z=i.current;if(!!I.current.activeId){Z.wheelPx=0,Z.dragPx=0,Z.isDragging=!1;return}const me=.0022,ae=Z.wheelPx*me,pe=Z.dragPx*me;ae!==0&&(E.current+=ae*26,Z.wheelPx=0),pe!==0&&(U.current+=pe,E.current=Pn.lerp(E.current,pe*60,.35),Z.dragPx=0);const Fe=Z.isDragging?.88:.92;E.current*=Math.pow(Fe,$*60),U.current+=E.current*$;const ye=32;U.current<-N?(U.current=-N,E.current*=-.35):U.current>N&&(U.current=N,E.current*=-.35),U.current<-N?E.current+=(-N-U.current)*ye*$:U.current>N&&(E.current-=(U.current-N)*ye*$),u.current&&(u.current.position.x=G(U.current,-N,N));const Le=q.clock.elapsedTime,it=Math.floor(Le*12)/12;d.current&&(d.current.intensity=.78+Math.sin(it*1.2)*.04),h.current&&(h.current.intensity=.24+Math.cos(it*1.05)*.02),Os(p.current,Le),Os(g.current,Le),Os(v.current,Le)});const[Q,_e]=_.useState(-1),ge=(q,$,Z)=>{i.current.blockPan=!0,I.current.activeId=q,I.current.pointerId=Number($?.pointerId??-1),I.current.startSlot=Z,I.current.hoverSlot=Z,I.current.moved=!1,I.current.mode=$?.shiftKey?"rotate":"move",I.current.startYaw=y[q]??0,I.current.tempYaw=null,I.current.startClientX=Number($?.clientX??$?.nativeEvent?.clientX??0),I.current.startClientY=Number($?.clientY??$?.nativeEvent?.clientY??0);const ie=T[q],me=ce(Z);I.current.dragPos={x:ie?.x??me.x,y:ie?.y??me.y,z:.85},_e(Z);try{$.stopPropagation?.(),$?.nativeEvent?.target?.setPointerCapture?.($.pointerId)}catch{}},de=q=>{if(!I.current.activeId)return;const Z=I.current.pointerId;if(Z!==null&&Number(q?.pointerId??-1)!==Z||!u.current)return;const ie=Number(q?.clientX??q?.nativeEvent?.clientX??0),me=Number(q?.clientY??q?.nativeEvent?.clientY??0),ae=ie-I.current.startClientX,pe=me-I.current.startClientY;if(!I.current.moved&&ae*ae+pe*pe>36&&(I.current.moved=!0),I.current.mode==="rotate"){const Xe=I.current.startYaw+ae*.012;I.current.tempYaw=Xe;const W=I.current.dragPos;W&&(I.current.dragPos={...W});return}const Fe=q?.ray;if(!Fe)return;const ye=new Ec(new Ht(0,0,1),-.25),Le=new Ht;if(!Fe.intersectPlane(ye,Le))return;const ut=u.current.worldToLocal(Le.clone()),We=K(ut);I.current.hoverSlot=We,I.current.dragPos={x:G(ut.x,-se/2,se/2),y:ut.y,z:.85},_e(We)},ve=(q,$)=>{if(I.current.activeId!==q)return;const Z=I.current.startSlot,ie=I.current.hoverSlot,me=I.current.moved,ae=I.current.mode,pe=I.current.tempYaw;I.current.activeId=null,I.current.pointerId=null,I.current.startSlot=-1,I.current.hoverSlot=-1,I.current.moved=!1,I.current.dragPos=null,I.current.mode="move",I.current.startYaw=0,I.current.tempYaw=null,_e(-1),i.current.blockPan=!1;try{$?.nativeEvent?.target?.releasePointerCapture?.($.pointerId)}catch{}if(!me){C===q?(t||e)(q):e(q);return}if(ae==="rotate"){typeof pe=="number"&&Number.isFinite(pe)&&j(Fe=>({...Fe,[q]:pe}));return}if(a){const Fe=I.current.dragPos,ye=Fe?.x??0,Le=Fe?.y??0,it=G(ye,-se/2,se/2),ut=G(Le,M[M.length-1],M[0]);if(o){const We=K(new Ht(it,ut,0));Z>=0&&We>=0&&Z!==We&&S(Xe=>{const W=Math.max(0,Z),oe=Math.max(0,We);let J=null;for(const[xe,ke]of Object.entries(Xe))if(xe!==q&&Math.trunc(ke)===oe){J=xe;break}const te={...Xe,[q]:oe};return J&&(te[J]=W),te}),k(Xe=>{if(!Xe[q])return Xe;const W={...Xe};return delete W[q],W})}else k(We=>{const Xe=We[q]?.yaw;return{...We,[q]:{x:it,y:ut,yaw:Xe}}});return}Z>=0&&ie>=0&&Z!==ie&&S(Fe=>{const ye=Math.max(0,Z),Le=Math.max(0,ie);let it=null;for(const[We,Xe]of Object.entries(Fe))if(We!==q&&Math.trunc(Xe)===Le){it=We;break}const ut={...Fe,[q]:Le};return it&&(ut[it]=ye),ut})},He=q=>{O($=>$===q?null:q),e(q)},et=q=>{const $=I.current.activeId;$&&ve($,q)};return r.jsxs("group",{children:[r.jsx("fog",{attach:"fog",args:["#f5f1ea",6.5,15.5]}),r.jsxs("mesh",{position:[0,-2.15,0],receiveShadow:!0,rotation:[-Math.PI/2,0,0],children:[r.jsx("planeGeometry",{args:[40,20]}),r.jsx("meshToonMaterial",{ref:p,color:"#f6f0e8",gradientMap:m})]}),r.jsxs("mesh",{position:[0,.1,-1.05],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[40,10]}),r.jsx("meshToonMaterial",{ref:g,color:"#fff9f0",gradientMap:m})]}),r.jsxs("group",{ref:u,children:[r.jsxs("mesh",{position:[0,.05,.26],onPointerDown:q=>{C&&(I.current.activeId||(q.stopPropagation(),Qe()))},onPointerMove:q=>de(q),onPointerUp:q=>et(q),onPointerCancel:q=>et(q),children:[r.jsx("planeGeometry",{args:[Math.max(14,B+4),Math.max(7,M[0]-M[M.length-1]+5.2)]}),r.jsx("meshBasicMaterial",{transparent:!0,opacity:0,depthWrite:!1})]}),P?r.jsxs("mesh",{position:[0,.05,-.15],raycast:null,children:[r.jsx("planeGeometry",{args:[Math.max(18,B+10),9]}),r.jsx("meshBasicMaterial",{color:"#0b0b0b",opacity:.12,transparent:!0,depthWrite:!1})]}):null,r.jsxs("group",{position:[0,.05,-.25],children:[r.jsxs("mesh",{position:[-B/2+.08,D.centerY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[.16,D.height,.9]}),r.jsx("meshToonMaterial",{ref:v,color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[B/2-.08,D.centerY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[.16,D.height,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[0,D.topFrameY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[B,.18,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),r.jsxs("mesh",{position:[0,D.bottomFrameY,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[B,.18,.9]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]}),M.map((q,$)=>r.jsxs("mesh",{position:[0,q-.78,0],castShadow:!0,receiveShadow:!0,children:[r.jsx("boxGeometry",{args:[B-.22,.14,.88]}),r.jsx("meshToonMaterial",{color:"#ffffff",gradientMap:m})]},$))]}),Q>=0&&(!a||o)?r.jsxs("mesh",{position:[ce(Q).x,ce(Q).y-.78+.09,.32],rotation:[-Math.PI/2,0,0],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[.34,.72]}),r.jsx("meshStandardMaterial",{color:"#d9d9d9",opacity:.45,transparent:!0,roughness:1,metalness:0})]}):null,b.slice().sort((q,$)=>{const Z=w[q]??999999,ie=w[$]??999999;if(Z!==ie)return Z-ie;const me=V.get(q),ae=V.get($);return String(ae?.createdAt??"").localeCompare(String(me?.createdAt??""))}).map(q=>{const $=V.get(q);if(!$)return null;const Z=w[q]??0,ie=ce(Z),me=I.current.activeId===q,ae=me?I.current.dragPos:null,pe=C===q,Fe=P&&!pe,ye=T[q],Le=ye&&typeof ye.x=="number"&&typeof ye.y=="number",it=ae?[ae.x,ae.y,ae.z]:[Le?ye.x:ie.x,Le?ye.y:ie.y,P&&!pe?.12:.25],We=me&&I.current.activeId===q&&I.current.mode==="rotate"?I.current.tempYaw:null,Xe=typeof We=="number"&&Number.isFinite(We)?We:y[q]??0;return r.jsx(eu,{album:$,basePosition:it,isFocused:pe,dimmed:Fe,focusedPosition:le,faceOut:!!A[$.id],yaw:Xe,dragging:me,onPointerDown:W=>ge($.id,W,Z),onPointerMove:W=>de(W),onPointerUp:W=>ve($.id,W),onContextMenu:()=>lt($.id),onToggleFaceOut:()=>lt($.id),onRotateLeft:()=>Pt($.id,-1),onRotateRight:()=>Pt($.id,1),onClick:()=>{C===q?(t||e)(q):e(q)},onDoubleClick:()=>He(q)},$.id)})]}),P?r.jsx("pointLight",{position:[0,.8,3.6],intensity:.45,distance:12,decay:2}):null,r.jsx("ambientLight",{intensity:.42}),r.jsx("hemisphereLight",{args:["#fff6e6","#e9e2d6",.22]}),r.jsx("directionalLight",{ref:d,position:[4,6,6],intensity:.78,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),r.jsx("directionalLight",{ref:h,position:[-3,3,4],intensity:.24,color:"#ffe9d6"})]})},iu=({albums:s,onBookClick:e,onBookOpen:t,constellationEnabled:n,layoutEditEnabled:i,layoutSnapEnabled:a,layoutResetToken:o})=>{const l=_.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0,blockPan:!1});return r.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:c=>{if(c.preventDefault(),l.current.blockPan)return;const u=Math.abs(c.deltaX)>Math.abs(c.deltaY)?c.deltaX:c.deltaY;l.current.wheelPx+=u},onPointerDown:c=>{l.current.blockPan||i&&!c.altKey||(c.currentTarget.setPointerCapture(c.pointerId),l.current.isDragging=!0,l.current.lastPointerX=c.clientX)},onPointerMove:c=>{if(l.current.blockPan||!l.current.isDragging||i&&!c.altKey)return;const u=c.clientX-l.current.lastPointerX;l.current.lastPointerX=c.clientX,l.current.dragPx+=u},onPointerUp:c=>{try{c.currentTarget.releasePointerCapture(c.pointerId)}catch{}l.current.isDragging=!1,l.current.blockPan=!1},onPointerCancel:()=>{l.current.isDragging=!1,l.current.blockPan=!1},children:r.jsx(Ws,{shadows:!0,camera:{position:[0,.55,7.2],fov:34},gl:{alpha:!0,antialias:!0},children:r.jsx(_.Suspense,{fallback:null,children:r.jsx(ru,{albums:s,onBookClick:e,onBookOpen:t,constellationEnabled:n,inputRef:l,layoutEditEnabled:!!i,layoutSnapEnabled:a??!0,layoutResetToken:o??0})})})})},ls=({title:s,mood:e,imageUrl:t,meta:n,badges:i=[],variant:a="default",className:o})=>r.jsxs("div",{className:`album-card album-card-${a} ${o||""}`.trim(),children:[r.jsx("div",{className:"album-card-image",children:r.jsx("img",{src:t,alt:s,loading:"lazy"})}),r.jsxs("div",{className:"album-card-body",children:[r.jsx("div",{className:"album-card-title",children:s}),e&&r.jsx("div",{className:"album-card-mood",children:e}),n&&r.jsx("div",{className:"album-card-meta",children:n}),i.length>0&&r.jsx("div",{className:"album-card-badges",children:i.map(l=>r.jsx("span",{className:`album-badge tone-${l.tone||"default"}`,children:l.label},l.label))})]})]}),au=({title:s,description:e,actionLabel:t,onAction:n,icon:i})=>r.jsxs("div",{className:"empty-state",children:[i&&r.jsx("div",{className:"empty-icon",children:i}),r.jsx("h2",{className:"empty-title",children:s}),r.jsx("p",{className:"empty-description",children:e}),t&&n&&r.jsx("button",{onClick:n,className:"empty-cta-button",children:t})]}),Bn=({trigger:s,children:e,placement:t="bottom",triggerClassName:n,triggerAriaLabel:i,triggerAriaHaspopup:a,onOpenChange:o})=>{const[l,c]=_.useState(!1),u=_.useRef(null),d=_.useRef(null),h=_.useId(),m=()=>{c(!1),o?.(!1),d.current?.focus()},f=()=>{c(p=>{const g=!p;return o?.(g),g})};return _.useEffect(()=>{if(!l)return;const p=v=>{u.current?.contains(v.target)||m()},g=v=>{v.key==="Escape"&&(v.preventDefault(),m())};return document.addEventListener("mousedown",p),document.addEventListener("keydown",g),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",g)}},[l]),r.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[r.jsx("button",{ref:d,type:"button",className:`popover-trigger ${n||""}`.trim(),onClick:f,"aria-expanded":l,"aria-controls":l?h:void 0,"aria-label":i,"aria-haspopup":a,children:s}),l&&r.jsx("div",{className:"popover-panel",id:h,children:typeof e=="function"?e({close:m}):e})]})},qn=({items:s,autoFocus:e=!0})=>{const[t,n]=R.useState(0),i=R.useRef([]);R.useEffect(()=>{if(!e||s.length===0)return;const l=i.current[0];l&&l.focus()},[e,s.length]);const a=l=>{const c=Math.max(0,Math.min(s.length-1,l));n(c),i.current[c]?.focus()},o=l=>{if(s.length!==0){if(l.key==="ArrowDown"){l.preventDefault(),a(t+1);return}if(l.key==="ArrowUp"){l.preventDefault(),a(t-1);return}if(l.key==="Home"){l.preventDefault(),a(0);return}if(l.key==="End"){l.preventDefault(),a(s.length-1);return}}};return r.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:o,children:s.map((l,c)=>r.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:c===t?0:-1,ref:u=>{i.current[c]=u},onFocus:()=>n(c),onClick:()=>{n(c),l.onSelect()},type:"button",children:l.label},l.id))})},no=({items:s,value:e,onChange:t,ariaLabel:n="タブ"})=>{const i=_.useId();return r.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[r.jsx("div",{className:"tabs-list",role:"tablist","aria-label":n,children:s.map(a=>r.jsx("button",{id:`${i}-${a.id}-tab`,role:"tab","aria-selected":e===a.id,"aria-controls":`${i}-${a.id}-panel`,className:`tab-button ${e===a.id?"is-active":""}`,onClick:()=>t(a.id),type:"button",children:a.label},a.id))}),s.map(a=>r.jsx("div",{id:`${i}-${a.id}-panel`,role:"tabpanel","aria-labelledby":`${i}-${a.id}-tab`,hidden:e!==a.id,className:"tab-panel",children:a.content},a.id))]})},zr=({options:s,value:e,onChange:t,ariaLabel:n="選択"})=>r.jsx("div",{className:"segmented-control",role:"group","aria-label":n,"data-no-swipe":"true",children:s.map(i=>r.jsx("button",{type:"button",className:`segmented-item ${e===i.id?"is-active":""}`,"aria-pressed":e===i.id,onClick:()=>t(i.id),children:i.label},i.id))}),ou=()=>{const{albums:s,selectAlbum:e,updateAlbum:t}=Lt(),{getSelectedAlbum:n}=Lt(),i=n(),{requestPlayAlbum:a}=ts(),{navigateToRoom:o}=Ut(),[l,c]=R.useState("shelf"),[u,d]=R.useState("all"),[h,m]=R.useState("new"),[f,p]=R.useState("public"),[g,v]=R.useState(!1),[b,w]=R.useState(!0),[S,A]=R.useState(0),x=I=>{e(I)},T=I=>{e(I),o("album")},k=R.useMemo(()=>s.filter(I=>I.musicData),[s]),y=!!i,j=!!i?.musicData,C=R.useMemo(()=>{const I=s.filter(F=>u==="public"?F.isPublic:u==="private"?!F.isPublic:u==="favorite"?F.isFavorite:!0),V=F=>{const X=Number(F.duration||0);return(F.musicData?1e3:0)+X};return I.slice().sort((F,X)=>h==="duration"?(X.duration||0)-(F.duration||0):h==="popular"?V(X)-V(F):String(X.createdAt).localeCompare(String(F.createdAt)))},[s,u,h]),O=h==="popular"?"人気順":h==="duration"?"長さ順":"新しい順",P=r.jsxs("div",{className:"bookshelf-container",children:[r.jsxs("div",{className:`gallery-shelf-stage ${C.length===0?"empty":""}`,children:[r.jsxs("div",{className:"gallery-shelf-hint","aria-hidden":"true",children:[r.jsx("span",{className:"gallery-shelf-hint-pill",children:"HINT"}),r.jsx("span",{className:"gallery-shelf-hint-text",children:"右クリックで表紙 / 背表紙を切り替え（保存されます）"})]}),r.jsx(iu,{albums:C,onBookClick:x,onBookOpen:T,constellationEnabled:!1,layoutEditEnabled:g,layoutSnapEnabled:b,layoutResetToken:S}),C.length===0&&r.jsx("div",{className:"empty-shelf-overlay",children:r.jsx(au,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>o("main"),icon:r.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),r.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[r.jsxs("div",{className:"gallery-selection",children:[r.jsx("div",{className:"gallery-selection-label",children:"選択中"}),r.jsx("div",{className:"gallery-selection-value",children:i?i.title||i.mood:"未選択"})]}),r.jsxs("div",{className:"gallery-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!y,onClick:()=>o("album"),children:"開く"}),r.jsx("button",{className:"btn btn-primary",disabled:!j||!i,onClick:()=>{i&&a(i,k)},children:"再生"}),r.jsx("button",{className:"btn",disabled:!y,onClick:()=>o("social"),children:"公開"}),r.jsx(Bn,{triggerClassName:"btn",trigger:r.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:I})=>r.jsx(qn,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{o("album"),I()}},{id:"publish",label:"SNSに公開",onSelect:()=>{o("social"),I()}},{id:"play",label:"再生",onSelect:()=>{i&&(a(i,k),I())}},{id:"favorite",label:i?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{i&&(t(i.id,{isFavorite:!i.isFavorite}),I())}},{id:"public",label:i?.isPublic?"非公開にする":"公開にする",onSelect:()=>{i&&(t(i.id,{isPublic:!i.isPublic}),I())}}]})})]})]})]}),U=r.jsx("div",{className:"gallery-focus",children:i?r.jsxs("div",{className:"gallery-focus-card room-card",children:[r.jsx(ls,{title:i.title||i.mood,mood:i.mood,imageUrl:i.imageDataURL,meta:`作成日: ${new Date(i.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:i.musicData?"再生可能":"音声なし",tone:i.musicData?"success":"default"},...i.isPublic?[{label:"公開中",tone:"info"}]:[],...i.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),r.jsxs("div",{className:"gallery-focus-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:()=>o("album"),children:"詳細へ"}),r.jsx("button",{className:"btn btn-primary",disabled:!i.musicData,onClick:()=>a(i,k),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>o("social"),children:"公開"})]})]}):r.jsxs("div",{className:"gallery-focus-empty room-card",children:[r.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),r.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),E=[{id:"shelf",label:"Shelf",content:P},{id:"focus",label:"Focus",content:U}];return r.jsxs("div",{className:"room-content gallery-room",children:[r.jsx(Xa,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),r.jsx("h1",{className:"sr-only",children:"GALLERY"}),r.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"gallery-toolbar-left",children:[r.jsx(zr,{value:u,onChange:I=>d(I),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),r.jsxs("div",{className:"gallery-filter-tags",children:[r.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),r.jsx("span",{className:"filter-tag",children:O}),r.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",f==="public"?"公開":"お気に入り"]})]})]}),r.jsxs("div",{className:"gallery-toolbar-right",children:[r.jsx("button",{type:"button",className:`btn ${g?"btn-primary":""}`,onClick:()=>v(I=>!I),"aria-pressed":g,children:g?"レイアウト編集: ON":"レイアウト編集: OFF"}),g?r.jsxs(r.Fragment,{children:[r.jsx("button",{type:"button",className:"btn",onClick:()=>w(I=>!I),"aria-pressed":b,children:b?"スナップ: ON":"スナップ: OFF"}),r.jsx("button",{type:"button",className:"btn",onClick:()=>A(I=>I+1),children:"配置リセット"})]}):null,r.jsx(zr,{value:f,onChange:I=>p(I),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),r.jsx(Bn,{triggerClassName:"btn",trigger:r.jsxs("span",{children:["並び替え: ",O]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:I})=>r.jsx(qn,{items:[{id:"new",label:"新しい順",onSelect:()=>{m("new"),I()}},{id:"popular",label:"人気順",onSelect:()=>{m("popular"),I()}},{id:"duration",label:"長さ順",onSelect:()=>{m("duration"),I()}}]})})]})]}),r.jsx(no,{items:E,value:l,onChange:c,ariaLabel:"ギャラリー表示"})]})},cu=2147483647,lu=({log:s})=>{if(!s)return r.jsxs("div",{className:"explainability-panel",children:[r.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),r.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const n=Math.round(t/1e3);if(n<60)return`${n}秒`;const i=Math.floor(n/60),a=n%60;return`${i}分${a}秒`};return r.jsxs("div",{className:"explainability-panel",children:[r.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),s.analysis&&r.jsxs("div",{className:"explainability-section timeline-section",children:[r.jsx("h4",{className:"section-title",children:"生成フロー"}),r.jsxs("div",{className:"timeline",children:[r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"入力"}),r.jsx("span",{className:"timeline-value",children:new Date(s.input.timestamp).toLocaleTimeString("ja-JP")})]}),s.analysis&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"解析"}),r.jsxs("span",{className:"timeline-value",children:[e(s.analysis.duration)," (",s.analysis.provider,")"]})]}),s.imageGeneration&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"画像生成"}),r.jsxs("span",{className:"timeline-value",children:[e(s.imageGeneration.duration)," (",s.imageGeneration.provider,")"]})]}),s.musicGeneration&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"音楽生成"}),r.jsxs("span",{className:"timeline-value",children:[e(s.musicGeneration.duration)," (",s.musicGeneration.provider,")"]})]}),s.album&&r.jsxs("div",{className:"timeline-item",children:[r.jsx("span",{className:"timeline-label",children:"完成"}),r.jsxs("span",{className:"timeline-value",children:["合計: ",e(s.totalDuration)]})]})]})]}),s.analysis&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"感情分析"}),r.jsxs("div",{className:"analysis-explanation",children:[r.jsxs("div",{className:"ir-values",children:[r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Valence:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${(s.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:s.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),r.jsx("span",{className:"ir-number",children:s.analysis.intermediateRepresentation.valence.toFixed(2)})]}),r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Arousal:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${s.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),r.jsx("span",{className:"ir-number",children:s.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),r.jsxs("div",{className:"ir-value",children:[r.jsx("span",{className:"ir-label",children:"Focus:"}),r.jsx("div",{className:"ir-gauge",children:r.jsx("div",{className:"ir-gauge-fill",style:{width:`${s.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),r.jsx("span",{className:"ir-number",children:s.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),r.jsxs("div",{className:"motif-tags",children:[r.jsx("strong",{children:"モチーフタグ:"})," ",s.analysis.intermediateRepresentation.motif_tags.join("、")]}),r.jsxs("div",{className:"reasoning-text",children:[r.jsx("strong",{children:"理由:"})," ",s.analysis.reasoning]})]})]}),s.imageGeneration&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),r.jsxs("div",{className:"image-explanation",children:[r.jsx("p",{className:"reasoning-text",children:s.imageGeneration.reasoning}),r.jsxs("div",{className:"image-details",children:[r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"スタイル:"}),r.jsx("span",{className:"detail-value",children:s.imageGeneration.stylePreset})]}),s.imageGeneration.seed&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"Seed:"}),r.jsx("span",{className:"detail-value",children:s.imageGeneration.seed})]}),r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"モデル:"}),r.jsx("span",{className:"detail-value",children:s.imageGeneration.model})]})]})]})]}),s.musicGeneration&&r.jsxs("div",{className:"explainability-section",children:[r.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),r.jsxs("div",{className:"music-explanation",children:[r.jsx("p",{className:"reasoning-text",children:s.musicGeneration.reasoning}),r.jsx("div",{className:"music-details",children:s.musicGeneration.structure&&typeof s.musicGeneration.structure=="object"&&r.jsxs(r.Fragment,{children:[s.musicGeneration.structure.key&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"調:"}),r.jsx("span",{className:"detail-value",children:s.musicGeneration.structure.key})]}),s.musicGeneration.structure.tempo&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"テンポ:"}),r.jsxs("span",{className:"detail-value",children:[s.musicGeneration.structure.tempo," BPM"]})]}),s.musicGeneration.structure.timeSignature&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"拍子:"}),r.jsx("span",{className:"detail-value",children:s.musicGeneration.structure.timeSignature})]}),s.musicGeneration.structure.form&&r.jsxs("div",{className:"detail-item",children:[r.jsx("span",{className:"detail-label",children:"形式:"}),r.jsx("span",{className:"detail-value",children:s.musicGeneration.structure.form})]})]})})]})]}),s.errors&&s.errors.length>0&&r.jsxs("div",{className:"explainability-section error-section",children:[r.jsx("h4",{className:"section-title",children:"エラー"}),r.jsx("div",{className:"errors-list",children:s.errors.map((t,n)=>r.jsxs("div",{className:"error-item",children:[r.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),r.jsx("span",{className:"error-message",children:t.error})]},n))})]})]})},uu=({dominantColors:s=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:n=0,highlightedLayer:i=-1})=>{const a=_.useRef(null),o=_.useRef(),l=_.useRef([]);return _.useEffect(()=>{const c=a.current;if(!c)return;const u=c.getContext("2d");if(!u)return;const d=()=>{const p=c.parentElement;p&&(c.width=p.clientWidth,c.height=p.clientHeight)};d(),window.addEventListener("resize",d);const h=Math.min(5,s.length+2);l.current=Array.from({length:h},(p,g)=>({radius:50+g*30,maxRadius:200+g*50,color:s[g%s.length]||"#D4AF37",phase:g*Math.PI*2/h,phaseSpeed:5e-4+g*2e-4}));let m=0;const f=p=>{const g=p-m;m=p,u.clearRect(0,0,c.width,c.height);const v=c.width/2,b=c.height/2;l.current.forEach((w,S)=>{w.phase+=w.phaseSpeed*g;const A=Math.sin(w.phase),x=20+(e?t*30:0),T=w.radius+A*x,k=.1,y=.3,j=n*.2,C=i===S?.3:0,O=e?t*.15:0,P=Math.min(y,k+j+C+O),U=u.createRadialGradient(v,b,T-20,v,b,T+20);U.addColorStop(0,`${w.color}00`),U.addColorStop(.5,`${w.color}${Math.floor(P*255).toString(16).padStart(2,"0")}`),U.addColorStop(1,`${w.color}00`),u.fillStyle=U,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(v,b,T,0,Math.PI*2),u.fill()}),o.current=requestAnimationFrame(f)};return o.current=requestAnimationFrame(f),()=>{window.removeEventListener("resize",d),o.current&&cancelAnimationFrame(o.current),u.clearRect(0,0,c.width,c.height)}},[s,e,t,n,i]),r.jsx("canvas",{ref:a,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},du=()=>{const[s,e]=_.useState({x:0,y:0});return _.useEffect(()=>{const t=n=>{e({x:n.clientX,y:n.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),s},hu=(s,e=200)=>{const[t,n]=_.useState(0),i=du();return _.useEffect(()=>{if(!s.current)return;const a=s.current.getBoundingClientRect(),o=a.left+a.width/2,l=a.top+a.height/2,c=Math.sqrt(Math.pow(i.x-o,2)+Math.pow(i.y-l,2)),u=Math.max(0,1-c/e);n(u)},[i,s,e]),t},mu=()=>{const{getSelectedAlbum:s,selectAlbum:e,addAlbum:t,updateAlbum:n}=Lt(),{getLog:i}=Wa(),{state:a,requestPlayAlbum:o}=ts(),{navigateToRoom:l}=Ut(),c=s(),u=E=>{const I=new Date(E);return Number.isNaN(I.getTime())?"":I.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},[d,h]=_.useState("");_.useEffect(()=>{h(c?.memo||"")},[c?.id]);const m=c?.causalLogId?i(c.causalLogId):void 0,f=(E,I=2400)=>{try{const V=JSON.stringify(E,null,2)??"";return V.length<=I?V:`${V.slice(0,I)}
…(truncated)`}catch{return""}},[p,g]=_.useState(!1),[v,b]=_.useState(null),[w,S]=_.useState(!1),A=_.useRef(null),x=hu(A,300),[T,k]=_.useState(-1),y=E=>{const I=A.current;if(!I)return;const V=I.getBoundingClientRect(),F=(E.clientX-V.left)/Math.max(1,V.width),X=(E.clientY-V.top)/Math.max(1,V.height),z=Math.max(0,Math.min(1,F)),L=Math.max(0,Math.min(1,X)),H=(z-.5)*10,Y=(.5-L)*7;I.style.setProperty("--tilt-x",`${Y.toFixed(2)}deg`),I.style.setProperty("--tilt-y",`${H.toFixed(2)}deg`),I.style.setProperty("--shine-x",`${(z*100).toFixed(1)}%`),I.style.setProperty("--shine-y",`${(L*100).toFixed(1)}%`)},j=()=>{const E=A.current;E&&(E.style.setProperty("--tilt-x","0deg"),E.style.setProperty("--tilt-y","0deg"),E.style.setProperty("--shine-x","50%"),E.style.setProperty("--shine-y","45%"))},C=c?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],O=a.playbackState===Tt.PLAYING&&a.currentAlbum?.id===c?.id,P=()=>{e(null),l("gallery")},U=async()=>{if(!c||!c.metadata){b("メタデータが見つかりません");return}try{g(!0),b(null),S(!1);const E=Math.floor(Math.random()*cu),I=await Gr({mood:c.mood,duration:c.duration,motifTags:c.metadata.motif_tags||[],stylePreset:c.metadata.stylePreset,seed:E,valence:c.metadata.valence,arousal:c.metadata.arousal,focus:c.metadata.focus,confidence:c.metadata.confidence}),V=await Rn(I.jobId,F=>{console.log("Regenerate status:",F)});if(V.status==="succeeded"&&V.resultUrl)t({mood:c.mood,duration:c.duration,imageDataURL:V.resultUrl,sessionData:c.sessionData,metadata:{...c.metadata,seed:E}}),S(!0),setTimeout(()=>S(!1),3e3);else throw new Error(V.errorMessage||"再生成に失敗しました")}catch(E){b(E instanceof Error?E.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",E)}finally{g(!1)}};return c?r.jsxs("div",{className:"room-content album-room",children:[r.jsxs("div",{className:"album-header room-header",children:[r.jsxs("div",{className:"album-header-left",children:[r.jsx("h1",{className:"album-title",children:c.title||c.mood}),r.jsxs("p",{className:"album-subtitle",children:["ムード: ",c.mood," ・ 選択したアルバムの詳細"]})]}),r.jsxs("div",{className:"album-header-actions room-header-actions",children:[r.jsx("button",{className:"btn back-to-gallery-btn",onClick:P,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),r.jsx("button",{className:"btn btn-primary",disabled:!c.musicData,onClick:()=>o(c),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>l("social"),children:"公開"}),r.jsx(Bn,{triggerClassName:"btn",trigger:r.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:E})=>r.jsx(qn,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{l("gallery"),E()}},{id:"publish",label:"SNSに公開",onSelect:()=>{l("social"),E()}},{id:"play",label:"再生",onSelect:()=>{o(c),E()}},{id:"favorite",label:c.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{n(c.id,{isFavorite:!c.isFavorite}),E()}},{id:"public",label:c.isPublic?"非公開にする":"公開にする",onSelect:()=>{n(c.id,{isPublic:!c.isPublic}),E()}}]})})]})]}),r.jsxs("div",{className:"album-details",children:[r.jsx("div",{className:"album-media",children:r.jsxs("div",{className:`album-image-container ${O?"is-playing":""}`,ref:A,onMouseMove:y,onMouseLeave:j,children:[r.jsx(uu,{dominantColors:C,isPlaying:O,beatAmplitude:0,mouseProximity:x,highlightedLayer:T}),r.jsx("img",{src:c.imageDataURL,alt:`${c.mood}のセッション画像`,className:"album-image"})]})}),r.jsxs("div",{className:"album-metadata",children:[r.jsxs("div",{className:"album-meta-card","data-no-swipe":"true",children:[r.jsx("div",{className:"album-meta-title",children:"作品情報"}),r.jsxs("div",{className:"album-meta-grid",children:[r.jsx("div",{className:"album-meta-k",children:"タイトル"}),r.jsx("div",{className:"album-meta-v",children:c.title||c.mood}),r.jsx("div",{className:"album-meta-k",children:"作成"}),r.jsx("div",{className:"album-meta-v",children:c.createdAt?u(c.createdAt):""}),r.jsx("div",{className:"album-meta-k",children:"公開"}),r.jsx("div",{className:"album-meta-v",children:c.isPublic?"公開":"非公開"}),r.jsx("div",{className:"album-meta-k",children:"お気に入り"}),r.jsx("div",{className:"album-meta-v",children:c.isFavorite?"Yes":"No"}),r.jsx("div",{className:"album-meta-k",children:"長さ"}),r.jsx("div",{className:"album-meta-v",children:c.duration?`${c.duration} sec`:""}),r.jsx("div",{className:"album-meta-k",children:"ムード"}),r.jsx("div",{className:"album-meta-v",children:c.mood}),r.jsx("div",{className:"album-meta-k",children:"ID"}),r.jsx("div",{className:"album-meta-v album-meta-id",children:c.id})]})]}),r.jsx("div",{className:"album-summary-card",children:r.jsx(ls,{variant:"compact",title:c.title||c.mood,mood:c.mood,imageUrl:c.imageDataURL,meta:`作成日: ${new Date(c.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:c.musicData?"再生可能":"音声なし",tone:c.musicData?"success":"default"},...c.isPublic?[{label:"公開中",tone:"info"}]:[],...c.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),r.jsxs("section",{className:"metadata-section","aria-label":"アルバムメモ",children:[r.jsx("h2",{className:"metadata-section-title",children:"メモ（ひとこと）"}),r.jsx("textarea",{className:"album-memo-input",value:d,onChange:E=>h(E.target.value),onBlur:()=>{const E=d.trim();(c.memo||"")!==E&&n(c.id,{memo:E||void 0})},placeholder:"この作品にひとこと。気づき、風景、だれにも見せないメモでも。",rows:3}),r.jsx("div",{className:"album-memo-hint",children:"フォーカスが外れると自動で保存します。"})]}),c.metadata&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"分析結果 (IR)"}),c.metadata.valence!==void 0&&r.jsxs("div",{className:"metadata-item",onMouseEnter:()=>k(0),onMouseLeave:()=>k(-1),children:[r.jsx("span",{className:"metadata-label",children:"Valence"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.valence.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.valence>0?"明るい":"暗い",")"]})]})]}),c.metadata.arousal!==void 0&&r.jsxs("div",{className:"metadata-item",onMouseEnter:()=>k(1),onMouseLeave:()=>k(-1),children:[r.jsx("span",{className:"metadata-label",children:"Arousal"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.arousal.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.arousal>.6?"動的":"静的",")"]})]})]}),c.metadata.focus!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"Focus"}),r.jsxs("span",{className:"metadata-value",children:[c.metadata.focus.toFixed(2),r.jsxs("span",{className:"metadata-hint",children:["(",c.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),c.metadata.confidence!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"信頼度"}),r.jsxs("span",{className:"metadata-value",children:[Math.round(c.metadata.confidence*100),"%"]})]}),c.metadata.motif_tags&&c.metadata.motif_tags.length>0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"モチーフ"}),r.jsx("span",{className:"metadata-value metadata-tags",children:c.metadata.motif_tags.join(", ")})]})]}),r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"生成情報"}),c.metadata.stylePreset&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"スタイル"}),r.jsx("span",{className:"metadata-value",children:c.metadata.stylePreset})]}),c.metadata.seed!==void 0&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"シード"}),r.jsx("span",{className:"metadata-value metadata-id",children:c.metadata.seed})]}),c.metadata.provider&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"生成方法"}),r.jsx("span",{className:"metadata-value",children:c.metadata.provider==="replicate"?"Replicate (SDXL)":c.metadata.provider==="local"?"ローカル生成":c.metadata.provider})]})]}),(c.metadata.prompt||c.metadata.negativePrompt)&&r.jsxs("details",{className:"metadata-section album-details-toggle",children:[r.jsx("summary",{className:"metadata-section-title",children:"プロンプト"}),c.metadata.prompt?r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Prompt"}),r.jsx("pre",{className:"album-text-pre",children:c.metadata.prompt})]}):null,c.metadata.negativePrompt?r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Negative"}),r.jsx("pre",{className:"album-text-pre",children:c.metadata.negativePrompt})]}):null]}),c.musicMetadata&&r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"調"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.key})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"テンポ"}),r.jsxs("span",{className:"metadata-value",children:[c.musicMetadata.tempo," BPM"]})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"拍子"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.timeSignature})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"形式"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.form})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"性格"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.character})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"生成方法"}),r.jsx("span",{className:"metadata-value",children:c.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":c.musicMetadata.provider==="rule-based"?"ルールベース":c.musicMetadata.provider})]}),c.musicData&&r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"フォーマット"}),r.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(c.musicData.length/1024)," KB)"]})]})]}),c.metadata.provider==="replicate"&&r.jsxs("div",{className:"album-actions",children:[r.jsx("button",{className:"regenerate-btn",onClick:U,disabled:p,children:p?"再生成中...":"再生成 (新しいシード)"}),w&&r.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),v&&r.jsx("div",{className:"regenerate-error",children:v})]})]}),c.sessionData?r.jsxs("details",{className:"metadata-section album-details-toggle",children:[r.jsx("summary",{className:"metadata-section-title",children:"セッションデータ（概要）"}),r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Keys"}),r.jsx("div",{className:"album-text-inline",children:typeof c.sessionData=="object"&&c.sessionData!==null?Object.keys(c.sessionData).slice(0,24).join(", "):typeof c.sessionData})]}),r.jsxs("div",{className:"album-text-block",children:[r.jsx("div",{className:"album-text-label",children:"Preview"}),r.jsx("pre",{className:"album-text-pre",children:f(c.sessionData)})]})]}):null,c.causalLogId||m?r.jsxs("div",{className:"metadata-section",children:[r.jsx("h3",{className:"metadata-section-title",children:"因果ログ"}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"Log ID"}),r.jsx("span",{className:"metadata-value metadata-id",children:c.causalLogId||""})]}),m?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"成功"}),r.jsx("span",{className:"metadata-value",children:m.success?"Yes":"No"})]}),r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"総所要時間"}),r.jsxs("span",{className:"metadata-value",children:[Math.round((m.totalDuration||0)*10)/10," sec"]})]}),m.errors&&m.errors.length>0?r.jsxs("div",{className:"metadata-item",children:[r.jsx("span",{className:"metadata-label",children:"エラー"}),r.jsxs("span",{className:"metadata-value",children:[m.errors.length," 件"]})]}):null]}):null]}):null]}),r.jsx(lu,{log:m})]})]}):r.jsxs("div",{className:"room-content album-room",children:[r.jsx("h1",{className:"room-title",children:"ALBUM"}),r.jsx("p",{className:"room-subtitle",children:"アルバム詳細"}),r.jsxs("div",{className:"album-empty",children:[r.jsx("p",{children:"アルバムが選択されていません"}),r.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})]})},pu=()=>{const{albums:s,getSelectedAlbum:e,selectAlbum:t}=Lt(),n=e(),{navigateToRoom:i}=Ut(),{requestPlayAlbum:a}=ts(),[o,l]=R.useState("now"),c=s.filter(h=>h.musicData),u=n&&n.musicData?r.jsxs("div",{className:"music-panel",children:[r.jsx(ls,{title:n.title||n.mood,mood:n.mood,imageUrl:n.imageDataURL,meta:`作成日: ${new Date(n.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...n.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...n.isPublic?[{label:"公開",tone:"info"}]:[]]}),n.musicMetadata&&r.jsxs("div",{className:"music-meta-grid room-card",children:[r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"調"}),r.jsx("span",{children:n.musicMetadata.key})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"テンポ"}),r.jsxs("span",{children:[n.musicMetadata.tempo," BPM"]})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"拍子"}),r.jsx("span",{children:n.musicMetadata.timeSignature})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"形式"}),r.jsx("span",{children:n.musicMetadata.form})]}),r.jsxs("div",{className:"music-meta-row",children:[r.jsx("span",{className:"music-meta-label",children:"性格"}),r.jsx("span",{children:n.musicMetadata.character})]})]}),r.jsxs("div",{className:"music-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:()=>a(n,c),children:"再生"}),r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})]})]}):r.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),d=r.jsxs("div",{className:"music-panel",children:[r.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",c.length,"件"]}),c.length>0?r.jsx("div",{className:"music-library-grid",children:c.map(h=>r.jsx("button",{className:"album-card-button",onClick:()=>{t(h.id),a(h,c)},children:r.jsx(ls,{title:h.title||h.mood,mood:h.mood,imageUrl:h.imageDataURL,meta:h.musicMetadata?`${h.musicMetadata.key} | ${h.musicMetadata.tempo} BPM | ${h.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...h.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...h.isPublic?[{label:"公開",tone:"info"}]:[]]})},h.id))}):r.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return r.jsxs("div",{className:"room-content music-room",children:[r.jsxs("div",{className:"room-header music-header",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"room-title",children:"MUSIC"}),r.jsx("p",{className:"room-subtitle",children:"選択したアルバムを再生する"})]}),r.jsx("div",{className:"room-header-actions",children:r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})})]}),r.jsx(no,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:d}],value:o,onChange:l,ariaLabel:"音楽タブ"})]})},fs="https://airia-beyond.onrender.com";async function fu(s=50,e="all"){const t=await yt(`${fs}/api/social/posts?limit=${encodeURIComponent(String(s))}&mode=${encodeURIComponent(String(e))}`);if(!t.ok)throw new Error(`Failed to load posts: ${t.status}`);return t.json()}async function gu(s){const e=await yt(`${fs}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function vu(s){const e=await yt(`${fs}/api/social/posts/${encodeURIComponent(s)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function yu(s,e){const t=await yt(`${fs}/api/social/posts/${encodeURIComponent(s)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json().catch(()=>null);if(!t.ok)throw new Error(n?.message||`Failed to comment: ${t.status}`);return n}async function bu(s){const e=await yt(`${fs}/api/social/users/${encodeURIComponent(s)}/follow`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to follow: ${e.status}`);return t}async function xu(s,e){const t=await yt(`${fs}/api/social/posts/${encodeURIComponent(s)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({visibility:e})}),n=await t.json().catch(()=>null);if(!t.ok)throw new Error(n?.message||`Failed to update post: ${t.status}`);return n}async function _u(s){const e=await yt(`${fs}/api/social/posts/${encodeURIComponent(s)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to delete post: ${e.status}`);return t}const wu={comment:r.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:r.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:r.jsxs(r.Fragment,{children:[r.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),r.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:r.jsx("path",{d:"M6 9l6 6 6-6"}),more:r.jsxs(r.Fragment,{children:[r.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),r.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),r.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},jn=({name:s,size:e=16,className:t})=>r.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:wu[s]}),Nu=()=>{const{albums:s,getSelectedAlbum:e,updateAlbum:t}=Lt(),n=e(),{navigateToRoom:i}=Ut(),[a,o]=R.useState([]),[l,c]=R.useState(!1),[u,d]=R.useState(null),{user:h,logout:m,updateFollowingIds:f}=nr(),[p,g]=R.useState(""),[v,b]=R.useState(n?.id||(s[0]?.id??"")),[w,S]=R.useState(!1),[A,x]=R.useState({}),[T,k]=R.useState(null),[y,j]=R.useState("all"),[C,O]=R.useState({}),[P,U]=R.useState(null),E=R.useCallback(()=>{try{const D=String(window.location.hash||"").match(/^#social\/(.+)$/);if(D&&D[1])return decodeURIComponent(D[1])}catch{}try{const M="airia_social_focus_post_v1",D=localStorage.getItem(M);if(D)return localStorage.removeItem(M),String(D)}catch{}return null},[]),I=async M=>{const D=`${window.location.origin}/#social/${M}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(D);else{const N=document.createElement("input");N.value=D,document.body.appendChild(N),N.select(),document.execCommand("copy"),document.body.removeChild(N)}d("リンクをコピーしました"),setTimeout(()=>d(null),1500)}catch(N){d(N instanceof Error?N.message:String(N))}},V=R.useCallback(async()=>{c(!0),d(null);try{const M=await fu(50,y);o(M.posts||[]);const D=P||E();D&&(U(D),O(N=>({...N,[D]:!0})),window.setTimeout(()=>{const N=document.querySelector(`[data-post-id="${CSS.escape(D)}"]`);N&&"scrollIntoView"in N&&N.scrollIntoView({block:"start",behavior:"smooth"})},60))}catch(M){d(M instanceof Error?M.message:String(M))}finally{c(!1)}},[E,y,P]);R.useEffect(()=>{V()},[V]),R.useEffect(()=>{n?.id&&b(n.id)},[n?.id]);const F=R.useMemo(()=>s.find(M=>M.id===v)||null,[s,v]),X=!!h&&!!F?.imageDataURL&&!w,z=async()=>{if(!h){d("投稿にはログインが必要です");return}if(F){S(!0),d(null);try{const M=await gu({caption:p,album:{title:F.title||F.mood,mood:F.mood,imageUrl:F.thumbnailUrl||F.imageDataURL,createdAt:F.createdAt}});o(D=>[M,...D]),F.isPublic||t(F.id,{isPublic:!0}),g("")}catch(M){d(M instanceof Error?M.message:String(M))}finally{S(!1)}}},L=async M=>{if(!h){d("いいねにはログインが必要です");return}try{const D=await vu(M);o(N=>N.map(G=>G.id===M?D:G))}catch(D){d(D instanceof Error?D.message:String(D))}},H=async M=>{if(!h){d("コメントにはログインが必要です");return}const D=(A[M]||"").trim();if(D){k(M),d(null);try{const N=await yu(M,{text:D});o(G=>G.map(ce=>ce.id===M?{...ce,comments:Array.isArray(ce.comments)?[...ce.comments,N]:[N]}:ce)),x(G=>({...G,[M]:""}))}catch(N){d(N instanceof Error?N.message:String(N))}finally{k(null)}}},Y=async M=>{if(!h){d("フォローにはログインが必要です");return}try{const D=await bu(M);f(D.followingIds)}catch(D){d(D instanceof Error?D.message:String(D))}},ee=M=>{O(D=>({...D,[M]:!D[M]}))},se=async M=>{if(!h){d("操作にはログインが必要です");return}const N=(String(M.visibility||"public").toLowerCase()==="private"?"private":"public")==="private"?"public":"private";d(null);try{const G=await xu(M.id,N);o(ce=>ce.map(le=>le.id===M.id?G:le))}catch(G){d(G instanceof Error?G.message:String(G))}},B=async M=>{if(!h){d("操作にはログインが必要です");return}const D=M.album?.title||M.album?.mood||"投稿";if(window.confirm(`削除しますか？

${D}
この操作は取り消せません。`)){d(null);try{await _u(M.id),o(N=>N.filter(G=>G.id!==M.id))}catch(N){d(N instanceof Error?N.message:String(N))}}};return r.jsxs("div",{className:"room-content social-room",children:[r.jsxs("div",{className:"social-header",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"room-title",children:"SOCIAL"}),r.jsx("p",{className:"room-subtitle",children:"作品を公開して、反応を集める"})]}),r.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[r.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"}),r.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"更新"})]})]}),r.jsx("div",{className:"social-filter","data-no-swipe":"true",children:r.jsx(zr,{value:y,onChange:M=>j(M),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),r.jsx("div",{className:"social-auth","data-no-swipe":"true","aria-label":"ログイン",children:r.jsxs("div",{className:"social-auth-row",children:[r.jsxs("div",{className:"social-auth-me",children:[r.jsx("div",{className:"social-auth-title",children:"ログイン中"}),r.jsxs("div",{className:"social-auth-handle",children:["@",h?.handle||"..."]}),r.jsx("div",{className:"social-auth-sub",children:h?.displayName||""})]}),r.jsxs("div",{className:"social-auth-actions",children:[r.jsx("button",{className:"btn",onClick:()=>void V(),disabled:l,children:"再読み込み"}),r.jsx("button",{className:"btn",onClick:()=>void m(),disabled:!h,children:"ログアウト"})]})]})}),r.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[r.jsxs("div",{className:"social-compose-grid",children:[r.jsxs("label",{className:"social-field",children:[r.jsx("span",{className:"social-label",children:"公開するアルバム"}),r.jsxs("select",{className:"social-select",value:v,onChange:M=>b(M.target.value),children:[s.length===0&&r.jsx("option",{value:"",children:"（アルバムがありません）"}),s.map(M=>r.jsx("option",{value:M.id,children:M.title||M.mood},M.id))]})]}),r.jsxs("label",{className:"social-field social-field-wide",children:[r.jsx("span",{className:"social-label",children:"キャプション"}),r.jsx("textarea",{className:"social-textarea",value:p,onChange:M=>g(M.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),r.jsxs("div",{className:"social-compose-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!X,onClick:z,children:w?"公開中…":"公開する"}),F&&r.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:r.jsx(ls,{variant:"compact",title:F.title||F.mood,mood:F.mood,imageUrl:F.thumbnailUrl||F.imageDataURL,badges:[{label:F.musicData?"再生可能":"音声なし",tone:F.musicData?"success":"default"}]})})]}),u&&r.jsx("div",{className:"social-error",children:u})]}),r.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[l&&a.length===0&&r.jsx("div",{className:"social-muted",children:"読み込み中…"}),!l&&a.length===0&&r.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),a.map(M=>r.jsxs("article",{className:"social-post","data-no-swipe":"true","data-post-id":M.id,children:[r.jsxs("header",{className:"social-post-header",children:[r.jsxs("div",{className:"social-post-author",children:[M.author?.handle?`@${M.author.handle}`:M.authorName||"anonymous",M.author?.displayName&&r.jsx("span",{className:"social-post-author-sub",children:M.author.displayName})]}),r.jsx("div",{className:"social-post-date",children:new Date(M.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),M.author?.id&&h?.id!==M.author.id&&r.jsx("div",{className:"social-post-follow","data-no-swipe":"true",children:r.jsx("button",{className:`btn ${h?.followingIds?.includes(M.author.id)?"btn-primary":""}`,onClick:()=>void Y(M.author.id),disabled:!h,children:h?.followingIds?.includes(M.author.id)?"フォロー中":"フォロー"})}),r.jsx("div",{className:"social-post-album",children:r.jsx(ls,{title:M.album?.title||"album",mood:M.album?.mood,imageUrl:M.album?.imageUrl,meta:M.album?.createdAt?`作成日: ${new Date(M.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:String(M.visibility||"public").toLowerCase()==="private"?"非公開":"公開作品",tone:String(M.visibility||"public").toLowerCase()==="private"?"default":"info"}]})}),M.caption&&r.jsx("div",{className:"social-post-caption",children:M.caption}),r.jsxs("div",{className:"social-post-actions",children:[r.jsxs("button",{className:`btn social-action ${C[M.id]?"is-active":""}`,onClick:()=>ee(M.id),"aria-expanded":!!C[M.id],"aria-controls":`post-comments-${M.id}`,"aria-label":C[M.id]?"コメントを閉じる":"コメントを開く",children:[r.jsxs("span",{className:"social-action-main",children:[r.jsx(jn,{name:C[M.id]?"chevronDown":"comment",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:C[M.id]?"閉じる":"コメント"})]}),r.jsx("span",{className:"social-count-chip",children:Array.isArray(M.comments)?M.comments.length:0})]}),r.jsxs("button",{className:`btn social-action ${M.viewerHasLiked?"is-active":""}`,onClick:()=>void L(M.id),disabled:!h,children:[r.jsxs("span",{className:"social-action-main",children:[r.jsx(jn,{name:"heart",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:"いいね"})]}),r.jsx("span",{className:"social-count-chip",children:M.likes||0})]}),r.jsx("button",{className:"btn social-action",onClick:()=>void I(M.id),children:r.jsxs("span",{className:"social-action-main",children:[r.jsx(jn,{name:"link",className:"social-action-icon"}),r.jsx("span",{className:"social-action-label",children:"共有"})]})}),r.jsx(Bn,{triggerClassName:"btn social-action social-action-iconOnly",trigger:r.jsx(jn,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:D})=>r.jsx(qn,{items:(()=>{const N=!!h?.id&&!!M.author?.id&&h.id===M.author.id,G=[{id:"copy",label:"リンクをコピー",onSelect:()=>{I(M.id),D()}}];if(N){const ce=String(M.visibility||"public").toLowerCase()==="private";G.push({id:"vis",label:ce?"公開にする":"非公開にする",onSelect:()=>{se(M),D()}}),G.push({id:"delete",label:"削除",onSelect:()=>{B(M),D()}})}else G.push({id:"report",label:"通報する",onSelect:()=>{d("通報を受け付けました"),D()}});return G})()})})]}),C[M.id]&&r.jsxs("div",{className:"social-post-comments",id:`post-comments-${M.id}`,children:[(M.comments||[]).slice(-6).map(D=>r.jsxs("div",{className:"social-comment",children:[r.jsx("span",{className:"social-comment-author",children:D.authorName||"anonymous"}),r.jsx("span",{className:"social-comment-text",children:D.text})]},D.id)),r.jsxs("div",{className:"social-comment-compose",children:[r.jsx("input",{className:"social-input",value:A[M.id]||"",onChange:D=>x(N=>({...N,[M.id]:D.target.value})),placeholder:h?"コメントを書く":"ログインしてコメント",maxLength:240,disabled:!h}),r.jsx("button",{className:"btn btn-primary",disabled:!h||T===M.id,onClick:()=>void H(M.id),children:T===M.id?"送信中…":"送信"})]})]})]},M.id))]})]})},li="https://airia-beyond.onrender.com",Yr="airia_admin_token_v1";function tn(){try{return String(localStorage.getItem(Yr)||"")}catch{return""}}function ro(s){try{s?localStorage.setItem(Yr,s):localStorage.removeItem(Yr)}catch{}}async function io(s){return s.json().catch(()=>null)}async function Su(s,e){const t=new URL(`${li}/api/admin/audit`);t.searchParams.set("limit",String(s.limit)),s.sinceId!==void 0&&t.searchParams.set("sinceId",String(s.sinceId)),s.type&&t.searchParams.set("type",String(s.type)),s.actorId&&t.searchParams.set("actorId",String(s.actorId));const n=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),i=await io(n);if(!n.ok)throw new Error(i?.message||i?.error||`Failed to load audit: ${n.status}`);return i}function ku(s){const e=new URL(`${li}/api/admin/audit/stream`);return e.searchParams.set("token",s),e.toString()}async function da(s,e){const t=new URL(`${li}/api/admin/metrics`);t.searchParams.set("days",String(s||30));const n=await fetch(t.toString(),{headers:{Authorization:`Bearer ${e}`}}),i=await io(n);if(!n.ok)throw new Error(i?.message||i?.error||`Failed to load metrics: ${n.status}`);return i}function ju(s){const e=new Date(s);return Number.isNaN(e.getTime())?"":e.toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"})}const Tu=()=>{const{user:s,logout:e,updateProfile:t,busy:n}=nr(),{navigateToRoom:i}=Ut(),{addToast:a}=Gs(),[o,l]=R.useState(s?.displayName||""),[c,u]=R.useState(s?.bio||""),[d,h]=R.useState(!1),[m,f]=R.useState(tn());R.useEffect(()=>{l(s?.displayName||""),u(s?.bio||"")},[s?.displayName,s?.bio]),R.useEffect(()=>{f(tn())},[]);const p=!!s&&!d&&(o.trim()!==(s?.displayName||"")||c.trim()!==(s?.bio||"")),g=async()=>{if(s){h(!0);try{await t({displayName:o.trim()||void 0,bio:c.trim()||""}),a("success","プロフィールを保存しました")}catch(w){a("error",w instanceof Error?w.message:"保存に失敗しました")}finally{h(!1)}}},v=async()=>{try{await e()}catch{}},b=()=>{const w=m.trim();ro(w||null),a("success",w?"Admin token を保存しました":"Admin token をクリアしました")};return r.jsxs("div",{className:"room-content settings-room",children:[r.jsxs("div",{className:"settings-header","data-no-swipe":"true",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"room-title",children:"MY"}),r.jsx("p",{className:"room-subtitle",children:"プロフィールと設定"})]}),r.jsx("div",{className:"settings-header-actions",children:r.jsx("button",{className:"btn",onClick:()=>void v(),disabled:!s||n,children:"ログアウト"})})]}),r.jsxs("div",{className:"settings-card",children:[r.jsxs("section",{className:"settings-section",children:[r.jsx("h2",{className:"settings-title",children:"アカウント"}),r.jsxs("div",{className:"settings-kv",children:[r.jsxs("div",{className:"settings-kv-row",children:[r.jsx("div",{className:"settings-k",children:"ハンドル"}),r.jsxs("div",{className:"settings-v",children:["@",s?.handle||"..."]})]}),r.jsxs("div",{className:"settings-kv-row",children:[r.jsx("div",{className:"settings-k",children:"作成日"}),r.jsx("div",{className:"settings-v",children:s?.createdAt?ju(s.createdAt):""})]})]})]}),r.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"settings-title",children:"プロフィール"}),r.jsxs("div",{className:"settings-grid",children:[r.jsxs("label",{className:"settings-field",children:[r.jsx("span",{className:"settings-label",children:"表示名"}),r.jsx("input",{className:"settings-input",value:o,onChange:w=>l(w.target.value),maxLength:32,placeholder:"あなたの名前"})]}),r.jsxs("label",{className:"settings-field settings-field-wide",children:[r.jsx("span",{className:"settings-label",children:"自己紹介"}),r.jsx("textarea",{className:"settings-textarea",value:c,onChange:w=>u(w.target.value),maxLength:160,rows:4,placeholder:"一言（任意）"})]})]}),r.jsxs("div",{className:"settings-actions",children:[r.jsx("button",{className:"btn btn-primary",disabled:!p,onClick:()=>void g(),children:d?"保存中…":"保存する"}),r.jsx("div",{className:"settings-muted",children:"プレリリースでは基本項目のみ編集できます。"})]})]}),r.jsxs("section",{className:"settings-section",children:[r.jsx("h2",{className:"settings-title",children:"通知"}),r.jsx("p",{className:"settings-muted",children:"メール通知は次フェーズで追加予定です。"})]}),r.jsxs("section",{className:"settings-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"settings-title",children:"Admin"}),r.jsx("div",{className:"settings-grid",children:r.jsxs("label",{className:"settings-field settings-field-wide",children:[r.jsx("span",{className:"settings-label",children:"ADMIN_TOKEN"}),r.jsx("input",{className:"settings-input",value:m,onChange:w=>f(w.target.value),placeholder:"サーバの ADMIN_TOKEN",type:"password",autoComplete:"off"})]})}),r.jsxs("div",{className:"settings-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:b,children:"保存"}),r.jsx("button",{className:"btn",onClick:()=>{b(),m.trim()&&i("admin")},disabled:!m.trim(),children:"Adminログへ"}),r.jsx("div",{className:"settings-muted",children:"Adminログは ADMIN_TOKEN を知っている人のみ利用できます。"})]})]})]})]})};function Cu(s){const e=new Date(s);return Number.isNaN(e.getTime())?s:e.toLocaleString("ja-JP",{hour12:!1})}function Iu(s){const e=s.actor;if(!e)return"anonymous";const t=e.handle?`@${e.handle}`:e.id,n=e.displayName?String(e.displayName):"";return n?`${n} (${t})`:t}const Au=()=>{const{addToast:s}=Gs(),[e,t]=R.useState(tn()),[n,i]=R.useState(tn()),[a,o]=R.useState([]),[l,c]=R.useState(!1),[u,d]=R.useState(null),[h,m]=R.useState(null),[f,p]=R.useState(30),[g,v]=R.useState(""),[b,w]=R.useState(""),[S,A]=R.useState(!1),[x,T]=R.useState(!0),k=R.useRef(null),y=R.useCallback(()=>{if(k.current)try{k.current.close()}catch{}k.current=null,A(!1)},[]),j=R.useCallback(E=>{if(y(),!!E)try{const I=new EventSource(ku(E));k.current=I,I.addEventListener("hello",()=>{A(!0),d(null)}),I.addEventListener("audit",V=>{try{const F=JSON.parse(String(V.data||"null"));if(!F||typeof F!="object")return;o(X=>[F,...X].slice(0,2e3))}catch{}}),I.onerror=()=>{A(!1)}}catch(I){d(I instanceof Error?I.message:String(I)),A(!1)}},[y]),C=R.useCallback(async()=>{const E=(n||"").trim();if(!E){d("ADMIN_TOKEN を入力してください");return}c(!0),d(null);try{const I=await Su({limit:200,type:g.trim(),actorId:b.trim()},E);o(I.events||[]);const V=await da(f,E);m(V)}catch(I){d(I instanceof Error?I.message:String(I))}finally{c(!1)}},[n,g,b,f]);R.useEffect(()=>{const E=(n||"").trim();if(!E)return;let I=!1;const V=async()=>{try{const X=await da(f,E);I||m(X)}catch{}};V();const F=window.setInterval(V,6e4);return()=>{I=!0,window.clearInterval(F)}},[n,f]),R.useEffect(()=>{if(x&&n)return j(n),()=>y()},[x,n,j,y]);const O=()=>{const E=e.trim();ro(E||null),i(E),s("success",E?"Admin token を保存しました":"Admin token をクリアしました"),E&&x&&j(E),E||y()},P=()=>o([]),U=R.useMemo(()=>{const E=g.trim().toLowerCase(),I=b.trim();return a.filter(V=>{if(E&&!String(V.type||"").toLowerCase().includes(E))return!1;if(I){const F=String(V.actor?.id||""),X=String(V.actor?.handle||"");if(I!==F&&I!==X)return!1}return!0})},[a,g,b]);return r.jsxs("div",{className:"room-content admin-room",children:[r.jsxs("div",{className:"admin-header","data-no-swipe":"true",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"room-title",children:"ADMIN"}),r.jsx("p",{className:"room-subtitle",children:"ユーザーアクション監視ログ（リアルタイム）"})]}),r.jsxs("div",{className:"admin-header-actions",children:[r.jsx("span",{className:`admin-pill ${S?"ok":"ng"}`,children:S?"LIVE":"OFFLINE"}),r.jsx("button",{className:"btn",onClick:()=>void C(),disabled:l||!n,children:l?"読込中…":"最新を取得"}),r.jsx("button",{className:"btn btn-secondary",onClick:P,disabled:a.length===0,children:"表示クリア"})]})]}),r.jsxs("div",{className:"admin-metrics","data-no-swipe":"true",children:[r.jsxs("div",{className:"admin-metrics-top",children:[r.jsxs("div",{className:"admin-metrics-cards",children:[r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"総ユーザー数"}),r.jsx("div",{className:"admin-metric-v",children:h?.totals?.users??"—"})]}),r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"総アクション数"}),r.jsx("div",{className:"admin-metric-v",children:h?.totals?.actions??"—"})]}),r.jsxs("div",{className:"admin-metric",children:[r.jsx("div",{className:"admin-metric-k",children:"期間"}),r.jsxs("div",{className:"admin-metric-v",children:["直近 ",f," 日"]})]})]}),r.jsxs("div",{className:"admin-metrics-days",children:[r.jsx("button",{className:`btn ${f===7?"btn-primary":""}`,onClick:()=>p(7),children:"7日"}),r.jsx("button",{className:`btn ${f===14?"btn-primary":""}`,onClick:()=>p(14),children:"14日"}),r.jsx("button",{className:`btn ${f===30?"btn-primary":""}`,onClick:()=>p(30),children:"30日"})]})]}),r.jsxs("div",{className:"admin-charts",children:[r.jsx(ha,{title:"ユーザー増加（新規/日）",points:h?.series?.newUsersPerDay||[]}),r.jsx(ha,{title:"アクション数（/日）",points:h?.series?.actionsPerDay||[]})]})]}),r.jsxs("div",{className:"admin-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"admin-grid",children:[r.jsxs("label",{className:"admin-field admin-field-wide",children:[r.jsx("span",{className:"admin-label",children:"ADMIN_TOKEN"}),r.jsx("input",{className:"admin-input",value:e,onChange:E=>t(E.target.value),placeholder:"Bearer token（サーバの ADMIN_TOKEN）",type:"password",autoComplete:"off"})]}),r.jsxs("div",{className:"admin-actions",children:[r.jsx("button",{className:"btn btn-primary",onClick:O,children:"保存"}),r.jsx("button",{className:"btn",onClick:()=>S?y():j(n),disabled:!n,children:S?"切断":"接続"}),r.jsxs("label",{className:"admin-toggle",children:[r.jsx("input",{type:"checkbox",checked:x,onChange:E=>T(E.target.checked)}),"自動接続"]})]}),r.jsxs("label",{className:"admin-field",children:[r.jsx("span",{className:"admin-label",children:"type filter"}),r.jsx("input",{className:"admin-input",value:g,onChange:E=>v(E.target.value),placeholder:"social.post"})]}),r.jsxs("label",{className:"admin-field",children:[r.jsx("span",{className:"admin-label",children:"actor filter"}),r.jsx("input",{className:"admin-input",value:b,onChange:E=>w(E.target.value),placeholder:"user id or handle"})]})]}),u&&r.jsx("div",{className:"admin-error",children:u}),!n&&r.jsx("div",{className:"admin-hint",children:"まず ADMIN_TOKEN を入力して「保存」してください。"})]}),r.jsx("div",{className:"admin-list","data-no-swipe":"true",children:U.length===0?r.jsx("div",{className:"admin-empty",children:"ログがありません。操作してイベントを発生させてください。"}):U.map(E=>r.jsx(Mu,{evt:E,onCopy:()=>{const I=JSON.stringify(E,null,2);navigator.clipboard.writeText(I).then(()=>s("success","コピーしました")).catch(()=>s("error","コピーできませんでした"))}},E.id))})]})},ha=({title:s,points:e})=>{const t=Math.max(1,...e.map(a=>Number(a.value||0))),n=e[e.length-1],i=e.reduce((a,o)=>a+(Number(o.value)||0),0);return r.jsxs("div",{className:"admin-chart",children:[r.jsxs("div",{className:"admin-chart-top",children:[r.jsx("div",{className:"admin-chart-title",children:s}),r.jsxs("div",{className:"admin-chart-meta",children:["合計 ",i," / 最新 ",n?.value??0]})]}),r.jsx("div",{className:"admin-chart-bars","aria-label":s,children:e.map(a=>r.jsx("div",{className:"admin-chart-bar",title:`${a.day}: ${a.value}`,children:r.jsx("div",{className:"admin-chart-barFill",style:{height:`${Math.round(Number(a.value||0)/t*100)}%`}})},a.day))}),r.jsxs("div",{className:"admin-chart-axis",children:[r.jsx("span",{children:e[0]?.day||""}),r.jsx("span",{children:e[e.length-1]?.day||""})]})]})},Mu=({evt:s,onCopy:e})=>{const[t,n]=R.useState(!1);return r.jsxs("div",{className:"admin-row",children:[r.jsxs("button",{className:"admin-row-main",onClick:()=>n(i=>!i),"aria-expanded":t,children:[r.jsxs("div",{className:"admin-row-top",children:[r.jsx("div",{className:"admin-row-type",children:s.type}),r.jsx("div",{className:"admin-row-ts",children:Cu(s.ts)})]}),r.jsxs("div",{className:"admin-row-mid",children:[r.jsx("div",{className:"admin-row-actor",children:Iu(s)}),r.jsx("div",{className:"admin-row-summary",children:s.summary||""})]}),s.request?.path?r.jsxs("div",{className:"admin-row-path",children:[s.request.method," ",s.request.path]}):null]}),r.jsx("div",{className:"admin-row-actions","data-no-swipe":"true",children:r.jsx("button",{className:"btn btn-secondary",onClick:e,children:"JSONコピー"})}),t?r.jsx("pre",{className:"admin-row-json",children:JSON.stringify(s,null,2)}):null]})},Eu=({label:s,children:e,placement:t="top"})=>{const n=_.useId(),[i,a]=_.useState(!1),o=[e.props["aria-describedby"],n].filter(Boolean).join(" ");return r.jsxs("span",{className:`tooltip-wrapper tooltip-${t}`,onMouseEnter:()=>a(!0),onMouseLeave:()=>a(!1),onFocusCapture:()=>a(!0),onBlurCapture:()=>a(!1),"data-no-swipe":"true",children:[R.cloneElement(e,{"aria-describedby":o}),r.jsx("span",{id:n,role:"tooltip",className:`tooltip-bubble ${i?"is-open":""}`,children:s})]})},ma="airia_theme";function Ou(s){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=s==="system"?e?"dark":"light":s;document.documentElement.setAttribute("data-theme",t)}const Pu=()=>{const{addToast:s}=Gs(),{navigateToRoom:e}=Ut(),[t,n]=R.useState(()=>{try{return localStorage.getItem(ma)||"system"}catch{return"system"}}),i=l=>{n(l);try{localStorage.setItem(ma,l)}catch{}Ou(l)},[a,o]=R.useState(!1);return r.jsxs("div",{className:"room-content info-room",children:[r.jsx("h1",{className:"room-title",children:"INFO"}),r.jsx("p",{className:"room-subtitle",children:"このアプリについて"}),r.jsxs("div",{className:"info-card",children:[r.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[r.jsx("h2",{className:"info-title",children:"フィードバック"}),r.jsx("p",{className:"info-text",children:"不便・バグ・改善案はもちろん、良かった点も歓迎です。短くても大丈夫。"}),r.jsx("div",{className:"info-actions",children:r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>e("feedback"),children:"フィードバックを書く"})})]}),r.jsxs("section",{className:"info-section",children:[r.jsx("h2",{className:"info-title",children:"目的"}),r.jsx("p",{className:"info-text",children:"この体験の目的は、「より貴方らしい芸術」を日常の中で生み出せること。"}),r.jsx("p",{className:"info-text",children:"そして、気持ちの変化に合わせて「ずっと寄り添える」相棒になることです。"})]}),r.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[r.jsxs("div",{className:"info-actions",children:[r.jsx("h2",{className:"info-title",children:"テーマ"}),r.jsx(Eu,{label:"見やすさに合わせて切り替えできます",children:r.jsx("span",{className:"info-badge","aria-hidden":"true",children:"?"})})]}),r.jsx("div",{className:"info-actions",children:r.jsx("div",{className:"theme-toggle",role:"group","aria-label":"テーマ切り替え",children:[{id:"system",label:"システム"},{id:"light",label:"ライト"},{id:"dark",label:"ダーク"},{id:"high-contrast",label:"高コントラスト"}].map(l=>r.jsx("button",{type:"button",className:"theme-button","aria-pressed":t===l.id,onClick:()=>i(l.id),children:l.label},l.id))})}),r.jsx("p",{className:"info-text",children:"見やすさに合わせて切り替えられます。"})]}),r.jsxs("section",{className:"info-section",children:[r.jsxs("div",{className:"info-actions",children:[r.jsx("h2",{className:"info-title",children:"リンク"}),r.jsx("button",{type:"button",className:"info-reset",onClick:()=>o(!0),children:"アプリ情報"})]}),r.jsx("ul",{className:"info-list",children:r.jsx("li",{children:r.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})})})]}),null]}),r.jsxs(Ha,{open:a,onOpenChange:o,title:"AIRIA BEYOND",description:"あなたの一日を、作品へ。",footer:r.jsx("button",{className:"btn btn-primary",onClick:()=>o(!1),children:"閉じる"}),children:[r.jsx("p",{className:"info-text",children:"会話と気分の手がかりから、あなたに合うレコメンドや創作を少しずつ育てていきます。"}),r.jsx("p",{className:"info-text",children:"まだプレリリース段階です。気づいたことがあれば、ぜひフィードバックを送ってください。"})]})]})},Du=()=>{const{navigateToRoom:s}=Ut(),{addToast:e}=Gs(),[t,n]=R.useState(!1),[i,a]=R.useState(null),[o,l]=R.useState(!1),[c,u]=R.useState(""),[d,h]=R.useState(""),[m,f]=R.useState(""),[p,g]=R.useState(""),[v,b]=R.useState(""),[w,S]=R.useState(""),[A,x]=R.useState(""),[T,k]=R.useState(""),[y,j]=R.useState(""),[C,O]=R.useState(""),[P,U]=R.useState(""),[E,I]=R.useState(!0),[V,F]=R.useState(!1),[X,z]=R.useState(null),[L,H]=R.useState(""),[Y,ee]=R.useState(!1),se=R.useMemo(()=>(m.trim().length>0||p.trim().length>0||v.trim().length>0||w.trim().length>0||A.trim().length>0)&&!t,[A,w,t,p,v,m]),B=async()=>{z(null),F(!0);try{const N=await fetch("/api/diagnostics/image",{method:"GET"}),G=await N.json().catch(()=>({}));if(!N.ok)throw new Error(G?.message||"診断情報の取得に失敗しました");const ce=JSON.stringify(G,null,2);H(ce),e("success","診断情報を取得しました。必要ならコピーして送れます。")}catch(N){const G=N instanceof Error?N.message:"診断情報の取得に失敗しました";z(G),e("error",G)}finally{F(!1)}},M=async()=>{const N=L.trim();if(!N){e("info","先に「診断情報を取得」を押してください。");return}try{await navigator.clipboard.writeText(N),e("success","診断情報をコピーしました。")}catch{try{const G=document.createElement("textarea");G.value=N,G.style.position="fixed",G.style.left="-9999px",document.body.appendChild(G),G.select(),document.execCommand("copy"),document.body.removeChild(G),e("success","診断情報をコピーしました。")}catch{e("error","コピーに失敗しました。手動で選択してコピーしてください。")}}},D=async()=>{if(se){a(null),l(!1),n(!0);try{const N=await fetch("/api/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:c||void 0,rating:d||void 0,title:m||void 0,message:p||void 0,steps:v||void 0,expected:w||void 0,actual:A||void 0,device:T||void 0,browser:y||void 0,name:C||void 0,contact:P||void 0,allowFollowUp:E,diagnostics:Y&&L.trim().length>0?L:void 0})}),G=await N.json().catch(()=>({}));if(!N.ok)throw new Error(G?.message||"送信に失敗しました");l(!0),e("success","フィードバックを送信しました。ありがとうございます。"),u(""),h(""),f(""),g(""),b(""),S(""),x(""),k(""),j("")}catch(N){const G=N instanceof Error?N.message:"送信に失敗しました";a(G),e("error",G)}finally{n(!1)}}};return r.jsxs("div",{className:"room-content feedback-room",children:[r.jsxs("div",{className:"feedback-header","data-no-swipe":"true",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"room-title",children:"FEEDBACK"}),r.jsx("p",{className:"room-subtitle",children:"改善のために、気づいたことを教えてください"})]}),r.jsx("div",{className:"feedback-header-actions",children:r.jsx("button",{className:"btn btn-secondary",onClick:()=>s("info"),children:"Infoへ"})})]}),r.jsxs("div",{className:"feedback-hero","data-no-swipe":"true",children:[r.jsxs("div",{className:"feedback-hero-top",children:[r.jsx("h2",{className:"feedback-hero-title",children:"フィードバックを送ってください"}),r.jsxs("p",{className:"feedback-hero-sub",children:["不便・バグ・改善案はもちろん、良かった点も歓迎です。",r.jsx("br",{}),"一部だけの回答でも送信できます。"]})]}),r.jsxs("div",{className:"feedback-grid",children:[r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"カテゴリ"}),r.jsxs("select",{className:"feedback-input",value:c,onChange:N=>u(N.target.value),children:[r.jsx("option",{value:"",children:"未選択"}),r.jsx("option",{value:"bug",children:"バグ"}),r.jsx("option",{value:"ux",children:"使いにくい"}),r.jsx("option",{value:"feature",children:"要望"}),r.jsx("option",{value:"praise",children:"良かった"}),r.jsx("option",{value:"other",children:"その他"})]})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"気持ち（任意）"}),r.jsxs("select",{className:"feedback-input",value:d,onChange:N=>h(N.target.value),children:[r.jsx("option",{value:"",children:"未選択"}),r.jsx("option",{value:"great",children:"最高だった"}),r.jsx("option",{value:"good",children:"良かった"}),r.jsx("option",{value:"ok",children:"ふつう"}),r.jsx("option",{value:"frustrating",children:"困った"}),r.jsx("option",{value:"broken",children:"壊れてる"})]})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"タイトル（任意）"}),r.jsx("input",{className:"feedback-input",value:m,onChange:N=>f(N.target.value),placeholder:"例：再開ボタンが効かない / 背景が綺麗で好き"})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"本文（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:p,onChange:N=>g(N.target.value),placeholder:"気づいたことを自由に。短くてもOK。",rows:5})]}),r.jsxs("div",{className:"feedback-field feedback-span-2",children:[r.jsx("label",{className:"feedback-label",children:"再現手順（任意・バグ向け）"}),r.jsx("textarea",{className:"feedback-textarea",value:v,onChange:N=>b(N.target.value),placeholder:`例：
1) Chatで「今すぐ1曲」
2) キャンセル
3) 再開
→ エラー`,rows:4})]}),r.jsxs("div",{className:"feedback-field feedback-span-2 feedback-split",children:[r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"期待したこと（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:w,onChange:N=>S(N.target.value),rows:3})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"実際に起きたこと（任意）"}),r.jsx("textarea",{className:"feedback-textarea",value:A,onChange:N=>x(N.target.value),rows:3})]})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"端末（任意）"}),r.jsx("input",{className:"feedback-input",value:T,onChange:N=>k(N.target.value),placeholder:"例：iPhone / Windows"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"ブラウザ（任意）"}),r.jsx("input",{className:"feedback-input",value:y,onChange:N=>j(N.target.value),placeholder:"例：Safari / Chrome"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"お名前（任意）"}),r.jsx("input",{className:"feedback-input",value:C,onChange:N=>O(N.target.value),placeholder:"匿名でもOK"})]}),r.jsxs("div",{className:"feedback-field",children:[r.jsx("label",{className:"feedback-label",children:"連絡先（任意）"}),r.jsx("input",{className:"feedback-input",value:P,onChange:N=>U(N.target.value),placeholder:"返信が必要な場合だけ"})]}),r.jsxs("label",{className:"feedback-check feedback-span-2",children:[r.jsx("input",{type:"checkbox",checked:E,onChange:N=>I(N.target.checked)}),"必要があれば追加で質問してもよい（任意）"]}),r.jsxs("div",{className:"feedback-actions feedback-span-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary feedback-submit",disabled:!se,onClick:()=>void D(),children:t?"送信中…":"送信する"}),r.jsx("div",{className:"feedback-hint",children:o?"送信完了。ありがとうございます。":"※ タイトル/本文/再現手順など、どれか1つでも書けば送信できます。"}),i?r.jsx("div",{className:"feedback-error",children:i}):null]})]})]}),r.jsxs("div",{className:"diagnostics-card","data-no-swipe":"true",children:[r.jsxs("div",{className:"diagnostics-top",children:[r.jsx("h2",{className:"diagnostics-title",children:"困ったとき（診断情報）"}),r.jsx("p",{className:"diagnostics-sub",children:"画像生成がうまくいかない時は、診断情報をコピーしてフィードバックに貼り付けると原因特定が早くなります。"})]}),r.jsxs("div",{className:"diagnostics-actions",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",disabled:V,onClick:()=>void B(),children:V?"取得中…":"診断情報を取得"}),r.jsx("button",{type:"button",className:"btn btn-secondary",disabled:!L.trim(),onClick:()=>void M(),children:"コピー"}),r.jsxs("label",{className:"diagnostics-attach",children:[r.jsx("input",{type:"checkbox",checked:Y,onChange:N=>ee(N.target.checked)}),"フィードバック送信に添付する（任意）"]})]}),r.jsx("p",{className:"diagnostics-note",children:"※ 個人情報は含めませんが、接続先URL・エラー概要・最近のジョブ情報が含まれることがあります。"}),r.jsx("textarea",{className:"diagnostics-textarea",value:L,onChange:N=>H(N.target.value),placeholder:"ここに診断情報が表示されます（取得ボタンを押してください）",rows:7}),X?r.jsx("div",{className:"diagnostics-error",children:X}):null]})]})},Ru=({onDismiss:s})=>{const[e,t]=_.useState("enter");_.useEffect(()=>{const i=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>s(),2900)];return()=>{i.forEach(a=>clearTimeout(a))}},[s]);const n=()=>{t("exit"),window.setTimeout(s,260)};return r.jsxs("div",{className:`splash-screen splash-${e}`,onClick:n,role:"button",tabIndex:0,onKeyDown:i=>{(i.key==="Enter"||i.key===" ")&&n()},"aria-label":"クリックして開始",children:[r.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[r.jsx("div",{className:"splash-orbit"}),r.jsx("div",{className:"splash-grain"})]}),r.jsxs("div",{className:"splash-content",children:[r.jsx("div",{className:"splash-mark","aria-hidden":"true",children:r.jsx("div",{className:"splash-monogram",children:"A"})}),r.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),r.jsx("div",{className:"splash-rule","aria-hidden":"true"}),r.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),r.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},ao="15.1.22",pa=(s,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:s}),fa=(s,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:s}),Hr=(s,e)=>({startTime:e,type:"setValue",value:s}),oo=(s,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:s}),co=(s,e,{startTime:t,target:n,timeConstant:i})=>n+(e-n)*Math.exp((t-s)/i),Cs=s=>s.type==="exponentialRampToValue",Wn=s=>s.type==="linearRampToValue",Yt=s=>Cs(s)||Wn(s),ui=s=>s.type==="setValue",Rt=s=>s.type==="setValueCurve",Gn=(s,e,t,n)=>{const i=s[e];return i===void 0?n:Yt(i)||ui(i)?i.value:Rt(i)?i.values[i.values.length-1]:co(t,Gn(s,e-1,i.startTime,n),i)},ga=(s,e,t,n,i)=>t===void 0?[n.insertTime,i]:Yt(t)?[t.endTime,t.value]:ui(t)?[t.startTime,t.value]:Rt(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,Gn(s,e-1,t.startTime,i)],Xr=s=>s.type==="cancelAndHold",Jr=s=>s.type==="cancelScheduledValues",Gt=s=>Xr(s)||Jr(s)?s.cancelTime:Cs(s)||Wn(s)?s.endTime:s.startTime,va=(s,e,t,{endTime:n,value:i})=>t===i?i:0<t&&0<i||t<0&&i<0?t*(i/t)**((s-e)/(n-e)):0,ya=(s,e,t,{endTime:n,value:i})=>t+(s-e)/(n-e)*(i-t),Fu=(s,e)=>{const t=Math.floor(e),n=Math.ceil(e);return t===n?s[t]:(1-(e-t))*s[t]+(1-(n-e))*s[n]},Lu=(s,{duration:e,startTime:t,values:n})=>{const i=(s-t)/e*(n.length-1);return Fu(n,i)},Tn=s=>s.type==="setTarget";class Vu{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=Gt(e);if(Xr(e)||Jr(e)){const n=this._automationEvents.findIndex(a=>Jr(e)&&Rt(a)?a.startTime+a.duration>=t:Gt(a)>=t),i=this._automationEvents[n];if(n!==-1&&(this._automationEvents=this._automationEvents.slice(0,n)),Xr(e)){const a=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&Yt(i)){if(a!==void 0&&Tn(a))throw new Error("The internal list is malformed.");const o=a===void 0?i.insertTime:Rt(a)?a.startTime+a.duration:Gt(a),l=a===void 0?this._defaultValue:Rt(a)?a.values[a.values.length-1]:a.value,c=Cs(i)?va(t,o,l,i):ya(t,o,l,i),u=Cs(i)?pa(c,t,this._currenTime):fa(c,t,this._currenTime);this._automationEvents.push(u)}if(a!==void 0&&Tn(a)&&this._automationEvents.push(Hr(this.getValue(t),t)),a!==void 0&&Rt(a)&&a.startTime+a.duration>t){const o=t-a.startTime,l=(a.values.length-1)/a.duration,c=Math.max(2,1+Math.ceil(o*l)),u=o/(c-1)*l,d=a.values.slice(0,c);if(u<1)for(let h=1;h<c;h+=1){const m=u*h%1;d[h]=a.values[h-1]*(1-m)+a.values[h]*m}this._automationEvents[this._automationEvents.length-1]=oo(d,a.startTime,o)}}}else{const n=this._automationEvents.findIndex(o=>Gt(o)>t),i=n===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[n-1];if(i!==void 0&&Rt(i)&&Gt(i)+i.duration>t)return!1;const a=Cs(e)?pa(e.value,e.endTime,this._currenTime):Wn(e)?fa(e.value,t,this._currenTime):e;if(n===-1)this._automationEvents.push(a);else{if(Rt(e)&&t+e.duration>Gt(this._automationEvents[n]))return!1;this._automationEvents.splice(n,0,a)}}return!0}flush(e){const t=this._automationEvents.findIndex(n=>Gt(n)>e);if(t>1){const n=this._automationEvents.slice(t-1),i=n[0];Tn(i)&&n.unshift(Hr(Gn(this._automationEvents,t-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=n}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(o=>Gt(o)>e),n=this._automationEvents[t],i=(t===-1?this._automationEvents.length:t)-1,a=this._automationEvents[i];if(a!==void 0&&Tn(a)&&(n===void 0||!Yt(n)||n.insertTime>e))return co(e,Gn(this._automationEvents,i-1,a.startTime,this._defaultValue),a);if(a!==void 0&&ui(a)&&(n===void 0||!Yt(n)))return a.value;if(a!==void 0&&Rt(a)&&(n===void 0||!Yt(n)||a.startTime+a.duration>e))return e<a.startTime+a.duration?Lu(e,a):a.values[a.values.length-1];if(a!==void 0&&Yt(a)&&(n===void 0||!Yt(n)))return a.value;if(n!==void 0&&Cs(n)){const[o,l]=ga(this._automationEvents,i,a,n,this._defaultValue);return va(e,o,l,n)}if(n!==void 0&&Wn(n)){const[o,l]=ga(this._automationEvents,i,a,n,this._defaultValue);return ya(e,o,l,n)}return this._defaultValue}}const Uu=s=>({cancelTime:s,type:"cancelAndHold"}),Bu=s=>({cancelTime:s,type:"cancelScheduledValues"}),qu=(s,e)=>({endTime:e,type:"exponentialRampToValue",value:s}),Wu=(s,e)=>({endTime:e,type:"linearRampToValue",value:s}),Gu=(s,e,t)=>({startTime:e,target:s,timeConstant:t,type:"setTarget"}),$u=()=>new DOMException("","AbortError"),zu=s=>(e,t,[n,i,a],o)=>{s(e[i],[t,n,a],l=>l[0]===t&&l[1]===n,o)},Yu=s=>(e,t,n)=>{const i=[];for(let a=0;a<n.numberOfInputs;a+=1)i.push(new Set);s.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},Hu=s=>(e,t)=>{s.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},Ds=new WeakSet,lo=new WeakMap,di=new WeakMap,uo=new WeakMap,hi=new WeakMap,rr=new WeakMap,ho=new WeakMap,Kr=new WeakMap,Zr=new WeakMap,Qr=new WeakMap,mo={construct(){return mo}},Xu=s=>{try{const e=new Proxy(s,mo);new e}catch{return!1}return!0},ba=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,xa=(s,e)=>{const t=[];let n=s.replace(/^[\s]+/,""),i=n.match(ba);for(;i!==null;){const a=i[1].slice(1,-1),o=i[0].replace(/([\s]+)?;?$/,"").replace(a,new URL(a,e).toString());t.push(o),n=n.slice(i[0].length).replace(/^[\s]+/,""),i=n.match(ba)}return[t.join(";"),n]},_a=s=>{if(s!==void 0&&!Array.isArray(s))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},wa=s=>{if(!Xu(s))throw new TypeError("The given value for processorCtor should be a constructor.");if(s.prototype===null||typeof s.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Ju=(s,e,t,n,i,a,o,l,c,u,d,h,m)=>{let f=0;return(p,g,v={credentials:"omit"})=>{const b=d.get(p);if(b!==void 0&&b.has(g))return Promise.resolve();const w=u.get(p);if(w!==void 0){const x=w.get(g);if(x!==void 0)return x}const S=a(p),A=S.audioWorklet===void 0?i(g).then(([x,T])=>{const[k,y]=xa(x,T),j=`${k};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${y}
})})(window,'_AWGS')`;return t(j)}).then(()=>{const x=m._AWGS.pop();if(x===void 0)throw new SyntaxError;n(S.currentTime,S.sampleRate,()=>x(class{},void 0,(T,k)=>{if(T.trim()==="")throw e();const y=Zr.get(S);if(y!==void 0){if(y.has(T))throw e();wa(k),_a(k.parameterDescriptors),y.set(T,k)}else wa(k),_a(k.parameterDescriptors),Zr.set(S,new Map([[T,k]]))},S.sampleRate,void 0,void 0))}):Promise.all([i(g),Promise.resolve(s(h,h))]).then(([[x,T],k])=>{const y=f+1;f=y;const[j,C]=xa(x,T),E=`${j};((AudioWorkletProcessor,registerProcessor)=>{${C}
})(${k?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${k?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${k?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${y}',class extends AudioWorkletProcessor{process(){return !1}})`,I=new Blob([E],{type:"application/javascript; charset=utf-8"}),V=URL.createObjectURL(I);return S.audioWorklet.addModule(V,v).then(()=>{if(l(S))return S;const F=o(S);return F.audioWorklet.addModule(V,v).then(()=>F)}).then(F=>{if(c===null)throw new SyntaxError;try{new c(F,`__sac${y}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(V))});return w===void 0?u.set(p,new Map([[g,A]])):w.set(g,A),A.then(()=>{const x=d.get(p);x===void 0?d.set(p,new Set([g])):x.add(g)}).finally(()=>{const x=u.get(p);x!==void 0&&x.delete(g)}),A}},wt=(s,e)=>{const t=s.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},ir=(s,e)=>{const t=Array.from(s).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[n]=t;return s.delete(n),n},po=(s,e,t,n)=>{const i=wt(s,e),a=ir(i,o=>o[0]===t&&o[1]===n);return i.size===0&&s.delete(e),a},hn=s=>wt(ho,s),Rs=s=>{if(Ds.has(s))throw new Error("The AudioNode is already stored.");Ds.add(s),hn(s).forEach(e=>e(!0))},fo=s=>"port"in s,mn=s=>{if(!Ds.has(s))throw new Error("The AudioNode is not stored.");Ds.delete(s),hn(s).forEach(e=>e(!1))},ei=(s,e)=>{!fo(s)&&e.every(t=>t.size===0)&&mn(s)},Ku=(s,e,t,n,i,a,o,l,c,u,d,h,m)=>{const f=new WeakMap;return(p,g,v,b,w)=>{const{activeInputs:S,passiveInputs:A}=a(g),{outputs:x}=a(p),T=l(p),k=y=>{const j=c(g),C=c(p);if(y){const O=po(A,p,v,b);s(S,p,O,!1),!w&&!h(p)&&t(C,j,v,b),m(g)&&Rs(g)}else{const O=n(S,p,v,b);e(A,b,O,!1),!w&&!h(p)&&i(C,j,v,b);const P=o(g);if(P===0)d(g)&&ei(g,S);else{const U=f.get(g);U!==void 0&&clearTimeout(U),f.set(g,setTimeout(()=>{d(g)&&ei(g,S)},P*1e3))}}};return u(x,[g,v,b],y=>y[0]===g&&y[1]===v&&y[2]===b,!0)?(T.add(k),d(p)?s(S,p,[v,b,k],!0):e(A,b,[p,v,k],!0),!0):!1}},Zu=s=>(e,t,[n,i,a],o)=>{const l=e.get(n);l===void 0?e.set(n,new Set([[i,t,a]])):s(l,[i,t,a],c=>c[0]===i&&c[1]===t,o)},Qu=s=>(e,t)=>{const n=s(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(n).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(n),n.disconnect()};t.addEventListener("ended",i)},ed=s=>(e,t)=>{s(e).add(t)},td={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},sd=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=i(l),d={...td,...c},h=n(u,d),m=a(u)?e():null;super(l,!1,h,m),this._nativeAnalyserNode=h}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(l){this._nativeAnalyserNode.fftSize=l}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(l){const c=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=l,!(l>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=c,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(l){const c=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=l,!(this._nativeAnalyserNode.maxDecibels>l))throw this._nativeAnalyserNode.minDecibels=c,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(l){this._nativeAnalyserNode.smoothingTimeConstant=l}getByteFrequencyData(l){this._nativeAnalyserNode.getByteFrequencyData(l)}getByteTimeDomainData(l){this._nativeAnalyserNode.getByteTimeDomainData(l)}getFloatFrequencyData(l){this._nativeAnalyserNode.getFloatFrequencyData(l)}getFloatTimeDomainData(l){this._nativeAnalyserNode.getFloatTimeDomainData(l)}},Ze=(s,e)=>s.context===e,nd=(s,e,t)=>()=>{const n=new WeakMap,i=async(a,o)=>{let l=e(a);if(!Ze(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,fftSize:l.fftSize,maxDecibels:l.maxDecibels,minDecibels:l.minDecibels,smoothingTimeConstant:l.smoothingTimeConstant};l=s(o,u)}return n.set(o,l),await t(a,o,l),l};return{render(a,o){const l=n.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},$n=s=>{try{s.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Mt=()=>new DOMException("","IndexSizeError"),mi=s=>{s.getChannelData=(e=>t=>{try{return e.call(s,t)}catch(n){throw n.code===12?Mt():n}})(s.getChannelData)},rd={numberOfChannels:1},id=(s,e,t,n,i,a,o,l)=>{let c=null;return class go{constructor(d){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:h,numberOfChannels:m,sampleRate:f}={...rd,...d};c===null&&(c=new i(1,1,44100));const p=n!==null&&e(a,a)?new n({length:h,numberOfChannels:m,sampleRate:f}):c.createBuffer(m,h,f);if(p.numberOfChannels===0)throw t();return typeof p.copyFromChannel!="function"?(o(p),mi(p)):e($n,()=>$n(p))||l(p),s.add(p),p}static[Symbol.hasInstance](d){return d!==null&&typeof d=="object"&&Object.getPrototypeOf(d)===go.prototype||s.has(d)}}},at=-34028234663852886e22,tt=-at,Ft=s=>Ds.has(s),ad={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},od=(s,e,t,n,i,a,o,l)=>class extends s{constructor(u,d){const h=a(u),m={...ad,...d},f=i(h,m),p=o(h),g=p?e():null;super(u,!1,f,g),this._audioBufferSourceNodeRenderer=g,this._isBufferNullified=!1,this._isBufferSet=m.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,p,f.playbackRate,tt,at)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw n();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const d=typeof u=="function"?l(this,u):null;this._nativeAudioBufferSourceNode.onended=d;const h=this._nativeAudioBufferSourceNode.onended;this._onended=h!==null&&h===d?u:h}get playbackRate(){return this._playbackRate}start(u=0,d=0,h){if(this._nativeAudioBufferSourceNode.start(u,d,h),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=h===void 0?[u,d]:[u,d,h]),this.context.state!=="closed"){Rs(this);const m=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",m),Ft(this)&&mn(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",m)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},cd=(s,e,t,n,i)=>()=>{const a=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const m=Ze(h,d);if(!m){const f={buffer:h.buffer,channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,loop:h.loop,loopEnd:h.loopEnd,loopStart:h.loopStart,playbackRate:h.playbackRate.value};h=e(d,f),o!==null&&h.start(...o),l!==null&&h.stop(l)}return a.set(d,h),m?await s(d,u.playbackRate,h.playbackRate):await n(d,u.playbackRate,h.playbackRate),await i(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=a.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},ld=s=>"playbackRate"in s,ud=s=>"frequency"in s&&"gain"in s,dd=s=>"offset"in s,hd=s=>!("frequency"in s)&&"gain"in s,md=s=>"detune"in s&&"frequency"in s&&!("gain"in s),pd=s=>"pan"in s,st=s=>wt(lo,s),pn=s=>wt(uo,s),ti=(s,e)=>{const{activeInputs:t}=st(s);t.forEach(i=>i.forEach(([a])=>{e.includes(s)||ti(a,[...e,s])}));const n=ld(s)?[s.playbackRate]:fo(s)?Array.from(s.parameters.values()):ud(s)?[s.Q,s.detune,s.frequency,s.gain]:dd(s)?[s.offset]:hd(s)?[s.gain]:md(s)?[s.detune,s.frequency]:pd(s)?[s.pan]:[];for(const i of n){const a=pn(i);a!==void 0&&a.activeInputs.forEach(([o])=>ti(o,e))}Ft(s)&&mn(s)},vo=s=>{ti(s.destination,[])},fd=s=>s===void 0||typeof s=="number"||typeof s=="string"&&(s==="balanced"||s==="interactive"||s==="playback"),gd=(s,e,t,n,i,a,o,l,c)=>class extends s{constructor(d={}){if(c===null)throw new Error("Missing the native AudioContext constructor.");let h;try{h=new c(d)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?t():p}if(h===null)throw n();if(!fd(d.latencyHint))throw new TypeError(`The provided value '${d.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(d.sampleRate!==void 0&&h.sampleRate!==d.sampleRate)throw t();super(h,2);const{latencyHint:m}=d,{sampleRate:f}=h;if(this._baseLatency=typeof h.baseLatency=="number"?h.baseLatency:m==="balanced"?512/f:m==="interactive"||m===void 0?256/f:m==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(m*f/128)))*128/f,this._nativeAudioContext=h,c.name==="webkitAudioContext"?(this._nativeGainNode=h.createGain(),this._nativeOscillatorNode=h.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(h.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,h.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),h.removeEventListener("statechange",p)};h.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),vo(this)}))}createMediaElementSource(d){return new i(this,{mediaElement:d})}createMediaStreamDestination(){return new a(this)}createMediaStreamSource(d){return new o(this,{mediaStream:d})}createMediaStreamTrackSource(d){return new l(this,{mediaStreamTrack:d})}resume(){return this._state==="suspended"?new Promise((d,h)=>{const m=()=>{this._nativeAudioContext.removeEventListener("statechange",m),this._nativeAudioContext.state==="running"?d():this.resume().then(d,h)};this._nativeAudioContext.addEventListener("statechange",m)}):this._nativeAudioContext.resume().catch(d=>{throw d===void 0||d.code===15?e():d})}suspend(){return this._nativeAudioContext.suspend().catch(d=>{throw d===void 0?e():d})}},vd=(s,e,t,n,i,a,o,l)=>class extends s{constructor(u,d){const h=a(u),m=o(h),f=i(h,d,m),p=m?e(l):null;super(u,!1,f,p),this._isNodeOfNativeOfflineAudioContext=m,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw n();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw n();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},yd=s=>{const e=new WeakMap,t=async(n,i)=>{const a=i.destination;return e.set(i,a),await s(n,i,a),a};return{render(n,i){const a=e.get(i);return a!==void 0?Promise.resolve(a):t(n,i)}}},bd=(s,e,t,n,i,a,o,l)=>(c,u)=>{const d=u.listener,h=()=>{const x=new Float32Array(1),T=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),k=o(u);let y=!1,j=[0,0,-1,0,1,0],C=[0,0,0];const O=()=>{if(y)return;y=!0;const I=n(u,256,9,0);I.onaudioprocess=({inputBuffer:V})=>{const F=[a(V,x,0),a(V,x,1),a(V,x,2),a(V,x,3),a(V,x,4),a(V,x,5)];F.some((z,L)=>z!==j[L])&&(d.setOrientation(...F),j=F);const X=[a(V,x,6),a(V,x,7),a(V,x,8)];X.some((z,L)=>z!==C[L])&&(d.setPosition(...X),C=X)},T.connect(I)},P=I=>V=>{V!==j[I]&&(j[I]=V,d.setOrientation(...j))},U=I=>V=>{V!==C[I]&&(C[I]=V,d.setPosition(...C))},E=(I,V,F)=>{const X=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:V});X.connect(T,0,I),X.start(),Object.defineProperty(X.offset,"defaultValue",{get(){return V}});const z=s({context:c},k,X.offset,tt,at);return l(z,"value",L=>()=>L.call(z),L=>H=>{try{L.call(z,H)}catch(Y){if(Y.code!==9)throw Y}O(),k&&F(H)}),z.cancelAndHoldAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.cancelAndHoldAtTime),z.cancelScheduledValues=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.cancelScheduledValues),z.exponentialRampToValueAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.exponentialRampToValueAtTime),z.linearRampToValueAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.linearRampToValueAtTime),z.setTargetAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.setTargetAtTime),z.setValueAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.setValueAtTime),z.setValueCurveAtTime=(L=>k?()=>{throw i()}:(...H)=>{const Y=L.apply(z,H);return O(),Y})(z.setValueCurveAtTime),z};return{forwardX:E(0,0,P(0)),forwardY:E(1,0,P(1)),forwardZ:E(2,-1,P(2)),positionX:E(6,0,U(0)),positionY:E(7,0,U(1)),positionZ:E(8,0,U(2)),upX:E(3,0,P(3)),upY:E(4,1,P(4)),upZ:E(5,0,P(5))}},{forwardX:m,forwardY:f,forwardZ:p,positionX:g,positionY:v,positionZ:b,upX:w,upY:S,upZ:A}=d.forwardX===void 0?h():d;return{get forwardX(){return m},get forwardY(){return f},get forwardZ(){return p},get positionX(){return g},get positionY(){return v},get positionZ(){return b},get upX(){return w},get upY(){return S},get upZ(){return A}}},zn=s=>"context"in s,fn=s=>zn(s[0]),gs=(s,e,t,n)=>{for(const i of s)if(t(i)){if(n)return!1;throw Error("The set contains at least one similar element.")}return s.add(e),!0},Na=(s,e,[t,n],i)=>{gs(s,[e,t,n],a=>a[0]===e&&a[1]===t,i)},Sa=(s,[e,t,n],i)=>{const a=s.get(e);a===void 0?s.set(e,new Set([[t,n]])):gs(a,[t,n],o=>o[0]===t,i)},$s=s=>"inputs"in s,Yn=(s,e,t,n)=>{if($s(e)){const i=e.inputs[n];return s.connect(i,t,0),[i,t,0]}return s.connect(e,t,n),[e,t,n]},yo=(s,e,t)=>{for(const n of s)if(n[0]===e&&n[1]===t)return s.delete(n),n;return null},xd=(s,e,t)=>ir(s,n=>n[0]===e&&n[1]===t),bo=(s,e)=>{if(!hn(s).delete(e))throw new Error("Missing the expected event listener.")},xo=(s,e,t)=>{const n=wt(s,e),i=ir(n,a=>a[0]===t);return n.size===0&&s.delete(e),i},Hn=(s,e,t,n)=>{$s(e)?s.disconnect(e.inputs[n],t,0):s.disconnect(e,t,n)},Se=s=>wt(di,s),sn=s=>wt(hi,s),us=s=>Kr.has(s),Fn=s=>!Ds.has(s),ka=(s,e)=>new Promise(t=>{if(e!==null)t(!0);else{const n=s.createScriptProcessor(256,1,1),i=s.createGain(),a=s.createBuffer(1,2,44100),o=a.getChannelData(0);o[0]=1,o[1]=1;const l=s.createBufferSource();l.buffer=a,l.loop=!0,l.connect(n).connect(s.destination),l.connect(i),l.disconnect(i),n.onaudioprocess=c=>{const u=c.inputBuffer.getChannelData(0);Array.prototype.some.call(u,d=>d===1)?t(!0):t(!1),l.stop(),n.onaudioprocess=null,l.disconnect(n),n.disconnect(s.destination)},l.start()}}),Vr=(s,e)=>{const t=new Map;for(const n of s)for(const i of n){const a=t.get(i);t.set(i,a===void 0?1:a+1)}t.forEach((n,i)=>e(i,n))},Xn=s=>"context"in s,_d=s=>{const e=new Map;s.connect=(t=>(n,i=0,a=0)=>{const o=Xn(n)?t(n,i,a):t(n,i),l=e.get(n);return l===void 0?e.set(n,[{input:a,output:i}]):l.every(c=>c.input!==a||c.output!==i)&&l.push({input:a,output:i}),o})(s.connect.bind(s)),s.disconnect=(t=>(n,i,a)=>{if(t.apply(s),n===void 0)e.clear();else if(typeof n=="number")for(const[o,l]of e){const c=l.filter(u=>u.output!==n);c.length===0?e.delete(o):e.set(o,c)}else if(e.has(n))if(i===void 0)e.delete(n);else{const o=e.get(n);if(o!==void 0){const l=o.filter(c=>c.output!==i&&(c.input!==a||a===void 0));l.length===0?e.delete(n):e.set(n,l)}}for(const[o,l]of e)l.forEach(c=>{Xn(o)?s.connect(o,c.output,c.input):s.connect(o,c.output)})})(s.disconnect)},wd=(s,e,t,n)=>{const{activeInputs:i,passiveInputs:a}=pn(e),{outputs:o}=st(s),l=hn(s),c=u=>{const d=Se(s),h=sn(e);if(u){const m=xo(a,s,t);Na(i,s,m,!1),!n&&!us(s)&&d.connect(h,t)}else{const m=xd(i,s,t);Sa(a,m,!1),!n&&!us(s)&&d.disconnect(h,t)}};return gs(o,[e,t],u=>u[0]===e&&u[1]===t,!0)?(l.add(c),Ft(s)?Na(i,s,[t,c],!0):Sa(a,[s,t,c],!0),!0):!1},Nd=(s,e,t,n)=>{const{activeInputs:i,passiveInputs:a}=st(e),o=yo(i[n],s,t);return o===null?[po(a,s,t,n)[2],!1]:[o[2],!0]},Sd=(s,e,t)=>{const{activeInputs:n,passiveInputs:i}=pn(e),a=yo(n,s,t);return a===null?[xo(i,s,t)[1],!1]:[a[2],!0]},pi=(s,e,t,n,i)=>{const[a,o]=Nd(s,t,n,i);if(a!==null&&(bo(s,a),o&&!e&&!us(s)&&Hn(Se(s),Se(t),n,i)),Ft(t)){const{activeInputs:l}=st(t);ei(t,l)}},fi=(s,e,t,n)=>{const[i,a]=Sd(s,t,n);i!==null&&(bo(s,i),a&&!e&&!us(s)&&Se(s).disconnect(sn(t),n))},kd=(s,e)=>{const t=st(s),n=[];for(const i of t.outputs)fn(i)?pi(s,e,...i):fi(s,e,...i),n.push(i[0]);return t.outputs.clear(),n},jd=(s,e,t)=>{const n=st(s),i=[];for(const a of n.outputs)a[1]===t&&(fn(a)?pi(s,e,...a):fi(s,e,...a),i.push(a[0]),n.outputs.delete(a));return i},Td=(s,e,t,n,i)=>{const a=st(s);return Array.from(a.outputs).filter(o=>o[0]===t&&(n===void 0||o[1]===n)&&(i===void 0||o[2]===i)).map(o=>(fn(o)?pi(s,e,...o):fi(s,e,...o),a.outputs.delete(o),o[0]))},Cd=(s,e,t,n,i,a,o,l,c,u,d,h,m,f,p,g)=>class extends u{constructor(b,w,S,A){super(S),this._context=b,this._nativeAudioNode=S;const x=d(b);h(x)&&t(ka,()=>ka(x,g))!==!0&&_d(S),di.set(this,S),ho.set(this,new Set),b.state!=="closed"&&w&&Rs(this),s(this,A,S)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(b){this._nativeAudioNode.channelCount=b}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(b){this._nativeAudioNode.channelCountMode=b}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(b){this._nativeAudioNode.channelInterpretation=b}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(b,w=0,S=0){if(w<0||w>=this._nativeAudioNode.numberOfOutputs)throw i();const A=d(this._context),x=p(A);if(m(b)||f(b))throw a();if(zn(b)){const y=Se(b);try{const C=Yn(this._nativeAudioNode,y,w,S),O=Fn(this);(x||O)&&this._nativeAudioNode.disconnect(...C),this.context.state!=="closed"&&!O&&Fn(b)&&Rs(b)}catch(C){throw C.code===12?a():C}if(e(this,b,w,S,x)){const C=c([this],b);Vr(C,n(x))}return b}const T=sn(b);if(T.name==="playbackRate"&&T.maxValue===1024)throw o();try{this._nativeAudioNode.connect(T,w),(x||Fn(this))&&this._nativeAudioNode.disconnect(T,w)}catch(y){throw y.code===12?a():y}if(wd(this,b,w,x)){const y=c([this],b);Vr(y,n(x))}}disconnect(b,w,S){let A;const x=d(this._context),T=p(x);if(b===void 0)A=kd(this,T);else if(typeof b=="number"){if(b<0||b>=this.numberOfOutputs)throw i();A=jd(this,T,b)}else{if(w!==void 0&&(w<0||w>=this.numberOfOutputs)||zn(b)&&S!==void 0&&(S<0||S>=b.numberOfInputs))throw i();if(A=Td(this,T,b,w,S),A.length===0)throw a()}for(const k of A){const y=c([this],k);Vr(y,l)}}},Id=(s,e,t,n,i,a,o,l,c,u,d,h,m)=>(f,p,g,v=null,b=null)=>{const w=g.value,S=new Vu(w),A=p?n(S):null,x={get defaultValue(){return w},get maxValue(){return v===null?g.maxValue:v},get minValue(){return b===null?g.minValue:b},get value(){return g.value},set value(T){g.value=T,x.setValueAtTime(T,f.context.currentTime)},cancelAndHoldAtTime(T){if(typeof g.cancelAndHoldAtTime=="function")A===null&&S.flush(f.context.currentTime),S.add(i(T)),g.cancelAndHoldAtTime(T);else{const k=Array.from(S).pop();A===null&&S.flush(f.context.currentTime),S.add(i(T));const y=Array.from(S).pop();g.cancelScheduledValues(T),k!==y&&y!==void 0&&(y.type==="exponentialRampToValue"?g.exponentialRampToValueAtTime(y.value,y.endTime):y.type==="linearRampToValue"?g.linearRampToValueAtTime(y.value,y.endTime):y.type==="setValue"?g.setValueAtTime(y.value,y.startTime):y.type==="setValueCurve"&&g.setValueCurveAtTime(y.values,y.startTime,y.duration))}return x},cancelScheduledValues(T){return A===null&&S.flush(f.context.currentTime),S.add(a(T)),g.cancelScheduledValues(T),x},exponentialRampToValueAtTime(T,k){if(T===0)throw new RangeError;if(!Number.isFinite(k)||k<0)throw new RangeError;const y=f.context.currentTime;return A===null&&S.flush(y),Array.from(S).length===0&&(S.add(u(w,y)),g.setValueAtTime(w,y)),S.add(o(T,k)),g.exponentialRampToValueAtTime(T,k),x},linearRampToValueAtTime(T,k){const y=f.context.currentTime;return A===null&&S.flush(y),Array.from(S).length===0&&(S.add(u(w,y)),g.setValueAtTime(w,y)),S.add(l(T,k)),g.linearRampToValueAtTime(T,k),x},setTargetAtTime(T,k,y){return A===null&&S.flush(f.context.currentTime),S.add(c(T,k,y)),g.setTargetAtTime(T,k,y),x},setValueAtTime(T,k){return A===null&&S.flush(f.context.currentTime),S.add(u(T,k)),g.setValueAtTime(T,k),x},setValueCurveAtTime(T,k,y){const j=T instanceof Float32Array?T:new Float32Array(T);if(h!==null&&h.name==="webkitAudioContext"){const C=k+y,O=f.context.sampleRate,P=Math.ceil(k*O),U=Math.floor(C*O),E=U-P,I=new Float32Array(E);for(let F=0;F<E;F+=1){const X=(j.length-1)/y*((P+F)/O-k),z=Math.floor(X),L=Math.ceil(X);I[F]=z===L?j[z]:(1-(X-z))*j[z]+(1-(L-X))*j[L]}A===null&&S.flush(f.context.currentTime),S.add(d(I,k,y)),g.setValueCurveAtTime(I,k,y);const V=U/O;V<C&&m(x,I[I.length-1],V),m(x,j[j.length-1],C)}else A===null&&S.flush(f.context.currentTime),S.add(d(j,k,y)),g.setValueCurveAtTime(j,k,y);return x}};return t.set(x,g),e.set(x,f),s(x,A),x},Ad=s=>({replay(e){for(const t of s)if(t.type==="exponentialRampToValue"){const{endTime:n,value:i}=t;e.exponentialRampToValueAtTime(i,n)}else if(t.type==="linearRampToValue"){const{endTime:n,value:i}=t;e.linearRampToValueAtTime(i,n)}else if(t.type==="setTarget"){const{startTime:n,target:i,timeConstant:a}=t;e.setTargetAtTime(i,n,a)}else if(t.type==="setValue"){const{startTime:n,value:i}=t;e.setValueAtTime(i,n)}else if(t.type==="setValueCurve"){const{duration:n,startTime:i,values:a}=t;e.setValueCurveAtTime(a,i,n)}else throw new Error("Can't apply an unknown automation.")}});class _o{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((n,i)=>e.call(t,n,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const Md={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},Ed=(s,e,t,n,i,a,o,l,c,u,d,h,m,f)=>class extends e{constructor(g,v,b){var w;const S=l(g),A=c(S),x=d({...Md,...b});m(x);const T=Zr.get(S),k=T?.get(v),y=A||S.state!=="closed"?S:(w=o(S))!==null&&w!==void 0?w:S,j=i(y,A?null:g.baseLatency,u,v,k,x),C=A?n(v,x,k):null;super(g,!0,j,C);const O=[];j.parameters.forEach((U,E)=>{const I=t(this,A,U);O.push([E,I])}),this._nativeAudioWorkletNode=j,this._onprocessorerror=null,this._parameters=new _o(O),A&&s(S,this);const{activeInputs:P}=a(this);h(j,P)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(g){const v=typeof g=="function"?f(this,g):null;this._nativeAudioWorkletNode.onprocessorerror=v;const b=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=b!==null&&b===v?g:b}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function Jn(s,e,t,n,i){if(typeof s.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),s.copyFromChannel(e[t],n,i);else{const a=s.getChannelData(n);if(e[t].byteLength===0)e[t]=a.slice(i,i+128);else{const o=new Float32Array(a.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(o)}}}const wo=(s,e,t,n,i)=>{typeof s.copyToChannel=="function"?e[t].byteLength!==0&&s.copyToChannel(e[t],n,i):e[t].byteLength!==0&&s.getChannelData(n).set(e[t],i)},Kn=(s,e)=>{const t=[];for(let n=0;n<s;n+=1){const i=[],a=typeof e=="number"?e:e[n];for(let o=0;o<a;o+=1)i.push(new Float32Array(128));t.push(i)}return t},Od=(s,e)=>{const t=wt(Qr,s),n=Se(e);return wt(t,n)},Pd=async(s,e,t,n,i,a,o)=>{const l=e===null?Math.ceil(s.context.length/128)*128:e.length,c=n.channelCount*n.numberOfInputs,u=i.reduce((v,b)=>v+b,0),d=u===0?null:t.createBuffer(u,l,t.sampleRate);if(a===void 0)throw new Error("Missing the processor constructor.");const h=st(s),m=await Od(t,s),f=Kn(n.numberOfInputs,n.channelCount),p=Kn(n.numberOfOutputs,i),g=Array.from(s.parameters.keys()).reduce((v,b)=>({...v,[b]:new Float32Array(128)}),{});for(let v=0;v<l;v+=128){if(n.numberOfInputs>0&&e!==null)for(let b=0;b<n.numberOfInputs;b+=1)for(let w=0;w<n.channelCount;w+=1)Jn(e,f[b],w,w,v);a.parameterDescriptors!==void 0&&e!==null&&a.parameterDescriptors.forEach(({name:b},w)=>{Jn(e,g,b,c+w,v)});for(let b=0;b<n.numberOfInputs;b+=1)for(let w=0;w<i[b];w+=1)p[b][w].byteLength===0&&(p[b][w]=new Float32Array(128));try{const b=f.map((S,A)=>h.activeInputs[A].size===0?[]:S),w=o(v/t.sampleRate,t.sampleRate,()=>m.process(b,p,g));if(d!==null)for(let S=0,A=0;S<n.numberOfOutputs;S+=1){for(let x=0;x<i[S];x+=1)wo(d,p[S],x,A+x,v);A+=i[S]}if(!w)break}catch(b){s.dispatchEvent(new ErrorEvent("processorerror",{colno:b.colno,filename:b.filename,lineno:b.lineno,message:b.message}));break}}return d},Dd=(s,e,t,n,i,a,o,l,c,u,d,h,m,f,p,g)=>(v,b,w)=>{const S=new WeakMap;let A=null;const x=async(T,k)=>{let y=d(T),j=null;const C=Ze(y,k),O=Array.isArray(b.outputChannelCount)?b.outputChannelCount:Array.from(b.outputChannelCount);if(h===null){const P=O.reduce((V,F)=>V+F,0),U=i(k,{channelCount:Math.max(1,P),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,P)}),E=[];for(let V=0;V<T.numberOfOutputs;V+=1)E.push(n(k,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:O[V]}));const I=o(k,{channelCount:b.channelCount,channelCountMode:b.channelCountMode,channelInterpretation:b.channelInterpretation,gain:1});I.connect=e.bind(null,E),I.disconnect=c.bind(null,E),j=[U,E,I]}else C||(y=new h(k,v));if(S.set(k,j===null?y:j[2]),j!==null){if(A===null){if(w===void 0)throw new Error("Missing the processor constructor.");if(m===null)throw new Error("Missing the native OfflineAudioContext constructor.");const F=T.channelCount*T.numberOfInputs,X=w.parameterDescriptors===void 0?0:w.parameterDescriptors.length,z=F+X;A=Pd(T,z===0?null:await(async()=>{const H=new m(z,Math.ceil(T.context.length/128)*128,k.sampleRate),Y=[],ee=[];for(let M=0;M<b.numberOfInputs;M+=1)Y.push(o(H,{channelCount:b.channelCount,channelCountMode:b.channelCountMode,channelInterpretation:b.channelInterpretation,gain:1})),ee.push(i(H,{channelCount:b.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:b.channelCount}));const se=await Promise.all(Array.from(T.parameters.values()).map(async M=>{const D=a(H,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:M.value});return await f(H,M,D.offset),D})),B=n(H,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,F+X)});for(let M=0;M<b.numberOfInputs;M+=1){Y[M].connect(ee[M]);for(let D=0;D<b.channelCount;D+=1)ee[M].connect(B,D,M*b.channelCount+D)}for(const[M,D]of se.entries())D.connect(B,0,F+M),D.start(0);return B.connect(H.destination),await Promise.all(Y.map(M=>p(T,H,M))),g(H)})(),k,b,O,w,u)}const P=await A,U=t(k,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[E,I,V]=j;P!==null&&(U.buffer=P,U.start(0)),U.connect(E);for(let F=0,X=0;F<T.numberOfOutputs;F+=1){const z=I[F];for(let L=0;L<O[F];L+=1)E.connect(z,X+L,L);X+=O[F]}return V}if(C)for(const[P,U]of T.parameters.entries())await s(k,U,y.parameters.get(P));else for(const[P,U]of T.parameters.entries())await f(k,U,y.parameters.get(P));return await p(T,k,y),y};return{render(T,k){l(k,T);const y=S.get(k);return y!==void 0?Promise.resolve(y):x(T,k)}}},Rd=(s,e,t,n,i,a,o,l,c,u,d,h,m,f,p,g,v,b,w,S)=>class extends p{constructor(x,T){super(x,T),this._nativeContext=x,this._audioWorklet=s===void 0?void 0:{addModule:(k,y)=>s(this,k,y)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new i(this)}createBuffer(x,T,k){return new t({length:T,numberOfChannels:x,sampleRate:k})}createBufferSource(){return new n(this)}createChannelMerger(x=6){return new a(this,{numberOfInputs:x})}createChannelSplitter(x=6){return new o(this,{numberOfOutputs:x})}createConstantSource(){return new l(this)}createConvolver(){return new c(this)}createDelay(x=1){return new d(this,{maxDelayTime:x})}createDynamicsCompressor(){return new h(this)}createGain(){return new m(this)}createIIRFilter(x,T){return new f(this,{feedback:T,feedforward:x})}createOscillator(){return new g(this)}createPanner(){return new v(this)}createPeriodicWave(x,T,k={disableNormalization:!1}){return new b(this,{...k,imag:T,real:x})}createStereoPanner(){return new w(this)}createWaveShaper(){return new S(this)}decodeAudioData(x,T,k){return u(this._nativeContext,x).then(y=>(typeof T=="function"&&T(y),y),y=>{throw typeof k=="function"&&k(y),y})}},Fd={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Ld=(s,e,t,n,i,a,o,l)=>class extends s{constructor(u,d){const h=a(u),m={...Fd,...d},f=i(h,m),p=o(h),g=p?t():null;super(u,!1,f,g),this._Q=e(this,p,f.Q,tt,at),this._detune=e(this,p,f.detune,1200*Math.log2(tt),-1200*Math.log2(tt)),this._frequency=e(this,p,f.frequency,u.sampleRate/2,0),this._gain=e(this,p,f.gain,40*Math.log10(tt),at),this._nativeBiquadFilterNode=f,l(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,d,h){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,d,h)}catch(m){throw m.code===11?n():m}if(u.length!==d.length||d.length!==h.length)throw n()}},Vd=(s,e,t,n,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Ze(u,c);if(!d){const h={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(c,h)}return a.set(c,u),d?(await s(c,l.Q,u.Q),await s(c,l.detune,u.detune),await s(c,l.frequency,u.frequency),await s(c,l.gain,u.gain)):(await n(c,l.Q,u.Q),await n(c,l.detune,u.detune),await n(c,l.frequency,u.frequency),await n(c,l.gain,u.gain)),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},Ud=(s,e)=>(t,n)=>{const i=e.get(t);if(i!==void 0)return i;const a=s.get(t);if(a!==void 0)return a;try{const o=n();return o instanceof Promise?(s.set(t,o),o.catch(()=>!1).then(l=>(s.delete(t),e.set(t,l),l))):(e.set(t,o),o)}catch{return e.set(t,!1),!1}},Bd={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},qd=(s,e,t,n,i)=>class extends s{constructor(o,l){const c=n(o),u={...Bd,...l},d=t(c,u),h=i(c)?e():null;super(o,!1,d,h)}},Wd=(s,e,t)=>()=>{const n=new WeakMap,i=async(a,o)=>{let l=e(a);if(!Ze(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfInputs:l.numberOfInputs};l=s(o,u)}return n.set(o,l),await t(a,o,l),l};return{render(a,o){const l=n.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},Gd={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},$d=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=n(l),d=a({...Gd,...c}),h=t(u,d),m=i(u)?e():null;super(l,!1,h,m)}},zd=(s,e,t)=>()=>{const n=new WeakMap,i=async(a,o)=>{let l=e(a);if(!Ze(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,numberOfOutputs:l.numberOfOutputs};l=s(o,u)}return n.set(o,l),await t(a,o,l),l};return{render(a,o){const l=n.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},Yd=s=>(e,t,n)=>s(t,e,n),Hd=s=>(e,t,n=0,i=0)=>{const a=e[n];if(a===void 0)throw s();return Xn(t)?a.connect(t,0,i):a.connect(t,0)},Xd=s=>(e,t)=>{const n=s(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return n.buffer=i,n.loop=!0,n.connect(t),n.start(),()=>{n.stop(),n.disconnect(t)}},Jd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Kd=(s,e,t,n,i,a,o)=>class extends s{constructor(c,u){const d=i(c),h={...Jd,...u},m=n(d,h),f=a(d),p=f?t():null;super(c,!1,m,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=m,this._offset=e(this,f,m.offset,tt,at),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeConstantSourceNode.onended=u;const d=this._nativeConstantSourceNode.onended;this._onended=d!==null&&d===u?c:d}start(c=0){if(this._nativeConstantSourceNode.start(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=c),this.context.state!=="closed"){Rs(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),Ft(this)&&mn(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(c=0){this._nativeConstantSourceNode.stop(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=c)}},Zd=(s,e,t,n,i)=>()=>{const a=new WeakMap;let o=null,l=null;const c=async(u,d)=>{let h=t(u);const m=Ze(h,d);if(!m){const f={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,offset:h.offset.value};h=e(d,f),o!==null&&h.start(o),l!==null&&h.stop(l)}return a.set(d,h),m?await s(d,u.offset,h.offset):await n(d,u.offset,h.offset),await i(u,d,h),h};return{set start(u){o=u},set stop(u){l=u},render(u,d){const h=a.get(d);return h!==void 0?Promise.resolve(h):c(u,d)}}},Qd=s=>e=>(s[0]=e,s[0]),eh={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},th=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=n(l),d={...eh,...c},h=t(u,d),f=i(u)?e():null;super(l,!1,h,f),this._isBufferNullified=!1,this._nativeConvolverNode=h,d.buffer!==null&&a(this,d.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(l){if(this._nativeConvolverNode.buffer=l,l===null&&this._nativeConvolverNode.buffer!==null){const c=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=c.createBuffer(1,1,c.sampleRate),this._isBufferNullified=!0,a(this,0)}else this._isBufferNullified=!1,a(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(l){this._nativeConvolverNode.normalize=l}},sh=(s,e,t)=>()=>{const n=new WeakMap,i=async(a,o)=>{let l=e(a);if(!Ze(l,o)){const u={buffer:l.buffer,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,disableNormalization:!l.normalize};l=s(o,u)}return n.set(o,l),$s(l)?await t(a,o,l.inputs[0]):await t(a,o,l),l};return{render(a,o){const l=n.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},nh=(s,e)=>(t,n,i)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,n,i)}catch(a){throw a.name==="SyntaxError"?s():a}},rh=()=>new DOMException("","DataCloneError"),ja=s=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(n=>{const i=()=>{t.onmessage=null,e.close(),t.close(),n()};t.onmessage=()=>i();try{e.postMessage(s,[s])}catch{}finally{i()}})},ih=(s,e,t,n,i,a,o,l,c,u,d)=>(h,m)=>{const f=o(h)?h:a(h);if(i.has(m)){const p=t();return Promise.reject(p)}try{i.add(m)}catch{}return e(c,()=>c(f))?f.decodeAudioData(m).then(p=>(ja(m).catch(()=>{}),e(l,()=>l(p))||d(p),s.add(p),p)):new Promise((p,g)=>{const v=async()=>{try{await ja(m)}catch{}},b=w=>{g(w),v()};try{f.decodeAudioData(m,w=>{typeof w.copyFromChannel!="function"&&(u(w),mi(w)),s.add(w),v().then(()=>p(w))},w=>{b(w===null?n():w)})}catch(w){b(w)}})},ah=(s,e,t,n,i,a,o,l)=>(c,u)=>{const d=e.get(c);if(d===void 0)throw new Error("Missing the expected cycle count.");const h=a(c.context),m=l(h);if(d===u){if(e.delete(c),!m&&o(c)){const f=n(c),{outputs:p}=t(c);for(const g of p)if(fn(g)){const v=n(g[0]);s(f,v,g[1],g[2])}else{const v=i(g[0]);f.connect(v,g[1])}}}else e.set(c,d-u)},oh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},ch=(s,e,t,n,i,a,o)=>class extends s{constructor(c,u){const d=i(c),h={...oh,...u},m=n(d,h),f=a(d),p=f?t(h.maxDelayTime):null;super(c,!1,m,p),this._delayTime=e(this,f,m.delayTime),o(this,h.maxDelayTime)}get delayTime(){return this._delayTime}},lh=(s,e,t,n,i)=>a=>{const o=new WeakMap,l=async(c,u)=>{let d=t(c);const h=Ze(d,u);if(!h){const m={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,delayTime:d.delayTime.value,maxDelayTime:a};d=e(u,m)}return o.set(u,d),h?await s(u,c.delayTime,d.delayTime):await n(u,c.delayTime,d.delayTime),await i(c,u,d),d};return{render(c,u){const d=o.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},uh=s=>(e,t,n,i)=>s(e[i],a=>a[0]===t&&a[1]===n),dh=s=>(e,t)=>{s(e).delete(t)},hh=s=>"delayTime"in s,mh=(s,e,t)=>function n(i,a){const o=zn(a)?a:t(s,a);if(hh(o))return[];if(i[0]===o)return[i];if(i.includes(o))return[];const{outputs:l}=e(o);return Array.from(l).map(c=>n([...i,o],c[0])).reduce((c,u)=>c.concat(u),[])},Cn=(s,e,t)=>{const n=e[t];if(n===void 0)throw s();return n},ph=s=>(e,t=void 0,n=void 0,i=0)=>t===void 0?e.forEach(a=>a.disconnect()):typeof t=="number"?Cn(s,e,t).disconnect():Xn(t)?n===void 0?e.forEach(a=>a.disconnect(t)):i===void 0?Cn(s,e,n).disconnect(t,0):Cn(s,e,n).disconnect(t,0,i):n===void 0?e.forEach(a=>a.disconnect(t)):Cn(s,e,n).disconnect(t,0),fh={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},gh=(s,e,t,n,i,a,o,l)=>class extends s{constructor(u,d){const h=a(u),m={...fh,...d},f=n(h,m),p=o(h),g=p?t():null;super(u,!1,f,g),this._attack=e(this,p,f.attack),this._knee=e(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,p,f.ratio),this._release=e(this,p,f.release),this._threshold=e(this,p,f.threshold),l(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const d=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=d,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const d=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=d,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},vh=(s,e,t,n,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Ze(u,c);if(!d){const h={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(c,h)}return a.set(c,u),d?(await s(c,l.attack,u.attack),await s(c,l.knee,u.knee),await s(c,l.ratio,u.ratio),await s(c,l.release,u.release),await s(c,l.threshold,u.threshold)):(await n(c,l.attack,u.attack),await n(c,l.knee,u.knee),await n(c,l.ratio,u.ratio),await n(c,l.release,u.release),await n(c,l.threshold,u.threshold)),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},yh=()=>new DOMException("","EncodingError"),bh=s=>e=>new Promise((t,n)=>{if(s===null){n(new SyntaxError);return}const i=s.document.head;if(i===null)n(new SyntaxError);else{const a=s.document.createElement("script"),o=new Blob([e],{type:"application/javascript"}),l=URL.createObjectURL(o),c=s.onerror,u=()=>{s.onerror=c,URL.revokeObjectURL(l)};s.onerror=(d,h,m,f,p)=>{if(h===l||h===s.location.href&&m===1&&f===1)return u(),n(p),!1;if(c!==null)return c(d,h,m,f,p)},a.onerror=()=>{u(),n(new SyntaxError)},a.onload=()=>{u(),t()},a.src=l,a.type="module",i.appendChild(a)}}),xh=s=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,n,i){if(n!==null){let a=this._listeners.get(n);a===void 0&&(a=s(this,n),typeof n=="function"&&this._listeners.set(n,a)),this._nativeEventTarget.addEventListener(t,a,i)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,n,i){const a=n===null?void 0:this._listeners.get(n);this._nativeEventTarget.removeEventListener(t,a===void 0?null:a,i)}},_h=s=>(e,t,n)=>{Object.defineProperties(s,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return n()}finally{s!==null&&(delete s.currentFrame,delete s.currentTime)}},wh=s=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw s()},Nh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Sh=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=i(l),d={...Nh,...c},h=n(u,d),m=a(u),f=m?t():null;super(l,!1,h,f),this._gain=e(this,m,h.gain,tt,at)}get gain(){return this._gain}},kh=(s,e,t,n,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Ze(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(c,h)}return a.set(c,u),d?await s(c,l.gain,u.gain):await n(c,l.gain,u.gain),await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},jh=(s,e)=>t=>e(s,t),Th=s=>e=>{const t=s(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},Ch=s=>e=>{var t;return(t=s.get(e))!==null&&t!==void 0?t:0},Ih=s=>e=>{const t=s(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},Ah=s=>e=>s.get(e),$e=()=>new DOMException("","InvalidStateError"),Mh=s=>e=>{const t=s.get(e);if(t===void 0)throw $e();return t},Eh=(s,e)=>t=>{let n=s.get(t);if(n!==void 0)return n;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return n=new e(1,1,44100),s.set(t,n),n},Oh=s=>e=>{const t=s.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},ar=()=>new DOMException("","InvalidAccessError"),Ph=s=>{s.getFrequencyResponse=(e=>(t,n,i)=>{if(t.length!==n.length||n.length!==i.length)throw ar();return e.call(s,t,n,i)})(s.getFrequencyResponse)},Dh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Rh=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=n(l),d=i(u),h={...Dh,...c},m=e(u,d?null:l.baseLatency,h),f=d?t(h.feedback,h.feedforward):null;super(l,!1,m,f),Ph(m),this._nativeIIRFilterNode=m,a(this,1)}getFrequencyResponse(l,c,u){return this._nativeIIRFilterNode.getFrequencyResponse(l,c,u)}},No=(s,e,t,n,i,a,o,l,c,u,d)=>{const h=u.length;let m=l;for(let f=0;f<h;f+=1){let p=t[0]*u[f];for(let g=1;g<i;g+=1){const v=m-g&c-1;p+=t[g]*a[v],p-=s[g]*o[v]}for(let g=i;g<n;g+=1)p+=t[g]*a[m-g&c-1];for(let g=i;g<e;g+=1)p-=s[g]*o[m-g&c-1];a[m]=u[f],o[m]=p,m=m+1&c-1,d[f]=p}return m},Fh=(s,e,t,n)=>{const i=t instanceof Float64Array?t:new Float64Array(t),a=n instanceof Float64Array?n:new Float64Array(n),o=i.length,l=a.length,c=Math.min(o,l);if(i[0]!==1){for(let p=0;p<o;p+=1)a[p]/=i[0];for(let p=1;p<l;p+=1)i[p]/=i[0]}const u=32,d=new Float32Array(u),h=new Float32Array(u),m=e.createBuffer(s.numberOfChannels,s.length,s.sampleRate),f=s.numberOfChannels;for(let p=0;p<f;p+=1){const g=s.getChannelData(p),v=m.getChannelData(p);d.fill(0),h.fill(0),No(i,o,a,l,c,d,h,0,u,g,v)}return m},Lh=(s,e,t,n,i)=>(a,o)=>{const l=new WeakMap;let c=null;const u=async(d,h)=>{let m=null,f=e(d);const p=Ze(f,h);if(h.createIIRFilter===void 0?m=s(h,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=h.createIIRFilter(o,a)),l.set(h,m===null?f:m),m!==null){if(c===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const v=new t(d.context.destination.channelCount,d.context.length,h.sampleRate);c=(async()=>{await n(d,v,v.destination);const b=await i(v);return Fh(b,h,a,o)})()}const g=await c;return m.buffer=g,m.start(0),m}return await n(d,h,f),f};return{render(d,h){const m=l.get(h);return m!==void 0?Promise.resolve(m):u(d,h)}}},Vh=(s,e,t,n,i,a)=>o=>(l,c)=>{const u=s.get(l);if(u===void 0){if(!o&&a(l)){const d=n(l),{outputs:h}=t(l);for(const m of h)if(fn(m)){const f=n(m[0]);e(d,f,m[1],m[2])}else{const f=i(m[0]);d.disconnect(f,m[1])}}s.set(l,c)}else s.set(l,u+c)},Uh=(s,e)=>t=>{const n=s.get(t);return e(n)||e(t)},Bh=(s,e)=>t=>s.has(t)||e(t),qh=(s,e)=>t=>s.has(t)||e(t),Wh=(s,e)=>t=>{const n=s.get(t);return e(n)||e(t)},Gh=s=>e=>s!==null&&e instanceof s,$h=s=>e=>s!==null&&typeof s.AudioNode=="function"&&e instanceof s.AudioNode,zh=s=>e=>s!==null&&typeof s.AudioParam=="function"&&e instanceof s.AudioParam,Yh=(s,e)=>t=>s(t)||e(t),Hh=s=>e=>s!==null&&e instanceof s,Xh=s=>s!==null&&s.isSecureContext,Jh=(s,e,t,n)=>class extends s{constructor(a,o){const l=t(a),c=e(l,o);if(n(l))throw TypeError();super(a,!0,c,null),this._nativeMediaElementAudioSourceNode=c}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},Kh={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Zh=(s,e,t,n)=>class extends s{constructor(a,o){const l=t(a);if(n(l))throw new TypeError;const c={...Kh,...o},u=e(l,c);super(a,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},Qh=(s,e,t,n)=>class extends s{constructor(a,o){const l=t(a),c=e(l,o);if(n(l))throw new TypeError;super(a,!0,c,null),this._nativeMediaStreamAudioSourceNode=c}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},em=(s,e,t)=>class extends s{constructor(i,a){const o=t(i),l=e(o,a);super(i,!0,l,null)}},tm=(s,e,t,n,i,a)=>class extends t{constructor(l,c){super(l),this._nativeContext=l,rr.set(this,l),n(l)&&i.set(l,new Set),this._destination=new s(this,c),this._listener=e(this,l),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(l){const c=typeof l=="function"?a(this,l):null;this._nativeContext.onstatechange=c;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===c?l:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},nn=s=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=s.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},sm=(s,e)=>(t,n,i)=>{const a=new Set;return t.connect=(o=>(l,c=0,u=0)=>{const d=a.size===0;if(e(l))return o.call(t,l,c,u),s(a,[l,c,u],h=>h[0]===l&&h[1]===c&&h[2]===u,!0),d&&n(),l;o.call(t,l,c),s(a,[l,c],h=>h[0]===l&&h[1]===c,!0),d&&n()})(t.connect),t.disconnect=(o=>(l,c,u)=>{const d=a.size>0;if(l===void 0)o.apply(t),a.clear();else if(typeof l=="number"){o.call(t,l);for(const m of a)m[1]===l&&a.delete(m)}else{e(l)?o.call(t,l,c,u):o.call(t,l,c);for(const m of a)m[0]===l&&(c===void 0||m[1]===c)&&(u===void 0||m[2]===u)&&a.delete(m)}const h=a.size===0;d&&h&&i()})(t.disconnect),t},Te=(s,e,t)=>{const n=e[t];n!==void 0&&n!==s[t]&&(s[t]=n)},Be=(s,e)=>{Te(s,e,"channelCount"),Te(s,e,"channelCountMode"),Te(s,e,"channelInterpretation")},Ta=s=>typeof s.getFloatTimeDomainData=="function",nm=s=>{s.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);s.getByteTimeDomainData(t);const n=Math.max(t.length,s.fftSize);for(let i=0;i<n;i+=1)e[i]=(t[i]-128)*.0078125;return e}},rm=(s,e)=>(t,n)=>{const i=t.createAnalyser();if(Be(i,n),!(n.maxDecibels>n.minDecibels))throw e();return Te(i,n,"fftSize"),Te(i,n,"maxDecibels"),Te(i,n,"minDecibels"),Te(i,n,"smoothingTimeConstant"),s(Ta,()=>Ta(i))||nm(i),i},im=s=>s===null?null:s.hasOwnProperty("AudioBuffer")?s.AudioBuffer:null,Ae=(s,e,t)=>{const n=e[t];n!==void 0&&n!==s[t].value&&(s[t].value=n)},am=s=>{s.start=(e=>{let t=!1;return(n=0,i=0,a)=>{if(t)throw $e();e.call(s,n,i,a),t=!0}})(s.start)},gi=s=>{s.start=(e=>(t=0,n=0,i)=>{if(typeof i=="number"&&i<0||n<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(s,t,n,i)})(s.start)},vi=s=>{s.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(s,t)})(s.stop)},om=(s,e,t,n,i,a,o,l,c,u,d)=>(h,m)=>{const f=h.createBufferSource();return Be(f,m),Ae(f,m,"playbackRate"),Te(f,m,"buffer"),Te(f,m,"loop"),Te(f,m,"loopEnd"),Te(f,m,"loopStart"),e(t,()=>t(h))||am(f),e(n,()=>n(h))||c(f),e(i,()=>i(h))||u(f,h),e(a,()=>a(h))||gi(f),e(o,()=>o(h))||d(f,h),e(l,()=>l(h))||vi(f),s(h,f),f},cm=s=>s===null?null:s.hasOwnProperty("AudioContext")?s.AudioContext:s.hasOwnProperty("webkitAudioContext")?s.webkitAudioContext:null,lm=(s,e)=>(t,n,i)=>{const a=t.destination;if(a.channelCount!==n)try{a.channelCount=n}catch{}i&&a.channelCountMode!=="explicit"&&(a.channelCountMode="explicit"),a.maxChannelCount===0&&Object.defineProperty(a,"maxChannelCount",{value:n});const o=s(t,{channelCount:n,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,gain:1});return e(o,"channelCount",l=>()=>l.call(o),l=>c=>{l.call(o,c);try{a.channelCount=c}catch(u){if(c>a.maxChannelCount)throw u}}),e(o,"channelCountMode",l=>()=>l.call(o),l=>c=>{l.call(o,c),a.channelCountMode=c}),e(o,"channelInterpretation",l=>()=>l.call(o),l=>c=>{l.call(o,c),a.channelInterpretation=c}),Object.defineProperty(o,"maxChannelCount",{get:()=>a.maxChannelCount}),o.connect(a),o},um=s=>s===null?null:s.hasOwnProperty("AudioWorkletNode")?s.AudioWorkletNode:null,dm=s=>{const{port1:e}=new MessageChannel;try{e.postMessage(s)}finally{e.close()}},hm=(s,e,t,n,i)=>(a,o,l,c,u,d)=>{if(l!==null)try{const h=new l(a,c,d),m=new Map;let f=null;if(Object.defineProperties(h,{channelCount:{get:()=>d.channelCount,set:()=>{throw s()}},channelCountMode:{get:()=>"explicit",set:()=>{throw s()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&h.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&h.addEventListener("processorerror",f)}}}),h.addEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const v=typeof g[1]=="function"?g[1]:typeof g[1]=="object"&&g[1]!==null&&typeof g[1].handleEvent=="function"?g[1].handleEvent:null;if(v!==null){const b=m.get(g[1]);b!==void 0?g[1]=b:(g[1]=w=>{w.type==="error"?(Object.defineProperties(w,{type:{value:"processorerror"}}),v(w)):v(new ErrorEvent(g[0],{...w}))},m.set(v,g[1]))}}return p.call(h,"error",g[1],g[2]),p.call(h,...g)})(h.addEventListener),h.removeEventListener=(p=>(...g)=>{if(g[0]==="processorerror"){const v=m.get(g[1]);v!==void 0&&(m.delete(g[1]),g[1]=v)}return p.call(h,"error",g[1],g[2]),p.call(h,g[0],g[1],g[2])})(h.removeEventListener),d.numberOfOutputs!==0){const p=t(a,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return h.connect(p).connect(a.destination),i(h,()=>p.disconnect(),()=>p.connect(a.destination))}return h}catch(h){throw h.code===11?n():h}if(u===void 0)throw n();return dm(d),e(a,o,u,d)},So=(s,e)=>s===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(s*e))))),mm=s=>new Promise((e,t)=>{const{port1:n,port2:i}=new MessageChannel;n.onmessage=({data:a})=>{n.close(),i.close(),e(a)},n.onmessageerror=({data:a})=>{n.close(),i.close(),t(a)},i.postMessage(s)}),pm=async(s,e)=>{const t=await mm(e);return new s(t)},fm=(s,e,t,n)=>{let i=Qr.get(s);i===void 0&&(i=new WeakMap,Qr.set(s,i));const a=pm(t,n);return i.set(e,a),a},gm=(s,e,t,n,i,a,o,l,c,u,d,h,m)=>(f,p,g,v)=>{if(v.numberOfInputs===0&&v.numberOfOutputs===0)throw c();const b=Array.isArray(v.outputChannelCount)?v.outputChannelCount:Array.from(v.outputChannelCount);if(b.some(K=>K<1))throw c();if(b.length!==v.numberOfOutputs)throw e();if(v.channelCountMode!=="explicit")throw c();const w=v.channelCount*v.numberOfInputs,S=b.reduce((K,Q)=>K+Q,0),A=g.parameterDescriptors===void 0?0:g.parameterDescriptors.length;if(w+A>6||S>6)throw c();const x=new MessageChannel,T=[],k=[];for(let K=0;K<v.numberOfInputs;K+=1)T.push(o(f,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1})),k.push(i(f,{channelCount:v.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:v.channelCount}));const y=[];if(g.parameterDescriptors!==void 0)for(const{defaultValue:K,maxValue:Q,minValue:_e,name:ge}of g.parameterDescriptors){const de=a(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:v.parameterData[ge]!==void 0?v.parameterData[ge]:K===void 0?0:K});Object.defineProperties(de.offset,{defaultValue:{get:()=>K===void 0?0:K},maxValue:{get:()=>Q===void 0?tt:Q},minValue:{get:()=>_e===void 0?at:_e}}),y.push(de)}const j=n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,w+A)}),C=So(p,f.sampleRate),O=l(f,C,w+A,Math.max(1,S)),P=i(f,{channelCount:Math.max(1,S),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,S)}),U=[];for(let K=0;K<v.numberOfOutputs;K+=1)U.push(n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:b[K]}));for(let K=0;K<v.numberOfInputs;K+=1){T[K].connect(k[K]);for(let Q=0;Q<v.channelCount;Q+=1)k[K].connect(j,Q,K*v.channelCount+Q)}const E=new _o(g.parameterDescriptors===void 0?[]:g.parameterDescriptors.map(({name:K},Q)=>{const _e=y[Q];return _e.connect(j,0,w+Q),_e.start(0),[K,_e.offset]}));j.connect(O);let I=v.channelInterpretation,V=null;const F=v.numberOfOutputs===0?[O]:U,X={get bufferSize(){return C},get channelCount(){return v.channelCount},set channelCount(K){throw t()},get channelCountMode(){return v.channelCountMode},set channelCountMode(K){throw t()},get channelInterpretation(){return I},set channelInterpretation(K){for(const Q of T)Q.channelInterpretation=K;I=K},get context(){return O.context},get inputs(){return T},get numberOfInputs(){return v.numberOfInputs},get numberOfOutputs(){return v.numberOfOutputs},get onprocessorerror(){return V},set onprocessorerror(K){typeof V=="function"&&X.removeEventListener("processorerror",V),V=typeof K=="function"?K:null,typeof V=="function"&&X.addEventListener("processorerror",V)},get parameters(){return E},get port(){return x.port2},addEventListener(...K){return O.addEventListener(K[0],K[1],K[2])},connect:s.bind(null,F),disconnect:u.bind(null,F),dispatchEvent(...K){return O.dispatchEvent(K[0])},removeEventListener(...K){return O.removeEventListener(K[0],K[1],K[2])}},z=new Map;x.port1.addEventListener=(K=>(...Q)=>{if(Q[0]==="message"){const _e=typeof Q[1]=="function"?Q[1]:typeof Q[1]=="object"&&Q[1]!==null&&typeof Q[1].handleEvent=="function"?Q[1].handleEvent:null;if(_e!==null){const ge=z.get(Q[1]);ge!==void 0?Q[1]=ge:(Q[1]=de=>{d(f.currentTime,f.sampleRate,()=>_e(de))},z.set(_e,Q[1]))}}return K.call(x.port1,Q[0],Q[1],Q[2])})(x.port1.addEventListener),x.port1.removeEventListener=(K=>(...Q)=>{if(Q[0]==="message"){const _e=z.get(Q[1]);_e!==void 0&&(z.delete(Q[1]),Q[1]=_e)}return K.call(x.port1,Q[0],Q[1],Q[2])})(x.port1.removeEventListener);let L=null;Object.defineProperty(x.port1,"onmessage",{get:()=>L,set:K=>{typeof L=="function"&&x.port1.removeEventListener("message",L),L=typeof K=="function"?K:null,typeof L=="function"&&(x.port1.addEventListener("message",L),x.port1.start())}}),g.prototype.port=x.port1;let H=null;fm(f,X,g,v).then(K=>H=K);const ee=Kn(v.numberOfInputs,v.channelCount),se=Kn(v.numberOfOutputs,b),B=g.parameterDescriptors===void 0?[]:g.parameterDescriptors.reduce((K,{name:Q})=>({...K,[Q]:new Float32Array(128)}),{});let M=!0;const D=()=>{v.numberOfOutputs>0&&O.disconnect(P);for(let K=0,Q=0;K<v.numberOfOutputs;K+=1){const _e=U[K];for(let ge=0;ge<b[K];ge+=1)P.disconnect(_e,Q+ge,ge);Q+=b[K]}},N=new Map;O.onaudioprocess=({inputBuffer:K,outputBuffer:Q})=>{if(H!==null){const _e=h(X);for(let ge=0;ge<C;ge+=128){for(let de=0;de<v.numberOfInputs;de+=1)for(let ve=0;ve<v.channelCount;ve+=1)Jn(K,ee[de],ve,ve,ge);g.parameterDescriptors!==void 0&&g.parameterDescriptors.forEach(({name:de},ve)=>{Jn(K,B,de,w+ve,ge)});for(let de=0;de<v.numberOfInputs;de+=1)for(let ve=0;ve<b[de];ve+=1)se[de][ve].byteLength===0&&(se[de][ve]=new Float32Array(128));try{const de=ee.map((He,et)=>{if(_e[et].size>0)return N.set(et,C/128),He;const $=N.get(et);return $===void 0?[]:(He.every(Z=>Z.every(ie=>ie===0))&&($===1?N.delete(et):N.set(et,$-1)),He)});M=d(f.currentTime+ge/f.sampleRate,f.sampleRate,()=>H.process(de,se,B));for(let He=0,et=0;He<v.numberOfOutputs;He+=1){for(let q=0;q<b[He];q+=1)wo(Q,se[He],q,et+q,ge);et+=b[He]}}catch(de){M=!1,X.dispatchEvent(new ErrorEvent("processorerror",{colno:de.colno,filename:de.filename,lineno:de.lineno,message:de.message}))}if(!M){for(let de=0;de<v.numberOfInputs;de+=1){T[de].disconnect(k[de]);for(let ve=0;ve<v.channelCount;ve+=1)k[ge].disconnect(j,ve,de*v.channelCount+ve)}if(g.parameterDescriptors!==void 0){const de=g.parameterDescriptors.length;for(let ve=0;ve<de;ve+=1){const He=y[ve];He.disconnect(j,0,w+ve),He.stop()}}j.disconnect(O),O.onaudioprocess=null,G?D():Qe();break}}}};let G=!1;const ce=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),le=()=>O.connect(ce).connect(f.destination),Qe=()=>{O.disconnect(ce),ce.disconnect()},lt=()=>{if(M){Qe(),v.numberOfOutputs>0&&O.connect(P);for(let K=0,Q=0;K<v.numberOfOutputs;K+=1){const _e=U[K];for(let ge=0;ge<b[K];ge+=1)P.connect(_e,Q+ge,ge);Q+=b[K]}}G=!0},Pt=()=>{M&&(le(),D()),G=!1};return le(),m(X,lt,Pt)},ko=(s,e)=>{const t=s.createBiquadFilter();return Be(t,e),Ae(t,e,"Q"),Ae(t,e,"detune"),Ae(t,e,"frequency"),Ae(t,e,"gain"),Te(t,e,"type"),t},vm=(s,e)=>(t,n)=>{const i=t.createChannelMerger(n.numberOfInputs);return s!==null&&s.name==="webkitAudioContext"&&e(t,i),Be(i,n),i},ym=s=>{const e=s.numberOfOutputs;Object.defineProperty(s,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw $e()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw $e()}}),Object.defineProperty(s,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw $e()}})},gn=(s,e)=>{const t=s.createChannelSplitter(e.numberOfOutputs);return Be(t,e),ym(t),t},bm=(s,e,t,n,i)=>(a,o)=>{if(a.createConstantSource===void 0)return t(a,o);const l=a.createConstantSource();return Be(l,o),Ae(l,o,"offset"),e(n,()=>n(a))||gi(l),e(i,()=>i(a))||vi(l),s(a,l),l},zs=(s,e)=>(s.connect=e.connect.bind(e),s.disconnect=e.disconnect.bind(e),s),xm=(s,e,t,n)=>(i,{offset:a,...o})=>{const l=i.createBuffer(1,2,44100),c=e(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(i,{...o,gain:a}),d=l.getChannelData(0);d[0]=1,d[1]=1,c.buffer=l,c.loop=!0;const h={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(p){u.channelCount=p},get channelCountMode(){return u.channelCountMode},set channelCountMode(p){u.channelCountMode=p},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(p){u.channelInterpretation=p},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return c.onended},set onended(p){c.onended=p},addEventListener(...p){return c.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return c.dispatchEvent(p[0])},removeEventListener(...p){return c.removeEventListener(p[0],p[1],p[2])},start(p=0){c.start.call(c,p)},stop(p=0){c.stop.call(c,p)}},m=()=>c.connect(u),f=()=>c.disconnect(u);return s(i,c),n(zs(h,u),m,f)},_m=(s,e)=>(t,n)=>{const i=t.createConvolver();if(Be(i,n),n.disableNormalization===i.normalize&&(i.normalize=!n.disableNormalization),Te(i,n,"buffer"),n.channelCount>2||(e(i,"channelCount",a=>()=>a.call(i),a=>o=>{if(o>2)throw s();return a.call(i,o)}),n.channelCountMode==="max"))throw s();return e(i,"channelCountMode",a=>()=>a.call(i),a=>o=>{if(o==="max")throw s();return a.call(i,o)}),i},jo=(s,e)=>{const t=s.createDelay(e.maxDelayTime);return Be(t,e),Ae(t,e,"delayTime"),t},wm=s=>(e,t)=>{const n=e.createDynamicsCompressor();if(Be(n,t),t.channelCount>2||t.channelCountMode==="max")throw s();return Ae(n,t,"attack"),Ae(n,t,"knee"),Ae(n,t,"ratio"),Ae(n,t,"release"),Ae(n,t,"threshold"),n},ct=(s,e)=>{const t=s.createGain();return Be(t,e),Ae(t,e,"gain"),t},Nm=s=>(e,t,n)=>{if(e.createIIRFilter===void 0)return s(e,t,n);const i=e.createIIRFilter(n.feedforward,n.feedback);return Be(i,n),i};function Sm(s,e){const t=e[0]*e[0]+e[1]*e[1];return[(s[0]*e[0]+s[1]*e[1])/t,(s[1]*e[0]-s[0]*e[1])/t]}function km(s,e){return[s[0]*e[0]-s[1]*e[1],s[0]*e[1]+s[1]*e[0]]}function Ca(s,e){let t=[0,0];for(let n=s.length-1;n>=0;n-=1)t=km(t,e),t[0]+=s[n];return t}const jm=(s,e,t,n)=>(i,a,{channelCount:o,channelCountMode:l,channelInterpretation:c,feedback:u,feedforward:d})=>{const h=So(a,i.sampleRate),m=u instanceof Float64Array?u:new Float64Array(u),f=d instanceof Float64Array?d:new Float64Array(d),p=m.length,g=f.length,v=Math.min(p,g);if(p===0||p>20)throw n();if(m[0]===0)throw e();if(g===0||g>20)throw n();if(f[0]===0)throw e();if(m[0]!==1){for(let y=0;y<g;y+=1)f[y]/=m[0];for(let y=1;y<p;y+=1)m[y]/=m[0]}const b=t(i,h,o,o);b.channelCount=o,b.channelCountMode=l,b.channelInterpretation=c;const w=32,S=[],A=[],x=[];for(let y=0;y<o;y+=1){S.push(0);const j=new Float32Array(w),C=new Float32Array(w);j.fill(0),C.fill(0),A.push(j),x.push(C)}b.onaudioprocess=y=>{const j=y.inputBuffer,C=y.outputBuffer,O=j.numberOfChannels;for(let P=0;P<O;P+=1){const U=j.getChannelData(P),E=C.getChannelData(P);S[P]=No(m,p,f,g,v,A[P],x[P],S[P],w,U,E)}};const T=i.sampleRate/2;return zs({get bufferSize(){return h},get channelCount(){return b.channelCount},set channelCount(y){b.channelCount=y},get channelCountMode(){return b.channelCountMode},set channelCountMode(y){b.channelCountMode=y},get channelInterpretation(){return b.channelInterpretation},set channelInterpretation(y){b.channelInterpretation=y},get context(){return b.context},get inputs(){return[b]},get numberOfInputs(){return b.numberOfInputs},get numberOfOutputs(){return b.numberOfOutputs},addEventListener(...y){return b.addEventListener(y[0],y[1],y[2])},dispatchEvent(...y){return b.dispatchEvent(y[0])},getFrequencyResponse(y,j,C){if(y.length!==j.length||j.length!==C.length)throw s();const O=y.length;for(let P=0;P<O;P+=1){const U=-Math.PI*(y[P]/T),E=[Math.cos(U),Math.sin(U)],I=Ca(f,E),V=Ca(m,E),F=Sm(I,V);j[P]=Math.sqrt(F[0]*F[0]+F[1]*F[1]),C[P]=Math.atan2(F[1],F[0])}},removeEventListener(...y){return b.removeEventListener(y[0],y[1],y[2])}},b)},Tm=(s,e)=>s.createMediaElementSource(e.mediaElement),Cm=(s,e)=>{const t=s.createMediaStreamDestination();return Be(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},Im=(s,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((a,o)=>a.id<o.id?-1:a.id>o.id?1:0);const n=t.slice(0,1),i=s.createMediaStreamSource(new MediaStream(n));return Object.defineProperty(i,"mediaStream",{value:e}),i},Am=(s,e)=>(t,{mediaStreamTrack:n})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(n);const i=new MediaStream([n]),a=t.createMediaStreamSource(i);if(n.kind!=="audio")throw s();if(e(t))throw new TypeError;return a},Mm=s=>s===null?null:s.hasOwnProperty("OfflineAudioContext")?s.OfflineAudioContext:s.hasOwnProperty("webkitOfflineAudioContext")?s.webkitOfflineAudioContext:null,Em=(s,e,t,n,i,a)=>(o,l)=>{const c=o.createOscillator();return Be(c,l),Ae(c,l,"detune"),Ae(c,l,"frequency"),l.periodicWave!==void 0?c.setPeriodicWave(l.periodicWave):Te(c,l,"type"),e(t,()=>t(o))||gi(c),e(n,()=>n(o))||a(c,o),e(i,()=>i(o))||vi(c),s(o,c),c},Om=s=>(e,t)=>{const n=e.createPanner();return n.orientationX===void 0?s(e,t):(Be(n,t),Ae(n,t,"orientationX"),Ae(n,t,"orientationY"),Ae(n,t,"orientationZ"),Ae(n,t,"positionX"),Ae(n,t,"positionY"),Ae(n,t,"positionZ"),Te(n,t,"coneInnerAngle"),Te(n,t,"coneOuterAngle"),Te(n,t,"coneOuterGain"),Te(n,t,"distanceModel"),Te(n,t,"maxDistance"),Te(n,t,"panningModel"),Te(n,t,"refDistance"),Te(n,t,"rolloffFactor"),n)},Pm=(s,e,t,n,i,a,o,l,c,u)=>(d,{coneInnerAngle:h,coneOuterAngle:m,coneOuterGain:f,distanceModel:p,maxDistance:g,orientationX:v,orientationY:b,orientationZ:w,panningModel:S,positionX:A,positionY:x,positionZ:T,refDistance:k,rolloffFactor:y,...j})=>{const C=d.createPanner();if(j.channelCount>2||j.channelCountMode==="max")throw o();Be(C,j);const O={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},P=t(d,{...O,channelInterpretation:"speakers",numberOfInputs:6}),U=n(d,{...j,gain:1}),E=n(d,{...O,gain:1}),I=n(d,{...O,gain:0}),V=n(d,{...O,gain:0}),F=n(d,{...O,gain:0}),X=n(d,{...O,gain:0}),z=n(d,{...O,gain:0}),L=i(d,256,6,1),H=a(d,{...O,curve:new Float32Array([1,1]),oversample:"none"});let Y=[v,b,w],ee=[A,x,T];const se=new Float32Array(1);L.onaudioprocess=({inputBuffer:N})=>{const G=[c(N,se,0),c(N,se,1),c(N,se,2)];G.some((le,Qe)=>le!==Y[Qe])&&(C.setOrientation(...G),Y=G);const ce=[c(N,se,3),c(N,se,4),c(N,se,5)];ce.some((le,Qe)=>le!==ee[Qe])&&(C.setPosition(...ce),ee=ce)},Object.defineProperty(I.gain,"defaultValue",{get:()=>0}),Object.defineProperty(V.gain,"defaultValue",{get:()=>0}),Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(X.gain,"defaultValue",{get:()=>0}),Object.defineProperty(z.gain,"defaultValue",{get:()=>0});const B={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(N){if(N>2)throw o();U.channelCount=N,C.channelCount=N},get channelCountMode(){return C.channelCountMode},set channelCountMode(N){if(N==="max")throw o();U.channelCountMode=N,C.channelCountMode=N},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(N){U.channelInterpretation=N,C.channelInterpretation=N},get coneInnerAngle(){return C.coneInnerAngle},set coneInnerAngle(N){C.coneInnerAngle=N},get coneOuterAngle(){return C.coneOuterAngle},set coneOuterAngle(N){C.coneOuterAngle=N},get coneOuterGain(){return C.coneOuterGain},set coneOuterGain(N){if(N<0||N>1)throw e();C.coneOuterGain=N},get context(){return C.context},get distanceModel(){return C.distanceModel},set distanceModel(N){C.distanceModel=N},get inputs(){return[U]},get maxDistance(){return C.maxDistance},set maxDistance(N){if(N<0)throw new RangeError;C.maxDistance=N},get numberOfInputs(){return C.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get orientationX(){return E.gain},get orientationY(){return I.gain},get orientationZ(){return V.gain},get panningModel(){return C.panningModel},set panningModel(N){C.panningModel=N},get positionX(){return F.gain},get positionY(){return X.gain},get positionZ(){return z.gain},get refDistance(){return C.refDistance},set refDistance(N){if(N<0)throw new RangeError;C.refDistance=N},get rolloffFactor(){return C.rolloffFactor},set rolloffFactor(N){if(N<0)throw new RangeError;C.rolloffFactor=N},addEventListener(...N){return U.addEventListener(N[0],N[1],N[2])},dispatchEvent(...N){return U.dispatchEvent(N[0])},removeEventListener(...N){return U.removeEventListener(N[0],N[1],N[2])}};h!==B.coneInnerAngle&&(B.coneInnerAngle=h),m!==B.coneOuterAngle&&(B.coneOuterAngle=m),f!==B.coneOuterGain&&(B.coneOuterGain=f),p!==B.distanceModel&&(B.distanceModel=p),g!==B.maxDistance&&(B.maxDistance=g),v!==B.orientationX.value&&(B.orientationX.value=v),b!==B.orientationY.value&&(B.orientationY.value=b),w!==B.orientationZ.value&&(B.orientationZ.value=w),S!==B.panningModel&&(B.panningModel=S),A!==B.positionX.value&&(B.positionX.value=A),x!==B.positionY.value&&(B.positionY.value=x),T!==B.positionZ.value&&(B.positionZ.value=T),k!==B.refDistance&&(B.refDistance=k),y!==B.rolloffFactor&&(B.rolloffFactor=y),(Y[0]!==1||Y[1]!==0||Y[2]!==0)&&C.setOrientation(...Y),(ee[0]!==0||ee[1]!==0||ee[2]!==0)&&C.setPosition(...ee);const M=()=>{U.connect(C),s(U,H,0,0),H.connect(E).connect(P,0,0),H.connect(I).connect(P,0,1),H.connect(V).connect(P,0,2),H.connect(F).connect(P,0,3),H.connect(X).connect(P,0,4),H.connect(z).connect(P,0,5),P.connect(L).connect(d.destination)},D=()=>{U.disconnect(C),l(U,H,0,0),H.disconnect(E),E.disconnect(P),H.disconnect(I),I.disconnect(P),H.disconnect(V),V.disconnect(P),H.disconnect(F),F.disconnect(P),H.disconnect(X),X.disconnect(P),H.disconnect(z),z.disconnect(P),P.disconnect(L),L.disconnect(d.destination)};return u(zs(B,C),M,D)},Dm=s=>(e,{disableNormalization:t,imag:n,real:i})=>{const a=n instanceof Float32Array?n:new Float32Array(n),o=i instanceof Float32Array?i:new Float32Array(i),l=e.createPeriodicWave(o,a,{disableNormalization:t});if(Array.from(n).length<2)throw s();return l},vn=(s,e,t,n)=>s.createScriptProcessor(e,t,n),Rm=(s,e)=>(t,n)=>{const i=n.channelCountMode;if(i==="clamped-max")throw e();if(t.createStereoPanner===void 0)return s(t,n);const a=t.createStereoPanner();return Be(a,n),Ae(a,n,"pan"),Object.defineProperty(a,"channelCountMode",{get:()=>i,set:o=>{if(o!==i)throw e()}}),a},Fm=(s,e,t,n,i,a)=>{const l=new Float32Array([1,1]),c=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},d={...u,oversample:"none"},h=(p,g,v,b)=>{const w=new Float32Array(16385),S=new Float32Array(16385);for(let j=0;j<16385;j+=1){const C=j/16384*c;w[j]=Math.cos(C),S[j]=Math.sin(C)}const A=t(p,{...u,gain:0}),x=n(p,{...d,curve:w}),T=n(p,{...d,curve:l}),k=t(p,{...u,gain:0}),y=n(p,{...d,curve:S});return{connectGraph(){g.connect(A),g.connect(T.inputs===void 0?T:T.inputs[0]),g.connect(k),T.connect(v),v.connect(x.inputs===void 0?x:x.inputs[0]),v.connect(y.inputs===void 0?y:y.inputs[0]),x.connect(A.gain),y.connect(k.gain),A.connect(b,0,0),k.connect(b,0,1)},disconnectGraph(){g.disconnect(A),g.disconnect(T.inputs===void 0?T:T.inputs[0]),g.disconnect(k),T.disconnect(v),v.disconnect(x.inputs===void 0?x:x.inputs[0]),v.disconnect(y.inputs===void 0?y:y.inputs[0]),x.disconnect(A.gain),y.disconnect(k.gain),A.disconnect(b,0,0),k.disconnect(b,0,1)}}},m=(p,g,v,b)=>{const w=new Float32Array(16385),S=new Float32Array(16385),A=new Float32Array(16385),x=new Float32Array(16385),T=Math.floor(16385/2);for(let F=0;F<16385;F+=1)if(F>T){const X=(F-T)/(16384-T)*c;w[F]=Math.cos(X),S[F]=Math.sin(X),A[F]=0,x[F]=1}else{const X=F/(16384-T)*c;w[F]=1,S[F]=0,A[F]=Math.cos(X),x[F]=Math.sin(X)}const k=e(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),y=t(p,{...u,gain:0}),j=n(p,{...d,curve:w}),C=t(p,{...u,gain:0}),O=n(p,{...d,curve:S}),P=n(p,{...d,curve:l}),U=t(p,{...u,gain:0}),E=n(p,{...d,curve:A}),I=t(p,{...u,gain:0}),V=n(p,{...d,curve:x});return{connectGraph(){g.connect(k),g.connect(P.inputs===void 0?P:P.inputs[0]),k.connect(y,0),k.connect(C,0),k.connect(U,1),k.connect(I,1),P.connect(v),v.connect(j.inputs===void 0?j:j.inputs[0]),v.connect(O.inputs===void 0?O:O.inputs[0]),v.connect(E.inputs===void 0?E:E.inputs[0]),v.connect(V.inputs===void 0?V:V.inputs[0]),j.connect(y.gain),O.connect(C.gain),E.connect(U.gain),V.connect(I.gain),y.connect(b,0,0),U.connect(b,0,0),C.connect(b,0,1),I.connect(b,0,1)},disconnectGraph(){g.disconnect(k),g.disconnect(P.inputs===void 0?P:P.inputs[0]),k.disconnect(y,0),k.disconnect(C,0),k.disconnect(U,1),k.disconnect(I,1),P.disconnect(v),v.disconnect(j.inputs===void 0?j:j.inputs[0]),v.disconnect(O.inputs===void 0?O:O.inputs[0]),v.disconnect(E.inputs===void 0?E:E.inputs[0]),v.disconnect(V.inputs===void 0?V:V.inputs[0]),j.disconnect(y.gain),O.disconnect(C.gain),E.disconnect(U.gain),V.disconnect(I.gain),y.disconnect(b,0,0),U.disconnect(b,0,0),C.disconnect(b,0,1),I.disconnect(b,0,1)}}},f=(p,g,v,b,w)=>{if(g===1)return h(p,v,b,w);if(g===2)return m(p,v,b,w);throw i()};return(p,{channelCount:g,channelCountMode:v,pan:b,...w})=>{if(v==="max")throw i();const S=s(p,{...w,channelCount:1,channelCountMode:v,numberOfInputs:2}),A=t(p,{...w,channelCount:g,channelCountMode:v,gain:1}),x=t(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:b});let{connectGraph:T,disconnectGraph:k}=f(p,g,A,x,S);Object.defineProperty(x.gain,"defaultValue",{get:()=>0}),Object.defineProperty(x.gain,"maxValue",{get:()=>1}),Object.defineProperty(x.gain,"minValue",{get:()=>-1});const y={get bufferSize(){},get channelCount(){return A.channelCount},set channelCount(P){A.channelCount!==P&&(j&&k(),{connectGraph:T,disconnectGraph:k}=f(p,P,A,x,S),j&&T()),A.channelCount=P},get channelCountMode(){return A.channelCountMode},set channelCountMode(P){if(P==="clamped-max"||P==="max")throw i();A.channelCountMode=P},get channelInterpretation(){return A.channelInterpretation},set channelInterpretation(P){A.channelInterpretation=P},get context(){return A.context},get inputs(){return[A]},get numberOfInputs(){return A.numberOfInputs},get numberOfOutputs(){return A.numberOfOutputs},get pan(){return x.gain},addEventListener(...P){return A.addEventListener(P[0],P[1],P[2])},dispatchEvent(...P){return A.dispatchEvent(P[0])},removeEventListener(...P){return A.removeEventListener(P[0],P[1],P[2])}};let j=!1;const C=()=>{T(),j=!0},O=()=>{k(),j=!1};return a(zs(y,S),C,O)}},Lm=(s,e,t,n,i,a,o)=>(l,c)=>{const u=l.createWaveShaper();if(a!==null&&a.name==="webkitAudioContext"&&l.createGain().gain.automationRate===void 0)return t(l,c);Be(u,c);const d=c.curve===null||c.curve instanceof Float32Array?c.curve:new Float32Array(c.curve);if(d!==null&&d.length<2)throw e();Te(u,{curve:d},"curve"),Te(u,c,"oversample");let h=null,m=!1;return o(u,"curve",g=>()=>g.call(u),g=>v=>(g.call(u,v),m&&(n(v)&&h===null?h=s(l,u):!n(v)&&h!==null&&(h(),h=null)),v)),i(u,()=>{m=!0,n(u.curve)&&(h=s(l,u))},()=>{m=!1,h!==null&&(h(),h=null)})},Vm=(s,e,t,n,i)=>(a,{curve:o,oversample:l,...c})=>{const u=a.createWaveShaper(),d=a.createWaveShaper();Be(u,c),Be(d,c);const h=t(a,{...c,gain:1}),m=t(a,{...c,gain:-1}),f=t(a,{...c,gain:1}),p=t(a,{...c,gain:-1});let g=null,v=!1,b=null;const w={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(x){h.channelCount=x,m.channelCount=x,u.channelCount=x,f.channelCount=x,d.channelCount=x,p.channelCount=x},get channelCountMode(){return u.channelCountMode},set channelCountMode(x){h.channelCountMode=x,m.channelCountMode=x,u.channelCountMode=x,f.channelCountMode=x,d.channelCountMode=x,p.channelCountMode=x},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(x){h.channelInterpretation=x,m.channelInterpretation=x,u.channelInterpretation=x,f.channelInterpretation=x,d.channelInterpretation=x,p.channelInterpretation=x},get context(){return u.context},get curve(){return b},set curve(x){if(x!==null&&x.length<2)throw e();if(x===null)u.curve=x,d.curve=x;else{const T=x.length,k=new Float32Array(T+2-T%2),y=new Float32Array(T+2-T%2);k[0]=x[0],y[0]=-x[T-1];const j=Math.ceil((T+1)/2),C=(T+1)/2-1;for(let O=1;O<j;O+=1){const P=O/j*C,U=Math.floor(P),E=Math.ceil(P);k[O]=U===E?x[U]:(1-(P-U))*x[U]+(1-(E-P))*x[E],y[O]=U===E?-x[T-1-U]:-((1-(P-U))*x[T-1-U])-(1-(E-P))*x[T-1-E]}k[j]=T%2===1?x[j-1]:(x[j-2]+x[j-1])/2,u.curve=k,d.curve=y}b=x,v&&(n(b)&&g===null?g=s(a,h):g!==null&&(g(),g=null))},get inputs(){return[h]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(x){u.oversample=x,d.oversample=x},addEventListener(...x){return h.addEventListener(x[0],x[1],x[2])},dispatchEvent(...x){return h.dispatchEvent(x[0])},removeEventListener(...x){return h.removeEventListener(x[0],x[1],x[2])}};o!==null&&(w.curve=o instanceof Float32Array?o:new Float32Array(o)),l!==w.oversample&&(w.oversample=l);const S=()=>{h.connect(u).connect(f),h.connect(m).connect(d).connect(p).connect(f),v=!0,n(b)&&(g=s(a,h))},A=()=>{h.disconnect(u),u.disconnect(f),h.disconnect(m),m.disconnect(d),d.disconnect(p),p.disconnect(f),v=!1,g!==null&&(g(),g=null)};return i(zs(w,f),S,A)},nt=()=>new DOMException("","NotSupportedError"),Um={numberOfChannels:1},Bm=(s,e,t,n,i)=>class extends s{constructor(o,l,c){let u;if(typeof o=="number"&&l!==void 0&&c!==void 0)u={length:l,numberOfChannels:o,sampleRate:c};else if(typeof o=="object")u=o;else throw new Error("The given parameters are not valid.");const{length:d,numberOfChannels:h,sampleRate:m}={...Um,...u},f=n(h,d,m);e(nn,()=>nn(f))||f.addEventListener("statechange",(()=>{let p=0;const g=v=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",g),v.stopImmediatePropagation(),this._waitForThePromiseToSettle(v)):p+=1)};return g})()),super(f,h),this._length=d,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,vo(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},qm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Wm=(s,e,t,n,i,a,o)=>class extends s{constructor(c,u){const d=i(c),h={...qm,...u},m=t(d,h),f=a(d),p=f?n():null,g=c.sampleRate/2;super(c,!1,m,p),this._detune=e(this,f,m.detune,153600,-153600),this._frequency=e(this,f,m.frequency,g,-g),this._nativeOscillatorNode=m,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&h.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=h.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(c){const u=typeof c=="function"?o(this,c):null;this._nativeOscillatorNode.onended=u;const d=this._nativeOscillatorNode.onended;this._onended=d!==null&&d===u?c:d}get type(){return this._nativeOscillatorNode.type}set type(c){this._nativeOscillatorNode.type=c,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(c){this._nativeOscillatorNode.setPeriodicWave(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=c)}start(c=0){if(this._nativeOscillatorNode.start(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=c),this.context.state!=="closed"){Rs(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),Ft(this)&&mn(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(c=0){this._nativeOscillatorNode.stop(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=c)}},Gm=(s,e,t,n,i)=>()=>{const a=new WeakMap;let o=null,l=null,c=null;const u=async(d,h)=>{let m=t(d);const f=Ze(m,h);if(!f){const p={channelCount:m.channelCount,channelCountMode:m.channelCountMode,channelInterpretation:m.channelInterpretation,detune:m.detune.value,frequency:m.frequency.value,periodicWave:o===null?void 0:o,type:m.type};m=e(h,p),l!==null&&m.start(l),c!==null&&m.stop(c)}return a.set(h,m),f?(await s(h,d.detune,m.detune),await s(h,d.frequency,m.frequency)):(await n(h,d.detune,m.detune),await n(h,d.frequency,m.frequency)),await i(d,h,m),m};return{set periodicWave(d){o=d},set start(d){l=d},set stop(d){c=d},render(d,h){const m=a.get(h);return m!==void 0?Promise.resolve(m):u(d,h)}}},$m={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},zm=(s,e,t,n,i,a,o)=>class extends s{constructor(c,u){const d=i(c),h={...$m,...u},m=t(d,h),f=a(d),p=f?n():null;super(c,!1,m,p),this._nativePannerNode=m,this._orientationX=e(this,f,m.orientationX,tt,at),this._orientationY=e(this,f,m.orientationY,tt,at),this._orientationZ=e(this,f,m.orientationZ,tt,at),this._positionX=e(this,f,m.positionX,tt,at),this._positionY=e(this,f,m.positionY,tt,at),this._positionZ=e(this,f,m.positionZ,tt,at),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(c){this._nativePannerNode.coneInnerAngle=c}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(c){this._nativePannerNode.coneOuterAngle=c}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(c){this._nativePannerNode.coneOuterGain=c}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(c){this._nativePannerNode.distanceModel=c}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(c){this._nativePannerNode.maxDistance=c}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(c){this._nativePannerNode.panningModel=c}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(c){this._nativePannerNode.refDistance=c}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(c){this._nativePannerNode.rolloffFactor=c}},Ym=(s,e,t,n,i,a,o,l,c,u)=>()=>{const d=new WeakMap;let h=null;const m=async(f,p)=>{let g=null,v=a(f);const b={channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation},w={...b,coneInnerAngle:v.coneInnerAngle,coneOuterAngle:v.coneOuterAngle,coneOuterGain:v.coneOuterGain,distanceModel:v.distanceModel,maxDistance:v.maxDistance,panningModel:v.panningModel,refDistance:v.refDistance,rolloffFactor:v.rolloffFactor},S=Ze(v,p);if("bufferSize"in v)g=n(p,{...b,gain:1});else if(!S){const A={...w,orientationX:v.orientationX.value,orientationY:v.orientationY.value,orientationZ:v.orientationZ.value,positionX:v.positionX.value,positionY:v.positionY.value,positionZ:v.positionZ.value};v=i(p,A)}if(d.set(p,g===null?v:g),g!==null){if(h===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const O=new o(6,f.context.length,p.sampleRate),P=e(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});P.connect(O.destination),h=(async()=>{const U=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(E,I)=>{const V=t(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:I===0?1:0});return await l(O,E,V.offset),V}));for(let E=0;E<6;E+=1)U[E].connect(P,0,E),U[E].start(0);return u(O)})()}const A=await h,x=n(p,{...b,gain:1});await c(f,p,x);const T=[];for(let O=0;O<A.numberOfChannels;O+=1)T.push(A.getChannelData(O));let k=[T[0][0],T[1][0],T[2][0]],y=[T[3][0],T[4][0],T[5][0]],j=n(p,{...b,gain:1}),C=i(p,{...w,orientationX:k[0],orientationY:k[1],orientationZ:k[2],positionX:y[0],positionY:y[1],positionZ:y[2]});x.connect(j).connect(C.inputs[0]),C.connect(g);for(let O=128;O<A.length;O+=128){const P=[T[0][O],T[1][O],T[2][O]],U=[T[3][O],T[4][O],T[5][O]];if(P.some((E,I)=>E!==k[I])||U.some((E,I)=>E!==y[I])){k=P,y=U;const E=O/p.sampleRate;j.gain.setValueAtTime(0,E),j=n(p,{...b,gain:0}),C=i(p,{...w,orientationX:k[0],orientationY:k[1],orientationZ:k[2],positionX:y[0],positionY:y[1],positionZ:y[2]}),j.gain.setValueAtTime(1,E),x.connect(j).connect(C.inputs[0]),C.connect(g)}}return g}return S?(await s(p,f.orientationX,v.orientationX),await s(p,f.orientationY,v.orientationY),await s(p,f.orientationZ,v.orientationZ),await s(p,f.positionX,v.positionX),await s(p,f.positionY,v.positionY),await s(p,f.positionZ,v.positionZ)):(await l(p,f.orientationX,v.orientationX),await l(p,f.orientationY,v.orientationY),await l(p,f.orientationZ,v.orientationZ),await l(p,f.positionX,v.positionX),await l(p,f.positionY,v.positionY),await l(p,f.positionZ,v.positionZ)),$s(v)?await c(f,p,v.inputs[0]):await c(f,p,v),v};return{render(f,p){const g=d.get(p);return g!==void 0?Promise.resolve(g):m(f,p)}}},Hm={disableNormalization:!1},Xm=(s,e,t,n)=>class To{constructor(a,o){const l=e(a),c=n({...Hm,...o}),u=s(l,c);return t.add(u),u}static[Symbol.hasInstance](a){return a!==null&&typeof a=="object"&&Object.getPrototypeOf(a)===To.prototype||t.has(a)}},Jm=(s,e)=>(t,n,i)=>(s(n).replay(i),e(n,t,i)),Km=(s,e,t)=>async(n,i,a)=>{const o=s(n);await Promise.all(o.activeInputs.map((l,c)=>Array.from(l).map(async([u,d])=>{const m=await e(u).render(u,i),f=n.context.destination;!t(u)&&(n!==f||!t(n))&&m.connect(a,d,c)})).reduce((l,c)=>[...l,...c],[]))},Zm=(s,e,t)=>async(n,i,a)=>{const o=e(n);await Promise.all(Array.from(o.activeInputs).map(async([l,c])=>{const d=await s(l).render(l,i);t(l)||d.connect(a,c)}))},Qm=(s,e,t,n)=>i=>s(nn,()=>nn(i))?Promise.resolve(s(n,n)).then(a=>{if(!a){const o=t(i,512,0,1);i.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>i.currentTime,o.connect(i.destination)}return i.startRendering()}):new Promise(a=>{const o=e(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=l=>{o.disconnect(),a(l.renderedBuffer)},o.connect(i.destination),i.startRendering()}),ep=s=>(e,t)=>{s.set(e,t)},tp=s=>(e,t)=>s.set(e,t),sp=(s,e,t,n,i,a,o,l)=>(c,u)=>t(c).render(c,u).then(()=>Promise.all(Array.from(n(u)).map(d=>t(d).render(d,u)))).then(()=>i(u)).then(d=>(typeof d.copyFromChannel!="function"?(o(d),mi(d)):e(a,()=>a(d))||l(d),s.add(d),d)),np={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},rp=(s,e,t,n,i,a)=>class extends s{constructor(l,c){const u=i(l),d={...np,...c},h=t(u,d),m=a(u),f=m?n():null;super(l,!1,h,f),this._pan=e(this,m,h.pan)}get pan(){return this._pan}},ip=(s,e,t,n,i)=>()=>{const a=new WeakMap,o=async(l,c)=>{let u=t(l);const d=Ze(u,c);if(!d){const h={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(c,h)}return a.set(c,u),d?await s(c,l.pan,u.pan):await n(c,l.pan,u.pan),$s(u)?await i(l,c,u.inputs[0]):await i(l,c,u),u};return{render(l,c){const u=a.get(c);return u!==void 0?Promise.resolve(u):o(l,c)}}},ap=s=>()=>{if(s===null)return!1;try{new s({length:1,sampleRate:44100})}catch{return!1}return!0},op=(s,e)=>async()=>{if(s===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),n=new e(1,128,44100),i=URL.createObjectURL(t);let a=!1,o=!1;try{await n.audioWorklet.addModule(i);const l=new s(n,"a",{numberOfOutputs:0}),c=n.createOscillator();l.port.onmessage=()=>a=!0,l.onprocessorerror=()=>o=!0,c.connect(l),c.start(0),await n.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(i)}return a&&!o},cp=(s,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),n=s(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{t.oncomplete=()=>{n.disconnect(),i(t.currentTime!==0)},t.startRendering()})},lp=()=>new DOMException("","UnknownError"),up={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},dp=(s,e,t,n,i,a,o)=>class extends s{constructor(c,u){const d=i(c),h={...up,...u},m=t(d,h),p=a(d)?n():null;super(c,!0,m,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=m,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(c){if(c===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(c.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=c}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(c){this._nativeWaveShaperNode.oversample=c}},hp=(s,e,t)=>()=>{const n=new WeakMap,i=async(a,o)=>{let l=e(a);if(!Ze(l,o)){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,curve:l.curve,oversample:l.oversample};l=s(o,u)}return n.set(o,l),$s(l)?await t(a,o,l.inputs[0]):await t(a,o,l),l};return{render(a,o){const l=n.get(o);return l!==void 0?Promise.resolve(l):i(a,o)}}},mp=()=>typeof window>"u"?null:window,pp=(s,e)=>t=>{t.copyFromChannel=(n,i,a=0)=>{const o=s(a),l=s(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=n.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)n[h]=u[h+o]},t.copyToChannel=(n,i,a=0)=>{const o=s(a),l=s(i);if(l>=t.numberOfChannels)throw e();const c=t.length,u=t.getChannelData(l),d=n.length;for(let h=o<0?-o:0;h+o<c&&h<d;h+=1)u[h+o]=n[h]}},fp=s=>e=>{e.copyFromChannel=(t=>(n,i,a=0)=>{const o=s(a),l=s(i);if(o<e.length)return t.call(e,n,l,o)})(e.copyFromChannel),e.copyToChannel=(t=>(n,i,a=0)=>{const o=s(a),l=s(i);if(o<e.length)return t.call(e,n,l,o)})(e.copyToChannel)},gp=s=>(e,t)=>{const n=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=n),s(e,"buffer",i=>()=>{const a=i.call(e);return a===n?null:a},i=>a=>i.call(e,a===null?n:a))},vp=(s,e)=>(t,n)=>{n.channelCount=1,n.channelCountMode="explicit",Object.defineProperty(n,"channelCount",{get:()=>1,set:()=>{throw s()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:()=>{throw s()}});const i=t.createBufferSource();e(n,()=>{const l=n.numberOfInputs;for(let c=0;c<l;c+=1)i.connect(n,0,c)},()=>i.disconnect(n))},Co=(s,e,t)=>s.copyFromChannel===void 0?s.getChannelData(t)[0]:(s.copyFromChannel(e,t),e[0]),Io=s=>{if(s===null)return!1;const e=s.length;return e%2!==0?s[Math.floor(e/2)]!==0:s[e/2-1]+s[e/2]!==0},yn=(s,e,t,n)=>{let i=s;for(;!i.hasOwnProperty(e);)i=Object.getPrototypeOf(i);const{get:a,set:o}=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(s,e,{get:t(a),set:n(o)})},yp=s=>({...s,outputChannelCount:s.outputChannelCount!==void 0?s.outputChannelCount:s.numberOfInputs===1&&s.numberOfOutputs===1?[s.channelCount]:Array.from({length:s.numberOfOutputs},()=>1)}),bp=s=>({...s,channelCount:s.numberOfOutputs}),xp=s=>{const{imag:e,real:t}=s;return e===void 0?t===void 0?{...s,imag:[0,0],real:[0,0]}:{...s,imag:Array.from(t,()=>0),real:t}:t===void 0?{...s,imag:e,real:Array.from(e,()=>0)}:{...s,imag:e,real:t}},Ao=(s,e,t)=>{try{s.setValueAtTime(e,t)}catch(n){if(n.code!==9)throw n;Ao(s,e,t+1e-7)}},_p=s=>{const e=s.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},wp=s=>{const e=s.createBufferSource(),t=s.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},Np=s=>{const e=s.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},yi=s=>{const e=s.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},Mo=s=>{const e=s.createBuffer(1,1,44100),t=s.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},bi=s=>{const e=s.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},Sp=s=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(s)}finally{e.close(),t.close()}},kp=s=>{s.start=(e=>(t=0,n=0,i)=>{const a=s.buffer,o=a===null?n:Math.min(a.duration,n);a!==null&&o>a.duration-.5/s.context.sampleRate?e.call(s,t,0,0):e.call(s,t,o,i)})(s.start)},Eo=(s,e)=>{const t=e.createGain();s.connect(t);const n=(i=>()=>{i.call(s,t),s.removeEventListener("ended",n)})(s.disconnect);s.addEventListener("ended",n),zs(s,t),s.stop=(i=>{let a=!1;return(o=0)=>{if(a)try{i.call(s,o)}catch{t.gain.setValueAtTime(0,o)}else i.call(s,o),a=!0}})(s.stop)},Ys=(s,e)=>t=>{const n={value:s};return Object.defineProperties(t,{currentTarget:n,target:n}),typeof e=="function"?e.call(s,t):e.handleEvent.call(s,t)},jp=zu(gs),Tp=Zu(gs),Cp=uh(ir),Oo=new WeakMap,Ip=Ch(Oo),Nt=Ud(new Map,new WeakMap),It=mp(),Po=rm(Nt,Mt),xi=Th(st),Ye=Km(st,xi,us),Ap=nd(Po,Se,Ye),Ne=Mh(rr),Bt=Mm(It),be=Hh(Bt),Do=new WeakMap,Ro=xh(Ys),bn=cm(It),_i=Gh(bn),wi=$h(It),Fo=zh(It),rn=um(It),Oe=Cd(Yu(lo),Ku(jp,Tp,Yn,Cp,Hn,st,Ip,hn,Se,gs,Ft,us,Fn),Nt,Vh(Kr,Hn,st,Se,sn,Ft),Mt,ar,nt,ah(Yn,Kr,st,Se,sn,Ne,Ft,be),mh(Do,st,wt),Ro,Ne,_i,wi,Fo,be,rn),Mp=sd(Oe,Ap,Mt,Po,Ne,be),Ni=new WeakSet,Ia=im(It),Lo=Qd(new Uint32Array(1)),Si=pp(Lo,Mt),ki=fp(Lo),Vo=id(Ni,Nt,nt,Ia,Bt,ap(Ia),Si,ki),or=Qu(ct),Uo=Zm(xi,pn,us),Et=Yd(Uo),Hs=om(or,Nt,_p,wp,Np,yi,Mo,bi,kp,gp(yn),Eo),Ot=Jm(Ih(pn),Uo),Ep=cd(Et,Hs,Se,Ot,Ye),St=Id(Hu(uo),Do,hi,Ad,Uu,Bu,qu,Wu,Gu,Hr,oo,bn,Ao),Op=od(Oe,Ep,St,$e,Hs,Ne,be,Ys),Pp=vd(Oe,yd,Mt,$e,lm(ct,yn),Ne,be,Ye),Dp=Vd(Et,ko,Se,Ot,Ye),vs=tp(Oo),Rp=Ld(Oe,St,Dp,ar,ko,Ne,be,vs),ns=sm(gs,wi),Fp=vp($e,ns),rs=vm(bn,Fp),Lp=Wd(rs,Se,Ye),Vp=qd(Oe,Lp,rs,Ne,be),Up=zd(gn,Se,Ye),Bp=$d(Oe,Up,gn,Ne,be,bp),qp=xm(or,Hs,ct,ns),Xs=bm(or,Nt,qp,yi,bi),Wp=Zd(Et,Xs,Se,Ot,Ye),Gp=Kd(Oe,St,Wp,Xs,Ne,be,Ys),Bo=_m(nt,yn),$p=sh(Bo,Se,Ye),zp=th(Oe,$p,Bo,Ne,be,vs),Yp=lh(Et,jo,Se,Ot,Ye),Hp=ch(Oe,St,Yp,jo,Ne,be,vs),qo=wm(nt),Xp=vh(Et,qo,Se,Ot,Ye),Jp=gh(Oe,St,Xp,qo,nt,Ne,be,vs),Kp=kh(Et,ct,Se,Ot,Ye),Zp=Sh(Oe,St,Kp,ct,Ne,be),Qp=jm(ar,$e,vn,nt),cr=Qm(Nt,ct,vn,cp(ct,Bt)),ef=Lh(Hs,Se,Bt,Ye,cr),tf=Nm(Qp),sf=Rh(Oe,tf,ef,Ne,be,vs),nf=bd(St,rs,Xs,vn,nt,Co,be,yn),Wo=new WeakMap,rf=tm(Pp,nf,Ro,be,Wo,Ys),Go=Em(or,Nt,yi,Mo,bi,Eo),af=Gm(Et,Go,Se,Ot,Ye),of=Wm(Oe,St,Go,af,Ne,be,Ys),$o=Xd(Hs),cf=Vm($o,$e,ct,Io,ns),lr=Lm($o,$e,cf,Io,ns,bn,yn),lf=Pm(Yn,$e,rs,ct,vn,lr,nt,Hn,Co,ns),zo=Om(lf),uf=Ym(Et,rs,Xs,ct,zo,Se,Bt,Ot,Ye,cr),df=zm(Oe,St,zo,uf,Ne,be,vs),hf=Dm(Mt),mf=Xm(hf,Ne,new WeakSet,xp),pf=Fm(rs,gn,ct,lr,nt,ns),Yo=Rm(pf,nt),ff=ip(Et,Yo,Se,Ot,Ye),gf=rp(Oe,St,Yo,ff,Ne,be),vf=hp(lr,Se,Ye),yf=dp(Oe,$e,lr,vf,Ne,be,vs),Ho=Xh(It),ji=_h(It),Xo=new WeakMap,bf=Eh(Xo,Bt),xf=Ho?Ju(Nt,nt,bh(It),ji,wh($u),Ne,bf,be,rn,new WeakMap,new WeakMap,op(rn,Bt),It):void 0,_f=Yh(_i,be),wf=ih(Ni,Nt,rh,yh,new WeakSet,Ne,_f,$n,nn,Si,ki),Jo=Rd(xf,Mp,Vo,Op,Rp,Vp,Bp,Gp,zp,wf,Hp,Jp,Zp,sf,rf,of,df,mf,gf,yf),Nf=Jh(Oe,Tm,Ne,be),Sf=Zh(Oe,Cm,Ne,be),kf=Qh(Oe,Im,Ne,be),jf=Am($e,be),Tf=em(Oe,jf,Ne),Cf=gd(Jo,$e,nt,lp,Nf,Sf,kf,Tf,bn),Ti=Oh(Wo),If=ed(Ti),Ko=Hd(Mt),Af=dh(Ti),Zo=ph(Mt),Qo=new WeakMap,Mf=jh(Qo,wt),Ef=gm(Ko,Mt,$e,rs,gn,Xs,ct,vn,nt,Zo,ji,Mf,ns),Of=hm($e,Ef,ct,nt,ns),Pf=Dd(Et,Ko,Hs,rs,gn,Xs,ct,Af,Zo,ji,Se,rn,Bt,Ot,Ye,cr),Df=Ah(Xo),Rf=ep(Qo),Aa=Ho?Ed(If,Oe,St,Pf,Of,st,Df,Ne,be,rn,yp,Rf,Sp,Ys):void 0,Ff=nh(nt,Bt),Lf=sp(Ni,Nt,xi,Ti,cr,$n,Si,ki),Vf=Bm(Jo,Nt,$e,Ff,Lf),Uf=Uh(rr,_i),Bf=Bh(di,wi),qf=qh(hi,Fo),Wf=Wh(rr,be);function ft(s){return s===void 0}function ue(s){return s!==void 0}function Gf(s){return typeof s=="function"}function At(s){return typeof s=="number"}function Xt(s){return Object.prototype.toString.call(s)==="[object Object]"&&s.constructor===Object}function ec(s){return typeof s=="boolean"}function ot(s){return Array.isArray(s)}function Vt(s){return typeof s=="string"}function In(s){return Vt(s)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(s)}function ne(s,e){if(!s)throw new Error(e)}function Zt(s,e,t=1/0){if(!(e<=s&&s<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${s}`)}function tc(s){!s.isOffline&&s.state!=="running"&&ur('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let sc=!1,Ma=!1;function Ea(s){sc=s}function $f(s){ft(s)&&sc&&!Ma&&(Ma=!0,ur("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let nc=console;function zf(...s){nc.log(...s)}function ur(...s){nc.warn(...s)}function Yf(s){return new Cf(s)}function Hf(s,e,t){return new Vf(s,e,t)}const ht=typeof self=="object"?self:null,Xf=ht&&(ht.hasOwnProperty("AudioContext")||ht.hasOwnProperty("webkitAudioContext"));function Jf(s,e,t){return ne(ue(Aa),"AudioWorkletNode only works in a secure context (https or localhost)"),new(s instanceof ht?.BaseAudioContext?ht?.AudioWorkletNode:Aa)(s,e,t)}function kt(s,e,t,n){var i=arguments.length,a=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(s,e,t,n);else for(var l=s.length-1;l>=0;l--)(o=s[l])&&(a=(i<3?o(a):i>3?o(e,t,a):o(e,t))||a);return i>3&&a&&Object.defineProperty(e,t,a),a}function Re(s,e,t,n){function i(a){return a instanceof t?a:new t(function(o){o(a)})}return new(t||(t=Promise))(function(a,o){function l(d){try{u(n.next(d))}catch(h){o(h)}}function c(d){try{u(n.throw(d))}catch(h){o(h)}}function u(d){d.done?a(d.value):i(d.value).then(l,c)}u((n=n.apply(s,e||[])).next())})}class Kf{constructor(e,t,n,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=n,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),n=new Worker(t);n.onmessage=this._callback.bind(this),this._worker=n}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function ds(s){return qf(s)}function Jt(s){return Bf(s)}function Ln(s){return Wf(s)}function js(s){return Uf(s)}function Zf(s){return s instanceof Vo}function Qf(s,e){return s==="value"||ds(e)||Jt(e)||Zf(e)}function cs(s,...e){if(!e.length)return s;const t=e.shift();if(Xt(s)&&Xt(t))for(const n in t)Qf(n,t[n])?s[n]=t[n]:Xt(t[n])?(s[n]||Object.assign(s,{[n]:{}}),cs(s[n],t[n])):Object.assign(s,{[n]:t[n]});return cs(s,...e)}function eg(s,e){return s.length===e.length&&s.every((t,n)=>e[n]===t)}function re(s,e,t=[],n){const i={},a=Array.from(e);if(Xt(a[0])&&n&&!Reflect.has(a[0],n)&&(Object.keys(a[0]).some(l=>Reflect.has(s,l))||(cs(i,{[n]:a[0]}),t.splice(t.indexOf(n),1),a.shift())),a.length===1&&Xt(a[0]))cs(i,a[0]);else for(let o=0;o<t.length;o++)ue(a[o])&&(i[t[o]]=a[o]);return cs(s,i)}function tg(s){return s.constructor.getDefaults()}function Ct(s,e){return ft(s)?e:s}function si(s,e){return e.forEach(t=>{Reflect.has(s,t)&&delete s[t]}),s}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class qt{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||ht&&this.toString()===ht.TONE_DEBUG_CLASS)&&zf(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}qt.version=ao;const Ci=1e-6;function Fs(s,e){return s>e+Ci}function ni(s,e){return Fs(s,e)||bt(s,e)}function Zn(s,e){return s+Ci<e}function bt(s,e){return Math.abs(s-e)<Ci}function sg(s,e,t){return Math.max(Math.min(s,t),e)}class vt extends qt{constructor(){super(),this.name="Timeline",this._timeline=[];const e=re(vt.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(ne(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];ne(ni(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const n=this._search(e,t);return n!==-1?this._timeline[n]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const n=this._search(e,t);return n+1<this._timeline.length?this._timeline[n+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const n=this._search(e);return n-1>=0?this._timeline[n-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(bt(this._timeline[t].time,e)){for(let n=t;n>=0&&bt(this._timeline[n].time,e);n--)t=n;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&ni(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let n=0;const i=this._timeline.length;let a=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;n<a;){let o=Math.floor(n+(a-n)/2);const l=this._timeline[o],c=this._timeline[o+1];if(bt(l[t],e)){for(let u=o;u<this._timeline.length;u++){const d=this._timeline[u];if(bt(d[t],e))o=u;else break}return o}else{if(Zn(l[t],e)&&Fs(c[t],e))return o;Fs(l[t],e)?a=o:n=o+1}}return-1}_iterate(e,t=0,n=this._timeline.length-1){this._timeline.slice(t,n+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const n=this._search(e);return n!==-1&&this._iterate(t,0,n),this}forEachAfter(e,t){const n=this._search(e);return this._iterate(t,n+1),this}forEachBetween(e,t,n){let i=this._search(e),a=this._search(t);return i!==-1&&a!==-1?(this._timeline[i].time!==e&&(i+=1),this._timeline[a].time===t&&(a-=1),this._iterate(n,i,a)):i===-1&&this._iterate(n,0,a),this}forEachFrom(e,t){let n=this._search(e);for(;n>=0&&this._timeline[n].time>=e;)n--;return this._iterate(t,n+1),this}forEachAtTime(e,t){const n=this._search(e);if(n!==-1&&bt(this._timeline[n].time,e)){let i=n;for(let a=n;a>=0&&bt(this._timeline[a].time,e);a--)i=a;this._iterate(a=>{t(a)},i,n)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const rc=[];function dr(s){rc.push(s)}function ng(s){rc.forEach(e=>e(s))}const ic=[];function hr(s){ic.push(s)}function rg(s){ic.forEach(e=>e(s))}class xn extends qt{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(i=>{ft(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(t)}),this}once(e,t){const n=(...i)=>{t(...i),this.off(e,n)};return this.on(e,n),this}off(e,t){return e.split(/\W+/).forEach(i=>{if(ft(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(ft(t))this._events[i]=[];else{const a=this._events[i];for(let o=a.length-1;o>=0;o--)a[o]===t&&a.splice(o,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const n=this._events[e].slice(0);for(let i=0,a=n.length;i<a;i++)n[i].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const n=Object.getOwnPropertyDescriptor(xn.prototype,t);Object.defineProperty(e.prototype,t,n)})}dispose(){return super.dispose(),this._events=void 0,this}}class ac extends xn{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class _n extends ac{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new vt,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const n=re(_n.getDefaults(),arguments,["context"]);n.context?(this._context=n.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=Yf({latencyHint:n.latencyHint}),this._latencyHint=n.latencyHint),this._ticker=new Kf(this.emit.bind(this,"tick"),n.clockSource,n.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=n.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(ng(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,n){return this._context.createBuffer(e,t,n)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,n){return this._context.createPeriodicWave(e,t,n)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return ne(js(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return ne(js(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return ne(js(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){ne(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){ne(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){ne(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){ne(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Jf(this.rawContext,e,t)}addAudioWorkletModule(e){return Re(this,void 0,void 0,function*(){ne(ue(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return Re(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return js(this._context)?this._context.resume():Promise.resolve()}close(){return Re(this,void 0,void 0,function*(){js(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&rg(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),n=t.getChannelData(0);for(let a=0;a<n.length;a++)n[a]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const n=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:n+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const n=++this._timeoutIds,i=()=>{const a=this.now();this._timeouts.add({callback:()=>{e(),i()},id:n,time:a+t})};return i(),n}}class ig extends ac{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,n){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,n){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return Re(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function Me(s,e){ot(e)?e.forEach(t=>Me(s,t)):Object.defineProperty(s,e,{enumerable:!0,writable:!1})}function oc(s,e){ot(e)?e.forEach(t=>oc(s,t)):Object.defineProperty(s,e,{writable:!0})}const fe=()=>{};class je extends qt{constructor(){super(),this.name="ToneAudioBuffer",this.onload=fe;const e=re(je.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,Vt(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:fe,onload:fe,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:mt().sampleRate}set(e){return e instanceof je?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return Re(this,void 0,void 0,function*(){const t=je.load(e).then(n=>{this.set(n),this.onload(this)});je.downloads.push(t);try{yield t}finally{const n=je.downloads.indexOf(t);je.downloads.splice(n,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=ot(e)&&e[0].length>0,n=t?e.length:1,i=t?e[0].length:e.length,a=mt(),o=a.createBuffer(n,i,a.sampleRate),l=!t&&n===1?[e]:e;for(let c=0;c<n;c++)o.copyToChannel(l[c],c);return this._buffer=o,this}toMono(e){if(At(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const n=this.numberOfChannels;for(let i=0;i<n;i++){const a=this.toArray(i);for(let o=0;o<a.length;o++)t[o]+=a[o]}t=t.map(i=>i/n),this.fromArray(t)}return this}toArray(e){if(At(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let n=0;n<this.numberOfChannels;n++)t[n]=this.getChannelData(n);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){ne(this.loaded,"Buffer is not loaded");const n=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);ne(n<i,"The start time must be less than the end time");const a=i-n,o=mt().createBuffer(this.numberOfChannels,a,this.sampleRate);for(let l=0;l<this.numberOfChannels;l++)o.copyToChannel(this.getChannelData(l).subarray(n,i),l);return new je(o)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new je().fromArray(e)}static fromUrl(e){return Re(this,void 0,void 0,function*(){return yield new je().load(e)})}static load(e){return Re(this,void 0,void 0,function*(){const t=je.baseUrl===""||je.baseUrl.endsWith("/")?je.baseUrl:je.baseUrl+"/",n=yield fetch(t+e);if(!n.ok)throw new Error(`could not load url: ${e}`);const i=yield n.arrayBuffer();return yield mt().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),n=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+n)!==""}static loaded(){return Re(this,void 0,void 0,function*(){for(yield Promise.resolve();je.downloads.length;)yield je.downloads[0]})}}je.baseUrl="";je.downloads=[];class Ii extends _n{constructor(){super({clockSource:"offline",context:Ln(arguments[0])?arguments[0]:Hf(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:Ln(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Ln(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return Re(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const n=Math.floor(this.sampleRate/128);e&&t%n===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return Re(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new je(t)})}close(){return Promise.resolve()}}const cc=new ig;let as=cc;function mt(){return as===cc&&Xf&&ag(new _n),as}function ag(s,e=!1){e&&as.dispose(),js(s)?as=new _n(s):Ln(s)?as=new Ii(s):as=s}function lc(){return as.resume()}if(ht&&!ht.TONE_SILENCE_LOGGING){const e=` * Tone.js v${ao} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function og(s){return Math.pow(10,s/20)}function cg(s){return 20*(Math.log(s)/Math.LN10)}function uc(s){return Math.pow(2,s/12)}let mr=440;function lg(){return mr}function ug(s){mr=s}function os(s){return Math.round(dc(s))}function dc(s){return 69+12*Math.log2(s/mr)}function hc(s){return mr*Math.pow(2,(s-69)/12)}class Ai extends qt{constructor(e,t,n){super(),this.defaultUnits="s",this._val=t,this._units=n,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const n=parseInt(e,10),i=t==="."?1.5:1;return n===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/n)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,n)=>{let i=0;return e&&e!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i+=this._beatsToUnits(parseFloat(t))),n&&n!=="0"&&(i+=this._beatsToUnits(parseFloat(n)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Ai&&this.fromType(this._val),ft(this._val))return this._noArg();if(Vt(this._val)&&ft(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(Xt(this._val)){let e=0;for(const t in this._val)if(ue(this._val[t])){const n=this._val[t],i=new this.constructor(this.context,t).valueOf()*n;e+=i}return e}if(ue(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return Vt(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class xt extends Ai{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new xt(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const n=new this.constructor(this.context,e).valueOf(),i=this.valueOf(),l=Math.round(i/n)*n-i;return i+l*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let a=1;a<9;a++){const o=Math.pow(2,a);t.push(o+"n."),t.push(o+"n"),t.push(o+"t")}t.push("0");let n=t[0],i=new xt(this.context,t[0]).toSeconds();return t.forEach(a=>{const o=new xt(this.context,a).toSeconds();Math.abs(o-e)<Math.abs(i-e)&&(n=a,i=o)}),n}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const n=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const a=i.toString();return a.length>3&&(i=parseFloat(parseFloat(a).toFixed(3))),[n,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return os(this.toFrequency())}_now(){return this.context.now()}}class pt extends xt{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return lg()}static set A4(e){ug(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:pt.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const i=dg[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?i:pt.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,n){let i=1;return e&&e!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i*=this._beatsToUnits(parseFloat(t))),n&&n!=="0"&&(i*=this._beatsToUnits(parseFloat(n)/4)),i}}})}transpose(e){return new pt(this.context,this.valueOf()*uc(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return os(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/pt.A4);let n=Math.round(12*t)+57;const i=Math.floor(n/12);return i<0&&(n+=-12*i),hg[n%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return hc(e)}static ftom(e){return os(e)}}const dg={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},hg=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class Ps extends xt{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Je extends qt{constructor(){super();const e=re(Je.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:mt()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return $f(e),new xt(this.context,e).toSeconds()}toFrequency(e){return new pt(this.context,e).toFrequency()}toTicks(e){return new Ps(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(n=>{ft(e[n])&&delete t[n]}),t}get(){const e=tg(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const n=this[t];ue(n)&&ue(n.value)&&ue(n.setValueAtTime)?e[t]=n.value:n instanceof Je?e[t]=n._getPartialProperties(e[t]):ot(n)||At(n)||Vt(n)||ec(n)?e[t]=n:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&ue(this[t])&&(this[t]&&ue(this[t].value)&&ue(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Je?this[t].set(e[t]):this[t]=e[t])}),this}}class wn extends vt{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,n){return Zt(t,0),this.add(Object.assign({},n,{state:e,time:t})),this}getLastState(e,t){const n=this._search(t);for(let i=n;i>=0;i--){const a=this._timeline[i];if(a.state===e)return a}}getNextState(e,t){const n=this._search(t);if(n!==-1)for(let i=n;i<this._timeline.length;i++){const a=this._timeline[i];if(a.state===e)return a}}}class Ce extends Je{constructor(){const e=re(Ce.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,ne(ue(e.param)&&(ds(e.param)||e.param instanceof Ce),"param must be an AudioParam");!ds(e.param);)e.param=e.param._param;this._swappable=ue(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new vt(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,ue(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Je.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return ue(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return ue(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return ue(this.maxValue)&&ue(this.minValue)&&Zt(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?og(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?cg(e):e}setValueAtTime(e,t){const n=this.toSeconds(t),i=this._fromType(e);return ne(isFinite(i)&&isFinite(n),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,n),this._events.add({time:n,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,n),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),n=this._events.getAfter(t),i=this._events.get(t);let a=this._initialValue;if(i===null)a=this._initialValue;else if(i.type==="setTargetAtTime"&&(n===null||n.type==="setValueAtTime")){const o=this._events.getBefore(i.time);let l;o===null?l=this._initialValue:l=o.value,i.type==="setTargetAtTime"&&(a=this._exponentialApproach(i.time,l,i.value,i.constant,t))}else if(n===null)a=i.value;else if(n.type==="linearRampToValueAtTime"||n.type==="exponentialRampToValueAtTime"){let o=i.value;if(i.type==="setTargetAtTime"){const l=this._events.getBefore(i.time);l===null?o=this._initialValue:o=l.value}n.type==="linearRampToValueAtTime"?a=this._linearInterpolate(i.time,o,n.time,n.value,t):a=this._exponentialInterpolate(i.time,o,n.time,n.value,t)}else a=i.value;return this._toType(a)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const n=this._fromType(e),i=this.toSeconds(t);return ne(isFinite(n)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(n),this._events.add({time:i,type:"linearRampToValueAtTime",value:n}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(n,i),this}exponentialRampToValueAtTime(e,t){let n=this._fromType(e);n=bt(n,0)?this._minOutput:n,this._assertRange(n);const i=this.toSeconds(t);return ne(isFinite(n)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:n}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(n,i),this}exponentialRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialRampToValueAtTime(e,n+this.toSeconds(t)),this}linearRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.linearRampToValueAtTime(e,n+this.toSeconds(t)),this}targetRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialApproachValueAtTime(e,n,t),this}exponentialApproachValueAtTime(e,t,n){t=this.toSeconds(t),n=this.toSeconds(n);const i=Math.log(n+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+n*.9),this.linearRampToValueAtTime(e,t+n),this}setTargetAtTime(e,t,n){const i=this._fromType(e);ne(isFinite(n)&&n>0,"timeConstant must be a number greater than 0");const a=this.toSeconds(t);return this._assertRange(i),ne(isFinite(i)&&isFinite(a),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:n,time:a,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,a,n),this._param.setTargetAtTime(i,a,n),this}setValueCurveAtTime(e,t,n,i=1){n=this.toSeconds(n),t=this.toSeconds(t);const a=this._fromType(e[0])*i;this.setValueAtTime(this._toType(a),t);const o=n/(e.length-1);for(let l=1;l<e.length;l++){const c=this._fromType(e[l])*i;this.linearRampToValueAtTime(this._toType(c),t+l*o)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return ne(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),n=this._fromType(this.getValueAtTime(t));ne(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+n);const i=this._events.get(t),a=this._events.getAfter(t);return i&&bt(i.time,t)?a?(this._param.cancelScheduledValues(a.time),this._events.cancel(a.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):a&&(this._param.cancelScheduledValues(a.time),this._events.cancel(a.time),a.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(n),t):a.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(n),t)),this._events.add({time:t,type:"setValueAtTime",value:n}),this._param.setValueAtTime(n,t),this}rampTo(e,t=.1,n){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,n):this.linearRampTo(e,t,n),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const n=this._events.get(t);if(n&&n.type==="setTargetAtTime"){const i=this._events.getAfter(n.time),a=i?i.time:t+2,o=(a-t)/10;for(let l=t;l<a;l+=o)e.linearRampToValueAtTime(this.getValueAtTime(l),l)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?e.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?e.setTargetAtTime(i.value,i.time,i.constant):e[i.type](i.value,i.time)}),this}setParam(e){ne(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,n,i,a){return n+(t-n)*Math.exp(-(a-e)/i)}_linearInterpolate(e,t,n,i,a){return t+(i-t)*((a-e)/(n-e))}_exponentialInterpolate(e,t,n,i,a){return t*Math.pow(i/t,(a-e)/(n-e))}}class he extends Je{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return ue(this.input)?ds(this.input)||this.input instanceof Ce?1:this.input.numberOfInputs:0}get numberOfOutputs(){return ue(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return ue(e)&&(e instanceof he||Jt(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(n=>{n.channelCount=e.channelCount,n.channelCountMode=e.channelCountMode,n.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();ne(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,n=0){return Js(this,e,t,n),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return ur("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,n=0){return mg(this,e,t,n),this}chain(...e){return ri(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),ue(this.input)&&(this.input instanceof he?this.input.dispose():Jt(this.input)&&this.input.disconnect()),ue(this.output)&&(this.output instanceof he?this.output.dispose():Jt(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function ri(...s){const e=s.shift();s.reduce((t,n)=>(t instanceof he?t.connect(n):Jt(t)&&Js(t,n),n),e)}function Js(s,e,t=0,n=0){for(ne(ue(s),"Cannot connect from undefined node"),ne(ue(e),"Cannot connect to undefined node"),(e instanceof he||Jt(e))&&ne(e.numberOfInputs>0,"Cannot connect to node with no inputs"),ne(s.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof he||e instanceof Ce;)ue(e.input)&&(e=e.input);for(;s instanceof he;)ue(s.output)&&(s=s.output);ds(e)?s.connect(e,t):s.connect(e,t,n)}function mg(s,e,t=0,n=0){if(ue(e))for(;e instanceof he;)e=e.input;for(;!Jt(s);)ue(s.output)&&(s=s.output);ds(e)?s.disconnect(e,t):Jt(e)?s.disconnect(e,t,n):s.disconnect()}class Ke extends he{constructor(){const e=re(Ke.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Ce({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),Me(this,"gain")}static getDefaults(){return Object.assign(he.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Ls extends he{constructor(e){super(e),this.onended=fe,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Ke({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const n=this.toSeconds(t);return this._startTime!==-1&&n>=this._startTime&&(this._stopTime===-1||n<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(he.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:fe})}_startGain(e,t=1){ne(this._startTime===-1,"Source cannot be started more than once");const n=this.toSeconds(this._fadeIn);return this._startTime=e+n,this._startTime=Math.max(this._startTime,this.context.currentTime),n>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+n):this._gainNode.gain.exponentialApproachValueAtTime(t,e,n)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){ne(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const n=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+n),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==fe&&(this.onended(this),this.onended=fe,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),ne(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=fe,this}}class Mi extends Ls{constructor(){const e=re(Mi.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Js(this._source,this._gainNode),this.offset=new Ce({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(Ls.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class ze extends he{constructor(){const e=re(ze.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Mi({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(he.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,n=0){return Ei(this,e,t,n),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,n){return this._param.exponentialRampTo(e,t,n),this}linearRampTo(e,t,n){return this._param.linearRampTo(e,t,n),this}targetRampTo(e,t,n){return this._param.targetRampTo(e,t,n),this}exponentialApproachValueAtTime(e,t,n){return this._param.exponentialApproachValueAtTime(e,t,n),this}setTargetAtTime(e,t,n){return this._param.setTargetAtTime(e,t,n),this}setValueCurveAtTime(e,t,n,i){return this._param.setValueCurveAtTime(e,t,n,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,n){return this._param.rampTo(e,t,n),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Ei(s,e,t,n){(e instanceof Ce||ds(e)||e instanceof ze&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof ze&&(e.overridden=!0)),Js(s,e,t,n)}class Oi extends Ce{constructor(){const e=re(Oi.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new vt(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Ce.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,n){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),a=this._events.get(t),o=Math.round(Math.max(1/n,1));for(let l=0;l<=o;l++){const c=n*l+t,u=this._exponentialApproach(a.time,a.value,i,n,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}setValueAtTime(e,t){const n=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(n),a=this._events.previousEvent(i),o=this._getTicksUntilEvent(a,n);return i.ticks=Math.max(o,0),this}linearRampToValueAtTime(e,t){const n=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(n),a=this._events.previousEvent(i),o=this._getTicksUntilEvent(a,n);return i.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const n=this._fromType(e),i=this._events.get(t),a=Math.round(Math.max((t-i.time)*10,1)),o=(t-i.time)/a;for(let l=0;l<=a;l++){const c=o*l+i.time,u=this._exponentialInterpolate(i.time,i.value,t,n,c);this.linearRampToValueAtTime(this._toType(u),c)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(ft(e.ticks)){const o=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(o,e.time)}const n=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const a=this._events.get(t);return a&&a.time===t&&a.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(n+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),n=this._events.get(t);return Math.max(this._getTicksUntilEvent(n,t),0)}getDurationOfTicks(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-n}getTimeOfTick(e){const t=this._events.get(e,"ticks"),n=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&n&&n.type==="linearRampToValueAtTime"&&t.value!==n.value){const i=this._fromType(this.getValueAtTime(t.time)),o=(this._fromType(this.getValueAtTime(n.time))-i)/(n.time-t.time),l=Math.sqrt(Math.pow(i,2)-2*o*(t.ticks-e)),c=(-i+l)/o,u=(-i-l)/o;return(c>0?c:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const n=this.toSeconds(t),i=this.toSeconds(e),a=this.getTicksAtTime(n);return this.getTicksAtTime(n+i)-a}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class Pi extends ze{constructor(){const e=re(Pi.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Oi({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(ze.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class Di extends Je{constructor(){const e=re(Di.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new wn,this._tickOffset=new vt,this._ticksAtTime=new vt,this._secondsAtTime=new vt,this.frequency=new Pi({context:this.context,units:e.units,value:e.frequency}),Me(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Je.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const n=this.toSeconds(e);return this._state.getValueAtTime(n)!=="started"&&(this._state.setStateAtTime("started",n),ue(t)&&this.setTicksAtTime(t,n),this._ticksAtTime.cancel(n),this._secondsAtTime.cancel(n)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const n=this._state.get(t);n&&n.time>0&&(this._tickOffset.cancel(n.time),this._state.cancel(n.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),n=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),a={state:"paused",time:t};this._state.add(a);let o=i||n,l=i?i.ticks:0,c=null;return this._state.forEachBetween(o.time,t+this.sampleTime,u=>{let d=o.time;const h=this._tickOffset.get(u.time);h&&h.time>=o.time&&(l=h.ticks,d=h.time),o.state==="started"&&u.state!=="started"&&(l+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(d),u.time!==a.time&&(c={state:u.state,time:u.time,ticks:l})),o=u}),this._state.remove(a),c&&this._ticksAtTime.add(c),l}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),n=this.frequency.timeToTicks(e,t);this.setTicksAtTime(n,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),n={state:"paused",time:e};this._state.add(n);const i=this._secondsAtTime.get(e);let a=i||t,o=i?i.seconds:0,l=null;return this._state.forEachBetween(a.time,e+this.sampleTime,c=>{let u=a.time;const d=this._tickOffset.get(c.time);d&&d.time>=a.time&&(o=d.seconds,u=d.time),a.state==="started"&&c.state!=="started"&&(o+=c.time-u,c.time!==n.time&&(l={state:c.state,time:c.time,seconds:o})),a=c}),this._state.remove(n),l&&this._secondsAtTime.add(l),o}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const n=this._tickOffset.get(t),i=this._state.get(t),a=Math.max(n.time,i.time),o=this.frequency.getTicksAtTime(a)+e-n.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(e,t,n){let i=this._state.get(e);this._state.forEachBetween(e,t,o=>{i&&i.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(i.time,e),o.time-this.sampleTime,n),i=o});let a=null;if(i&&i.state==="started"){const o=Math.max(i.time,e),l=this.frequency.getTicksAtTime(o),c=this.frequency.getTicksAtTime(i.time),u=l-c;let d=Math.ceil(u)-u;d=bt(d,1)?0:d;let h=this.frequency.getTimeOfTick(l+d);for(;h<t;){try{n(h,Math.round(this.getTicksAtTime(h)))}catch(m){a=m;break}h+=this.frequency.getDurationOfTicks(1,h)}}if(a)throw a;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class pr extends Je{constructor(){const e=re(pr.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=fe,this._lastUpdate=0,this._state=new wn("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new Di({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Me(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Je.getDefaults(),{callback:fe,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){tc(this.context);const n=this.toSeconds(e);return this.log("start",n),this._state.getValueAtTime(n)!=="started"&&(this._state.setStateAtTime("started",n),this._tickSource.start(n,t),n<this._lastUpdate&&this.emit("start",n,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(n);return this._tickSource.getTimeOfTick(i+e,n)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,n=>{switch(n.state){case"started":const i=this._tickSource.getTicksAtTime(n.time);this.emit("start",n.time,i);break;case"stopped":n.time!==0&&this.emit("stop",n.time);break;case"paused":this.emit("pause",n.time);break}}),this._tickSource.forEachTickBetween(e,t,(n,i)=>{this.callback(n,i)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}xn.mixin(pr);class Ks extends he{constructor(){const e=re(Ks.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new Ke({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,Me(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(he.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Ri extends he{constructor(){const e=re(Ri.getDefaults(),arguments);super(e),this.name="Destination",this.input=new Ks({context:this.context}),this.output=new Ke({context:this.context}),this.volume=this.input.volume,ri(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(he.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),ri(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}dr(s=>{s.destination=new Ri({context:s})});hr(s=>{s.destination.dispose()});class pg extends he{constructor(){super(...arguments),this.name="Listener",this.positionX=new Ce({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Ce({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Ce({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Ce({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Ce({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Ce({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Ce({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Ce({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Ce({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(he.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}dr(s=>{s.listener=new pg({context:s})});hr(s=>{s.listener.dispose()});class Fi extends qt{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=re(Fi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const n=e.urls[t];this.add(t,n,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:fe,onload:fe,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return ne(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,n=fe,i=fe){return Vt(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new je(this.baseUrl+t,n,i))):this._buffers.set(e.toString(),new je(t,n,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class Qn extends pt{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return os(super._frequencyToUnits(e))}_ticksToUnits(e){return os(super._ticksToUnits(e))}_beatsToUnits(e){return os(super._beatsToUnits(e))}_secondsToUnits(e){return os(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return hc(this.toMidi())}transpose(e){return new Qn(this.context,this.toMidi()+e)}}class Ue extends Ps{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class fg extends Je{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new vt,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}dr(s=>{s.draw=new fg({context:s})});hr(s=>{s.draw.dispose()});class gg extends qt{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){ne(ue(e.time),"Events must have a time property"),ne(ue(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new vg(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const n of t)if(n.event===e){this._removeNode(n),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let n,i=null;if(t>0)if(e.left.right===null)n=e.left,n.right=e.right,i=n;else{for(n=e.left.right;n.right!==null;)n=n.right;n.parent&&(n.parent.right=n.left,i=n.parent,n.left=e.left,n.right=e.right)}else if(e.right.left===null)n=e.right,n.left=e.left,i=n;else{for(n=e.right.left;n.left!==null;)n=n.left;n.parent&&(n.parent.left=n.right,i=n.parent,n.left=e.left,n.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=n:e.parent.right=n:this._setRoot(n),i&&this._rebalance(i)}e.dispose()}_rotateLeft(e){const t=e.parent,n=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),t!==null?n?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,n=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),t!==null?n?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let n=t[0];for(let i=1;i<t.length;i++)t[i].low>n.low&&(n=t[i]);return n.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(n=>t.push(n)),t.forEach(n=>{n.event&&e(n.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const n=[];this._root.search(e,n),n.forEach(i=>{i.event&&t(i.event)})}return this}forEachFrom(e,t){if(this._root!==null){const n=[];this._root.searchAfter(e,n),n.forEach(i=>{i.event&&t(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class vg{constructor(e,t,n){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=n,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class yg extends qt{constructor(e){super(),this.name="TimelineValue",this._timeline=new vt({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class Vs extends he{constructor(){super(re(Vs.getDefaults(),arguments,["context"]))}connect(e,t=0,n=0){return Ei(this,e,t,n),this}}class Nn extends Vs{constructor(){const e=re(Nn.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,ot(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):Gf(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(ze.getDefaults(),{length:1024})}setMap(e,t=1024){const n=new Float32Array(t);for(let i=0,a=t;i<a;i++){const o=i/(a-1)*2-1;n[i]=e(o,i)}return this.curve=n,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(n=>n.includes(e));ne(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Li extends Vs{constructor(){const e=re(Li.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new Nn({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(Vs.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class Qt{constructor(e,t){this.id=Qt._eventId++,this._remainderTime=0;const n=Object.assign(Qt.getDefaults(),t);this.transport=e,this.callback=n.callback,this._once=n.once,this.time=Math.floor(n.time),this._remainderTime=n.time-this.time}static getDefaults(){return{callback:fe,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}Qt._eventId=0;class Vi extends Qt{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const n=Object.assign(Vi.getDefaults(),t);this.duration=n.duration,this._interval=n.interval,this._nextTick=n.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},Qt.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return Zn(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ue(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){Zn(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ue(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);Fs(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class fr extends Je{constructor(){const e=re(fr.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new yg(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new vt,this._repeatedEvents=new gg,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new pr({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),Me(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Je.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const n=t%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(n*Math.PI)*this._swingAmount;e+=new Ue(this.context,this._swingTicks*2/3).toSeconds()*i}Ea(!0),this._timeline.forEachAtTime(t,n=>n.invoke(e)),Ea(!1)}schedule(e,t){const n=new Qt(this,{callback:e,time:new Ps(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}scheduleRepeat(e,t,n,i=1/0){const a=new Vi(this,{callback:e,duration:new xt(this.context,i).toTicks(),interval:new xt(this.context,t).toTicks(),time:new Ps(this.context,n).toTicks()});return this._addEvent(a,this._repeatedEvents)}scheduleOnce(e,t){const n=new Qt(this,{callback:e,once:!0,time:new Ps(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,n=>this.clear(n.id)),this._repeatedEvents.forEachFrom(t,n=>this.clear(n.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new Ue(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let n;return ue(t)&&(n=this.toTicks(t)),this._clock.start(e,n),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){ot(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new xt(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new xt(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new Ue(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new Ue(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),n=this._clock.frequency.timeToTicks(e,t);this.ticks=n}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const n=this._clock.getTicksAtTime(t),i=this._clock.frequency.getDurationOfTicks(Math.ceil(n)-n,t),a=t+i;this.emit("stop",a),this._clock.setTicksAtTime(e,a),this.emit("start",a,this._clock.getSecondsAtTime(a))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),n=this.getTicksAtTime(t),i=e-n%e;return this._clock.nextTickTime(i,t)}}syncSignal(e,t){const n=this.now();let i=this.bpm,a=1/(60/i.getValueAtTime(n)/this.PPQ),o=[];if(e.units==="time"){const c=.015625/a,u=new Ke(c),d=new Li(-1),h=new Ke(c);i.chain(u,d,h),i=h,a=1/a,o=[u,d,h]}t||(e.getValueAtTime(n)!==0?t=e.getValueAtTime(n)/a:t=0);const l=new Ke(t);return i.connect(l),l.connect(e._param),o.push(l),this._syncedSignals.push({initial:e.value,nodes:o,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const n=this._syncedSignals[t];n.signal===e&&(n.nodes.forEach(i=>i.dispose()),n.signal.value=n.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),oc(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}xn.mixin(fr);dr(s=>{s.transport=new fr({context:s})});hr(s=>{s.transport.dispose()});class gt extends he{constructor(e){super(e),this.input=void 0,this._state=new wn("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=fe,this._syncedStop=fe,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Ks({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,Me(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(he.getDefaults(),{mute:!1,onstop:fe,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,n){let i=ft(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")ne(Fs(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,n);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const a=this._state.get(i);a&&(a.offset=this.toSeconds(Ct(t,0)),a.duration=n?this.toSeconds(n):void 0);const o=this.context.transport.schedule(l=>{this._start(l,t,n)},i);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else tc(this.context),this._start(i,t,n);return this}stop(e){let t=ft(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||ue(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const n=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(n)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,n){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,n)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(Fs(t,0)){const n=this._state.get(t);if(n&&n.state==="started"&&n.time!==t){const i=t-this.toSeconds(n.time);let a;n.duration&&(a=this.toSeconds(n.duration)-i),this._start(e,this.toSeconds(n.offset)+i,a)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=fe,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class gr extends Ls{constructor(){const e=re(gr.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Js(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Ce({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new je(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Ls.getDefaults(),{url:new je,loop:!1,loopEnd:0,loopStart:0,onload:fe,onerror:fe,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,n,i=1){ne(this.buffer.loaded,"buffer is either not set or not loaded");const a=this.toSeconds(e);this._startGain(a,i),this.loop?t=Ct(t,this.loopStart):t=Ct(t,0);let o=Math.max(this.toSeconds(t),0);if(this.loop){const l=this.toSeconds(this.loopEnd)||this.buffer.duration,c=this.toSeconds(this.loopStart),u=l-c;ni(o,l)&&(o=(o-c)%u+c),bt(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Zn(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(a,o)),ue(n)){let l=this.toSeconds(n);l=Math.max(l,0),this.stop(a+l)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function ys(s,e){return Re(this,void 0,void 0,function*(){const t=e/s.context.sampleRate,n=new Ii(1,t,s.context.sampleRate);return new s.constructor(Object.assign(s.get(),{frequency:2/t,detune:0,context:n})).toDestination().start(0),(yield n.render()).getChannelData(0)})}class Ui extends Ls{constructor(){const e=re(Ui.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Js(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new Ce({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new Ce({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),Me(this,["frequency","detune"])}static getDefaults(){return Object.assign(Ls.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class De extends gt{constructor(){const e=re(De.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new ze({context:this.context,units:"frequency",value:e.frequency}),Me(this,"frequency"),this.detune=new ze({context:this.context,units:"cents",value:e.detune}),Me(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),n=new Ui({context:this.context,onended:()=>this.onstop(this)});this._oscillator=n,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return De._periodicWaveCache.find(t=>t.phase===this._phase&&eg(t.partials,this._partials));{const e=De._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const n=this._getCachedPeriodicWave();if(ue(n)){const{partials:i,wave:a}=n;this._wave=a,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,a]=this._getRealImaginary(e,this._phase),o=this.context.createPeriodicWave(i,a);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),De._periodicWaveCache.push({imag:a,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),De._periodicWaveCache.length>100&&De._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Zt(e,0);let t=this._type;const n=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(n&&(t=n[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const i=new Float32Array(e);this._partials.forEach((a,o)=>i[o]=a),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(e,t){let i=2048;const a=new Float32Array(i),o=new Float32Array(i);let l=1;if(e==="custom"){if(l=this._partials.length+1,this._partialCount=this._partials.length,i=l,this._partials.length===0)return[a,o]}else{const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);c?(l=parseInt(c[2],10)+1,this._partialCount=parseInt(c[2],10),e=c[1],l=Math.max(l,2),i=l):this._partialCount=0,this._partials=[]}for(let c=1;c<i;++c){const u=2/(c*Math.PI);let d;switch(e){case"sine":d=c<=l?1:0,this._partials[c-1]=d;break;case"square":d=c&1?2*u:0,this._partials[c-1]=d;break;case"sawtooth":d=u*(c&1?1:-1),this._partials[c-1]=d;break;case"triangle":c&1?d=2*(u*u)*(c-1>>1&1?-1:1):d=0,this._partials[c-1]=d;break;case"custom":d=this._partials[c-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}d!==0?(a[c]=-d*Math.sin(t*c),o[c]=d*Math.cos(t*c)):(a[c]=0,o[c]=0)}return[a,o]}_inverseFFT(e,t,n){let i=0;const a=e.length;for(let o=0;o<a;o++)i+=e[o]*Math.cos(o*n)+t[o]*Math.sin(o*n);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let n=0;const i=Math.PI*2,a=32;for(let o=0;o<a;o++)n=Math.max(this._inverseFFT(e,t,o/a*i),n);return sg(-this._inverseFFT(e,t,this._phase)/n,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}De._periodicWaveCache=[];class bg extends Vs{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Nn({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Us extends ze{constructor(){const e=re(Us.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Ke({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(ze.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class vr extends gt{constructor(){const e=re(vr.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new bg({context:this.context}),this._modulationNode=new Ke({context:this.context}),this._carrier=new De({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new De({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Us({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Me(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(De.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class yr extends gt{constructor(){const e=re(yr.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new Ke({context:this.context,gain:0}),this._carrier=new De({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new ze({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new De({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Us({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new Us({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Me(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(De.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Sn extends gt{constructor(){const e=re(Sn.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new Ke({context:this.context,gain:0}),this._thresh=new Nn({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new ze({context:this.context,units:"audioRange",value:e.width}),this._triangle=new De({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Me(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class br extends gt{constructor(){const e=re(br.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new ze({context:this.context,units:"frequency",value:e.frequency}),this.detune=new ze({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,Me(this,["frequency","detune"])}static getDefaults(){return Object.assign(De.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,n=e/(this._oscillators.length-1);this._forEach((i,a)=>i.detune.value=t+n*a)}}get count(){return this._oscillators.length}set count(e){if(Zt(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const n=new De({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):fe});this.type==="custom"&&(n.partials=this._partials),this.frequency.connect(n.frequency),this.detune.connect(n.detune),n.detune.overridden=!1,n.connect(this.output),this._oscillators[t]=n}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,n)=>t.phase=this._phase+n/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class xr extends gt{constructor(){const e=re(xr.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Us({context:this.context,value:2}),this._pulse=new Sn({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new De({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Me(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(gt.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Oa={am:vr,fat:br,fm:yr,oscillator:De,pulse:Sn,pwm:xr};class er extends gt{constructor(){const e=re(er.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new ze({context:this.context,units:"frequency",value:e.frequency}),this.detune=new ze({context:this.context,units:"cents",value:e.detune}),Me(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(De.getDefaults(),yr.getDefaults(),vr.getDefaults(),br.getDefaults(),Sn.getDefaults(),xr.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=Oa[e],n=this.now();if(this._oscillator){const i=this._oscillator;i.stop(n),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(n)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof Oa[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&At(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&At(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Vt(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return Re(this,arguments,void 0,function*(e=1024){return ys(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function mc(s,e=1/0){const t=new WeakMap;return function(n,i){Reflect.defineProperty(n,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(a){Zt(a,s,e),t.set(this,a)}})}}function Wt(s,e=1/0){const t=new WeakMap;return function(n,i){Reflect.defineProperty(n,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(a){Zt(this.toSeconds(a),s,e),t.set(this,a)}})}}class _r extends gt{constructor(){const e=re(_r.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new je({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(gt.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:fe,onerror:fe,playbackRate:1,reverse:!1})}load(e){return Re(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=fe){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,n){return super.start(e,t,n),this}_start(e,t,n){this._loop?t=Ct(t,this._loopStart):t=Ct(t,0);const i=this.toSeconds(t),a=n;n=Ct(n,Math.max(this._buffer.duration-i,0));let o=this.toSeconds(n);o=o/this._playbackRate,e=this.toSeconds(e);const l=new gr({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+o),this._state.setStateAtTime("stopped",e+o,{implicitEnd:!0})),this._activeSources.add(l),this._loop&&ft(a)?l.start(e,i):l.start(e,i,o-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(n=>n.stop(t))}restart(e,t,n){return super.restart(e,t,n),this}_restart(e,t,n){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(e),this._start(e,t,n)}seek(e,t){const n=this.toSeconds(t);if(this._state.getValueAtTime(n)==="started"){const i=this.toSeconds(e);this._stop(n),this._start(n,i)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Zt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Zt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),n=this._state.getNextState("stopped",t);n&&n.implicitEnd&&(this._state.cancel(n.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}kt([Wt(0)],_r.prototype,"fadeIn",void 0);kt([Wt(0)],_r.prototype,"fadeOut",void 0);class is extends he{constructor(){const e=re(is.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new ze({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(he.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(Vt(e))return e;{let n;for(n in An)if(An[n][t]===e)return n;return e}}_setCurve(e,t,n){if(Vt(n)&&Reflect.has(An,n)){const i=An[n];Xt(i)?e!=="_decayCurve"&&(this[e]=i[t]):this[e]=i}else if(ot(n)&&e!=="_decayCurve")this[e]=n;else throw new Error("Envelope: invalid curve: "+n)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let i=this.toSeconds(this.attack);const a=this.toSeconds(this.decay),o=this.getValueAtTime(e);if(o>0){const l=1/i;i=(1-o)/l}if(i<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,i,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,i,e);else{this._sig.cancelAndHoldAtTime(e);let l=this._attackCurve;for(let c=1;c<l.length;c++)if(l[c-1]<=o&&o<=l[c]){l=this._attackCurve.slice(c),l[0]=o;break}this._sig.setValueCurveAtTime(l,e,i,t)}if(a&&this.sustain<1){const l=t*this.sustain,c=e+i;this.log("decay",c),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(l,a+c):this._sig.exponentialApproachValueAtTime(l,c,a)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const n=this.toSeconds(this.release);n<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,n,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,n,e):(ne(ot(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,n,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,n=1){return t=this.toSeconds(t),this.triggerAttack(t,n),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,n=0){return Ei(this,e,t,n),this}asArray(){return Re(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,n=new Ii(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),a=i+this.toSeconds(this.release),o=a*.1,l=a+o,c=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/l,decay:t*this.toSeconds(this.decay)/l,release:t*this.toSeconds(this.release)/l,context:n}));return c._sig.toDestination(),c.triggerAttackRelease(t*(i+o)/l,0),(yield n.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}kt([Wt(0)],is.prototype,"attack",void 0);kt([Wt(0)],is.prototype,"decay",void 0);kt([mc(0,1)],is.prototype,"sustain",void 0);kt([Wt(0)],is.prototype,"release",void 0);const An=(()=>{let e,t;const n=[];for(e=0;e<128;e++)n[e]=Math.sin(e/127*(Math.PI/2));const i=[],a=6.4;for(e=0;e<127;e++){t=e/127;const m=Math.sin(t*(Math.PI*2)*a-Math.PI/2)+1;i[e]=m/10+t*.83}i[127]=1;const o=[],l=5;for(e=0;e<128;e++)o[e]=Math.ceil(e/127*l)/l;const c=[];for(e=0;e<128;e++)t=e/127,c[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const m=Math.pow(t,3)*4+.2,f=Math.cos(m*Math.PI*2*t);u[e]=Math.abs(f*(1-t))}function d(m){const f=new Array(m.length);for(let p=0;p<m.length;p++)f[p]=1-m[p];return f}function h(m){return m.slice(0).reverse()}return{bounce:{In:d(u),Out:u},cosine:{In:n,Out:h(n)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:d(i)},sine:{In:c,Out:d(c)},step:{In:o,Out:d(o)}}})();let Bs=class pc extends he{constructor(){const e=re(pc.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new Ks({context:this.context,volume:e.volume}),this.volume=this._volume.volume,Me(this,"volume")}static getDefaults(){return Object.assign(he.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const n=this["_original_"+e]=this[e];this[e]=(...i)=>{const a=i[t],o=this.context.transport.schedule(l=>{i[t]=l,n.apply(this,i)},a);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,n,i){const a=this.toSeconds(n),o=this.toSeconds(t);return this.triggerAttack(e,a,i),this.triggerRelease(a+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}};class hs extends Bs{constructor(){const e=re(hs.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(Bs.getDefaults(),{detune:0,onsilence:fe,portamento:0})}triggerAttack(e,t,n=1){this.log("triggerAttack",e,t,n);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,n),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const n=this.toSeconds(t),i=e instanceof pt?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(n)>.05){const a=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,a,n)}else this.frequency.setValueAtTime(i,n);return this}}kt([Wt(0)],hs.prototype,"portamento",void 0);class Bi extends is{constructor(){super(re(Bi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Ke({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class qs extends hs{constructor(){const e=re(qs.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new er(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Bi(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),Me(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(hs.getDefaults(),{envelope:Object.assign(si(is.getDefaults(),Object.keys(he.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(si(er.getDefaults(),[...Object.keys(gt.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const n=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+n+i)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class wr extends qs{constructor(){const e=re(wr.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,Me(this,["oscillator","envelope"])}static getDefaults(){return cs(hs.getDefaults(),qs.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const n=this.toSeconds(t),i=this.toFrequency(e instanceof pt?e.toFrequency():e),a=i*this.octaves;return this.oscillator.frequency.setValueAtTime(a,n),this.oscillator.frequency.exponentialRampToValueAtTime(i,n+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}kt([mc(0)],wr.prototype,"octaves",void 0);kt([Wt(0)],wr.prototype,"pitchDecay",void 0);const fc=new Set;function qi(s){fc.add(s)}function gc(s,e){const t=`registerProcessor("${s}", ${e})`;fc.add(t)}const xg=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;qi(xg);const _g=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;qi(_g);const wg=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;qi(wg);const Ng="feedback-comb-filter",Sg=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;gc(Ng,Sg);class Wi extends Bs{constructor(){const e=re(Wi.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=i=>this.releaseAll(i),ne(!At(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const n=this._voices.indexOf(this._dummyVoice);this._voices.splice(n,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Bs.getDefaults(),{maxPolyphony:32,options:{},voice:qs})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(n=>n.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return ne(e instanceof hs,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else ur("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,n){e.forEach(i=>{const a=new Qn(this.context,i).toMidi(),o=this._getNextAvailableVoice();o&&(o.triggerAttack(i,t,n),this._activeVoices.push({midi:a,voice:o,released:!1}),this.log("triggerAttack",i,t))})}_triggerRelease(e,t){e.forEach(n=>{const i=new Qn(this.context,n).toMidi(),a=this._activeVoices.find(({midi:o,released:l})=>o===i&&!l);a&&(a.voice.triggerRelease(t),a.released=!0,this.log("triggerRelease",n,t))})}_scheduleEvent(e,t,n,i){ne(!this.disposed,"Synth was already disposed"),n<=this.now()?e==="attack"?this._triggerAttack(t,n,i):this._triggerRelease(t,n):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,n,i)},n-this.now())}triggerAttack(e,t,n){Array.isArray(e)||(e=[e]);const i=this.toSeconds(t);return this._scheduleEvent("attack",e,i,n),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const n=this.toSeconds(t);return this._scheduleEvent("release",e,n),this}triggerAttackRelease(e,t,n,i){const a=this.toSeconds(n);if(this.triggerAttack(e,a,i),ot(t)){ne(ot(e),"If the duration is an array, the notes must also be an array"),e=e;for(let o=0;o<e.length;o++){const l=t[Math.min(o,t.length-1)],c=this.toSeconds(l);ne(c>0,"The duration must be greater than 0"),this.triggerRelease(e[o],a+c)}}else{const o=this.toSeconds(t);ne(o>0,"The duration must be greater than 0"),this.triggerRelease(e,a+o)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=si(e,["onsilence","context"]);return this.options=cs(this.options,t),this._voices.forEach(n=>n.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:n})=>{n.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Nr extends Bs{constructor(){const e=re(Nr.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(n=>{const i=parseInt(n,10);if(ne(In(n)||At(i)&&isFinite(i),`url key is neither a note or midi pitch: ${n}`),In(n)){const a=new pt(this.context,n).toMidi();t[a]=e.urls[n]}else At(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new Fi({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(Bs.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:fe,onerror:fe,release:.1,urls:{}})}_findClosest(e){let n=0;for(;n<96;){if(this._buffers.has(e+n))return-n;if(this._buffers.has(e-n))return n;n++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,n=1){return this.log("triggerAttack",e,t,n),Array.isArray(e)||(e=[e]),e.forEach(i=>{const a=dc(new pt(this.context,i).toFrequency()),o=Math.round(a),l=a-o,c=this._findClosest(o),u=o-c,d=this._buffers.get(u),h=uc(c+l),m=new gr({url:d,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:h}).connect(this.output);m.start(t,0,d.duration/h,n),ot(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(m),m.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),p=f.indexOf(m);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(n=>{const i=new pt(this.context,n).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const a=this._activeSources.get(i);t=this.toSeconds(t),a.forEach(o=>{o.stop(t)}),this._activeSources.set(i,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(n=>{for(;n.length;)n.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,n,i=1){const a=this.toSeconds(n);return this.triggerAttack(e,a,i),ot(t)?(ne(ot(e),"notes must be an array when duration is array"),e.forEach((o,l)=>{const c=t[Math.min(l,t.length-1)];this.triggerRelease(o,a+this.toSeconds(c))})):this.triggerRelease(e,a+this.toSeconds(t)),this}add(e,t,n){if(ne(In(e)||isFinite(e),`note must be a pitch or midi: ${e}`),In(e)){const i=new pt(this.context,e).toMidi();this._buffers.add(i,t,n)}else this._buffers.add(e,t,n);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}kt([Wt(0)],Nr.prototype,"attack",void 0);kt([Wt(0)],Nr.prototype,"release",void 0);class Is extends Je{constructor(){const e=re(Is.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new wn("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Je.getDefaults(),{callback:fe,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let n;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const i=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||At(this._loop)&&this._loop>1){n=1/0,At(this._loop)&&(n=this._loop*this._getLoopDuration());const a=this._state.getAfter(i);a!==null&&(n=Math.min(n,a.time-i)),n!==1/0&&(n=new Ue(this.context,n));const o=new Ue(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),o,new Ue(this.context,i),n)}else t.id=this.context.transport.schedule(this._tick.bind(this),new Ue(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const n=this._state.getBefore(t);let i=t;n!==null&&(i=n.time),this._rescheduleEvents(i)}return this}cancel(e){e=Ct(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,n=>{this.context.transport.clear(n.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let n=.02;ec(this.humanize)||(n=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*n}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new Ue(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new Ue(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const n=this._getLoopDuration();return(e-t.time)%n/n}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class tr extends Is{constructor(){const e=re(tr.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new wn("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{ot(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(Is.getDefaults(),{events:[]})}start(e,t){const n=this.toTicks(e);if(this._state.getValueAtTime(n)!=="started"){t=Ct(t,this._loop?this._loopStart:0),this._loop?t=Ct(t,this._loopStart):t=Ct(t,0);const i=this.toTicks(t);this._state.add({id:-1,offset:i,state:"started",time:n}),this._forEach(a=>{this._startNote(a,n,i)})}return this}_startNote(e,t,n){t-=n,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<n&&(t+=this._getLoopDuration()),e.start(new Ue(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=n&&(e.loop=!1,e.start(new Ue(this.context,t))):e.startOffset>=n&&e.start(new Ue(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(n=>{n.stop(e)}),this}at(e,t){const n=new Ps(this.context,e).toTicks(),i=new Ue(this.context,1).toSeconds(),a=this._events.values();let o=a.next();for(;!o.done;){const l=o.value;if(Math.abs(n-l.startOffset)<i)return ue(t)&&(l.value=t),l;o=a.next()}return ue(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const n=this.toTicks(e);let i;return t instanceof Is?(i=t,i.callback=this._tick.bind(this)):i=new Is({callback:this._tick.bind(this),context:this.context,value:t}),i.startOffset=n,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new Ue(this.context,t.time))})}remove(e,t){return Xt(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(n=>{n.startOffset===e&&(ft(t)||ue(t)&&n.value===t)&&(this._events.delete(n),n.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof tr?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(n=>{n[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new Ue(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new Ue(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class Gi extends he{constructor(){const e=re(Gi.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Ce({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",Me(this,"pan")}static getDefaults(){return Object.assign(he.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const kg="bit-crusher",jg=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;gc(kg,jg);class Pe extends he{constructor(){const e=re(Pe.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new Ke({context:this.context}),Pe._allSolos.has(this.context)||Pe._allSolos.set(this.context,new Set),Pe._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(he.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),Pe._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){Pe._soloed.has(this.context)||Pe._soloed.set(this.context,new Set),Pe._soloed.get(this.context).add(this)}_removeSolo(){Pe._soloed.has(this.context)&&Pe._soloed.get(this.context).delete(this)}_isSoloed(){return Pe._soloed.has(this.context)&&Pe._soloed.get(this.context).has(this)}_noSolos(){return!Pe._soloed.has(this.context)||Pe._soloed.has(this.context)&&Pe._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),Pe._allSolos.get(this.context).delete(this),this._removeSolo(),this}}Pe._allSolos=new Map;Pe._soloed=new Map;class $i extends he{constructor(){const e=re($i.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new Gi({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Ks({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,Me(this,["pan","volume"])}static getDefaults(){return Object.assign(he.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class As extends he{constructor(){const e=re(As.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new Pe({solo:e.solo,context:this.context}),this._panVol=this.output=new $i({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Me(this,["pan","volume"])}static getDefaults(){return Object.assign(he.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return As.buses.has(e)||As.buses.set(e,new Ke({context:this.context})),As.buses.get(e)}send(e,t=0){const n=this._getBus(e),i=new Ke({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(n),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}As.buses=new Map;mt().transport;function Dt(){return mt().transport}mt().destination;mt().destination;function Tg(){return mt().destination}mt().listener;mt().draw;const Cg=mt();var vc={},Sr={};function Ig(s){var e=new rt(s),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=Ag(t.data),i=[],a=0;!e.eof()&&a<n.numTracks;a++){var o=e.readChunk();if(o.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+o.id+"'";var l=Mg(o.data);i.push(l)}return{header:n,tracks:i}}function Ag(s){var e=new rt(s),t=e.readUInt16(),n=e.readUInt16(),i={format:t,numTracks:n},a=e.readUInt16();return a&32768?(i.framesPerSecond=256-(a>>8),i.ticksPerFrame=a&255):i.ticksPerBeat=a,i}function Mg(s){for(var e=new rt(s),t=[];!e.eof();){var n=a();t.push(n)}return t;var i;function a(){var o={};o.deltaTime=e.readVarInt();var l=e.readUInt8();if((l&240)===240)if(l===255){o.meta=!0;var c=e.readUInt8(),u=e.readVarInt();switch(c){case 0:if(o.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return o.number=e.readUInt16(),o;case 1:return o.type="text",o.text=e.readString(u),o;case 2:return o.type="copyrightNotice",o.text=e.readString(u),o;case 3:return o.type="trackName",o.text=e.readString(u),o;case 4:return o.type="instrumentName",o.text=e.readString(u),o;case 5:return o.type="lyrics",o.text=e.readString(u),o;case 6:return o.type="marker",o.text=e.readString(u),o;case 7:return o.type="cuePoint",o.text=e.readString(u),o;case 32:if(o.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return o.channel=e.readUInt8(),o;case 33:if(o.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return o.port=e.readUInt8(),o;case 47:if(o.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return o;case 81:if(o.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return o.microsecondsPerBeat=e.readUInt24(),o;case 84:if(o.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var d=e.readUInt8(),h={0:24,32:25,64:29,96:30};return o.frameRate=h[d&96],o.hour=d&31,o.min=e.readUInt8(),o.sec=e.readUInt8(),o.frame=e.readUInt8(),o.subFrame=e.readUInt8(),o;case 88:if(o.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return o.numerator=e.readUInt8(),o.denominator=1<<e.readUInt8(),u===4?(o.metronome=e.readUInt8(),o.thirtyseconds=e.readUInt8()):(o.metronome=36,o.thirtyseconds=8),o;case 89:if(o.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return o.key=e.readInt8(),o.scale=e.readUInt8(),o;case 127:return o.type="sequencerSpecific",o.data=e.readBytes(u),o;default:return o.type="unknownMeta",o.data=e.readBytes(u),o.metatypeByte=c,o}}else if(l==240){o.type="sysEx";var u=e.readVarInt();return o.data=e.readBytes(u),o}else if(l==247){o.type="endSysEx";var u=e.readVarInt();return o.data=e.readBytes(u),o}else throw"Unrecognised MIDI event type byte: "+l;else{var m;if(l&128)m=e.readUInt8(),i=l;else{if(i===null)throw"Running status byte encountered before status byte";m=l,l=i,o.running=!0}var f=l>>4;switch(o.channel=l&15,f){case 8:return o.type="noteOff",o.noteNumber=m,o.velocity=e.readUInt8(),o;case 9:var p=e.readUInt8();return o.type=p===0?"noteOff":"noteOn",o.noteNumber=m,o.velocity=p,p===0&&(o.byte9=!0),o;case 10:return o.type="noteAftertouch",o.noteNumber=m,o.amount=e.readUInt8(),o;case 11:return o.type="controller",o.controllerType=m,o.value=e.readUInt8(),o;case 12:return o.type="programChange",o.programNumber=m,o;case 13:return o.type="channelAftertouch",o.amount=m,o;case 14:return o.type="pitchBend",o.value=m+(e.readUInt8()<<7)-8192,o;default:throw"Unrecognised MIDI event type: "+f}}}}function rt(s){this.buffer=s,this.bufferLen=this.buffer.length,this.pos=0}rt.prototype.eof=function(){return this.pos>=this.bufferLen};rt.prototype.readUInt8=function(){var s=this.buffer[this.pos];return this.pos+=1,s};rt.prototype.readInt8=function(){var s=this.readUInt8();return s&128?s-256:s};rt.prototype.readUInt16=function(){var s=this.readUInt8(),e=this.readUInt8();return(s<<8)+e};rt.prototype.readInt16=function(){var s=this.readUInt16();return s&32768?s-65536:s};rt.prototype.readUInt24=function(){var s=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(s<<16)+(e<<8)+t};rt.prototype.readInt24=function(){var s=this.readUInt24();return s&8388608?s-16777216:s};rt.prototype.readUInt32=function(){var s=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(s<<24)+(e<<16)+(t<<8)+n};rt.prototype.readBytes=function(s){var e=this.buffer.slice(this.pos,this.pos+s);return this.pos+=s,e};rt.prototype.readString=function(s){var e=this.readBytes(s);return String.fromCharCode.apply(null,e)};rt.prototype.readVarInt=function(){for(var s=0;!this.eof();){var e=this.readUInt8();if(e&128)s+=e&127,s<<=7;else return s+e}return s};rt.prototype.readChunk=function(){var s=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:s,length:e,data:t}};var Eg=Ig;function Og(s,e){if(typeof s!="object")throw"Invalid MIDI data";e=e||{};var t=s.header||{},n=s.tracks||[],i,a=n.length,o=new qe;for(Pg(o,t,a),i=0;i<a;i++)Dg(o,n[i],e);return o.buffer}function Pg(s,e,t){var n=e.format==null?1:e.format,i=128;e.timeDivision?i=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?i=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(i=e.ticksPerBeat&32767);var a=new qe;a.writeUInt16(n),a.writeUInt16(t),a.writeUInt16(i),s.writeChunk("MThd",a.buffer)}function Dg(s,e,t){var n=new qe,i,a=e.length,o=null;for(i=0;i<a;i++)(t.running===!1||!t.running&&!e[i].running)&&(o=null),o=Rg(n,e[i],o,t.useByte9ForNoteOff);s.writeChunk("MTrk",n.buffer)}function Rg(s,e,t,n){var i=e.type,a=e.deltaTime,o=e.text||"",l=e.data||[],c=null;switch(s.writeVarInt(a),i){case"sequenceNumber":s.writeUInt8(255),s.writeUInt8(0),s.writeVarInt(2),s.writeUInt16(e.number);break;case"text":s.writeUInt8(255),s.writeUInt8(1),s.writeVarInt(o.length),s.writeString(o);break;case"copyrightNotice":s.writeUInt8(255),s.writeUInt8(2),s.writeVarInt(o.length),s.writeString(o);break;case"trackName":s.writeUInt8(255),s.writeUInt8(3),s.writeVarInt(o.length),s.writeString(o);break;case"instrumentName":s.writeUInt8(255),s.writeUInt8(4),s.writeVarInt(o.length),s.writeString(o);break;case"lyrics":s.writeUInt8(255),s.writeUInt8(5),s.writeVarInt(o.length),s.writeString(o);break;case"marker":s.writeUInt8(255),s.writeUInt8(6),s.writeVarInt(o.length),s.writeString(o);break;case"cuePoint":s.writeUInt8(255),s.writeUInt8(7),s.writeVarInt(o.length),s.writeString(o);break;case"channelPrefix":s.writeUInt8(255),s.writeUInt8(32),s.writeVarInt(1),s.writeUInt8(e.channel);break;case"portPrefix":s.writeUInt8(255),s.writeUInt8(33),s.writeVarInt(1),s.writeUInt8(e.port);break;case"endOfTrack":s.writeUInt8(255),s.writeUInt8(47),s.writeVarInt(0);break;case"setTempo":s.writeUInt8(255),s.writeUInt8(81),s.writeVarInt(3),s.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":s.writeUInt8(255),s.writeUInt8(84),s.writeVarInt(5);var u={24:0,25:32,29:64,30:96},d=e.hour&31|u[e.frameRate];s.writeUInt8(d),s.writeUInt8(e.min),s.writeUInt8(e.sec),s.writeUInt8(e.frame),s.writeUInt8(e.subFrame);break;case"timeSignature":s.writeUInt8(255),s.writeUInt8(88),s.writeVarInt(4),s.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;s.writeUInt8(h),s.writeUInt8(e.metronome),s.writeUInt8(e.thirtyseconds||8);break;case"keySignature":s.writeUInt8(255),s.writeUInt8(89),s.writeVarInt(2),s.writeInt8(e.key),s.writeUInt8(e.scale);break;case"sequencerSpecific":s.writeUInt8(255),s.writeUInt8(127),s.writeVarInt(l.length),s.writeBytes(l);break;case"unknownMeta":e.metatypeByte!=null&&(s.writeUInt8(255),s.writeUInt8(e.metatypeByte),s.writeVarInt(l.length),s.writeBytes(l));break;case"sysEx":s.writeUInt8(240),s.writeVarInt(l.length),s.writeBytes(l);break;case"endSysEx":s.writeUInt8(247),s.writeVarInt(l.length),s.writeBytes(l);break;case"noteOff":var m=n!==!1&&e.byte9||n&&e.velocity==0?144:128;c=m|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.noteNumber),s.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.noteNumber),s.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.noteNumber),s.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.controllerType),s.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&s.writeUInt8(c),s.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&s.writeUInt8(c);var f=8192+e.value,p=f&127,g=f>>7&127;s.writeUInt8(p),s.writeUInt8(g);break;default:throw"Unrecognized event type: "+i}return c}function qe(){this.buffer=[]}qe.prototype.writeUInt8=function(s){this.buffer.push(s&255)};qe.prototype.writeInt8=qe.prototype.writeUInt8;qe.prototype.writeUInt16=function(s){var e=s>>8&255,t=s&255;this.writeUInt8(e),this.writeUInt8(t)};qe.prototype.writeInt16=qe.prototype.writeUInt16;qe.prototype.writeUInt24=function(s){var e=s>>16&255,t=s>>8&255,n=s&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};qe.prototype.writeInt24=qe.prototype.writeUInt24;qe.prototype.writeUInt32=function(s){var e=s>>24&255,t=s>>16&255,n=s>>8&255,i=s&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(i)};qe.prototype.writeInt32=qe.prototype.writeUInt32;qe.prototype.writeBytes=function(s){this.buffer=this.buffer.concat(Array.prototype.slice.call(s,0))};qe.prototype.writeString=function(s){var e,t=s.length,n=[];for(e=0;e<t;e++)n.push(s.codePointAt(e));this.writeBytes(n)};qe.prototype.writeVarInt=function(s){if(s<0)throw"Cannot write negative variable-length integer";if(s<=127)this.writeUInt8(s);else{var e=s,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};qe.prototype.writeChunk=function(s,e){this.writeString(s),this.writeUInt32(e.length),this.writeBytes(e)};var Fg=Og;Sr.parseMidi=Eg;Sr.writeMidi=Fg;var sr={},ms={};Object.defineProperty(ms,"__esModule",{value:!0});ms.insert=ms.search=void 0;function yc(s,e,t){t===void 0&&(t="ticks");var n=0,i=s.length,a=i;if(i>0&&s[i-1][t]<=e)return i-1;for(;n<a;){var o=Math.floor(n+(a-n)/2),l=s[o],c=s[o+1];if(l[t]===e){for(var u=o;u<s.length;u++){var d=s[u];d[t]===e&&(o=u)}return o}else{if(l[t]<e&&c[t]>e)return o;l[t]>e?a=o:l[t]<e&&(n=o+1)}}return-1}ms.search=yc;function Lg(s,e,t){if(t===void 0&&(t="ticks"),s.length){var n=yc(s,e[t],t);s.splice(n+1,0,e)}else s.push(e)}ms.insert=Lg;(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.Header=s.keySignatureKeys=void 0;var e=ms,t=new WeakMap;s.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var n=function(){function i(a){var o=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",t.set(this,480),a){t.set(this,a.header.ticksPerBeat),a.tracks.forEach(function(c){c.forEach(function(u){u.meta&&(u.type==="timeSignature"?o.timeSignatures.push({ticks:u.absoluteTime,timeSignature:[u.numerator,u.denominator]}):u.type==="setTempo"?o.tempos.push({bpm:6e7/u.microsecondsPerBeat,ticks:u.absoluteTime}):u.type==="keySignature"&&o.keySignatures.push({key:s.keySignatureKeys[u.key+7],scale:u.scale===0?"major":"minor",ticks:u.absoluteTime}))})});var l=0;a.tracks[0].forEach(function(c){l+=c.deltaTime,c.meta&&(c.type==="trackName"?o.name=c.text:(c.type==="text"||c.type==="cuePoint"||c.type==="marker"||c.type==="lyrics")&&o.meta.push({text:c.text,ticks:l,type:c.type}))}),this.update()}}return i.prototype.update=function(){var a=this,o=0,l=0;this.tempos.sort(function(c,u){return c.ticks-u.ticks}),this.tempos.forEach(function(c,u){var d=u>0?a.tempos[u-1].bpm:a.tempos[0].bpm,h=c.ticks/a.ppq-l,m=60/d*h;c.time=m+o,o=c.time,l+=h}),this.timeSignatures.sort(function(c,u){return c.ticks-u.ticks}),this.timeSignatures.forEach(function(c,u){var d=u>0?a.timeSignatures[u-1]:a.timeSignatures[0],h=(c.ticks-d.ticks)/a.ppq,m=h/d.timeSignature[0]/(d.timeSignature[1]/4);d.measures=d.measures||0,c.measures=m+d.measures})},i.prototype.ticksToSeconds=function(a){var o=(0,e.search)(this.tempos,a);if(o!==-1){var l=this.tempos[o],c=l.time,u=(a-l.ticks)/this.ppq;return c+60/l.bpm*u}else{var d=a/this.ppq;return 60/120*d}},i.prototype.ticksToMeasures=function(a){var o=(0,e.search)(this.timeSignatures,a);if(o!==-1){var l=this.timeSignatures[o],c=(a-l.ticks)/this.ppq;return l.measures+c/(l.timeSignature[0]/l.timeSignature[1])/4}else return a/this.ppq/4},Object.defineProperty(i.prototype,"ppq",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),i.prototype.secondsToTicks=function(a){var o=(0,e.search)(this.tempos,a,"time");if(o!==-1){var l=this.tempos[o],c=l.time,u=a-c,d=u/(60/l.bpm);return Math.round(l.ticks+d*this.ppq)}else{var h=a/.5;return Math.round(h*this.ppq)}},i.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(a){return{bpm:a.bpm,ticks:a.ticks}}),timeSignatures:this.timeSignatures}},i.prototype.fromJSON=function(a){this.name=a.name,this.tempos=a.tempos.map(function(o){return Object.assign({},o)}),this.timeSignatures=a.timeSignatures.map(function(o){return Object.assign({},o)}),this.keySignatures=a.keySignatures.map(function(o){return Object.assign({},o)}),this.meta=a.meta.map(function(o){return Object.assign({},o)}),t.set(this,a.ppq),this.update()},i.prototype.setTempo=function(a){this.tempos=[{bpm:a,ticks:0}],this.update()},i}();s.Header=n})(sr);var an={},zi={};(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.ControlChange=s.controlChangeIds=s.controlChangeNames=void 0,s.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},s.controlChangeIds=Object.keys(s.controlChangeNames).reduce(function(i,a){return i[s.controlChangeNames[a]]=a,i},{});var e=new WeakMap,t=new WeakMap,n=function(){function i(a,o){e.set(this,o),t.set(this,a.controllerType),this.ticks=a.absoluteTime,this.value=a.value}return Object.defineProperty(i.prototype,"number",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return s.controlChangeNames[this.number]?s.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"time",{get:function(){var a=e.get(this);return a.ticksToSeconds(this.ticks)},set:function(a){var o=e.get(this);this.ticks=o.secondsToTicks(a)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},i}();s.ControlChange=n})(zi);var kr={};Object.defineProperty(kr,"__esModule",{value:!0});kr.createControlChanges=void 0;var Mn=zi;function Vg(){return new Proxy({},{get:function(s,e){if(s[e])return s[e];if(Mn.controlChangeIds.hasOwnProperty(e))return s[Mn.controlChangeIds[e]]},set:function(s,e,t){return Mn.controlChangeIds.hasOwnProperty(e)?s[Mn.controlChangeIds[e]]=t:s[e]=t,!0}})}kr.createControlChanges=Vg;var jr={};Object.defineProperty(jr,"__esModule",{value:!0});jr.PitchBend=void 0;var Ur=new WeakMap,Ug=function(){function s(e,t){Ur.set(this,t),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(s.prototype,"time",{get:function(){var e=Ur.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=Ur.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},s}();jr.PitchBend=Ug;var Tr={},Kt={};Object.defineProperty(Kt,"__esModule",{value:!0});Kt.DrumKitByPatchID=Kt.InstrumentFamilyByID=Kt.instrumentByPatchID=void 0;Kt.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"];Kt.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"];Kt.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"};Object.defineProperty(Tr,"__esModule",{value:!0});Tr.Instrument=void 0;var En=Kt,Pa=new WeakMap,Bg=function(){function s(e,t){if(this.number=0,Pa.set(this,t),this.number=0,e){var n=e.find(function(i){return i.type==="programChange"});n&&(this.number=n.programNumber)}}return Object.defineProperty(s.prototype,"name",{get:function(){return this.percussion?En.DrumKitByPatchID[this.number]:En.instrumentByPatchID[this.number]},set:function(e){var t=En.instrumentByPatchID.indexOf(e);t!==-1&&(this.number=t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"family",{get:function(){return this.percussion?"drums":En.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"percussion",{get:function(){var e=Pa.get(this);return e.channel===9},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},s.prototype.fromJSON=function(e){this.number=e.number},s}();Tr.Instrument=Bg;var Cr={};Object.defineProperty(Cr,"__esModule",{value:!0});Cr.Note=void 0;function qg(s){var e=Math.floor(s/12)-1;return bc(s)+e.toString()}function bc(s){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=s%12;return e[t]}function Wg(s){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return e.indexOf(s)}var Gg=function(){var s=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,e={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(t){var n=s.exec(t),i=n[1],a=n[2],o=e[i.toLowerCase()];return o+(parseInt(a,10)+1)*12}}(),Ss=new WeakMap,$g=function(){function s(e,t,n){Ss.set(this,n),this.midi=e.midi,this.velocity=e.velocity,this.noteOffVelocity=t.velocity,this.ticks=e.ticks,this.durationTicks=t.ticks-e.ticks}return Object.defineProperty(s.prototype,"name",{get:function(){return qg(this.midi)},set:function(e){this.midi=Gg(e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(e){var t=e-this.octave;this.midi+=t*12},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"pitch",{get:function(){return bc(this.midi)},set:function(e){this.midi=12*(this.octave+1)+Wg(e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"duration",{get:function(){var e=Ss.get(this);return e.ticksToSeconds(this.ticks+this.durationTicks)-e.ticksToSeconds(this.ticks)},set:function(e){var t=Ss.get(this),n=t.secondsToTicks(this.time+e);this.durationTicks=n-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"time",{get:function(){var e=Ss.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=Ss.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"bars",{get:function(){var e=Ss.get(this);return e.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},s}();Cr.Note=$g;Object.defineProperty(an,"__esModule",{value:!0});an.Track=void 0;var Br=ms,zg=zi,Yg=kr,Hg=jr,Da=Tr,Xg=Cr,On=new WeakMap,Jg=function(){function s(e,t){var n=this;if(this.name="",this.notes=[],this.controlChanges=(0,Yg.createControlChanges)(),this.pitchBends=[],On.set(this,t),e){var i=e.find(function(m){return m.type==="trackName"});this.name=i?i.text:""}if(this.instrument=new Da.Instrument(e,this),this.channel=0,e){for(var a=e.filter(function(m){return m.type==="noteOn"}),o=e.filter(function(m){return m.type==="noteOff"}),l=function(){var m=a.shift();c.channel=m.channel;var f=o.findIndex(function(g){return g.noteNumber===m.noteNumber&&g.absoluteTime>=m.absoluteTime});if(f!==-1){var p=o.splice(f,1)[0];c.addNote({durationTicks:p.absoluteTime-m.absoluteTime,midi:m.noteNumber,noteOffVelocity:p.velocity/127,ticks:m.absoluteTime,velocity:m.velocity/127})}},c=this;a.length;)l();var u=e.filter(function(m){return m.type==="controller"});u.forEach(function(m){n.addCC({number:m.controllerType,ticks:m.absoluteTime,value:m.value/127})});var d=e.filter(function(m){return m.type==="pitchBend"});d.forEach(function(m){n.addPitchBend({ticks:m.absoluteTime,value:m.value/Math.pow(2,13)})});var h=e.find(function(m){return m.type==="endOfTrack"});this.endOfTrackTicks=h!==void 0?h.absoluteTime:void 0}}return s.prototype.addNote=function(e){var t=On.get(this),n=new Xg.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},t);return Object.assign(n,e),(0,Br.insert)(this.notes,n,"ticks"),this},s.prototype.addCC=function(e){var t=On.get(this),n=new zg.ControlChange({controllerType:e.number},t);return delete e.number,Object.assign(n,e),Array.isArray(this.controlChanges[n.number])||(this.controlChanges[n.number]=[]),(0,Br.insert)(this.controlChanges[n.number],n,"ticks"),this},s.prototype.addPitchBend=function(e){var t=On.get(this),n=new Hg.PitchBend({},t);return Object.assign(n,e),(0,Br.insert)(this.pitchBends,n,"ticks"),this},Object.defineProperty(s.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,t=0;t<this.notes.length-1;t++){var n=this.notes[t].time+this.notes[t].duration;e<n&&(e=n)}return e},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,t=0;t<this.notes.length-1;t++){var n=this.notes[t].ticks+this.notes[t].durationTicks;e<n&&(e=n)}return e},enumerable:!1,configurable:!0}),s.prototype.fromJSON=function(e){var t=this;this.name=e.name,this.channel=e.channel,this.instrument=new Da.Instrument(void 0,this),this.instrument.fromJSON(e.instrument),e.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=e.endOfTrackTicks);for(var n in e.controlChanges)e.controlChanges[n]&&e.controlChanges[n].forEach(function(i){t.addCC({number:i.number,ticks:i.ticks,value:i.value})});e.notes.forEach(function(i){t.addNote({durationTicks:i.durationTicks,midi:i.midi,ticks:i.ticks,velocity:i.velocity})})},s.prototype.toJSON=function(){for(var e={},t=0;t<127;t++)this.controlChanges.hasOwnProperty(t)&&(e[t]=this.controlChanges[t].map(function(i){return i.toJSON()}));var n={channel:this.channel,controlChanges:e,pitchBends:this.pitchBends.map(function(i){return i.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(i){return i.toJSON()})};return this.endOfTrackTicks!==void 0&&(n.endOfTrackTicks=this.endOfTrackTicks),n},s}();an.Track=Jg;var Ir={};function Kg(s){var e=[];return xc(s,e),e}function xc(s,e){for(var t=0;t<s.length;t++){var n=s[t];Array.isArray(n)?xc(n,e):e.push(n)}}const Zg=Object.freeze(Object.defineProperty({__proto__:null,flatten:Kg},Symbol.toStringTag,{value:"Module"})),Qg=Oc(Zg);var $t=Ts&&Ts.__spreadArray||function(s,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,a;n<i;n++)(a||!(n in e))&&(a||(a=Array.prototype.slice.call(e,0,n)),a[n]=e[n]);return s.concat(a||Array.prototype.slice.call(e))};Object.defineProperty(Ir,"__esModule",{value:!0});Ir.encode=void 0;var ev=Sr,tv=sr,sv=Qg;function nv(s,e){return[{absoluteTime:s.ticks,channel:e,deltaTime:0,noteNumber:s.midi,type:"noteOn",velocity:Math.floor(s.velocity*127)},{absoluteTime:s.ticks+s.durationTicks,channel:e,deltaTime:0,noteNumber:s.midi,type:"noteOff",velocity:Math.floor(s.noteOffVelocity*127)}]}function rv(s){return(0,sv.flatten)(s.notes.map(function(e){return nv(e,s.channel)}))}function iv(s,e){return{absoluteTime:s.ticks,channel:e,controllerType:s.number,deltaTime:0,type:"controller",value:Math.floor(s.value*127)}}function av(s){for(var e=[],t=0;t<127;t++)s.controlChanges.hasOwnProperty(t)&&s.controlChanges[t].forEach(function(n){e.push(iv(n,s.channel))});return e}function ov(s,e){return{absoluteTime:s.ticks,channel:e,deltaTime:0,type:"pitchBend",value:s.value}}function cv(s){var e=[];return s.pitchBends.forEach(function(t){e.push(ov(t,s.channel))}),e}function lv(s){return{absoluteTime:0,channel:s.channel,deltaTime:0,programNumber:s.instrument.number,type:"programChange"}}function uv(s){return{absoluteTime:0,deltaTime:0,meta:!0,text:s,type:"trackName"}}function dv(s){return{absoluteTime:s.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/s.bpm),type:"setTempo"}}function hv(s){return{absoluteTime:s.ticks,deltaTime:0,denominator:s.timeSignature[1],meta:!0,metronome:24,numerator:s.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function mv(s){var e=tv.keySignatureKeys.indexOf(s.key);return{absoluteTime:s.ticks,deltaTime:0,key:e+7,meta:!0,scale:s.scale==="major"?0:1,type:"keySignature"}}function pv(s){return{absoluteTime:s.ticks,deltaTime:0,meta:!0,text:s.text,type:s.type}}function fv(s){var e={header:{format:1,numTracks:s.tracks.length+1,ticksPerBeat:s.header.ppq},tracks:$t([$t($t($t($t([{absoluteTime:0,deltaTime:0,meta:!0,text:s.header.name,type:"trackName"}],s.header.keySignatures.map(function(t){return mv(t)}),!0),s.header.meta.map(function(t){return pv(t)}),!0),s.header.tempos.map(function(t){return dv(t)}),!0),s.header.timeSignatures.map(function(t){return hv(t)}),!0)],s.tracks.map(function(t){return $t($t($t([uv(t.name),lv(t)],rv(t),!0),av(t),!0),cv(t),!0)}),!0)};return e.tracks=e.tracks.map(function(t){t=t.sort(function(i,a){return i.absoluteTime-a.absoluteTime});var n=0;return t.forEach(function(i){i.deltaTime=i.absoluteTime-n,n=i.absoluteTime,delete i.absoluteTime}),t.push({deltaTime:0,meta:!0,type:"endOfTrack"}),t}),new Uint8Array((0,ev.writeMidi)(e))}Ir.encode=fv;(function(s){var e=Ts&&Ts.__awaiter||function(h,m,f,p){function g(v){return v instanceof f?v:new f(function(b){b(v)})}return new(f||(f=Promise))(function(v,b){function w(x){try{A(p.next(x))}catch(T){b(T)}}function S(x){try{A(p.throw(x))}catch(T){b(T)}}function A(x){x.done?v(x.value):g(x.value).then(w,S)}A((p=p.apply(h,m||[])).next())})},t=Ts&&Ts.__generator||function(h,m){var f={label:0,sent:function(){if(v[0]&1)throw v[1];return v[1]},trys:[],ops:[]},p,g,v,b;return b={next:w(0),throw:w(1),return:w(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function w(A){return function(x){return S([A,x])}}function S(A){if(p)throw new TypeError("Generator is already executing.");for(;f;)try{if(p=1,g&&(v=A[0]&2?g.return:A[0]?g.throw||((v=g.return)&&v.call(g),0):g.next)&&!(v=v.call(g,A[1])).done)return v;switch(g=0,v&&(A=[A[0]&2,v.value]),A[0]){case 0:case 1:v=A;break;case 4:return f.label++,{value:A[1],done:!1};case 5:f.label++,g=A[1],A=[0];continue;case 7:A=f.ops.pop(),f.trys.pop();continue;default:if(v=f.trys,!(v=v.length>0&&v[v.length-1])&&(A[0]===6||A[0]===2)){f=0;continue}if(A[0]===3&&(!v||A[1]>v[0]&&A[1]<v[3])){f.label=A[1];break}if(A[0]===6&&f.label<v[1]){f.label=v[1],v=A;break}if(v&&f.label<v[2]){f.label=v[2],f.ops.push(A);break}v[2]&&f.ops.pop(),f.trys.pop();continue}A=m.call(h,f)}catch(x){A=[6,x],g=0}finally{p=v=0}if(A[0]&5)throw A[1];return{value:A[0]?A[1]:void 0,done:!0}}};Object.defineProperty(s,"__esModule",{value:!0}),s.Header=s.Track=s.Midi=void 0;var n=Sr,i=sr,a=an,o=Ir,l=function(){function h(m){var f=this,p=null;if(m){var g=m instanceof ArrayBuffer?new Uint8Array(m):m;p=(0,n.parseMidi)(g),p.tracks.forEach(function(v){var b=0;v.forEach(function(w){b+=w.deltaTime,w.absoluteTime=b})}),p.tracks=d(p.tracks)}this.header=new i.Header(p),this.tracks=[],m&&(this.tracks=p.tracks.map(function(v){return new a.Track(v,f.header)}),p.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return h.fromUrl=function(m){return e(this,void 0,void 0,function(){var f,p;return t(this,function(g){switch(g.label){case 0:return[4,fetch(m)];case 1:return f=g.sent(),f.ok?[4,f.arrayBuffer()]:[3,3];case 2:return p=g.sent(),[2,new h(p)];case 3:throw new Error("Could not load '".concat(m,"'"))}})})},Object.defineProperty(h.prototype,"name",{get:function(){return this.header.name},set:function(m){this.header.name=m},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"duration",{get:function(){var m=this.tracks.map(function(f){return f.duration});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"durationTicks",{get:function(){var m=this.tracks.map(function(f){return f.durationTicks});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),h.prototype.addTrack=function(){var m=new a.Track(void 0,this.header);return this.tracks.push(m),m},h.prototype.toArray=function(){return(0,o.encode)(this)},h.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(m){return m.toJSON()})}},h.prototype.fromJSON=function(m){var f=this;this.header=new i.Header,this.header.fromJSON(m.header),this.tracks=m.tracks.map(function(p){var g=new a.Track(void 0,f.header);return g.fromJSON(p),g})},h.prototype.clone=function(){var m=new h;return m.fromJSON(this.toJSON()),m},h}();s.Midi=l;var c=an;Object.defineProperty(s,"Track",{enumerable:!0,get:function(){return c.Track}});var u=sr;Object.defineProperty(s,"Header",{enumerable:!0,get:function(){return u.Header}});function d(h){for(var m=[],f=0;f<h.length;f++)for(var p=m.length,g=new Map,v=Array(16).fill(0),b=0,w=h[f];b<w.length;b++){var S=w[b],A=p,x=S.channel;if(x!==void 0){S.type==="programChange"&&(v[x]=S.programNumber);var T=v[x],k="".concat(T," ").concat(x);g.has(k)?A=g.get(k):(A=p+g.size,g.set(k,A))}m[A]||m.push([]),m[A].push(S)}return m}})(vc);class gv{constructor(e={}){jt(this,"synth",null);jt(this,"part",null);jt(this,"isPlaying",!1);jt(this,"isPaused",!1);jt(this,"duration",0);jt(this,"options");jt(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let a=0;a<t.length;a++)n[a]=t.charCodeAt(a);const i=this.parseMIDIToNotes(n);this.synth||(this.synth=new Wi(qs,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new tr((a,o)=>{this.synth?.triggerAttackRelease(o.name,o.duration,a,o.velocity)},i),this.duration=this.calculateDuration(i),this.part.loop=!1}catch(t){const n=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(n),n}}parseMIDIToNotes(e){try{const t=new vc.Midi(e),n=[];for(const i of t.tracks)for(const a of i.notes){const o=Number(a.time),l=Number(a.duration);!Number.isFinite(o)||!Number.isFinite(l)||n.push({time:o,name:a.name,duration:l,velocity:typeof a.velocity=="number"?a.velocity:.8})}if(n.sort((i,a)=>Number(i.time)-Number(a.time)),n.length)return n;throw new Error("No notes found in MIDI")}catch{const t=[],n=["C4","D4","E4","F4","G4","A4","B4","C5"];let i=0;for(let a=0;a<16;a++)t.push({time:i,name:n[a%n.length],duration:.4,velocity:.7}),i+=.5;return t}}calculateDuration(e){if(e.length===0)return 0;let t=0;for(const n of e)!Number.isFinite(n.time)||!Number.isFinite(n.duration)||(t=Math.max(t,n.time+n.duration));return t}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await lc(),this.isPaused?(Dt().start(),this.isPaused=!1):(this.part.start(0),Dt().start()),this.isPlaying=!0,this.startProgressTracking(),Dt().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(Dt().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){Dt().stop(),Dt().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));Dt().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:Dt().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=Dt().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let qr=null;function vv(){return qr||(qr=new gv),qr}const yv=({album:s,isPlaying:e,currentTime:t,duration:n,onPlayPause:i,onExpand:a})=>{if(!s)return null;const o=n>0?Math.max(0,Math.min(1,t/n)):0,l=c=>{c.stopPropagation()};return r.jsxs("div",{className:"spotify-square-dock",role:"button",tabIndex:0,"aria-label":"プレイヤーを開く",onClick:a,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),a())},"data-no-swipe":!0,children:[r.jsx("img",{className:"spotify-square-dock-art",src:s.imageDataURL,alt:s.title||s.mood,draggable:!1}),r.jsx("div",{className:"spotify-square-dock-overlay","aria-hidden":"true"}),r.jsx("button",{className:"spotify-square-dock-play",onClick:c=>{l(c),i()},onMouseDown:l,onTouchStart:l,"aria-label":e?"一時停止":"再生",title:e?"一時停止":"再生",children:e?"⏸":"▶"}),r.jsx("div",{className:"spotify-square-dock-progress","aria-hidden":"true",children:r.jsx("div",{className:"spotify-square-dock-progressFill",style:{width:`${Math.round(o*100)}%`}})}),r.jsx("div",{className:"spotify-square-dock-hint","aria-hidden":"true",children:r.jsx("div",{className:"spotify-square-dock-title",children:s.title||s.mood})})]})},bv=({isPlaying:s,canPrevious:e,canNext:t,shuffle:n,repeat:i,onPlayPause:a,onPrevious:o,onNext:l,onShuffle:c,onRepeat:u,expanded:d=!1})=>{const h=()=>r.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:r.jsx("polygon",{points:"8,6 8,18 18,12"})}),m=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),r.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),f=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),r.jsx("polygon",{points:"18,6 10,12 18,18"})]}),p=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("polygon",{points:"6,6 14,12 6,18"}),r.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),g=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),r.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),v=()=>r.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[r.jsx("path",{d:"M7 7h10v4"}),r.jsx("path",{d:"M17 17H7v-4"}),r.jsx("path",{d:"M17 7l3 3-3 3"}),r.jsx("path",{d:"M7 17l-3-3 3-3"})]});return r.jsxs("div",{className:`playback-controls ${d?"expanded":""}`,children:[d&&r.jsx("button",{className:`control-button secondary ${n?"active":""}`,onClick:c,"aria-label":"Shuffle",title:"Shuffle",children:r.jsx(g,{})}),r.jsx("button",{className:"control-button",onClick:o,disabled:!e,"aria-label":"Previous",title:"Previous track",children:r.jsx(f,{})}),r.jsx("button",{className:"control-button primary",onClick:a,"aria-label":s?"Pause":"Play",title:s?"Pause":"Play",children:s?r.jsx(m,{}):r.jsx(h,{})}),r.jsx("button",{className:"control-button",onClick:l,disabled:!t,"aria-label":"Next",title:"Next track",children:r.jsx(p,{})}),d&&r.jsxs("button",{className:`control-button secondary ${i!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${i}`,title:`Repeat: ${i}`,children:[r.jsx(v,{}),i==="one"&&r.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},xv=({currentTime:s,duration:e,onSeek:t,color:n="#D4AF37"})=>{const[i,a]=_.useState(!1),o=_.useRef(null),l=f=>{if(!isFinite(f)||f<0)return"0:00";const p=Math.floor(f/60),g=Math.floor(f%60);return`${p}:${g.toString().padStart(2,"0")}`},c=f=>{if(!o.current||e===0)return;const p=o.current.getBoundingClientRect(),g=f-p.left,b=Math.max(0,Math.min(1,g/p.width))*e;t(b)},u=f=>{a(!0),c(f.clientX)},d=f=>{i&&c(f.clientX)},h=()=>{a(!1)};R.useEffect(()=>{if(i)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",h),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",h)}},[i]);const m=e>0?s/e*100:0;return r.jsxs("div",{className:"seek-bar-container",children:[r.jsx("span",{className:"seek-time current",children:l(s)}),r.jsx("div",{ref:o,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":s,children:r.jsx("div",{className:"seek-progress",style:{width:`${m}%`,background:`linear-gradient(90deg, ${n}cc, ${n})`},children:r.jsx("div",{className:"seek-thumb"})})}),r.jsx("span",{className:"seek-time total",children:l(e)})]})},_v=({volume:s,isMuted:e,onVolumeChange:t,onMuteToggle:n,expanded:i=!1})=>{const[a,o]=_.useState(!1),l=_.useRef(null),c=e||s===0?"muted":s<.5?"low":"high",u=p=>{if(!l.current)return;const g=l.current.getBoundingClientRect(),v=p-g.left,b=Math.max(0,Math.min(1,v/g.width));t(b)},d=p=>{o(!0),u(p.clientX)},h=p=>{a&&u(p.clientX)},m=()=>{o(!1)};R.useEffect(()=>{if(a)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",m),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",m)}},[a]);const f=e?0:s;return r.jsxs("div",{className:`volume-control ${i?"expanded":""}`,children:[r.jsxs("button",{className:`volume-icon ${c}`,onClick:n,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[r.jsx("span",{className:"volume-core"}),r.jsx("span",{className:"volume-wave wave-1"}),r.jsx("span",{className:"volume-wave wave-2"})]}),r.jsx("div",{ref:l,className:"volume-slider",onMouseDown:d,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(f*100),children:r.jsx("div",{className:"volume-fill",style:{width:`${f*100}%`},children:r.jsx("div",{className:"volume-thumb"})})})]})},wv=({queue:s,currentIndex:e,onSkipTo:t})=>{const n=s.slice(e+1,e+4);if(n.length===0)return null;const i=a=>{const o=Math.floor(a/60),l=Math.floor(a%60);return`${o}:${l.toString().padStart(2,"0")}`};return r.jsxs("div",{className:"queue-preview",children:[r.jsx("div",{className:"queue-label",children:"Up Next"}),r.jsx("div",{className:"queue-items",children:n.map((a,o)=>r.jsx("div",{className:"queue-item",onClick:()=>t(e+o+1),role:"button",tabIndex:0,onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t(e+o+1))},children:r.jsx(ls,{variant:"compact",className:"queue-album-card",title:a.title||a.mood,mood:a.mood,imageUrl:a.imageDataURL,meta:i(a.musicMetadata?.duration||a.duration),badges:[...a.musicData?[{label:"再生",tone:"success"}]:[],...a.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...a.isPublic?[{label:"公開",tone:"info"}]:[]]})},a.id))})]})};class Nv{static draw(e,t,n,i,a,o){const l=this.smoothData(t);this.drawGrid(e,n,i),e.lineWidth=3,e.strokeStyle=this.getGradient(e,a,n),e.shadowBlur=o?8:4,e.shadowColor=a,e.beginPath();const c=n/l.length;let u=0;for(let d=0;d<l.length;d++){const m=l[d]/128*i/2;if(d===0)e.moveTo(u,m);else{const f=(u+c*d)/2,p=(m+l[d-1]/128*i/2)/2;e.quadraticCurveTo(u,l[d-1]/128*i/2,f,p)}u=c*d}e.lineTo(n,i/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-i),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let i=0;i<e.length;i++){let a=0,o=0;for(let l=-3;l<=3;l++){const c=i+l;c>=0&&c<e.length&&(a+=e[c],o++)}t.push(a/o)}return t}static drawGrid(e,t,n){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const i=5;for(let a=0;a<i;a++){const o=n/(i-1)*a;e.beginPath(),e.moveTo(0,o),e.lineTo(t,o),e.stroke()}}static getGradient(e,t,n){const i=e.createLinearGradient(0,0,n,0);return i.addColorStop(0,t),i.addColorStop(.5,this.lightenColor(t,20)),i.addColorStop(1,t),i}static lightenColor(e,t){const n=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),a=Math.min(255,(n>>16&255)+i),o=Math.min(255,(n>>8&255)+i),l=Math.min(255,(n&255)+i);return`#${(a<<16|o<<8|l).toString(16).padStart(6,"0")}`}}class _c{static draw(e,t,n,i,a,o){const h=(n-640)/2,m=Math.floor(t.length/64),f=[];for(let v=0;v<64;v++){let b=0;for(let S=0;S<m;S++){const A=v*m+S;A<t.length&&(b+=t[A])}const w=b/m;f.push(w)}const p=this.smoothTransitions(f),g=this.createBarGradient(e,a,64,10,h);for(let v=0;v<64;v++){const b=h+v*10,w=p[v]/255*(i*.4);e.fillStyle=g,this.drawRoundedBar(e,b,i/2-w,8,w,4),o&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,b,i/2+2,8,w*.5,4),e.restore()),e.shadowBlur=o?4:0,e.shadowColor=a}e.shadowBlur=0,o&&this.drawParticles(e,p,h,10,i,a)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],n=.7;for(let i=0;i<e.length;i++){const a=this.previousHeights[i]||0,o=e[i],l=a*n+o*(1-n);t.push(l)}return this.previousHeights=t,t}static drawRoundedBar(e,t,n,i,a,o){e.beginPath(),e.moveTo(t,n+a),e.lineTo(t,n+o),e.arcTo(t,n,t+i,n,o),e.lineTo(t+i,n+o),e.arcTo(t+i,n,t+i,n+a,o),e.lineTo(t+i,n+a),e.closePath(),e.fill()}static createBarGradient(e,t,n,i,a){const o=e.createLinearGradient(a,0,a+n*i,0);return o.addColorStop(0,t),o.addColorStop(.5,this.adjustHue(t,30)),o.addColorStop(1,this.adjustHue(t,60)),o}static drawParticles(e,t,n,i,a,o){for(let c=0;c<t.length;c++)if(t[c]>200){const u=n+c*i+i/2,d=t[c]/255*(a*.4),h=a/2-d-10;e.fillStyle=o,e.globalAlpha=.5,e.beginPath(),e.arc(u,h,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const n=parseInt(e.replace("#",""),16),i=n>>16&255,a=n>>8&255,o=n&255,l=1+t/360,c=Math.min(255,i*l),u=Math.min(255,a*l),d=Math.min(255,o*l);return`#${(Math.floor(c)<<16|Math.floor(u)<<8|Math.floor(d)).toString(16).padStart(6,"0")}`}}jt(_c,"previousHeights",[]);class wc{static draw(e,t,n,i,a,o){const l=n/2,c=i/2,u=Math.min(n,i)*.15,d=Math.min(n,i)*.45;o&&(this.rotation+=360/(60*60));const h=Math.min(t.length,180),m=Math.PI*2/h;for(let f=0;f<h;f++){const p=t[Math.floor(f*(t.length/h))],g=p/255*(d-u),v=f*m+this.rotation*(Math.PI/180),b=l+Math.cos(v)*u,w=c+Math.sin(v)*u,S=l+Math.cos(v)*(u+g),A=c+Math.sin(v)*(u+g),x=f/h*360;if(e.strokeStyle=`hsla(${x}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(b,w),e.lineTo(S,A),e.stroke(),o&&p>200){const T=l+Math.cos(v)*(u+g+5),k=c+Math.sin(v)*(u+g+5);e.fillStyle=`hsla(${x}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(T,k,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=a,e.lineWidth=2,e.beginPath(),e.arc(l,c,u,0,Math.PI*2),e.stroke(),o){const f=this.getAverageAmplitude(t),p=d+f/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=a,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=a,e.beginPath(),e.arc(l,c,p,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t/e.length}}jt(wc,"rotation",0);const Sv=({mode:s,frequencyData:e,timeDomainData:t,isPlaying:n,dominantColor:i="#D4AF37",width:a=800,height:o=200,mini:l=!1})=>{const c=_.useRef(null),u=_.useRef(null),d=_.useRef(0);return _.useEffect(()=>{const h=c.current;if(!h)return;const m=h.getContext("2d");if(!m)return;const f=l?1:Math.min(window.devicePixelRatio||1,2);h.width=a*f,h.height=o*f,h.style.width=`${a}px`,h.style.height=`${o}px`,m.scale(f,f);const g=1e3/(l?30:60),v=b=>{if(b-d.current<g){u.current=requestAnimationFrame(v);return}d.current=b,m.clearRect(0,0,a,o),s==="waveform"&&t?Nv.draw(m,t,a,o,i,n):s==="spectrum"&&e?_c.draw(m,e,a,o,i,n):s==="radial"&&e&&wc.draw(m,e,a,o,i,n),u.current=requestAnimationFrame(v)};return u.current=requestAnimationFrame(v),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[s,e,t,n,i,a,o,l]),r.jsx("canvas",{ref:c,style:{display:"block",margin:"0 auto",borderRadius:l?"4px":"8px"}})},kv=({tags:s,centerX:e,centerY:t,isPlaying:n})=>{const[i,a]=_.useState([]),o=_.useRef(null),l=_.useRef(Date.now());_.useEffect(()=>{const u=[220,260,300,340,380],d=[12,10,8,6,4],h=s.map((f,p)=>360/s.length*p),m=s.slice(0,5).map((f,p)=>({text:f,radius:u[p]||300,speed:d[p]||8,angle:h[p]||0,scale:1,opacity:.6}));a(m)},[s]),_.useEffect(()=>{if(!n){o.current!==null&&(cancelAnimationFrame(o.current),o.current=null);return}const u=()=>{const d=Date.now(),h=(d-l.current)/1e3;l.current=d,a(m=>m.map((f,p)=>{let g=f.angle+f.speed*h;g=g%360;const v=p*.5,w=1+Math.sin((d/3e3+v)*Math.PI*2)*.05,S=.55+Math.sin((d/3e3+v)*Math.PI*2)*.15;return{...f,angle:g,scale:w,opacity:S}})),o.current=requestAnimationFrame(u)};return o.current=requestAnimationFrame(u),()=>{o.current!==null&&cancelAnimationFrame(o.current)}},[n]);const c=u=>u*Math.PI/180;return r.jsx("div",{className:"motif-orbit",children:i.map((u,d)=>{const h=e+u.radius*Math.cos(c(u.angle)),m=t+u.radius*Math.sin(c(u.angle));return r.jsx("div",{className:"motif-tag",style:{left:`${h}px`,top:`${m}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${d}`)})})},jv=({album:s,isPlaying:e,currentTime:t,duration:n,volume:i,isMuted:a,shuffle:o,repeat:l,canPrevious:c,canNext:u,visualizationMode:d,queue:h,queueIndex:m,frequencyData:f,timeDomainData:p,onPlayPause:g,onPrevious:v,onNext:b,onSeek:w,onVolumeChange:S,onMuteToggle:A,onShuffle:x,onRepeat:T,onVisualizationModeChange:k,onSkipToIndex:y,onClose:j})=>{const{updateAlbum:C}=Lt(),O=s?.id||null,[P,U]=_.useState("");_.useEffect(()=>{U(s?.memo||"")},[O]),_.useEffect(()=>{const F=X=>{X.key==="Escape"?j():X.key===" "&&X.target===document.body?(X.preventDefault(),g()):X.key==="ArrowLeft"?w(Math.max(0,t-5)):X.key==="ArrowRight"?w(Math.min(n,t+5)):X.key==="ArrowUp"?S(Math.min(1,i+.1)):X.key==="ArrowDown"?S(Math.max(0,i-.1)):X.key==="m"||X.key==="M"?A():X.key==="n"||X.key==="N"?b():(X.key==="p"||X.key==="P")&&v()};return document.addEventListener("keydown",F),()=>document.removeEventListener("keydown",F)},[t,n,i,j,g,w,S,A,b,v]);const E="#D4AF37",I=s?.metadata?.motif_tags||[],V=_.useMemo(()=>"メモ（ひとこと）。聴きながら思い出したこと、今の気分、景色…",[]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"expanded-player-backdrop",onClick:j}),r.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[r.jsx("button",{className:"expanded-player-close",onClick:j,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),r.jsx("button",{className:"expanded-player-minimize",onClick:j,"aria-label":"Minimize player",title:"Minimize",children:"-"}),r.jsxs("div",{className:"expanded-player-content",children:[r.jsxs("div",{className:"expanded-player-album-section",children:[r.jsx("div",{className:"expanded-player-album-container",children:s&&r.jsxs(r.Fragment,{children:[r.jsx("img",{src:s.imageDataURL,alt:s.title||s.mood,className:"expanded-player-album-image"}),I.length>0&&r.jsx(kv,{tags:I,centerX:200,centerY:200,isPlaying:e})]})}),s&&r.jsxs("div",{className:"expanded-player-album-meta",children:[r.jsx("h2",{className:"expanded-player-album-title",children:s.title||s.mood}),s.musicMetadata&&r.jsxs("p",{className:"expanded-player-album-details",children:[s.musicMetadata.key," • ",s.musicMetadata.tempo," BPM • ",s.musicMetadata.timeSignature]}),s.musicMetadata?.character&&r.jsx("p",{className:"expanded-player-album-character",children:s.musicMetadata.character}),r.jsxs("div",{className:"expanded-player-memo",children:[r.jsx("div",{className:"expanded-player-memo-label",children:"メモ"}),r.jsx("textarea",{className:"expanded-player-memo-input",value:P,onChange:F=>U(F.target.value),onBlur:()=>{if(!s)return;const F=P.trim();(s.memo||"")!==F&&C(s.id,{memo:F||void 0})},placeholder:V,rows:2})]})]})]}),r.jsxs("div",{className:"expanded-player-visualization-section",children:[r.jsx(Sv,{mode:d,frequencyData:f,timeDomainData:p,isPlaying:e,dominantColor:E,width:800,height:200}),r.jsxs("div",{className:"visualization-mode-toggle",children:[r.jsx("button",{className:d==="waveform"?"active":"",onClick:()=>k("waveform"),title:"Waveform",children:"波形"}),r.jsx("button",{className:d==="spectrum"?"active":"",onClick:()=>k("spectrum"),title:"Spectrum Bars",children:"バー"}),r.jsx("button",{className:d==="radial"?"active":"",onClick:()=>k("radial"),title:"Radial Spectrum",children:"円形"})]})]}),r.jsxs("div",{className:"expanded-player-controls-section",children:[r.jsx(bv,{isPlaying:e,canPrevious:c,canNext:u,shuffle:o,repeat:l,onPlayPause:g,onPrevious:v,onNext:b,onShuffle:x,onRepeat:T,expanded:!0}),r.jsx(xv,{currentTime:t,duration:n,onSeek:w,color:E}),r.jsx(_v,{volume:i,isMuted:a,onVolumeChange:S,onMuteToggle:A,expanded:!0})]}),r.jsx(wv,{queue:h,currentIndex:m,onSkipTo:y})]})]})]})},Tv=({album:s,queue:e=[]})=>{const{state:t,setPlaybackState:n,setCurrentTime:i,setDuration:a,setVolume:o,toggleMute:l,toggleShuffle:c,cycleRepeat:u,toggleExpanded:d,setVisualizationMode:h,play:m,pause:f,next:p,previous:g,skipToIndex:v,setQueue:b,setCurrentAlbumFull:w}=ts(),S=_.useRef(vv()),A=_.useRef(null),x=_.useRef(null),T=_.useRef(null),k=_.useRef(null),y=_.useRef(0),j=_.useRef(0),[C,O]=_.useState(null),[P,U]=_.useState(null);_.useEffect(()=>((async()=>{try{await lc();const N=Cg.createAnalyser();N.fftSize=2048,N.smoothingTimeConstant=.8,Tg().connect(N),A.current=N,x.current=new Uint8Array(N.frequencyBinCount),T.current=new Uint8Array(N.frequencyBinCount)}catch(N){console.error("Failed to initialize analyser:",N)}})(),()=>{if(A.current)try{A.current.disconnect()}catch{}}),[]),_.useEffect(()=>{if(e.length>0){const D=s?e.findIndex(N=>N.id===s.id):0;b(e,Math.max(0,D))}else s&&b([s],0)},[s,e,b]),_.useEffect(()=>{const D=t.currentAlbum||s;D?.musicData&&(E(D),w(D))},[t.currentAlbum?.id,s?.id]),_.useEffect(()=>{t.playRequestId>0&&(y.current=t.playRequestId)},[t.playRequestId]),_.useEffect(()=>{const D=t.currentAlbum||s,N=y.current;if(!D?.musicData||N===0||N===j.current)return;let G=!1;return(async()=>{try{if(await E(D),G)return;await I(),j.current=N}catch(ce){console.error("[EnhancedMiniPlayer] Autoplay failed:",ce)}})(),()=>{G=!0}},[t.currentAlbum?.id,s?.id,t.playRequestId]),_.useEffect(()=>{if(t.playbackState===Tt.PLAYING&&A.current){let D;const N=()=>{!A.current||!x.current||!T.current||(A.current.getByteFrequencyData(x.current),A.current.getByteTimeDomainData(T.current),O(new Uint8Array(x.current)),U(new Uint8Array(T.current)),D=requestAnimationFrame(N))};return D=requestAnimationFrame(N),()=>{D&&cancelAnimationFrame(D)}}},[t.playbackState]);const E=async D=>{try{const N=S.current;await N.loadMIDI(D.musicData);const G=N.getState();a(G.duration)}catch(N){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",N)}},I=async()=>{try{n(Tt.LOADING);const D=S.current;await D.play(),m();const N=window.setInterval(()=>{const G=D.getState();i(G.currentTime),a(G.duration),!G.isPlaying&&!G.isPaused&&(clearInterval(N),F())},100);k.current=N}catch(D){console.error("Failed to start playback:",D),n(Tt.STOPPED)}},V=()=>{S.current.pause(),f(),k.current&&(clearInterval(k.current),k.current=null)},F=()=>{t.repeat==="one"?(H(0),I()):z()},X=()=>{t.playbackState===Tt.PLAYING?V():I()},z=()=>{p(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{I()})})},L=()=>{g(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{I()})})},H=D=>{S.current.seek(D),i(D)},Y=D=>{o(D)},ee=D=>{v(D),requestAnimationFrame(()=>{requestAnimationFrame(()=>{I()})})},se=t.queueIndex>0||t.repeat==="all",B=t.queueIndex<t.queue.length-1||t.repeat==="all",M=t.playbackState===Tt.PLAYING;return _.useEffect(()=>()=>{k.current&&clearInterval(k.current)},[]),r.jsxs(r.Fragment,{children:[!t.isExpanded&&r.jsx(yv,{album:t.currentAlbum,isPlaying:M,currentTime:t.currentTime,duration:t.duration,onPlayPause:X,onExpand:d}),t.isExpanded&&r.jsx(jv,{album:t.currentAlbum,isPlaying:M,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:se,canNext:B,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:C,timeDomainData:P,onPlayPause:X,onPrevious:L,onNext:z,onSeek:H,onVolumeChange:Y,onMuteToggle:l,onShuffle:c,onRepeat:u,onVisualizationModeChange:h,onSkipToIndex:ee,onClose:d})]})};function Cv(){const{state:s}=ts(),e=!!s.currentAlbumImage&&(s.playbackState===Tt.PLAYING||s.playbackState===Tt.PAUSED),t=_.useMemo(()=>`${s.currentAlbum?.id||"none"}:${s.playbackState}`,[s.currentAlbum?.id,s.playbackState]),[n,i]=_.useState(!1);return _.useEffect(()=>{const a=window.setTimeout(()=>i(e),e?40:0);return()=>window.clearTimeout(a)},[e]),s.currentAlbumImage?r.jsx("div",{className:`playback-backdrop ${n?"is-active":""} ${s.playbackState===Tt.PLAYING?"is-playing":""}`,style:{backgroundImage:`url(${s.currentAlbumImage})`},"aria-hidden":"true"},t):null}function Iv({active:s,scopeLabel:e,statusText:t,elapsedSec:n=0,onCancel:i}){if(!s)return null;const o=.85-.35*Math.max(0,Math.min(1,n/22));return r.jsxs("div",{className:"gen-frost",style:{"--frost":o},"aria-live":"polite","aria-busy":"true",children:[r.jsx("div",{className:"gen-frost-surface"}),r.jsxs("div",{className:"gen-frost-card",role:"status",children:[r.jsxs("div",{className:"gen-frost-title",children:[r.jsx("span",{className:"gen-frost-title-main",children:"生成中"}),e?r.jsx("span",{className:"gen-frost-scope",children:e}):null]}),r.jsxs("div",{className:"gen-frost-status",children:[t||"進行中…",r.jsxs("span",{className:"gen-frost-elapsed",children:["（",n,"s）"]})]}),i?r.jsx("button",{className:"gen-frost-cancel",onClick:i,type:"button",children:"キャンセル"}):null]})]})}function Av(){const{current:s}=oi();return r.jsx(Iv,{active:s.active,scopeLabel:s.scopeLabel,statusText:s.statusText,elapsedSec:s.elapsedSec,onCancel:s.onCancel})}function Mv(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function Ev(){try{new Function('return import("web-vitals")')().then(e=>{const t=n=>{console.log("[Web Vitals]",n)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}function Ov(){const s=document.createElement("script");s.type="module",s.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const e=document.createElement("script");e.type="module",e.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(s),document.head.appendChild(e)}Mv(),Ev(),Ov();const Pv="airia_onboarding_data",Dv="airia_theme",Ra="airia_post_onboarding_room",zt="airia_preauth_view_v1";function Fa(){try{const s=String(window.location.hash||"").trim().toLowerCase();return s==="#terms"?"terms":s==="#privacy"?"privacy":s==="#login"||s==="#signup"?"auth":null}catch{return null}}function Rv(){try{const s=localStorage.getItem(Dv),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=s||"system",n=t==="system"?e?"dark":"light":t;document.documentElement.setAttribute("data-theme",n)}catch{document.documentElement.setAttribute("data-theme","light")}}function La(){try{if(Qs())return!1;const s=localStorage.getItem(Pv);return s?!!JSON.parse(s)?.completedAt:!1}catch{return!1}}function Fv(){try{const s=localStorage.getItem(Ra);if(!s)return null;localStorage.removeItem(Ra);const e=String(s);return["main","gallery","album","music","social","me","settings","admin","info","feedback"].includes(e)?e:null}catch{return null}}const Lv=()=>{const[s,e]=_.useState(!0),[t,n]=_.useState(()=>{try{const x=Fa();if(x)return x;const T=sessionStorage.getItem(zt);return T==="auth"||T==="terms"||T==="privacy"?T:"landing"}catch{return"landing"}}),[i,a]=_.useState(()=>{try{return La()}catch{return!1}}),{getSelectedAlbum:o,albums:l}=Lt(),{state:c}=ts(),{user:u,bootLoading:d}=nr(),h=o();_.useEffect(()=>{const x=()=>{const T=Fa();if(T){n(T);try{sessionStorage.setItem(zt,T)}catch{}return}try{const y=sessionStorage.getItem(zt)==="auth"?"auth":"landing";n(y),sessionStorage.setItem(zt,y)}catch{n("landing")}};return window.addEventListener("hashchange",x),()=>window.removeEventListener("hashchange",x)},[]);const m=R.useCallback(()=>{n("auth");try{sessionStorage.setItem(zt,"auth"),window.location.hash="#login"}catch{}},[]),f=R.useCallback(()=>{n("landing");try{sessionStorage.setItem(zt,"landing"),window.location.hash=""}catch{}},[]),p=R.useCallback(()=>{n("terms");try{sessionStorage.setItem(zt,"terms"),window.location.hash="#terms"}catch{}},[]),g=R.useCallback(()=>{n("privacy");try{sessionStorage.setItem(zt,"privacy"),window.location.hash="#privacy"}catch{}},[]);_.useEffect(()=>{Rv()},[]);const v=l.filter(x=>x.musicData),b=!!(tn()||"".toLowerCase()==="true"),w=i?[{id:"main",name:"Main",component:r.jsx(Ql,{})},{id:"gallery",name:"Gallery",component:r.jsx(ou,{})},{id:"album",name:"Album",component:r.jsx(mu,{})},{id:"music",name:"Music",component:r.jsx(pu,{})},{id:"social",name:"Social",component:r.jsx(Nu,{})},{id:"me",name:"My",component:r.jsx(Tu,{})},...b?[{id:"admin",name:"Admin",component:r.jsx(Au,{})}]:[],{id:"info",name:"Info",component:r.jsx(Pu,{})},{id:"feedback",name:"Feedback",component:r.jsx(Du,{})}]:[{id:"onboarding",name:"はじめに",component:r.jsx(Wl,{onExit:()=>{a(La())}})}],S=i?Fv()??"main":null,A=i?S==="settings"?"me":S:"onboarding";return r.jsxs(r.Fragment,{children:[s&&r.jsx(Ru,{onDismiss:()=>e(!1)}),!s&&r.jsxs(r.Fragment,{children:[r.jsx(Cv,{}),r.jsxs("div",{className:"app-ui-layer",children:[r.jsx(Av,{}),d?r.jsx("div",{className:"preauth-shell",children:r.jsx("div",{className:"loading-panel","aria-live":"polite","aria-busy":"true",children:r.jsx("div",{className:"loading-card",children:r.jsxs("div",{className:"loading-row",children:[r.jsx("div",{className:"loading-spinner","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("p",{className:"loading-title",children:"ログイン状態を確認しています…"}),r.jsx("p",{className:"loading-sub",children:"通信環境によっては時間がかかる場合があります。画面はこのままでお待ちください。"})]})]})})})}):u?r.jsxs(r.Fragment,{children:[r.jsx(ol,{rooms:w,initialRoom:A},i?"onboarded":"needs-onboarding"),r.jsx(Tv,{album:h||void 0,queue:v})]}):r.jsx("div",{className:"preauth-shell",children:t==="auth"?r.jsx($l,{onBack:f}):t==="terms"?r.jsx(ua,{kind:"terms",onBack:f,onStart:m}):t==="privacy"?r.jsx(ua,{kind:"privacy",onBack:f,onStart:m}):r.jsx(zl,{onStart:m,onOpenTerms:p,onOpenPrivacy:g})})]})]})]})},Vv=()=>r.jsx(R.StrictMode,{children:r.jsx(Zc,{children:r.jsx(Vc,{children:r.jsx(Yc,{children:r.jsx(Dc,{children:r.jsx(Xc,{children:r.jsx(Jc,{children:r.jsx(ql,{children:r.jsx(Lv,{})})})})})})})})});Pc.createRoot(document.getElementById("root")).render(r.jsx(Vv,{}));
//# sourceMappingURL=index-_iisWvlG.js.map
