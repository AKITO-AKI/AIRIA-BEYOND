var da=Object.defineProperty;var pa=(n,e,t)=>e in n?da(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Ye=(n,e,t)=>pa(n,typeof e!="symbol"?e+"":e,t);import{r as T,j as a,C as $t,u as jt,B as is,V as Ws,L as ma,a as fa,b as di,M as ga,c as _a,T as va,S as ya,d as pi,e as gn,R as K,f as ba,g as xa}from"./vendor-three-h5bJxvVc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const mi=n=>{if(!n)return 30;const e=20,t=60,s=30,i=180,r=Math.max(s,Math.min(i,n));return e+(r-s)/(i-s)*(t-e)},wa=n=>{const t=Math.floor(n/10),s=n%10;return{shelfIndex:Math.min(t,4),positionIndex:s}},fi=n=>{const e=["#4A90E2","#E24A90","#90E24A","#E2904A","#904AE2","#4AE290"];let t=0;for(let s=0;s<n.length;s++)t=(t<<5)-t+n.charCodeAt(s),t=t&t;return e[Math.abs(t)%e.length]},Wi=T.createContext(void 0),gi="airia-albums",Ta=({children:n})=>{const[e,t]=T.useState([]),[s,i]=T.useState(null);T.useEffect(()=>{try{const u=localStorage.getItem(gi);if(u){const h=JSON.parse(u);t(h)}}catch(u){console.error("Failed to load albums from localStorage:",u)}},[]),T.useEffect(()=>{try{localStorage.setItem(gi,JSON.stringify(e))}catch(u){console.error("Failed to save albums to localStorage:",u)}},[e]);const r=u=>{const h={...u,isPublic:u.isPublic??!1,isFavorite:u.isFavorite??!1,id:`album_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,createdAt:new Date().toISOString()};t(d=>[h,...d].map((p,m)=>{const g=wa(m),_=mi(p.musicMetadata?.duration),y=p.gallery?.spineColor||fi(p.imageDataURL);return{...p,gallery:{shelfIndex:g.shelfIndex,positionIndex:g.positionIndex,thickness:_,spineColor:y}}}))},c=(u,h)=>{t(d=>d.map(f=>{if(f.id!==u)return f;const p={...f,...h};if(h.imageDataURL){const m=p.gallery?.spineColor||fi(p.imageDataURL);return{...p,gallery:{...p.gallery||{shelfIndex:0,positionIndex:0,thickness:mi(p.musicMetadata?.duration),spineColor:m},spineColor:m}}}return p}))},o=u=>{i(u)},l=()=>s&&e.find(u=>u.id===s)||null;return a.jsx(Wi.Provider,{value:{albums:e,selectedAlbumId:s,addAlbum:r,updateAlbum:c,selectAlbum:o,getSelectedAlbum:l},children:n})},Nt=()=>{const n=T.useContext(Wi);if(n===void 0)throw new Error("useAlbums must be used within an AlbumProvider");return n},Bi=T.createContext(void 0),pn="airia-causal-logs",Na=30;function Sa(n){return n&&{mood:n.mood,duration:n.duration,timestamp:n.timestamp,customInput:n.customInput?"[user input - redacted for privacy]":void 0,onboardingAnswers:n.onboardingAnswers?"[onboarding data - summary only]":void 0}}function ka(n){const e=new Date;return e.setDate(e.getDate()-Na),n.filter(t=>new Date(t.createdAt)>=e)}const Ca=({children:n})=>{const[e,t]=T.useState([]);T.useEffect(()=>{try{const d=localStorage.getItem(pn);if(d){const p=JSON.parse(d).map(g=>({...g,createdAt:new Date(g.createdAt),input:{...g.input,timestamp:new Date(g.input.timestamp)},analysis:g.analysis?{...g.analysis,timestamp:new Date(g.analysis.timestamp)}:void 0,imageGeneration:g.imageGeneration?{...g.imageGeneration,timestamp:new Date(g.imageGeneration.timestamp)}:void 0,musicGeneration:g.musicGeneration?{...g.musicGeneration,timestamp:new Date(g.musicGeneration.timestamp)}:void 0,album:g.album?{...g.album,timestamp:new Date(g.album.timestamp)}:void 0,errors:g.errors?.map(_=>({..._,timestamp:new Date(_.timestamp)}))})),m=ka(p);t(m)}}catch(d){console.error("[CausalLog] Failed to load logs from localStorage:",d)}},[]),T.useEffect(()=>{try{localStorage.setItem(pn,JSON.stringify(e))}catch(d){console.error("[CausalLog] Failed to save logs to localStorage:",d)}},[e]);const s=(d,f)=>{const p=`log_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,m={id:p,sessionId:d,createdAt:new Date,input:Sa(f),totalDuration:0,success:!1};return t(g=>[...g,m]),console.log("[CausalLog] Created log:",p,"for session:",d),p},i=d=>e.find(f=>f.id===d),r=d=>e.find(f=>f.sessionId===d),c=(d,f)=>{t(p=>p.map(m=>{if(m.id===d){const g={...m,...f};if(g.analysis||g.imageGeneration||g.musicGeneration){const _=[g.analysis?.duration||0,g.imageGeneration?.duration||0,g.musicGeneration?.duration||0];g.totalDuration=_.reduce((y,w)=>y+w,0)}return g}return m})),console.log("[CausalLog] Updated log:",d)},o=d=>{t(f=>f.filter(p=>p.id!==d)),console.log("[CausalLog] Deleted log:",d)},l=()=>{t([]),localStorage.removeItem(pn),console.log("[CausalLog] Cleared all logs")},u=()=>e.map(d=>({id:d.id,sessionId:d.sessionId,createdAt:d.createdAt,success:d.success,totalDuration:d.totalDuration,albumId:d.album?.albumId})),h=d=>{const f=i(d);if(!f)throw new Error(`Log ${d} not found`);return JSON.stringify(f,null,2)};return a.jsx(Bi.Provider,{value:{logs:e,createLog:s,getLog:i,getLogBySessionId:r,updateLog:c,deleteLog:o,clearAllLogs:l,getLogSummaries:u,exportLog:h},children:n})},jn=()=>{const n=T.useContext(Bi);if(n===void 0)throw new Error("useCausalLog must be used within a CausalLogProvider");return n};var bt=(n=>(n.STOPPED="STOPPED",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.LOADING="LOADING",n))(bt||{});const Ui=T.createContext(void 0),Aa=.7,ja=({children:n})=>{const[e,t]=T.useState({playbackState:"STOPPED",currentAlbum:null,currentAlbumImage:void 0,currentTrackTitle:void 0,queue:[],queueIndex:-1,currentTime:0,duration:0,volume:Aa,isMuted:!1,shuffle:!1,repeat:"off",isExpanded:!1,visualizationMode:"waveform",playRequestId:0}),s=T.useCallback(v=>{t(k=>({...k,playbackState:v?"PLAYING":"PAUSED"}))},[]),i=T.useCallback((v,k)=>{t(x=>({...x,currentAlbumImage:v,currentTrackTitle:k}))},[]),r=T.useCallback(v=>{t(k=>({...k,playbackState:v}))},[]),c=T.useCallback(v=>{t(k=>({...k,currentAlbum:v,currentAlbumImage:v?.imageDataURL,currentTrackTitle:v?v.title||v.mood:void 0}))},[]),o=T.useCallback((v,k=0)=>{t(x=>({...x,queue:v,queueIndex:k,currentAlbum:v[k]||null,currentAlbumImage:v[k]?.imageDataURL,currentTrackTitle:v[k]?v[k].title||v[k].mood:void 0}))},[]),l=T.useCallback(v=>{t(k=>({...k,currentTime:v}))},[]),u=T.useCallback(v=>{t(k=>({...k,duration:v}))},[]),h=T.useCallback(v=>{const k=Math.max(0,Math.min(1,v));t(x=>({...x,volume:k}))},[]),d=T.useCallback(()=>{t(v=>({...v,isMuted:!v.isMuted}))},[]),f=T.useCallback(()=>{t(v=>({...v,shuffle:!v.shuffle}))},[]),p=T.useCallback(()=>{t(v=>{const k=["off","all","one"],j=(k.indexOf(v.repeat)+1)%k.length;return{...v,repeat:k[j]}})},[]),m=T.useCallback(()=>{t(v=>({...v,isExpanded:!v.isExpanded}))},[]),g=T.useCallback(v=>{t(k=>({...k,isExpanded:v}))},[]),_=T.useCallback(v=>{t(k=>({...k,visualizationMode:v}))},[]),y=T.useCallback((v,k)=>{t(x=>{const j=k&&k.length>0?k:x.queue,M=j.length>0?j:[v],O=Math.max(0,M.findIndex(q=>q.id===v.id)),D=M[O]||v;return{...x,queue:M,queueIndex:O,currentAlbum:D,currentAlbumImage:D.imageDataURL,currentTrackTitle:D.title||D.mood,currentTime:0,playRequestId:x.playRequestId+1,isExpanded:!0}})},[]),w=T.useCallback(()=>{t(v=>({...v,playbackState:"PLAYING"}))},[]),N=T.useCallback(()=>{t(v=>({...v,playbackState:"PAUSED"}))},[]),A=T.useCallback(()=>{t(v=>({...v,playbackState:"STOPPED",currentTime:0}))},[]),b=T.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;let k=v.queueIndex+1;if(k>=v.queue.length)if(v.repeat==="all")k=0;else return{...v,playbackState:"STOPPED"};const x=v.queue[k];return{...v,queueIndex:k,currentAlbum:x,currentAlbumImage:x.imageDataURL,currentTrackTitle:x.mood,currentTime:0}})},[]),S=T.useCallback(()=>{t(v=>{if(v.queue.length===0)return v;if(v.currentTime>3)return{...v,currentTime:0};let k=v.queueIndex-1;if(k<0)if(v.repeat==="all")k=v.queue.length-1;else return v;const x=v.queue[k];return{...v,queueIndex:k,currentAlbum:x,currentAlbumImage:x.imageDataURL,currentTrackTitle:x.mood,currentTime:0}})},[]),C=T.useCallback(v=>{t(k=>{if(v<0||v>=k.queue.length)return k;const x=k.queue[v];return{...k,queueIndex:v,currentAlbum:x,currentAlbumImage:x.imageDataURL,currentTrackTitle:x.mood,currentTime:0}})},[]);return a.jsx(Ui.Provider,{value:{state:e,setPlaying:s,setCurrentAlbum:i,setPlaybackState:r,setCurrentAlbumFull:c,setQueue:o,setCurrentTime:l,setDuration:u,setVolume:h,toggleMute:d,toggleShuffle:f,cycleRepeat:p,toggleExpanded:m,setExpanded:g,setVisualizationMode:_,requestPlayAlbum:y,play:w,pause:N,stop:A,next:b,previous:S,skipToIndex:C},children:n})},rs=()=>{const n=T.useContext(Ui);if(!n)throw new Error("useMusicPlayer must be used within MusicPlayerProvider");return n},Ma=T.createContext(void 0),Ea=({children:n})=>{const[e,t]=T.useState([]),s=T.useCallback((r,c,o=4e3)=>{const l=`toast-${Date.now()}-${Math.random()}`,u={id:l,type:r,message:c,duration:o};t(d=>[...d,u]);const h=setTimeout(()=>{i(l)},o);return()=>clearTimeout(h)},[]),i=T.useCallback(r=>{t(c=>c.filter(o=>o.id!==r))},[]);return a.jsxs(Ma.Provider,{value:{toasts:e,addToast:s,removeToast:i},children:[n,a.jsx(Ia,{toasts:e})]})},Ia=({toasts:n})=>a.jsx("div",{className:"toast-container",role:"region","aria-live":"polite","aria-label":"通知",children:n.map(e=>a.jsxs("div",{className:`toast toast-${e.type}`,style:{animation:`slideIn 0.4s ease, slideOut 0.4s ease ${e.duration-400}ms`},children:[a.jsxs("span",{className:"toast-icon","aria-hidden":"true",children:[e.type==="success"&&"●",e.type==="error"&&"■",e.type==="info"&&"◇"]}),a.jsx("span",{className:"toast-message",children:e.message})]},e.id))});class Oa extends T.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("[ErrorBoundary] Caught error:",e,t);try{new Function('return import("@sentry/react")')().then(i=>{i.captureException(e,{contexts:{react:t}})}).catch(()=>{})}catch{}}render(){return this.state.hasError?a.jsxs("div",{style:{padding:"2rem",textAlign:"center",fontFamily:"sans-serif"},children:[a.jsx("h1",{children:"エラーが発生しました"}),a.jsx("p",{children:"アプリケーションでエラーが発生しました。ページをリロードしてください。"}),a.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"0.5rem 1rem",marginTop:"1rem",cursor:"pointer"},children:"リロード"})]}):this.props.children}}const Gi=T.createContext(void 0),Ra=({value:n,children:e})=>a.jsx(Gi.Provider,{value:n,children:e}),Bs=()=>{const n=T.useContext(Gi);if(!n)throw new Error("useRoomNavigation must be used within RoomNavigationProvider");return n},Da=({rooms:n,initialRoom:e="main"})=>{const t=n.findIndex(x=>x.id===e),[s,i]=T.useState(t>=0?t:0),[r,c]=T.useState(!1),[o,l]=T.useState(0),[u,h]=T.useState(0),d=T.useRef(null),f=x=>x instanceof Element?!!x.closest('button, a, input, select, textarea, [role="button"], [data-no-swipe="true"]'):!1,p=x=>{f(x.target)||(c(!0),l(x.touches[0].clientX))},m=x=>{if(!r)return;const M=x.touches[0].clientX-o;h(M)},g=()=>{if(!r)return;c(!1),Math.abs(u)>100&&(u>0&&s>0?i(s-1):u<0&&s<n.length-1&&i(s+1)),h(0)},_=x=>{f(x.target)||(c(!0),l(x.clientX))},y=x=>{if(!r)return;x.preventDefault();const j=x.clientX-o;h(j)},w=()=>{if(!r)return;c(!1),Math.abs(u)>100&&(u>0&&s>0?i(s-1):u<0&&s<n.length-1&&i(s+1)),h(0)},N=()=>{r&&(Math.abs(u)>100&&(u>0&&s>0?i(s-1):u<0&&s<n.length-1&&i(s+1)),c(!1),h(0))},A=x=>{i(x),h(0)},b=d.current?.clientWidth||window.innerWidth||1,S=-s*100+u/b*100,C=n[s]?.id,v=C!=="onboarding",k=x=>{const j=n.findIndex(M=>M.id===x);j>=0&&A(j)};return a.jsx(Ra,{value:{currentRoomId:C,navigateToRoom:k},children:a.jsxs("div",{className:`room-navigator ${v?"":"indicators-hidden"}`,children:[v&&a.jsx("div",{className:"room-indicators","aria-label":"ルームナビゲーション",children:n.map((x,j)=>a.jsx("button",{className:`room-indicator ${j===s?"active":""}`,onClick:()=>A(j),"aria-current":j===s?"page":void 0,"aria-label":`${x.name}へ移動`,children:a.jsx("span",{className:"room-indicator-label",children:x.name})},x.id))}),a.jsx("div",{ref:d,className:"rooms-container",onTouchStart:p,onTouchMove:m,onTouchEnd:g,onMouseDown:_,onMouseMove:y,onMouseUp:w,onMouseLeave:N,style:{transform:`translateX(${S}%)`,transition:r?"none":"transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1)"},children:n.map(x=>a.jsx("div",{className:"room",children:x.component},x.id))})]})})},_i="airia_onboarding_data",Pa=[{value:"",label:"選択してください"},{value:"talk",label:"会話からはじめる（やさしく）"},{value:"create",label:"創作からはじめる（早く作品へ）"}],Fa=[{value:"",label:"選択してください"},{value:"今日",label:"今日"},{value:"昨日",label:"昨日"},{value:"今週",label:"今週"},{value:"先週",label:"先週"},{value:"今月",label:"今月"},{value:"先月",label:"先月"}],La=[{value:"",label:"選択してください"},{value:"朝（6-9時）",label:"朝（6-9時）"},{value:"午前（9-12時）",label:"午前（9-12時）"},{value:"昼（12-15時）",label:"昼（12-15時）"},{value:"午後（15-18時）",label:"午後（15-18時）"},{value:"夕方（18-21時）",label:"夕方（18-21時）"},{value:"夜（21-24時）",label:"夜（21-24時）"},{value:"深夜（0-6時）",label:"深夜（0-6時）"}],vi=[{value:"",label:"選択してください"},{value:"穏やか",label:"○ 穏やか"},{value:"嬉しい",label:"△ 嬉しい"},{value:"不安",label:"□ 不安"},{value:"疲れ",label:"◇ 疲れ"},{value:"怒り",label:"▲ 怒り"},{value:"悲しい",label:"◆ 悲しい"},{value:"興奮",label:"▽ 興奮"},{value:"退屈",label:"◻︎ 退屈"}],Va=[{value:"",label:"選択してください"},{value:"1週間以内",label:"1週間以内"},{value:"1ヶ月以内",label:"1ヶ月以内"},{value:"3ヶ月以内",label:"3ヶ月以内"},{value:"6ヶ月以内",label:"6ヶ月以内"},{value:"1年以内",label:"1年以内"},{value:"長期的",label:"長期的"}],qa=({onComplete:n,onProgressChange:e})=>{const[t,s]=T.useState({startMode:"",recentMomentWhen:"",recentMomentEmotion:"",recentMomentWhy:"",dailyPatternWhen:"",dailyPatternEmotion:"",emotionalTrigger:"",emotionalTriggerWhy:"",emotionalGoal:"",emotionalGoalTimeframe:""}),i=[{key:"startMode",title:"はじめに：どちらから始めたい？",description:"迷ったら「会話から」でOK。後からいつでも変えられます。",kind:"select",options:Pa},{key:"recentMomentWhen",title:"最近の感情的な瞬間は「いつ」でしたか？",description:"時間の粒度はざっくりで大丈夫です。",kind:"select",options:Fa},{key:"recentMomentEmotion",title:"そのときの感情は？",description:"一番近いものを選んでください。",kind:"select",options:vi},{key:"recentMomentWhy",title:"なぜその感情が湧きましたか？",description:"短文でもOKです。",kind:"textarea",placeholder:"例：プロジェクトが成功した／大切な人と話せた／不安な連絡が来た…",rows:4},{key:"dailyPatternWhen",title:"普段、感情が動きやすい時間帯は？",description:"一日の中で特徴的な時間帯を選んでください。",kind:"select",options:La},{key:"dailyPatternEmotion",title:"その時間帯に感じやすい感情は？",description:"一番よく起きるものを選んでください。",kind:"select",options:vi},{key:"emotionalTrigger",title:"感情を動かしやすい「きっかけ」は？",description:"要因を一言で書いてください。",kind:"input",placeholder:"例：仕事の締切／SNS／睡眠不足／人間関係…"},{key:"emotionalTriggerWhy",title:"そのきっかけが影響する理由は？",description:"背景やパターンがあれば。",kind:"textarea",placeholder:"例：評価が気になる／比較してしまう／体力が落ちると不安が増える…",rows:4},{key:"emotionalGoal",title:"これから目指したい感情は？",description:"どんな状態で過ごしたいですか？",kind:"textarea",placeholder:"例：落ち着いて集中できる／夜に安心して眠れる／穏やかに話せる…",rows:3},{key:"emotionalGoalTimeframe",title:"その目標はいつ頃までに？",description:"時間感覚を選んでください。",kind:"select",options:Va}],[r,c]=T.useState(0),o=i.length;T.useEffect(()=>{const m=o>0?r/o:0;e?.(Math.min(m,.999))},[r,o,e]),T.useEffect(()=>{const m=localStorage.getItem(_i);if(m)try{const g=JSON.parse(m);s(g)}catch(g){console.error("Failed to parse saved onboarding data:",g)}},[]);const l=m=>{localStorage.setItem(_i,JSON.stringify(m))},u=(m,g)=>{s({...t,[m]:g})},h=()=>{r<o-1&&(l(t),c(r+1))},d=()=>{r>0&&(l(t),c(r-1))},f=()=>{const m={...t,completedAt:new Date().toISOString()};s(m),l(m),n&&n(m)},p=()=>{const m=i[r],g=String(t[m.key]??"");return m.kind==="select"?g.length>0:g.trim().length>0};return a.jsxs("div",{className:"onboarding-form",children:[a.jsxs("div",{className:"onboarding-header",children:[a.jsx("h2",{className:"blend-text",children:"はじめに"}),a.jsx("p",{className:"onboarding-subtitle",children:"いまのあなたに合わせて、AIRIAが整えます（所要2分・短文OK）"}),a.jsx("div",{className:"progress-bar",children:a.jsx("div",{className:"progress-fill",style:{width:`${(r+1)/o*100}%`}})}),a.jsxs("p",{className:"step-indicator",children:["ステップ ",r+1," / ",o]})]}),a.jsx("div",{className:"question-container",children:(()=>{const m=i[r];return a.jsxs("div",{className:"question-step",children:[a.jsx("h3",{className:"question-title",children:m.title}),m.description?a.jsx("p",{className:"question-description",children:m.description}):null,a.jsx("div",{className:"form-group",children:m.kind==="select"?a.jsx("select",{className:"form-select",value:String(t[m.key]??""),onChange:g=>u(m.key,g.target.value),children:(m.options??[]).map(g=>a.jsx("option",{value:g.value,children:g.label},g.value))}):m.kind==="input"?a.jsx("input",{type:"text",className:"form-input",placeholder:m.placeholder,value:String(t[m.key]??""),onChange:g=>u(m.key,g.target.value)}):a.jsx("textarea",{className:"form-textarea",placeholder:m.placeholder,value:String(t[m.key]??""),onChange:g=>u(m.key,g.target.value),rows:m.rows??4})})]})})()}),a.jsxs("div",{className:"button-group",children:[r>0&&a.jsx("button",{className:"btn btn-secondary",onClick:d,children:"← 戻る"}),r<o-1?a.jsx("button",{className:"btn btn-primary",onClick:h,disabled:!p(),children:"次へ →"}):a.jsx("button",{className:"btn btn-success",onClick:f,disabled:!p(),children:"完了"})]})]})},Wa=({isActive:n})=>{const e=T.useRef(null),t=T.useRef(null);jt(l=>{if(!e.current)return;e.current.rotation.z+=n?.002:.001;const u=Math.sin(l.clock.elapsedTime*.5)*.1+1;e.current.scale.setScalar(u),t.current&&(t.current.opacity=n?.6:.3)});const s=[],i=5,r=50,c=i*r;for(let l=0;l<c;l++){const u=l/r,h=u*Math.PI*2,d=u*.5;s.push(new Ws(Math.cos(h)*d,Math.sin(h)*d,u*.1))}const o=new is().setFromPoints(s);return a.jsx("line",{ref:e,geometry:o,children:a.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})})},Ba=({isActive:n=!1})=>a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs($t,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(Wa,{isActive:n})]})}),Ua=({isActive:n})=>{const e=T.useRef(null),t=T.useRef(null);jt(u=>{if(!e.current)return;e.current.rotation.z+=n?.001:5e-4;const h=Math.sin(u.clock.elapsedTime*.3)*.05+1;e.current.scale.setScalar(h),t.current&&(t.current.opacity=n?.5:.25)});const s=[],i=200,r=3,c=2,o=Math.PI/2;for(let u=0;u<=i;u++){const h=u/i*Math.PI*2,d=Math.sin(r*h+o)*1.5,f=Math.sin(c*h)*1.5,p=0;s.push(new Ws(d,f,p))}const l=new is().setFromPoints(s);return a.jsx("line",{ref:e,geometry:l,children:a.jsx("lineBasicMaterial",{ref:t,color:"#D4AF37",linewidth:2,transparent:!0,opacity:.5})})},Ga=({isActive:n=!1})=>a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs($t,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(Ua,{isActive:n})]})}),$a=({isActive:n,ripples:e})=>{const t=T.useRef(null);jt(i=>{if(!t.current)return;const r=i.clock.elapsedTime;t.current.children.forEach((c,o)=>{if(e[o]){const l=r-e[o].startTime,u=3;if(l<u){const h=1+l*.5;c.scale.setScalar(h);const d=1-l/u;c instanceof ma&&(c.material.opacity=d*(n?.6:.3))}else c.visible=!1}})});const s=()=>{const i=[];for(let o=0;o<=64;o++){const l=o/64*Math.PI*2;i.push(new Ws(Math.cos(l)*1,Math.sin(l)*1,0))}return new is().setFromPoints(i)};return a.jsx("group",{ref:t,children:e.slice(-5).map(i=>a.jsx("line",{geometry:s(),children:a.jsx("lineBasicMaterial",{color:"#D4AF37",linewidth:2,transparent:!0,opacity:.6})},i.id))})},za=({isActive:n=!1,triggerRipple:e})=>{const[t,s]=T.useState([]),i=T.useRef(0);return T.useEffect(()=>{if(e){const r={id:i.current++,startTime:Date.now()/1e3};s(c=>[...c,r].slice(-5))}},[e]),T.useEffect(()=>{if(!n)return;const r=setInterval(()=>{const c={id:i.current++,startTime:Date.now()/1e3};s(o=>[...o,c].slice(-5))},2e3);return()=>clearInterval(r)},[n]),a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:0},children:a.jsxs($t,{camera:{position:[0,0,5],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx($a,{isActive:n,ripples:t})]})})},Xa=({isActive:n,progress:e,dominantColor:t,onComplete:s,mousePos:i})=>{const r=T.useRef(null),c=T.useRef(null),[o,l]=T.useState(!1),[u,h]=T.useState(0),d=T.useMemo(()=>new fa(t),[t]),f=T.useMemo(()=>{const p=new is,m=new Float32Array(100*3),g=new Float32Array(100*3);for(let _=0;_<100;_++){const y=Math.random()*Math.PI*2,w=Math.acos(2*Math.random()-1),N=1;m[_*3]=N*Math.sin(w)*Math.cos(y),m[_*3+1]=N*Math.sin(w)*Math.sin(y),m[_*3+2]=N*Math.cos(w),g[_*3]=m[_*3]*.02,g[_*3+1]=m[_*3+1]*.02,g[_*3+2]=m[_*3+2]*.02}return p.setAttribute("position",new di(m,3)),p.setAttribute("velocity",new di(g,3)),p},[]);return jt(p=>{if(!r.current)return;const m=n?2*Math.PI/(30*60):2*Math.PI/(60*60);if(r.current.rotation.y+=m,r.current.rotation.x+=m*.5,n&&i.x!==0&&i.y!==0){const y=(i.x/window.innerWidth-.5)*.5,w=(i.y/window.innerHeight-.5)*.5;r.current.rotation.y+=(y-r.current.rotation.y)*.1,r.current.rotation.x+=(w-r.current.rotation.x)*.1}const g=20,_=Math.floor(e*g);if(_!==u&&_<g&&h(_),e>=1&&!o&&(l(!0),setTimeout(()=>{s?.()},1500)),o&&c.current){const y=f.getAttribute("position"),w=f.getAttribute("velocity");for(let N=0;N<100;N++)y.setXYZ(N,y.getX(N)+w.getX(N),y.getY(N)+w.getY(N),y.getZ(N)+w.getZ(N));y.needsUpdate=!0,r.current.material instanceof ga&&(r.current.material.opacity=Math.max(0,r.current.material.opacity-.02))}}),a.jsxs("group",{children:[!o&&a.jsxs("mesh",{ref:r,children:[a.jsx("icosahedronGeometry",{args:[1,0]}),a.jsx("meshStandardMaterial",{color:d,transparent:!0,opacity:.8,wireframe:!1,emissive:d,emissiveIntensity:u/20})]}),o&&a.jsx("points",{ref:c,geometry:f,children:a.jsx("pointsMaterial",{color:d,size:.05,transparent:!0,opacity:.8})})]})},Ya=({isActive:n=!1,progress:e=0,onComplete:t,dominantColor:s="#D4AF37",layer:i="foreground",placement:r="center",sizePx:c=400,opacity:o})=>{const[l,u]=T.useState({x:0,y:0});T.useEffect(()=>{const p=m=>{u({x:m.clientX,y:m.clientY})};return window.addEventListener("mousemove",p),()=>window.removeEventListener("mousemove",p)},[]);const h=(()=>{switch(r){case"topRight":return{top:"30%",left:"75%"};case"topLeft":return{top:"30%",left:"25%"};case"bottomRight":return{top:"70%",left:"75%"};case"bottomLeft":return{top:"70%",left:"25%"};case"center":default:return{top:"50%",left:"50%"}}})(),d=i==="background",f=typeof o=="number"?o:d?.14:1;return a.jsx("div",{style:{width:"100%",height:`${c}px`,position:"absolute",...h,transform:"translate(-50%, -50%)",pointerEvents:d?"none":n?"auto":"none",zIndex:d?-1:0,opacity:f},children:a.jsxs($t,{camera:{position:[0,0,3],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx("pointLight",{position:[10,10,10],intensity:1}),a.jsx(Xa,{isActive:n,progress:e,dominantColor:s,onComplete:t,mousePos:l})]})})},Ha=({index:n,frequency:e,amplitude:t,color:s,mousePos:i,plucked:r})=>{const c=T.useRef(null),[o,l]=T.useState(0),[u,h]=T.useState(0),d=T.useMemo(()=>{const p=[];for(let _=0;_<100;_++){const y=_/100*4-2;p.push(new Ws(y,0,0))}return p},[]);jt(p=>{if(!c.current)return;const m=c.current.geometry.attributes.position,g=4,_=100;l(w=>w+e*.01),r&&h(w=>w+.2);const y=r?Math.exp(-u)*.5:0;for(let w=0;w<_;w++){const N=w/_*g-g/2,A=(i.x/window.innerWidth-.5)*8,b=(i.y/window.innerHeight-.5)*6,S=(n-2)*.4,C=Math.sqrt(Math.pow(A-N,2)+Math.pow(b-S,2)),v=Math.max(0,1-C/2)*.3,k=(t+v+y)*Math.sin(e*N+o),x=k,j=k*.2;m.setXYZ(w,N,x,j)}m.needsUpdate=!0,c.current.position.y=(n-2)*.4});const f=T.useMemo(()=>new is().setFromPoints(d),[d]);return a.jsx("line",{ref:c,geometry:f,children:a.jsx("lineBasicMaterial",{color:s,linewidth:2,transparent:!0,opacity:.8})})},Za=({isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:r})=>{const c=T.useMemo(()=>{const o=t<0?1:2,l=s*.2;return[{frequency:o,amplitude:e?.bass?e.bass/255*.3:l,color:"#FF4444"},{frequency:o*1.5,amplitude:e?.midLow?e.midLow/255*.3:l*.8,color:"#FF8844"},{frequency:o*2,amplitude:e?.mid?e.mid/255*.3:l*.6,color:"#FFDD44"},{frequency:o*2.5,amplitude:e?.midHigh?e.midHigh/255*.3:l*.4,color:"#44DDFF"},{frequency:o*3,amplitude:e?.treble?e.treble/255*.3:l*.2,color:"#8844FF"}]},[e,t,s]);return a.jsx("group",{children:c.map((o,l)=>a.jsx(Ha,{index:l,frequency:o.frequency,amplitude:o.amplitude,color:o.color,mousePos:i,plucked:r===l},l))})},Ja=({isActive:n=!1,audioData:e=null,valence:t=0,arousal:s=.5})=>{const[i,r]=T.useState({x:0,y:0}),[c,o]=T.useState(-1);T.useEffect(()=>{const u=h=>{r({x:h.clientX,y:h.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[]);const l=u=>{const h=u.currentTarget.getBoundingClientRect(),d=u.clientY-h.top,f=Math.floor(d/h.height*5);o(f),setTimeout(()=>o(-1),1e3)};return a.jsx("div",{style:{width:"100%",height:"400px",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",pointerEvents:n?"auto":"none",zIndex:0},onClick:l,children:a.jsxs($t,{camera:{position:[0,0,4],fov:50},style:{background:"transparent"},children:[a.jsx("ambientLight",{intensity:.5}),a.jsx(Za,{isActive:n,audioData:e,valence:t,arousal:s,mousePos:i,pluckedIndex:c})]})})},$i=({pattern:n,isActive:e=!1,triggerRipple:t,progress:s=0,dominantColor:i="#D4AF37",layer:r="foreground",placement:c="center",sizePx:o,opacity:l,audioData:u=null,valence:h=0,arousal:d=.5,onComplete:f})=>{const[p,m]=T.useState(!1),[g,_]=T.useState(!1);return T.useEffect(()=>{const y=()=>{m(window.innerWidth<768)},w=window.matchMedia("(prefers-reduced-motion: reduce)");_(w.matches),y(),window.addEventListener("resize",y);const N=A=>{_(A.matches)};return w.addEventListener("change",N),()=>{window.removeEventListener("resize",y),w.removeEventListener("change",N)}},[]),p||g||n==="none"?null:a.jsxs(a.Fragment,{children:[n==="spiral"&&a.jsx(Ba,{isActive:e}),n==="lissajous"&&a.jsx(Ga,{isActive:e}),n==="ripples"&&a.jsx(za,{isActive:e,triggerRipple:t}),n==="polyhedron"&&a.jsx(Ya,{isActive:e,progress:s,dominantColor:i,onComplete:f,layer:r,placement:c,sizePx:o,opacity:l}),n==="stringVibration"&&a.jsx(Ja,{isActive:e,audioData:u,valence:h,arousal:d})]})},Qa=({onExit:n})=>{const[e,t]=T.useState(!1),[s,i]=T.useState(null),[r,c]=T.useState(0),o=u=>{i(u),t(!0)},l=()=>{t(!1),i(null),c(0)};return a.jsxs("div",{className:"room-content",children:[!e&&a.jsx($i,{pattern:"polyhedron",isActive:!0,progress:r,layer:"background",placement:"center",sizePx:420,opacity:.16}),a.jsx("h1",{className:"room-title",children:"はじめに"}),a.jsx("p",{className:"room-subtitle",children:"あなたに合う体験へ整えます"}),e?a.jsxs("div",{className:"onboarding-complete",children:[a.jsx("h2",{className:"blend-text",children:"完了しました！"}),a.jsxs("p",{className:"completion-message",children:["ありがとうございます。あなたの回答は保存されました。",a.jsx("br",{}),"この情報は、より良いセッション体験のために活用されます。"]}),a.jsxs("div",{className:"button-group",children:[a.jsx("button",{className:"btn btn-secondary",onClick:l,children:"回答を編集"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>{if(!s)return;const u=JSON.stringify(s,null,2),h=new Blob([u],{type:"application/json"}),d=URL.createObjectURL(h),f=document.createElement("a");f.href=d,f.download="getting_started_profile.json",f.click(),URL.revokeObjectURL(d)},children:"プロフィールをダウンロード"}),a.jsx("button",{className:"btn btn-success",onClick:()=>{n?.()},children:"はじめる"})]})]}):a.jsx(qa,{onComplete:o,onProgressChange:c})]})},gt="https://airia-beyond.onrender.com";async function zi(n){const e=await fetch(`${gt}/api/image/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate image")}return e.json()}async function Ka(n){const e=await fetch(`${gt}/api/job/${n}`);if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to get job status")}return e.json()}async function Xi(n,e,t=60,s=2e3){for(let i=0;i<t;i++){const r=await Ka(n);if(e&&e(r),r.status==="succeeded"||r.status==="failed")return r;await new Promise(c=>setTimeout(c,s))}throw new Error("Job polling timeout")}async function eo(n){const e=await fetch(`${gt}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to chat")}return e.json()}async function to(n){const e=await fetch(`${gt}/api/event/refine`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to refine event")}return e.json()}async function so(n){const e=await fetch(`${gt}/api/album/name`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to name album title")}return e.json()}async function no(n){const e=await fetch(`${gt}/api/music/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to resolve music preview")}return e.json()}async function io(n){const e=await fetch(`${gt}/api/music/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to generate music")}return e.json()}async function ro(n){const e=await fetch(`${gt}/api/music/${n}`);if(!e.ok){const t=await e.json();throw new Error(t.message||t.error||"Failed to get music job status")}return e.json()}async function ao(n,e,t=60,s=2e3){for(let i=0;i<t;i++){const r=await ro(n);if(r.status==="succeeded"||r.status==="failed")return r;await new Promise(c=>setTimeout(c,s))}throw new Error("Music job polling timeout")}function oo(n,e,t){try{n(e,{album:{albumId:t.albumId,title:t.title,timestamp:new Date},success:!0}),console.log("[CausalLog] Album creation stage logged for",e)}catch(s){console.error("[CausalLog] Failed to log album creation stage:",s)}}function co(n,e,t,s,i){try{const c=e(t)?.errors||[];n(t,{errors:[...c,{stage:s,error:i,timestamp:new Date}]}),console.log("[CausalLog] Error logged for",t,"at stage",s)}catch(r){console.error("[CausalLog] Failed to log error:",r)}}function lo({open:n,mood:e,defaultTitle:t,onCancel:s,onSubmit:i}){const[r,c]=T.useState(t??"");T.useEffect(()=>{n&&c(t??"")},[n,t]);const o=T.useMemo(()=>r.trim().length>0?"そのまま保存されます。":"空のまま保存すると、AIがタイトルを提案します。",[r]);return T.useEffect(()=>{if(!n)return;const l=u=>{u.key==="Escape"&&s(),u.key==="Enter"&&(u.metaKey||u.ctrlKey)&&i(r)};return document.addEventListener("keydown",l),()=>document.removeEventListener("keydown",l)},[n,s,i,r]),n?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"album-title-backdrop",onClick:s}),a.jsxs("div",{className:"album-title-modal",role:"dialog","aria-modal":"true","aria-label":"アルバムタイトルの設定",children:[a.jsxs("div",{className:"album-title-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"album-title-eyebrow",children:"アルバムのタイトル"}),a.jsx("h2",{className:"album-title-heading",children:"作品に名前をつけよう"}),a.jsxs("p",{className:"album-title-sub",children:["ムード: ",e]})]}),a.jsx("button",{className:"album-title-close",onClick:s,"aria-label":"閉じる",title:"閉じる (Esc)",children:"×"})]}),a.jsxs("div",{className:"album-title-body",children:[a.jsx("label",{className:"album-title-label",htmlFor:"album-title-input",children:"タイトル（空でもOK）"}),a.jsx("input",{id:"album-title-input",className:"album-title-input",value:r,placeholder:"例：雨上がりの余白",onChange:l=>c(l.target.value),autoFocus:!0}),a.jsx("div",{className:"album-title-hint",children:o}),a.jsx("div",{className:"album-title-shortcut",children:"保存: クリック / (Ctrl+Enter)"})]}),a.jsxs("div",{className:"album-title-actions",children:[a.jsx("button",{className:"btn btn-secondary",onClick:s,children:"キャンセル"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>i(r),children:"保存"})]})]})]}):null}function uo(){return new Date().toISOString()}function ho(){const{addAlbum:n}=Nt(),{createLog:e,updateLog:t,getLog:s}=jn(),[i,r]=T.useState([{role:"assistant",content:"今日はどんな一日でした？短くても大丈夫。"}]),[c,o]=T.useState(""),[l,u]=T.useState(!1),[h,d]=T.useState(null),[f,p]=T.useState([]),[m,g]=T.useState(null),[_,y]=T.useState(!1),[w,N]=T.useState(!1),[A,b]=T.useState(null),[S,C]=T.useState(null),[v,k]=T.useState(!1),x=T.useRef(null),[j,M]=T.useState(null),[O,D]=T.useState({}),[q,L]=T.useState({}),[B,U]=T.useState({}),E=T.useMemo(()=>i.filter(F=>F.role==="user"),[i]);T.useEffect(()=>()=>{x.current&&(x.current.pause(),x.current.src="",x.current=null)},[]);const R=F=>`${F.composer}::${F.title}`;async function V(F){const P=R(F);if(O[P])return O[P];if(q[P])return null;L(I=>({...I,[P]:!0})),U(I=>({...I,[P]:null}));try{const I=await no({composer:F.composer,title:F.title});return D(J=>({...J,[P]:I})),I}catch(I){const J=I instanceof Error?I.message:"プレビュー取得に失敗しました";return U(me=>({...me,[P]:J})),null}finally{L(I=>({...I,[P]:!1}))}}async function Y(F){const P=R(F);if(j===P){x.current?.pause(),M(null);return}const J=await V(F),me=J?.previewUrl,Ee=J?.trackUrl;if(!me){Ee&&window.open(Ee,"_blank","noopener,noreferrer");return}try{x.current||(x.current=new Audio),x.current.pause(),x.current.src=me,x.current.currentTime=0,await x.current.play(),M(P),x.current.onended=()=>{M(oe=>oe===P?null:oe)}}catch(oe){U(Kt=>({...Kt,[P]:oe instanceof Error?oe.message:"再生に失敗しました"}))}}async function ie(){const F=c.trim();if(!F)return;d(null),u(!0);const P=[...i,{role:"user",content:F}];r(P),o("");try{const I=await eo({messages:P});r(J=>[...J,{role:"assistant",content:I.assistant_message}]),p(I.recommendations??[]),g(I.event_suggestion??null)}catch(I){const J=I instanceof Error?I.message:"送信に失敗しました";d(J),r(me=>[...me,{role:"assistant",content:"ごめん、いま少し不安定。もう一度だけ送ってみて。"}])}finally{u(!1)}}async function xe(){d(null),y(!0);const F=`chat_${Date.now()}`,P=e(F,{mood:"穏やか",duration:60,timestamp:new Date,customInput:!0});try{const I=await to({messages:i}),J=await zi(I.image),me=await io(I.music),[Ee,oe]=await Promise.all([Xi(J.jobId),ao(me.jobId)]);if(Ee.status!=="succeeded"||!Ee.resultUrl)throw new Error("画像生成に失敗しました");if(oe.status!=="succeeded"||!oe.midiData||!oe.result)throw new Error("曲生成に失敗しました");const Kt=I?.brief?.theme?.title||"";b({title:Kt,mood:I.image.mood,duration:I.image.duration,imageDataURL:Ee.resultUrl,thumbnailUrl:Ee.resultUrl,metadata:{valence:I.analysisLike.valence,arousal:I.analysisLike.arousal,focus:I.analysisLike.focus,motif_tags:I.analysisLike.motif_tags,confidence:I.analysisLike.confidence,stylePreset:I.image.stylePreset,provider:"replicate"},musicData:oe.midiData,musicFormat:"midi",musicMetadata:{key:oe.result.key,tempo:oe.result.tempo,timeSignature:oe.result.timeSignature,form:oe.result.form,character:oe.result.character,duration:I.music.duration,createdAt:uo(),provider:oe.provider},sessionData:{brief:I.brief,recommendations:f,messages:i},causalLogId:P}),C(P),N(!0),g(null),r(hn=>[...hn,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}catch(I){const J=I instanceof Error?I.message:"生成イベントに失敗しました";d(J),co(t,s,P,"generation-event",J),r(me=>[...me,{role:"assistant",content:"生成イベントがうまく走らなかった。もう少し会話を続けるか、後でもう一度やってみよう。"}])}finally{y(!1)}}async function X(F){if(!A){N(!1);return}const P=F.trim();try{k(!0);let I=P;if(!I)try{I=(await so({mood:A.mood,motifTags:A?.metadata?.motif_tags,character:A?.musicMetadata?.character,brief:A?.sessionData?.brief,messages:A?.sessionData?.messages})).title}catch{I=""}n({...A,title:I||void 0}),S&&oo(t,S,{albumId:"local",title:I||A.mood}),g(null),r(J=>[...J,{role:"assistant",content:"生成イベントを完了したよ。ギャラリーで見返せるように保存した。"}])}finally{k(!1),N(!1),b(null),C(null)}}return a.jsxs("div",{className:"chatSession",children:[a.jsx(lo,{open:w,mood:A?.mood||"穏やか",defaultTitle:A?.title,onCancel:()=>{v||(N(!1),b(null),C(null))},onSubmit:F=>{v||X(F)}}),a.jsxs("div",{className:"chatHeader",children:[a.jsxs("div",{className:"chatTitle",children:[a.jsx("div",{className:"chatTitleMain",children:"対話"}),a.jsx("div",{className:"chatTitleSub",children:"話すだけで、レコメンドと創作が進む"})]}),a.jsx("div",{className:"chatHeaderRight",children:m?.shouldTrigger?a.jsx("button",{className:"chatPrimary",onClick:xe,disabled:_,"data-no-swipe":!0,children:_?"生成中…":"生成イベントを開始"}):null})]}),m&&!m.shouldTrigger?a.jsx("div",{className:"chatHint",children:m.reason}):null,a.jsxs("div",{className:"chatBody",children:[i.map((F,P)=>a.jsx("div",{className:`chatMsg ${F.role==="user"?"user":"assistant"}`,children:a.jsx("div",{className:"chatBubble",children:F.content})},P)),f.length>0?a.jsxs("details",{className:"chatRecsInline","data-no-swipe":!0,open:!0,children:[a.jsx("summary",{className:"chatRecsSummary",children:"いまのレコメンド"}),a.jsx("ul",{className:"chatRecsList",children:f.slice(0,4).map((F,P)=>a.jsxs("li",{className:"chatRecItem",children:[a.jsxs("div",{className:"chatRecMain",children:[a.jsx("span",{className:"chatRecComposer",children:F.composer}),a.jsx("span",{className:"chatRecSep",children:"—"}),a.jsx("span",{className:"chatRecTitle",children:F.title}),F.era?a.jsxs("span",{className:"chatRecEra",children:["(",F.era,")"]}):null]}),a.jsx("div",{className:"chatRecWhy",children:F.why}),a.jsxs("div",{className:"chatRecActions",children:[a.jsx("button",{className:"chatRecPlay",onClick:()=>void Y(F),disabled:!!q[R(F)],"data-no-swipe":!0,title:"プレビューがある場合は30秒再生します",children:j===R(F)?"停止":q[R(F)]?"取得中…":"再生"}),O[R(F)]?.trackUrl?a.jsx("a",{className:"chatRecOpen",href:O[R(F)]?.trackUrl,target:"_blank",rel:"noreferrer","data-no-swipe":!0,children:"開く"}):null]}),B[R(F)]?a.jsx("div",{className:"chatRecErr",children:B[R(F)]}):null]},P))})]}):null]}),a.jsxs("div",{className:"chatDock","data-no-swipe":!0,children:[h?a.jsx("div",{className:"chatError",children:h}):null,a.jsxs("div",{className:"chatComposer",children:[a.jsx("textarea",{className:"chatInput",placeholder:E.length===0?"今日のことを一言で":"続けて話して",value:c,onChange:F=>o(F.target.value),onKeyDown:F=>{F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),l||ie())},rows:2}),a.jsx("button",{className:"chatSend",onClick:ie,disabled:l||!c.trim(),children:l?"送信中…":"送信"})]})]})]})}const po=()=>a.jsx("div",{className:"room-content",style:{maxWidth:"100%",width:"100%",position:"relative"},children:a.jsx(ho,{})}),mo=({album:n,position:e,onClick:t,isSelected:s})=>{const i=T.useRef(null),r=T.useRef(null),c=T.useRef(0),o=.22,l=1.8,u=.55,h=n.gallery?.spineColor||"#111111",d=n.title||n.mood,f=T.useMemo(()=>new Date(n.createdAt).toLocaleDateString("ja-JP",{year:"2-digit",month:"2-digit",day:"2-digit"}),[n.createdAt]),p=_a(va,n.imageDataURL);return T.useEffect(()=>{p.colorSpace=ya,p.anisotropy=4,p.needsUpdate=!0},[p]),jt((m,g)=>{const _=s?1:0;if(c.current=gn.lerp(c.current,_,1-Math.exp(-8*g)),r.current){const y=c.current;r.current.position.z=u/2+.04+y*.7,r.current.position.y=y*.08,r.current.scale.setScalar(.92+y*.08),r.current.visible=y>.01}if(i.current){const y=c.current;i.current.scale.y=1+y*.02}}),a.jsxs("group",{position:e,children:[a.jsxs("mesh",{ref:i,onClick:t,castShadow:!0,receiveShadow:!0,children:[a.jsx("boxGeometry",{args:[o,l,u]}),a.jsx("meshStandardMaterial",{color:h,roughness:.9,metalness:.05})]}),a.jsxs("group",{position:[o/2-.05,l/2-.12,u/2+.03],children:[n.isPublic&&a.jsxs("mesh",{position:[0,0,0],children:[a.jsx("boxGeometry",{args:[.06,.06,.02]}),a.jsx("meshStandardMaterial",{color:"#63e6be",roughness:.4,metalness:.1})]}),n.isFavorite&&a.jsxs("mesh",{position:[0,-.08,0],children:[a.jsx("boxGeometry",{args:[.06,.06,.02]}),a.jsx("meshStandardMaterial",{color:"#d4af37",roughness:.4,metalness:.1})]})]}),a.jsxs("group",{position:[0,0,u/2+.01],children:[a.jsx(pi,{fontSize:.12,color:h==="#111111"?"#f5f5f5":"#111111",anchorX:"center",anchorY:"middle",maxWidth:.9,children:d}),a.jsx(pi,{position:[0,-.16,0],fontSize:.08,color:h==="#111111"?"#f5f5f5":"#111111",fillOpacity:h==="#111111"?.75:.55,anchorX:"center",anchorY:"middle",maxWidth:.9,children:f})]}),a.jsxs("group",{ref:r,position:[0,.05,u/2+.04],visible:!1,children:[a.jsxs("mesh",{onClick:t,castShadow:!0,children:[a.jsx("planeGeometry",{args:[1.1,1.55]}),a.jsx("meshStandardMaterial",{map:p,roughness:.85,metalness:0})]}),a.jsxs("mesh",{position:[0,0,-.01],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[1.14,1.6]}),a.jsx("meshStandardMaterial",{color:"#ffffff",roughness:1,metalness:0,opacity:.6,transparent:!0})]})]})]})},fo=({albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})=>{const[i,r]=T.useState(null),c=T.useRef(null),o=T.useRef(0),l=T.useRef(0),u=.32,h=Math.max(0,(n.length-1)*u),d=T.useMemo(()=>n.map((f,p)=>({x:-p*u,y:0,z:0})),[n,u]);return jt((f,p)=>{const m=s.current,g=.0022,_=m.wheelPx*g,y=m.dragPx*g;_!==0&&(l.current+=_*26,m.wheelPx=0),y!==0&&(o.current-=y,l.current=gn.lerp(l.current,-y*60,.35),m.dragPx=0);const w=m.isDragging?.88:.92;l.current*=Math.pow(w,p*60),o.current+=l.current*p;const N=.9,A=40;if(o.current<-N?(o.current=-N,l.current*=-.35):o.current>h+N&&(o.current=h+N,l.current*=-.35),o.current<0?l.current+=(0-o.current)*A*p:o.current>h&&(l.current-=(o.current-h)*A*p),!m.isDragging&&Math.abs(l.current)<.15&&n.length>0){const C=Math.max(0,Math.min(n.length-1,Math.round(o.current/u)))*u;o.current=gn.lerp(o.current,C,1-Math.exp(-10*p))}c.current&&(c.current.position.x=o.current)}),a.jsxs("group",{children:[a.jsxs("mesh",{position:[0,-1.05,-.25],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[30,6]}),a.jsx("meshStandardMaterial",{color:"#f5f5f5",roughness:1,metalness:0})]}),a.jsxs("mesh",{position:[0,.4,-.6],receiveShadow:!0,children:[a.jsx("planeGeometry",{args:[30,8]}),a.jsx("meshStandardMaterial",{color:"#fafafa",roughness:1,metalness:0})]}),a.jsx("group",{ref:c,children:n.map((f,p)=>{const m=d[p],g=[m.x,m.y,m.z];return a.jsx(mo,{album:f,position:g,onClick:()=>{r(f.id),o.current=p*u,l.current=0,e(f.id)},isSelected:i===f.id},f.id)})}),a.jsx("ambientLight",{intensity:.55}),a.jsx("directionalLight",{position:[4,6,6],intensity:.65,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-camera-left":-8,"shadow-camera-right":8,"shadow-camera-top":6,"shadow-camera-bottom":-6}),a.jsx("directionalLight",{position:[-3,3,4],intensity:.22})]})},go=({albums:n,onBookClick:e,constellationEnabled:t})=>{const s=T.useRef({wheelPx:0,dragPx:0,isDragging:!1,lastPointerX:0});return a.jsx("div",{style:{width:"100%",height:"clamp(420px, 62vh, 640px)",background:"transparent",touchAction:"none",overscrollBehavior:"contain"},onWheel:i=>{i.preventDefault();const r=Math.abs(i.deltaX)>Math.abs(i.deltaY)?i.deltaX:i.deltaY;s.current.wheelPx+=r},onPointerDown:i=>{i.currentTarget.setPointerCapture(i.pointerId),s.current.isDragging=!0,s.current.lastPointerX=i.clientX},onPointerMove:i=>{if(!s.current.isDragging)return;const r=i.clientX-s.current.lastPointerX;s.current.lastPointerX=i.clientX,s.current.dragPx+=r},onPointerUp:i=>{try{i.currentTarget.releasePointerCapture(i.pointerId)}catch{}s.current.isDragging=!1},onPointerCancel:()=>{s.current.isDragging=!1},children:a.jsx($t,{shadows:!0,camera:{position:[0,1.1,6.5],fov:32},gl:{alpha:!0,antialias:!0},children:a.jsx(T.Suspense,{fallback:null,children:a.jsx(fo,{albums:n,onBookClick:e,constellationEnabled:t,inputRef:s})})})})},St=({title:n,mood:e,imageUrl:t,meta:s,badges:i=[],variant:r="default",className:c})=>a.jsxs("div",{className:`album-card album-card-${r} ${c||""}`.trim(),children:[a.jsx("div",{className:"album-card-image",children:a.jsx("img",{src:t,alt:n,loading:"lazy"})}),a.jsxs("div",{className:"album-card-body",children:[a.jsx("div",{className:"album-card-title",children:n}),e&&a.jsx("div",{className:"album-card-mood",children:e}),s&&a.jsx("div",{className:"album-card-meta",children:s}),i.length>0&&a.jsx("div",{className:"album-card-badges",children:i.map(o=>a.jsx("span",{className:`album-badge tone-${o.tone||"default"}`,children:o.label},o.label))})]})]}),_o=({title:n,description:e,actionLabel:t,onAction:s,icon:i})=>a.jsxs("div",{className:"empty-state",children:[i&&a.jsx("div",{className:"empty-icon",children:i}),a.jsx("h2",{className:"empty-title",children:n}),a.jsx("p",{className:"empty-description",children:e}),t&&s&&a.jsx("button",{onClick:s,className:"empty-cta-button",children:t})]}),ks=({trigger:n,children:e,placement:t="bottom",triggerClassName:s,triggerAriaLabel:i,triggerAriaHaspopup:r,onOpenChange:c})=>{const[o,l]=T.useState(!1),u=T.useRef(null),h=T.useRef(null),d=T.useId(),f=()=>{l(!1),c?.(!1),h.current?.focus()},p=()=>{l(m=>{const g=!m;return c?.(g),g})};return T.useEffect(()=>{if(!o)return;const m=_=>{u.current?.contains(_.target)||f()},g=_=>{_.key==="Escape"&&(_.preventDefault(),f())};return document.addEventListener("mousedown",m),document.addEventListener("keydown",g),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("keydown",g)}},[o]),a.jsxs("div",{ref:u,className:`popover popover-${t}`,"data-no-swipe":"true",children:[a.jsx("button",{ref:h,type:"button",className:`popover-trigger ${s||""}`.trim(),onClick:p,"aria-expanded":o,"aria-controls":o?d:void 0,"aria-label":i,"aria-haspopup":r,children:n}),o&&a.jsx("div",{className:"popover-panel",id:d,children:typeof e=="function"?e({close:f}):e})]})},Cs=({items:n,autoFocus:e=!0})=>{const[t,s]=K.useState(0),i=K.useRef([]);K.useEffect(()=>{if(!e||n.length===0)return;const o=i.current[0];o&&o.focus()},[e,n.length]);const r=o=>{const l=Math.max(0,Math.min(n.length-1,o));s(l),i.current[l]?.focus()},c=o=>{if(n.length!==0){if(o.key==="ArrowDown"){o.preventDefault(),r(t+1);return}if(o.key==="ArrowUp"){o.preventDefault(),r(t-1);return}if(o.key==="Home"){o.preventDefault(),r(0);return}if(o.key==="End"){o.preventDefault(),r(n.length-1);return}}};return a.jsx("div",{className:"menu",role:"menu","aria-orientation":"vertical",onKeyDown:c,children:n.map((o,l)=>a.jsx("button",{className:"menu-item",role:"menuitem",tabIndex:l===t?0:-1,ref:u=>{i.current[l]=u},onFocus:()=>s(l),onClick:()=>{s(l),o.onSelect()},type:"button",children:o.label},o.id))})},Yi=({items:n,value:e,onChange:t,ariaLabel:s="タブ"})=>{const i=T.useId();return a.jsxs("div",{className:"tabs","data-no-swipe":"true",children:[a.jsx("div",{className:"tabs-list",role:"tablist","aria-label":s,children:n.map(r=>a.jsx("button",{id:`${i}-${r.id}-tab`,role:"tab","aria-selected":e===r.id,"aria-controls":`${i}-${r.id}-panel`,className:`tab-button ${e===r.id?"is-active":""}`,onClick:()=>t(r.id),type:"button",children:r.label},r.id))}),n.map(r=>a.jsx("div",{id:`${i}-${r.id}-panel`,role:"tabpanel","aria-labelledby":`${i}-${r.id}-tab`,hidden:e!==r.id,className:"tab-panel",children:r.content},r.id))]})},_n=({options:n,value:e,onChange:t,ariaLabel:s="選択"})=>a.jsx("div",{className:"segmented-control",role:"group","aria-label":s,"data-no-swipe":"true",children:n.map(i=>a.jsx("button",{type:"button",className:`segmented-item ${e===i.id?"is-active":""}`,"aria-pressed":e===i.id,onClick:()=>t(i.id),children:i.label},i.id))}),vo=()=>{const{albums:n,selectAlbum:e,updateAlbum:t}=Nt(),{getSelectedAlbum:s}=Nt(),i=s(),{requestPlayAlbum:r}=rs(),{navigateToRoom:c}=Bs(),[o,l]=K.useState("shelf"),[u,h]=K.useState("all"),[d,f]=K.useState("new"),[p,m]=K.useState("public"),g=v=>{e(v)},_=K.useMemo(()=>n.filter(v=>v.musicData),[n]),y=!!i,w=!!i?.musicData,N=K.useMemo(()=>{const v=n.filter(x=>u==="public"?x.isPublic:u==="private"?!x.isPublic:u==="favorite"?x.isFavorite:!0),k=x=>{const j=Number(x.duration||0);return(x.musicData?1e3:0)+j};return v.slice().sort((x,j)=>d==="duration"?(j.duration||0)-(x.duration||0):d==="popular"?k(j)-k(x):String(j.createdAt).localeCompare(String(x.createdAt)))},[n,u,d]),A=d==="popular"?"人気順":d==="duration"?"長さ順":"新しい順",b=a.jsxs("div",{className:"bookshelf-container",children:[a.jsxs("div",{className:`gallery-shelf-stage ${N.length===0?"empty":""}`,children:[a.jsx(go,{albums:N,onBookClick:g,constellationEnabled:!1}),a.jsx("div",{className:"bookshelf-overlay-grid","aria-hidden":"true",children:N.map(v=>!v.gallery||!(v.isPublic||v.isFavorite)?null:a.jsx("div",{className:`bookshelf-badge ${i?.id===v.id?"is-selected":""}`,style:{gridColumn:v.gallery.positionIndex+1,gridRow:v.gallery.shelfIndex+1},children:v.isPublic||v.isFavorite?p==="favorite"&&v.isFavorite?a.jsxs("span",{className:"badge-chip badge-favorite badge-compact is-priority",children:[a.jsx("span",{className:"badge-dot"}),"お気に入り"]}):v.isPublic?a.jsxs("span",{className:`badge-chip badge-public badge-compact ${p==="public"?"is-priority":""}`.trim(),children:[a.jsx("span",{className:"badge-dot"}),"公開"]}):a.jsxs("span",{className:"badge-chip badge-favorite badge-compact",children:[a.jsx("span",{className:"badge-dot"}),"お気に入り"]}):null},v.id))}),N.length===0&&a.jsx("div",{className:"empty-shelf-overlay",children:a.jsx(_o,{title:"該当するアルバムがありません",description:"フィルタ条件を変えるか、Mainルームでセッションを開始してください。",actionLabel:"セッションを始める",onAction:()=>c("main"),icon:a.jsx("span",{className:"empty-icon-shape","aria-hidden":"true"})})})]}),a.jsxs("div",{className:"gallery-actionbar room-card","data-no-swipe":"true","aria-label":"選択中アルバムの操作",children:[a.jsxs("div",{className:"gallery-selection",children:[a.jsx("div",{className:"gallery-selection-label",children:"選択中"}),a.jsx("div",{className:"gallery-selection-value",children:i?i.title||i.mood:"未選択"})]}),a.jsxs("div",{className:"gallery-actions",children:[a.jsx("button",{className:"btn btn-primary",disabled:!y,onClick:()=>c("album"),children:"開く"}),a.jsx("button",{className:"btn btn-primary",disabled:!w||!i,onClick:()=>{i&&r(i,_)},children:"再生"}),a.jsx("button",{className:"btn",disabled:!y,onClick:()=>c("social"),children:"公開"}),a.jsx(ks,{triggerClassName:"btn",trigger:a.jsx("span",{children:"その他"}),placement:"top",triggerAriaHaspopup:"menu",children:({close:v})=>a.jsx(Cs,{items:[{id:"open",label:"アルバム詳細へ",onSelect:()=>{c("album"),v()}},{id:"publish",label:"SNSに公開",onSelect:()=>{c("social"),v()}},{id:"play",label:"再生",onSelect:()=>{i&&(r(i,_),v())}},{id:"favorite",label:i?.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{i&&(t(i.id,{isFavorite:!i.isFavorite}),v())}},{id:"public",label:i?.isPublic?"非公開にする":"公開にする",onSelect:()=>{i&&(t(i.id,{isPublic:!i.isPublic}),v())}}]})})]})]})]}),S=a.jsx("div",{className:"gallery-focus",children:i?a.jsxs("div",{className:"gallery-focus-card room-card",children:[a.jsx(St,{title:i.title||i.mood,mood:i.mood,imageUrl:i.imageDataURL,meta:`作成日: ${new Date(i.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:i.musicData?"再生可能":"音声なし",tone:i.musicData?"success":"default"},...i.isPublic?[{label:"公開中",tone:"info"}]:[],...i.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]}),a.jsxs("div",{className:"gallery-focus-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:()=>c("album"),children:"詳細へ"}),a.jsx("button",{className:"btn btn-primary",disabled:!i.musicData,onClick:()=>r(i,_),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>c("social"),children:"公開"})]})]}):a.jsxs("div",{className:"gallery-focus-empty room-card",children:[a.jsx("div",{className:"gallery-selection-label",children:"アルバム未選択"}),a.jsx("div",{className:"gallery-selection-value",children:"棚から選択すると詳細が表示されます。"})]})}),C=[{id:"shelf",label:"Shelf",content:b},{id:"focus",label:"Focus",content:S}];return a.jsxs("div",{className:"room-content gallery-room",children:[a.jsx($i,{pattern:"polyhedron",isActive:!1,layer:"background",placement:"topRight",sizePx:360,opacity:.08}),a.jsx("h1",{className:"room-title",children:"GALLERY"}),a.jsx("p",{className:"room-subtitle",children:"スクロールで時間を辿り、クリックで選ぶ"}),a.jsxs("div",{className:"gallery-toolbar room-card","data-no-swipe":"true",children:[a.jsxs("div",{className:"gallery-toolbar-left",children:[a.jsx(_n,{value:u,onChange:v=>h(v),ariaLabel:"表示フィルター",options:[{id:"all",label:"すべて"},{id:"public",label:"公開"},{id:"private",label:"非公開"},{id:"favorite",label:"お気に入り"}]}),a.jsxs("div",{className:"gallery-filter-tags",children:[a.jsx("span",{className:"filter-tag",children:u==="all"?"全件":u==="public"?"公開のみ":u==="private"?"非公開のみ":"お気に入り"}),a.jsx("span",{className:"filter-tag",children:A}),a.jsxs("span",{className:"filter-tag",children:["バッジ優先: ",p==="public"?"公開":"お気に入り"]})]})]}),a.jsxs("div",{className:"gallery-toolbar-right",children:[a.jsx(_n,{value:p,onChange:v=>m(v),ariaLabel:"バッジ優先",options:[{id:"public",label:"公開優先"},{id:"favorite",label:"お気に入り優先"}]}),a.jsx(ks,{triggerClassName:"btn",trigger:a.jsxs("span",{children:["並び替え: ",A]}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:v})=>a.jsx(Cs,{items:[{id:"new",label:"新しい順",onSelect:()=>{f("new"),v()}},{id:"popular",label:"人気順",onSelect:()=>{f("popular"),v()}},{id:"duration",label:"長さ順",onSelect:()=>{f("duration"),v()}}]})})]})]}),a.jsx(Yi,{items:C,value:o,onChange:l,ariaLabel:"ギャラリー表示"})]})},yo=2147483647,bo=({log:n})=>{if(!n)return a.jsxs("div",{className:"explainability-panel",children:[a.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),a.jsx("p",{className:"explainability-hint",children:"このアルバムの解説データがありません"})]});const e=t=>{const s=Math.round(t/1e3);if(s<60)return`${s}秒`;const i=Math.floor(s/60),r=s%60;return`${i}分${r}秒`};return a.jsxs("div",{className:"explainability-panel",children:[a.jsx("h3",{className:"explainability-title",children:"Liner Notes / 解説"}),n.analysis&&a.jsxs("div",{className:"explainability-section timeline-section",children:[a.jsx("h4",{className:"section-title",children:"生成フロー"}),a.jsxs("div",{className:"timeline",children:[a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"入力"}),a.jsx("span",{className:"timeline-value",children:new Date(n.input.timestamp).toLocaleTimeString("ja-JP")})]}),n.analysis&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"解析"}),a.jsxs("span",{className:"timeline-value",children:[e(n.analysis.duration)," (",n.analysis.provider,")"]})]}),n.imageGeneration&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"画像生成"}),a.jsxs("span",{className:"timeline-value",children:[e(n.imageGeneration.duration)," (",n.imageGeneration.provider,")"]})]}),n.musicGeneration&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"音楽生成"}),a.jsxs("span",{className:"timeline-value",children:[e(n.musicGeneration.duration)," (",n.musicGeneration.provider,")"]})]}),n.album&&a.jsxs("div",{className:"timeline-item",children:[a.jsx("span",{className:"timeline-label",children:"完成"}),a.jsxs("span",{className:"timeline-value",children:["合計: ",e(n.totalDuration)]})]})]})]}),n.analysis&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"感情分析"}),a.jsxs("div",{className:"analysis-explanation",children:[a.jsxs("div",{className:"ir-values",children:[a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Valence:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${(n.analysis.intermediateRepresentation.valence+1)/2*100}%`,backgroundColor:n.analysis.intermediateRepresentation.valence>0?"#4caf50":"#f44336"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.valence.toFixed(2)})]}),a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Arousal:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.arousal*100}%`,backgroundColor:"#2196f3"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.arousal.toFixed(2)})]}),a.jsxs("div",{className:"ir-value",children:[a.jsx("span",{className:"ir-label",children:"Focus:"}),a.jsx("div",{className:"ir-gauge",children:a.jsx("div",{className:"ir-gauge-fill",style:{width:`${n.analysis.intermediateRepresentation.focus*100}%`,backgroundColor:"#ff9800"}})}),a.jsx("span",{className:"ir-number",children:n.analysis.intermediateRepresentation.focus.toFixed(2)})]})]}),a.jsxs("div",{className:"motif-tags",children:[a.jsx("strong",{children:"モチーフタグ:"})," ",n.analysis.intermediateRepresentation.motif_tags.join("、")]}),a.jsxs("div",{className:"reasoning-text",children:[a.jsx("strong",{children:"理由:"})," ",n.analysis.reasoning]})]})]}),n.imageGeneration&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"なぜこの絵？"}),a.jsxs("div",{className:"image-explanation",children:[a.jsx("p",{className:"reasoning-text",children:n.imageGeneration.reasoning}),a.jsxs("div",{className:"image-details",children:[a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"スタイル:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.stylePreset})]}),n.imageGeneration.seed&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"Seed:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.seed})]}),a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"モデル:"}),a.jsx("span",{className:"detail-value",children:n.imageGeneration.model})]})]})]})]}),n.musicGeneration&&a.jsxs("div",{className:"explainability-section",children:[a.jsx("h4",{className:"section-title",children:"なぜこの曲？"}),a.jsxs("div",{className:"music-explanation",children:[a.jsx("p",{className:"reasoning-text",children:n.musicGeneration.reasoning}),a.jsx("div",{className:"music-details",children:n.musicGeneration.structure&&typeof n.musicGeneration.structure=="object"&&a.jsxs(a.Fragment,{children:[n.musicGeneration.structure.key&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"調:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.key})]}),n.musicGeneration.structure.tempo&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"テンポ:"}),a.jsxs("span",{className:"detail-value",children:[n.musicGeneration.structure.tempo," BPM"]})]}),n.musicGeneration.structure.timeSignature&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"拍子:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.timeSignature})]}),n.musicGeneration.structure.form&&a.jsxs("div",{className:"detail-item",children:[a.jsx("span",{className:"detail-label",children:"形式:"}),a.jsx("span",{className:"detail-value",children:n.musicGeneration.structure.form})]})]})})]})]}),n.errors&&n.errors.length>0&&a.jsxs("div",{className:"explainability-section error-section",children:[a.jsx("h4",{className:"section-title",children:"エラー"}),a.jsx("div",{className:"errors-list",children:n.errors.map((t,s)=>a.jsxs("div",{className:"error-item",children:[a.jsxs("span",{className:"error-stage",children:[t.stage,":"]}),a.jsx("span",{className:"error-message",children:t.error})]},s))})]})]})},xo=({dominantColors:n=["#D4AF37","#F4E5C2","#B8941E"],isPlaying:e=!1,beatAmplitude:t=0,mouseProximity:s=0,highlightedLayer:i=-1})=>{const r=T.useRef(null),c=T.useRef(),o=T.useRef([]);return T.useEffect(()=>{const l=r.current;if(!l)return;const u=l.getContext("2d");if(!u)return;const h=()=>{const m=l.parentElement;m&&(l.width=m.clientWidth,l.height=m.clientHeight)};h(),window.addEventListener("resize",h);const d=Math.min(5,n.length+2);o.current=Array.from({length:d},(m,g)=>({radius:50+g*30,maxRadius:200+g*50,color:n[g%n.length]||"#D4AF37",phase:g*Math.PI*2/d,phaseSpeed:5e-4+g*2e-4}));let f=0;const p=m=>{const g=m-f;f=m,u.clearRect(0,0,l.width,l.height);const _=l.width/2,y=l.height/2;o.current.forEach((w,N)=>{w.phase+=w.phaseSpeed*g;const A=Math.sin(w.phase),b=20+(e?t*30:0),S=w.radius+A*b,C=.1,v=.3,k=s*.2,x=i===N?.3:0,j=e?t*.15:0,M=Math.min(v,C+k+x+j),O=u.createRadialGradient(_,y,S-20,_,y,S+20);O.addColorStop(0,`${w.color}00`),O.addColorStop(.5,`${w.color}${Math.floor(M*255).toString(16).padStart(2,"0")}`),O.addColorStop(1,`${w.color}00`),u.fillStyle=O,u.globalCompositeOperation="lighter",u.beginPath(),u.arc(_,y,S,0,Math.PI*2),u.fill()}),c.current=requestAnimationFrame(p)};return c.current=requestAnimationFrame(p),()=>{window.removeEventListener("resize",h),c.current&&cancelAnimationFrame(c.current),u.clearRect(0,0,l.width,l.height)}},[n,e,t,s,i]),a.jsx("canvas",{ref:r,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:0},role:"img","aria-label":"アルバムのオーラ - 感情的な雰囲気を表現する光の輪"})},wo=()=>{const[n,e]=T.useState({x:0,y:0});return T.useEffect(()=>{const t=s=>{e({x:s.clientX,y:s.clientY})};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[]),n},To=(n,e=200)=>{const[t,s]=T.useState(0),i=wo();return T.useEffect(()=>{if(!n.current)return;const r=n.current.getBoundingClientRect(),c=r.left+r.width/2,o=r.top+r.height/2,l=Math.sqrt(Math.pow(i.x-c,2)+Math.pow(i.y-o,2)),u=Math.max(0,1-l/e);s(u)},[i,n,e]),t},No=()=>{const{getSelectedAlbum:n,selectAlbum:e,addAlbum:t,updateAlbum:s}=Nt(),{getLog:i}=jn(),{state:r,requestPlayAlbum:c}=rs(),{navigateToRoom:o}=Bs(),l=n(),u=l?.causalLogId?i(l.causalLogId):void 0,[h,d]=T.useState(!1),[f,p]=T.useState(null),[m,g]=T.useState(!1),_=T.useRef(null),y=To(_,300),[w,N]=T.useState(-1),A=x=>{const j=_.current;if(!j)return;const M=j.getBoundingClientRect(),O=(x.clientX-M.left)/Math.max(1,M.width),D=(x.clientY-M.top)/Math.max(1,M.height),q=Math.max(0,Math.min(1,O)),L=Math.max(0,Math.min(1,D)),B=(q-.5)*10,U=(.5-L)*7;j.style.setProperty("--tilt-x",`${U.toFixed(2)}deg`),j.style.setProperty("--tilt-y",`${B.toFixed(2)}deg`),j.style.setProperty("--shine-x",`${(q*100).toFixed(1)}%`),j.style.setProperty("--shine-y",`${(L*100).toFixed(1)}%`)},b=()=>{const x=_.current;x&&(x.style.setProperty("--tilt-x","0deg"),x.style.setProperty("--tilt-y","0deg"),x.style.setProperty("--shine-x","50%"),x.style.setProperty("--shine-y","45%"))},S=l?.metadata?.dominantColors||["#D4AF37","#F4E5C2","#B8941E"],C=r.playbackState===bt.PLAYING&&r.currentAlbum?.id===l?.id,v=()=>{e(null),o("gallery")},k=async()=>{if(!l||!l.metadata){p("メタデータが見つかりません");return}try{d(!0),p(null),g(!1);const x=Math.floor(Math.random()*yo),j=await zi({mood:l.mood,duration:l.duration,motifTags:l.metadata.motif_tags||[],stylePreset:l.metadata.stylePreset,seed:x,valence:l.metadata.valence,arousal:l.metadata.arousal,focus:l.metadata.focus,confidence:l.metadata.confidence}),M=await Xi(j.jobId,O=>{console.log("Regenerate status:",O)});if(M.status==="succeeded"&&M.resultUrl)t({mood:l.mood,duration:l.duration,imageDataURL:M.resultUrl,sessionData:l.sessionData,metadata:{...l.metadata,seed:x}}),g(!0),setTimeout(()=>g(!1),3e3);else throw new Error(M.errorMessage||"再生成に失敗しました")}catch(x){p(x instanceof Error?x.message:"再生成中にエラーが発生しました"),console.error("Regenerate error:",x)}finally{d(!1)}};return l?a.jsxs("div",{className:"room-content album-room",children:[a.jsxs("div",{className:"album-header room-header",children:[a.jsxs("div",{className:"album-header-left",children:[a.jsx("h1",{className:"album-title",children:l.title||l.mood}),a.jsxs("p",{className:"album-subtitle",children:["ムード: ",l.mood," ・ 選択したアルバムの詳細"]})]}),a.jsxs("div",{className:"album-header-actions room-header-actions",children:[a.jsx("button",{className:"btn back-to-gallery-btn",onClick:v,"aria-label":"ギャラリーに戻る",children:"ギャラリーへ"}),a.jsx("button",{className:"btn btn-primary",disabled:!l.musicData,onClick:()=>c(l),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>o("social"),children:"公開"}),a.jsx(ks,{triggerClassName:"btn",trigger:a.jsx("span",{children:"操作"}),placement:"bottom",triggerAriaHaspopup:"menu",children:({close:x})=>a.jsx(Cs,{items:[{id:"gallery",label:"ギャラリーへ戻る",onSelect:()=>{o("gallery"),x()}},{id:"publish",label:"SNSに公開",onSelect:()=>{o("social"),x()}},{id:"play",label:"再生",onSelect:()=>{c(l),x()}},{id:"favorite",label:l.isFavorite?"お気に入り解除":"お気に入り登録",onSelect:()=>{s(l.id,{isFavorite:!l.isFavorite}),x()}},{id:"public",label:l.isPublic?"非公開にする":"公開にする",onSelect:()=>{s(l.id,{isPublic:!l.isPublic}),x()}}]})})]})]}),a.jsxs("div",{className:"album-details",children:[a.jsxs("div",{className:`album-image-container ${C?"is-playing":""}`,ref:_,onMouseMove:A,onMouseLeave:b,children:[a.jsx(xo,{dominantColors:S,isPlaying:C,beatAmplitude:0,mouseProximity:y,highlightedLayer:w}),a.jsx("img",{src:l.imageDataURL,alt:`${l.mood}のセッション画像`,className:"album-image"})]}),a.jsxs("div",{className:"album-metadata",children:[a.jsx("div",{className:"album-summary-card",children:a.jsx(St,{variant:"compact",title:l.title||l.mood,mood:l.mood,imageUrl:l.imageDataURL,meta:`作成日: ${new Date(l.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:l.musicData?"再生可能":"音声なし",tone:l.musicData?"success":"default"},...l.isPublic?[{label:"公開中",tone:"info"}]:[],...l.isFavorite?[{label:"お気に入り",tone:"warning"}]:[]]})}),a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"基本情報"}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"ムード"}),a.jsx("span",{className:"metadata-value",children:l.mood})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"セッション時間"}),a.jsxs("span",{className:"metadata-value",children:[l.duration,"秒"]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"作成日"}),a.jsx("span",{className:"metadata-value",children:new Date(l.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),l.metadata&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"感情分析 (IR)"}),l.metadata.valence!==void 0&&a.jsxs("div",{className:"metadata-item",onMouseEnter:()=>N(0),onMouseLeave:()=>N(-1),children:[a.jsx("span",{className:"metadata-label",children:"Valence"}),a.jsxs("span",{className:"metadata-value",children:[l.metadata.valence.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",l.metadata.valence>0?"明るい":"暗い",")"]})]})]}),l.metadata.arousal!==void 0&&a.jsxs("div",{className:"metadata-item",onMouseEnter:()=>N(1),onMouseLeave:()=>N(-1),children:[a.jsx("span",{className:"metadata-label",children:"Arousal"}),a.jsxs("span",{className:"metadata-value",children:[l.metadata.arousal.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",l.metadata.arousal>.6?"動的":"静的",")"]})]})]}),l.metadata.focus!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"Focus"}),a.jsxs("span",{className:"metadata-value",children:[l.metadata.focus.toFixed(2),a.jsxs("span",{className:"metadata-hint",children:["(",l.metadata.focus>.7?"明瞭":"拡散",")"]})]})]}),l.metadata.confidence!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"信頼度"}),a.jsxs("span",{className:"metadata-value",children:[Math.round(l.metadata.confidence*100),"%"]})]}),l.metadata.motif_tags&&l.metadata.motif_tags.length>0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"モチーフ"}),a.jsx("span",{className:"metadata-value metadata-tags",children:l.metadata.motif_tags.join(", ")})]})]}),a.jsxs("div",{className:"metadata-section room-card",children:[a.jsx("h3",{className:"metadata-section-title",children:"生成パラメータ"}),l.metadata.stylePreset&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"スタイル"}),a.jsx("span",{className:"metadata-value",children:l.metadata.stylePreset})]}),l.metadata.seed!==void 0&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"シード"}),a.jsx("span",{className:"metadata-value metadata-id",children:l.metadata.seed})]}),l.metadata.provider&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"生成方法"}),a.jsx("span",{className:"metadata-value",children:l.metadata.provider==="replicate"?"Replicate (SDXL)":l.metadata.provider==="local"?"ローカル生成":l.metadata.provider})]})]}),l.musicMetadata&&a.jsxs("div",{className:"metadata-section",children:[a.jsx("h3",{className:"metadata-section-title",children:"音楽メタデータ"}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"調"}),a.jsx("span",{className:"metadata-value",children:l.musicMetadata.key})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"テンポ"}),a.jsxs("span",{className:"metadata-value",children:[l.musicMetadata.tempo," BPM"]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"拍子"}),a.jsx("span",{className:"metadata-value",children:l.musicMetadata.timeSignature})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"形式"}),a.jsx("span",{className:"metadata-value",children:l.musicMetadata.form})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"性格"}),a.jsx("span",{className:"metadata-value",children:l.musicMetadata.character})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"生成方法"}),a.jsx("span",{className:"metadata-value",children:l.musicMetadata.provider==="openai"?"OpenAI (GPT-4)":l.musicMetadata.provider==="rule-based"?"ルールベース":l.musicMetadata.provider})]}),l.musicData&&a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"フォーマット"}),a.jsxs("span",{className:"metadata-value",children:["MIDI (",Math.round(l.musicData.length/1024)," KB)"]})]})]}),l.metadata.provider==="replicate"&&a.jsxs("div",{className:"album-actions",children:[a.jsx("button",{className:"regenerate-btn",onClick:k,disabled:h,children:h?"再生成中...":"再生成 (新しいシード)"}),m&&a.jsx("div",{className:"regenerate-success",children:"再生成が完了しました。Galleryで新しいアルバムを確認できます。"}),f&&a.jsx("div",{className:"regenerate-error",children:f})]})]}),a.jsxs("div",{className:"metadata-item",children:[a.jsx("span",{className:"metadata-label",children:"アルバムID"}),a.jsx("span",{className:"metadata-value metadata-id",children:l.id})]})]}),a.jsx(bo,{log:u})]})]}):a.jsxs("div",{className:"room-content album-room",children:[a.jsx("h1",{className:"room-title",children:"ALBUM"}),a.jsx("p",{className:"room-subtitle",children:"アルバム詳細"}),a.jsxs("div",{className:"album-empty",children:[a.jsx("p",{children:"アルバムが選択されていません"}),a.jsx("p",{className:"album-empty-hint",children:"Galleryからアルバムを選択してください"})]})]})},So=()=>{const{albums:n,getSelectedAlbum:e,selectAlbum:t}=Nt(),s=e(),{navigateToRoom:i}=Bs(),{requestPlayAlbum:r}=rs(),[c,o]=K.useState("now"),l=n.filter(d=>d.musicData),u=s&&s.musicData?a.jsxs("div",{className:"music-panel",children:[a.jsx(St,{title:s.title||s.mood,mood:s.mood,imageUrl:s.imageDataURL,meta:`作成日: ${new Date(s.createdAt).toLocaleDateString("ja-JP")}`,badges:[{label:"再生中",tone:"success"},...s.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...s.isPublic?[{label:"公開",tone:"info"}]:[]]}),s.musicMetadata&&a.jsxs("div",{className:"music-meta-grid room-card",children:[a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"調"}),a.jsx("span",{children:s.musicMetadata.key})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"テンポ"}),a.jsxs("span",{children:[s.musicMetadata.tempo," BPM"]})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"拍子"}),a.jsx("span",{children:s.musicMetadata.timeSignature})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"形式"}),a.jsx("span",{children:s.musicMetadata.form})]}),a.jsxs("div",{className:"music-meta-row",children:[a.jsx("span",{className:"music-meta-label",children:"性格"}),a.jsx("span",{children:s.musicMetadata.character})]})]}),a.jsxs("div",{className:"music-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:()=>r(s,l),children:"再生"}),a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})]})]}):a.jsx("div",{className:"music-empty",children:"音楽付きアルバムを選択してください。Mainルームで外部生成を行うと曲付きアルバムが作成されます。"}),h=a.jsxs("div",{className:"music-panel",children:[a.jsxs("div",{className:"room-card",children:["音楽付きアルバム: ",l.length,"件"]}),l.length>0?a.jsx("div",{className:"music-library-grid",children:l.map(d=>a.jsx("button",{className:"album-card-button",onClick:()=>{t(d.id),r(d,l)},children:a.jsx(St,{title:d.title||d.mood,mood:d.mood,imageUrl:d.imageDataURL,meta:d.musicMetadata?`${d.musicMetadata.key} | ${d.musicMetadata.tempo} BPM | ${d.musicMetadata.form}`:void 0,badges:[{label:"再生",tone:"success"},...d.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...d.isPublic?[{label:"公開",tone:"info"}]:[]]})},d.id))}):a.jsx("div",{className:"music-empty",children:"音楽を生成するには、Mainルームでセッションを作成し、外部生成を使用してください。"})]});return a.jsxs("div",{className:"room-content music-room",children:[a.jsxs("div",{className:"room-header music-header",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"MUSIC"}),a.jsx("p",{className:"room-subtitle",children:"選択したアルバムを再生する"})]}),a.jsx("div",{className:"room-header-actions",children:a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"})})]}),a.jsx(Yi,{items:[{id:"now",label:"Now Playing",content:u},{id:"library",label:"Library",content:h}],value:c,onChange:o,ariaLabel:"音楽タブ"})]})},Us="https://airia-beyond.onrender.com";async function ko(n=50){const e=await fetch(`${Us}/api/social/posts?limit=${encodeURIComponent(String(n))}`);if(!e.ok)throw new Error(`Failed to load posts: ${e.status}`);return e.json()}async function Co(n){const e=await fetch(`${Us}/api/social/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to create post: ${e.status}`);return t}async function Ao(n){const e=await fetch(`${Us}/api/social/posts/${encodeURIComponent(n)}/like`,{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json().catch(()=>null);if(!e.ok)throw new Error(t?.message||`Failed to like post: ${e.status}`);return t}async function jo(n,e){const t=await fetch(`${Us}/api/social/posts/${encodeURIComponent(n)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.message||`Failed to comment: ${t.status}`);return s}const Mo={comment:a.jsx("path",{d:"M21 15a4 4 0 0 1-4 4H8l-5 5V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"}),heart:a.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"}),link:a.jsxs(a.Fragment,{children:[a.jsx("path",{d:"M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"}),a.jsx("path",{d:"M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1"})]}),chevronDown:a.jsx("path",{d:"M6 9l6 6 6-6"}),more:a.jsxs(a.Fragment,{children:[a.jsx("circle",{cx:"5",cy:"12",r:"1.6"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.6"}),a.jsx("circle",{cx:"19",cy:"12",r:"1.6"})]})},ys=({name:n,size:e=16,className:t})=>a.jsx("svg",{className:t,width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:Mo[n]}),Eo=()=>{const{albums:n,getSelectedAlbum:e,updateAlbum:t}=Nt(),s=e(),{navigateToRoom:i}=Bs(),[r,c]=K.useState([]),[o,l]=K.useState(!1),[u,h]=K.useState(null),[d,f]=K.useState(""),[p,m]=K.useState(""),[g,_]=K.useState(s?.id||(n[0]?.id??"")),[y,w]=K.useState(!1),[N,A]=K.useState({}),[b,S]=K.useState(null),[C,v]=K.useState("all"),[k,x]=K.useState({}),j=async E=>{const R=`${window.location.origin}/#social/${E}`;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(R);else{const V=document.createElement("input");V.value=R,document.body.appendChild(V),V.select(),document.execCommand("copy"),document.body.removeChild(V)}h("リンクをコピーしました"),setTimeout(()=>h(null),1500)}catch(V){h(V instanceof Error?V.message:String(V))}},M=K.useCallback(async()=>{l(!0),h(null);try{const E=await ko(50);c(E.posts||[])}catch(E){h(E instanceof Error?E.message:String(E))}finally{l(!1)}},[]);K.useEffect(()=>{M()},[M]),K.useEffect(()=>{s?.id&&_(s.id)},[s?.id]);const O=K.useMemo(()=>n.find(E=>E.id===g)||null,[n,g]),D=!!O?.imageDataURL&&!y,q=async()=>{if(O){w(!0),h(null);try{const E=await Co({authorName:d,caption:p,album:{title:O.title||O.mood,mood:O.mood,imageUrl:O.thumbnailUrl||O.imageDataURL,createdAt:O.createdAt}});c(R=>[E,...R]),O.isPublic||t(O.id,{isPublic:!0}),m("")}catch(E){h(E instanceof Error?E.message:String(E))}finally{w(!1)}}},L=async E=>{try{const R=await Ao(E);c(V=>V.map(Y=>Y.id===E?R:Y))}catch(R){h(R instanceof Error?R.message:String(R))}},B=async E=>{const R=(N[E]||"").trim();if(R){S(E),h(null);try{const V=await jo(E,{authorName:d,text:R});c(Y=>Y.map(ie=>ie.id===E?{...ie,comments:Array.isArray(ie.comments)?[...ie.comments,V]:[V]}:ie)),A(Y=>({...Y,[E]:""}))}catch(V){h(V instanceof Error?V.message:String(V))}finally{S(null)}}},U=E=>{x(R=>({...R,[E]:!R[E]}))};return a.jsxs("div",{className:"room-content social-room",children:[a.jsxs("div",{className:"social-header",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"room-title",children:"SOCIAL"}),a.jsx("p",{className:"room-subtitle",children:"作品を公開して、反応を集める"})]}),a.jsxs("div",{className:"social-header-actions","data-no-swipe":"true",children:[a.jsx("button",{className:"btn",onClick:()=>i("gallery"),children:"ギャラリーへ"}),a.jsx("button",{className:"btn",onClick:()=>void M(),disabled:o,children:"更新"})]})]}),a.jsx("div",{className:"social-filter","data-no-swipe":"true",children:a.jsx(_n,{value:C,onChange:E=>v(E),ariaLabel:"フィード切り替え",options:[{id:"all",label:"おすすめ"},{id:"following",label:"フォロー中"},{id:"trending",label:"トレンド"}]})}),a.jsxs("div",{className:"social-compose","data-no-swipe":"true","aria-label":"投稿フォーム",children:[a.jsxs("div",{className:"social-compose-grid",children:[a.jsxs("label",{className:"social-field",children:[a.jsx("span",{className:"social-label",children:"名前（任意）"}),a.jsx("input",{className:"social-input",value:d,onChange:E=>f(E.target.value),placeholder:"anonymous",maxLength:24})]}),a.jsxs("label",{className:"social-field",children:[a.jsx("span",{className:"social-label",children:"公開するアルバム"}),a.jsxs("select",{className:"social-select",value:g,onChange:E=>_(E.target.value),children:[n.length===0&&a.jsx("option",{value:"",children:"（アルバムがありません）"}),n.map(E=>a.jsx("option",{value:E.id,children:E.title||E.mood},E.id))]})]}),a.jsxs("label",{className:"social-field social-field-wide",children:[a.jsx("span",{className:"social-label",children:"キャプション"}),a.jsx("textarea",{className:"social-textarea",value:p,onChange:E=>m(E.target.value),placeholder:"この作品の一言（任意）",maxLength:240,rows:3})]})]}),a.jsxs("div",{className:"social-compose-actions",children:[a.jsx("button",{className:"btn btn-primary",disabled:!D,onClick:q,children:y?"公開中…":"公開する"}),O&&a.jsx("div",{className:"social-compose-preview","aria-label":"選択中アルバムのプレビュー",children:a.jsx(St,{variant:"compact",title:O.title||O.mood,mood:O.mood,imageUrl:O.thumbnailUrl||O.imageDataURL,badges:[{label:O.musicData?"再生可能":"音声なし",tone:O.musicData?"success":"default"}]})})]}),u&&a.jsx("div",{className:"social-error",children:u})]}),a.jsxs("div",{className:"social-timeline","aria-label":"タイムライン",children:[o&&r.length===0&&a.jsx("div",{className:"social-muted",children:"読み込み中…"}),!o&&r.length===0&&a.jsx("div",{className:"social-muted",children:"まだ投稿がありません"}),r.map(E=>a.jsxs("article",{className:"social-post","data-no-swipe":"true",children:[a.jsxs("header",{className:"social-post-header",children:[a.jsx("div",{className:"social-post-author",children:E.authorName||"anonymous"}),a.jsx("div",{className:"social-post-date",children:new Date(E.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})]}),a.jsx("div",{className:"social-post-album",children:a.jsx(St,{title:E.album?.title||"album",mood:E.album?.mood,imageUrl:E.album?.imageUrl,meta:E.album?.createdAt?`作成日: ${new Date(E.album.createdAt).toLocaleDateString("ja-JP")}`:void 0,badges:[{label:"公開作品",tone:"info"}]})}),E.caption&&a.jsx("div",{className:"social-post-caption",children:E.caption}),a.jsxs("div",{className:"social-post-actions",children:[a.jsxs("button",{className:`btn social-action ${k[E.id]?"is-active":""}`,onClick:()=>U(E.id),"aria-expanded":!!k[E.id],"aria-controls":`post-comments-${E.id}`,"aria-label":k[E.id]?"コメントを閉じる":"コメントを開く",children:[a.jsxs("span",{className:"social-action-main",children:[a.jsx(ys,{name:k[E.id]?"chevronDown":"comment",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:k[E.id]?"閉じる":"コメント"})]}),a.jsx("span",{className:"social-count-chip",children:Array.isArray(E.comments)?E.comments.length:0})]}),a.jsxs("button",{className:"btn social-action",onClick:()=>void L(E.id),children:[a.jsxs("span",{className:"social-action-main",children:[a.jsx(ys,{name:"heart",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:"いいね"})]}),a.jsx("span",{className:"social-count-chip",children:E.likes||0})]}),a.jsx("button",{className:"btn social-action",onClick:()=>void j(E.id),children:a.jsxs("span",{className:"social-action-main",children:[a.jsx(ys,{name:"link",className:"social-action-icon"}),a.jsx("span",{className:"social-action-label",children:"共有"})]})}),a.jsx(ks,{triggerClassName:"btn social-action social-action-iconOnly",trigger:a.jsx(ys,{name:"more",className:"social-action-icon"}),placement:"bottom",triggerAriaLabel:"メニュー",triggerAriaHaspopup:"menu",children:({close:R})=>a.jsx(Cs,{items:[{id:"copy",label:"リンクをコピー",onSelect:()=>{j(E.id),R()}},{id:"report",label:"通報する",onSelect:()=>{h("通報を受け付けました"),R()}}]})})]}),k[E.id]&&a.jsxs("div",{className:"social-post-comments",id:`post-comments-${E.id}`,children:[(E.comments||[]).slice(-6).map(R=>a.jsxs("div",{className:"social-comment",children:[a.jsx("span",{className:"social-comment-author",children:R.authorName||"anonymous"}),a.jsx("span",{className:"social-comment-text",children:R.text})]},R.id)),a.jsxs("div",{className:"social-comment-compose",children:[a.jsx("input",{className:"social-input",value:N[E.id]||"",onChange:R=>A(V=>({...V,[E.id]:R.target.value})),placeholder:"コメントを書く",maxLength:240}),a.jsx("button",{className:"btn btn-primary",disabled:b===E.id,onClick:()=>void B(E.id),children:b===E.id?"送信中…":"送信"})]})]})]},E.id))]})]})},Io=({open:n,onOpenChange:e,title:t,description:s,children:i,footer:r,size:c="md"})=>{const o=T.useId(),l=T.useId();return T.useEffect(()=>{if(!n)return;const u=h=>{h.key==="Escape"&&e(!1)};return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[n,e]),n?ba.createPortal(a.jsxs("div",{className:"dialog-overlay","data-no-swipe":"true","aria-hidden":!1,children:[a.jsx("div",{className:"dialog-backdrop",onClick:()=>e(!1),"aria-hidden":"true"}),a.jsxs("div",{className:`dialog-surface dialog-${c}`,role:"dialog","aria-modal":"true","aria-labelledby":o,"aria-describedby":s?l:void 0,children:[a.jsxs("header",{className:"dialog-header",children:[a.jsxs("div",{children:[a.jsx("h2",{id:o,className:"dialog-title",children:t}),s&&a.jsx("p",{id:l,className:"dialog-description",children:s})]}),a.jsx("button",{type:"button",className:"dialog-close","aria-label":"閉じる",onClick:()=>e(!1),children:"×"})]}),a.jsx("div",{className:"dialog-body",children:i}),r?a.jsx("footer",{className:"dialog-footer",children:r}):null]})]}),document.body):null},Oo=({label:n,children:e,placement:t="top"})=>{const s=T.useId(),[i,r]=T.useState(!1),c=[e.props["aria-describedby"],s].filter(Boolean).join(" ");return a.jsxs("span",{className:`tooltip-wrapper tooltip-${t}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),onFocusCapture:()=>r(!0),onBlurCapture:()=>r(!1),"data-no-swipe":"true",children:[K.cloneElement(e,{"aria-describedby":c}),a.jsx("span",{id:s,role:"tooltip",className:`tooltip-bubble ${i?"is-open":""}`,children:n})]})},yi="airia_theme";function Ro(n){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n==="system"?e?"dark":"light":n;document.documentElement.setAttribute("data-theme",t)}const Do=()=>{const[n,e]=K.useState(()=>{try{return localStorage.getItem(yi)||"system"}catch{return"system"}}),t=r=>{e(r);try{localStorage.setItem(yi,r)}catch{}Ro(r)},[s,i]=K.useState(!1);return a.jsxs("div",{className:"room-content info-room",children:[a.jsx("h1",{className:"room-title",children:"INFO"}),a.jsx("p",{className:"room-subtitle",children:"このアプリについて / ローカル運用 / デバッグ"}),a.jsxs("div",{className:"info-card",children:[a.jsxs("section",{className:"info-section",children:[a.jsx("h2",{className:"info-title",children:"目的"}),a.jsx("p",{className:"info-text",children:"会話を軸に、クラシック中心のレコメンドと、時々「生成イベント」（曲＋アルバムアート）を作ります。"})]}),a.jsxs("section",{className:"info-section",children:[a.jsx("h2",{className:"info-title",children:"ローカル運用"}),a.jsx("p",{className:"info-text",children:"有料APIを避けたい場合は、LLMはOllama、画像はComfyUIを推奨します。"})]}),a.jsxs("section",{className:"info-section","data-no-swipe":"true",children:[a.jsxs("div",{className:"info-actions",children:[a.jsx("h2",{className:"info-title",children:"テーマ"}),a.jsx(Oo,{label:"見やすさに合わせて切り替えできます",children:a.jsx("span",{className:"info-badge","aria-hidden":"true",children:"?"})})]}),a.jsx("div",{className:"info-actions",children:a.jsx("div",{className:"theme-toggle",role:"group","aria-label":"テーマ切り替え",children:[{id:"system",label:"システム"},{id:"light",label:"ライト"},{id:"dark",label:"ダーク"},{id:"high-contrast",label:"高コントラスト"}].map(r=>a.jsx("button",{type:"button",className:"theme-button","aria-pressed":n===r.id,onClick:()=>t(r.id),children:r.label},r.id))})}),a.jsx("p",{className:"info-text",children:"見やすさに合わせて切り替えられます。"})]}),a.jsxs("section",{className:"info-section",children:[a.jsxs("div",{className:"info-actions",children:[a.jsx("h2",{className:"info-title",children:"リンク"}),a.jsx("button",{type:"button",className:"info-reset",onClick:()=>i(!0),children:"アプリ情報"})]}),a.jsxs("ul",{className:"info-list",children:[a.jsx("li",{children:a.jsx("a",{className:"info-link",href:"https://github.com/AKITO-AKI/AIRIA-BEYOND",target:"_blank",rel:"noreferrer",children:"GitHub Repository"})}),a.jsxs("li",{children:[a.jsx("a",{className:"info-link",href:"https://ollama.com",target:"_blank",rel:"noreferrer",children:"Ollama"})," / ",a.jsx("a",{className:"info-link",href:"https://github.com/comfyanonymous/ComfyUI",target:"_blank",rel:"noreferrer",children:"ComfyUI"})]})]})]}),null]}),a.jsxs(Io,{open:s,onOpenChange:i,title:"AIRIA BEYOND",description:"Design Tokens / UI基盤の整備中",footer:a.jsx("button",{className:"btn btn-primary",onClick:()=>i(!1),children:"閉じる"}),children:[a.jsx("p",{className:"info-text",children:"テーマ・タイポグラフィ・余白・影・角丸・モーションを共通化し、品質を安定させるための基盤を整えています。"}),a.jsx("p",{className:"info-text",children:"次は Dialog / Tooltip / Toast などの基礎部品を統一規約で拡張していきます。"})]})]})},Po=({onDismiss:n})=>{const[e,t]=T.useState("enter");T.useEffect(()=>{const i=[window.setTimeout(()=>t("ready"),700),window.setTimeout(()=>t("exit"),2600),window.setTimeout(()=>n(),2900)];return()=>{i.forEach(r=>clearTimeout(r))}},[n]);const s=()=>{t("exit"),window.setTimeout(n,260)};return a.jsxs("div",{className:`splash-screen splash-${e}`,onClick:s,role:"button",tabIndex:0,onKeyDown:i=>{(i.key==="Enter"||i.key===" ")&&s()},"aria-label":"クリックして開始",children:[a.jsxs("div",{className:"splash-bg","aria-hidden":"true",children:[a.jsx("div",{className:"splash-orbit"}),a.jsx("div",{className:"splash-grain"})]}),a.jsxs("div",{className:"splash-content",children:[a.jsx("div",{className:"splash-mark","aria-hidden":"true",children:a.jsx("div",{className:"splash-monogram",children:"A"})}),a.jsx("h1",{className:"splash-title",children:"AIRIA BEYOND"}),a.jsx("div",{className:"splash-rule","aria-hidden":"true"}),a.jsx("p",{className:"splash-subtitle",children:"人生をじんわり染め上げる"}),a.jsx("div",{className:"splash-hint","aria-hidden":"true",children:e==="ready"?"クリックして開始":""})]})]})},Hi="15.1.22",bi=(n,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:n}),xi=(n,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:n}),vn=(n,e)=>({startTime:e,type:"setValue",value:n}),Zi=(n,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:n}),Ji=(n,e,{startTime:t,target:s,timeConstant:i})=>s+(e-s)*Math.exp((t-n)/i),Rt=n=>n.type==="exponentialRampToValue",As=n=>n.type==="linearRampToValue",ut=n=>Rt(n)||As(n),Mn=n=>n.type==="setValue",st=n=>n.type==="setValueCurve",js=(n,e,t,s)=>{const i=n[e];return i===void 0?s:ut(i)||Mn(i)?i.value:st(i)?i.values[i.values.length-1]:Ji(t,js(n,e-1,i.startTime,s),i)},wi=(n,e,t,s,i)=>t===void 0?[s.insertTime,i]:ut(t)?[t.endTime,t.value]:Mn(t)?[t.startTime,t.value]:st(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,js(n,e-1,t.startTime,i)],yn=n=>n.type==="cancelAndHold",bn=n=>n.type==="cancelScheduledValues",lt=n=>yn(n)||bn(n)?n.cancelTime:Rt(n)||As(n)?n.endTime:n.startTime,Ti=(n,e,t,{endTime:s,value:i})=>t===i?i:0<t&&0<i||t<0&&i<0?t*(i/t)**((n-e)/(s-e)):0,Ni=(n,e,t,{endTime:s,value:i})=>t+(n-e)/(s-e)*(i-t),Fo=(n,e)=>{const t=Math.floor(e),s=Math.ceil(e);return t===s?n[t]:(1-(e-t))*n[t]+(1-(s-e))*n[s]},Lo=(n,{duration:e,startTime:t,values:s})=>{const i=(n-t)/e*(s.length-1);return Fo(s,i)},bs=n=>n.type==="setTarget";class Vo{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=lt(e);if(yn(e)||bn(e)){const s=this._automationEvents.findIndex(r=>bn(e)&&st(r)?r.startTime+r.duration>=t:lt(r)>=t),i=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),yn(e)){const r=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&ut(i)){if(r!==void 0&&bs(r))throw new Error("The internal list is malformed.");const c=r===void 0?i.insertTime:st(r)?r.startTime+r.duration:lt(r),o=r===void 0?this._defaultValue:st(r)?r.values[r.values.length-1]:r.value,l=Rt(i)?Ti(t,c,o,i):Ni(t,c,o,i),u=Rt(i)?bi(l,t,this._currenTime):xi(l,t,this._currenTime);this._automationEvents.push(u)}if(r!==void 0&&bs(r)&&this._automationEvents.push(vn(this.getValue(t),t)),r!==void 0&&st(r)&&r.startTime+r.duration>t){const c=t-r.startTime,o=(r.values.length-1)/r.duration,l=Math.max(2,1+Math.ceil(c*o)),u=c/(l-1)*o,h=r.values.slice(0,l);if(u<1)for(let d=1;d<l;d+=1){const f=u*d%1;h[d]=r.values[d-1]*(1-f)+r.values[d]*f}this._automationEvents[this._automationEvents.length-1]=Zi(h,r.startTime,c)}}}else{const s=this._automationEvents.findIndex(c=>lt(c)>t),i=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(i!==void 0&&st(i)&&lt(i)+i.duration>t)return!1;const r=Rt(e)?bi(e.value,e.endTime,this._currenTime):As(e)?xi(e.value,t,this._currenTime):e;if(s===-1)this._automationEvents.push(r);else{if(st(e)&&t+e.duration>lt(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,r)}}return!0}flush(e){const t=this._automationEvents.findIndex(s=>lt(s)>e);if(t>1){const s=this._automationEvents.slice(t-1),i=s[0];bs(i)&&s.unshift(vn(js(this._automationEvents,t-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=s}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(c=>lt(c)>e),s=this._automationEvents[t],i=(t===-1?this._automationEvents.length:t)-1,r=this._automationEvents[i];if(r!==void 0&&bs(r)&&(s===void 0||!ut(s)||s.insertTime>e))return Ji(e,js(this._automationEvents,i-1,r.startTime,this._defaultValue),r);if(r!==void 0&&Mn(r)&&(s===void 0||!ut(s)))return r.value;if(r!==void 0&&st(r)&&(s===void 0||!ut(s)||r.startTime+r.duration>e))return e<r.startTime+r.duration?Lo(e,r):r.values[r.values.length-1];if(r!==void 0&&ut(r)&&(s===void 0||!ut(s)))return r.value;if(s!==void 0&&Rt(s)){const[c,o]=wi(this._automationEvents,i,r,s,this._defaultValue);return Ti(e,c,o,s)}if(s!==void 0&&As(s)){const[c,o]=wi(this._automationEvents,i,r,s,this._defaultValue);return Ni(e,c,o,s)}return this._defaultValue}}const qo=n=>({cancelTime:n,type:"cancelAndHold"}),Wo=n=>({cancelTime:n,type:"cancelScheduledValues"}),Bo=(n,e)=>({endTime:e,type:"exponentialRampToValue",value:n}),Uo=(n,e)=>({endTime:e,type:"linearRampToValue",value:n}),Go=(n,e,t)=>({startTime:e,target:n,timeConstant:t,type:"setTarget"}),$o=()=>new DOMException("","AbortError"),zo=n=>(e,t,[s,i,r],c)=>{n(e[i],[t,s,r],o=>o[0]===t&&o[1]===s,c)},Xo=n=>(e,t,s)=>{const i=[];for(let r=0;r<s.numberOfInputs;r+=1)i.push(new Set);n.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},Yo=n=>(e,t)=>{n.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},Lt=new WeakSet,Qi=new WeakMap,En=new WeakMap,Ki=new WeakMap,In=new WeakMap,Gs=new WeakMap,er=new WeakMap,xn=new WeakMap,wn=new WeakMap,Tn=new WeakMap,tr={construct(){return tr}},Ho=n=>{try{const e=new Proxy(n,tr);new e}catch{return!1}return!0},Si=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,ki=(n,e)=>{const t=[];let s=n.replace(/^[\s]+/,""),i=s.match(Si);for(;i!==null;){const r=i[1].slice(1,-1),c=i[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,e).toString());t.push(c),s=s.slice(i[0].length).replace(/^[\s]+/,""),i=s.match(Si)}return[t.join(";"),s]},Ci=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Ai=n=>{if(!Ho(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Zo=(n,e,t,s,i,r,c,o,l,u,h,d,f)=>{let p=0;return(m,g,_={credentials:"omit"})=>{const y=h.get(m);if(y!==void 0&&y.has(g))return Promise.resolve();const w=u.get(m);if(w!==void 0){const b=w.get(g);if(b!==void 0)return b}const N=r(m),A=N.audioWorklet===void 0?i(g).then(([b,S])=>{const[C,v]=ki(b,S),k=`${C};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${v}
})})(window,'_AWGS')`;return t(k)}).then(()=>{const b=f._AWGS.pop();if(b===void 0)throw new SyntaxError;s(N.currentTime,N.sampleRate,()=>b(class{},void 0,(S,C)=>{if(S.trim()==="")throw e();const v=wn.get(N);if(v!==void 0){if(v.has(S))throw e();Ai(C),Ci(C.parameterDescriptors),v.set(S,C)}else Ai(C),Ci(C.parameterDescriptors),wn.set(N,new Map([[S,C]]))},N.sampleRate,void 0,void 0))}):Promise.all([i(g),Promise.resolve(n(d,d))]).then(([[b,S],C])=>{const v=p+1;p=v;const[k,x]=ki(b,S),D=`${k};((AudioWorkletProcessor,registerProcessor)=>{${x}
})(${C?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${C?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${C?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${v}',class extends AudioWorkletProcessor{process(){return !1}})`,q=new Blob([D],{type:"application/javascript; charset=utf-8"}),L=URL.createObjectURL(q);return N.audioWorklet.addModule(L,_).then(()=>{if(o(N))return N;const B=c(N);return B.audioWorklet.addModule(L,_).then(()=>B)}).then(B=>{if(l===null)throw new SyntaxError;try{new l(B,`__sac${v}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(L))});return w===void 0?u.set(m,new Map([[g,A]])):w.set(g,A),A.then(()=>{const b=h.get(m);b===void 0?h.set(m,new Set([g])):b.add(g)}).finally(()=>{const b=u.get(m);b!==void 0&&b.delete(g)}),A}},Ge=(n,e)=>{const t=n.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},$s=(n,e)=>{const t=Array.from(n).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[s]=t;return n.delete(s),s},sr=(n,e,t,s)=>{const i=Ge(n,e),r=$s(i,c=>c[0]===t&&c[1]===s);return i.size===0&&n.delete(e),r},as=n=>Ge(er,n),Vt=n=>{if(Lt.has(n))throw new Error("The AudioNode is already stored.");Lt.add(n),as(n).forEach(e=>e(!0))},nr=n=>"port"in n,os=n=>{if(!Lt.has(n))throw new Error("The AudioNode is not stored.");Lt.delete(n),as(n).forEach(e=>e(!1))},Nn=(n,e)=>{!nr(n)&&e.every(t=>t.size===0)&&os(n)},Jo=(n,e,t,s,i,r,c,o,l,u,h,d,f)=>{const p=new WeakMap;return(m,g,_,y,w)=>{const{activeInputs:N,passiveInputs:A}=r(g),{outputs:b}=r(m),S=o(m),C=v=>{const k=l(g),x=l(m);if(v){const j=sr(A,m,_,y);n(N,m,j,!1),!w&&!d(m)&&t(x,k,_,y),f(g)&&Vt(g)}else{const j=s(N,m,_,y);e(A,y,j,!1),!w&&!d(m)&&i(x,k,_,y);const M=c(g);if(M===0)h(g)&&Nn(g,N);else{const O=p.get(g);O!==void 0&&clearTimeout(O),p.set(g,setTimeout(()=>{h(g)&&Nn(g,N)},M*1e3))}}};return u(b,[g,_,y],v=>v[0]===g&&v[1]===_&&v[2]===y,!0)?(S.add(C),h(m)?n(N,m,[_,y,C],!0):e(A,y,[m,_,C],!0),!0):!1}},Qo=n=>(e,t,[s,i,r],c)=>{const o=e.get(s);o===void 0?e.set(s,new Set([[i,t,r]])):n(o,[i,t,r],l=>l[0]===i&&l[1]===t,c)},Ko=n=>(e,t)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(s).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(s),s.disconnect()};t.addEventListener("ended",i)},ec=n=>(e,t)=>{n(e).add(t)},tc={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},sc=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=i(o),h={...tc,...l},d=s(u,h),f=r(u)?e():null;super(o,!1,d,f),this._nativeAnalyserNode=d}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(o){this._nativeAnalyserNode.fftSize=o}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(o){const l=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=o,!(o>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=l,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(o){const l=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=o,!(this._nativeAnalyserNode.maxDecibels>o))throw this._nativeAnalyserNode.minDecibels=l,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(o){this._nativeAnalyserNode.smoothingTimeConstant=o}getByteFrequencyData(o){this._nativeAnalyserNode.getByteFrequencyData(o)}getByteTimeDomainData(o){this._nativeAnalyserNode.getByteTimeDomainData(o)}getFloatFrequencyData(o){this._nativeAnalyserNode.getFloatFrequencyData(o)}getFloatTimeDomainData(o){this._nativeAnalyserNode.getFloatTimeDomainData(o)}},Ce=(n,e)=>n.context===e,nc=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,c)=>{let o=e(r);if(!Ce(o,c)){const u={channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation,fftSize:o.fftSize,maxDecibels:o.maxDecibels,minDecibels:o.minDecibels,smoothingTimeConstant:o.smoothingTimeConstant};o=n(c,u)}return s.set(c,o),await t(r,c,o),o};return{render(r,c){const o=s.get(c);return o!==void 0?Promise.resolve(o):i(r,c)}}},Ms=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Qe=()=>new DOMException("","IndexSizeError"),On=n=>{n.getChannelData=(e=>t=>{try{return e.call(n,t)}catch(s){throw s.code===12?Qe():s}})(n.getChannelData)},ic={numberOfChannels:1},rc=(n,e,t,s,i,r,c,o)=>{let l=null;return class ir{constructor(h){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:d,numberOfChannels:f,sampleRate:p}={...ic,...h};l===null&&(l=new i(1,1,44100));const m=s!==null&&e(r,r)?new s({length:d,numberOfChannels:f,sampleRate:p}):l.createBuffer(f,d,p);if(m.numberOfChannels===0)throw t();return typeof m.copyFromChannel!="function"?(c(m),On(m)):e(Ms,()=>Ms(m))||o(m),n.add(m),m}static[Symbol.hasInstance](h){return h!==null&&typeof h=="object"&&Object.getPrototypeOf(h)===ir.prototype||n.has(h)}}},Ie=-34028234663852886e22,Ae=-Ie,nt=n=>Lt.has(n),ac={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},oc=(n,e,t,s,i,r,c,o)=>class extends n{constructor(u,h){const d=r(u),f={...ac,...h},p=i(d,f),m=c(d),g=m?e():null;super(u,!1,p,g),this._audioBufferSourceNodeRenderer=g,this._isBufferNullified=!1,this._isBufferSet=f.buffer!==null,this._nativeAudioBufferSourceNode=p,this._onended=null,this._playbackRate=t(this,m,p.playbackRate,Ae,Ie)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(u){if(this._nativeAudioBufferSourceNode.buffer=u,u!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(u){this._nativeAudioBufferSourceNode.loop=u}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(u){this._nativeAudioBufferSourceNode.loopEnd=u}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(u){this._nativeAudioBufferSourceNode.loopStart=u}get onended(){return this._onended}set onended(u){const h=typeof u=="function"?o(this,u):null;this._nativeAudioBufferSourceNode.onended=h;const d=this._nativeAudioBufferSourceNode.onended;this._onended=d!==null&&d===h?u:d}get playbackRate(){return this._playbackRate}start(u=0,h=0,d){if(this._nativeAudioBufferSourceNode.start(u,h,d),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=d===void 0?[u,h]:[u,h,d]),this.context.state!=="closed"){Vt(this);const f=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",f),nt(this)&&os(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",f)}}stop(u=0){this._nativeAudioBufferSourceNode.stop(u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=u)}},cc=(n,e,t,s,i)=>()=>{const r=new WeakMap;let c=null,o=null;const l=async(u,h)=>{let d=t(u);const f=Ce(d,h);if(!f){const p={buffer:d.buffer,channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,loop:d.loop,loopEnd:d.loopEnd,loopStart:d.loopStart,playbackRate:d.playbackRate.value};d=e(h,p),c!==null&&d.start(...c),o!==null&&d.stop(o)}return r.set(h,d),f?await n(h,u.playbackRate,d.playbackRate):await s(h,u.playbackRate,d.playbackRate),await i(u,h,d),d};return{set start(u){c=u},set stop(u){o=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):l(u,h)}}},lc=n=>"playbackRate"in n,uc=n=>"frequency"in n&&"gain"in n,hc=n=>"offset"in n,dc=n=>!("frequency"in n)&&"gain"in n,pc=n=>"detune"in n&&"frequency"in n&&!("gain"in n),mc=n=>"pan"in n,je=n=>Ge(Qi,n),cs=n=>Ge(Ki,n),Sn=(n,e)=>{const{activeInputs:t}=je(n);t.forEach(i=>i.forEach(([r])=>{e.includes(n)||Sn(r,[...e,n])}));const s=lc(n)?[n.playbackRate]:nr(n)?Array.from(n.parameters.values()):uc(n)?[n.Q,n.detune,n.frequency,n.gain]:hc(n)?[n.offset]:dc(n)?[n.gain]:pc(n)?[n.detune,n.frequency]:mc(n)?[n.pan]:[];for(const i of s){const r=cs(i);r!==void 0&&r.activeInputs.forEach(([c])=>Sn(c,e))}nt(n)&&os(n)},rr=n=>{Sn(n.destination,[])},fc=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),gc=(n,e,t,s,i,r,c,o,l)=>class extends n{constructor(h={}){if(l===null)throw new Error("Missing the native AudioContext constructor.");let d;try{d=new l(h)}catch(m){throw m.code===12&&m.message==="sampleRate is not in range"?t():m}if(d===null)throw s();if(!fc(h.latencyHint))throw new TypeError(`The provided value '${h.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(h.sampleRate!==void 0&&d.sampleRate!==h.sampleRate)throw t();super(d,2);const{latencyHint:f}=h,{sampleRate:p}=d;if(this._baseLatency=typeof d.baseLatency=="number"?d.baseLatency:f==="balanced"?512/p:f==="interactive"||f===void 0?256/p:f==="playback"?1024/p:Math.max(2,Math.min(128,Math.round(f*p/128)))*128/p,this._nativeAudioContext=d,l.name==="webkitAudioContext"?(this._nativeGainNode=d.createGain(),this._nativeOscillatorNode=d.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(d.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,d.state==="running"){this._state="suspended";const m=()=>{this._state==="suspended"&&(this._state=null),d.removeEventListener("statechange",m)};d.addEventListener("statechange",m)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),rr(this)}))}createMediaElementSource(h){return new i(this,{mediaElement:h})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(h){return new c(this,{mediaStream:h})}createMediaStreamTrackSource(h){return new o(this,{mediaStreamTrack:h})}resume(){return this._state==="suspended"?new Promise((h,d)=>{const f=()=>{this._nativeAudioContext.removeEventListener("statechange",f),this._nativeAudioContext.state==="running"?h():this.resume().then(h,d)};this._nativeAudioContext.addEventListener("statechange",f)}):this._nativeAudioContext.resume().catch(h=>{throw h===void 0||h.code===15?e():h})}suspend(){return this._nativeAudioContext.suspend().catch(h=>{throw h===void 0?e():h})}},_c=(n,e,t,s,i,r,c,o)=>class extends n{constructor(u,h){const d=r(u),f=c(d),p=i(d,h,f),m=f?e(o):null;super(u,!1,p,m),this._isNodeOfNativeOfflineAudioContext=f,this._nativeAudioDestinationNode=p}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(u>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=u}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(u){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=u}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},vc=n=>{const e=new WeakMap,t=async(s,i)=>{const r=i.destination;return e.set(i,r),await n(s,i,r),r};return{render(s,i){const r=e.get(i);return r!==void 0?Promise.resolve(r):t(s,i)}}},yc=(n,e,t,s,i,r,c,o)=>(l,u)=>{const h=u.listener,d=()=>{const b=new Float32Array(1),S=e(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),C=c(u);let v=!1,k=[0,0,-1,0,1,0],x=[0,0,0];const j=()=>{if(v)return;v=!0;const q=s(u,256,9,0);q.onaudioprocess=({inputBuffer:L})=>{const B=[r(L,b,0),r(L,b,1),r(L,b,2),r(L,b,3),r(L,b,4),r(L,b,5)];B.some((E,R)=>E!==k[R])&&(h.setOrientation(...B),k=B);const U=[r(L,b,6),r(L,b,7),r(L,b,8)];U.some((E,R)=>E!==x[R])&&(h.setPosition(...U),x=U)},S.connect(q)},M=q=>L=>{L!==k[q]&&(k[q]=L,h.setOrientation(...k))},O=q=>L=>{L!==x[q]&&(x[q]=L,h.setPosition(...x))},D=(q,L,B)=>{const U=t(u,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L});U.connect(S,0,q),U.start(),Object.defineProperty(U.offset,"defaultValue",{get(){return L}});const E=n({context:l},C,U.offset,Ae,Ie);return o(E,"value",R=>()=>R.call(E),R=>V=>{try{R.call(E,V)}catch(Y){if(Y.code!==9)throw Y}j(),C&&B(V)}),E.cancelAndHoldAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.cancelAndHoldAtTime),E.cancelScheduledValues=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.cancelScheduledValues),E.exponentialRampToValueAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.exponentialRampToValueAtTime),E.linearRampToValueAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.linearRampToValueAtTime),E.setTargetAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.setTargetAtTime),E.setValueAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.setValueAtTime),E.setValueCurveAtTime=(R=>C?()=>{throw i()}:(...V)=>{const Y=R.apply(E,V);return j(),Y})(E.setValueCurveAtTime),E};return{forwardX:D(0,0,M(0)),forwardY:D(1,0,M(1)),forwardZ:D(2,-1,M(2)),positionX:D(6,0,O(0)),positionY:D(7,0,O(1)),positionZ:D(8,0,O(2)),upX:D(3,0,M(3)),upY:D(4,1,M(4)),upZ:D(5,0,M(5))}},{forwardX:f,forwardY:p,forwardZ:m,positionX:g,positionY:_,positionZ:y,upX:w,upY:N,upZ:A}=h.forwardX===void 0?d():h;return{get forwardX(){return f},get forwardY(){return p},get forwardZ(){return m},get positionX(){return g},get positionY(){return _},get positionZ(){return y},get upX(){return w},get upY(){return N},get upZ(){return A}}},Es=n=>"context"in n,ls=n=>Es(n[0]),Mt=(n,e,t,s)=>{for(const i of n)if(t(i)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(e),!0},ji=(n,e,[t,s],i)=>{Mt(n,[e,t,s],r=>r[0]===e&&r[1]===t,i)},Mi=(n,[e,t,s],i)=>{const r=n.get(e);r===void 0?n.set(e,new Set([[t,s]])):Mt(r,[t,s],c=>c[0]===t,i)},zt=n=>"inputs"in n,Is=(n,e,t,s)=>{if(zt(e)){const i=e.inputs[s];return n.connect(i,t,0),[i,t,0]}return n.connect(e,t,s),[e,t,s]},ar=(n,e,t)=>{for(const s of n)if(s[0]===e&&s[1]===t)return n.delete(s),s;return null},bc=(n,e,t)=>$s(n,s=>s[0]===e&&s[1]===t),or=(n,e)=>{if(!as(n).delete(e))throw new Error("Missing the expected event listener.")},cr=(n,e,t)=>{const s=Ge(n,e),i=$s(s,r=>r[0]===t);return s.size===0&&n.delete(e),i},Os=(n,e,t,s)=>{zt(e)?n.disconnect(e.inputs[s],t,0):n.disconnect(e,t,s)},ne=n=>Ge(En,n),ts=n=>Ge(In,n),kt=n=>xn.has(n),Ns=n=>!Lt.has(n),Ei=(n,e)=>new Promise(t=>{if(e!==null)t(!0);else{const s=n.createScriptProcessor(256,1,1),i=n.createGain(),r=n.createBuffer(1,2,44100),c=r.getChannelData(0);c[0]=1,c[1]=1;const o=n.createBufferSource();o.buffer=r,o.loop=!0,o.connect(s).connect(n.destination),o.connect(i),o.disconnect(i),s.onaudioprocess=l=>{const u=l.inputBuffer.getChannelData(0);Array.prototype.some.call(u,h=>h===1)?t(!0):t(!1),o.stop(),s.onaudioprocess=null,o.disconnect(s),s.disconnect(n.destination)},o.start()}}),mn=(n,e)=>{const t=new Map;for(const s of n)for(const i of s){const r=t.get(i);t.set(i,r===void 0?1:r+1)}t.forEach((s,i)=>e(i,s))},Rs=n=>"context"in n,xc=n=>{const e=new Map;n.connect=(t=>(s,i=0,r=0)=>{const c=Rs(s)?t(s,i,r):t(s,i),o=e.get(s);return o===void 0?e.set(s,[{input:r,output:i}]):o.every(l=>l.input!==r||l.output!==i)&&o.push({input:r,output:i}),c})(n.connect.bind(n)),n.disconnect=(t=>(s,i,r)=>{if(t.apply(n),s===void 0)e.clear();else if(typeof s=="number")for(const[c,o]of e){const l=o.filter(u=>u.output!==s);l.length===0?e.delete(c):e.set(c,l)}else if(e.has(s))if(i===void 0)e.delete(s);else{const c=e.get(s);if(c!==void 0){const o=c.filter(l=>l.output!==i&&(l.input!==r||r===void 0));o.length===0?e.delete(s):e.set(s,o)}}for(const[c,o]of e)o.forEach(l=>{Rs(c)?n.connect(c,l.output,l.input):n.connect(c,l.output)})})(n.disconnect)},wc=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:r}=cs(e),{outputs:c}=je(n),o=as(n),l=u=>{const h=ne(n),d=ts(e);if(u){const f=cr(r,n,t);ji(i,n,f,!1),!s&&!kt(n)&&h.connect(d,t)}else{const f=bc(i,n,t);Mi(r,f,!1),!s&&!kt(n)&&h.disconnect(d,t)}};return Mt(c,[e,t],u=>u[0]===e&&u[1]===t,!0)?(o.add(l),nt(n)?ji(i,n,[t,l],!0):Mi(r,[n,t,l],!0),!0):!1},Tc=(n,e,t,s)=>{const{activeInputs:i,passiveInputs:r}=je(e),c=ar(i[s],n,t);return c===null?[sr(r,n,t,s)[2],!1]:[c[2],!0]},Nc=(n,e,t)=>{const{activeInputs:s,passiveInputs:i}=cs(e),r=ar(s,n,t);return r===null?[cr(i,n,t)[1],!1]:[r[2],!0]},Rn=(n,e,t,s,i)=>{const[r,c]=Tc(n,t,s,i);if(r!==null&&(or(n,r),c&&!e&&!kt(n)&&Os(ne(n),ne(t),s,i)),nt(t)){const{activeInputs:o}=je(t);Nn(t,o)}},Dn=(n,e,t,s)=>{const[i,r]=Nc(n,t,s);i!==null&&(or(n,i),r&&!e&&!kt(n)&&ne(n).disconnect(ts(t),s))},Sc=(n,e)=>{const t=je(n),s=[];for(const i of t.outputs)ls(i)?Rn(n,e,...i):Dn(n,e,...i),s.push(i[0]);return t.outputs.clear(),s},kc=(n,e,t)=>{const s=je(n),i=[];for(const r of s.outputs)r[1]===t&&(ls(r)?Rn(n,e,...r):Dn(n,e,...r),i.push(r[0]),s.outputs.delete(r));return i},Cc=(n,e,t,s,i)=>{const r=je(n);return Array.from(r.outputs).filter(c=>c[0]===t&&(s===void 0||c[1]===s)&&(i===void 0||c[2]===i)).map(c=>(ls(c)?Rn(n,e,...c):Dn(n,e,...c),r.outputs.delete(c),c[0]))},Ac=(n,e,t,s,i,r,c,o,l,u,h,d,f,p,m,g)=>class extends u{constructor(y,w,N,A){super(N),this._context=y,this._nativeAudioNode=N;const b=h(y);d(b)&&t(Ei,()=>Ei(b,g))!==!0&&xc(N),En.set(this,N),er.set(this,new Set),y.state!=="closed"&&w&&Vt(this),n(this,A,N)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(y){this._nativeAudioNode.channelCount=y}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(y){this._nativeAudioNode.channelCountMode=y}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(y){this._nativeAudioNode.channelInterpretation=y}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(y,w=0,N=0){if(w<0||w>=this._nativeAudioNode.numberOfOutputs)throw i();const A=h(this._context),b=m(A);if(f(y)||p(y))throw r();if(Es(y)){const v=ne(y);try{const x=Is(this._nativeAudioNode,v,w,N),j=Ns(this);(b||j)&&this._nativeAudioNode.disconnect(...x),this.context.state!=="closed"&&!j&&Ns(y)&&Vt(y)}catch(x){throw x.code===12?r():x}if(e(this,y,w,N,b)){const x=l([this],y);mn(x,s(b))}return y}const S=ts(y);if(S.name==="playbackRate"&&S.maxValue===1024)throw c();try{this._nativeAudioNode.connect(S,w),(b||Ns(this))&&this._nativeAudioNode.disconnect(S,w)}catch(v){throw v.code===12?r():v}if(wc(this,y,w,b)){const v=l([this],y);mn(v,s(b))}}disconnect(y,w,N){let A;const b=h(this._context),S=m(b);if(y===void 0)A=Sc(this,S);else if(typeof y=="number"){if(y<0||y>=this.numberOfOutputs)throw i();A=kc(this,S,y)}else{if(w!==void 0&&(w<0||w>=this.numberOfOutputs)||Es(y)&&N!==void 0&&(N<0||N>=y.numberOfInputs))throw i();if(A=Cc(this,S,y,w,N),A.length===0)throw r()}for(const C of A){const v=l([this],C);mn(v,o)}}},jc=(n,e,t,s,i,r,c,o,l,u,h,d,f)=>(p,m,g,_=null,y=null)=>{const w=g.value,N=new Vo(w),A=m?s(N):null,b={get defaultValue(){return w},get maxValue(){return _===null?g.maxValue:_},get minValue(){return y===null?g.minValue:y},get value(){return g.value},set value(S){g.value=S,b.setValueAtTime(S,p.context.currentTime)},cancelAndHoldAtTime(S){if(typeof g.cancelAndHoldAtTime=="function")A===null&&N.flush(p.context.currentTime),N.add(i(S)),g.cancelAndHoldAtTime(S);else{const C=Array.from(N).pop();A===null&&N.flush(p.context.currentTime),N.add(i(S));const v=Array.from(N).pop();g.cancelScheduledValues(S),C!==v&&v!==void 0&&(v.type==="exponentialRampToValue"?g.exponentialRampToValueAtTime(v.value,v.endTime):v.type==="linearRampToValue"?g.linearRampToValueAtTime(v.value,v.endTime):v.type==="setValue"?g.setValueAtTime(v.value,v.startTime):v.type==="setValueCurve"&&g.setValueCurveAtTime(v.values,v.startTime,v.duration))}return b},cancelScheduledValues(S){return A===null&&N.flush(p.context.currentTime),N.add(r(S)),g.cancelScheduledValues(S),b},exponentialRampToValueAtTime(S,C){if(S===0)throw new RangeError;if(!Number.isFinite(C)||C<0)throw new RangeError;const v=p.context.currentTime;return A===null&&N.flush(v),Array.from(N).length===0&&(N.add(u(w,v)),g.setValueAtTime(w,v)),N.add(c(S,C)),g.exponentialRampToValueAtTime(S,C),b},linearRampToValueAtTime(S,C){const v=p.context.currentTime;return A===null&&N.flush(v),Array.from(N).length===0&&(N.add(u(w,v)),g.setValueAtTime(w,v)),N.add(o(S,C)),g.linearRampToValueAtTime(S,C),b},setTargetAtTime(S,C,v){return A===null&&N.flush(p.context.currentTime),N.add(l(S,C,v)),g.setTargetAtTime(S,C,v),b},setValueAtTime(S,C){return A===null&&N.flush(p.context.currentTime),N.add(u(S,C)),g.setValueAtTime(S,C),b},setValueCurveAtTime(S,C,v){const k=S instanceof Float32Array?S:new Float32Array(S);if(d!==null&&d.name==="webkitAudioContext"){const x=C+v,j=p.context.sampleRate,M=Math.ceil(C*j),O=Math.floor(x*j),D=O-M,q=new Float32Array(D);for(let B=0;B<D;B+=1){const U=(k.length-1)/v*((M+B)/j-C),E=Math.floor(U),R=Math.ceil(U);q[B]=E===R?k[E]:(1-(U-E))*k[E]+(1-(R-U))*k[R]}A===null&&N.flush(p.context.currentTime),N.add(h(q,C,v)),g.setValueCurveAtTime(q,C,v);const L=O/j;L<x&&f(b,q[q.length-1],L),f(b,k[k.length-1],x)}else A===null&&N.flush(p.context.currentTime),N.add(h(k,C,v)),g.setValueCurveAtTime(k,C,v);return b}};return t.set(b,g),e.set(b,p),n(b,A),b},Mc=n=>({replay(e){for(const t of n)if(t.type==="exponentialRampToValue"){const{endTime:s,value:i}=t;e.exponentialRampToValueAtTime(i,s)}else if(t.type==="linearRampToValue"){const{endTime:s,value:i}=t;e.linearRampToValueAtTime(i,s)}else if(t.type==="setTarget"){const{startTime:s,target:i,timeConstant:r}=t;e.setTargetAtTime(i,s,r)}else if(t.type==="setValue"){const{startTime:s,value:i}=t;e.setValueAtTime(i,s)}else if(t.type==="setValueCurve"){const{duration:s,startTime:i,values:r}=t;e.setValueCurveAtTime(r,i,s)}else throw new Error("Can't apply an unknown automation.")}});class lr{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((s,i)=>e.call(t,s,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const Ec={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},Ic=(n,e,t,s,i,r,c,o,l,u,h,d,f,p)=>class extends e{constructor(g,_,y){var w;const N=o(g),A=l(N),b=h({...Ec,...y});f(b);const S=wn.get(N),C=S?.get(_),v=A||N.state!=="closed"?N:(w=c(N))!==null&&w!==void 0?w:N,k=i(v,A?null:g.baseLatency,u,_,C,b),x=A?s(_,b,C):null;super(g,!0,k,x);const j=[];k.parameters.forEach((O,D)=>{const q=t(this,A,O);j.push([D,q])}),this._nativeAudioWorkletNode=k,this._onprocessorerror=null,this._parameters=new lr(j),A&&n(N,this);const{activeInputs:M}=r(this);d(k,M)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(g){const _=typeof g=="function"?p(this,g):null;this._nativeAudioWorkletNode.onprocessorerror=_;const y=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=y!==null&&y===_?g:y}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function Ds(n,e,t,s,i){if(typeof n.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),n.copyFromChannel(e[t],s,i);else{const r=n.getChannelData(s);if(e[t].byteLength===0)e[t]=r.slice(i,i+128);else{const c=new Float32Array(r.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(c)}}}const ur=(n,e,t,s,i)=>{typeof n.copyToChannel=="function"?e[t].byteLength!==0&&n.copyToChannel(e[t],s,i):e[t].byteLength!==0&&n.getChannelData(s).set(e[t],i)},Ps=(n,e)=>{const t=[];for(let s=0;s<n;s+=1){const i=[],r=typeof e=="number"?e:e[s];for(let c=0;c<r;c+=1)i.push(new Float32Array(128));t.push(i)}return t},Oc=(n,e)=>{const t=Ge(Tn,n),s=ne(e);return Ge(t,s)},Rc=async(n,e,t,s,i,r,c)=>{const o=e===null?Math.ceil(n.context.length/128)*128:e.length,l=s.channelCount*s.numberOfInputs,u=i.reduce((_,y)=>_+y,0),h=u===0?null:t.createBuffer(u,o,t.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const d=je(n),f=await Oc(t,n),p=Ps(s.numberOfInputs,s.channelCount),m=Ps(s.numberOfOutputs,i),g=Array.from(n.parameters.keys()).reduce((_,y)=>({..._,[y]:new Float32Array(128)}),{});for(let _=0;_<o;_+=128){if(s.numberOfInputs>0&&e!==null)for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<s.channelCount;w+=1)Ds(e,p[y],w,w,_);r.parameterDescriptors!==void 0&&e!==null&&r.parameterDescriptors.forEach(({name:y},w)=>{Ds(e,g,y,l+w,_)});for(let y=0;y<s.numberOfInputs;y+=1)for(let w=0;w<i[y];w+=1)m[y][w].byteLength===0&&(m[y][w]=new Float32Array(128));try{const y=p.map((N,A)=>d.activeInputs[A].size===0?[]:N),w=c(_/t.sampleRate,t.sampleRate,()=>f.process(y,m,g));if(h!==null)for(let N=0,A=0;N<s.numberOfOutputs;N+=1){for(let b=0;b<i[N];b+=1)ur(h,m[N],b,A+b,_);A+=i[N]}if(!w)break}catch(y){n.dispatchEvent(new ErrorEvent("processorerror",{colno:y.colno,filename:y.filename,lineno:y.lineno,message:y.message}));break}}return h},Dc=(n,e,t,s,i,r,c,o,l,u,h,d,f,p,m,g)=>(_,y,w)=>{const N=new WeakMap;let A=null;const b=async(S,C)=>{let v=h(S),k=null;const x=Ce(v,C),j=Array.isArray(y.outputChannelCount)?y.outputChannelCount:Array.from(y.outputChannelCount);if(d===null){const M=j.reduce((L,B)=>L+B,0),O=i(C,{channelCount:Math.max(1,M),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,M)}),D=[];for(let L=0;L<S.numberOfOutputs;L+=1)D.push(s(C,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:j[L]}));const q=c(C,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1});q.connect=e.bind(null,D),q.disconnect=l.bind(null,D),k=[O,D,q]}else x||(v=new d(C,_));if(N.set(C,k===null?v:k[2]),k!==null){if(A===null){if(w===void 0)throw new Error("Missing the processor constructor.");if(f===null)throw new Error("Missing the native OfflineAudioContext constructor.");const B=S.channelCount*S.numberOfInputs,U=w.parameterDescriptors===void 0?0:w.parameterDescriptors.length,E=B+U;A=Rc(S,E===0?null:await(async()=>{const V=new f(E,Math.ceil(S.context.length/128)*128,C.sampleRate),Y=[],ie=[];for(let F=0;F<y.numberOfInputs;F+=1)Y.push(c(V,{channelCount:y.channelCount,channelCountMode:y.channelCountMode,channelInterpretation:y.channelInterpretation,gain:1})),ie.push(i(V,{channelCount:y.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:y.channelCount}));const xe=await Promise.all(Array.from(S.parameters.values()).map(async F=>{const P=r(V,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:F.value});return await p(V,F,P.offset),P})),X=s(V,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,B+U)});for(let F=0;F<y.numberOfInputs;F+=1){Y[F].connect(ie[F]);for(let P=0;P<y.channelCount;P+=1)ie[F].connect(X,P,F*y.channelCount+P)}for(const[F,P]of xe.entries())P.connect(X,0,B+F),P.start(0);return X.connect(V.destination),await Promise.all(Y.map(F=>m(S,V,F))),g(V)})(),C,y,j,w,u)}const M=await A,O=t(C,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[D,q,L]=k;M!==null&&(O.buffer=M,O.start(0)),O.connect(D);for(let B=0,U=0;B<S.numberOfOutputs;B+=1){const E=q[B];for(let R=0;R<j[B];R+=1)D.connect(E,U+R,R);U+=j[B]}return L}if(x)for(const[M,O]of S.parameters.entries())await n(C,O,v.parameters.get(M));else for(const[M,O]of S.parameters.entries())await p(C,O,v.parameters.get(M));return await m(S,C,v),v};return{render(S,C){o(C,S);const v=N.get(C);return v!==void 0?Promise.resolve(v):b(S,C)}}},Pc=(n,e,t,s,i,r,c,o,l,u,h,d,f,p,m,g,_,y,w,N)=>class extends m{constructor(b,S){super(b,S),this._nativeContext=b,this._audioWorklet=n===void 0?void 0:{addModule:(C,v)=>n(this,C,v)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new i(this)}createBuffer(b,S,C){return new t({length:S,numberOfChannels:b,sampleRate:C})}createBufferSource(){return new s(this)}createChannelMerger(b=6){return new r(this,{numberOfInputs:b})}createChannelSplitter(b=6){return new c(this,{numberOfOutputs:b})}createConstantSource(){return new o(this)}createConvolver(){return new l(this)}createDelay(b=1){return new h(this,{maxDelayTime:b})}createDynamicsCompressor(){return new d(this)}createGain(){return new f(this)}createIIRFilter(b,S){return new p(this,{feedback:S,feedforward:b})}createOscillator(){return new g(this)}createPanner(){return new _(this)}createPeriodicWave(b,S,C={disableNormalization:!1}){return new y(this,{...C,imag:S,real:b})}createStereoPanner(){return new w(this)}createWaveShaper(){return new N(this)}decodeAudioData(b,S,C){return u(this._nativeContext,b).then(v=>(typeof S=="function"&&S(v),v),v=>{throw typeof C=="function"&&C(v),v})}},Fc={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Lc=(n,e,t,s,i,r,c,o)=>class extends n{constructor(u,h){const d=r(u),f={...Fc,...h},p=i(d,f),m=c(d),g=m?t():null;super(u,!1,p,g),this._Q=e(this,m,p.Q,Ae,Ie),this._detune=e(this,m,p.detune,1200*Math.log2(Ae),-1200*Math.log2(Ae)),this._frequency=e(this,m,p.frequency,u.sampleRate/2,0),this._gain=e(this,m,p.gain,40*Math.log10(Ae),Ie),this._nativeBiquadFilterNode=p,o(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(u){this._nativeBiquadFilterNode.type=u}getFrequencyResponse(u,h,d){try{this._nativeBiquadFilterNode.getFrequencyResponse(u,h,d)}catch(f){throw f.code===11?s():f}if(u.length!==h.length||h.length!==d.length)throw s()}},Vc=(n,e,t,s,i)=>()=>{const r=new WeakMap,c=async(o,l)=>{let u=t(o);const h=Ce(u,l);if(!h){const d={Q:u.Q.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,gain:u.gain.value,type:u.type};u=e(l,d)}return r.set(l,u),h?(await n(l,o.Q,u.Q),await n(l,o.detune,u.detune),await n(l,o.frequency,u.frequency),await n(l,o.gain,u.gain)):(await s(l,o.Q,u.Q),await s(l,o.detune,u.detune),await s(l,o.frequency,u.frequency),await s(l,o.gain,u.gain)),await i(o,l,u),u};return{render(o,l){const u=r.get(l);return u!==void 0?Promise.resolve(u):c(o,l)}}},qc=(n,e)=>(t,s)=>{const i=e.get(t);if(i!==void 0)return i;const r=n.get(t);if(r!==void 0)return r;try{const c=s();return c instanceof Promise?(n.set(t,c),c.catch(()=>!1).then(o=>(n.delete(t),e.set(t,o),o))):(e.set(t,c),c)}catch{return e.set(t,!1),!1}},Wc={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Bc=(n,e,t,s,i)=>class extends n{constructor(c,o){const l=s(c),u={...Wc,...o},h=t(l,u),d=i(l)?e():null;super(c,!1,h,d)}},Uc=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,c)=>{let o=e(r);if(!Ce(o,c)){const u={channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation,numberOfInputs:o.numberOfInputs};o=n(c,u)}return s.set(c,o),await t(r,c,o),o};return{render(r,c){const o=s.get(c);return o!==void 0?Promise.resolve(o):i(r,c)}}},Gc={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},$c=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=s(o),h=r({...Gc,...l}),d=t(u,h),f=i(u)?e():null;super(o,!1,d,f)}},zc=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,c)=>{let o=e(r);if(!Ce(o,c)){const u={channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation,numberOfOutputs:o.numberOfOutputs};o=n(c,u)}return s.set(c,o),await t(r,c,o),o};return{render(r,c){const o=s.get(c);return o!==void 0?Promise.resolve(o):i(r,c)}}},Xc=n=>(e,t,s)=>n(t,e,s),Yc=n=>(e,t,s=0,i=0)=>{const r=e[s];if(r===void 0)throw n();return Rs(t)?r.connect(t,0,i):r.connect(t,0)},Hc=n=>(e,t)=>{const s=n(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return s.buffer=i,s.loop=!0,s.connect(t),s.start(),()=>{s.stop(),s.disconnect(t)}},Zc={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Jc=(n,e,t,s,i,r,c)=>class extends n{constructor(l,u){const h=i(l),d={...Zc,...u},f=s(h,d),p=r(h),m=p?t():null;super(l,!1,f,m),this._constantSourceNodeRenderer=m,this._nativeConstantSourceNode=f,this._offset=e(this,p,f.offset,Ae,Ie),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(l){const u=typeof l=="function"?c(this,l):null;this._nativeConstantSourceNode.onended=u;const h=this._nativeConstantSourceNode.onended;this._onended=h!==null&&h===u?l:h}start(l=0){if(this._nativeConstantSourceNode.start(l),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=l),this.context.state!=="closed"){Vt(this);const u=()=>{this._nativeConstantSourceNode.removeEventListener("ended",u),nt(this)&&os(this)};this._nativeConstantSourceNode.addEventListener("ended",u)}}stop(l=0){this._nativeConstantSourceNode.stop(l),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=l)}},Qc=(n,e,t,s,i)=>()=>{const r=new WeakMap;let c=null,o=null;const l=async(u,h)=>{let d=t(u);const f=Ce(d,h);if(!f){const p={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,offset:d.offset.value};d=e(h,p),c!==null&&d.start(c),o!==null&&d.stop(o)}return r.set(h,d),f?await n(h,u.offset,d.offset):await s(h,u.offset,d.offset),await i(u,h,d),d};return{set start(u){c=u},set stop(u){o=u},render(u,h){const d=r.get(h);return d!==void 0?Promise.resolve(d):l(u,h)}}},Kc=n=>e=>(n[0]=e,n[0]),el={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},tl=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=s(o),h={...el,...l},d=t(u,h),p=i(u)?e():null;super(o,!1,d,p),this._isBufferNullified=!1,this._nativeConvolverNode=d,h.buffer!==null&&r(this,h.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(o){if(this._nativeConvolverNode.buffer=o,o===null&&this._nativeConvolverNode.buffer!==null){const l=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=l.createBuffer(1,1,l.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(o){this._nativeConvolverNode.normalize=o}},sl=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,c)=>{let o=e(r);if(!Ce(o,c)){const u={buffer:o.buffer,channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation,disableNormalization:!o.normalize};o=n(c,u)}return s.set(c,o),zt(o)?await t(r,c,o.inputs[0]):await t(r,c,o),o};return{render(r,c){const o=s.get(c);return o!==void 0?Promise.resolve(o):i(r,c)}}},nl=(n,e)=>(t,s,i)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,s,i)}catch(r){throw r.name==="SyntaxError"?n():r}},il=()=>new DOMException("","DataCloneError"),Ii=n=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(s=>{const i=()=>{t.onmessage=null,e.close(),t.close(),s()};t.onmessage=()=>i();try{e.postMessage(n,[n])}catch{}finally{i()}})},rl=(n,e,t,s,i,r,c,o,l,u,h)=>(d,f)=>{const p=c(d)?d:r(d);if(i.has(f)){const m=t();return Promise.reject(m)}try{i.add(f)}catch{}return e(l,()=>l(p))?p.decodeAudioData(f).then(m=>(Ii(f).catch(()=>{}),e(o,()=>o(m))||h(m),n.add(m),m)):new Promise((m,g)=>{const _=async()=>{try{await Ii(f)}catch{}},y=w=>{g(w),_()};try{p.decodeAudioData(f,w=>{typeof w.copyFromChannel!="function"&&(u(w),On(w)),n.add(w),_().then(()=>m(w))},w=>{y(w===null?s():w)})}catch(w){y(w)}})},al=(n,e,t,s,i,r,c,o)=>(l,u)=>{const h=e.get(l);if(h===void 0)throw new Error("Missing the expected cycle count.");const d=r(l.context),f=o(d);if(h===u){if(e.delete(l),!f&&c(l)){const p=s(l),{outputs:m}=t(l);for(const g of m)if(ls(g)){const _=s(g[0]);n(p,_,g[1],g[2])}else{const _=i(g[0]);p.connect(_,g[1])}}}else e.set(l,h-u)},ol={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},cl=(n,e,t,s,i,r,c)=>class extends n{constructor(l,u){const h=i(l),d={...ol,...u},f=s(h,d),p=r(h),m=p?t(d.maxDelayTime):null;super(l,!1,f,m),this._delayTime=e(this,p,f.delayTime),c(this,d.maxDelayTime)}get delayTime(){return this._delayTime}},ll=(n,e,t,s,i)=>r=>{const c=new WeakMap,o=async(l,u)=>{let h=t(l);const d=Ce(h,u);if(!d){const f={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,delayTime:h.delayTime.value,maxDelayTime:r};h=e(u,f)}return c.set(u,h),d?await n(u,l.delayTime,h.delayTime):await s(u,l.delayTime,h.delayTime),await i(l,u,h),h};return{render(l,u){const h=c.get(u);return h!==void 0?Promise.resolve(h):o(l,u)}}},ul=n=>(e,t,s,i)=>n(e[i],r=>r[0]===t&&r[1]===s),hl=n=>(e,t)=>{n(e).delete(t)},dl=n=>"delayTime"in n,pl=(n,e,t)=>function s(i,r){const c=Es(r)?r:t(n,r);if(dl(c))return[];if(i[0]===c)return[i];if(i.includes(c))return[];const{outputs:o}=e(c);return Array.from(o).map(l=>s([...i,c],l[0])).reduce((l,u)=>l.concat(u),[])},xs=(n,e,t)=>{const s=e[t];if(s===void 0)throw n();return s},ml=n=>(e,t=void 0,s=void 0,i=0)=>t===void 0?e.forEach(r=>r.disconnect()):typeof t=="number"?xs(n,e,t).disconnect():Rs(t)?s===void 0?e.forEach(r=>r.disconnect(t)):i===void 0?xs(n,e,s).disconnect(t,0):xs(n,e,s).disconnect(t,0,i):s===void 0?e.forEach(r=>r.disconnect(t)):xs(n,e,s).disconnect(t,0),fl={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},gl=(n,e,t,s,i,r,c,o)=>class extends n{constructor(u,h){const d=r(u),f={...fl,...h},p=s(d,f),m=c(d),g=m?t():null;super(u,!1,p,g),this._attack=e(this,m,p.attack),this._knee=e(this,m,p.knee),this._nativeDynamicsCompressorNode=p,this._ratio=e(this,m,p.ratio),this._release=e(this,m,p.release),this._threshold=e(this,m,p.threshold),o(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(u){const h=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=u,u>2)throw this._nativeDynamicsCompressorNode.channelCount=h,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(u){const h=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=u,u==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=h,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},_l=(n,e,t,s,i)=>()=>{const r=new WeakMap,c=async(o,l)=>{let u=t(o);const h=Ce(u,l);if(!h){const d={attack:u.attack.value,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,knee:u.knee.value,ratio:u.ratio.value,release:u.release.value,threshold:u.threshold.value};u=e(l,d)}return r.set(l,u),h?(await n(l,o.attack,u.attack),await n(l,o.knee,u.knee),await n(l,o.ratio,u.ratio),await n(l,o.release,u.release),await n(l,o.threshold,u.threshold)):(await s(l,o.attack,u.attack),await s(l,o.knee,u.knee),await s(l,o.ratio,u.ratio),await s(l,o.release,u.release),await s(l,o.threshold,u.threshold)),await i(o,l,u),u};return{render(o,l){const u=r.get(l);return u!==void 0?Promise.resolve(u):c(o,l)}}},vl=()=>new DOMException("","EncodingError"),yl=n=>e=>new Promise((t,s)=>{if(n===null){s(new SyntaxError);return}const i=n.document.head;if(i===null)s(new SyntaxError);else{const r=n.document.createElement("script"),c=new Blob([e],{type:"application/javascript"}),o=URL.createObjectURL(c),l=n.onerror,u=()=>{n.onerror=l,URL.revokeObjectURL(o)};n.onerror=(h,d,f,p,m)=>{if(d===o||d===n.location.href&&f===1&&p===1)return u(),s(m),!1;if(l!==null)return l(h,d,f,p,m)},r.onerror=()=>{u(),s(new SyntaxError)},r.onload=()=>{u(),t()},r.src=o,r.type="module",i.appendChild(r)}}),bl=n=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,s,i){if(s!==null){let r=this._listeners.get(s);r===void 0&&(r=n(this,s),typeof s=="function"&&this._listeners.set(s,r)),this._nativeEventTarget.addEventListener(t,r,i)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,s,i){const r=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(t,r===void 0?null:r,i)}},xl=n=>(e,t,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},wl=n=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw n()},Tl={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Nl=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=i(o),h={...Tl,...l},d=s(u,h),f=r(u),p=f?t():null;super(o,!1,d,p),this._gain=e(this,f,d.gain,Ae,Ie)}get gain(){return this._gain}},Sl=(n,e,t,s,i)=>()=>{const r=new WeakMap,c=async(o,l)=>{let u=t(o);const h=Ce(u,l);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,gain:u.gain.value};u=e(l,d)}return r.set(l,u),h?await n(l,o.gain,u.gain):await s(l,o.gain,u.gain),await i(o,l,u),u};return{render(o,l){const u=r.get(l);return u!==void 0?Promise.resolve(u):c(o,l)}}},kl=(n,e)=>t=>e(n,t),Cl=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},Al=n=>e=>{var t;return(t=n.get(e))!==null&&t!==void 0?t:0},jl=n=>e=>{const t=n(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},Ml=n=>e=>n.get(e),we=()=>new DOMException("","InvalidStateError"),El=n=>e=>{const t=n.get(e);if(t===void 0)throw we();return t},Il=(n,e)=>t=>{let s=n.get(t);if(s!==void 0)return s;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new e(1,1,44100),n.set(t,s),s},Ol=n=>e=>{const t=n.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},zs=()=>new DOMException("","InvalidAccessError"),Rl=n=>{n.getFrequencyResponse=(e=>(t,s,i)=>{if(t.length!==s.length||s.length!==i.length)throw zs();return e.call(n,t,s,i)})(n.getFrequencyResponse)},Dl={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Pl=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=s(o),h=i(u),d={...Dl,...l},f=e(u,h?null:o.baseLatency,d),p=h?t(d.feedback,d.feedforward):null;super(o,!1,f,p),Rl(f),this._nativeIIRFilterNode=f,r(this,1)}getFrequencyResponse(o,l,u){return this._nativeIIRFilterNode.getFrequencyResponse(o,l,u)}},hr=(n,e,t,s,i,r,c,o,l,u,h)=>{const d=u.length;let f=o;for(let p=0;p<d;p+=1){let m=t[0]*u[p];for(let g=1;g<i;g+=1){const _=f-g&l-1;m+=t[g]*r[_],m-=n[g]*c[_]}for(let g=i;g<s;g+=1)m+=t[g]*r[f-g&l-1];for(let g=i;g<e;g+=1)m-=n[g]*c[f-g&l-1];r[f]=u[p],c[f]=m,f=f+1&l-1,h[p]=m}return f},Fl=(n,e,t,s)=>{const i=t instanceof Float64Array?t:new Float64Array(t),r=s instanceof Float64Array?s:new Float64Array(s),c=i.length,o=r.length,l=Math.min(c,o);if(i[0]!==1){for(let m=0;m<c;m+=1)r[m]/=i[0];for(let m=1;m<o;m+=1)i[m]/=i[0]}const u=32,h=new Float32Array(u),d=new Float32Array(u),f=e.createBuffer(n.numberOfChannels,n.length,n.sampleRate),p=n.numberOfChannels;for(let m=0;m<p;m+=1){const g=n.getChannelData(m),_=f.getChannelData(m);h.fill(0),d.fill(0),hr(i,c,r,o,l,h,d,0,u,g,_)}return f},Ll=(n,e,t,s,i)=>(r,c)=>{const o=new WeakMap;let l=null;const u=async(h,d)=>{let f=null,p=e(h);const m=Ce(p,d);if(d.createIIRFilter===void 0?f=n(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):m||(p=d.createIIRFilter(c,r)),o.set(d,f===null?p:f),f!==null){if(l===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const _=new t(h.context.destination.channelCount,h.context.length,d.sampleRate);l=(async()=>{await s(h,_,_.destination);const y=await i(_);return Fl(y,d,r,c)})()}const g=await l;return f.buffer=g,f.start(0),f}return await s(h,d,p),p};return{render(h,d){const f=o.get(d);return f!==void 0?Promise.resolve(f):u(h,d)}}},Vl=(n,e,t,s,i,r)=>c=>(o,l)=>{const u=n.get(o);if(u===void 0){if(!c&&r(o)){const h=s(o),{outputs:d}=t(o);for(const f of d)if(ls(f)){const p=s(f[0]);e(h,p,f[1],f[2])}else{const p=i(f[0]);h.disconnect(p,f[1])}}n.set(o,l)}else n.set(o,u+l)},ql=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Wl=(n,e)=>t=>n.has(t)||e(t),Bl=(n,e)=>t=>n.has(t)||e(t),Ul=(n,e)=>t=>{const s=n.get(t);return e(s)||e(t)},Gl=n=>e=>n!==null&&e instanceof n,$l=n=>e=>n!==null&&typeof n.AudioNode=="function"&&e instanceof n.AudioNode,zl=n=>e=>n!==null&&typeof n.AudioParam=="function"&&e instanceof n.AudioParam,Xl=(n,e)=>t=>n(t)||e(t),Yl=n=>e=>n!==null&&e instanceof n,Hl=n=>n!==null&&n.isSecureContext,Zl=(n,e,t,s)=>class extends n{constructor(r,c){const o=t(r),l=e(o,c);if(s(o))throw TypeError();super(r,!0,l,null),this._nativeMediaElementAudioSourceNode=l}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},Jl={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Ql=(n,e,t,s)=>class extends n{constructor(r,c){const o=t(r);if(s(o))throw new TypeError;const l={...Jl,...c},u=e(o,l);super(r,!1,u,null),this._nativeMediaStreamAudioDestinationNode=u}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},Kl=(n,e,t,s)=>class extends n{constructor(r,c){const o=t(r),l=e(o,c);if(s(o))throw new TypeError;super(r,!0,l,null),this._nativeMediaStreamAudioSourceNode=l}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},eu=(n,e,t)=>class extends n{constructor(i,r){const c=t(i),o=e(c,r);super(i,!0,o,null)}},tu=(n,e,t,s,i,r)=>class extends t{constructor(o,l){super(o),this._nativeContext=o,Gs.set(this,o),s(o)&&i.set(o,new Set),this._destination=new n(this,l),this._listener=e(this,o),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(o){const l=typeof o=="function"?r(this,o):null;this._nativeContext.onstatechange=l;const u=this._nativeContext.onstatechange;this._onstatechange=u!==null&&u===l?o:u}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},ss=n=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=n.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},su=(n,e)=>(t,s,i)=>{const r=new Set;return t.connect=(c=>(o,l=0,u=0)=>{const h=r.size===0;if(e(o))return c.call(t,o,l,u),n(r,[o,l,u],d=>d[0]===o&&d[1]===l&&d[2]===u,!0),h&&s(),o;c.call(t,o,l),n(r,[o,l],d=>d[0]===o&&d[1]===l,!0),h&&s()})(t.connect),t.disconnect=(c=>(o,l,u)=>{const h=r.size>0;if(o===void 0)c.apply(t),r.clear();else if(typeof o=="number"){c.call(t,o);for(const f of r)f[1]===o&&r.delete(f)}else{e(o)?c.call(t,o,l,u):c.call(t,o,l);for(const f of r)f[0]===o&&(l===void 0||f[1]===l)&&(u===void 0||f[2]===u)&&r.delete(f)}const d=r.size===0;h&&d&&i()})(t.disconnect),t},ae=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t]&&(n[t]=s)},be=(n,e)=>{ae(n,e,"channelCount"),ae(n,e,"channelCountMode"),ae(n,e,"channelInterpretation")},Oi=n=>typeof n.getFloatTimeDomainData=="function",nu=n=>{n.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);n.getByteTimeDomainData(t);const s=Math.max(t.length,n.fftSize);for(let i=0;i<s;i+=1)e[i]=(t[i]-128)*.0078125;return e}},iu=(n,e)=>(t,s)=>{const i=t.createAnalyser();if(be(i,s),!(s.maxDecibels>s.minDecibels))throw e();return ae(i,s,"fftSize"),ae(i,s,"maxDecibels"),ae(i,s,"minDecibels"),ae(i,s,"smoothingTimeConstant"),n(Oi,()=>Oi(i))||nu(i),i},ru=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,he=(n,e,t)=>{const s=e[t];s!==void 0&&s!==n[t].value&&(n[t].value=s)},au=n=>{n.start=(e=>{let t=!1;return(s=0,i=0,r)=>{if(t)throw we();e.call(n,s,i,r),t=!0}})(n.start)},Pn=n=>{n.start=(e=>(t=0,s=0,i)=>{if(typeof i=="number"&&i<0||s<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(n,t,s,i)})(n.start)},Fn=n=>{n.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(n,t)})(n.stop)},ou=(n,e,t,s,i,r,c,o,l,u,h)=>(d,f)=>{const p=d.createBufferSource();return be(p,f),he(p,f,"playbackRate"),ae(p,f,"buffer"),ae(p,f,"loop"),ae(p,f,"loopEnd"),ae(p,f,"loopStart"),e(t,()=>t(d))||au(p),e(s,()=>s(d))||l(p),e(i,()=>i(d))||u(p,d),e(r,()=>r(d))||Pn(p),e(c,()=>c(d))||h(p,d),e(o,()=>o(d))||Fn(p),n(d,p),p},cu=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,lu=(n,e)=>(t,s,i)=>{const r=t.destination;if(r.channelCount!==s)try{r.channelCount=s}catch{}i&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:s});const c=n(t,{channelCount:s,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return e(c,"channelCount",o=>()=>o.call(c),o=>l=>{o.call(c,l);try{r.channelCount=l}catch(u){if(l>r.maxChannelCount)throw u}}),e(c,"channelCountMode",o=>()=>o.call(c),o=>l=>{o.call(c,l),r.channelCountMode=l}),e(c,"channelInterpretation",o=>()=>o.call(c),o=>l=>{o.call(c,l),r.channelInterpretation=l}),Object.defineProperty(c,"maxChannelCount",{get:()=>r.maxChannelCount}),c.connect(r),c},uu=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,hu=n=>{const{port1:e}=new MessageChannel;try{e.postMessage(n)}finally{e.close()}},du=(n,e,t,s,i)=>(r,c,o,l,u,h)=>{if(o!==null)try{const d=new o(r,l,h),f=new Map;let p=null;if(Object.defineProperties(d,{channelCount:{get:()=>h.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>p,set:m=>{typeof p=="function"&&d.removeEventListener("processorerror",p),p=typeof m=="function"?m:null,typeof p=="function"&&d.addEventListener("processorerror",p)}}}),d.addEventListener=(m=>(...g)=>{if(g[0]==="processorerror"){const _=typeof g[1]=="function"?g[1]:typeof g[1]=="object"&&g[1]!==null&&typeof g[1].handleEvent=="function"?g[1].handleEvent:null;if(_!==null){const y=f.get(g[1]);y!==void 0?g[1]=y:(g[1]=w=>{w.type==="error"?(Object.defineProperties(w,{type:{value:"processorerror"}}),_(w)):_(new ErrorEvent(g[0],{...w}))},f.set(_,g[1]))}}return m.call(d,"error",g[1],g[2]),m.call(d,...g)})(d.addEventListener),d.removeEventListener=(m=>(...g)=>{if(g[0]==="processorerror"){const _=f.get(g[1]);_!==void 0&&(f.delete(g[1]),g[1]=_)}return m.call(d,"error",g[1],g[2]),m.call(d,g[0],g[1],g[2])})(d.removeEventListener),h.numberOfOutputs!==0){const m=t(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return d.connect(m).connect(r.destination),i(d,()=>m.disconnect(),()=>m.connect(r.destination))}return d}catch(d){throw d.code===11?s():d}if(u===void 0)throw s();return hu(h),e(r,c,u,h)},dr=(n,e)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*e))))),pu=n=>new Promise((e,t)=>{const{port1:s,port2:i}=new MessageChannel;s.onmessage=({data:r})=>{s.close(),i.close(),e(r)},s.onmessageerror=({data:r})=>{s.close(),i.close(),t(r)},i.postMessage(n)}),mu=async(n,e)=>{const t=await pu(e);return new n(t)},fu=(n,e,t,s)=>{let i=Tn.get(n);i===void 0&&(i=new WeakMap,Tn.set(n,i));const r=mu(t,s);return i.set(e,r),r},gu=(n,e,t,s,i,r,c,o,l,u,h,d,f)=>(p,m,g,_)=>{if(_.numberOfInputs===0&&_.numberOfOutputs===0)throw l();const y=Array.isArray(_.outputChannelCount)?_.outputChannelCount:Array.from(_.outputChannelCount);if(y.some(W=>W<1))throw l();if(y.length!==_.numberOfOutputs)throw e();if(_.channelCountMode!=="explicit")throw l();const w=_.channelCount*_.numberOfInputs,N=y.reduce((W,G)=>W+G,0),A=g.parameterDescriptors===void 0?0:g.parameterDescriptors.length;if(w+A>6||N>6)throw l();const b=new MessageChannel,S=[],C=[];for(let W=0;W<_.numberOfInputs;W+=1)S.push(c(p,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1})),C.push(i(p,{channelCount:_.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:_.channelCount}));const v=[];if(g.parameterDescriptors!==void 0)for(const{defaultValue:W,maxValue:G,minValue:ve,name:ce}of g.parameterDescriptors){const Q=r(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:_.parameterData[ce]!==void 0?_.parameterData[ce]:W===void 0?0:W});Object.defineProperties(Q.offset,{defaultValue:{get:()=>W===void 0?0:W},maxValue:{get:()=>G===void 0?Ae:G},minValue:{get:()=>ve===void 0?Ie:ve}}),v.push(Q)}const k=s(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,w+A)}),x=dr(m,p.sampleRate),j=o(p,x,w+A,Math.max(1,N)),M=i(p,{channelCount:Math.max(1,N),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,N)}),O=[];for(let W=0;W<_.numberOfOutputs;W+=1)O.push(s(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:y[W]}));for(let W=0;W<_.numberOfInputs;W+=1){S[W].connect(C[W]);for(let G=0;G<_.channelCount;G+=1)C[W].connect(k,G,W*_.channelCount+G)}const D=new lr(g.parameterDescriptors===void 0?[]:g.parameterDescriptors.map(({name:W},G)=>{const ve=v[G];return ve.connect(k,0,w+G),ve.start(0),[W,ve.offset]}));k.connect(j);let q=_.channelInterpretation,L=null;const B=_.numberOfOutputs===0?[j]:O,U={get bufferSize(){return x},get channelCount(){return _.channelCount},set channelCount(W){throw t()},get channelCountMode(){return _.channelCountMode},set channelCountMode(W){throw t()},get channelInterpretation(){return q},set channelInterpretation(W){for(const G of S)G.channelInterpretation=W;q=W},get context(){return j.context},get inputs(){return S},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},get onprocessorerror(){return L},set onprocessorerror(W){typeof L=="function"&&U.removeEventListener("processorerror",L),L=typeof W=="function"?W:null,typeof L=="function"&&U.addEventListener("processorerror",L)},get parameters(){return D},get port(){return b.port2},addEventListener(...W){return j.addEventListener(W[0],W[1],W[2])},connect:n.bind(null,B),disconnect:u.bind(null,B),dispatchEvent(...W){return j.dispatchEvent(W[0])},removeEventListener(...W){return j.removeEventListener(W[0],W[1],W[2])}},E=new Map;b.port1.addEventListener=(W=>(...G)=>{if(G[0]==="message"){const ve=typeof G[1]=="function"?G[1]:typeof G[1]=="object"&&G[1]!==null&&typeof G[1].handleEvent=="function"?G[1].handleEvent:null;if(ve!==null){const ce=E.get(G[1]);ce!==void 0?G[1]=ce:(G[1]=Q=>{h(p.currentTime,p.sampleRate,()=>ve(Q))},E.set(ve,G[1]))}}return W.call(b.port1,G[0],G[1],G[2])})(b.port1.addEventListener),b.port1.removeEventListener=(W=>(...G)=>{if(G[0]==="message"){const ve=E.get(G[1]);ve!==void 0&&(E.delete(G[1]),G[1]=ve)}return W.call(b.port1,G[0],G[1],G[2])})(b.port1.removeEventListener);let R=null;Object.defineProperty(b.port1,"onmessage",{get:()=>R,set:W=>{typeof R=="function"&&b.port1.removeEventListener("message",R),R=typeof W=="function"?W:null,typeof R=="function"&&(b.port1.addEventListener("message",R),b.port1.start())}}),g.prototype.port=b.port1;let V=null;fu(p,U,g,_).then(W=>V=W);const ie=Ps(_.numberOfInputs,_.channelCount),xe=Ps(_.numberOfOutputs,y),X=g.parameterDescriptors===void 0?[]:g.parameterDescriptors.reduce((W,{name:G})=>({...W,[G]:new Float32Array(128)}),{});let F=!0;const P=()=>{_.numberOfOutputs>0&&j.disconnect(M);for(let W=0,G=0;W<_.numberOfOutputs;W+=1){const ve=O[W];for(let ce=0;ce<y[W];ce+=1)M.disconnect(ve,G+ce,ce);G+=y[W]}},I=new Map;j.onaudioprocess=({inputBuffer:W,outputBuffer:G})=>{if(V!==null){const ve=d(U);for(let ce=0;ce<x;ce+=128){for(let Q=0;Q<_.numberOfInputs;Q+=1)for(let ue=0;ue<_.channelCount;ue+=1)Ds(W,ie[Q],ue,ue,ce);g.parameterDescriptors!==void 0&&g.parameterDescriptors.forEach(({name:Q},ue)=>{Ds(W,X,Q,w+ue,ce)});for(let Q=0;Q<_.numberOfInputs;Q+=1)for(let ue=0;ue<y[Q];ue+=1)xe[Q][ue].byteLength===0&&(xe[Q][ue]=new Float32Array(128));try{const Q=ie.map((qe,ct)=>{if(ve[ct].size>0)return I.set(ct,x/128),qe;const dn=I.get(ct);return dn===void 0?[]:(qe.every(ua=>ua.every(ha=>ha===0))&&(dn===1?I.delete(ct):I.set(ct,dn-1)),qe)});F=h(p.currentTime+ce/p.sampleRate,p.sampleRate,()=>V.process(Q,xe,X));for(let qe=0,ct=0;qe<_.numberOfOutputs;qe+=1){for(let es=0;es<y[qe];es+=1)ur(G,xe[qe],es,ct+es,ce);ct+=y[qe]}}catch(Q){F=!1,U.dispatchEvent(new ErrorEvent("processorerror",{colno:Q.colno,filename:Q.filename,lineno:Q.lineno,message:Q.message}))}if(!F){for(let Q=0;Q<_.numberOfInputs;Q+=1){S[Q].disconnect(C[Q]);for(let ue=0;ue<_.channelCount;ue+=1)C[ce].disconnect(k,ue,Q*_.channelCount+ue)}if(g.parameterDescriptors!==void 0){const Q=g.parameterDescriptors.length;for(let ue=0;ue<Q;ue+=1){const qe=v[ue];qe.disconnect(k,0,w+ue),qe.stop()}}k.disconnect(j),j.onaudioprocess=null,J?P():oe();break}}}};let J=!1;const me=c(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Ee=()=>j.connect(me).connect(p.destination),oe=()=>{j.disconnect(me),me.disconnect()},Kt=()=>{if(F){oe(),_.numberOfOutputs>0&&j.connect(M);for(let W=0,G=0;W<_.numberOfOutputs;W+=1){const ve=O[W];for(let ce=0;ce<y[W];ce+=1)M.connect(ve,G+ce,ce);G+=y[W]}}J=!0},hn=()=>{F&&(Ee(),P()),J=!1};return Ee(),f(U,Kt,hn)},pr=(n,e)=>{const t=n.createBiquadFilter();return be(t,e),he(t,e,"Q"),he(t,e,"detune"),he(t,e,"frequency"),he(t,e,"gain"),ae(t,e,"type"),t},_u=(n,e)=>(t,s)=>{const i=t.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&e(t,i),be(i,s),i},vu=n=>{const e=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw we()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw we()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw we()}})},us=(n,e)=>{const t=n.createChannelSplitter(e.numberOfOutputs);return be(t,e),vu(t),t},yu=(n,e,t,s,i)=>(r,c)=>{if(r.createConstantSource===void 0)return t(r,c);const o=r.createConstantSource();return be(o,c),he(o,c,"offset"),e(s,()=>s(r))||Pn(o),e(i,()=>i(r))||Fn(o),n(r,o),o},Xt=(n,e)=>(n.connect=e.connect.bind(e),n.disconnect=e.disconnect.bind(e),n),bu=(n,e,t,s)=>(i,{offset:r,...c})=>{const o=i.createBuffer(1,2,44100),l=e(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),u=t(i,{...c,gain:r}),h=o.getChannelData(0);h[0]=1,h[1]=1,l.buffer=o,l.loop=!0;const d={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(m){u.channelCount=m},get channelCountMode(){return u.channelCountMode},set channelCountMode(m){u.channelCountMode=m},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(m){u.channelInterpretation=m},get context(){return u.context},get inputs(){return[]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get offset(){return u.gain},get onended(){return l.onended},set onended(m){l.onended=m},addEventListener(...m){return l.addEventListener(m[0],m[1],m[2])},dispatchEvent(...m){return l.dispatchEvent(m[0])},removeEventListener(...m){return l.removeEventListener(m[0],m[1],m[2])},start(m=0){l.start.call(l,m)},stop(m=0){l.stop.call(l,m)}},f=()=>l.connect(u),p=()=>l.disconnect(u);return n(i,l),s(Xt(d,u),f,p)},xu=(n,e)=>(t,s)=>{const i=t.createConvolver();if(be(i,s),s.disableNormalization===i.normalize&&(i.normalize=!s.disableNormalization),ae(i,s,"buffer"),s.channelCount>2||(e(i,"channelCount",r=>()=>r.call(i),r=>c=>{if(c>2)throw n();return r.call(i,c)}),s.channelCountMode==="max"))throw n();return e(i,"channelCountMode",r=>()=>r.call(i),r=>c=>{if(c==="max")throw n();return r.call(i,c)}),i},mr=(n,e)=>{const t=n.createDelay(e.maxDelayTime);return be(t,e),he(t,e,"delayTime"),t},wu=n=>(e,t)=>{const s=e.createDynamicsCompressor();if(be(s,t),t.channelCount>2||t.channelCountMode==="max")throw n();return he(s,t,"attack"),he(s,t,"knee"),he(s,t,"ratio"),he(s,t,"release"),he(s,t,"threshold"),s},Re=(n,e)=>{const t=n.createGain();return be(t,e),he(t,e,"gain"),t},Tu=n=>(e,t,s)=>{if(e.createIIRFilter===void 0)return n(e,t,s);const i=e.createIIRFilter(s.feedforward,s.feedback);return be(i,s),i};function Nu(n,e){const t=e[0]*e[0]+e[1]*e[1];return[(n[0]*e[0]+n[1]*e[1])/t,(n[1]*e[0]-n[0]*e[1])/t]}function Su(n,e){return[n[0]*e[0]-n[1]*e[1],n[0]*e[1]+n[1]*e[0]]}function Ri(n,e){let t=[0,0];for(let s=n.length-1;s>=0;s-=1)t=Su(t,e),t[0]+=n[s];return t}const ku=(n,e,t,s)=>(i,r,{channelCount:c,channelCountMode:o,channelInterpretation:l,feedback:u,feedforward:h})=>{const d=dr(r,i.sampleRate),f=u instanceof Float64Array?u:new Float64Array(u),p=h instanceof Float64Array?h:new Float64Array(h),m=f.length,g=p.length,_=Math.min(m,g);if(m===0||m>20)throw s();if(f[0]===0)throw e();if(g===0||g>20)throw s();if(p[0]===0)throw e();if(f[0]!==1){for(let v=0;v<g;v+=1)p[v]/=f[0];for(let v=1;v<m;v+=1)f[v]/=f[0]}const y=t(i,d,c,c);y.channelCount=c,y.channelCountMode=o,y.channelInterpretation=l;const w=32,N=[],A=[],b=[];for(let v=0;v<c;v+=1){N.push(0);const k=new Float32Array(w),x=new Float32Array(w);k.fill(0),x.fill(0),A.push(k),b.push(x)}y.onaudioprocess=v=>{const k=v.inputBuffer,x=v.outputBuffer,j=k.numberOfChannels;for(let M=0;M<j;M+=1){const O=k.getChannelData(M),D=x.getChannelData(M);N[M]=hr(f,m,p,g,_,A[M],b[M],N[M],w,O,D)}};const S=i.sampleRate/2;return Xt({get bufferSize(){return d},get channelCount(){return y.channelCount},set channelCount(v){y.channelCount=v},get channelCountMode(){return y.channelCountMode},set channelCountMode(v){y.channelCountMode=v},get channelInterpretation(){return y.channelInterpretation},set channelInterpretation(v){y.channelInterpretation=v},get context(){return y.context},get inputs(){return[y]},get numberOfInputs(){return y.numberOfInputs},get numberOfOutputs(){return y.numberOfOutputs},addEventListener(...v){return y.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return y.dispatchEvent(v[0])},getFrequencyResponse(v,k,x){if(v.length!==k.length||k.length!==x.length)throw n();const j=v.length;for(let M=0;M<j;M+=1){const O=-Math.PI*(v[M]/S),D=[Math.cos(O),Math.sin(O)],q=Ri(p,D),L=Ri(f,D),B=Nu(q,L);k[M]=Math.sqrt(B[0]*B[0]+B[1]*B[1]),x[M]=Math.atan2(B[1],B[0])}},removeEventListener(...v){return y.removeEventListener(v[0],v[1],v[2])}},y)},Cu=(n,e)=>n.createMediaElementSource(e.mediaElement),Au=(n,e)=>{const t=n.createMediaStreamDestination();return be(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},ju=(n,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((r,c)=>r.id<c.id?-1:r.id>c.id?1:0);const s=t.slice(0,1),i=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(i,"mediaStream",{value:e}),i},Mu=(n,e)=>(t,{mediaStreamTrack:s})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(s);const i=new MediaStream([s]),r=t.createMediaStreamSource(i);if(s.kind!=="audio")throw n();if(e(t))throw new TypeError;return r},Eu=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,Iu=(n,e,t,s,i,r)=>(c,o)=>{const l=c.createOscillator();return be(l,o),he(l,o,"detune"),he(l,o,"frequency"),o.periodicWave!==void 0?l.setPeriodicWave(o.periodicWave):ae(l,o,"type"),e(t,()=>t(c))||Pn(l),e(s,()=>s(c))||r(l,c),e(i,()=>i(c))||Fn(l),n(c,l),l},Ou=n=>(e,t)=>{const s=e.createPanner();return s.orientationX===void 0?n(e,t):(be(s,t),he(s,t,"orientationX"),he(s,t,"orientationY"),he(s,t,"orientationZ"),he(s,t,"positionX"),he(s,t,"positionY"),he(s,t,"positionZ"),ae(s,t,"coneInnerAngle"),ae(s,t,"coneOuterAngle"),ae(s,t,"coneOuterGain"),ae(s,t,"distanceModel"),ae(s,t,"maxDistance"),ae(s,t,"panningModel"),ae(s,t,"refDistance"),ae(s,t,"rolloffFactor"),s)},Ru=(n,e,t,s,i,r,c,o,l,u)=>(h,{coneInnerAngle:d,coneOuterAngle:f,coneOuterGain:p,distanceModel:m,maxDistance:g,orientationX:_,orientationY:y,orientationZ:w,panningModel:N,positionX:A,positionY:b,positionZ:S,refDistance:C,rolloffFactor:v,...k})=>{const x=h.createPanner();if(k.channelCount>2||k.channelCountMode==="max")throw c();be(x,k);const j={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M=t(h,{...j,channelInterpretation:"speakers",numberOfInputs:6}),O=s(h,{...k,gain:1}),D=s(h,{...j,gain:1}),q=s(h,{...j,gain:0}),L=s(h,{...j,gain:0}),B=s(h,{...j,gain:0}),U=s(h,{...j,gain:0}),E=s(h,{...j,gain:0}),R=i(h,256,6,1),V=r(h,{...j,curve:new Float32Array([1,1]),oversample:"none"});let Y=[_,y,w],ie=[A,b,S];const xe=new Float32Array(1);R.onaudioprocess=({inputBuffer:I})=>{const J=[l(I,xe,0),l(I,xe,1),l(I,xe,2)];J.some((Ee,oe)=>Ee!==Y[oe])&&(x.setOrientation(...J),Y=J);const me=[l(I,xe,3),l(I,xe,4),l(I,xe,5)];me.some((Ee,oe)=>Ee!==ie[oe])&&(x.setPosition(...me),ie=me)},Object.defineProperty(q.gain,"defaultValue",{get:()=>0}),Object.defineProperty(L.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(U.gain,"defaultValue",{get:()=>0}),Object.defineProperty(E.gain,"defaultValue",{get:()=>0});const X={get bufferSize(){},get channelCount(){return x.channelCount},set channelCount(I){if(I>2)throw c();O.channelCount=I,x.channelCount=I},get channelCountMode(){return x.channelCountMode},set channelCountMode(I){if(I==="max")throw c();O.channelCountMode=I,x.channelCountMode=I},get channelInterpretation(){return x.channelInterpretation},set channelInterpretation(I){O.channelInterpretation=I,x.channelInterpretation=I},get coneInnerAngle(){return x.coneInnerAngle},set coneInnerAngle(I){x.coneInnerAngle=I},get coneOuterAngle(){return x.coneOuterAngle},set coneOuterAngle(I){x.coneOuterAngle=I},get coneOuterGain(){return x.coneOuterGain},set coneOuterGain(I){if(I<0||I>1)throw e();x.coneOuterGain=I},get context(){return x.context},get distanceModel(){return x.distanceModel},set distanceModel(I){x.distanceModel=I},get inputs(){return[O]},get maxDistance(){return x.maxDistance},set maxDistance(I){if(I<0)throw new RangeError;x.maxDistance=I},get numberOfInputs(){return x.numberOfInputs},get numberOfOutputs(){return x.numberOfOutputs},get orientationX(){return D.gain},get orientationY(){return q.gain},get orientationZ(){return L.gain},get panningModel(){return x.panningModel},set panningModel(I){x.panningModel=I},get positionX(){return B.gain},get positionY(){return U.gain},get positionZ(){return E.gain},get refDistance(){return x.refDistance},set refDistance(I){if(I<0)throw new RangeError;x.refDistance=I},get rolloffFactor(){return x.rolloffFactor},set rolloffFactor(I){if(I<0)throw new RangeError;x.rolloffFactor=I},addEventListener(...I){return O.addEventListener(I[0],I[1],I[2])},dispatchEvent(...I){return O.dispatchEvent(I[0])},removeEventListener(...I){return O.removeEventListener(I[0],I[1],I[2])}};d!==X.coneInnerAngle&&(X.coneInnerAngle=d),f!==X.coneOuterAngle&&(X.coneOuterAngle=f),p!==X.coneOuterGain&&(X.coneOuterGain=p),m!==X.distanceModel&&(X.distanceModel=m),g!==X.maxDistance&&(X.maxDistance=g),_!==X.orientationX.value&&(X.orientationX.value=_),y!==X.orientationY.value&&(X.orientationY.value=y),w!==X.orientationZ.value&&(X.orientationZ.value=w),N!==X.panningModel&&(X.panningModel=N),A!==X.positionX.value&&(X.positionX.value=A),b!==X.positionY.value&&(X.positionY.value=b),S!==X.positionZ.value&&(X.positionZ.value=S),C!==X.refDistance&&(X.refDistance=C),v!==X.rolloffFactor&&(X.rolloffFactor=v),(Y[0]!==1||Y[1]!==0||Y[2]!==0)&&x.setOrientation(...Y),(ie[0]!==0||ie[1]!==0||ie[2]!==0)&&x.setPosition(...ie);const F=()=>{O.connect(x),n(O,V,0,0),V.connect(D).connect(M,0,0),V.connect(q).connect(M,0,1),V.connect(L).connect(M,0,2),V.connect(B).connect(M,0,3),V.connect(U).connect(M,0,4),V.connect(E).connect(M,0,5),M.connect(R).connect(h.destination)},P=()=>{O.disconnect(x),o(O,V,0,0),V.disconnect(D),D.disconnect(M),V.disconnect(q),q.disconnect(M),V.disconnect(L),L.disconnect(M),V.disconnect(B),B.disconnect(M),V.disconnect(U),U.disconnect(M),V.disconnect(E),E.disconnect(M),M.disconnect(R),R.disconnect(h.destination)};return u(Xt(X,x),F,P)},Du=n=>(e,{disableNormalization:t,imag:s,real:i})=>{const r=s instanceof Float32Array?s:new Float32Array(s),c=i instanceof Float32Array?i:new Float32Array(i),o=e.createPeriodicWave(c,r,{disableNormalization:t});if(Array.from(s).length<2)throw n();return o},hs=(n,e,t,s)=>n.createScriptProcessor(e,t,s),Pu=(n,e)=>(t,s)=>{const i=s.channelCountMode;if(i==="clamped-max")throw e();if(t.createStereoPanner===void 0)return n(t,s);const r=t.createStereoPanner();return be(r,s),he(r,s,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>i,set:c=>{if(c!==i)throw e()}}),r},Fu=(n,e,t,s,i,r)=>{const o=new Float32Array([1,1]),l=Math.PI/2,u={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...u,oversample:"none"},d=(m,g,_,y)=>{const w=new Float32Array(16385),N=new Float32Array(16385);for(let k=0;k<16385;k+=1){const x=k/16384*l;w[k]=Math.cos(x),N[k]=Math.sin(x)}const A=t(m,{...u,gain:0}),b=s(m,{...h,curve:w}),S=s(m,{...h,curve:o}),C=t(m,{...u,gain:0}),v=s(m,{...h,curve:N});return{connectGraph(){g.connect(A),g.connect(S.inputs===void 0?S:S.inputs[0]),g.connect(C),S.connect(_),_.connect(b.inputs===void 0?b:b.inputs[0]),_.connect(v.inputs===void 0?v:v.inputs[0]),b.connect(A.gain),v.connect(C.gain),A.connect(y,0,0),C.connect(y,0,1)},disconnectGraph(){g.disconnect(A),g.disconnect(S.inputs===void 0?S:S.inputs[0]),g.disconnect(C),S.disconnect(_),_.disconnect(b.inputs===void 0?b:b.inputs[0]),_.disconnect(v.inputs===void 0?v:v.inputs[0]),b.disconnect(A.gain),v.disconnect(C.gain),A.disconnect(y,0,0),C.disconnect(y,0,1)}}},f=(m,g,_,y)=>{const w=new Float32Array(16385),N=new Float32Array(16385),A=new Float32Array(16385),b=new Float32Array(16385),S=Math.floor(16385/2);for(let B=0;B<16385;B+=1)if(B>S){const U=(B-S)/(16384-S)*l;w[B]=Math.cos(U),N[B]=Math.sin(U),A[B]=0,b[B]=1}else{const U=B/(16384-S)*l;w[B]=1,N[B]=0,A[B]=Math.cos(U),b[B]=Math.sin(U)}const C=e(m,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),v=t(m,{...u,gain:0}),k=s(m,{...h,curve:w}),x=t(m,{...u,gain:0}),j=s(m,{...h,curve:N}),M=s(m,{...h,curve:o}),O=t(m,{...u,gain:0}),D=s(m,{...h,curve:A}),q=t(m,{...u,gain:0}),L=s(m,{...h,curve:b});return{connectGraph(){g.connect(C),g.connect(M.inputs===void 0?M:M.inputs[0]),C.connect(v,0),C.connect(x,0),C.connect(O,1),C.connect(q,1),M.connect(_),_.connect(k.inputs===void 0?k:k.inputs[0]),_.connect(j.inputs===void 0?j:j.inputs[0]),_.connect(D.inputs===void 0?D:D.inputs[0]),_.connect(L.inputs===void 0?L:L.inputs[0]),k.connect(v.gain),j.connect(x.gain),D.connect(O.gain),L.connect(q.gain),v.connect(y,0,0),O.connect(y,0,0),x.connect(y,0,1),q.connect(y,0,1)},disconnectGraph(){g.disconnect(C),g.disconnect(M.inputs===void 0?M:M.inputs[0]),C.disconnect(v,0),C.disconnect(x,0),C.disconnect(O,1),C.disconnect(q,1),M.disconnect(_),_.disconnect(k.inputs===void 0?k:k.inputs[0]),_.disconnect(j.inputs===void 0?j:j.inputs[0]),_.disconnect(D.inputs===void 0?D:D.inputs[0]),_.disconnect(L.inputs===void 0?L:L.inputs[0]),k.disconnect(v.gain),j.disconnect(x.gain),D.disconnect(O.gain),L.disconnect(q.gain),v.disconnect(y,0,0),O.disconnect(y,0,0),x.disconnect(y,0,1),q.disconnect(y,0,1)}}},p=(m,g,_,y,w)=>{if(g===1)return d(m,_,y,w);if(g===2)return f(m,_,y,w);throw i()};return(m,{channelCount:g,channelCountMode:_,pan:y,...w})=>{if(_==="max")throw i();const N=n(m,{...w,channelCount:1,channelCountMode:_,numberOfInputs:2}),A=t(m,{...w,channelCount:g,channelCountMode:_,gain:1}),b=t(m,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:y});let{connectGraph:S,disconnectGraph:C}=p(m,g,A,b,N);Object.defineProperty(b.gain,"defaultValue",{get:()=>0}),Object.defineProperty(b.gain,"maxValue",{get:()=>1}),Object.defineProperty(b.gain,"minValue",{get:()=>-1});const v={get bufferSize(){},get channelCount(){return A.channelCount},set channelCount(M){A.channelCount!==M&&(k&&C(),{connectGraph:S,disconnectGraph:C}=p(m,M,A,b,N),k&&S()),A.channelCount=M},get channelCountMode(){return A.channelCountMode},set channelCountMode(M){if(M==="clamped-max"||M==="max")throw i();A.channelCountMode=M},get channelInterpretation(){return A.channelInterpretation},set channelInterpretation(M){A.channelInterpretation=M},get context(){return A.context},get inputs(){return[A]},get numberOfInputs(){return A.numberOfInputs},get numberOfOutputs(){return A.numberOfOutputs},get pan(){return b.gain},addEventListener(...M){return A.addEventListener(M[0],M[1],M[2])},dispatchEvent(...M){return A.dispatchEvent(M[0])},removeEventListener(...M){return A.removeEventListener(M[0],M[1],M[2])}};let k=!1;const x=()=>{S(),k=!0},j=()=>{C(),k=!1};return r(Xt(v,N),x,j)}},Lu=(n,e,t,s,i,r,c)=>(o,l)=>{const u=o.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&o.createGain().gain.automationRate===void 0)return t(o,l);be(u,l);const h=l.curve===null||l.curve instanceof Float32Array?l.curve:new Float32Array(l.curve);if(h!==null&&h.length<2)throw e();ae(u,{curve:h},"curve"),ae(u,l,"oversample");let d=null,f=!1;return c(u,"curve",g=>()=>g.call(u),g=>_=>(g.call(u,_),f&&(s(_)&&d===null?d=n(o,u):!s(_)&&d!==null&&(d(),d=null)),_)),i(u,()=>{f=!0,s(u.curve)&&(d=n(o,u))},()=>{f=!1,d!==null&&(d(),d=null)})},Vu=(n,e,t,s,i)=>(r,{curve:c,oversample:o,...l})=>{const u=r.createWaveShaper(),h=r.createWaveShaper();be(u,l),be(h,l);const d=t(r,{...l,gain:1}),f=t(r,{...l,gain:-1}),p=t(r,{...l,gain:1}),m=t(r,{...l,gain:-1});let g=null,_=!1,y=null;const w={get bufferSize(){},get channelCount(){return u.channelCount},set channelCount(b){d.channelCount=b,f.channelCount=b,u.channelCount=b,p.channelCount=b,h.channelCount=b,m.channelCount=b},get channelCountMode(){return u.channelCountMode},set channelCountMode(b){d.channelCountMode=b,f.channelCountMode=b,u.channelCountMode=b,p.channelCountMode=b,h.channelCountMode=b,m.channelCountMode=b},get channelInterpretation(){return u.channelInterpretation},set channelInterpretation(b){d.channelInterpretation=b,f.channelInterpretation=b,u.channelInterpretation=b,p.channelInterpretation=b,h.channelInterpretation=b,m.channelInterpretation=b},get context(){return u.context},get curve(){return y},set curve(b){if(b!==null&&b.length<2)throw e();if(b===null)u.curve=b,h.curve=b;else{const S=b.length,C=new Float32Array(S+2-S%2),v=new Float32Array(S+2-S%2);C[0]=b[0],v[0]=-b[S-1];const k=Math.ceil((S+1)/2),x=(S+1)/2-1;for(let j=1;j<k;j+=1){const M=j/k*x,O=Math.floor(M),D=Math.ceil(M);C[j]=O===D?b[O]:(1-(M-O))*b[O]+(1-(D-M))*b[D],v[j]=O===D?-b[S-1-O]:-((1-(M-O))*b[S-1-O])-(1-(D-M))*b[S-1-D]}C[k]=S%2===1?b[k-1]:(b[k-2]+b[k-1])/2,u.curve=C,h.curve=v}y=b,_&&(s(y)&&g===null?g=n(r,d):g!==null&&(g(),g=null))},get inputs(){return[d]},get numberOfInputs(){return u.numberOfInputs},get numberOfOutputs(){return u.numberOfOutputs},get oversample(){return u.oversample},set oversample(b){u.oversample=b,h.oversample=b},addEventListener(...b){return d.addEventListener(b[0],b[1],b[2])},dispatchEvent(...b){return d.dispatchEvent(b[0])},removeEventListener(...b){return d.removeEventListener(b[0],b[1],b[2])}};c!==null&&(w.curve=c instanceof Float32Array?c:new Float32Array(c)),o!==w.oversample&&(w.oversample=o);const N=()=>{d.connect(u).connect(p),d.connect(f).connect(h).connect(m).connect(p),_=!0,s(y)&&(g=n(r,d))},A=()=>{d.disconnect(u),u.disconnect(p),d.disconnect(f),f.disconnect(h),h.disconnect(m),m.disconnect(p),_=!1,g!==null&&(g(),g=null)};return i(Xt(w,p),N,A)},Me=()=>new DOMException("","NotSupportedError"),qu={numberOfChannels:1},Wu=(n,e,t,s,i)=>class extends n{constructor(c,o,l){let u;if(typeof c=="number"&&o!==void 0&&l!==void 0)u={length:o,numberOfChannels:c,sampleRate:l};else if(typeof c=="object")u=c;else throw new Error("The given parameters are not valid.");const{length:h,numberOfChannels:d,sampleRate:f}={...qu,...u},p=s(d,h,f);e(ss,()=>ss(p))||p.addEventListener("statechange",(()=>{let m=0;const g=_=>{this._state==="running"&&(m>0?(p.removeEventListener("statechange",g),_.stopImmediatePropagation(),this._waitForThePromiseToSettle(_)):m+=1)};return g})()),super(p,d),this._length=h,this._nativeOfflineAudioContext=p,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,rr(this)}))}_waitForThePromiseToSettle(c){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(c):setTimeout(()=>this._waitForThePromiseToSettle(c))}},Bu={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Uu=(n,e,t,s,i,r,c)=>class extends n{constructor(l,u){const h=i(l),d={...Bu,...u},f=t(h,d),p=r(h),m=p?s():null,g=l.sampleRate/2;super(l,!1,f,m),this._detune=e(this,p,f.detune,153600,-153600),this._frequency=e(this,p,f.frequency,g,-g),this._nativeOscillatorNode=f,this._onended=null,this._oscillatorNodeRenderer=m,this._oscillatorNodeRenderer!==null&&d.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=d.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(l){const u=typeof l=="function"?c(this,l):null;this._nativeOscillatorNode.onended=u;const h=this._nativeOscillatorNode.onended;this._onended=h!==null&&h===u?l:h}get type(){return this._nativeOscillatorNode.type}set type(l){this._nativeOscillatorNode.type=l,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(l){this._nativeOscillatorNode.setPeriodicWave(l),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=l)}start(l=0){if(this._nativeOscillatorNode.start(l),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=l),this.context.state!=="closed"){Vt(this);const u=()=>{this._nativeOscillatorNode.removeEventListener("ended",u),nt(this)&&os(this)};this._nativeOscillatorNode.addEventListener("ended",u)}}stop(l=0){this._nativeOscillatorNode.stop(l),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=l)}},Gu=(n,e,t,s,i)=>()=>{const r=new WeakMap;let c=null,o=null,l=null;const u=async(h,d)=>{let f=t(h);const p=Ce(f,d);if(!p){const m={channelCount:f.channelCount,channelCountMode:f.channelCountMode,channelInterpretation:f.channelInterpretation,detune:f.detune.value,frequency:f.frequency.value,periodicWave:c===null?void 0:c,type:f.type};f=e(d,m),o!==null&&f.start(o),l!==null&&f.stop(l)}return r.set(d,f),p?(await n(d,h.detune,f.detune),await n(d,h.frequency,f.frequency)):(await s(d,h.detune,f.detune),await s(d,h.frequency,f.frequency)),await i(h,d,f),f};return{set periodicWave(h){c=h},set start(h){o=h},set stop(h){l=h},render(h,d){const f=r.get(d);return f!==void 0?Promise.resolve(f):u(h,d)}}},$u={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},zu=(n,e,t,s,i,r,c)=>class extends n{constructor(l,u){const h=i(l),d={...$u,...u},f=t(h,d),p=r(h),m=p?s():null;super(l,!1,f,m),this._nativePannerNode=f,this._orientationX=e(this,p,f.orientationX,Ae,Ie),this._orientationY=e(this,p,f.orientationY,Ae,Ie),this._orientationZ=e(this,p,f.orientationZ,Ae,Ie),this._positionX=e(this,p,f.positionX,Ae,Ie),this._positionY=e(this,p,f.positionY,Ae,Ie),this._positionZ=e(this,p,f.positionZ,Ae,Ie),c(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(l){this._nativePannerNode.coneInnerAngle=l}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(l){this._nativePannerNode.coneOuterAngle=l}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(l){this._nativePannerNode.coneOuterGain=l}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(l){this._nativePannerNode.distanceModel=l}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(l){this._nativePannerNode.maxDistance=l}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(l){this._nativePannerNode.panningModel=l}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(l){this._nativePannerNode.refDistance=l}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(l){this._nativePannerNode.rolloffFactor=l}},Xu=(n,e,t,s,i,r,c,o,l,u)=>()=>{const h=new WeakMap;let d=null;const f=async(p,m)=>{let g=null,_=r(p);const y={channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation},w={...y,coneInnerAngle:_.coneInnerAngle,coneOuterAngle:_.coneOuterAngle,coneOuterGain:_.coneOuterGain,distanceModel:_.distanceModel,maxDistance:_.maxDistance,panningModel:_.panningModel,refDistance:_.refDistance,rolloffFactor:_.rolloffFactor},N=Ce(_,m);if("bufferSize"in _)g=s(m,{...y,gain:1});else if(!N){const A={...w,orientationX:_.orientationX.value,orientationY:_.orientationY.value,orientationZ:_.orientationZ.value,positionX:_.positionX.value,positionY:_.positionY.value,positionZ:_.positionZ.value};_=i(m,A)}if(h.set(m,g===null?_:g),g!==null){if(d===null){if(c===null)throw new Error("Missing the native OfflineAudioContext constructor.");const j=new c(6,p.context.length,m.sampleRate),M=e(j,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});M.connect(j.destination),d=(async()=>{const O=await Promise.all([p.orientationX,p.orientationY,p.orientationZ,p.positionX,p.positionY,p.positionZ].map(async(D,q)=>{const L=t(j,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:q===0?1:0});return await o(j,D,L.offset),L}));for(let D=0;D<6;D+=1)O[D].connect(M,0,D),O[D].start(0);return u(j)})()}const A=await d,b=s(m,{...y,gain:1});await l(p,m,b);const S=[];for(let j=0;j<A.numberOfChannels;j+=1)S.push(A.getChannelData(j));let C=[S[0][0],S[1][0],S[2][0]],v=[S[3][0],S[4][0],S[5][0]],k=s(m,{...y,gain:1}),x=i(m,{...w,orientationX:C[0],orientationY:C[1],orientationZ:C[2],positionX:v[0],positionY:v[1],positionZ:v[2]});b.connect(k).connect(x.inputs[0]),x.connect(g);for(let j=128;j<A.length;j+=128){const M=[S[0][j],S[1][j],S[2][j]],O=[S[3][j],S[4][j],S[5][j]];if(M.some((D,q)=>D!==C[q])||O.some((D,q)=>D!==v[q])){C=M,v=O;const D=j/m.sampleRate;k.gain.setValueAtTime(0,D),k=s(m,{...y,gain:0}),x=i(m,{...w,orientationX:C[0],orientationY:C[1],orientationZ:C[2],positionX:v[0],positionY:v[1],positionZ:v[2]}),k.gain.setValueAtTime(1,D),b.connect(k).connect(x.inputs[0]),x.connect(g)}}return g}return N?(await n(m,p.orientationX,_.orientationX),await n(m,p.orientationY,_.orientationY),await n(m,p.orientationZ,_.orientationZ),await n(m,p.positionX,_.positionX),await n(m,p.positionY,_.positionY),await n(m,p.positionZ,_.positionZ)):(await o(m,p.orientationX,_.orientationX),await o(m,p.orientationY,_.orientationY),await o(m,p.orientationZ,_.orientationZ),await o(m,p.positionX,_.positionX),await o(m,p.positionY,_.positionY),await o(m,p.positionZ,_.positionZ)),zt(_)?await l(p,m,_.inputs[0]):await l(p,m,_),_};return{render(p,m){const g=h.get(m);return g!==void 0?Promise.resolve(g):f(p,m)}}},Yu={disableNormalization:!1},Hu=(n,e,t,s)=>class fr{constructor(r,c){const o=e(r),l=s({...Yu,...c}),u=n(o,l);return t.add(u),u}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===fr.prototype||t.has(r)}},Zu=(n,e)=>(t,s,i)=>(n(s).replay(i),e(s,t,i)),Ju=(n,e,t)=>async(s,i,r)=>{const c=n(s);await Promise.all(c.activeInputs.map((o,l)=>Array.from(o).map(async([u,h])=>{const f=await e(u).render(u,i),p=s.context.destination;!t(u)&&(s!==p||!t(s))&&f.connect(r,h,l)})).reduce((o,l)=>[...o,...l],[]))},Qu=(n,e,t)=>async(s,i,r)=>{const c=e(s);await Promise.all(Array.from(c.activeInputs).map(async([o,l])=>{const h=await n(o).render(o,i);t(o)||h.connect(r,l)}))},Ku=(n,e,t,s)=>i=>n(ss,()=>ss(i))?Promise.resolve(n(s,s)).then(r=>{if(!r){const c=t(i,512,0,1);i.oncomplete=()=>{c.onaudioprocess=null,c.disconnect()},c.onaudioprocess=()=>i.currentTime,c.connect(i.destination)}return i.startRendering()}):new Promise(r=>{const c=e(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=o=>{c.disconnect(),r(o.renderedBuffer)},c.connect(i.destination),i.startRendering()}),eh=n=>(e,t)=>{n.set(e,t)},th=n=>(e,t)=>n.set(e,t),sh=(n,e,t,s,i,r,c,o)=>(l,u)=>t(l).render(l,u).then(()=>Promise.all(Array.from(s(u)).map(h=>t(h).render(h,u)))).then(()=>i(u)).then(h=>(typeof h.copyFromChannel!="function"?(c(h),On(h)):e(r,()=>r(h))||o(h),n.add(h),h)),nh={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},ih=(n,e,t,s,i,r)=>class extends n{constructor(o,l){const u=i(o),h={...nh,...l},d=t(u,h),f=r(u),p=f?s():null;super(o,!1,d,p),this._pan=e(this,f,d.pan)}get pan(){return this._pan}},rh=(n,e,t,s,i)=>()=>{const r=new WeakMap,c=async(o,l)=>{let u=t(o);const h=Ce(u,l);if(!h){const d={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,pan:u.pan.value};u=e(l,d)}return r.set(l,u),h?await n(l,o.pan,u.pan):await s(l,o.pan,u.pan),zt(u)?await i(o,l,u.inputs[0]):await i(o,l,u),u};return{render(o,l){const u=r.get(l);return u!==void 0?Promise.resolve(u):c(o,l)}}},ah=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},oh=(n,e)=>async()=>{if(n===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new e(1,128,44100),i=URL.createObjectURL(t);let r=!1,c=!1;try{await s.audioWorklet.addModule(i);const o=new n(s,"a",{numberOfOutputs:0}),l=s.createOscillator();o.port.onmessage=()=>r=!0,o.onprocessorerror=()=>c=!0,l.connect(o),l.start(0),await s.startRendering(),await new Promise(u=>setTimeout(u))}catch{}finally{URL.revokeObjectURL(i)}return r&&!c},ch=(n,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{t.oncomplete=()=>{s.disconnect(),i(t.currentTime!==0)},t.startRendering()})},lh=()=>new DOMException("","UnknownError"),uh={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},hh=(n,e,t,s,i,r,c)=>class extends n{constructor(l,u){const h=i(l),d={...uh,...u},f=t(h,d),m=r(h)?s():null;super(l,!0,f,m),this._isCurveNullified=!1,this._nativeWaveShaperNode=f,c(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(l){if(l===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(l.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=l}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(l){this._nativeWaveShaperNode.oversample=l}},dh=(n,e,t)=>()=>{const s=new WeakMap,i=async(r,c)=>{let o=e(r);if(!Ce(o,c)){const u={channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation,curve:o.curve,oversample:o.oversample};o=n(c,u)}return s.set(c,o),zt(o)?await t(r,c,o.inputs[0]):await t(r,c,o),o};return{render(r,c){const o=s.get(c);return o!==void 0?Promise.resolve(o):i(r,c)}}},ph=()=>typeof window>"u"?null:window,mh=(n,e)=>t=>{t.copyFromChannel=(s,i,r=0)=>{const c=n(r),o=n(i);if(o>=t.numberOfChannels)throw e();const l=t.length,u=t.getChannelData(o),h=s.length;for(let d=c<0?-c:0;d+c<l&&d<h;d+=1)s[d]=u[d+c]},t.copyToChannel=(s,i,r=0)=>{const c=n(r),o=n(i);if(o>=t.numberOfChannels)throw e();const l=t.length,u=t.getChannelData(o),h=s.length;for(let d=c<0?-c:0;d+c<l&&d<h;d+=1)u[d+c]=s[d]}},fh=n=>e=>{e.copyFromChannel=(t=>(s,i,r=0)=>{const c=n(r),o=n(i);if(c<e.length)return t.call(e,s,o,c)})(e.copyFromChannel),e.copyToChannel=(t=>(s,i,r=0)=>{const c=n(r),o=n(i);if(c<e.length)return t.call(e,s,o,c)})(e.copyToChannel)},gh=n=>(e,t)=>{const s=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=s),n(e,"buffer",i=>()=>{const r=i.call(e);return r===s?null:r},i=>r=>i.call(e,r===null?s:r))},_h=(n,e)=>(t,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const i=t.createBufferSource();e(s,()=>{const o=s.numberOfInputs;for(let l=0;l<o;l+=1)i.connect(s,0,l)},()=>i.disconnect(s))},gr=(n,e,t)=>n.copyFromChannel===void 0?n.getChannelData(t)[0]:(n.copyFromChannel(e,t),e[0]),_r=n=>{if(n===null)return!1;const e=n.length;return e%2!==0?n[Math.floor(e/2)]!==0:n[e/2-1]+n[e/2]!==0},ds=(n,e,t,s)=>{let i=n;for(;!i.hasOwnProperty(e);)i=Object.getPrototypeOf(i);const{get:r,set:c}=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(n,e,{get:t(r),set:s(c)})},vh=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),yh=n=>({...n,channelCount:n.numberOfOutputs}),bh=n=>{const{imag:e,real:t}=n;return e===void 0?t===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(t,()=>0),real:t}:t===void 0?{...n,imag:e,real:Array.from(e,()=>0)}:{...n,imag:e,real:t}},vr=(n,e,t)=>{try{n.setValueAtTime(e,t)}catch(s){if(s.code!==9)throw s;vr(n,e,t+1e-7)}},xh=n=>{const e=n.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},wh=n=>{const e=n.createBufferSource(),t=n.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},Th=n=>{const e=n.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},Ln=n=>{const e=n.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},yr=n=>{const e=n.createBuffer(1,1,44100),t=n.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Vn=n=>{const e=n.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},Nh=n=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(n)}finally{e.close(),t.close()}},Sh=n=>{n.start=(e=>(t=0,s=0,i)=>{const r=n.buffer,c=r===null?s:Math.min(r.duration,s);r!==null&&c>r.duration-.5/n.context.sampleRate?e.call(n,t,0,0):e.call(n,t,c,i)})(n.start)},br=(n,e)=>{const t=e.createGain();n.connect(t);const s=(i=>()=>{i.call(n,t),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),Xt(n,t),n.stop=(i=>{let r=!1;return(c=0)=>{if(r)try{i.call(n,c)}catch{t.gain.setValueAtTime(0,c)}else i.call(n,c),r=!0}})(n.stop)},Yt=(n,e)=>t=>{const s={value:n};return Object.defineProperties(t,{currentTarget:s,target:s}),typeof e=="function"?e.call(n,t):e.handleEvent.call(n,t)},kh=zo(Mt),Ch=Qo(Mt),Ah=ul($s),xr=new WeakMap,jh=Al(xr),$e=qc(new Map,new WeakMap),Ze=ph(),wr=iu($e,Qe),qn=Cl(je),Ne=Ju(je,qn,kt),Mh=nc(wr,ne,Ne),se=El(Gs),rt=Eu(Ze),te=Yl(rt),Tr=new WeakMap,Nr=bl(Yt),ps=cu(Ze),Wn=Gl(ps),Bn=$l(Ze),Sr=zl(Ze),ns=uu(Ze),pe=Ac(Xo(Qi),Jo(kh,Ch,Is,Ah,Os,je,jh,as,ne,Mt,nt,kt,Ns),$e,Vl(xn,Os,je,ne,ts,nt),Qe,zs,Me,al(Is,xn,je,ne,ts,se,nt,te),pl(Tr,je,Ge),Nr,se,Wn,Bn,Sr,te,ns),Eh=sc(pe,Mh,Qe,wr,se,te),Un=new WeakSet,Di=ru(Ze),kr=Kc(new Uint32Array(1)),Gn=mh(kr,Qe),$n=fh(kr),Cr=rc(Un,$e,Me,Di,rt,ah(Di),Gn,$n),Xs=Ko(Re),Ar=Qu(qn,cs,kt),Ke=Xc(Ar),Ht=ou(Xs,$e,xh,wh,Th,Ln,yr,Vn,Sh,gh(ds),br),et=Zu(jl(cs),Ar),Ih=cc(Ke,Ht,ne,et,Ne),ze=jc(Yo(Ki),Tr,In,Mc,qo,Wo,Bo,Uo,Go,vn,Zi,ps,vr),Oh=oc(pe,Ih,ze,we,Ht,se,te,Yt),Rh=_c(pe,vc,Qe,we,lu(Re,ds),se,te,Ne),Dh=Vc(Ke,pr,ne,et,Ne),Et=th(xr),Ph=Lc(pe,ze,Dh,zs,pr,se,te,Et),_t=su(Mt,Bn),Fh=_h(we,_t),vt=_u(ps,Fh),Lh=Uc(vt,ne,Ne),Vh=Bc(pe,Lh,vt,se,te),qh=zc(us,ne,Ne),Wh=$c(pe,qh,us,se,te,yh),Bh=bu(Xs,Ht,Re,_t),Zt=yu(Xs,$e,Bh,Ln,Vn),Uh=Qc(Ke,Zt,ne,et,Ne),Gh=Jc(pe,ze,Uh,Zt,se,te,Yt),jr=xu(Me,ds),$h=sl(jr,ne,Ne),zh=tl(pe,$h,jr,se,te,Et),Xh=ll(Ke,mr,ne,et,Ne),Yh=cl(pe,ze,Xh,mr,se,te,Et),Mr=wu(Me),Hh=_l(Ke,Mr,ne,et,Ne),Zh=gl(pe,ze,Hh,Mr,Me,se,te,Et),Jh=Sl(Ke,Re,ne,et,Ne),Qh=Nl(pe,ze,Jh,Re,se,te),Kh=ku(zs,we,hs,Me),Ys=Ku($e,Re,hs,ch(Re,rt)),ed=Ll(Ht,ne,rt,Ne,Ys),td=Tu(Kh),sd=Pl(pe,td,ed,se,te,Et),nd=yc(ze,vt,Zt,hs,Me,gr,te,ds),Er=new WeakMap,id=tu(Rh,nd,Nr,te,Er,Yt),Ir=Iu(Xs,$e,Ln,yr,Vn,br),rd=Gu(Ke,Ir,ne,et,Ne),ad=Uu(pe,ze,Ir,rd,se,te,Yt),Or=Hc(Ht),od=Vu(Or,we,Re,_r,_t),Hs=Lu(Or,we,od,_r,_t,ps,ds),cd=Ru(Is,we,vt,Re,hs,Hs,Me,Os,gr,_t),Rr=Ou(cd),ld=Xu(Ke,vt,Zt,Re,Rr,ne,rt,et,Ne,Ys),ud=zu(pe,ze,Rr,ld,se,te,Et),hd=Du(Qe),dd=Hu(hd,se,new WeakSet,bh),pd=Fu(vt,us,Re,Hs,Me,_t),Dr=Pu(pd,Me),md=rh(Ke,Dr,ne,et,Ne),fd=ih(pe,ze,Dr,md,se,te),gd=dh(Hs,ne,Ne),_d=hh(pe,we,Hs,gd,se,te,Et),Pr=Hl(Ze),zn=xl(Ze),Fr=new WeakMap,vd=Il(Fr,rt),yd=Pr?Zo($e,Me,yl(Ze),zn,wl($o),se,vd,te,ns,new WeakMap,new WeakMap,oh(ns,rt),Ze):void 0,bd=Xl(Wn,te),xd=rl(Un,$e,il,vl,new WeakSet,se,bd,Ms,ss,Gn,$n),Lr=Pc(yd,Eh,Cr,Oh,Ph,Vh,Wh,Gh,zh,xd,Yh,Zh,Qh,sd,id,ad,ud,dd,fd,_d),wd=Zl(pe,Cu,se,te),Td=Ql(pe,Au,se,te),Nd=Kl(pe,ju,se,te),Sd=Mu(we,te),kd=eu(pe,Sd,se),Cd=gc(Lr,we,Me,lh,wd,Td,Nd,kd,ps),Xn=Ol(Er),Ad=ec(Xn),Vr=Yc(Qe),jd=hl(Xn),qr=ml(Qe),Wr=new WeakMap,Md=kl(Wr,Ge),Ed=gu(Vr,Qe,we,vt,us,Zt,Re,hs,Me,qr,zn,Md,_t),Id=du(we,Ed,Re,Me,_t),Od=Dc(Ke,Vr,Ht,vt,us,Zt,Re,jd,qr,zn,ne,ns,rt,et,Ne,Ys),Rd=Ml(Fr),Dd=eh(Wr),Pi=Pr?Ic(Ad,pe,ze,Od,Id,je,Rd,se,te,ns,vh,Dd,Nh,Yt):void 0,Pd=nl(Me,rt),Fd=sh(Un,$e,qn,Xn,Ys,Ms,Gn,$n),Ld=Wu(Lr,$e,we,Pd,Fd),Vd=ql(Gs,Wn),qd=Wl(En,Bn),Wd=Bl(In,Sr),Bd=Ul(Gs,te);function Le(n){return n===void 0}function H(n){return n!==void 0}function Ud(n){return typeof n=="function"}function Je(n){return typeof n=="number"}function ht(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function Br(n){return typeof n=="boolean"}function Oe(n){return Array.isArray(n)}function it(n){return typeof n=="string"}function ws(n){return it(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function $(n,e){if(!n)throw new Error(e)}function pt(n,e,t=1/0){if(!(e<=n&&n<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${n}`)}function Ur(n){!n.isOffline&&n.state!=="running"&&Zs('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Gr=!1,Fi=!1;function Li(n){Gr=n}function Gd(n){Le(n)&&Gr&&!Fi&&(Fi=!0,Zs("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let $r=console;function $d(...n){$r.log(...n)}function Zs(...n){$r.warn(...n)}function zd(n){return new Cd(n)}function Xd(n,e,t){return new Ld(n,e,t)}const De=typeof self=="object"?self:null,Yd=De&&(De.hasOwnProperty("AudioContext")||De.hasOwnProperty("webkitAudioContext"));function Hd(n,e,t){return $(H(Pi),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof De?.BaseAudioContext?De?.AudioWorkletNode:Pi)(n,e,t)}function Xe(n,e,t,s){var i=arguments.length,r=i<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,e,t,s);else for(var o=n.length-1;o>=0;o--)(c=n[o])&&(r=(i<3?c(r):i>3?c(e,t,r):c(e,t))||r);return i>3&&r&&Object.defineProperty(e,t,r),r}function _e(n,e,t,s){function i(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function o(h){try{u(s.next(h))}catch(d){c(d)}}function l(h){try{u(s.throw(h))}catch(d){c(d)}}function u(h){h.done?r(h.value):i(h.value).then(o,l)}u((s=s.apply(n,e||[])).next())})}class Zd{constructor(e,t,s,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),s=new Worker(t);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function Ct(n){return Wd(n)}function dt(n){return qd(n)}function Ss(n){return Bd(n)}function Ot(n){return Vd(n)}function Jd(n){return n instanceof Cr}function Qd(n,e){return n==="value"||Ct(e)||dt(e)||Jd(e)}function Tt(n,...e){if(!e.length)return n;const t=e.shift();if(ht(n)&&ht(t))for(const s in t)Qd(s,t[s])?n[s]=t[s]:ht(t[s])?(n[s]||Object.assign(n,{[s]:{}}),Tt(n[s],t[s])):Object.assign(n,{[s]:t[s]});return Tt(n,...e)}function Kd(n,e){return n.length===e.length&&n.every((t,s)=>e[s]===t)}function z(n,e,t=[],s){const i={},r=Array.from(e);if(ht(r[0])&&s&&!Reflect.has(r[0],s)&&(Object.keys(r[0]).some(o=>Reflect.has(n,o))||(Tt(i,{[s]:r[0]}),t.splice(t.indexOf(s),1),r.shift())),r.length===1&&ht(r[0]))Tt(i,r[0]);else for(let c=0;c<t.length;c++)H(r[c])&&(i[t[c]]=r[c]);return Tt(n,i)}function ep(n){return n.constructor.getDefaults()}function He(n,e){return Le(n)?e:n}function kn(n,e){return e.forEach(t=>{Reflect.has(n,t)&&delete n[t]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class at{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||De&&this.toString()===De.TONE_DEBUG_CLASS)&&$d(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}at.version=Hi;const Yn=1e-6;function qt(n,e){return n>e+Yn}function Cn(n,e){return qt(n,e)||Be(n,e)}function Fs(n,e){return n+Yn<e}function Be(n,e){return Math.abs(n-e)<Yn}function tp(n,e,t){return Math.max(Math.min(n,t),e)}class We extends at{constructor(){super(),this.name="Timeline",this._timeline=[];const e=z(We.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if($(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];$(Cn(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const s=this._search(e,t);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const s=this._search(e,t);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const s=this._search(e);return s-1>=0?this._timeline[s-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(Be(this._timeline[t].time,e)){for(let s=t;s>=0&&Be(this._timeline[s].time,e);s--)t=s;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&Cn(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let s=0;const i=this._timeline.length;let r=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;s<r;){let c=Math.floor(s+(r-s)/2);const o=this._timeline[c],l=this._timeline[c+1];if(Be(o[t],e)){for(let u=c;u<this._timeline.length;u++){const h=this._timeline[u];if(Be(h[t],e))c=u;else break}return c}else{if(Fs(o[t],e)&&qt(l[t],e))return c;qt(o[t],e)?r=c:s=c+1}}return-1}_iterate(e,t=0,s=this._timeline.length-1){this._timeline.slice(t,s+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const s=this._search(e);return s!==-1&&this._iterate(t,0,s),this}forEachAfter(e,t){const s=this._search(e);return this._iterate(t,s+1),this}forEachBetween(e,t,s){let i=this._search(e),r=this._search(t);return i!==-1&&r!==-1?(this._timeline[i].time!==e&&(i+=1),this._timeline[r].time===t&&(r-=1),this._iterate(s,i,r)):i===-1&&this._iterate(s,0,r),this}forEachFrom(e,t){let s=this._search(e);for(;s>=0&&this._timeline[s].time>=e;)s--;return this._iterate(t,s+1),this}forEachAtTime(e,t){const s=this._search(e);if(s!==-1&&Be(this._timeline[s].time,e)){let i=s;for(let r=s;r>=0&&Be(this._timeline[r].time,e);r--)i=r;this._iterate(r=>{t(r)},i,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const zr=[];function Js(n){zr.push(n)}function sp(n){zr.forEach(e=>e(n))}const Xr=[];function Qs(n){Xr.push(n)}function np(n){Xr.forEach(e=>e(n))}class ms extends at{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(i=>{Le(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(t)}),this}once(e,t){const s=(...i)=>{t(...i),this.off(e,s)};return this.on(e,s),this}off(e,t){return e.split(/\W+/).forEach(i=>{if(Le(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(Le(t))this._events[i]=[];else{const r=this._events[i];for(let c=r.length-1;c>=0;c--)r[c]===t&&r.splice(c,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const s=this._events[e].slice(0);for(let i=0,r=s.length;i<r;i++)s[i].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const s=Object.getOwnPropertyDescriptor(ms.prototype,t);Object.defineProperty(e.prototype,t,s)})}dispose(){return super.dispose(),this._events=void 0,this}}class Yr extends ms{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class fs extends Yr{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new We,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=z(fs.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=zd({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new Zd(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(sp(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,s){return this._context.createBuffer(e,t,s)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,s){return this._context.createPeriodicWave(e,t,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return $(Ot(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return $(Ot(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return $(Ot(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){$(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){$(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){$(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){$(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Hd(this.rawContext,e,t)}addAudioWorkletModule(e){return _e(this,void 0,void 0,function*(){$(H(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return _e(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return Ot(this._context)?this._context.resume():Promise.resolve()}close(){return _e(this,void 0,void 0,function*(){Ot(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&np(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),s=t.getChannelData(0);for(let r=0;r<s.length;r++)s[r]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:s+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const s=++this._timeoutIds,i=()=>{const r=this.now();this._timeouts.add({callback:()=>{e(),i()},id:s,time:r+t})};return i(),s}}class ip extends Yr{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,s){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return _e(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function de(n,e){Oe(e)?e.forEach(t=>de(n,t)):Object.defineProperty(n,e,{enumerable:!0,writable:!1})}function Hr(n,e){Oe(e)?e.forEach(t=>Hr(n,t)):Object.defineProperty(n,e,{writable:!0})}const ee=()=>{};class re extends at{constructor(){super(),this.name="ToneAudioBuffer",this.onload=ee;const e=z(re.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,it(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:ee,onload:ee,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:Pe().sampleRate}set(e){return e instanceof re?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return _e(this,void 0,void 0,function*(){const t=re.load(e).then(s=>{this.set(s),this.onload(this)});re.downloads.push(t);try{yield t}finally{const s=re.downloads.indexOf(t);re.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=Oe(e)&&e[0].length>0,s=t?e.length:1,i=t?e[0].length:e.length,r=Pe(),c=r.createBuffer(s,i,r.sampleRate),o=!t&&s===1?[e]:e;for(let l=0;l<s;l++)c.copyToChannel(o[l],l);return this._buffer=c,this}toMono(e){if(Je(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const s=this.numberOfChannels;for(let i=0;i<s;i++){const r=this.toArray(i);for(let c=0;c<r.length;c++)t[c]+=r[c]}t=t.map(i=>i/s),this.fromArray(t)}return this}toArray(e){if(Je(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let s=0;s<this.numberOfChannels;s++)t[s]=this.getChannelData(s);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){$(this.loaded,"Buffer is not loaded");const s=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);$(s<i,"The start time must be less than the end time");const r=i-s,c=Pe().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let o=0;o<this.numberOfChannels;o++)c.copyToChannel(this.getChannelData(o).subarray(s,i),o);return new re(c)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new re().fromArray(e)}static fromUrl(e){return _e(this,void 0,void 0,function*(){return yield new re().load(e)})}static load(e){return _e(this,void 0,void 0,function*(){const t=re.baseUrl===""||re.baseUrl.endsWith("/")?re.baseUrl:re.baseUrl+"/",s=yield fetch(t+e);if(!s.ok)throw new Error(`could not load url: ${e}`);const i=yield s.arrayBuffer();return yield Pe().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),s=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return _e(this,void 0,void 0,function*(){for(yield Promise.resolve();re.downloads.length;)yield re.downloads[0]})}}re.baseUrl="";re.downloads=[];class Hn extends fs{constructor(){super({clockSource:"offline",context:Ss(arguments[0])?arguments[0]:Xd(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:Ss(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Ss(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return _e(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const s=Math.floor(this.sampleRate/128);e&&t%s===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return _e(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new re(t)})}close(){return Promise.resolve()}}const Zr=new ip;let xt=Zr;function Pe(){return xt===Zr&&Yd&&rp(new fs),xt}function rp(n,e=!1){e&&xt.dispose(),Ot(n)?xt=new fs(n):Ss(n)?xt=new Hn(n):xt=n}function Jr(){return xt.resume()}if(De&&!De.TONE_SILENCE_LOGGING){const e=` * Tone.js v${Hi} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function ap(n){return Math.pow(10,n/20)}function op(n){return 20*(Math.log(n)/Math.LN10)}function Qr(n){return Math.pow(2,n/12)}let Ks=440;function cp(){return Ks}function lp(n){Ks=n}function wt(n){return Math.round(Kr(n))}function Kr(n){return 69+12*Math.log2(n/Ks)}function ea(n){return Ks*Math.pow(2,(n-69)/12)}class Zn extends at{constructor(e,t,s){super(),this.defaultUnits="s",this._val=t,this._units=s,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const s=parseInt(e,10),i=t==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/s)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,s)=>{let i=0;return e&&e!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i+=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i+=this._beatsToUnits(parseFloat(s)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Zn&&this.fromType(this._val),Le(this._val))return this._noArg();if(it(this._val)&&Le(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(ht(this._val)){let e=0;for(const t in this._val)if(H(this._val[t])){const s=this._val[t],i=new this.constructor(this.context,t).valueOf()*s;e+=i}return e}if(H(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return it(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class Ue extends Zn{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new Ue(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const s=new this.constructor(this.context,e).valueOf(),i=this.valueOf(),o=Math.round(i/s)*s-i;return i+o*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let r=1;r<9;r++){const c=Math.pow(2,r);t.push(c+"n."),t.push(c+"n"),t.push(c+"t")}t.push("0");let s=t[0],i=new Ue(this.context,t[0]).toSeconds();return t.forEach(r=>{const c=new Ue(this.context,r).toSeconds();Math.abs(c-e)<Math.abs(i-e)&&(s=r,i=c)}),s}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const s=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const r=i.toString();return r.length>3&&(i=parseFloat(parseFloat(r).toFixed(3))),[s,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return wt(this.toFrequency())}_now(){return this.context.now()}}class Fe extends Ue{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return cp()}static set A4(e){lp(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:Fe.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const i=up[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?i:Fe.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,s){let i=1;return e&&e!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(i*=this._beatsToUnits(parseFloat(t))),s&&s!=="0"&&(i*=this._beatsToUnits(parseFloat(s)/4)),i}}})}transpose(e){return new Fe(this.context,this.valueOf()*Qr(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return wt(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/Fe.A4);let s=Math.round(12*t)+57;const i=Math.floor(s/12);return i<0&&(s+=-12*i),hp[s%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return ea(e)}static ftom(e){return wt(e)}}const up={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},hp=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class Ft extends Ue{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Se extends at{constructor(){super();const e=z(Se.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:Pe()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return Gd(e),new Ue(this.context,e).toSeconds()}toFrequency(e){return new Fe(this.context,e).toFrequency()}toTicks(e){return new Ft(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(s=>{Le(e[s])&&delete t[s]}),t}get(){const e=ep(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const s=this[t];H(s)&&H(s.value)&&H(s.setValueAtTime)?e[t]=s.value:s instanceof Se?e[t]=s._getPartialProperties(e[t]):Oe(s)||Je(s)||it(s)||Br(s)?e[t]=s:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&H(this[t])&&(this[t]&&H(this[t].value)&&H(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Se?this[t].set(e[t]):this[t]=e[t])}),this}}class gs extends We{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,s){return pt(t,0),this.add(Object.assign({},s,{state:e,time:t})),this}getLastState(e,t){const s=this._search(t);for(let i=s;i>=0;i--){const r=this._timeline[i];if(r.state===e)return r}}getNextState(e,t){const s=this._search(t);if(s!==-1)for(let i=s;i<this._timeline.length;i++){const r=this._timeline[i];if(r.state===e)return r}}}class le extends Se{constructor(){const e=z(le.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,$(H(e.param)&&(Ct(e.param)||e.param instanceof le),"param must be an AudioParam");!Ct(e.param);)e.param=e.param._param;this._swappable=H(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new We(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,H(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Se.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return H(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return H(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return H(this.maxValue)&&H(this.minValue)&&pt(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?ap(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?op(e):e}setValueAtTime(e,t){const s=this.toSeconds(t),i=this._fromType(e);return $(isFinite(i)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,s),this._events.add({time:s,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,s),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),s=this._events.getAfter(t),i=this._events.get(t);let r=this._initialValue;if(i===null)r=this._initialValue;else if(i.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const c=this._events.getBefore(i.time);let o;c===null?o=this._initialValue:o=c.value,i.type==="setTargetAtTime"&&(r=this._exponentialApproach(i.time,o,i.value,i.constant,t))}else if(s===null)r=i.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let c=i.value;if(i.type==="setTargetAtTime"){const o=this._events.getBefore(i.time);o===null?c=this._initialValue:c=o.value}s.type==="linearRampToValueAtTime"?r=this._linearInterpolate(i.time,c,s.time,s.value,t):r=this._exponentialInterpolate(i.time,c,s.time,s.value,t)}else r=i.value;return this._toType(r)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const s=this._fromType(e),i=this.toSeconds(t);return $(isFinite(s)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this._events.add({time:i,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(s,i),this}exponentialRampToValueAtTime(e,t){let s=this._fromType(e);s=Be(s,0)?this._minOutput:s,this._assertRange(s);const i=this.toSeconds(t);return $(isFinite(s)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(s,i),this}exponentialRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(e,s+this.toSeconds(t)),this}linearRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(e,s+this.toSeconds(t)),this}targetRampTo(e,t,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(e,s,t),this}exponentialApproachValueAtTime(e,t,s){t=this.toSeconds(t),s=this.toSeconds(s);const i=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+s*.9),this.linearRampToValueAtTime(e,t+s),this}setTargetAtTime(e,t,s){const i=this._fromType(e);$(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(t);return this._assertRange(i),$(isFinite(i)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:s,time:r,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,r,s),this._param.setTargetAtTime(i,r,s),this}setValueCurveAtTime(e,t,s,i=1){s=this.toSeconds(s),t=this.toSeconds(t);const r=this._fromType(e[0])*i;this.setValueAtTime(this._toType(r),t);const c=s/(e.length-1);for(let o=1;o<e.length;o++){const l=this._fromType(e[o])*i;this.linearRampToValueAtTime(this._toType(l),t+o*c)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return $(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),s=this._fromType(this.getValueAtTime(t));$(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+s);const i=this._events.get(t),r=this._events.getAfter(t);return i&&Be(i.time,t)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),t):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),t)),this._events.add({time:t,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,t),this}rampTo(e,t=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,s):this.linearRampTo(e,t,s),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const s=this._events.get(t);if(s&&s.type==="setTargetAtTime"){const i=this._events.getAfter(s.time),r=i?i.time:t+2,c=(r-t)/10;for(let o=t;o<r;o+=c)e.linearRampToValueAtTime(this.getValueAtTime(o),o)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?e.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?e.setTargetAtTime(i.value,i.time,i.constant):e[i.type](i.value,i.time)}),this}setParam(e){$(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,s,i,r){return s+(t-s)*Math.exp(-(r-e)/i)}_linearInterpolate(e,t,s,i,r){return t+(i-t)*((r-e)/(s-e))}_exponentialInterpolate(e,t,s,i,r){return t*Math.pow(i/t,(r-e)/(s-e))}}class Z extends Se{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return H(this.input)?Ct(this.input)||this.input instanceof le?1:this.input.numberOfInputs:0}get numberOfOutputs(){return H(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return H(e)&&(e instanceof Z||dt(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(s=>{s.channelCount=e.channelCount,s.channelCountMode=e.channelCountMode,s.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();$(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,s=0){return Jt(this,e,t,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Zs("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,s=0){return dp(this,e,t,s),this}chain(...e){return An(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),H(this.input)&&(this.input instanceof Z?this.input.dispose():dt(this.input)&&this.input.disconnect()),H(this.output)&&(this.output instanceof Z?this.output.dispose():dt(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function An(...n){const e=n.shift();n.reduce((t,s)=>(t instanceof Z?t.connect(s):dt(t)&&Jt(t,s),s),e)}function Jt(n,e,t=0,s=0){for($(H(n),"Cannot connect from undefined node"),$(H(e),"Cannot connect to undefined node"),(e instanceof Z||dt(e))&&$(e.numberOfInputs>0,"Cannot connect to node with no inputs"),$(n.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof Z||e instanceof le;)H(e.input)&&(e=e.input);for(;n instanceof Z;)H(n.output)&&(n=n.output);Ct(e)?n.connect(e,t):n.connect(e,t,s)}function dp(n,e,t=0,s=0){if(H(e))for(;e instanceof Z;)e=e.input;for(;!dt(n);)H(n.output)&&(n=n.output);Ct(e)?n.disconnect(e,t):dt(e)?n.disconnect(e,t,s):n.disconnect()}class ke extends Z{constructor(){const e=z(ke.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new le({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),de(this,"gain")}static getDefaults(){return Object.assign(Z.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Wt extends Z{constructor(e){super(e),this.onended=ee,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new ke({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const s=this.toSeconds(t);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(Z.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:ee})}_startGain(e,t=1){$(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=e+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+s):this._gainNode.gain.exponentialApproachValueAtTime(t,e,s)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){$(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==ee&&(this.onended(this),this.onended=ee,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),$(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=ee,this}}class Jn extends Wt{constructor(){const e=z(Jn.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Jt(this._source,this._gainNode),this.offset=new le({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(Wt.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Te extends Z{constructor(){const e=z(Te.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Jn({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(Z.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,s=0){return Qn(this,e,t,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,s){return this._param.exponentialRampTo(e,t,s),this}linearRampTo(e,t,s){return this._param.linearRampTo(e,t,s),this}targetRampTo(e,t,s){return this._param.targetRampTo(e,t,s),this}exponentialApproachValueAtTime(e,t,s){return this._param.exponentialApproachValueAtTime(e,t,s),this}setTargetAtTime(e,t,s){return this._param.setTargetAtTime(e,t,s),this}setValueCurveAtTime(e,t,s,i){return this._param.setValueCurveAtTime(e,t,s,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,s){return this._param.rampTo(e,t,s),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Qn(n,e,t,s){(e instanceof le||Ct(e)||e instanceof Te&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof Te&&(e.overridden=!0)),Jt(n,e,t,s)}class Kn extends le{constructor(){const e=z(Kn.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new We(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(le.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,s){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),r=this._events.get(t),c=Math.round(Math.max(1/s,1));for(let o=0;o<=c;o++){const l=s*o+t,u=this._exponentialApproach(r.time,r.value,i,s,l);this.linearRampToValueAtTime(this._toType(u),l)}return this}setValueAtTime(e,t){const s=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(s),r=this._events.previousEvent(i),c=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(c,0),this}linearRampToValueAtTime(e,t){const s=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(s),r=this._events.previousEvent(i),c=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(c,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const s=this._fromType(e),i=this._events.get(t),r=Math.round(Math.max((t-i.time)*10,1)),c=(t-i.time)/r;for(let o=0;o<=r;o++){const l=c*o+i.time,u=this._exponentialInterpolate(i.time,i.value,t,s,l);this.linearRampToValueAtTime(this._toType(u),l)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Le(e.ticks)){const c=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(c,e.time)}const s=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const r=this._events.get(t);return r&&r.time===t&&r.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(s+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),s=this._events.get(t);return Math.max(this._getTicksUntilEvent(s,t),0)}getDurationOfTicks(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-s}getTimeOfTick(e){const t=this._events.get(e,"ticks"),s=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&s&&s.type==="linearRampToValueAtTime"&&t.value!==s.value){const i=this._fromType(this.getValueAtTime(t.time)),c=(this._fromType(this.getValueAtTime(s.time))-i)/(s.time-t.time),o=Math.sqrt(Math.pow(i,2)-2*c*(t.ticks-e)),l=(-i+o)/c,u=(-i-o)/c;return(l>0?l:u)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const s=this.toSeconds(t),i=this.toSeconds(e),r=this.getTicksAtTime(s);return this.getTicksAtTime(s+i)-r}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class ei extends Te{constructor(){const e=z(ei.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Kn({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(Te.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class ti extends Se{constructor(){const e=z(ti.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new gs,this._tickOffset=new We,this._ticksAtTime=new We,this._secondsAtTime=new We,this.frequency=new ei({context:this.context,units:e.units,value:e.frequency}),de(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Se.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const s=this.toSeconds(e);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),H(t)&&this.setTicksAtTime(t,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const s=this._state.get(t);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),s=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),r={state:"paused",time:t};this._state.add(r);let c=i||s,o=i?i.ticks:0,l=null;return this._state.forEachBetween(c.time,t+this.sampleTime,u=>{let h=c.time;const d=this._tickOffset.get(u.time);d&&d.time>=c.time&&(o=d.ticks,h=d.time),c.state==="started"&&u.state!=="started"&&(o+=this.frequency.getTicksAtTime(u.time)-this.frequency.getTicksAtTime(h),u.time!==r.time&&(l={state:u.state,time:u.time,ticks:o})),c=u}),this._state.remove(r),l&&this._ticksAtTime.add(l),o}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),s=this.frequency.timeToTicks(e,t);this.setTicksAtTime(s,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),s={state:"paused",time:e};this._state.add(s);const i=this._secondsAtTime.get(e);let r=i||t,c=i?i.seconds:0,o=null;return this._state.forEachBetween(r.time,e+this.sampleTime,l=>{let u=r.time;const h=this._tickOffset.get(l.time);h&&h.time>=r.time&&(c=h.seconds,u=h.time),r.state==="started"&&l.state!=="started"&&(c+=l.time-u,l.time!==s.time&&(o={state:l.state,time:l.time,seconds:c})),r=l}),this._state.remove(s),o&&this._secondsAtTime.add(o),c}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const s=this._tickOffset.get(t),i=this._state.get(t),r=Math.max(s.time,i.time),c=this.frequency.getTicksAtTime(r)+e-s.ticks;return this.frequency.getTimeOfTick(c)}forEachTickBetween(e,t,s){let i=this._state.get(e);this._state.forEachBetween(e,t,c=>{i&&i.state==="started"&&c.state!=="started"&&this.forEachTickBetween(Math.max(i.time,e),c.time-this.sampleTime,s),i=c});let r=null;if(i&&i.state==="started"){const c=Math.max(i.time,e),o=this.frequency.getTicksAtTime(c),l=this.frequency.getTicksAtTime(i.time),u=o-l;let h=Math.ceil(u)-u;h=Be(h,1)?0:h;let d=this.frequency.getTimeOfTick(o+h);for(;d<t;){try{s(d,Math.round(this.getTicksAtTime(d)))}catch(f){r=f;break}d+=this.frequency.getDurationOfTicks(1,d)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class en extends Se{constructor(){const e=z(en.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=ee,this._lastUpdate=0,this._state=new gs("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new ti({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,de(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Se.getDefaults(),{callback:ee,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){Ur(this.context);const s=this.toSeconds(e);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,t),s<this._lastUpdate&&this.emit("start",s,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const s=this.toSeconds(t),i=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(i+e,s)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,s=>{switch(s.state){case"started":const i=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,i);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(e,t,(s,i)=>{this.callback(s,i)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}ms.mixin(en);class Qt extends Z{constructor(){const e=z(Qt.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new ke({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,de(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(Z.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class si extends Z{constructor(){const e=z(si.getDefaults(),arguments);super(e),this.name="Destination",this.input=new Qt({context:this.context}),this.output=new ke({context:this.context}),this.volume=this.input.volume,An(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(Z.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),An(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Js(n=>{n.destination=new si({context:n})});Qs(n=>{n.destination.dispose()});class pp extends Z{constructor(){super(...arguments),this.name="Listener",this.positionX=new le({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new le({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new le({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new le({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new le({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new le({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new le({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new le({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new le({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(Z.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}Js(n=>{n.listener=new pp({context:n})});Qs(n=>{n.listener.dispose()});class ni extends at{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=z(ni.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const s=e.urls[t];this.add(t,s,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:ee,onload:ee,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return $(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,s=ee,i=ee){return it(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new re(this.baseUrl+t,s,i))):this._buffers.set(e.toString(),new re(t,s,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class Ls extends Fe{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(e){return wt(super._frequencyToUnits(e))}_ticksToUnits(e){return wt(super._ticksToUnits(e))}_beatsToUnits(e){return wt(super._beatsToUnits(e))}_secondsToUnits(e){return wt(super._secondsToUnits(e))}toMidi(){return this.valueOf()}toFrequency(){return ea(this.toMidi())}transpose(e){return new Ls(this.context,this.toMidi()+e)}}class ye extends Ft{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class mp extends Se{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new We,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Js(n=>{n.draw=new mp({context:n})});Qs(n=>{n.draw.dispose()});class fp extends at{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){$(H(e.time),"Events must have a time property"),$(H(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new gp(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const s of t)if(s.event===e){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let s,i=null;if(t>0)if(e.left.right===null)s=e.left,s.right=e.right,i=s;else{for(s=e.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,i=s.parent,s.left=e.left,s.right=e.right)}else if(e.right.left===null)s=e.right,s.left=e.left,i=s;else{for(s=e.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,i=s.parent,s.left=e.left,s.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=s:e.parent.right=s:this._setRoot(s),i&&this._rebalance(i)}e.dispose()}_rotateLeft(e){const t=e.parent,s=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,s=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),t!==null?s?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let s=t[0];for(let i=1;i<t.length;i++)t[i].low>s.low&&(s=t[i]);return s.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(s=>t.push(s)),t.forEach(s=>{s.event&&e(s.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const s=[];this._root.search(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}forEachFrom(e,t){if(this._root!==null){const s=[];this._root.searchAfter(e,s),s.forEach(i=>{i.event&&t(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class gp{constructor(e,t,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class _p extends at{constructor(e){super(),this.name="TimelineValue",this._timeline=new We({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class Bt extends Z{constructor(){super(z(Bt.getDefaults(),arguments,["context"]))}connect(e,t=0,s=0){return Qn(this,e,t,s),this}}class _s extends Bt{constructor(){const e=z(_s.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Oe(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):Ud(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(Te.getDefaults(),{length:1024})}setMap(e,t=1024){const s=new Float32Array(t);for(let i=0,r=t;i<r;i++){const c=i/(r-1)*2-1;s[i]=e(c,i)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(s=>s.includes(e));$(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class ii extends Bt{constructor(){const e=z(ii.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new _s({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(Bt.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class mt{constructor(e,t){this.id=mt._eventId++,this._remainderTime=0;const s=Object.assign(mt.getDefaults(),t);this.transport=e,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:ee,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}mt._eventId=0;class ri extends mt{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(ri.getDefaults(),t);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},mt.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return Fs(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new ye(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){Fs(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new ye(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);qt(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class tn extends Se{constructor(){const e=z(tn.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new _p(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new We,this._repeatedEvents=new fp,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new en({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),de(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Se.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const s=t%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(s*Math.PI)*this._swingAmount;e+=new ye(this.context,this._swingTicks*2/3).toSeconds()*i}Li(!0),this._timeline.forEachAtTime(t,s=>s.invoke(e)),Li(!1)}schedule(e,t){const s=new mt(this,{callback:e,time:new Ft(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(e,t,s,i=1/0){const r=new ri(this,{callback:e,duration:new Ue(this.context,i).toTicks(),interval:new Ue(this.context,t).toTicks(),time:new Ft(this.context,s).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(e,t){const s=new mt(this,{callback:e,once:!0,time:new Ft(this.context,t).toTicks()});return this._addEvent(s,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(t,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new ye(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let s;return H(t)&&(s=this.toTicks(t)),this._clock.start(e,s),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){Oe(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new Ue(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new Ue(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new ye(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new ye(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),s=this._clock.frequency.timeToTicks(e,t);this.ticks=s}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(t),i=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,t),r=t+i;this.emit("stop",r),this._clock.setTicksAtTime(e,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),s=this.getTicksAtTime(t),i=e-s%e;return this._clock.nextTickTime(i,t)}}syncSignal(e,t){const s=this.now();let i=this.bpm,r=1/(60/i.getValueAtTime(s)/this.PPQ),c=[];if(e.units==="time"){const l=.015625/r,u=new ke(l),h=new ii(-1),d=new ke(l);i.chain(u,h,d),i=d,r=1/r,c=[u,h,d]}t||(e.getValueAtTime(s)!==0?t=e.getValueAtTime(s)/r:t=0);const o=new ke(t);return i.connect(o),o.connect(e._param),c.push(o),this._syncedSignals.push({initial:e.value,nodes:c,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const s=this._syncedSignals[t];s.signal===e&&(s.nodes.forEach(i=>i.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),Hr(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}ms.mixin(tn);Js(n=>{n.transport=new tn({context:n})});Qs(n=>{n.transport.dispose()});class Ve extends Z{constructor(e){super(e),this.input=void 0,this._state=new gs("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=ee,this._syncedStop=ee,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Qt({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,de(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(Z.getDefaults(),{mute:!1,onstop:ee,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,s){let i=Le(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")$(qt(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,s);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const r=this._state.get(i);r&&(r.offset=this.toSeconds(He(t,0)),r.duration=s?this.toSeconds(s):void 0);const c=this.context.transport.schedule(o=>{this._start(o,t,s)},i);this._scheduled.push(c),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else Ur(this.context),this._start(i,t,s);return this}stop(e){let t=Le(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||H(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const s=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(s)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,s){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(qt(t,0)){const s=this._state.get(t);if(s&&s.state==="started"&&s.time!==t){const i=t-this.toSeconds(s.time);let r;s.duration&&(r=this.toSeconds(s.duration)-i),this._start(e,this.toSeconds(s.offset)+i,r)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=ee,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class sn extends Wt{constructor(){const e=z(sn.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Jt(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new le({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new re(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Wt.getDefaults(),{url:new re,loop:!1,loopEnd:0,loopStart:0,onload:ee,onerror:ee,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,s,i=1){$(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(e);this._startGain(r,i),this.loop?t=He(t,this.loopStart):t=He(t,0);let c=Math.max(this.toSeconds(t),0);if(this.loop){const o=this.toSeconds(this.loopEnd)||this.buffer.duration,l=this.toSeconds(this.loopStart),u=o-l;Cn(c,o)&&(c=(c-l)%u+l),Be(c,this.buffer.duration)&&(c=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Fs(c,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,c)),H(s)){let o=this.toSeconds(s);o=Math.max(o,0),this.stop(r+o)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function It(n,e){return _e(this,void 0,void 0,function*(){const t=e/n.context.sampleRate,s=new Hn(1,t,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/t,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class ai extends Wt{constructor(){const e=z(ai.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Jt(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new le({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new le({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),de(this,["frequency","detune"])}static getDefaults(){return Object.assign(Wt.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class ge extends Ve{constructor(){const e=z(ge.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new Te({context:this.context,units:"frequency",value:e.frequency}),de(this,"frequency"),this.detune=new Te({context:this.context,units:"cents",value:e.detune}),de(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),s=new ai({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return ge._periodicWaveCache.find(t=>t.phase===this._phase&&Kd(t.partials,this._partials));{const e=ge._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const s=this._getCachedPeriodicWave();if(H(s)){const{partials:i,wave:r}=s;this._wave=r,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,r]=this._getRealImaginary(e,this._phase),c=this.context.createPeriodicWave(i,r);this._wave=c,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),ge._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),ge._periodicWaveCache.length>100&&ge._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){pt(e,0);let t=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(t=s[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const i=new Float32Array(e);this._partials.forEach((r,c)=>i[c]=r),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(e,t){let i=2048;const r=new Float32Array(i),c=new Float32Array(i);let o=1;if(e==="custom"){if(o=this._partials.length+1,this._partialCount=this._partials.length,i=o,this._partials.length===0)return[r,c]}else{const l=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);l?(o=parseInt(l[2],10)+1,this._partialCount=parseInt(l[2],10),e=l[1],o=Math.max(o,2),i=o):this._partialCount=0,this._partials=[]}for(let l=1;l<i;++l){const u=2/(l*Math.PI);let h;switch(e){case"sine":h=l<=o?1:0,this._partials[l-1]=h;break;case"square":h=l&1?2*u:0,this._partials[l-1]=h;break;case"sawtooth":h=u*(l&1?1:-1),this._partials[l-1]=h;break;case"triangle":l&1?h=2*(u*u)*(l-1>>1&1?-1:1):h=0,this._partials[l-1]=h;break;case"custom":h=this._partials[l-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}h!==0?(r[l]=-h*Math.sin(t*l),c[l]=h*Math.cos(t*l)):(r[l]=0,c[l]=0)}return[r,c]}_inverseFFT(e,t,s){let i=0;const r=e.length;for(let c=0;c<r;c++)i+=e[c]*Math.cos(c*s)+t[c]*Math.sin(c*s);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let s=0;const i=Math.PI*2,r=32;for(let c=0;c<r;c++)s=Math.max(this._inverseFFT(e,t,c/r*i),s);return tp(-this._inverseFFT(e,t,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}ge._periodicWaveCache=[];class vp extends Bt{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new _s({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Ut extends Te{constructor(){const e=z(Ut.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new ke({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Te.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class nn extends Ve{constructor(){const e=z(nn.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new vp({context:this.context}),this._modulationNode=new ke({context:this.context}),this._carrier=new ge({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new ge({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Ut({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),de(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(ge.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class rn extends Ve{constructor(){const e=z(rn.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new ke({context:this.context,gain:0}),this._carrier=new ge({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new Te({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new ge({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Ut({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new Ut({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),de(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(ge.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class vs extends Ve{constructor(){const e=z(vs.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new ke({context:this.context,gain:0}),this._thresh=new _s({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new Te({context:this.context,units:"audioRange",value:e.width}),this._triangle=new ge({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),de(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class an extends Ve{constructor(){const e=z(an.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new Te({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Te({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,de(this,["frequency","detune"])}static getDefaults(){return Object.assign(ge.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,s=e/(this._oscillators.length-1);this._forEach((i,r)=>i.detune.value=t+s*r)}}get count(){return this._oscillators.length}set count(e){if(pt(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const s=new ge({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):ee});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[t]=s}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,s)=>t.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class on extends Ve{constructor(){const e=z(on.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Ut({context:this.context,value:2}),this._pulse=new vs({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new ge({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),de(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Vi={am:nn,fat:an,fm:rn,oscillator:ge,pulse:vs,pwm:on};class Vs extends Ve{constructor(){const e=z(Vs.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new Te({context:this.context,units:"frequency",value:e.frequency}),this.detune=new Te({context:this.context,units:"cents",value:e.detune}),de(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(ge.getDefaults(),rn.getDefaults(),nn.getDefaults(),an.getDefaults(),vs.getDefaults(),on.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=Vi[e],s=this.now();if(this._oscillator){const i=this._oscillator;i.stop(s),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof Vi[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&Je(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&Je(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&it(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return _e(this,arguments,void 0,function*(e=1024){return It(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function ta(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){pt(r,n,e),t.set(this,r)}})}}function ot(n,e=1/0){const t=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){pt(this.toSeconds(r),n,e),t.set(this,r)}})}}class cn extends Ve{constructor(){const e=z(cn.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new re({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(Ve.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:ee,onerror:ee,playbackRate:1,reverse:!1})}load(e){return _e(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=ee){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,s){return super.start(e,t,s),this}_start(e,t,s){this._loop?t=He(t,this._loopStart):t=He(t,0);const i=this.toSeconds(t),r=s;s=He(s,Math.max(this._buffer.duration-i,0));let c=this.toSeconds(s);c=c/this._playbackRate,e=this.toSeconds(e);const o=new sn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+c),this._state.setStateAtTime("stopped",e+c,{implicitEnd:!0})),this._activeSources.add(o),this._loop&&Le(r)?o.start(e,i):o.start(e,i,c-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(s=>s.stop(t))}restart(e,t,s){return super.restart(e,t,s),this}_restart(e,t,s){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(e),this._start(e,t,s)}seek(e,t){const s=this.toSeconds(t);if(this._state.getValueAtTime(s)==="started"){const i=this.toSeconds(e);this._stop(s),this._start(s,i)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&pt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&pt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),s=this._state.getNextState("stopped",t);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Xe([ot(0)],cn.prototype,"fadeIn",void 0);Xe([ot(0)],cn.prototype,"fadeOut",void 0);class yt extends Z{constructor(){const e=z(yt.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new Te({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(Z.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(it(e))return e;{let s;for(s in Ts)if(Ts[s][t]===e)return s;return e}}_setCurve(e,t,s){if(it(s)&&Reflect.has(Ts,s)){const i=Ts[s];ht(i)?e!=="_decayCurve"&&(this[e]=i[t]):this[e]=i}else if(Oe(s)&&e!=="_decayCurve")this[e]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let i=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),c=this.getValueAtTime(e);if(c>0){const o=1/i;i=(1-c)/o}if(i<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,i,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,i,e);else{this._sig.cancelAndHoldAtTime(e);let o=this._attackCurve;for(let l=1;l<o.length;l++)if(o[l-1]<=c&&c<=o[l]){o=this._attackCurve.slice(l),o[0]=c;break}this._sig.setValueCurveAtTime(o,e,i,t)}if(r&&this.sustain<1){const o=t*this.sustain,l=e+i;this.log("decay",l),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(o,r+l):this._sig.exponentialApproachValueAtTime(o,l,r)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,e):($(Oe(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,s,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,s=1){return t=this.toSeconds(t),this.triggerAttack(t,s),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,s=0){return Qn(this,e,t,s),this}asArray(){return _e(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,s=new Hn(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=i+this.toSeconds(this.release),c=r*.1,o=r+c,l=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/o,decay:t*this.toSeconds(this.decay)/o,release:t*this.toSeconds(this.release)/o,context:s}));return l._sig.toDestination(),l.triggerAttackRelease(t*(i+c)/o,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Xe([ot(0)],yt.prototype,"attack",void 0);Xe([ot(0)],yt.prototype,"decay",void 0);Xe([ta(0,1)],yt.prototype,"sustain",void 0);Xe([ot(0)],yt.prototype,"release",void 0);const Ts=(()=>{let e,t;const s=[];for(e=0;e<128;e++)s[e]=Math.sin(e/127*(Math.PI/2));const i=[],r=6.4;for(e=0;e<127;e++){t=e/127;const f=Math.sin(t*(Math.PI*2)*r-Math.PI/2)+1;i[e]=f/10+t*.83}i[127]=1;const c=[],o=5;for(e=0;e<128;e++)c[e]=Math.ceil(e/127*o)/o;const l=[];for(e=0;e<128;e++)t=e/127,l[e]=.5*(1-Math.cos(Math.PI*t));const u=[];for(e=0;e<128;e++){t=e/127;const f=Math.pow(t,3)*4+.2,p=Math.cos(f*Math.PI*2*t);u[e]=Math.abs(p*(1-t))}function h(f){const p=new Array(f.length);for(let m=0;m<f.length;m++)p[m]=1-f[m];return p}function d(f){return f.slice(0).reverse()}return{bounce:{In:h(u),Out:u},cosine:{In:s,Out:d(s)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:h(i)},sine:{In:l,Out:h(l)},step:{In:c,Out:h(c)}}})();class ft extends Z{constructor(){const e=z(ft.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new Qt({context:this.context,volume:e.volume}),this.volume=this._volume.volume,de(this,"volume")}static getDefaults(){return Object.assign(Z.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const s=this["_original_"+e]=this[e];this[e]=(...i)=>{const r=i[t],c=this.context.transport.schedule(o=>{i[t]=o,s.apply(this,i)},r);this._scheduledEvents.push(c)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,s,i){const r=this.toSeconds(s),c=this.toSeconds(t);return this.triggerAttack(e,r,i),this.triggerRelease(r+c),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class At extends ft{constructor(){const e=z(At.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(ft.getDefaults(),{detune:0,onsilence:ee,portamento:0})}triggerAttack(e,t,s=1){this.log("triggerAttack",e,t,s);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,s),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const s=this.toSeconds(t),i=e instanceof Fe?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,r,s)}else this.frequency.setValueAtTime(i,s);return this}}Xe([ot(0)],At.prototype,"portamento",void 0);class oi extends yt{constructor(){super(z(oi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new ke({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Gt extends At{constructor(){const e=z(Gt.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new Vs(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new oi(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),de(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(At.getDefaults(),{envelope:Object.assign(kn(yt.getDefaults(),Object.keys(Z.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(kn(Vs.getDefaults(),[...Object.keys(Ve.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+s+i)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class ln extends Gt{constructor(){const e=z(ln.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,de(this,["oscillator","envelope"])}static getDefaults(){return Tt(At.getDefaults(),Gt.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const s=this.toSeconds(t),i=this.toFrequency(e instanceof Fe?e.toFrequency():e),r=i*this.octaves;return this.oscillator.frequency.setValueAtTime(r,s),this.oscillator.frequency.exponentialRampToValueAtTime(i,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Xe([ta(0)],ln.prototype,"octaves",void 0);Xe([ot(0)],ln.prototype,"pitchDecay",void 0);const sa=new Set;function ci(n){sa.add(n)}function na(n,e){const t=`registerProcessor("${n}", ${e})`;sa.add(t)}const yp=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;ci(yp);const bp=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;ci(bp);const xp=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;ci(xp);const wp="feedback-comb-filter",Tp=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;na(wp,Tp);class li extends ft{constructor(){const e=z(li.getDefaults(),arguments,["voice","options"]);super(e),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=i=>this.releaseAll(i),$(!Je(e.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const t=e.voice.getDefaults();this.options=Object.assign(t,e.options),this.voice=e.voice,this.maxPolyphony=e.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(ft.getDefaults(),{maxPolyphony:32,options:{},voice:Gt})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(e){this._availableVoices.push(e);const t=this._activeVoices.findIndex(s=>s.voice===e);this._activeVoices.splice(t,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const e=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return $(e instanceof At,"Voice must extend Monophonic class"),e.connect(this.output),this._voices.push(e),e}else Zs("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const e=this._availableVoices.shift(),t=this._voices.indexOf(e);this._voices.splice(t,1),this.context.isOffline||e.dispose()}}_triggerAttack(e,t,s){e.forEach(i=>{const r=new Ls(this.context,i).toMidi(),c=this._getNextAvailableVoice();c&&(c.triggerAttack(i,t,s),this._activeVoices.push({midi:r,voice:c,released:!1}),this.log("triggerAttack",i,t))})}_triggerRelease(e,t){e.forEach(s=>{const i=new Ls(this.context,s).toMidi(),r=this._activeVoices.find(({midi:c,released:o})=>c===i&&!o);r&&(r.voice.triggerRelease(t),r.released=!0,this.log("triggerRelease",s,t))})}_scheduleEvent(e,t,s,i){$(!this.disposed,"Synth was already disposed"),s<=this.now()?e==="attack"?this._triggerAttack(t,s,i):this._triggerRelease(t,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(e,t,s,i)},s-this.now())}triggerAttack(e,t,s){Array.isArray(e)||(e=[e]);const i=this.toSeconds(t);return this._scheduleEvent("attack",e,i,s),this}triggerRelease(e,t){Array.isArray(e)||(e=[e]);const s=this.toSeconds(t);return this._scheduleEvent("release",e,s),this}triggerAttackRelease(e,t,s,i){const r=this.toSeconds(s);if(this.triggerAttack(e,r,i),Oe(t)){$(Oe(e),"If the duration is an array, the notes must also be an array"),e=e;for(let c=0;c<e.length;c++){const o=t[Math.min(c,t.length-1)],l=this.toSeconds(o);$(l>0,"The duration must be greater than 0"),this.triggerRelease(e[c],r+l)}}else{const c=this.toSeconds(t);$(c>0,"The duration must be greater than 0"),this.triggerRelease(e,r+c)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(e){const t=kn(e,["onsilence","context"]);return this.options=Tt(this.options,t),this._voices.forEach(s=>s.set(t)),this._dummyVoice.set(t),this}get(){return this._dummyVoice.get()}releaseAll(e){const t=this.toSeconds(e);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(t)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(e=>e.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class un extends ft{constructor(){const e=z(un.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(s=>{const i=parseInt(s,10);if($(ws(s)||Je(i)&&isFinite(i),`url key is neither a note or midi pitch: ${s}`),ws(s)){const r=new Fe(this.context,s).toMidi();t[r]=e.urls[s]}else Je(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new ni({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(ft.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:ee,onerror:ee,release:.1,urls:{}})}_findClosest(e){let s=0;for(;s<96;){if(this._buffers.has(e+s))return-s;if(this._buffers.has(e-s))return s;s++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,s=1){return this.log("triggerAttack",e,t,s),Array.isArray(e)||(e=[e]),e.forEach(i=>{const r=Kr(new Fe(this.context,i).toFrequency()),c=Math.round(r),o=r-c,l=this._findClosest(c),u=c-l,h=this._buffers.get(u),d=Qr(l+o),f=new sn({url:h,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:d}).connect(this.output);f.start(t,0,h.duration/d,s),Oe(this._activeSources.get(c))||this._activeSources.set(c,[]),this._activeSources.get(c).push(f),f.onended=()=>{if(this._activeSources&&this._activeSources.has(c)){const p=this._activeSources.get(c),m=p.indexOf(f);m!==-1&&p.splice(m,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(s=>{const i=new Fe(this.context,s).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const r=this._activeSources.get(i);t=this.toSeconds(t),r.forEach(c=>{c.stop(t)}),this._activeSources.set(i,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,s,i=1){const r=this.toSeconds(s);return this.triggerAttack(e,r,i),Oe(t)?($(Oe(e),"notes must be an array when duration is array"),e.forEach((c,o)=>{const l=t[Math.min(o,t.length-1)];this.triggerRelease(c,r+this.toSeconds(l))})):this.triggerRelease(e,r+this.toSeconds(t)),this}add(e,t,s){if($(ws(e)||isFinite(e),`note must be a pitch or midi: ${e}`),ws(e)){const i=new Fe(this.context,e).toMidi();this._buffers.add(i,t,s)}else this._buffers.add(e,t,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}Xe([ot(0)],un.prototype,"attack",void 0);Xe([ot(0)],un.prototype,"release",void 0);class Dt extends Se{constructor(){const e=z(Dt.getDefaults(),arguments,["callback","value"]);super(e),this.name="ToneEvent",this._state=new gs("stopped"),this._startOffset=0,this._loop=e.loop,this.callback=e.callback,this.value=e.value,this._loopStart=this.toTicks(e.loopStart),this._loopEnd=this.toTicks(e.loopEnd),this._playbackRate=e.playbackRate,this._probability=e.probability,this._humanize=e.humanize,this.mute=e.mute,this._playbackRate=e.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Se.getDefaults(),{callback:ee,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(e=-1){this._state.forEachFrom(e,t=>{let s;if(t.state==="started"){t.id!==-1&&this.context.transport.clear(t.id);const i=t.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||Je(this._loop)&&this._loop>1){s=1/0,Je(this._loop)&&(s=this._loop*this._getLoopDuration());const r=this._state.getAfter(i);r!==null&&(s=Math.min(s,r.time-i)),s!==1/0&&(s=new ye(this.context,s));const c=new ye(this.context,this._getLoopDuration());t.id=this.context.transport.scheduleRepeat(this._tick.bind(this),c,new ye(this.context,i),s)}else t.id=this.context.transport.schedule(this._tick.bind(this),new ye(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e}get probability(){return this._probability}set probability(e){this._probability=e}get humanize(){return this._humanize}set humanize(e){this._humanize=e}start(e){const t=this.toTicks(e);return this._state.getValueAtTime(t)==="stopped"&&(this._state.add({id:-1,state:"started",time:t}),this._rescheduleEvents(t)),this}stop(e){this.cancel(e);const t=this.toTicks(e);if(this._state.getValueAtTime(t)==="started"){this._state.setStateAtTime("stopped",t,{id:-1});const s=this._state.getBefore(t);let i=t;s!==null&&(i=s.time),this._rescheduleEvents(i)}return this}cancel(e){e=He(e,-1/0);const t=this.toTicks(e);return this._state.forEachFrom(t,s=>{this.context.transport.clear(s.id)}),this._state.cancel(t),this}_tick(e){const t=this.context.transport.getTicksAtTime(e);if(!this.mute&&this._state.getValueAtTime(t)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let s=.02;Br(this.humanize)||(s=this.toSeconds(this.humanize)),e+=(Math.random()*2-1)*s}this.callback(e,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(e){this._loop=e,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._rescheduleEvents()}get loopEnd(){return new ye(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._rescheduleEvents()}get loopStart(){return new ye(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const e=this.context.transport.ticks,t=this._state.get(e);if(t!==null&&t.state==="started"){const s=this._getLoopDuration();return(e-t.time)%s/s}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class qs extends Dt{constructor(){const e=z(qs.getDefaults(),arguments,["callback","events"]);super(e),this.name="Part",this._state=new gs("stopped"),this._events=new Set,this._state.increasing=!0,e.events.forEach(t=>{Oe(t)?this.add(t[0],t[1]):this.add(t)})}static getDefaults(){return Object.assign(Dt.getDefaults(),{events:[]})}start(e,t){const s=this.toTicks(e);if(this._state.getValueAtTime(s)!=="started"){t=He(t,this._loop?this._loopStart:0),this._loop?t=He(t,this._loopStart):t=He(t,0);const i=this.toTicks(t);this._state.add({id:-1,offset:i,state:"started",time:s}),this._forEach(r=>{this._startNote(r,s,i)})}return this}_startNote(e,t,s){t-=s,this._loop?e.startOffset>=this._loopStart&&e.startOffset<this._loopEnd?(e.startOffset<s&&(t+=this._getLoopDuration()),e.start(new ye(this.context,t))):e.startOffset<this._loopStart&&e.startOffset>=s&&(e.loop=!1,e.start(new ye(this.context,t))):e.startOffset>=s&&e.start(new ye(this.context,t))}get startOffset(){return this._startOffset}set startOffset(e){this._startOffset=e,this._forEach(t=>{t.startOffset+=this._startOffset})}stop(e){const t=this.toTicks(e);return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._forEach(s=>{s.stop(e)}),this}at(e,t){const s=new Ft(this.context,e).toTicks(),i=new ye(this.context,1).toSeconds(),r=this._events.values();let c=r.next();for(;!c.done;){const o=c.value;if(Math.abs(s-o.startOffset)<i)return H(t)&&(o.value=t),o;c=r.next()}return H(t)?(this.add(e,t),this.at(e)):null}add(e,t){e instanceof Object&&Reflect.has(e,"time")&&(t=e,e=t.time);const s=this.toTicks(e);let i;return t instanceof Dt?(i=t,i.callback=this._tick.bind(this)):i=new Dt({callback:this._tick.bind(this),context:this.context,value:t}),i.startOffset=s,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(e){this._state.forEach(t=>{t.state==="started"?this._startNote(e,t.time,t.offset):e.stop(new ye(this.context,t.time))})}remove(e,t){return ht(e)&&e.hasOwnProperty("time")&&(t=e,e=t.time),e=this.toTicks(e),this._events.forEach(s=>{s.startOffset===e&&(Le(t)||H(t)&&s.value===t)&&(this._events.delete(s),s.dispose())}),this}clear(){return this._forEach(e=>e.dispose()),this._events.clear(),this}cancel(e){return this._forEach(t=>t.cancel(e)),this._state.cancel(this.toTicks(e)),this}_forEach(e){return this._events&&this._events.forEach(t=>{t instanceof qs?t._forEach(e):e(t)}),this}_setAll(e,t){this._forEach(s=>{s[e]=t})}_tick(e,t){this.mute||this.callback(e,t)}_testLoopBoundries(e){this._loop&&(e.startOffset<this._loopStart||e.startOffset>=this._loopEnd)?e.cancel(0):e.state==="stopped"&&this._restartEvent(e)}get probability(){return this._probability}set probability(e){this._probability=e,this._setAll("probability",e)}get humanize(){return this._humanize}set humanize(e){this._humanize=e,this._setAll("humanize",e)}get loop(){return this._loop}set loop(e){this._loop=e,this._forEach(t=>{t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.loop=e,this._testLoopBoundries(t)})}get loopEnd(){return new ye(this.context,this._loopEnd).toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopEnd=e,this._testLoopBoundries(t)})}get loopStart(){return new ye(this.context,this._loopStart).toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e),this._loop&&this._forEach(t=>{t.loopStart=this.loopStart,this._testLoopBoundries(t)})}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._setAll("playbackRate",e)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class ui extends Z{constructor(){const e=z(ui.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new le({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",de(this,"pan")}static getDefaults(){return Object.assign(Z.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const Np="bit-crusher",Sp=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;na(Np,Sp);class fe extends Z{constructor(){const e=z(fe.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new ke({context:this.context}),fe._allSolos.has(this.context)||fe._allSolos.set(this.context,new Set),fe._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(Z.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),fe._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){fe._soloed.has(this.context)||fe._soloed.set(this.context,new Set),fe._soloed.get(this.context).add(this)}_removeSolo(){fe._soloed.has(this.context)&&fe._soloed.get(this.context).delete(this)}_isSoloed(){return fe._soloed.has(this.context)&&fe._soloed.get(this.context).has(this)}_noSolos(){return!fe._soloed.has(this.context)||fe._soloed.has(this.context)&&fe._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),fe._allSolos.get(this.context).delete(this),this._removeSolo(),this}}fe._allSolos=new Map;fe._soloed=new Map;class hi extends Z{constructor(){const e=z(hi.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new ui({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Qt({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,de(this,["pan","volume"])}static getDefaults(){return Object.assign(Z.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Pt extends Z{constructor(){const e=z(Pt.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new fe({solo:e.solo,context:this.context}),this._panVol=this.output=new hi({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),de(this,["pan","volume"])}static getDefaults(){return Object.assign(Z.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return Pt.buses.has(e)||Pt.buses.set(e,new ke({context:this.context})),Pt.buses.get(e)}send(e,t=0){const s=this._getBus(e),i=new ke({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(s),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Pt.buses=new Map;Pe().transport;function tt(){return Pe().transport}Pe().destination;Pe().destination;function kp(){return Pe().destination}Pe().listener;Pe().draw;const Cp=Pe();class Ap{constructor(e={}){Ye(this,"synth",null);Ye(this,"part",null);Ye(this,"isPlaying",!1);Ye(this,"isPaused",!1);Ye(this,"duration",0);Ye(this,"options");Ye(this,"progressInterval",null);this.options=e}async loadMIDI(e){try{const t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);const i=this.parseMIDIToNotes(s);this.synth||(this.synth=new li(Gt,{oscillator:{type:"sine"},envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination()),this.part=new qs((r,c)=>{this.synth?.triggerAttackRelease(c.name,c.duration,r,c.velocity)},i),this.duration=this.calculateDuration(i),this.part.loop=!1}catch(t){const s=t instanceof Error?t:new Error("Failed to load MIDI");throw this.options.onError?.(s),s}}parseMIDIToNotes(e){const t=[],s=["C4","D4","E4","F4","G4","A4","B4","C5"];let i=0;for(let r=0;r<16;r++)t.push({time:`${i}`,name:s[r%s.length],duration:"4n",velocity:.7}),i+=.5;return t}calculateDuration(e){if(e.length===0)return 0;const t=e[e.length-1],s=parseFloat(t.time),r={"1n":2,"2n":1,"4n":.5,"8n":.25,"16n":.125}[t.duration]||.5;return s+r}async play(){if(!this.part||!this.synth)throw new Error("No MIDI loaded");await Jr(),this.isPaused?(tt().start(),this.isPaused=!1):(this.part.start(0),tt().start()),this.isPlaying=!0,this.startProgressTracking(),tt().schedule(()=>{this.stop(),this.options.onEnd?.()},`+${this.duration}`)}pause(){this.isPlaying&&(tt().pause(),this.isPlaying=!1,this.isPaused=!0,this.stopProgressTracking())}stop(){tt().stop(),tt().cancel(),this.part?.stop(),this.isPlaying=!1,this.isPaused=!1,this.stopProgressTracking()}seek(e){const t=Math.max(0,Math.min(e,this.duration));tt().seconds=t}getState(){return{isPlaying:this.isPlaying,isPaused:this.isPaused,currentTime:tt().seconds,duration:this.duration}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=window.setInterval(()=>{const e=tt().seconds;this.options.onProgress?.(e,this.duration)},100)}stopProgressTracking(){this.progressInterval!==null&&(clearInterval(this.progressInterval),this.progressInterval=null)}dispose(){this.stop(),this.part?.dispose(),this.synth?.dispose(),this.part=null,this.synth=null}}let fn=null;function jp(){return fn||(fn=new Ap),fn}const ia=({isPlaying:n,canPrevious:e,canNext:t,shuffle:s,repeat:i,onPlayPause:r,onPrevious:c,onNext:o,onShuffle:l,onRepeat:u,expanded:h=!1})=>{const d=()=>a.jsx("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:a.jsx("polygon",{points:"8,6 8,18 18,12"})}),f=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("rect",{x:"7",y:"6",width:"4",height:"12",rx:"1"}),a.jsx("rect",{x:"13",y:"6",width:"4",height:"12",rx:"1"})]}),p=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("rect",{x:"6",y:"6",width:"2",height:"12",rx:"1"}),a.jsx("polygon",{points:"18,6 10,12 18,18"})]}),m=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("polygon",{points:"6,6 14,12 6,18"}),a.jsx("rect",{x:"16",y:"6",width:"2",height:"12",rx:"1"})]}),g=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("path",{d:"M4 7h6l4 4 2-2 4 4"}),a.jsx("path",{d:"M4 17h6l4-4 2 2 4-4"})]}),_=()=>a.jsxs("svg",{viewBox:"0 0 24 24",className:"control-icon-svg","aria-hidden":"true",children:[a.jsx("path",{d:"M7 7h10v4"}),a.jsx("path",{d:"M17 17H7v-4"}),a.jsx("path",{d:"M17 7l3 3-3 3"}),a.jsx("path",{d:"M7 17l-3-3 3-3"})]});return a.jsxs("div",{className:`playback-controls ${h?"expanded":""}`,children:[h&&a.jsx("button",{className:`control-button secondary ${s?"active":""}`,onClick:l,"aria-label":"Shuffle",title:"Shuffle",children:a.jsx(g,{})}),a.jsx("button",{className:"control-button",onClick:c,disabled:!e,"aria-label":"Previous",title:"Previous track",children:a.jsx(p,{})}),a.jsx("button",{className:"control-button primary",onClick:r,"aria-label":n?"Pause":"Play",title:n?"Pause":"Play",children:n?a.jsx(f,{}):a.jsx(d,{})}),a.jsx("button",{className:"control-button",onClick:o,disabled:!t,"aria-label":"Next",title:"Next track",children:a.jsx(m,{})}),h&&a.jsxs("button",{className:`control-button secondary ${i!=="off"?"active":""}`,onClick:u,"aria-label":`Repeat: ${i}`,title:`Repeat: ${i}`,children:[a.jsx(_,{}),i==="one"&&a.jsx("span",{className:"repeat-indicator",children:"1"})]})]})},ra=({currentTime:n,duration:e,onSeek:t,color:s="#D4AF37"})=>{const[i,r]=T.useState(!1),c=T.useRef(null),o=p=>{if(!isFinite(p)||p<0)return"0:00";const m=Math.floor(p/60),g=Math.floor(p%60);return`${m}:${g.toString().padStart(2,"0")}`},l=p=>{if(!c.current||e===0)return;const m=c.current.getBoundingClientRect(),g=p-m.left,y=Math.max(0,Math.min(1,g/m.width))*e;t(y)},u=p=>{r(!0),l(p.clientX)},h=p=>{i&&l(p.clientX)},d=()=>{r(!1)};K.useEffect(()=>{if(i)return document.addEventListener("mousemove",h),document.addEventListener("mouseup",d),()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",d)}},[i]);const f=e>0?n/e*100:0;return a.jsxs("div",{className:"seek-bar-container",children:[a.jsx("span",{className:"seek-time current",children:o(n)}),a.jsx("div",{ref:c,className:"seek-track",onMouseDown:u,role:"slider","aria-label":"Seek","aria-valuemin":0,"aria-valuemax":e,"aria-valuenow":n,children:a.jsx("div",{className:"seek-progress",style:{width:`${f}%`,background:`linear-gradient(90deg, ${s}cc, ${s})`},children:a.jsx("div",{className:"seek-thumb"})})}),a.jsx("span",{className:"seek-time total",children:o(e)})]})},aa=({volume:n,isMuted:e,onVolumeChange:t,onMuteToggle:s,expanded:i=!1})=>{const[r,c]=T.useState(!1),o=T.useRef(null),l=e||n===0?"muted":n<.5?"low":"high",u=m=>{if(!o.current)return;const g=o.current.getBoundingClientRect(),_=m-g.left,y=Math.max(0,Math.min(1,_/g.width));t(y)},h=m=>{c(!0),u(m.clientX)},d=m=>{r&&u(m.clientX)},f=()=>{c(!1)};K.useEffect(()=>{if(r)return document.addEventListener("mousemove",d),document.addEventListener("mouseup",f),()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",f)}},[r]);const p=e?0:n;return a.jsxs("div",{className:`volume-control ${i?"expanded":""}`,children:[a.jsxs("button",{className:`volume-icon ${l}`,onClick:s,"aria-label":e?"Unmute":"Mute",title:e?"Unmute":"Mute",children:[a.jsx("span",{className:"volume-core"}),a.jsx("span",{className:"volume-wave wave-1"}),a.jsx("span",{className:"volume-wave wave-2"})]}),a.jsx("div",{ref:o,className:"volume-slider",onMouseDown:h,role:"slider","aria-label":"Volume","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(p*100),children:a.jsx("div",{className:"volume-fill",style:{width:`${p*100}%`},children:a.jsx("div",{className:"volume-thumb"})})})]})};class Mp{static draw(e,t,s,i,r,c){const o=this.smoothData(t);this.drawGrid(e,s,i),e.lineWidth=3,e.strokeStyle=this.getGradient(e,r,s),e.shadowBlur=c?8:4,e.shadowColor=r,e.beginPath();const l=s/o.length;let u=0;for(let h=0;h<o.length;h++){const f=o[h]/128*i/2;if(h===0)e.moveTo(u,f);else{const p=(u+l*h)/2,m=(f+o[h-1]/128*i/2)/2;e.quadraticCurveTo(u,o[h-1]/128*i/2,p,m)}u=l*h}e.lineTo(s,i/2),e.stroke(),e.save(),e.scale(1,-1),e.translate(0,-i),e.stroke(),e.restore(),e.shadowBlur=0}static smoothData(e){const t=[];for(let i=0;i<e.length;i++){let r=0,c=0;for(let o=-3;o<=3;o++){const l=i+o;l>=0&&l<e.length&&(r+=e[l],c++)}t.push(r/c)}return t}static drawGrid(e,t,s){e.strokeStyle="rgba(0, 0, 0, 0.05)",e.lineWidth=1;const i=5;for(let r=0;r<i;r++){const c=s/(i-1)*r;e.beginPath(),e.moveTo(0,c),e.lineTo(t,c),e.stroke()}}static getGradient(e,t,s){const i=e.createLinearGradient(0,0,s,0);return i.addColorStop(0,t),i.addColorStop(.5,this.lightenColor(t,20)),i.addColorStop(1,t),i}static lightenColor(e,t){const s=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+i),c=Math.min(255,(s>>8&255)+i),o=Math.min(255,(s&255)+i);return`#${(r<<16|c<<8|o).toString(16).padStart(6,"0")}`}}class oa{static draw(e,t,s,i,r,c){const d=(s-640)/2,f=Math.floor(t.length/64),p=[];for(let _=0;_<64;_++){let y=0;for(let N=0;N<f;N++){const A=_*f+N;A<t.length&&(y+=t[A])}const w=y/f;p.push(w)}const m=this.smoothTransitions(p),g=this.createBarGradient(e,r,64,10,d);for(let _=0;_<64;_++){const y=d+_*10,w=m[_]/255*(i*.4);e.fillStyle=g,this.drawRoundedBar(e,y,i/2-w,8,w,4),c&&(e.save(),e.globalAlpha=.3,this.drawRoundedBar(e,y,i/2+2,8,w*.5,4),e.restore()),e.shadowBlur=c?4:0,e.shadowColor=r}e.shadowBlur=0,c&&this.drawParticles(e,m,d,10,i,r)}static smoothTransitions(e){if(this.previousHeights.length===0)return this.previousHeights=[...e],e;const t=[],s=.7;for(let i=0;i<e.length;i++){const r=this.previousHeights[i]||0,c=e[i],o=r*s+c*(1-s);t.push(o)}return this.previousHeights=t,t}static drawRoundedBar(e,t,s,i,r,c){e.beginPath(),e.moveTo(t,s+r),e.lineTo(t,s+c),e.arcTo(t,s,t+i,s,c),e.lineTo(t+i,s+c),e.arcTo(t+i,s,t+i,s+r,c),e.lineTo(t+i,s+r),e.closePath(),e.fill()}static createBarGradient(e,t,s,i,r){const c=e.createLinearGradient(r,0,r+s*i,0);return c.addColorStop(0,t),c.addColorStop(.5,this.adjustHue(t,30)),c.addColorStop(1,this.adjustHue(t,60)),c}static drawParticles(e,t,s,i,r,c){for(let l=0;l<t.length;l++)if(t[l]>200){const u=s+l*i+i/2,h=t[l]/255*(r*.4),d=r/2-h-10;e.fillStyle=c,e.globalAlpha=.5,e.beginPath(),e.arc(u,d,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}}static adjustHue(e,t){const s=parseInt(e.replace("#",""),16),i=s>>16&255,r=s>>8&255,c=s&255,o=1+t/360,l=Math.min(255,i*o),u=Math.min(255,r*o),h=Math.min(255,c*o);return`#${(Math.floor(l)<<16|Math.floor(u)<<8|Math.floor(h)).toString(16).padStart(6,"0")}`}}Ye(oa,"previousHeights",[]);class ca{static draw(e,t,s,i,r,c){const o=s/2,l=i/2,u=Math.min(s,i)*.15,h=Math.min(s,i)*.45;c&&(this.rotation+=360/(60*60));const d=Math.min(t.length,180),f=Math.PI*2/d;for(let p=0;p<d;p++){const m=t[Math.floor(p*(t.length/d))],g=m/255*(h-u),_=p*f+this.rotation*(Math.PI/180),y=o+Math.cos(_)*u,w=l+Math.sin(_)*u,N=o+Math.cos(_)*(u+g),A=l+Math.sin(_)*(u+g),b=p/d*360;if(e.strokeStyle=`hsla(${b}, 70%, 60%, 0.8)`,e.lineWidth=2,e.beginPath(),e.moveTo(y,w),e.lineTo(N,A),e.stroke(),c&&m>200){const S=o+Math.cos(_)*(u+g+5),C=l+Math.sin(_)*(u+g+5);e.fillStyle=`hsla(${b}, 70%, 60%, 0.6)`,e.beginPath(),e.arc(S,C,2,0,Math.PI*2),e.fill()}}if(e.strokeStyle=r,e.lineWidth=2,e.beginPath(),e.arc(o,l,u,0,Math.PI*2),e.stroke(),c){const p=this.getAverageAmplitude(t),m=h+p/255*10;e.save(),e.globalAlpha=.3,e.strokeStyle=r,e.lineWidth=3,e.shadowBlur=20,e.shadowColor=r,e.beginPath(),e.arc(o,l,m,0,Math.PI*2),e.stroke(),e.restore()}}static getAverageAmplitude(e){let t=0;for(let s=0;s<e.length;s++)t+=e[s];return t/e.length}}Ye(ca,"rotation",0);const la=({mode:n,frequencyData:e,timeDomainData:t,isPlaying:s,dominantColor:i="#D4AF37",width:r=800,height:c=200,mini:o=!1})=>{const l=T.useRef(null),u=T.useRef(null),h=T.useRef(0);return T.useEffect(()=>{const d=l.current;if(!d)return;const f=d.getContext("2d");if(!f)return;const p=o?1:Math.min(window.devicePixelRatio||1,2);d.width=r*p,d.height=c*p,d.style.width=`${r}px`,d.style.height=`${c}px`,f.scale(p,p);const g=1e3/(o?30:60),_=y=>{if(y-h.current<g){u.current=requestAnimationFrame(_);return}h.current=y,f.clearRect(0,0,r,c),n==="waveform"&&t?Mp.draw(f,t,r,c,i,s):n==="spectrum"&&e?oa.draw(f,e,r,c,i,s):n==="radial"&&e&&ca.draw(f,e,r,c,i,s),u.current=requestAnimationFrame(_)};return u.current=requestAnimationFrame(_),()=>{u.current!==null&&cancelAnimationFrame(u.current)}},[n,e,t,s,i,r,c,o]),a.jsx("canvas",{ref:l,style:{display:"block",margin:"0 auto",borderRadius:o?"4px":"8px"}})},Ep=({album:n,isPlaying:e,currentTime:t,duration:s,volume:i,isMuted:r,canPrevious:c,canNext:o,frequencyData:l,timeDomainData:u,onPlayPause:h,onPrevious:d,onNext:f,onSeek:p,onVolumeChange:m,onMuteToggle:g,onExpand:_})=>{const y=n?`${n.title||n.mood} - ${n.musicMetadata?.key||"Classical"} ${n.musicMetadata?.tempo||""}BPM`:"No track playing",w=!!n;return a.jsx("div",{className:`mini-player-bar ${w?"has-track":"empty"}`,children:a.jsxs("div",{className:"mini-player-bar-content",children:[n&&a.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"mini-player-thumbnail"}),a.jsxs("div",{className:"mini-player-info-section",children:[a.jsx("div",{className:"mini-player-track-title",children:y}),n?.musicMetadata&&a.jsxs("div",{className:"mini-player-track-meta",children:[n.musicMetadata.form," - ",n.musicMetadata.character]})]}),a.jsxs("div",{className:"mini-player-controls-section",children:[a.jsx(ia,{isPlaying:e,canPrevious:c,canNext:o,shuffle:!1,repeat:"off",onPlayPause:h,onPrevious:d,onNext:f,onShuffle:()=>{},onRepeat:()=>{}}),a.jsx(ra,{currentTime:t,duration:s,onSeek:p})]}),a.jsx("div",{className:"mini-player-volume-section",children:a.jsx(aa,{volume:i,isMuted:r,onVolumeChange:m,onMuteToggle:g})}),a.jsx("div",{className:"mini-player-visualization-section",children:a.jsx(la,{mode:"waveform",frequencyData:l,timeDomainData:u,isPlaying:e,width:100,height:40,mini:!0})}),a.jsx("button",{className:"mini-player-expand-button",onClick:_,"aria-label":"Expand player",title:"Expand player",children:"⌃"})]})})},Ip=({queue:n,currentIndex:e,onSkipTo:t})=>{const s=n.slice(e+1,e+4);if(s.length===0)return null;const i=r=>{const c=Math.floor(r/60),o=Math.floor(r%60);return`${c}:${o.toString().padStart(2,"0")}`};return a.jsxs("div",{className:"queue-preview",children:[a.jsx("div",{className:"queue-label",children:"Up Next"}),a.jsx("div",{className:"queue-items",children:s.map((r,c)=>a.jsx("div",{className:"queue-item",onClick:()=>t(e+c+1),role:"button",tabIndex:0,onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),t(e+c+1))},children:a.jsx(St,{variant:"compact",className:"queue-album-card",title:r.title||r.mood,mood:r.mood,imageUrl:r.imageDataURL,meta:i(r.musicMetadata?.duration||r.duration),badges:[...r.musicData?[{label:"再生",tone:"success"}]:[],...r.isFavorite?[{label:"お気に入り",tone:"warning"}]:[],...r.isPublic?[{label:"公開",tone:"info"}]:[]]})},r.id))})]})},Op=({tags:n,centerX:e,centerY:t,isPlaying:s})=>{const[i,r]=T.useState([]),c=T.useRef(null),o=T.useRef(Date.now());T.useEffect(()=>{const u=[220,260,300,340,380],h=[12,10,8,6,4],d=n.map((p,m)=>360/n.length*m),f=n.slice(0,5).map((p,m)=>({text:p,radius:u[m]||300,speed:h[m]||8,angle:d[m]||0,scale:1,opacity:.6}));r(f)},[n]),T.useEffect(()=>{if(!s){c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}const u=()=>{const h=Date.now(),d=(h-o.current)/1e3;o.current=h,r(f=>f.map((p,m)=>{let g=p.angle+p.speed*d;g=g%360;const _=m*.5,w=1+Math.sin((h/3e3+_)*Math.PI*2)*.05,N=.55+Math.sin((h/3e3+_)*Math.PI*2)*.15;return{...p,angle:g,scale:w,opacity:N}})),c.current=requestAnimationFrame(u)};return c.current=requestAnimationFrame(u),()=>{c.current!==null&&cancelAnimationFrame(c.current)}},[s]);const l=u=>u*Math.PI/180;return a.jsx("div",{className:"motif-orbit",children:i.map((u,h)=>{const d=e+u.radius*Math.cos(l(u.angle)),f=t+u.radius*Math.sin(l(u.angle));return a.jsx("div",{className:"motif-tag",style:{left:`${d}px`,top:`${f}px`,transform:`translate(-50%, -50%) scale(${u.scale})`,opacity:u.opacity},children:u.text},`${u.text}-${h}`)})})},Rp=({album:n,isPlaying:e,currentTime:t,duration:s,volume:i,isMuted:r,shuffle:c,repeat:o,canPrevious:l,canNext:u,visualizationMode:h,queue:d,queueIndex:f,frequencyData:p,timeDomainData:m,onPlayPause:g,onPrevious:_,onNext:y,onSeek:w,onVolumeChange:N,onMuteToggle:A,onShuffle:b,onRepeat:S,onVisualizationModeChange:C,onSkipToIndex:v,onClose:k})=>{T.useEffect(()=>{const M=O=>{O.key==="Escape"?k():O.key===" "&&O.target===document.body?(O.preventDefault(),g()):O.key==="ArrowLeft"?w(Math.max(0,t-5)):O.key==="ArrowRight"?w(Math.min(s,t+5)):O.key==="ArrowUp"?N(Math.min(1,i+.1)):O.key==="ArrowDown"?N(Math.max(0,i-.1)):O.key==="m"||O.key==="M"?A():O.key==="n"||O.key==="N"?y():(O.key==="p"||O.key==="P")&&_()};return document.addEventListener("keydown",M),()=>document.removeEventListener("keydown",M)},[t,s,i,k,g,w,N,A,y,_]);const x="#D4AF37",j=n?.metadata?.motif_tags||[];return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"expanded-player-backdrop",onClick:k}),a.jsxs("div",{className:"expanded-player-modal",role:"dialog","aria-modal":"true",children:[a.jsx("button",{className:"expanded-player-close",onClick:k,"aria-label":"Close player",title:"Close (Esc)",children:"X"}),a.jsx("button",{className:"expanded-player-minimize",onClick:k,"aria-label":"Minimize player",title:"Minimize",children:"-"}),a.jsxs("div",{className:"expanded-player-content",children:[a.jsxs("div",{className:"expanded-player-album-section",children:[a.jsx("div",{className:"expanded-player-album-container",children:n&&a.jsxs(a.Fragment,{children:[a.jsx("img",{src:n.imageDataURL,alt:n.title||n.mood,className:"expanded-player-album-image"}),j.length>0&&a.jsx(Op,{tags:j,centerX:200,centerY:200,isPlaying:e})]})}),n&&a.jsxs("div",{className:"expanded-player-album-meta",children:[a.jsx("h2",{className:"expanded-player-album-title",children:n.title||n.mood}),n.musicMetadata&&a.jsxs("p",{className:"expanded-player-album-details",children:[n.musicMetadata.key," • ",n.musicMetadata.tempo," BPM • ",n.musicMetadata.timeSignature]}),n.musicMetadata?.character&&a.jsx("p",{className:"expanded-player-album-character",children:n.musicMetadata.character})]})]}),a.jsxs("div",{className:"expanded-player-visualization-section",children:[a.jsx(la,{mode:h,frequencyData:p,timeDomainData:m,isPlaying:e,dominantColor:x,width:800,height:200}),a.jsxs("div",{className:"visualization-mode-toggle",children:[a.jsx("button",{className:h==="waveform"?"active":"",onClick:()=>C("waveform"),title:"Waveform",children:"波形"}),a.jsx("button",{className:h==="spectrum"?"active":"",onClick:()=>C("spectrum"),title:"Spectrum Bars",children:"バー"}),a.jsx("button",{className:h==="radial"?"active":"",onClick:()=>C("radial"),title:"Radial Spectrum",children:"円形"})]})]}),a.jsxs("div",{className:"expanded-player-controls-section",children:[a.jsx(ia,{isPlaying:e,canPrevious:l,canNext:u,shuffle:c,repeat:o,onPlayPause:g,onPrevious:_,onNext:y,onShuffle:b,onRepeat:S,expanded:!0}),a.jsx(ra,{currentTime:t,duration:s,onSeek:w,color:x}),a.jsx(aa,{volume:i,isMuted:r,onVolumeChange:N,onMuteToggle:A,expanded:!0})]}),a.jsx(Ip,{queue:d,currentIndex:f,onSkipTo:v})]})]})]})},Dp=({album:n,queue:e=[]})=>{const{state:t,setPlaybackState:s,setCurrentTime:i,setDuration:r,setVolume:c,toggleMute:o,toggleShuffle:l,cycleRepeat:u,toggleExpanded:h,setVisualizationMode:d,play:f,pause:p,next:m,previous:g,skipToIndex:_,setQueue:y,setCurrentAlbumFull:w}=rs(),N=T.useRef(jp()),A=T.useRef(null),b=T.useRef(null),S=T.useRef(null),C=T.useRef(null),v=T.useRef(0),k=T.useRef(0),[x,j]=T.useState(null),[M,O]=T.useState(null);T.useEffect(()=>((async()=>{try{await Jr();const I=Cp.createAnalyser();I.fftSize=2048,I.smoothingTimeConstant=.8,kp().connect(I),A.current=I,b.current=new Uint8Array(I.frequencyBinCount),S.current=new Uint8Array(I.frequencyBinCount)}catch(I){console.error("Failed to initialize analyser:",I)}})(),()=>{if(A.current)try{A.current.disconnect()}catch{}}),[]),T.useEffect(()=>{if(e.length>0){const P=n?e.findIndex(I=>I.id===n.id):0;y(e,Math.max(0,P))}else n&&y([n],0)},[n,e,y]),T.useEffect(()=>{const P=t.currentAlbum||n;P?.musicData&&(D(P),w(P))},[t.currentAlbum?.id,n?.id]),T.useEffect(()=>{t.playRequestId>0&&(v.current=t.playRequestId)},[t.playRequestId]),T.useEffect(()=>{const P=t.currentAlbum||n,I=v.current;if(!P?.musicData||I===0||I===k.current)return;let J=!1;return(async()=>{try{if(await D(P),J)return;await q(),k.current=I}catch(me){console.error("[EnhancedMiniPlayer] Autoplay failed:",me)}})(),()=>{J=!0}},[t.currentAlbum?.id,n?.id,t.playRequestId]),T.useEffect(()=>{if(t.playbackState===bt.PLAYING&&A.current){let P;const I=()=>{!A.current||!b.current||!S.current||(A.current.getByteFrequencyData(b.current),A.current.getByteTimeDomainData(S.current),j(new Uint8Array(b.current)),O(new Uint8Array(S.current)),P=requestAnimationFrame(I))};return P=requestAnimationFrame(I),()=>{P&&cancelAnimationFrame(P)}}},[t.playbackState]);const D=async P=>{try{const I=N.current;await I.loadMIDI(P.musicData);const J=I.getState();r(J.duration)}catch(I){console.error("[EnhancedMiniPlayer] Failed to load MIDI:",I)}},q=async()=>{try{s(bt.LOADING);const P=N.current;await P.play(),f();const I=window.setInterval(()=>{const J=P.getState();i(J.currentTime),r(J.duration),!J.isPlaying&&!J.isPaused&&(clearInterval(I),B())},100);C.current=I}catch(P){console.error("Failed to start playback:",P),s(bt.STOPPED)}},L=()=>{N.current.pause(),p(),C.current&&(clearInterval(C.current),C.current=null)},B=()=>{t.repeat==="one"?(V(0),q()):E()},U=()=>{t.playbackState===bt.PLAYING?L():q()},E=()=>{m(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{q()})})},R=()=>{g(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{q()})})},V=P=>{N.current.seek(P),i(P)},Y=P=>{c(P)},ie=P=>{_(P),requestAnimationFrame(()=>{requestAnimationFrame(()=>{q()})})},xe=t.queueIndex>0||t.repeat==="all",X=t.queueIndex<t.queue.length-1||t.repeat==="all",F=t.playbackState===bt.PLAYING;return T.useEffect(()=>()=>{C.current&&clearInterval(C.current)},[]),a.jsxs(a.Fragment,{children:[!t.isExpanded&&a.jsx(Ep,{album:t.currentAlbum,isPlaying:F,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,canPrevious:xe,canNext:X,frequencyData:x,timeDomainData:M,onPlayPause:U,onPrevious:R,onNext:E,onSeek:V,onVolumeChange:Y,onMuteToggle:o,onExpand:h}),t.isExpanded&&a.jsx(Rp,{album:t.currentAlbum,isPlaying:F,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,shuffle:t.shuffle,repeat:t.repeat,canPrevious:xe,canNext:X,visualizationMode:t.visualizationMode,queue:t.queue,queueIndex:t.queueIndex,frequencyData:x,timeDomainData:M,onPlayPause:U,onPrevious:R,onNext:E,onSeek:V,onVolumeChange:Y,onMuteToggle:o,onShuffle:l,onRepeat:u,onVisualizationModeChange:d,onSkipToIndex:ie,onClose:h})]})},Pp=()=>{const{logs:n,clearAllLogs:e,deleteLog:t,exportLog:s}=jn(),[i,r]=T.useState(!1),[c,o]=T.useState(null),l=p=>{try{const m=s(p),g=new Blob([m],{type:"application/json"}),_=URL.createObjectURL(g),y=document.createElement("a");y.href=_,y.download=`causal-log-${p}.json`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(_)}catch(m){console.error("Failed to export log:",m),alert("ログのエクスポートに失敗しました")}},u=()=>{try{const p=JSON.stringify(n,null,2),m=new Blob([p],{type:"application/json"}),g=URL.createObjectURL(m),_=document.createElement("a");_.href=g,_.download=`causal-logs-all-${new Date().toISOString()}.json`,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(g)}catch(p){console.error("Failed to export all logs:",p),alert("全ログのエクスポートに失敗しました")}},h=()=>{window.confirm("すべてのログを削除してもよろしいですか？この操作は元に戻せません。")&&(e(),o(null))},d=p=>{window.confirm("このログを削除してもよろしいですか？")&&(t(p),c===p&&o(null))},f=p=>{const m=Math.round(p/1e3);if(m<60)return`${m}s`;const g=Math.floor(m/60),_=m%60;return`${g}m ${_}s`};return a.jsxs("div",{className:"debug-panel",children:[a.jsx("button",{className:"debug-toggle-btn",onClick:()=>r(!i),title:"開発者デバッグパネル",children:i?"CLOSE":"DEV"}),i&&a.jsxs("div",{className:"debug-panel-content",children:[a.jsxs("div",{className:"debug-header",children:[a.jsx("h3",{children:"デバッグパネル（P5）"}),a.jsxs("div",{className:"debug-actions",children:[a.jsx("button",{className:"debug-btn",onClick:u,disabled:n.length===0,children:"全ログエクスポート"}),a.jsx("button",{className:"debug-btn danger",onClick:h,disabled:n.length===0,children:"全ログ削除"})]})]}),a.jsxs("div",{className:"debug-stats",children:[a.jsxs("div",{className:"stat-item",children:[a.jsx("span",{className:"stat-label",children:"総ログ数:"}),a.jsx("span",{className:"stat-value",children:n.length})]}),a.jsxs("div",{className:"stat-item",children:[a.jsx("span",{className:"stat-label",children:"成功:"}),a.jsx("span",{className:"stat-value success",children:n.filter(p=>p.success).length})]}),a.jsxs("div",{className:"stat-item",children:[a.jsx("span",{className:"stat-label",children:"失敗:"}),a.jsx("span",{className:"stat-value error",children:n.filter(p=>!p.success).length})]})]}),a.jsx("div",{className:"debug-logs-list",children:n.length===0?a.jsx("div",{className:"debug-empty",children:"ログがありません"}):n.map(p=>a.jsxs("div",{className:"debug-log-item",children:[a.jsxs("div",{className:"debug-log-summary",onClick:()=>o(c===p.id?null:p.id),children:[a.jsxs("div",{className:"log-summary-left",children:[a.jsx("span",{className:`log-status ${p.success?"success":"error"}`,children:p.success?"OK":"NG"}),a.jsxs("span",{className:"log-id",children:[p.sessionId.slice(0,12),"..."]}),a.jsx("span",{className:"log-time",children:new Date(p.createdAt).toLocaleString("ja-JP")})]}),a.jsxs("div",{className:"log-summary-right",children:[a.jsx("span",{className:"log-duration",children:f(p.totalDuration)}),a.jsx("span",{className:"log-expand",children:c===p.id?"▲":"▼"})]})]}),c===p.id&&a.jsxs("div",{className:"debug-log-details",children:[a.jsxs("div",{className:"log-details-section",children:[a.jsx("h4",{children:"入力"}),a.jsx("pre",{children:JSON.stringify(p.input,null,2)})]}),p.analysis&&a.jsxs("div",{className:"log-details-section",children:[a.jsxs("h4",{children:["解析 (",p.analysis.provider,")"]}),a.jsx("pre",{children:JSON.stringify(p.analysis,null,2)})]}),p.imageGeneration&&a.jsxs("div",{className:"log-details-section",children:[a.jsxs("h4",{children:["画像生成 (",p.imageGeneration.provider,")"]}),a.jsx("pre",{children:JSON.stringify({...p.imageGeneration,resultUrl:p.imageGeneration.resultUrl.substring(0,50)+"..."},null,2)})]}),p.musicGeneration&&a.jsxs("div",{className:"log-details-section",children:[a.jsxs("h4",{children:["音楽生成 (",p.musicGeneration.provider,")"]}),a.jsx("pre",{children:JSON.stringify(p.musicGeneration,null,2)})]}),p.album&&a.jsxs("div",{className:"log-details-section",children:[a.jsx("h4",{children:"アルバム"}),a.jsx("pre",{children:JSON.stringify(p.album,null,2)})]}),p.errors&&p.errors.length>0&&a.jsxs("div",{className:"log-details-section error",children:[a.jsx("h4",{children:"エラー"}),a.jsx("pre",{children:JSON.stringify(p.errors,null,2)})]}),a.jsxs("div",{className:"log-actions",children:[a.jsx("button",{className:"debug-btn small",onClick:()=>l(p.id),children:"JSONエクスポート"}),a.jsx("button",{className:"debug-btn small danger",onClick:()=>d(p.id),children:"削除"})]})]})]},p.id))})]})]})};function Fp(){{console.log("[Sentry] DSN not configured, skipping initialization");return}}function Lp(){try{new Function('return import("web-vitals")')().then(e=>{const t=s=>{console.log("[Web Vitals]",s)};e.onCLS(t),e.onFID(t),e.onFCP(t),e.onLCP(t),e.onTTFB(t)}).catch(()=>{console.log("[Web Vitals] Package not installed, skipping")})}catch{console.log("[Web Vitals] Failed to initialize")}}function Vp(){const n=document.createElement("script");n.type="module",n.innerHTML=`
    try {
      const { inject } = await import('https://cdn.jsdelivr.net/npm/@vercel/analytics@1/dist/index.mjs');
      inject();
      console.log('[Analytics] Loaded successfully');
    } catch (e) {
      console.log('[Analytics] Package not available');
    }
  `;const e=document.createElement("script");e.type="module",e.innerHTML=`
    try {
      const { injectSpeedInsights } = await import('https://cdn.jsdelivr.net/npm/@vercel/speed-insights@1/dist/index.mjs');
      injectSpeedInsights();
      console.log('[Speed Insights] Loaded successfully');
    } catch (e) {
      console.log('[Speed Insights] Package not available');
    }
  `,document.head.appendChild(n),document.head.appendChild(e)}Fp(),Lp(),Vp();const qp="airia_onboarding_data",Wp="airia_theme";function Bp(){try{const n=localStorage.getItem(Wp),e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=n||"system",s=t==="system"?e?"dark":"light":t;document.documentElement.setAttribute("data-theme",s)}catch{document.documentElement.setAttribute("data-theme","light")}}function qi(){try{const n=localStorage.getItem(qp);return n?!!JSON.parse(n)?.completedAt:!1}catch{return!1}}const Up=()=>{const[n,e]=T.useState(!0),[t,s]=T.useState(()=>{try{return qi()}catch{return!1}}),{getSelectedAlbum:i,albums:r}=Nt(),{state:c}=rs(),o=i();T.useEffect(()=>{Bp()},[]);const l=r.filter(d=>d.musicData),u=t?[{id:"main",name:"Main",component:a.jsx(po,{})},{id:"gallery",name:"Gallery",component:a.jsx(vo,{})},{id:"album",name:"Album",component:a.jsx(No,{})},{id:"music",name:"Music",component:a.jsx(So,{})},{id:"social",name:"Social",component:a.jsx(Eo,{})},{id:"info",name:"Info",component:a.jsx(Do,{})}]:[{id:"onboarding",name:"はじめに",component:a.jsx(Qa,{onExit:()=>{s(qi())}})}],h=t?"main":"onboarding";return a.jsxs(a.Fragment,{children:[n&&a.jsx(Po,{onDismiss:()=>e(!1)}),!n&&a.jsxs(a.Fragment,{children:[a.jsx(Da,{rooms:u,initialRoom:h},t?"onboarded":"needs-onboarding"),a.jsx(Dp,{album:o||void 0,queue:l}),a.jsx(Pp,{})]})]})},Gp=()=>a.jsx(K.StrictMode,{children:a.jsx(Oa,{children:a.jsx(Ca,{children:a.jsx(Ta,{children:a.jsx(ja,{children:a.jsx(Ea,{children:a.jsx(Up,{})})})})})})});xa.createRoot(document.getElementById("root")).render(a.jsx(Gp,{}));
//# sourceMappingURL=index-wUWj2AeG.js.map
