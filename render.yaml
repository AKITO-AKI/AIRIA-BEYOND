services:
  - type: web
    name: airia-beyond-api
    env: node
    buildCommand: npm install
    startCommand: node server.js
    disk:
      name: airia-beyond-data
      mountPath: /var/data
      sizeGB: 1
    envVars:
      - key: NODE_ENV
        value: production
      - key: AUTH_ALLOW_PASSWORD
        value: true
      - key: AUTH_ALLOW_OAUTH
        value: false
      - key: AUTH_STORE_PATH
        value: /var/data/auth-store.json
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: APPLE_CLIENT_ID
        sync: false
      - key: EMAIL_NOTIFICATIONS_ENABLED
        value: false
      - key: EMAIL_FROM
        sync: false
      - key: APP_PUBLIC_URL
        value: https://www.airia-beyond.com/
      - key: APP_ALLOWED_ORIGINS
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: SMTP_SECURE
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ADMIN_TOKEN
        sync: false
      - key: DISABLE_LLM_ANALYSIS
        value: false
      - key: IMAGE_PROVIDER
        value: comfyui
      - key: COMFYUI_BASE_URL
        sync: false
      - key: COMFYUI_CHECKPOINT
        sync: false

      # --- ComfyUI quality defaults (recommended) ---
      - key: COMFYUI_WIDTH
        value: 1024
      - key: COMFYUI_HEIGHT
        value: 1024
      - key: COMFYUI_STEPS
        value: 30
      - key: COMFYUI_CFG
        value: 7.0
      - key: COMFYUI_SAMPLER
        value: dpmpp_2m
      - key: COMFYUI_SCHEDULER
        value: karras

      # Timeouts / polling
      - key: COMFYUI_TIMEOUT_MS
        value: 240000
      - key: COMFYUI_POLL_INTERVAL_MS
        value: 750
      - key: COMFYUI_HTTP_TIMEOUT_MS
        value: 20000

      # Hi-Res Fix (LatentUpscale + 2nd sampler pass)
      - key: COMFYUI_HIRES_ENABLED
        value: true
      - key: COMFYUI_HIRES_SCALE
        value: 1.5
      - key: COMFYUI_HIRES_DENOISE
        value: 0.35
      - key: COMFYUI_HIRES_STEPS
        value: 12
      - key: COMFYUI_HIRES_UPSCALE_METHOD
        value: nearest-exact

      # LoRA / Refiner (optional; set only if models exist on the ComfyUI host)
      - key: COMFYUI_LORAS
        sync: false
      - key: COMFYUI_REFINER_CHECKPOINT
        sync: false
      - key: COMFYUI_REFINER_DENOISE
        value: 0.22
      - key: COMFYUI_REFINER_STEPS
        value: 12

      # IP-Adapter (optional; requires custom nodes + models)
      - key: COMFYUI_IPADAPTER_ENABLED
        value: false
      - key: COMFYUI_IPADAPTER_MODEL
        sync: false
      - key: COMFYUI_CLIP_VISION_MODEL
        sync: false
      - key: COMFYUI_IPADAPTER_WEIGHT
        value: 0.65
      - key: COMFYUI_IPADAPTER_START_AT
        value: 0.0
      - key: COMFYUI_IPADAPTER_END_AT
        value: 1.0
      - key: COMFYUI_IPADAPTER_REFERENCE_URL
        sync: false

      # --- Art Director prompt layer (recommended) ---
      - key: IMAGE_ART_DIRECTOR_ENABLED
        value: true
      - key: IMAGE_PROMPT_LLM_PROVIDER
        value: openai
      - key: OPENAI_MODEL_IMAGE_PROMPT
        value: gpt-4o-mini
      - key: IMAGE_PROMPT_LLM_TEMPERATURE
        value: 0.7
      - key: IMAGE_PROMPT_LLM_MAX_TOKENS
        value: 800

      # --- Music quality (recommended) ---
      # Music LLM provider can be overridden independently of LLM_PROVIDER
      - key: MUSIC_LLM_PROVIDER
        value: openai
      - key: OPENAI_MODEL_MUSIC
        value: gpt-4o-mini
      - key: LLM_TEMPERATURE_MUSIC
        value: 0.65
      - key: MUSIC_LLM_MAX_TOKENS
        value: 2600

      # Allow more time for structure generation/refinement
      - key: MUSIC_STRUCTURE_TIMEOUT_MS
        value: 120000

      # Enable 2nd-pass editor/refiner for higher coherence
      - key: MUSIC_HIGH_QUALITY
        value: true
      - key: MUSIC_STRUCTURE_EDITOR_ENABLED
        value: true
      - key: MUSIC_STRUCTURE_EDITOR_PROVIDER
        value: openai
      - key: MUSIC_LLM_EDITOR_TEMPERATURE
        value: 0.25
      - key: MUSIC_LLM_EDITOR_MAX_TOKENS
        value: 3000
    healthCheckPath: /api/health
